# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_rks_water_numlda():
    ref_result_dm_alpha = array([[  9.13812575e-02,   4.60066710e-02,  -1.85249088e-02,
          3.96381083e-02,   1.22202666e-01,  -9.13070094e-02,
         -1.18033222e-05,   1.99092651e-02,   6.19130493e-02,
         -6.07049052e-02,   2.49824328e-06,  -4.87553639e-03,
         -3.12046651e-06,   7.62234686e-06,  -3.64752968e-03,
         -8.92122435e-03,  -1.89604382e-02,  -1.91378357e-02],
       [  4.60066710e-02,   2.89091958e-02,   1.09494283e-02,
         -1.54478118e-02,   7.21518009e-02,  -5.54102382e-02,
          8.02593057e-05,  -3.19654431e-02,   3.65536600e-02,
         -3.91349502e-02,   7.13917763e-05,  -1.60756461e-03,
         -1.16470727e-06,  -3.99395097e-07,  -3.23301369e-03,
         -5.26683081e-03,  -1.91411577e-02,  -9.55119685e-03],
       [ -1.85249088e-02,   1.09494283e-02,   1.04053744e+00,
         -7.85976280e-02,   5.41344227e-06,  -1.96995448e-02,
          9.60346142e-07,  -1.45187240e-01,  -1.49640984e-06,
         -1.61063191e-02,   7.54944174e-07,   3.30329165e-03,
          1.51563759e-06,   3.21015231e-07,  -3.90585226e-03,
          9.97037248e-07,  -1.85272442e-02,   1.09568307e-02],
       [  3.96381083e-02,  -1.54478118e-02,  -7.85976280e-02,
          2.40348473e-01,  -2.47825045e-05,   3.92764835e-02,
          3.56366297e-06,   2.75407975e-01,  -4.82503958e-06,
          4.11916047e-02,   3.11759457e-06,  -6.62687555e-03,
         -3.61514400e-06,  -1.15300029e-06,   8.16044462e-03,
         -5.93674279e-07,   3.96550555e-02,  -1.54571056e-02],
       [  1.22202666e-01,   7.21518009e-02,   5.41344227e-06,
         -2.47825045e-05,   2.70673168e-01,  -2.78106194e-06,
         -4.20318891e-05,   1.37070499e-05,   1.37121308e-01,
         -6.23436888e-06,  -7.16257329e-06,   1.49219672e-06,
         -1.59441717e-06,   1.18022651e-05,  -6.68646688e-06,
         -1.97544381e-02,  -1.22194820e-01,  -7.21728031e-02],
       [ -9.13070094e-02,  -5.54102382e-02,  -1.96995448e-02,
          3.92764835e-02,  -2.78106194e-06,   3.29332484e-01,
         -1.78875531e-06,   1.30637540e-01,  -1.55494927e-05,
          2.29574619e-01,  -1.18274024e-06,   1.13748092e-02,
          5.35582218e-06,  -9.47854112e-06,   1.78363186e-02,
          6.91457404e-06,  -9.13021178e-02,  -5.54733154e-02],
       [ -1.18033222e-05,   8.02593057e-05,   9.60346142e-07,
          3.56366297e-06,  -4.20318891e-05,  -1.78875531e-06,
          4.08036993e-01,  -2.66018479e-05,  -2.43689418e-05,
          1.07089618e-05,   3.27237129e-01,   1.10941987e-05,
         -8.92569509e-07,  -2.29722011e-02,   5.00283303e-06,
          1.44988946e-05,   8.13414773e-06,  -4.00040063e-05],
       [  1.99092651e-02,  -3.19654431e-02,  -1.45187240e-01,
          2.75407975e-01,   1.37070499e-05,   1.30637540e-01,
         -2.66018479e-05,   3.41090287e-01,   1.18235017e-05,
          1.06184728e-01,  -2.09809311e-05,  -4.36352084e-03,
         -2.58986860e-06,  -2.08400300e-06,   1.37736781e-02,
         -1.90988023e-06,   1.98914905e-02,  -3.20147635e-02],
       [  6.19130493e-02,   3.65536600e-02,  -1.49640984e-06,
         -4.82503958e-06,   1.37121308e-01,  -1.55494927e-05,
         -2.43689418e-05,   1.18235017e-05,   6.94647846e-02,
         -1.24680101e-05,  -6.09528626e-06,  -5.43450277e-08,
         -8.08115741e-07,   6.15254018e-06,  -3.91035882e-06,
         -1.00074734e-02,  -6.18971650e-02,  -3.65602644e-02],
       [ -6.07049052e-02,  -3.91349502e-02,  -1.61063191e-02,
          4.11916047e-02,  -6.23436888e-06,   2.29574619e-01,
          1.07089618e-05,   1.06184728e-01,  -1.24680101e-05,
          1.60848205e-01,   8.77722225e-06,   7.46425488e-03,
          3.48511319e-06,  -7.26975293e-06,   1.27853123e-02,
          4.94777365e-06,  -6.06979502e-02,  -3.91774989e-02],
       [  2.49824328e-06,   7.13917763e-05,   7.54944174e-07,
          3.11759457e-06,  -7.16257329e-06,  -1.18274024e-06,
          3.27237129e-01,  -2.09809311e-05,  -6.09528626e-06,
          8.77722225e-06,   2.62437331e-01,   8.89841216e-06,
         -7.15978501e-07,  -1.84232236e-02,   4.03103781e-06,
          9.69040655e-06,  -5.48147598e-06,  -3.92115044e-05],
       [ -4.87553639e-03,  -1.60756461e-03,   3.30329165e-03,
         -6.62687555e-03,   1.49219672e-06,   1.13748092e-02,
          1.10941987e-05,  -4.36352084e-03,  -5.43450277e-08,
          7.46425488e-03,   8.89841216e-06,   6.65258101e-04,
          3.29696049e-07,  -9.62053405e-07,   4.10439045e-04,
          2.32768153e-07,  -4.87660729e-03,  -1.61009013e-03],
       [ -3.12046651e-06,  -1.16470727e-06,   1.51563759e-06,
         -3.61514400e-06,  -1.59441717e-06,   5.35582218e-06,
         -8.92569509e-07,  -2.58986860e-06,  -8.08115741e-07,
          3.48511319e-06,  -7.15978501e-07,   3.29696049e-07,
          1.75443149e-10,   5.00361716e-08,   1.80783906e-07,
          1.16507045e-07,  -1.68064624e-06,  -3.15023901e-07],
       [  7.62234686e-06,  -3.99395097e-07,   3.21015231e-07,
         -1.15300029e-06,   1.18022651e-05,  -9.47854112e-06,
         -2.29722011e-02,  -2.08400300e-06,   6.15254018e-06,
         -7.26975293e-06,  -1.84232236e-02,  -9.62053405e-07,
          5.00361716e-08,   1.29331968e-03,  -7.95679564e-07,
         -1.50513229e-06,  -2.02009892e-06,   1.34193203e-06],
       [ -3.64752968e-03,  -3.23301369e-03,  -3.90585226e-03,
          8.16044462e-03,  -6.68646688e-06,   1.78363186e-02,
          5.00283303e-06,   1.37736781e-02,  -3.91035882e-06,
          1.27853123e-02,   4.03103781e-06,   4.10439045e-04,
          1.80783906e-07,  -7.95679564e-07,   1.12123104e-03,
          7.68972737e-07,  -3.64151061e-03,  -3.23332723e-03],
       [ -8.92122435e-03,  -5.26683081e-03,   9.97037248e-07,
         -5.93674279e-07,  -1.97544381e-02,   6.91457404e-06,
          1.44988946e-05,  -1.90988023e-06,  -1.00074734e-02,
          4.94777365e-06,   9.69040655e-06,   2.32768153e-07,
          1.16507045e-07,  -1.50513229e-06,   7.68972737e-07,
          1.44173123e-03,   8.91554511e-03,   5.26635240e-03],
       [ -1.89604382e-02,  -1.91411577e-02,  -1.85272442e-02,
          3.96550555e-02,  -1.22194820e-01,  -9.13021178e-02,
          8.13414773e-06,   1.98914905e-02,  -6.18971650e-02,
         -6.06979502e-02,  -5.48147598e-06,  -4.87660729e-03,
         -1.68064624e-06,  -2.02009892e-06,  -3.64151061e-03,
          8.91554511e-03,   9.13703908e-02,   4.60285897e-02],
       [ -1.91378357e-02,  -9.55119685e-03,   1.09568307e-02,
         -1.54571056e-02,  -7.21728031e-02,  -5.54733154e-02,
         -4.00040063e-05,  -3.20147635e-02,  -3.65602644e-02,
         -3.91774989e-02,  -3.92115044e-05,  -1.61009013e-03,
         -3.15023901e-07,   1.34193203e-06,  -3.23332723e-03,
          5.26635240e-03,   4.60285897e-02,   2.89432436e-02]])
    ref_result_energy = -75.839901640501509
    ref_result_exp_alpha = array([[ -1.10399453e-04,   1.39046009e-01,   2.34895857e-01,
         -1.29889751e-01,   2.26654967e-06,   1.11645558e-01,
          1.14547708e-01,   8.40960137e-01,   7.34658539e-01,
          8.05330777e-04,   4.95433401e-01,   3.54296040e-03,
          1.68647649e-01,  -2.63483446e-03,  -9.75016561e-02,
         -5.49848168e-04,   8.32738844e-01,  -9.60286504e-01],
       [ -3.76383698e-03,   4.87701173e-03,   1.38686371e-01,
         -9.81697008e-02,   1.38309236e-04,   9.30979483e-01,
          1.25592580e+00,  -6.29899618e-01,  -5.74180603e-01,
         -3.77017272e-04,  -7.35465944e-02,   9.64637343e-01,
          6.78998603e-01,  -1.00676444e-03,  -4.95415729e-02,
          1.48664230e-04,   1.09132818e-01,   1.57116039e-02],
       [ -9.94155645e-01,  -2.12464257e-01,   3.50317319e-06,
         -8.39698483e-02,   3.32268662e-06,   9.53721964e-02,
          1.59830458e-04,  -5.81903786e-05,   3.49156282e-02,
          7.75451422e-05,   6.59895676e-02,   3.50994066e-05,
         -7.09600277e-02,  -1.23816675e-05,   7.09930429e-04,
         -1.67527893e-05,   1.74122094e-02,   9.40852168e-07],
       [ -3.33386208e-02,   4.54332873e-01,  -3.41379346e-05,
          1.81159195e-01,   1.98885180e-06,  -1.78474440e-01,
         -3.88077399e-04,   4.12585434e-04,  -1.41265513e-01,
         -3.08394885e-04,  -3.62725895e-01,  -3.14787404e-04,
          1.62315859e+00,  -2.99741225e-03,  -1.35383910e-01,
          1.06530059e-06,   5.54975463e-01,   3.88038620e-04],
       [ -2.93644538e-07,  -2.13593852e-05,   5.20262659e-01,
          1.47602935e-05,  -2.55735176e-05,   6.04344512e-04,
         -4.35010970e-01,  -1.93522192e-01,   4.71232821e-05,
         -2.05692299e-05,  -3.46407817e-04,   9.78496618e-01,
          2.19353804e-04,   7.59737069e-05,   2.21896251e-04,
          3.52766502e-05,  -1.41779709e-04,  -3.71282245e-02],
       [  1.73218727e-03,  -1.35753755e-01,  -2.67309873e-05,
          5.57584484e-01,  -1.39264073e-05,   2.81350776e-01,
          4.74486723e-04,  -1.39606461e-03,   6.52772126e-01,
          1.55892742e-04,  -7.08583684e-01,  -4.86095497e-04,
         -1.80990442e-01,   1.68565253e-04,   6.85547485e-03,
         -2.49771874e-05,  -3.96251232e-02,  -2.58104846e-05],
       [  9.75670909e-08,  -7.75038020e-09,  -4.93910102e-05,
          1.27350065e-05,   6.38777740e-01,  -4.16293125e-05,
         -8.75897890e-05,   2.98751970e-04,  -9.00749204e-04,
          9.63302231e-01,  -6.28083426e-04,   8.23524948e-05,
         -2.99698794e-05,   6.38097462e-05,  -2.50331405e-05,
          7.53681268e-03,  -4.26632346e-05,  -1.51544711e-05],
       [  1.64950198e-02,   4.68508559e-01,   3.57068435e-05,
          3.48307244e-01,  -4.85567365e-05,  -1.09458086e+00,
         -1.55698360e-03,  -6.27310623e-04,   1.74303002e-01,
          8.39875407e-06,  -3.46652849e-03,   1.21549808e-04,
         -2.54397274e+00,   6.29409132e-03,   2.70584332e-01,
          1.76775617e-04,  -1.32619215e+00,  -8.13922269e-04],
       [  4.55218685e-07,   1.39460301e-05,   2.63561764e-01,
         -1.18512227e-05,  -1.77702262e-05,   1.17787939e-03,
         -7.46795349e-01,  -4.37326652e-01,  -1.24328381e-03,
          2.51133948e-04,   8.93106504e-04,  -1.69442074e+00,
         -3.96829605e-04,  -4.17528721e-05,  -3.99451729e-04,
          1.35524239e-04,  -1.01208068e-04,   9.45165398e-01],
       [ -2.83337839e-03,  -6.71963101e-02,  -2.59548443e-05,
          3.95379399e-01,   8.86865246e-06,   4.20743796e-01,
          5.85077600e-04,   1.04578841e-03,  -3.43088268e-01,
          4.73075289e-04,   1.13321213e+00,   6.35448223e-04,
          6.27065905e-01,  -3.76196945e-03,  -1.51460815e-01,
         -3.20594776e-04,   6.75909047e-01,   3.23496201e-04],
       [ -2.63335137e-08,   3.37101808e-07,   1.14139210e-05,
          1.07471200e-05,   5.12286366e-01,   1.72238599e-05,
          2.17357137e-07,  -2.83229318e-04,   9.86218693e-04,
         -1.03555732e+00,   6.77673616e-04,  -7.06613908e-05,
          1.65438366e-05,  -1.38183218e-04,  -1.43440537e-04,
          3.50494806e-02,   3.43892675e-05,   1.95996489e-05],
       [ -1.90960027e-04,  -2.07227431e-02,   1.58129716e-06,
          1.53554478e-02,   1.70734167e-05,   1.29069058e-02,
          1.22367157e-05,   1.77436687e-04,  -1.33596207e-01,
         -1.57195271e-04,  -8.93047825e-02,   8.97522254e-05,
         -1.57887178e-01,   1.11514918e-02,   4.72927082e-01,
          1.67408221e-03,   9.80721185e-01,   3.84185655e-04],
       [  1.78467799e-07,  -1.07320524e-05,  -3.05711129e-06,
          6.99176046e-06,  -1.39418013e-06,   3.05431415e-05,
          6.02507395e-06,   9.32005202e-06,   5.82438324e-05,
         -7.79615679e-05,   1.14367796e-04,  -6.90575768e-05,
         -1.74881147e-04,   9.99711713e-01,  -2.39577528e-02,
          1.55631986e-03,   1.72393599e-04,  -8.01651933e-05],
       [  5.19226098e-08,   4.33675322e-06,   2.09181138e-05,
         -1.68308427e-05,  -3.59627663e-02,  -1.53315709e-05,
         -1.05128951e-05,   7.42799876e-05,   9.59453654e-08,
          1.60295295e-02,  -1.05761149e-05,  -4.46991647e-05,
         -2.87045854e-04,  -1.63884231e-03,  -3.52306940e-03,
          9.99216943e-01,  -3.14481661e-05,  -2.09769593e-04],
       [  1.13371811e-04,   4.75336545e-03,  -1.35938487e-05,
          3.31455126e-02,   7.16957295e-06,   1.02300888e-02,
          6.19612976e-05,  -1.29293634e-04,   1.10213681e-01,
          1.48763908e-04,   1.08216673e-01,  -2.82026250e-04,
          1.81585169e-01,   2.10276048e-02,   8.73474938e-01,
          3.15008272e-03,  -5.07537533e-01,  -9.08714469e-05],
       [ -2.37346599e-07,  -7.65374841e-06,  -3.79701518e-02,
          8.72120200e-06,   1.97618030e-05,  -5.17920660e-06,
          1.71759105e-02,  -2.14172045e-01,  -3.88642240e-04,
          3.68096195e-05,   7.40938889e-05,  -2.59719988e-02,
          1.86875909e-04,  -9.92269634e-05,   1.05246526e-04,
         -2.51142203e-04,   4.74181245e-04,  -1.27314183e+00],
       [ -1.10147082e-04,   1.39052850e-01,  -2.34861985e-01,
         -1.29901827e-01,  -2.84353187e-06,   1.11772119e-01,
         -1.14080293e-01,  -8.43064309e-01,   7.31846459e-01,
          1.31052977e-03,   4.96029845e-01,  -3.38326397e-03,
          1.68673643e-01,  -2.47035423e-03,  -9.76758052e-02,
         -2.28576663e-05,   8.32050554e-01,   9.60902185e-01],
       [ -3.76353323e-03,   4.88534577e-03,  -1.38720766e-01,
         -9.82940914e-02,  -7.14087688e-05,   9.35089733e-01,
         -1.25320985e+00,   6.31840840e-01,  -5.72456028e-01,
         -7.03478059e-04,  -7.30973775e-02,  -9.64411866e-01,
          6.78310195e-01,  -1.14711795e-03,  -4.98327816e-02,
         -6.22409450e-05,   1.09380389e-01,  -1.54000784e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_numlda.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]