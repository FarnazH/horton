# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_dm_alpha = array([[  9.65375101e-02,   4.58300493e-02,  -1.85093961e-02,
          4.05426125e-02,   1.24296418e-01,  -9.41059718e-02,
          6.99824772e-07,   1.91029792e-02,   6.34689885e-02,
         -6.24644798e-02,  -5.80788420e-07,  -4.94378275e-03,
          5.07685097e-07,  -2.40501953e-07,  -3.49527595e-03,
         -9.52667591e-03,  -1.97157897e-02,  -1.88669387e-02],
       [  4.58300493e-02,   2.74104942e-02,   1.05230469e-02,
         -1.67259490e-02,   6.91727956e-02,  -5.44175132e-02,
         -7.29214805e-06,  -3.20503445e-02,   3.53214065e-02,
         -3.81342358e-02,  -6.36142188e-06,  -1.65023443e-03,
          2.73559876e-07,   3.35398919e-07,  -2.92390858e-03,
         -5.30172525e-03,  -1.88665755e-02,  -8.59423132e-03],
       [ -1.85093961e-02,   1.05230469e-02,   1.04154616e+00,
         -8.54284614e-02,   2.17366871e-07,  -2.02296988e-02,
         -4.96177108e-07,  -1.39030972e-01,   5.82463484e-08,
         -1.60237193e-02,  -3.68743191e-07,   2.87509914e-03,
         -2.50627804e-08,   1.63871448e-07,  -3.53305286e-03,
          1.96422311e-08,  -1.85094536e-02,   1.05232547e-02],
       [  4.05426125e-02,  -1.67259490e-02,  -8.54284614e-02,
          2.49967608e-01,  -1.52422054e-06,   4.28410698e-02,
         -1.19246622e-06,   2.77255136e-01,  -7.09111022e-07,
          4.19944720e-02,  -7.81120436e-07,  -5.77184273e-03,
          6.43490720e-08,  -2.74524850e-07,   7.59137295e-03,
          8.53990958e-08,   4.05436685e-02,  -1.67259027e-02],
       [  1.24296418e-01,   6.91727956e-02,   2.17366871e-07,
         -1.52422054e-06,   2.65791850e-01,   5.25824595e-07,
          6.67799371e-07,   1.26416366e-06,   1.35719593e-01,
         -1.05063141e-07,   1.04473168e-07,   2.10724547e-07,
          1.11690349e-06,  -1.00829893e-07,  -9.78898173e-08,
         -2.03712932e-02,  -1.24296202e-01,  -6.91736626e-02],
       [ -9.41059718e-02,  -5.44175132e-02,  -2.02296988e-02,
          4.28410698e-02,   5.25824595e-07,   3.28534140e-01,
         -5.13022060e-06,   1.30594970e-01,  -6.47758876e-07,
          2.27339149e-01,  -9.66698902e-07,   1.17262695e-02,
          9.07380294e-08,   5.89924638e-07,   1.63373834e-02,
          3.44538717e-07,  -9.41066285e-02,  -5.44187438e-02],
       [  6.99824772e-07,  -7.29214805e-06,  -4.96177108e-07,
         -1.19246622e-06,   6.67799371e-07,  -5.13022060e-06,
          4.13897325e-01,   9.95561928e-06,  -5.74075030e-07,
         -2.49022005e-06,   3.26449995e-01,   9.99876115e-08,
          5.38419114e-07,  -2.21138493e-02,   5.18516418e-07,
          2.02368202e-07,  -4.01037776e-07,  -6.81098813e-06],
       [  1.91029792e-02,  -3.20503445e-02,  -1.39030972e-01,
          2.77255136e-01,   1.26416366e-06,   1.30594970e-01,
          9.95561928e-06,   3.30821960e-01,   4.84084076e-07,
          1.03427772e-01,   8.81299632e-06,  -3.16057378e-03,
          9.20898202e-08,  -8.11585735e-07,   1.23379156e-02,
         -3.21718152e-08,   1.91013599e-02,  -3.20520476e-02],
       [  6.34689885e-02,   3.53214065e-02,   5.82463484e-08,
         -7.09111022e-07,   1.35719593e-01,  -6.47758876e-07,
         -5.74075030e-07,   4.84084076e-07,   6.93016280e-02,
         -6.78244441e-07,  -6.68397641e-07,   6.92097612e-08,
          5.70315887e-07,  -2.59666799e-09,  -9.13039754e-08,
         -1.04020632e-02,  -6.34682717e-02,  -3.53215609e-02],
       [ -6.24644798e-02,  -3.81342358e-02,  -1.60237193e-02,
          4.19944720e-02,  -1.05063141e-07,   2.27339149e-01,
         -2.49022005e-06,   1.03427772e-01,  -6.78244441e-07,
          1.57942859e-01,   1.54984578e-07,   7.74780479e-03,
          6.54389498e-08,   3.32480474e-07,   1.15796623e-02,
          2.70299911e-07,  -6.24645132e-02,  -3.81348747e-02],
       [ -5.80788420e-07,  -6.36142188e-06,  -3.68743191e-07,
         -7.81120436e-07,   1.04473168e-07,  -9.66698902e-07,
          3.26449995e-01,   8.81299632e-06,  -6.68397641e-07,
          1.54984578e-07,   2.57478347e-01,   1.96161888e-07,
          4.24662114e-07,  -1.74416831e-02,   5.56610357e-07,
          1.91977667e-07,  -1.05415188e-06,  -5.76215256e-06],
       [ -4.94378275e-03,  -1.65023443e-03,   2.87509914e-03,
         -5.77184273e-03,   2.10724547e-07,   1.17262695e-02,
          9.99876115e-08,  -3.16057378e-03,   6.92097612e-08,
          7.74780479e-03,   1.96161888e-07,   6.37907904e-04,
          1.66881898e-09,   1.72971257e-08,   4.19225692e-04,
          5.93403796e-11,  -4.94397530e-03,  -1.65035963e-03],
       [  5.07685097e-07,   2.73559876e-07,  -2.50627804e-08,
          6.43490720e-08,   1.11690349e-06,   9.07380294e-08,
          5.38419114e-07,   9.20898202e-08,   5.70315887e-07,
          6.54389498e-08,   4.24662114e-07,   1.66881898e-09,
          5.43017371e-12,  -2.87671106e-08,   5.68755139e-09,
         -8.56032921e-08,  -5.36944988e-07,  -3.07795279e-07],
       [ -2.40501953e-07,   3.35398919e-07,   1.63871448e-07,
         -2.74524850e-07,  -1.00829893e-07,   5.89924638e-07,
         -2.21138493e-02,  -8.11585735e-07,  -2.59666799e-09,
          3.32480474e-07,  -1.74416831e-02,   1.72971257e-08,
         -2.87671106e-08,   1.18150638e-03,  -2.04955227e-08,
         -5.81832147e-09,  -1.20749676e-07,   3.43602653e-07],
       [ -3.49527595e-03,  -2.92390858e-03,  -3.53305286e-03,
          7.59137295e-03,  -9.78898173e-08,   1.63373834e-02,
          5.18516418e-07,   1.23379156e-02,  -9.13039754e-08,
          1.15796623e-02,   5.56610357e-07,   4.19225692e-04,
          5.68755139e-09,  -2.04955227e-08,   9.34911467e-04,
          2.47952676e-08,  -3.49520039e-03,  -2.92391915e-03],
       [ -9.52667591e-03,  -5.30172525e-03,   1.96422311e-08,
          8.53990958e-08,  -2.03712932e-02,   3.44538717e-07,
          2.02368202e-07,  -3.21718152e-08,  -1.04020632e-02,
          2.70299911e-07,   1.91977667e-07,   5.93403796e-11,
         -8.56032921e-08,  -5.81832147e-09,   2.47952676e-08,
          1.56133301e-03,   9.52640327e-03,   5.30167088e-03],
       [ -1.97157897e-02,  -1.88665755e-02,  -1.85094536e-02,
          4.05436685e-02,  -1.24296202e-01,  -9.41066285e-02,
         -4.01037776e-07,   1.91013599e-02,  -6.34682717e-02,
         -6.24645132e-02,  -1.05415188e-06,  -4.94397530e-03,
         -5.36944988e-07,  -1.20749676e-07,  -3.49520039e-03,
          9.52640327e-03,   9.65372527e-02,   4.58305792e-02],
       [ -1.88669387e-02,  -8.59423132e-03,   1.05232547e-02,
         -1.67259027e-02,  -6.91736626e-02,  -5.44187438e-02,
         -6.81098813e-06,  -3.20520476e-02,  -3.53215609e-02,
         -3.81348747e-02,  -5.76215256e-06,  -1.65035963e-03,
         -3.07795279e-07,   3.43602653e-07,  -2.92391915e-03,
          5.30167088e-03,   4.58305792e-02,   2.74113119e-02]])
    ref_result_energy = -76.40615891465913
    ref_result_exp_alpha = array([[  1.90437577e-04,   1.39556877e-01,  -2.41095334e-01,
         -1.37602297e-01,   2.99560148e-06,  -1.01217983e-01,
          9.57074228e-02,  -8.47773980e-01,  -8.13683264e-01,
          4.48958651e-08,   3.56300888e-01,   1.20308521e-03,
          1.74423090e-01,   1.08744703e-04,  -9.07883502e-02,
         -9.51395821e-06,   8.28685677e-01,  -9.55955203e-01],
       [  3.04380283e-03,   1.01398303e-03,  -1.34172914e-01,
         -9.69424083e-02,   1.39660482e-05,  -9.50496039e-01,
          1.28959024e+00,   6.04523672e-01,   5.61054643e-01,
          2.57670415e-05,   1.50695765e-02,   9.35476564e-01,
          6.68579982e-01,   3.62774264e-05,  -4.64478677e-02,
         -3.55954037e-06,   1.10728404e-01,   1.16621351e-02],
       [  9.95040954e-01,  -2.12402471e-01,   1.20658615e-07,
         -7.95289443e-02,   2.27459170e-06,  -9.21827007e-02,
          2.41498853e-06,   3.15173605e-06,  -4.75051860e-02,
          1.61632548e-07,   5.72782798e-02,   6.03765030e-07,
         -6.81096193e-02,   5.25962213e-07,   5.72908502e-04,
         -8.42195722e-07,   1.80407376e-02,  -1.56830988e-07],
       [  2.79244978e-02,   4.66263724e-01,   1.75926899e-06,
          1.78286202e-01,  -1.76188753e-06,   1.57358876e-01,
         -1.03011963e-06,  -1.29154163e-05,   2.07082398e-01,
          3.04127597e-05,  -3.48541332e-01,  -1.79974749e-05,
          1.61932375e+00,   1.37555075e-04,  -1.27090967e-01,
         -2.05146211e-06,   5.54303609e-01,   1.91023959e-05],
       [ -2.48216316e-09,  -1.53982215e-06,  -5.15550046e-01,
          5.66572792e-07,  -7.76470702e-07,  -1.11446832e-05,
         -4.08545683e-01,   2.04413002e-01,  -5.95528678e-07,
         -4.81686892e-06,  -1.17428412e-05,   9.90115773e-01,
          1.26865073e-05,  -2.12765682e-05,   3.87548616e-06,
         -4.70172443e-06,   1.47010405e-08,  -3.71217184e-02],
       [ -1.64622995e-03,  -1.22151662e-01,  -4.07870823e-08,
          5.60009286e-01,  -7.09711463e-06,  -2.66172454e-01,
          4.51206819e-06,   3.83459825e-05,  -5.25044752e-01,
         -3.75534296e-05,  -8.10355607e-01,  -1.71477699e-05,
         -1.94065565e-01,  -1.00039790e-05,   6.33877344e-03,
         -9.63396788e-06,  -4.04783283e-02,  -2.67959294e-06],
       [ -6.32703104e-08,   1.51036906e-06,  -3.26712834e-07,
         -1.69858071e-05,  -6.43348525e-01,  -9.85786723e-06,
          3.54793984e-07,   1.24292214e-05,   9.63622416e-06,
         -9.60256151e-01,   2.93309325e-05,  -7.65166038e-06,
          2.28474223e-05,   3.55063628e-06,  -4.45382381e-06,
          7.55726632e-03,   4.73884825e-06,   2.08864424e-06],
       [ -1.31929262e-02,   4.67292467e-01,  -3.47939283e-06,
          3.35090521e-01,  -2.32250656e-05,   1.12257625e+00,
         -3.41203210e-05,   8.90323244e-06,  -1.49809986e-01,
         -7.04850461e-05,   5.32735665e-03,   2.55332308e-05,
         -2.53679776e+00,  -2.87012444e-04,   2.53341359e-01,
          1.18563739e-05,  -1.32681476e+00,  -3.75477717e-05],
       [ -1.99028976e-08,  -7.06802960e-08,  -2.63252024e-01,
         -1.18997457e-06,   1.02583430e-06,  -1.50751936e-05,
         -7.77186709e-01,   4.62414184e-01,   5.48551593e-05,
          2.05382407e-05,   2.45228756e-05,  -1.67581479e+00,
         -2.28258734e-05,   3.37376252e-05,  -7.38392117e-06,
          4.36827815e-06,  -1.20787505e-05,   9.41978349e-01],
       [  2.42468604e-03,  -6.02805673e-02,   8.14438951e-07,
          3.92814502e-01,  -6.64166492e-06,  -4.38280386e-01,
          1.49124102e-05,  -1.10059019e-05,   1.24423009e-01,
          5.80042463e-05,   1.16848507e+00,   1.04763687e-05,
          6.38458443e-01,   1.72235013e-04,  -1.41976116e-01,
         -2.12475895e-06,   6.73881996e-01,   1.53759090e-05],
       [  3.59670631e-08,  -4.38864703e-07,   5.61372685e-07,
         -8.25296869e-06,  -5.07423242e-01,  -2.83961585e-06,
          2.59499129e-07,  -1.27703180e-05,  -1.09275343e-05,
          1.03801027e+00,  -3.58602061e-05,   7.77938533e-06,
         -2.32630761e-05,  -1.05237682e-05,   2.13980585e-06,
          3.32061553e-02,  -4.62709179e-06,  -1.75244925e-06],
       [  2.15699868e-04,  -1.88283592e-02,  -3.33708081e-07,
          1.68331301e-02,  -6.44145645e-07,  -1.32405052e-02,
          6.42759957e-07,  -9.64440794e-06,   1.44456888e-01,
         -1.32434882e-06,  -6.18295013e-02,   1.95109323e-06,
         -1.60729382e-01,  -5.28169858e-04,   4.74645133e-01,
          8.33493635e-06,   9.80081028e-01,   1.40599076e-05],
       [  3.92471634e-09,   6.99601735e-08,  -2.16648039e-06,
          1.77287135e-07,  -8.37757984e-07,   4.74248154e-08,
         -4.55739361e-06,   2.92536071e-06,   1.17696543e-06,
          5.33399652e-06,  -5.31960699e-06,   1.74782617e-05,
          8.01407773e-06,   9.99999338e-01,   1.14240760e-03,
          1.37303113e-04,  -1.35514979e-05,  -1.05145354e-05],
       [ -1.38383560e-08,  -9.48297591e-07,   1.43822619e-07,
          1.28227699e-06,   3.43730472e-02,  -2.59291440e-06,
         -2.28764341e-07,   2.64725973e-06,  -7.51639544e-06,
         -1.51646192e-02,  -4.58099343e-06,   4.19237016e-06,
         -3.31234221e-06,  -1.37058477e-04,  -3.33108183e-05,
          9.99294005e-01,   7.76244329e-06,   1.67462138e-06],
       [ -1.24881533e-04,   4.73858741e-03,   2.08193903e-07,
          3.02066492e-02,  -1.59231757e-06,  -8.95499129e-03,
          6.52342627e-07,   7.64889174e-06,  -1.23132321e-01,
         -2.06056099e-07,   8.12474462e-02,  -6.31710803e-06,
          1.77968722e-01,  -1.00600873e-03,   8.73790261e-01,
          3.29888698e-05,  -5.10980308e-01,  -4.80060903e-06],
       [  2.09725720e-08,  -1.87977936e-07,   3.95137066e-02,
          5.77824568e-07,  -3.34640819e-07,  -4.14401824e-07,
          1.97790947e-02,   2.06393877e-01,   1.64899239e-05,
          3.32532339e-07,   1.56359506e-06,  -2.52163894e-02,
          8.50809057e-06,  -1.33890715e-05,   2.13312632e-06,
          1.70824689e-06,   1.83671828e-05,  -1.27435660e+00],
       [  1.90418324e-04,   1.39557691e-01,   2.41093780e-01,
         -1.37603255e-01,   4.46178631e-06,  -1.01220837e-01,
         -9.56970574e-02,   8.47886040e-01,  -8.13568932e-01,
          2.48959011e-05,   3.56304559e-01,  -1.21983743e-03,
          1.74409202e-01,   1.24105161e-04,  -9.07905883e-02,
         -1.69832954e-05,   8.28657418e-01,   9.55979424e-01],
       [  3.04378811e-03,   1.01391118e-03,   1.34174376e-01,
         -9.69446003e-02,   1.30811234e-05,  -9.50555736e-01,
         -1.28954227e+00,  -6.04600539e-01,   5.60995741e-01,
          2.46060801e-05,   1.50971533e-02,  -9.35476587e-01,
          6.68565313e-01,   6.11046206e-05,  -4.64547952e-02,
          6.91830815e-06,   1.10732961e-01,  -1.16467453e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_hybgga.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
