# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_hf_dft_rks_water_gga():
    ref_result_dm_alpha = array([[  9.81950507e-02,   4.71978998e-02,  -1.83796244e-02,
          4.01843358e-02,   1.25605775e-01,  -9.51454139e-02,
          1.12532936e-06,   1.79605836e-02,   6.29209342e-02,
         -6.27824690e-02,   2.01501441e-07,  -4.91061589e-03,
          1.28400444e-07,  -3.90977114e-07,  -3.75843393e-03,
         -9.07121761e-03,  -2.01872568e-02,  -1.91004210e-02],
       [  4.71978998e-02,   2.87668248e-02,   1.13929639e-02,
         -1.80033638e-02,   7.03438840e-02,  -5.63399587e-02,
         -3.62710049e-06,  -3.46758562e-02,   3.52380113e-02,
         -3.93904346e-02,  -3.30645828e-06,  -1.57261891e-03,
         -1.93586329e-08,  -2.13542012e-08,  -3.22427577e-03,
         -5.08017988e-03,  -1.91006239e-02,  -8.36250968e-03],
       [ -1.83796244e-02,   1.13929639e-02,   1.04147177e+00,
         -8.42680843e-02,   1.75538885e-07,  -2.01344565e-02,
         -9.55880244e-08,  -1.41407382e-01,  -4.75249698e-08,
         -1.60753106e-02,  -2.18074163e-07,   3.09340823e-03,
         -2.17480532e-07,  -9.08722650e-08,  -3.72932859e-03,
          1.24187863e-07,  -1.83799956e-02,   1.13933564e-02],
       [  4.01843358e-02,  -1.80033638e-02,  -8.42680843e-02,
          2.48952311e-01,  -2.18816842e-06,   4.19858315e-02,
          1.25296498e-06,   2.78942395e-01,  -8.73269494e-07,
          4.19368465e-02,   1.21639365e-06,  -6.29346977e-03,
          5.15007742e-07,   1.32423174e-07,   7.99493004e-03,
         -9.49864785e-08,   4.01868311e-02,  -1.80033192e-02],
       [  1.25605775e-01,   7.03438840e-02,   1.75538885e-07,
         -2.18816842e-06,   2.66543266e-01,   1.63506861e-06,
          1.67264076e-06,   3.06134878e-06,   1.33521806e-01,
         -1.42234643e-06,   1.62633171e-07,   4.89642241e-08,
         -3.07531529e-07,  -1.08534133e-06,   3.44936743e-07,
         -1.92498144e-02,  -1.25607749e-01,  -7.03450069e-02],
       [ -9.51454139e-02,  -5.63399587e-02,  -2.01344565e-02,
          4.19858315e-02,   1.63506861e-06,   3.26978310e-01,
         -7.65740590e-07,   1.32934319e-01,   4.83678401e-07,
          2.25321606e-01,  -1.02565438e-08,   1.11381625e-02,
         -5.08960323e-07,  -2.57504704e-07,   1.72106052e-02,
         -4.76919101e-07,  -9.51450435e-02,  -5.63411763e-02],
       [  1.12532936e-06,  -3.62710049e-06,  -9.55880244e-08,
          1.25296498e-06,   1.67264076e-06,  -7.65740590e-07,
          4.10554992e-01,  -3.44965946e-07,   5.89647953e-07,
         -3.25784652e-07,   3.26905219e-01,  -9.04410844e-07,
          4.50983782e-07,  -2.26234457e-02,  -7.06444456e-08,
         -1.06782151e-06,  -4.10682173e-07,   1.40162904e-06],
       [  1.79605836e-02,  -3.46758562e-02,  -1.41407382e-01,
          2.78942395e-01,   3.06134878e-06,   1.32934319e-01,
         -3.44965946e-07,   3.37641229e-01,   1.68612243e-06,
          1.05490552e-01,   1.23991350e-07,  -3.82939441e-03,
          4.19496287e-07,   1.56666555e-07,   1.32496637e-02,
         -5.91505511e-07,   1.79586781e-02,  -3.46787659e-02],
       [  6.29209342e-02,   3.52380113e-02,  -4.75249698e-08,
         -8.73269494e-07,   1.33521806e-01,   4.83678401e-07,
          5.89647953e-07,   1.68612243e-06,   6.68862244e-02,
         -9.29570686e-07,  -1.16194677e-07,   4.59212833e-09,
         -1.54053522e-07,  -5.30009497e-07,   1.61503374e-07,
         -9.64297474e-03,  -6.29216127e-02,  -3.52384824e-02],
       [ -6.27824690e-02,  -3.93904346e-02,  -1.60753106e-02,
          4.19368465e-02,  -1.42234643e-06,   2.25321606e-01,
         -3.25784652e-07,   1.05490552e-01,  -9.29570686e-07,
          1.55968645e-01,   1.61142772e-07,   7.26548817e-03,
         -3.19851699e-07,  -1.75824430e-07,   1.21671912e-02,
         -1.55503863e-07,  -6.27798013e-02,  -3.93899848e-02],
       [  2.01501441e-07,  -3.30645828e-06,  -2.18074163e-07,
          1.21639365e-06,   1.62633171e-07,  -1.02565438e-08,
          3.26905219e-01,   1.23991350e-07,  -1.16194677e-07,
          1.61142772e-07,   2.60298923e-01,  -7.04280785e-07,
          3.59097480e-07,  -1.80139631e-02,  -2.12910271e-08,
         -7.65815123e-07,   8.04182145e-08,   1.31481769e-06],
       [ -4.91061589e-03,  -1.57261891e-03,   3.09340823e-03,
         -6.29346977e-03,   4.89642241e-08,   1.11381625e-02,
         -9.04410844e-07,  -3.82939441e-03,   4.59212833e-09,
          7.26548817e-03,  -7.04280785e-07,   6.25733946e-04,
         -3.58056985e-08,   3.19792504e-08,   4.01953931e-04,
         -9.14194495e-09,  -4.91060291e-03,  -1.57262296e-03],
       [  1.28400444e-07,  -1.93586329e-08,  -2.17480532e-07,
          5.15007742e-07,  -3.07531529e-07,  -5.08960323e-07,
          4.50983782e-07,   4.19496287e-07,  -1.54053522e-07,
         -3.19851699e-07,   3.59097480e-07,  -3.58056985e-08,
          3.02820994e-12,  -2.48490698e-08,  -1.29661246e-08,
          2.22090186e-08,   4.18242385e-07,   1.42969497e-07],
       [ -3.90977114e-07,  -2.13542012e-08,  -9.08722650e-08,
          1.32423174e-07,  -1.08534133e-06,  -2.57504704e-07,
         -2.26234457e-02,   1.56666555e-07,  -5.30009497e-07,
         -1.75824430e-07,  -1.80139631e-02,   3.19792504e-08,
         -2.48490698e-08,   1.24665467e-03,  -6.15936570e-09,
          1.30568989e-07,   6.29713360e-07,   2.25762402e-07],
       [ -3.75843393e-03,  -3.22427577e-03,  -3.72932859e-03,
          7.99493004e-03,   3.44936743e-07,   1.72106052e-02,
         -7.06444456e-08,   1.32496637e-02,   1.61503374e-07,
          1.21671912e-02,  -2.12910271e-08,   4.01953931e-04,
         -1.29661246e-08,  -6.15936570e-09,   1.04381438e-03,
         -4.87464666e-08,  -3.75865395e-03,  -3.22450187e-03],
       [ -9.07121761e-03,  -5.08017988e-03,   1.24187863e-07,
         -9.49864785e-08,  -1.92498144e-02,  -4.76919101e-07,
         -1.06782151e-06,  -5.91505511e-07,  -9.64297474e-03,
         -1.55503863e-07,  -7.65815123e-07,  -9.14194495e-09,
          2.22090186e-08,   1.30568989e-07,  -4.87464666e-08,
          1.39022591e-03,   9.07147938e-03,   5.08040332e-03],
       [ -2.01872568e-02,  -1.91006239e-02,  -1.83799956e-02,
          4.01868311e-02,  -1.25607749e-01,  -9.51450435e-02,
         -4.10682173e-07,   1.79586781e-02,  -6.29216127e-02,
         -6.27798013e-02,   8.04182145e-08,  -4.91060291e-03,
          4.18242385e-07,   6.29713360e-07,  -3.75865395e-03,
          9.07147938e-03,   9.81958801e-02,   4.71984856e-02],
       [ -1.91004210e-02,  -8.36250968e-03,   1.13933564e-02,
         -1.80033192e-02,  -7.03450069e-02,  -5.63411763e-02,
          1.40162904e-06,  -3.46787659e-02,  -3.52384824e-02,
         -3.93899848e-02,   1.31481769e-06,  -1.57262296e-03,
          1.42969497e-07,   2.25762402e-07,  -3.22450187e-03,
          5.08040332e-03,   4.71984856e-02,   2.87676348e-02]])
    ref_result_energy = -76.31908112732782
    ref_result_exp_alpha = array([[  1.67094869e-04,   1.41662625e-01,  -2.43291624e-01,
         -1.37607827e-01,  -2.62974728e-06,   1.16202340e-01,
          1.14665272e-01,   8.42087975e-01,   7.95805621e-01,
          1.06610227e-04,   3.86654258e-01,   2.30694827e-02,
         -1.72287882e-01,   1.91632807e-04,   9.52172453e-02,
         -4.16834851e-05,   8.30199763e-01,  -9.57941513e-01],
       [  3.26826376e-03,   1.11025800e-03,  -1.36252218e-01,
         -1.00946918e-01,   4.79458251e-06,   9.33084959e-01,
          1.25951120e+00,  -6.57470128e-01,  -5.82784051e-01,
         -4.55732208e-05,  -4.62582204e-03,   9.40444329e-01,
         -6.73469431e-01,   8.96484199e-05,   5.02321947e-02,
         -2.26976758e-05,   1.12391790e-01,   1.28044989e-02],
       [  9.94910772e-01,  -2.11516613e-01,   1.70736067e-07,
         -8.29761601e-02,  -9.71016194e-07,   9.32498225e-02,
          7.43011151e-06,  -1.01187382e-05,   4.36515999e-02,
          4.67737577e-06,   5.94419316e-02,  -8.33163502e-07,
          6.80690243e-02,   1.17704047e-06,  -7.03621766e-04,
          1.88257920e-06,   1.74953413e-02,   8.62671024e-07],
       [  2.90524663e-02,   4.62726469e-01,   3.15255334e-06,
          1.84370298e-01,   6.57204401e-07,  -1.72175843e-01,
         -1.44599731e-05,   5.37482988e-05,  -1.95239150e-01,
          2.58924829e-06,  -3.53545278e-01,  -7.52822300e-06,
         -1.61543608e+00,   2.09713826e-04,   1.35765926e-01,
         -7.73469541e-05,   5.61188148e-01,   4.39338173e-05],
       [  4.43223278e-09,  -1.69105027e-06,  -5.16278166e-01,
          1.16296183e-06,   1.58082507e-07,   3.05491088e-05,
         -4.30714158e-01,  -2.22212456e-01,  -2.01094337e-06,
          9.68325279e-07,  -4.28576168e-06,   9.76354907e-01,
         -1.30493252e-05,   1.95385481e-05,  -5.52668494e-06,
          5.92461659e-06,  -4.56200000e-08,  -3.85779176e-02],
       [ -1.65310144e-03,  -1.30943282e-01,  -1.43609022e-06,
          5.56623119e-01,   9.57400332e-06,   2.81697150e-01,
          2.30521666e-05,  -7.55834282e-05,   5.51515439e-01,
          6.45460597e-06,  -7.89631696e-01,  -1.75959690e-05,
          1.87723877e-01,  -1.75076456e-05,  -8.21346169e-03,
          1.01287450e-05,  -4.17560250e-02,  -5.83210346e-06],
       [  2.90709055e-08,  -3.01508948e-07,  -3.43593656e-06,
          9.60676360e-06,  -6.40745550e-01,   3.45669550e-06,
          3.50417407e-06,  -1.85053495e-05,  -7.79095317e-05,
          9.62000321e-01,  -4.16614693e-05,  -5.18509516e-06,
          1.81310358e-05,   8.40986052e-06,  -1.00832886e-05,
         -6.84319746e-03,  -5.20147073e-06,   2.70515227e-06],
       [ -1.42366490e-02,   4.64992074e-01,  -6.66805968e-06,
          3.48168114e-01,   5.67147350e-06,  -1.09843863e+00,
         -8.23526697e-05,  -3.87809995e-05,   1.80891143e-01,
         -3.76434103e-05,   4.90170241e-03,   1.48568252e-05,
          2.53753354e+00,  -4.41687819e-04,  -2.70094592e-01,
          1.37235393e-04,  -1.33583338e+00,  -9.98930851e-05],
       [ -2.93164837e-08,  -1.88432348e-07,  -2.58623690e-01,
          1.06555298e-07,   4.66634458e-07,   5.22560735e-05,
         -7.58517085e-01,  -3.97403898e-01,  -1.23007308e-04,
         -1.73211820e-05,  -1.21283474e-05,  -1.69861202e+00,
          2.23034108e-05,  -4.21090807e-05,   1.07378210e-05,
          4.80622527e-07,  -4.96382850e-05,   9.47300923e-01],
       [  2.56646124e-03,  -6.47549182e-02,   3.88477578e-06,
          3.89575275e-01,   6.32262183e-06,   4.31185710e-01,
          3.30570445e-05,   1.03267678e-06,  -1.81346475e-01,
          5.12414670e-05,   1.16322374e+00,   1.82289488e-06,
         -6.33785642e-01,   2.63297501e-04,   1.50516009e-01,
         -5.46092487e-05,   6.78652473e-01,   4.75241269e-05],
       [ -1.58318955e-08,  -1.54685005e-07,  -4.71185279e-07,
          8.76841783e-06,  -5.10195096e-01,  -1.07189284e-06,
         -3.00940586e-07,   1.70266900e-05,   8.28128637e-05,
         -1.03658997e+00,   4.42850246e-05,   4.67828059e-06,
         -1.64906290e-05,  -1.08388280e-05,   2.50507584e-06,
         -3.50499187e-02,   6.10506802e-06,  -3.51118470e-06],
       [  1.95009804e-04,  -1.97363288e-02,  -3.28708994e-09,
          1.53679249e-02,   1.71276383e-06,   1.28191500e-02,
          1.76720007e-06,   2.55583800e-05,  -1.41548706e-01,
         -1.56371415e-05,  -6.82244277e-02,   7.39989510e-06,
          1.62482682e-01,  -7.26537350e-04,  -4.74431718e-01,
          8.09918186e-05,   9.79906958e-01,   5.83050093e-05],
       [  1.85572996e-08,   1.34958837e-06,   6.39191545e-07,
         -5.96819584e-07,  -6.80324142e-07,  -2.12219383e-06,
          2.14867048e-06,  -1.36581568e-06,  -4.40886362e-06,
         -9.37150737e-06,  -1.08955564e-05,  -1.85506701e-05,
         -8.68643525e-06,   9.99998744e-01,  -1.58413185e-03,
         -2.23193641e-05,  -2.54288072e-05,   1.25263221e-05],
       [ -5.26861402e-09,   6.20281431e-07,   2.11304190e-06,
         -9.76168717e-07,   3.53080001e-02,  -9.73837436e-07,
         -7.53810715e-08,  -6.44240978e-06,  -2.94657737e-07,
          1.64089685e-02,  -3.79054240e-06,   6.03139590e-06,
          3.24187518e-05,  -2.23964963e-05,  -1.71635487e-04,
         -9.99241742e-01,  -5.96747664e-06,   9.41825548e-06],
       [ -1.15449032e-04,   4.53997573e-03,  -5.90349060e-07,
          3.19873367e-02,   5.85450583e-07,   1.03910914e-02,
         -1.37080771e-06,  -2.08347666e-05,   1.20619673e-01,
          6.34793940e-06,   8.99956988e-02,  -1.40254578e-05,
         -1.85319640e-01,  -1.39605849e-03,  -8.73074483e-01,
          1.46729606e-04,  -5.08583797e-01,  -3.13615644e-05],
       [  2.15385270e-08,  -1.42810095e-07,   3.72857280e-02,
         -8.12309402e-07,   1.46657244e-06,  -5.96017708e-07,
          1.72510261e-02,  -2.09832155e-01,  -4.02776506e-05,
          3.30943574e-07,  -4.39479444e-06,  -3.38064993e-02,
         -8.65164141e-06,   1.49843929e-05,   1.75885254e-06,
         -1.07228907e-05,   7.76747502e-05,  -1.27369986e+00],
       [  1.67077467e-04,   1.41663819e-01,   2.43293932e-01,
         -1.37605670e-01,  -2.84171659e-06,   1.16205846e-01,
         -1.14639392e-01,  -8.42379594e-01,   7.95522558e-01,
          7.11840077e-05,   3.86606651e-01,  -2.31224732e-02,
         -1.72284575e-01,   1.64644984e-04,   9.52126361e-02,
         -1.25836415e-05,   8.30083398e-01,   9.58042283e-01],
       [  3.26824064e-03,   1.10914676e-03,   1.36253938e-01,
         -1.00948741e-01,  -4.51488013e-06,   9.33282296e-01,
         -1.25937621e+00,   6.57664837e-01,  -5.82617970e-01,
         -2.65159654e-05,  -4.59164555e-03,  -9.40416457e-01,
         -6.73437575e-01,   6.21421249e-05,   5.02500920e-02,
         -4.20222759e-05,   1.12404916e-01,  -1.27762978e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_gga.py")

    l = {}
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], l[k], v), l[k] - l[var_name]
