# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_uks_methyl_hybgga():
    ref_result_dm_alpha = array([[  1.03161118e+00,  -4.82044226e-02,  -2.85003057e-06,
         -3.64627863e-06,   3.74870785e-07,  -1.05601044e-01,
         -1.11621582e-06,  -1.54927285e-06,   1.33008190e-07,
          1.77791376e-03,   3.27402300e-08,   1.50253509e-09,
          2.02397122e-08,   1.59241894e-07,  -2.90657607e-02,
         -4.66463806e-03,  -2.90672672e-02,  -4.66348227e-03,
         -2.90728243e-02,  -4.65671566e-03],
       [ -4.82044226e-02,   1.63501111e-01,   5.97846482e-06,
          6.41777091e-06,  -1.28844760e-06,   1.67152701e-01,
          2.36990309e-06,   2.55821780e-06,  -6.84707240e-07,
         -2.93728180e-03,  -5.16255407e-08,  -4.42053518e-08,
          9.87908853e-08,  -4.05846269e-07,   5.55353879e-02,
          1.81818445e-02,   5.55375689e-02,   1.81790231e-02,
          5.55499878e-02,   1.81663176e-02],
       [ -2.85003057e-06,   5.97846482e-06,   2.00953909e-01,
         -5.45039784e-06,   5.28038526e-07,   5.92212679e-06,
          9.13760159e-02,  -1.88053859e-06,   1.33298487e-06,
         -1.52433981e-06,  -5.72323725e-07,   3.12772922e-07,
          1.05508165e-02,  -2.64858038e-06,   1.23423375e-01,
          1.03314088e-01,  -6.17181995e-02,  -5.16581669e-02,
         -6.17276124e-02,  -5.16460336e-02],
       [ -3.64627863e-06,   6.41777091e-06,  -5.45039784e-06,
          2.00945671e-01,  -2.63210197e-06,   1.21318977e-05,
         -5.82520330e-06,   9.13719184e-02,  -2.45609500e-06,
          1.95252307e-06,  -1.06403147e-07,   1.13027676e-06,
         -4.48373541e-07,  -1.05487588e-02,  -2.07821341e-06,
         -3.08797676e-06,   1.06893132e-01,   8.94609271e-02,
         -1.06920563e-01,  -8.94510427e-02],
       [  3.74870785e-07,  -1.28844760e-06,   5.28038526e-07,
         -2.63210197e-06,   3.65771238e-01,  -2.02664415e-06,
          1.30795310e-06,  -3.71688765e-07,   3.16398459e-01,
         -1.14773242e-06,  -1.68889266e-06,   3.10459238e-06,
         -5.94591682e-07,   1.23856107e-06,  -2.81196973e-06,
          1.71418778e-06,   4.35462495e-06,   6.03486712e-07,
         -8.76556721e-07,   9.63993376e-07],
       [ -1.05601044e-01,   1.67152701e-01,   5.92212679e-06,
          1.21318977e-05,  -2.02664415e-06,   1.74003546e-01,
          2.33214729e-06,   5.14830017e-06,  -1.31009382e-06,
         -3.05336357e-03,  -5.37472756e-08,  -4.45299613e-08,
          8.51324603e-08,  -7.04444767e-07,   5.74781624e-02,
          1.85492645e-02,   5.74835819e-02,   1.85489918e-02,
          5.74905588e-02,   1.85309619e-02],
       [ -1.11621582e-06,   2.36990309e-06,   9.13760159e-02,
         -5.82520330e-06,   1.30795310e-06,   2.33214729e-06,
          4.15497082e-02,  -2.37694176e-06,   1.52983240e-06,
         -6.86841389e-07,  -2.60245119e-07,   1.42211717e-07,
          4.79757564e-03,  -1.02864151e-06,   5.61218853e-02,
          4.69780460e-02,  -2.80658631e-02,  -2.34910816e-02,
         -2.80665822e-02,  -2.34825845e-02],
       [ -1.54927285e-06,   2.55821780e-06,  -1.88053859e-06,
          9.13719184e-02,  -3.71688765e-07,   5.14830017e-06,
         -2.37694176e-06,   4.15476852e-02,  -4.03036434e-07,
          8.94293816e-07,  -4.83879274e-08,   5.13955683e-07,
         -1.72493481e-07,  -4.79662153e-03,  -7.00133078e-07,
         -1.13681123e-06,   4.86050234e-02,   4.06785455e-02,
         -4.86181087e-02,  -4.06744383e-02],
       [  1.33008190e-07,  -6.84707240e-07,   1.33298487e-06,
         -2.45609500e-06,   3.16398459e-01,  -1.31009382e-06,
          1.52983240e-06,  -4.03036434e-07,   2.73690149e-01,
         -1.00059602e-06,  -1.46092395e-06,   2.68552644e-06,
         -4.68327648e-07,   1.08077528e-06,  -1.74745534e-06,
          1.98102747e-06,   3.54915547e-06,   2.64716753e-07,
         -7.85160934e-07,   7.36197539e-07],
       [  1.77791376e-03,  -2.93728180e-03,  -1.52433981e-06,
          1.95252307e-06,  -1.14773242e-06,  -3.05336357e-03,
         -6.86841389e-07,   8.94293816e-07,  -1.00059602e-06,
          5.35854082e-05,   9.51494308e-10,   7.83307859e-10,
         -7.60734221e-08,  -1.01290193e-07,  -1.00993423e-03,
         -3.26739369e-04,  -1.00756890e-03,  -3.24675164e-04,
         -1.00999548e-03,  -3.26286731e-04],
       [  3.27402300e-08,  -5.16255407e-08,  -5.72323725e-07,
         -1.06403147e-07,  -1.68889266e-06,  -5.37472756e-08,
         -2.60245119e-07,  -4.83879274e-08,  -1.46092395e-06,
          9.51494308e-10,   9.50115138e-12,  -1.58106519e-11,
         -3.00460635e-08,   5.58899262e-09,  -3.69248003e-07,
         -2.99974983e-07,   1.01390578e-07,   9.40126148e-08,
          2.14681768e-07,   1.88739305e-07],
       [  1.50253509e-09,  -4.42053518e-08,   3.12772922e-07,
          1.13027676e-06,   3.10459238e-06,  -4.45299613e-08,
          1.42211717e-07,   5.13955683e-07,   2.68552644e-06,
          7.83307859e-10,  -1.58106519e-11,   3.32079660e-11,
          1.64155869e-08,  -5.93297388e-08,   1.77199759e-07,
          1.55886268e-07,   4.90352641e-07,   4.17881578e-07,
         -7.12401038e-07,  -5.88463910e-07],
       [  2.02397122e-08,   9.87908853e-08,   1.05508165e-02,
         -4.48373541e-07,  -5.94591682e-07,   8.51324603e-08,
          4.79757564e-03,  -1.72493481e-07,  -4.68327648e-07,
         -7.60734221e-08,  -3.00460635e-08,   1.64155869e-08,
          5.53956528e-04,  -1.30546775e-07,   6.48010501e-03,
          5.42434433e-03,  -3.24059229e-03,  -2.71233910e-03,
         -3.24091392e-03,  -2.71155762e-03],
       [  1.59241894e-07,  -4.05846269e-07,  -2.64858038e-06,
         -1.05487588e-02,   1.23856107e-06,  -7.04444767e-07,
         -1.02864151e-06,  -4.79662153e-03,   1.08077528e-06,
         -1.01290193e-07,   5.58899262e-09,  -5.93297388e-08,
         -1.30546775e-07,   5.53763221e-04,  -1.71609911e-06,
         -1.35436575e-06,  -5.61053800e-03,  -4.69555625e-03,
          5.61373535e-03,   4.69653063e-03],
       [ -2.90657607e-02,   5.55353879e-02,   1.23423375e-01,
         -2.07821341e-06,  -2.81196973e-06,   5.74781624e-02,
          5.61218853e-02,  -7.00133078e-07,  -1.74745534e-06,
         -1.00993423e-03,  -3.69248003e-07,   1.77199759e-07,
          6.48010501e-03,  -1.71609911e-06,   9.48242777e-02,
          6.96197915e-02,  -1.88852198e-02,  -2.55620279e-02,
         -1.88857673e-02,  -2.55580987e-02],
       [ -4.66463806e-03,   1.81818445e-02,   1.03314088e-01,
         -3.08797676e-06,   1.71418778e-06,   1.85492645e-02,
          4.69780460e-02,  -1.13681123e-06,   1.98102747e-06,
         -3.26739369e-04,  -2.99974983e-07,   1.55886268e-07,
          5.42434433e-03,  -1.35436575e-06,   6.96197915e-02,
          5.51373387e-02,  -2.55645626e-02,  -2.45369841e-02,
         -2.55669604e-02,  -2.45312680e-02],
       [ -2.90672672e-02,   5.55375689e-02,  -6.17181995e-02,
          1.06893132e-01,   4.35462495e-06,   5.74835819e-02,
         -2.80658631e-02,   4.86050234e-02,   3.54915547e-06,
         -1.00756890e-03,   1.01390578e-07,   4.90352641e-07,
         -3.24059229e-03,  -5.61053800e-03,  -1.88852198e-02,
         -2.55645626e-02,   9.48374510e-02,   6.96185408e-02,
         -1.88895747e-02,  -2.55583837e-02],
       [ -4.66348227e-03,   1.81790231e-02,  -5.16581669e-02,
          8.94609271e-02,   6.03486712e-07,   1.85489918e-02,
         -2.34910816e-02,   4.06785455e-02,   2.64716753e-07,
         -3.24675164e-04,   9.40126148e-08,   4.17881578e-07,
         -2.71233910e-03,  -4.69555625e-03,  -2.55620279e-02,
         -2.45369841e-02,   6.96185408e-02,   5.51276481e-02,
         -2.55651774e-02,  -2.45265325e-02],
       [ -2.90728243e-02,   5.55499878e-02,  -6.17276124e-02,
         -1.06920563e-01,  -8.76556721e-07,   5.74905588e-02,
         -2.80665822e-02,  -4.86181087e-02,  -7.85160934e-07,
         -1.00999548e-03,   2.14681768e-07,  -7.12401038e-07,
         -3.24091392e-03,   5.61373535e-03,  -1.88857673e-02,
         -2.55669604e-02,  -1.88895747e-02,  -2.55651774e-02,
          9.48891559e-02,   6.96269113e-02],
       [ -4.65671566e-03,   1.81663176e-02,  -5.16460336e-02,
         -8.94510427e-02,   9.63993376e-07,   1.85309619e-02,
         -2.34825845e-02,  -4.06744383e-02,   7.36197539e-07,
         -3.26286731e-04,   1.88739305e-07,  -5.88463910e-07,
         -2.71155762e-03,   4.69653063e-03,  -2.55580987e-02,
         -2.45312680e-02,  -2.55583837e-02,  -2.45265325e-02,
          6.96269113e-02,   5.51135525e-02]])
    ref_result_energy = -39.829440562744253
    ref_result_exp_alpha = array([[  9.95043896e-01,  -2.03712610e-01,   1.27609005e-05,
         -8.93820420e-07,  -4.30028067e-07,   1.52591461e-01,
          3.83028925e-07,   2.44112279e-05,  -6.16791419e-07,
         -1.28665135e-06,   4.98263935e-06,  -4.93213617e-02,
         -2.71943577e-06,   3.61819075e-06,   3.63167451e-02,
          3.53637708e-06,  -1.79028210e-06,   4.10982691e-02,
          8.43218257e-07,  -2.75213435e-05],
       [  3.40435820e-02,   4.02917047e-01,  -2.34421175e-05,
          3.25886144e-06,   1.69264400e-06,  -2.38990068e-01,
         -1.27025930e-05,  -4.44048557e-05,   1.20730781e-05,
         -3.75536435e-05,   6.15320170e-05,  -6.72353093e-01,
          4.63712361e-04,   3.67122568e-05,  -1.94676276e+00,
          5.04151947e-05,  -1.98023021e-05,   2.69479575e-01,
          6.62752442e-06,  -1.21044335e-04],
       [  5.06167792e-08,   1.28125387e-08,  -1.98897153e-01,
          4.01738516e-01,  -2.69846154e-06,  -3.36942201e-05,
         -3.50353850e-01,   2.40927095e-01,  -1.23415740e-05,
         -7.71617088e-01,  -2.76153389e-01,  -3.28797895e-05,
         -5.41350203e-01,   5.57909257e-01,  -9.47963519e-05,
         -4.25758908e-06,  -2.63744889e-07,  -6.08792605e-07,
         -4.70845303e-02,  -3.71896117e-02],
       [  1.11693918e-07,  -5.84295903e-06,  -4.01724887e-01,
         -1.98903980e-01,   2.93024895e-06,  -5.41092862e-05,
          2.40928402e-01,   3.50325770e-01,   3.10344698e-05,
         -2.76171893e-01,   7.71620503e-01,   1.47560104e-04,
          5.57916339e-01,   5.41351151e-01,   1.25342432e-04,
         -2.88218021e-07,  -9.76567127e-06,   3.76525663e-07,
          3.71695076e-02,  -4.71306266e-02],
       [ -2.04788360e-08,  -6.46487382e-07,   2.81445201e-06,
         -1.35192806e-06,  -6.04790252e-01,   1.04385922e-06,
         -4.35864662e-07,  -6.03242743e-07,   1.05587688e+00,
         -6.98519753e-06,  -6.34269581e-05,   2.20746425e-06,
          2.48519973e-05,   5.43477634e-06,   5.14600044e-06,
         -1.56922413e-06,   9.09993584e-06,   1.04075363e-06,
          3.83537435e-06,  -5.16142784e-06],
       [ -2.08342245e-02,   4.16616741e-01,  -3.49890648e-05,
         -2.60263249e-06,   2.83216520e-06,  -1.88774588e+00,
         -4.06986050e-06,  -2.86449704e-04,  -1.50605960e-05,
          8.42501580e-05,  -9.35042099e-05,   1.04425596e+00,
         -8.41484735e-04,  -5.62266093e-05,   3.57262136e+00,
         -1.25486641e-04,   5.35553799e-05,  -7.86164394e-01,
         -1.49278004e-05,   3.95844766e-04],
       [  2.59396217e-08,  -8.56946554e-07,  -9.04340968e-02,
          1.82678385e-01,  -2.99352916e-06,  -9.28606779e-05,
         -1.08121993e+00,   7.43602501e-01,   2.88098732e-05,
          1.58302894e+00,   5.66581043e-01,   7.37990552e-05,
          7.86598713e-01,  -8.10699379e-01,   1.28937779e-04,
          3.78463398e-05,   2.72817956e-05,  -1.90025919e-04,
         -4.15033874e-01,  -3.27710309e-01],
       [ -2.12027261e-08,  -3.54621996e-06,  -1.82668776e-01,
         -9.04423745e-02,  -3.08816347e-08,  -1.68981232e-04,
          7.43595876e-01,   1.08127326e+00,  -7.01537445e-05,
          5.66546670e-01,  -1.58301254e+00,  -2.97464266e-04,
         -8.10689006e-01,  -7.86601248e-01,  -1.80104196e-04,
         -1.08141737e-06,   2.50619293e-05,  -2.41297971e-04,
          3.27724005e-01,  -4.15022089e-01],
       [  5.63910768e-09,   4.94137113e-07,   1.92474255e-06,
          7.58359113e-07,  -5.23154030e-01,  -4.43254083e-06,
          4.22932956e-06,   2.30313422e-06,  -1.09861599e+00,
          4.41912509e-06,   6.55028299e-05,  -1.21898866e-06,
         -2.00292409e-05,  -5.90150197e-06,  -6.10275146e-06,
         -4.15917248e-06,  -6.04553304e-06,   7.29895699e-07,
         -2.10813449e-06,   3.14606460e-06],
       [  2.89294896e-04,  -7.31448532e-03,  -2.30980742e-06,
         -4.94028618e-06,   1.88980079e-06,  -1.48273360e-02,
          2.14216427e-06,  -1.11537823e-05,  -1.79463966e-07,
         -4.33939789e-08,  -2.26751441e-06,   1.83891234e-01,
         -3.27179356e-05,  -5.52236730e-05,  -3.07126950e-02,
          1.19726659e-04,  -5.64529157e-05,   1.05118128e+00,
          6.04203373e-06,  -5.64736388e-04],
       [  6.57051085e-09,  -1.28221531e-07,   7.73701171e-07,
         -1.02776882e-06,   2.78748414e-06,   3.15006960e-07,
          2.49036233e-06,  -2.95613272e-08,  -6.96290919e-06,
          4.05843152e-06,  -1.39641868e-06,   5.17501107e-06,
          5.64288382e-06,   1.80275326e-05,  -4.36458787e-06,
          3.59515670e-02,   9.99353531e-01,   4.85697609e-05,
          1.66413658e-05,   4.33104759e-05],
       [ -2.06128082e-08,  -1.08785979e-07,  -2.58029357e-06,
         -4.98905260e-07,  -5.12962507e-06,   5.60719104e-07,
         -3.92369281e-07,   4.88872484e-07,  -1.14256864e-06,
         -2.68846470e-06,   4.22919881e-06,  -9.79445638e-06,
         -1.02980112e-05,   5.45985702e-07,   1.38058510e-05,
          9.99353526e-01,  -3.59515631e-02,  -1.13614895e-04,
          4.24079208e-05,   2.98742789e-05],
       [  6.30445312e-08,  -5.38019459e-07,  -1.04425087e-02,
          2.10929057e-02,   8.87419910e-07,  -5.24349525e-06,
          1.43152163e-02,  -9.86380778e-03,  -5.16450593e-06,
         -1.08421945e-01,  -3.87907048e-02,   2.59370078e-05,
          1.36418534e-01,  -1.40671570e-01,   1.11205431e-05,
          5.91074427e-05,   4.33616524e-05,  -3.63898059e-04,
         -8.51608188e-01,  -6.72431117e-01],
       [ -7.20840729e-08,   1.41480361e-07,   2.10916814e-02,
          1.04357076e-02,  -1.97307614e-06,   4.42830636e-06,
          9.85518382e-03,   1.43376428e-02,  -4.82449751e-06,
          3.88190254e-02,  -1.08420416e-01,  -3.28147903e-05,
          1.40634899e-01,   1.36501343e-01,   5.33306581e-05,
          4.06578993e-06,  -2.94736809e-05,   4.80277473e-04,
         -6.72441803e-01,   8.51591335e-01],
       [ -9.75497801e-04,   1.37906619e-01,  -1.22164290e-01,
          2.46740708e-01,   3.39248155e-06,   1.00039373e-01,
          8.83365027e-02,  -6.07430476e-02,  -2.04198126e-05,
         -4.11143477e-01,  -1.47102237e-01,  -6.36394174e-01,
          6.08356680e-01,  -6.26904079e-01,   2.92055562e-01,
          2.10185667e-06,  -3.15157066e-05,   3.76566576e-01,
          5.34056883e-01,   4.21487194e-01],
       [  4.47311522e-03,   4.47399412e-02,  -1.02256614e-01,
          2.06541131e-01,  -3.79086524e-06,   9.72155842e-01,
          1.37198659e+00,  -9.43389356e-01,   9.89741817e-06,
         -4.20512226e-01,  -1.50517694e-01,   2.08901409e-01,
         -1.06865066e+00,   1.10155613e+00,  -1.08258921e+00,
          1.09288458e-05,  -2.55312750e-05,   6.35855405e-02,
          8.72919342e-03,   6.85322250e-03],
       [ -9.75514984e-04,   1.37914110e-01,  -1.52612320e-01,
         -2.29184781e-01,  -7.53600203e-06,   1.00054955e-01,
         -9.68007116e-02,  -4.61281923e-02,   4.61456793e-05,
          7.81238691e-02,   4.29702892e-01,  -6.36460441e-01,
         -8.47131616e-01,  -2.13350789e-01,   2.91740438e-01,
          4.08202674e-05,  -6.54131236e-06,   3.76460673e-01,
         -6.32202996e-01,   2.51459932e-01],
       [  4.47316673e-03,   4.47346910e-02,  -1.27718390e-01,
         -1.91818756e-01,  -1.18861924e-06,   9.72141359e-01,
         -1.50310088e+00,  -7.16253139e-01,  -7.76391595e-06,
          7.99306491e-02,   4.39355265e-01,   2.09207519e-01,
          1.48862246e+00,   3.74873629e-01,  -1.08207580e+00,
          3.60487021e-05,  -2.17541313e-05,   6.35945425e-02,
         -1.03451428e-02,   4.06664205e-03],
       [ -9.75343360e-04,   1.37968077e-01,   2.74852991e-01,
         -1.75739579e-02,   2.63058650e-06,   1.00020625e-01,
          8.42753598e-03,   1.06895993e-01,  -2.80150966e-05,
          3.32962856e-01,  -2.82377200e-01,  -6.36332710e-01,
          2.38745644e-01,   8.40275207e-01,   2.91954818e-01,
          5.29198351e-05,  -6.56377039e-06,   3.76034237e-01,
          9.81684743e-02,  -6.73665325e-01],
       [  4.47305271e-03,   4.47225337e-02,   2.29950074e-01,
         -1.47101014e-02,  -5.10278952e-07,   9.71749082e-01,
          1.31163304e-01,   1.66009821e+00,   6.22915814e-06,
          3.40530141e-01,  -2.88919610e-01,   2.08828300e-01,
         -4.19337877e-01,  -1.47645046e+00,  -1.08249760e+00,
          2.30060845e-05,   1.71677158e-05,   6.35001153e-02,
          1.61485505e-03,  -1.09331866e-02]])
    ref_result_exp_beta = array([[  9.95305288e-01,  -1.94675845e-01,  -1.46897202e-05,
          9.65594294e-07,   2.46807351e-06,   1.60149315e-01,
          1.56397732e-05,  -2.61870951e-05,   2.57092707e-06,
         -5.83265737e-06,   1.49589155e-06,  -5.98253701e-02,
         -2.33424053e-06,   6.18377769e-06,   3.89591783e-02,
         -1.89652664e-07,   1.37288493e-06,   3.25562499e-02,
          2.66091967e-07,  -4.49271933e-05],
       [  3.22912265e-02,   3.80263959e-01,   2.59635154e-05,
         -4.71755436e-06,  -1.28172815e-05,  -2.37205016e-01,
         -3.81959446e-05,   3.65332619e-05,   5.53419005e-05,
         -4.77520327e-05,  -2.73992686e-05,  -5.89169146e-01,
         -3.11523855e-04,   8.45003078e-05,  -1.97133230e+00,
         -6.68667690e-05,   1.63899485e-05,   3.16227107e-01,
          5.98064566e-06,  -3.57733386e-04],
       [  3.13588706e-07,  -2.91640499e-07,   1.87658983e-01,
         -3.84833632e-01,   7.03500976e-06,  -4.66829888e-05,
         -1.74496581e-01,  -3.87295752e-01,   7.26111166e-01,
          3.47021843e-01,  -1.24839985e-04,  -2.26075850e-05,
          5.46192835e-01,   5.89928641e-01,  -3.54044674e-05,
          1.96806542e-05,   2.36214340e-06,  -3.40432787e-05,
          4.55480245e-02,  -3.85424108e-02],
       [  7.11341500e-08,  -1.37575636e-05,   3.84826443e-01,
          1.87662209e-01,   1.77557869e-05,  -6.78149556e-05,
          3.87284199e-01,  -1.74471448e-01,   3.47053043e-01,
         -7.26112018e-01,  -1.97572525e-04,   1.92858153e-04,
         -5.89939423e-01,   5.46177936e-01,   8.94063350e-05,
         -5.48538852e-06,   3.06509487e-05,  -2.78875080e-05,
         -3.85234204e-02,  -4.55931869e-02],
       [  3.85846889e-07,   8.46418275e-06,  -2.68687612e-05,
         -2.54096420e-06,  -5.03957852e-01,   1.22535502e-06,
         -3.60198280e-06,   4.46960678e-06,  -2.97185699e-04,
          2.12094785e-04,  -1.10755297e+00,  -5.59169650e-05,
         -4.29563632e-05,   6.16704712e-05,   3.35114417e-05,
         -3.78921266e-06,  -4.92896241e-06,  -2.09488283e-05,
         -1.71227776e-05,  -1.28214389e-05],
       [ -1.96573523e-02,   3.57266481e-01,   3.16108974e-05,
          3.18731289e-06,  -1.97205863e-05,  -1.95055375e+00,
         -1.84232983e-04,   3.14986715e-04,  -1.14424762e-04,
          6.40950135e-05,   8.29203965e-05,   9.81024955e-01,
          5.59051434e-04,  -1.55844443e-04,   3.55909826e+00,
          1.26654077e-04,  -4.55362010e-05,  -8.04648939e-01,
         -1.67197688e-05,   9.45513288e-04],
       [ -1.57803030e-07,  -1.98240065e-06,   7.99825349e-02,
         -1.64042330e-01,  -1.01267973e-06,  -1.18915917e-04,
         -5.48943583e-01,  -1.21855831e+00,  -1.49014507e+00,
         -7.12203343e-01,   2.40277109e-04,   5.12546777e-05,
         -7.80209635e-01,  -8.42716206e-01,   4.38511124e-05,
         -7.41191617e-05,   6.70755894e-06,  -4.34403340e-04,
          4.03986789e-01,  -3.41678489e-01],
       [ -3.32686894e-08,  -5.86175118e-06,   1.64034697e-01,
          7.99886421e-02,   3.18557437e-06,  -2.13282684e-04,
          1.21857530e+00,  -5.48985188e-01,  -7.12190017e-01,
          1.49013647e+00,   3.98523924e-04,  -3.70579027e-04,
          8.42712489e-01,  -7.80185552e-01,  -1.26080511e-04,
          3.87924836e-05,  -3.98593348e-05,  -4.93186805e-04,
         -3.41692387e-01,  -4.03977060e-01],
       [ -1.45595090e-07,   2.49422559e-07,  -6.93546877e-06,
         -4.05210008e-06,  -6.23071948e-01,   2.30941628e-05,
          2.62206832e-05,  -2.67759635e-05,   2.94016749e-04,
         -2.10604196e-04,   1.04519302e+00,   4.90235576e-05,
          3.40757381e-05,  -5.14389742e-05,  -2.58529201e-05,
          7.23936721e-06,   1.07400678e-06,   1.24948346e-05,
          8.34374878e-06,   6.15317291e-06],
       [ -6.51935640e-04,  -3.12044945e-02,  -6.23132889e-08,
          4.66541835e-06,  -7.46037262e-06,   1.24567512e-02,
         -1.45041844e-06,   5.15854720e-06,  -5.26536823e-07,
          3.95460656e-06,  -2.46047000e-05,   1.56854026e-01,
          4.24317400e-05,  -5.26372080e-05,   3.30867311e-03,
         -8.18436915e-05,   6.41695638e-05,   1.05558989e+00,
          3.42932262e-05,  -1.27358261e-03],
       [ -2.17355012e-07,  -7.15025377e-07,   3.23536388e-06,
          3.43770285e-06,   2.62968101e-06,   1.16444879e-06,
          7.09398246e-06,  -1.89271242e-06,  -4.05339677e-06,
         -3.70901291e-06,   3.77990089e-06,   6.34615095e-06,
         -1.24385535e-05,   2.99880234e-05,   2.80143750e-06,
         -1.73115529e-01,  -9.84901523e-01,   4.54725886e-05,
          1.16305890e-05,   6.22513595e-06],
       [ -4.72058447e-07,  -3.28851587e-06,   1.52247486e-06,
         -5.64405895e-06,  -3.84653494e-06,   3.71958252e-06,
         -5.17049603e-06,  -4.22399424e-06,   5.66862007e-06,
          6.01250046e-06,   4.35281252e-06,  -1.13236365e-05,
          2.05386589e-05,   3.94073252e-06,   2.34364332e-05,
         -9.84901515e-01,   1.73115522e-01,  -8.53929358e-05,
         -1.10547544e-04,   1.90185462e-05],
       [  1.89448642e-08,  -1.25855391e-06,   1.01902905e-02,
         -2.08917808e-02,  -1.69723914e-06,  -4.28885127e-06,
          6.01237145e-03,   1.33777442e-02,   1.05819291e-01,
          5.05565790e-02,  -2.55479235e-05,   2.64841895e-05,
         -1.28909952e-01,  -1.39316120e-01,  -2.36375311e-06,
         -1.05205696e-04,   2.05489472e-05,  -8.78815710e-04,
          8.29184792e-01,  -7.01306566e-01],
       [ -2.98436042e-09,   1.80928756e-06,  -2.08919129e-02,
         -1.01823123e-02,  -8.42543111e-06,   3.21034136e-06,
          1.33817088e-02,  -6.03521447e-03,  -5.05856218e-02,
          1.05815503e-01,   3.02607888e-05,  -3.06493905e-05,
         -1.39280477e-01,   1.28996493e-01,   4.31292593e-05,
         -5.96480485e-05,   2.95529512e-05,   9.93746667e-04,
          7.01317105e-01,   8.29166974e-01],
       [ -1.02014794e-03,   1.53344847e-01,   1.26555281e-01,
         -2.59514216e-01,   5.21277273e-06,   8.15060393e-02,
          3.86307839e-02,   8.57441405e-02,   4.11677920e-01,
          1.96695730e-01,  -5.10011608e-05,  -6.55570421e-01,
         -5.87132617e-01,  -6.34052445e-01,   2.76152896e-01,
          3.74313823e-05,  -1.17425131e-05,   3.53716643e-01,
         -5.16160731e-01,   4.36144155e-01],
       [  4.22023597e-03,   7.22938483e-02,   1.12162542e-01,
         -2.30003217e-01,   2.52015112e-07,   9.91807686e-01,
          6.88524566e-01,   1.52796285e+00,   3.66486326e-01,
          1.75182159e-01,  -8.41866984e-05,   2.26684667e-01,
          1.03945597e+00,   1.12284989e+00,  -1.05845774e+00,
         -4.70554808e-06,   2.43792769e-05,   7.73188023e-02,
         -1.03795464e-02,   8.67768865e-03],
       [ -1.02008892e-03,   1.53352557e-01,   1.61484566e-01,
          2.39374281e-01,  -1.16126003e-05,   8.15188856e-02,
         -9.35933279e-02,  -9.42751301e-03,  -3.54259963e-02,
         -4.54962160e-01,  -9.63206863e-05,  -6.55650211e-01,
          8.42658163e-01,  -1.91337453e-01,   2.75964467e-01,
         -6.70376162e-05,   1.97015755e-05,   3.53406033e-01,
          6.36162213e-01,   2.28309832e-01],
       [  4.22012116e-03,   7.22873711e-02,   1.43088918e-01,
          2.12127101e-01,  -6.84065601e-06,   9.91784207e-01,
         -1.66749583e+00,  -1.68021815e-01,  -3.15509769e-02,
         -4.04889521e-01,  -3.19625629e-05,   2.27019143e-01,
         -1.49230427e+00,   3.38871359e-01,  -1.05817107e+00,
         -5.05589034e-05,   3.25506019e-05,   7.73303664e-02,
          1.28061430e-02,   4.49656356e-03],
       [ -1.01996700e-03,   1.53413718e-01,  -2.88101946e-01,
          2.01619319e-02,   1.92991064e-05,   8.14805338e-02,
          5.49409157e-02,  -7.63497029e-02,  -3.76144947e-01,
          2.58020220e-01,   2.49499632e-04,  -6.55481494e-01,
         -2.55626607e-01,   8.25466194e-01,   2.76113360e-01,
         -1.25030273e-05,   3.79961625e-05,   3.52422007e-01,
         -1.19987579e-01,  -6.65845419e-01],
       [  4.22000678e-03,   7.22786777e-02,  -2.55208941e-01,
          1.78654114e-02,   5.33651303e-05,   9.91315598e-01,
          9.79301704e-01,  -1.36041360e+00,  -3.34895588e-01,
          2.29832174e-01,  -3.49545246e-05,   2.26526682e-01,
          4.52516512e-01,  -1.46169936e+00,  -1.05846889e+00,
         -3.33279045e-05,  -3.19374044e-05,   7.72285064e-02,
         -2.41352014e-03,  -1.33653821e-02]])
    ref_result_dm_beta = array([[  1.02853130e+00,  -4.18885740e-02,  -2.76018229e-06,
         -2.72252558e-06,  -1.25946846e-06,  -8.91162258e-02,
         -1.10376480e-06,  -1.22512056e-06,  -1.88866380e-07,
          5.42588634e-03,  -7.72409787e-08,   1.70420914e-07,
          9.39838560e-08,  -5.81026738e-08,  -3.08700048e-02,
         -9.87531456e-03,  -3.08714787e-02,  -9.87419111e-03,
         -3.08768711e-02,  -9.86695189e-03],
       [ -4.18885740e-02,   1.45643383e-01,   6.58735225e-06,
          3.87782118e-06,   3.21927817e-06,   1.35220808e-01,
          2.09070264e-06,   1.65266130e-06,   8.27435093e-08,
         -1.18869956e-02,  -2.78702576e-07,  -1.26591618e-06,
         -1.14864458e-07,   1.93384881e-07,   5.82830811e-02,
          2.76310204e-02,   5.82845690e-02,   2.76272641e-02,
          5.82971909e-02,   2.76145340e-02],
       [ -2.76018229e-06,   6.58735225e-06,   1.83312807e-01,
         -2.58882823e-06,  -4.06318226e-06,   4.59976725e-06,
          7.81384677e-02,   2.69032679e-07,   2.58568369e-07,
         -1.79753057e-06,  -7.20307085e-07,   2.45775870e-06,
          9.95215625e-03,  -2.05768990e-06,   1.23618976e-01,
          1.09561247e-01,  -6.18152879e-02,  -5.47817376e-02,
         -6.18239489e-02,  -5.47674740e-02],
       [ -2.72252558e-06,   3.87782118e-06,  -2.58882823e-06,
          1.83308479e-01,  -1.08186009e-05,   7.84464241e-06,
         -5.14733057e-06,   7.81357431e-02,  -3.43047647e-06,
          1.28016560e-06,   1.89021795e-06,  -4.77780769e-07,
          8.94315872e-07,  -9.95059535e-03,  -1.30153835e-06,
         -7.95167361e-07,   1.07062924e-01,   9.48716393e-02,
         -1.07087717e-01,  -9.48594718e-02],
       [ -1.25946846e-06,   3.21927817e-06,  -4.06318226e-06,
         -1.08186009e-05,   7.99851088e-10,   3.00516995e-06,
         -1.73173925e-06,  -4.61148880e-06,   1.98616126e-10,
         -2.63473430e-07,  -1.01701860e-10,  -5.42039373e-11,
         -2.20664027e-07,   5.87327412e-07,  -1.44711458e-06,
         -1.81713301e-06,  -3.65543363e-06,  -3.77354574e-06,
          8.98406643e-06,   7.42365955e-06],
       [ -8.91162258e-02,   1.35220808e-01,   4.59976725e-06,
          7.84464241e-06,   3.00516995e-06,   1.28025770e-01,
          1.30130853e-06,   3.34673503e-06,   8.48982209e-08,
         -1.11355054e-02,  -2.50931704e-07,  -1.16578668e-06,
         -1.94268649e-07,  -4.63981492e-08,   5.48082058e-02,
          2.57480304e-02,   5.48136484e-02,   2.57480938e-02,
          5.48205886e-02,   2.57317870e-02],
       [ -1.10376480e-06,   2.09070264e-06,   7.81384677e-02,
         -5.14733057e-06,  -1.73173925e-06,   1.30130853e-06,
          3.33071117e-02,  -1.60901345e-06,   1.10292010e-07,
         -7.07973553e-07,  -3.07076637e-07,   1.04765500e-06,
          4.24218170e-03,  -6.57595634e-07,   5.26932365e-02,
          4.67011725e-02,  -2.63518800e-02,  -2.33533578e-02,
         -2.63508477e-02,  -2.33430923e-02],
       [ -1.22512056e-06,   1.65266130e-06,   2.69032679e-07,
          7.81357431e-02,  -4.61148880e-06,   3.34673503e-06,
         -1.60901345e-06,   3.33055753e-02,  -1.46224808e-06,
          5.45558995e-07,   8.05705216e-07,  -2.03636949e-07,
          4.55719907e-07,  -4.24146864e-03,   3.71564677e-07,
          4.81443564e-07,   4.56354035e-02,   4.04388869e-02,
         -4.56468958e-02,  -4.04345206e-02],
       [ -1.88866380e-07,   8.27435093e-08,   2.58568369e-07,
         -3.43047647e-06,   1.98616126e-10,   8.48982209e-08,
          1.10292010e-07,  -1.46224808e-06,   6.46371926e-11,
         -7.11093210e-09,  -3.65226592e-11,   1.17190458e-11,
          1.40181705e-08,   1.86214843e-07,   2.09786077e-07,
          1.70546175e-07,  -2.05534423e-06,  -1.83668355e-06,
          1.95231331e-06,   1.71399858e-06],
       [  5.42588634e-03,  -1.18869956e-02,  -1.79753057e-06,
          1.28016560e-06,  -2.63473430e-07,  -1.11355054e-02,
         -7.07973553e-07,   5.45558995e-07,  -7.11093210e-09,
          9.74145509e-04,   2.24575601e-08,   1.02917009e-07,
         -5.88030589e-08,  -1.02617753e-07,  -4.78560134e-03,
         -2.25972422e-03,  -4.78351772e-03,  -2.25746160e-03,
         -4.78642030e-03,  -2.25807151e-03],
       [ -7.72409787e-08,  -2.78702576e-07,  -7.20307085e-07,
          1.89021795e-06,  -1.01701860e-10,  -2.50931704e-07,
         -3.07076637e-07,   8.05705216e-07,  -3.65226592e-11,
          2.24575601e-08,   2.28792209e-11,  -1.21311140e-11,
         -3.90943215e-08,  -1.02599454e-07,  -5.95085535e-07,
         -4.83072113e-07,   1.23752530e-06,   1.14095966e-06,
         -9.70713428e-07,  -8.15515532e-07],
       [  1.70420914e-07,  -1.26591618e-06,   2.45775870e-06,
         -4.77780769e-07,  -5.42039373e-11,  -1.16578668e-06,
          1.04765500e-06,  -2.03636949e-07,   1.17190458e-11,
          1.02917009e-07,  -1.21311140e-11,   4.52388772e-11,
          1.33434503e-07,   2.59025661e-08,   1.15351987e-06,
          1.22915672e-06,  -1.61176150e-06,  -1.22152051e-06,
         -1.05389786e-06,  -7.26768884e-07],
       [  9.39838560e-08,  -1.14864458e-07,   9.95215625e-03,
          8.94315872e-07,  -2.20664027e-07,  -1.94268649e-07,
          4.24218170e-03,   4.55719907e-07,   1.40181705e-08,
         -5.88030589e-08,  -3.90943215e-08,   1.33434503e-07,
          5.40308214e-04,  -1.67890384e-07,   6.71115374e-03,
          5.94805238e-03,  -3.35557321e-03,  -2.97368584e-03,
         -3.35725246e-03,  -2.97398256e-03],
       [ -5.81026738e-08,   1.93384881e-07,  -2.05768990e-06,
         -9.95059535e-03,   5.87327412e-07,  -4.63981492e-08,
         -6.57595634e-07,  -4.24146864e-03,   1.86214843e-07,
         -1.02617753e-07,  -1.02599454e-07,   2.59025661e-08,
         -1.67890384e-07,   5.40151516e-04,  -1.24885131e-06,
         -1.19385578e-06,  -5.81082827e-03,  -5.14921515e-03,
          5.81398262e-03,   5.15002191e-03],
       [ -3.08700048e-02,   5.82830811e-02,   1.23618976e-01,
         -1.30153835e-06,  -1.44711458e-06,   5.48082058e-02,
          5.26932365e-02,   3.71564677e-07,   2.09786077e-07,
         -4.78560134e-03,  -5.95085535e-07,   1.15351987e-06,
          6.71115374e-03,  -1.24885131e-06,   1.06879537e-01,
          8.49654379e-02,  -1.81674382e-02,  -2.58607473e-02,
         -1.81668838e-02,  -2.58551029e-02],
       [ -9.87531456e-03,   2.76310204e-02,   1.09561247e-01,
         -7.95167361e-07,  -1.81713301e-06,   2.57480304e-02,
          4.67011725e-02,   4.81443564e-07,   1.70546175e-07,
         -2.25972422e-03,  -4.83072113e-07,   1.22915672e-06,
          5.94805238e-03,  -1.19385578e-06,   8.49654379e-02,
          7.07261132e-02,  -2.58621900e-02,  -2.74969528e-02,
         -2.58649846e-02,  -2.74908634e-02],
       [ -3.08714787e-02,   5.82845690e-02,  -6.18152879e-02,
          1.07062924e-01,  -3.65543363e-06,   5.48136484e-02,
         -2.63518800e-02,   4.56354035e-02,  -2.05534423e-06,
         -4.78351772e-03,   1.23752530e-06,  -1.61176150e-06,
         -3.35557321e-03,  -5.81082827e-03,  -1.81674382e-02,
         -2.58621900e-02,   1.06895360e-01,   8.49655701e-02,
         -1.81703438e-02,  -2.58559694e-02],
       [ -9.87419111e-03,   2.76272641e-02,  -5.47817376e-02,
          9.48716393e-02,  -3.77354574e-06,   2.57480938e-02,
         -2.33533578e-02,   4.04388869e-02,  -1.83668355e-06,
         -2.25746160e-03,   1.14095966e-06,  -1.22152051e-06,
         -2.97368584e-03,  -5.14921515e-03,  -2.58607473e-02,
         -2.74969528e-02,   8.49655701e-02,   7.07156147e-02,
         -2.58617339e-02,  -2.74851884e-02],
       [ -3.08768711e-02,   5.82971909e-02,  -6.18239489e-02,
         -1.07087717e-01,   8.98406643e-06,   5.48205886e-02,
         -2.63508477e-02,  -4.56468958e-02,   1.95231331e-06,
         -4.78642030e-03,  -9.70713428e-07,  -1.05389786e-06,
         -3.35725246e-03,   5.81398262e-03,  -1.81668838e-02,
         -2.58649846e-02,  -1.81703438e-02,  -2.58617339e-02,
          1.06946037e-01,   8.49706233e-02],
       [ -9.86695189e-03,   2.76145340e-02,  -5.47674740e-02,
         -9.48594718e-02,   7.42365955e-06,   2.57317870e-02,
         -2.33430923e-02,  -4.04345206e-02,   1.71399858e-06,
         -2.25807151e-03,  -8.15515532e-07,  -7.26768884e-07,
         -2.97398256e-03,   5.15002191e-03,  -2.58551029e-02,
         -2.74908634e-02,  -2.58559694e-02,  -2.74851884e-02,
          8.49706233e-02,   7.06927844e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha', 'ref_result_exp_beta', 'ref_result_dm_beta']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_hybgga.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]