# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_hf_dft_uks_methyl_numgga():
    ref_result_dm_alpha = array([[  1.03150560e+00,  -4.58087665e-02,   1.94458867e-05,
          3.01061443e-06,  -2.38699812e-05,  -1.09603590e-01,
          2.78953532e-05,   6.59158507e-06,  -2.01560212e-05,
          1.55481738e-03,  -2.50177424e-06,   5.89857813e-06,
         -3.99251497e-06,   1.94283778e-06,  -2.91839960e-02,
         -3.81229538e-03,  -2.91391219e-02,  -3.83824654e-03,
         -2.91297859e-02,  -3.83677042e-03],
       [ -4.58087665e-02,   1.60986559e-01,  -2.28191036e-05,
          9.25468181e-06,   3.05727232e-06,   1.69027610e-01,
         -4.79170290e-05,  -5.72236267e-06,   2.74172126e-07,
         -2.56126456e-03,   5.27257189e-06,  -1.17780490e-05,
          7.75257823e-06,  -4.80291442e-06,   5.48316177e-02,
          1.71785321e-02,   5.47376506e-02,   1.72239994e-02,
          5.47033440e-02,   1.72086928e-02],
       [  1.94458867e-05,  -2.28191036e-05,   1.99950694e-01,
          1.19565532e-05,   2.87092112e-05,  -5.42718165e-05,
          9.38312241e-02,   3.48463420e-05,   1.38652972e-05,
          8.66047220e-07,  -2.00195445e-05,   1.49242199e-05,
          8.90968422e-03,   2.43516273e-06,   1.23241607e-01,
          1.00902378e-01,  -6.15451396e-02,  -5.05045209e-02,
         -6.15062473e-02,  -5.04889180e-02],
       [  3.01061443e-06,   9.25468181e-06,   1.19565532e-05,
          2.00028985e-01,   2.25672135e-06,  -3.54518067e-05,
         -1.85379890e-05,   9.38325578e-02,   3.71809363e-06,
         -8.98844913e-07,   1.26630491e-05,  -2.75355430e-05,
          2.46145566e-05,  -8.95428122e-03,  -1.18124049e-05,
          4.77986242e-05,   1.06520738e-01,   8.76117556e-02,
         -1.06498588e-01,  -8.76425630e-02],
       [ -2.38699812e-05,   3.05727232e-06,   2.87092112e-05,
          2.25672135e-06,   3.61019398e-01,   2.65979651e-04,
         -5.76108700e-06,  -8.49954650e-08,   3.16795699e-01,
          1.98025735e-05,  -7.40210226e-06,   5.56851721e-06,
          4.65535880e-06,   8.30241787e-06,  -6.70423401e-05,
         -9.48057100e-05,  -1.17913122e-04,  -2.69920277e-05,
         -2.73128776e-05,  -1.30378878e-04],
       [ -1.09603590e-01,   1.69027610e-01,  -5.42718165e-05,
         -3.54518067e-05,   2.65979651e-04,   1.81184973e-01,
         -6.50380674e-05,  -2.73416074e-05,   2.30864079e-04,
         -2.73906534e-03,   5.59117020e-06,  -1.25121730e-05,
          6.92887530e-06,  -3.06524613e-06,   5.83723321e-02,
          1.79566118e-02,   5.82759726e-02,   1.80079364e-02,
          5.82877770e-02,   1.80312376e-02],
       [  2.78953532e-05,  -4.79170290e-05,   9.38312241e-02,
         -1.85379890e-05,  -5.76108700e-06,  -6.50380674e-05,
          4.40323610e-02,   5.02670521e-06,  -1.03705272e-05,
          1.00406291e-06,  -9.39696862e-06,   7.00928543e-06,
          4.18105851e-03,   2.22434834e-06,   5.78210336e-02,
          4.73466779e-02,  -2.89070108e-02,  -2.37148943e-02,
         -2.88630418e-02,  -2.36864073e-02],
       [  6.59158507e-06,  -5.72236267e-06,   3.48463420e-05,
          9.38325578e-02,  -8.49954650e-08,  -2.73416074e-05,
          5.02670521e-06,   4.40163704e-02,   7.39109911e-07,
         -2.59645261e-07,   5.93693506e-06,  -1.29138738e-05,
          1.28488058e-05,  -4.20040613e-03,   9.02173137e-06,
          3.61049724e-05,   4.99558741e-02,   4.10897605e-02,
         -4.99703761e-02,  -4.11211255e-02],
       [ -2.01560212e-05,   2.74172126e-07,   1.38652972e-05,
          3.71809363e-06,   3.16795699e-01,   2.30864079e-04,
         -1.03705272e-05,   7.39109911e-07,   2.77989259e-01,
          1.74151935e-05,  -6.49420372e-06,   4.88548379e-06,
          3.58044017e-06,   7.20750321e-06,  -6.66340725e-05,
         -8.91652619e-05,  -9.98774618e-05,  -2.03206401e-05,
         -2.22286808e-05,  -1.12566883e-04],
       [  1.55481738e-03,  -2.56126456e-03,   8.66047220e-07,
         -8.98844913e-07,   1.98025735e-05,  -2.73906534e-03,
          1.00406291e-06,  -2.59645261e-07,   1.74151935e-05,
          4.14202310e-05,  -8.52022365e-08,   1.89899494e-07,
         -1.02750891e-07,   1.11200955e-07,  -8.83076459e-04,
         -2.72192171e-04,  -8.82426092e-04,  -2.73625223e-04,
         -8.81070090e-04,  -2.72727026e-04],
       [ -2.50177424e-06,   5.27257189e-06,  -2.00195445e-05,
          1.26630491e-05,  -7.40210226e-06,   5.59117020e-06,
         -9.39696862e-06,   5.93693506e-06,  -6.49420372e-06,
         -8.52022365e-08,   3.13134548e-09,  -3.73968315e-09,
         -8.90314199e-07,  -5.67474469e-07,  -1.05300386e-05,
         -9.53605332e-06,   1.47133186e-05,   1.11665774e-05,
          1.22002128e-06,   7.11449263e-08],
       [  5.89857813e-06,  -1.17780490e-05,   1.49242199e-05,
         -2.75355430e-05,   5.56851721e-06,  -1.25121730e-05,
          7.00928543e-06,  -1.29138738e-05,   4.88548379e-06,
          1.89899494e-07,  -3.73968315e-09,   5.85814236e-09,
          6.61104026e-07,   1.23330070e-06,   5.15443211e-06,
          6.26920279e-06,  -2.32965374e-05,  -1.70876420e-05,
          6.03431654e-06,   7.03839017e-06],
       [ -3.99251497e-06,   7.75257823e-06,   8.90968422e-03,
          2.46145566e-05,   4.65535880e-06,   6.92887530e-06,
          4.18105851e-03,   1.28488058e-05,   3.58044017e-06,
         -1.02750891e-07,  -8.90314199e-07,   6.61104026e-07,
          3.97013654e-04,  -9.69671887e-07,   5.49458849e-03,
          4.49708784e-03,  -2.72657913e-03,  -2.23896848e-03,
         -2.75049230e-03,  -2.25937369e-03],
       [  1.94283778e-06,  -4.80291442e-06,   2.43516273e-06,
         -8.95428122e-03,   8.30241787e-06,  -3.06524613e-06,
          2.22434834e-06,  -4.20040613e-03,   7.20750321e-06,
          1.11200955e-07,  -5.67474469e-07,   1.23330070e-06,
         -9.69671887e-07,   4.00838030e-04,   8.51530706e-07,
         -1.11099141e-06,  -4.77081193e-03,  -3.92315232e-03,
          4.76498443e-03,   3.92209121e-03],
       [ -2.91839960e-02,   5.48316177e-02,   1.23241607e-01,
         -1.18124049e-05,  -6.70423401e-05,   5.83723321e-02,
          5.78210336e-02,   9.02173137e-06,  -6.66340725e-05,
         -8.83076459e-04,  -1.05300386e-05,   5.15443211e-06,
          5.49458849e-03,   8.51530706e-07,   9.48276404e-02,
          6.80343304e-02,  -1.91189659e-02,  -2.52869440e-02,
         -1.90829912e-02,  -2.52629755e-02],
       [ -3.81229538e-03,   1.71785321e-02,   1.00902378e-01,
          4.77986242e-05,  -9.48057100e-05,   1.79566118e-02,
          4.73466779e-02,   3.61049724e-05,  -8.91652619e-05,
         -2.72192171e-04,  -9.53605332e-06,   6.26920279e-06,
          4.49708784e-03,  -1.11099141e-06,   6.80343304e-02,
          5.27557094e-02,  -2.52062991e-02,  -2.36288781e-02,
         -2.52337824e-02,  -2.36583317e-02],
       [ -2.91391219e-02,   5.47376506e-02,  -6.15451396e-02,
          1.06520738e-01,  -1.17913122e-04,   5.82759726e-02,
         -2.89070108e-02,   4.99558741e-02,  -9.98774618e-05,
         -8.82426092e-04,   1.47133186e-05,  -2.32965374e-05,
         -2.72657913e-03,  -4.77081193e-03,  -1.91189659e-02,
         -2.52062991e-02,   9.44567980e-02,   6.80417979e-02,
         -1.90059454e-02,  -2.52962431e-02],
       [ -3.83824654e-03,   1.72239994e-02,  -5.05045209e-02,
          8.76117556e-02,  -2.69920277e-05,   1.80079364e-02,
         -2.37148943e-02,   4.10897605e-02,  -2.03206401e-05,
         -2.73625223e-04,   1.11665774e-05,  -1.70876420e-05,
         -2.23896848e-03,  -3.92315232e-03,  -2.52869440e-02,
         -2.36288781e-02,   6.80417979e-02,   5.29746737e-02,
         -2.52753204e-02,  -2.37932435e-02],
       [ -2.91297859e-02,   5.47033440e-02,  -6.15062473e-02,
         -1.06498588e-01,  -2.73128776e-05,   5.82877770e-02,
         -2.88630418e-02,  -4.99703761e-02,  -2.22286808e-05,
         -8.81070090e-04,   1.22002128e-06,   6.03431654e-06,
         -2.75049230e-03,   4.76498443e-03,  -1.90829912e-02,
         -2.52337824e-02,  -1.90059454e-02,  -2.52753204e-02,
          9.43846405e-02,   6.80223558e-02],
       [ -3.83677042e-03,   1.72086928e-02,  -5.04889180e-02,
         -8.76425630e-02,  -1.30378878e-04,   1.80312376e-02,
         -2.36864073e-02,  -4.11211255e-02,  -1.12566883e-04,
         -2.72727026e-04,   7.11449263e-08,   7.03839017e-06,
         -2.25937369e-03,   3.92209121e-03,  -2.52629755e-02,
         -2.36583317e-02,  -2.52962431e-02,  -2.37932435e-02,
          6.80223558e-02,   5.29869996e-02]])
    ref_result_energy = -39.762033787057632
    ref_result_exp_alpha = array([[  9.94858551e-01,  -2.04357664e-01,  -4.95401067e-05,
         -4.99880446e-06,  -5.12137188e-05,  -1.54026002e-01,
          1.84324444e-05,  -6.46867395e-05,  -2.08217440e-05,
          3.44091148e-05,  -7.14479986e-05,  -4.69617790e-02,
         -1.22063797e-05,   1.07960377e-05,   3.47493461e-02,
          1.70906840e-05,  -1.38252244e-05,  -4.11504517e-02,
         -6.49187143e-05,  -2.08930231e-05],
       [  3.60397889e-02,   3.99609457e-01,   6.62457010e-05,
         -2.62087647e-05,   2.64687359e-05,   2.57979797e-01,
          4.78522826e-05,   4.27686679e-05,   1.39399900e-06,
          2.09240956e-04,  -1.09155353e-04,  -6.58049178e-01,
         -4.50938471e-03,  -3.20529419e-03,  -1.94933983e+00,
          1.57802355e-05,  -1.37784489e-04,  -2.73231099e-01,
         -3.97187680e-04,  -2.12857143e-04],
       [  9.33408264e-08,   1.41501402e-05,  -4.45567636e-01,
         -3.76851371e-02,  -3.12284424e-06,  -1.37741520e-05,
          3.56904356e-02,   4.42937999e-01,  -6.33014172e-04,
         -1.05972132e-01,  -8.20247279e-01,   1.93106674e-03,
         -3.38311294e-01,  -6.79599289e-01,   1.28279581e-03,
          8.70206020e-06,  -8.08584678e-05,  -1.17106715e-04,
          5.73442680e-02,   1.63061827e-02],
       [  1.33376463e-07,  -1.23605296e-05,   3.76658559e-02,
         -4.45657142e-01,   1.10731188e-04,   1.57594529e-04,
          4.42909140e-01,  -3.57520988e-02,  -5.32183171e-04,
          8.20128585e-01,  -1.06117777e-01,   1.34482276e-03,
         -6.79584961e-01,   3.38490620e-01,   6.95542799e-04,
         -3.78940556e-05,   7.55188119e-05,  -5.23695323e-05,
         -1.62077498e-02,   5.74414395e-02],
       [  3.30413284e-07,  -3.21767628e-05,  -8.02699832e-05,
          1.37445277e-04,   6.00848910e-01,  -1.80574643e-04,
          5.18675651e-05,  -6.21994319e-06,   1.05812412e+00,
          3.92742767e-04,  -9.05455815e-04,  -3.26054536e-04,
         -1.07587526e-04,   1.38362154e-04,   8.74170200e-05,
         -1.74559781e-05,   2.45694464e-05,   8.49675284e-06,
         -1.46317096e-05,  -5.25948594e-06],
       [ -2.28601629e-02,   4.25043652e-01,   1.28833832e-04,
          7.88103875e-05,   4.65339485e-04,   1.84854394e+00,
         -5.73003930e-04,   2.57579481e-04,   6.26455042e-05,
         -3.69245092e-04,  -3.68855980e-04,   9.83349773e-01,
          8.19068368e-03,   6.01642989e-03,   3.60793224e+00,
         -8.90091654e-05,   3.39524429e-04,   7.91947258e-01,
          1.08811512e-03,   4.84156899e-04],
       [ -2.05907183e-07,  -8.64534469e-05,  -2.09096811e-01,
         -1.76307819e-02,  -3.34936089e-05,  -1.14419421e-04,
          1.03212748e-01,   1.27621425e+00,   1.28819785e-03,
          2.17059263e-01,   1.67862595e+00,  -4.28493486e-03,
          5.10711549e-01,   1.02555442e+00,  -1.51741078e-03,
          1.60427283e-04,   3.58458837e-05,  -7.46894546e-04,
          5.14057536e-01,   1.44809837e-01],
       [  9.45085582e-08,  -3.09741430e-05,   1.76036878e-02,
         -2.09060910e-01,   5.00309520e-05,   1.92304911e-04,
          1.27632273e+00,  -1.03076063e-01,   9.16457086e-04,
         -1.67823946e+00,   2.16902977e-01,  -2.50831492e-03,
          1.02613132e+00,  -5.10929404e-01,  -8.62217683e-04,
         -5.71408567e-05,  -1.43891367e-04,   5.76237677e-05,
         -1.44917971e-01,   5.13774431e-01],
       [ -1.43827823e-07,  -3.42148450e-05,  -4.48685261e-05,
          1.18869946e-04,   5.27246816e-01,  -5.00168452e-05,
         -4.53472564e-05,  -2.48413938e-05,  -1.09665714e+00,
         -3.42636430e-04,   9.60926197e-04,   1.75635684e-04,
          1.85527299e-04,  -1.74164073e-04,  -6.59786186e-05,
          1.52467072e-05,  -7.98821131e-06,  -5.79449667e-06,
          1.09859406e-05,  -2.35838092e-06],
       [  2.41791311e-04,  -6.43123022e-03,  -2.32569366e-06,
          2.00706330e-06,   3.25973626e-05,   1.71264742e-02,
          2.82447838e-06,   2.65811831e-05,   5.21714899e-05,
         -1.11587465e-04,   2.13086460e-04,   1.85127235e-01,
          3.30398641e-04,   1.51262219e-04,  -2.70967750e-02,
          2.61502727e-04,  -3.76163899e-04,  -1.05103369e+00,
         -1.30479991e-03,  -3.63493918e-04],
       [  1.91859207e-07,   1.31685437e-05,   4.70087001e-05,
         -2.44446785e-05,  -1.23260428e-05,  -1.28880135e-06,
          8.64819421e-06,   2.92513896e-05,  -5.81609031e-06,
          3.66920429e-05,   1.25502032e-04,   9.97332142e-06,
         -8.87931592e-06,  -2.73519497e-04,  -3.12818690e-05,
          4.62538430e-01,   8.86599143e-01,  -1.99624265e-04,
         -1.45766102e-04,   4.40924358e-05],
       [ -1.22201549e-07,  -2.94535727e-05,  -3.84478931e-05,
          5.85504236e-05,   9.24729881e-06,   1.64186902e-05,
          3.55443155e-05,  -2.94337714e-05,   2.01221650e-05,
         -1.38372383e-04,  -3.12305295e-05,   1.24452263e-04,
         -1.78533487e-04,   1.98328808e-04,  -6.34111112e-05,
          8.86599113e-01,  -4.62538287e-01,   4.10425945e-04,
         -2.34345424e-04,  -5.06913343e-05],
       [ -3.65716966e-07,   2.26148506e-05,  -1.98496850e-02,
         -1.73287898e-03,   5.49386879e-06,  -6.34014458e-05,
         -1.78370142e-03,  -2.22041456e-02,  -9.63663922e-05,
         -1.49013612e-02,  -1.15859118e-01,  -3.20312506e-04,
          8.81849919e-02,   1.76787644e-01,  -4.33335152e-04,
          3.02043645e-04,   7.32782089e-05,  -1.41341960e-03,
          1.04389718e+00,   2.94316450e-01],
       [ -1.70131127e-07,  -1.04158000e-05,  -1.69273061e-03,
          1.99492733e-02,   9.02762253e-06,   1.56627263e-05,
          2.22048355e-02,  -1.74293557e-03,   1.63059067e-05,
         -1.15930995e-01,   1.49738986e-02,   1.97260814e-04,
         -1.77112205e-01,   8.80004975e-02,   2.39697909e-04,
          7.92373324e-06,   1.24714673e-04,  -3.20246679e-06,
          2.94366288e-01,  -1.04383408e+00],
       [ -1.13314040e-03,   1.37359243e-01,  -2.74629103e-01,
         -2.31883259e-02,  -1.35593879e-04,  -1.13714879e-01,
         -1.04197714e-02,  -1.27529650e-01,  -5.89367657e-04,
         -5.44790953e-02,  -4.24952430e-01,  -6.37906685e-01,
          3.89247834e-01,   7.82424821e-01,   2.82805637e-01,
          4.24009928e-05,   1.35433254e-04,  -3.75472931e-01,
         -6.56827931e-01,  -1.85421238e-01],
       [  4.90364629e-03,   4.25821007e-02,  -2.24840383e-01,
         -1.91114486e-02,  -1.81130321e-04,  -9.52478148e-01,
         -1.30718331e-01,  -1.62201480e+00,  -1.72145719e-04,
         -5.98785542e-02,  -4.60578612e-01,   2.35872017e-01,
         -7.01733667e-01,  -1.40689342e+00,  -1.09174158e+00,
         -1.30311557e-04,  -2.98519110e-04,  -6.43629120e-02,
         -1.06694792e-02,  -2.80108865e-03],
       [ -1.13327818e-03,   1.37039244e-01,   1.57224031e-01,
         -2.25735155e-01,  -1.16249522e-04,  -1.13411689e-01,
         -1.05038462e-01,   7.20927289e-02,   2.27477297e-05,
          3.95240976e-01,   1.63717619e-01,  -6.37731048e-01,
          4.82175157e-01,  -7.28932659e-01,   2.85028082e-01,
          4.89483824e-04,  -4.96825083e-04,  -3.76925807e-01,
          4.87748970e-01,  -4.76189304e-01],
       [  4.90344057e-03,   4.26262689e-02,   1.29054758e-01,
         -1.85683848e-01,   1.71185873e-05,  -9.53451442e-01,
         -1.33899317e+00,   9.24714736e-01,  -1.68011509e-04,
          4.28992208e-01,   1.79998826e-01,   2.32436476e-01,
         -8.68877274e-01,   1.30735165e+00,  -1.09471208e+00,
         -1.67827806e-04,   3.53443138e-04,  -6.44533264e-02,
          7.95303563e-03,  -7.53124934e-03],
       [ -1.13337958e-03,   1.36991199e-01,   1.16996997e-01,
          2.48854272e-01,  -7.94026194e-05,  -1.13312211e-01,
          1.15236084e-01,   5.43809153e-02,   5.54397652e-05,
         -3.39695523e-01,   2.58478305e-01,  -6.36749128e-01,
         -8.72855130e-01,  -5.38215229e-02,   2.86591417e-01,
          6.75103644e-05,  -1.60534414e-04,  -3.77017378e-01,
          1.67316544e-01,   6.60996155e-01],
       [  4.90374349e-03,   4.26190501e-02,   9.59958874e-02,
          2.04771243e-01,  -2.48685189e-04,  -9.52976732e-01,
          1.47068045e+00,   6.97656348e-01,   5.80625371e-04,
         -3.69565291e-01,   2.83262975e-01,   2.28787542e-01,
          1.56538497e+00,   9.49930551e-02,  -1.09710907e+00,
          8.00153969e-05,  -1.16228408e-04,  -6.43267078e-02,
          2.66548621e-03,   1.02632015e-02]])
    ref_result_exp_beta = array([[  9.95043768e-01,   1.96002958e-01,  -5.71260314e-05,
         -8.55371337e-06,  -5.55909926e-05,   1.61479067e-01,
          2.70844728e-05,  -9.84928570e-05,   3.83786560e-05,
         -8.67960604e-05,  -3.98257697e-05,   5.85695597e-02,
          4.09134240e-05,   6.02254659e-05,   3.61637496e-02,
          2.67134952e-05,   3.57981519e-06,  -3.15102736e-02,
          1.22963088e-04,  -5.82418630e-05],
       [  3.45048712e-02,  -3.79858889e-01,   7.78156389e-05,
         -2.75325834e-05,   1.69631317e-05,  -2.56246554e-01,
          5.01260064e-05,   1.18871279e-04,   1.66168033e-04,
         -4.59192576e-06,  -2.18250067e-04,   5.39785515e-01,
          1.17477585e-03,   3.52349434e-03,  -1.98092052e+00,
          1.65944221e-04,   5.08145452e-07,  -3.29552318e-01,
          1.20257751e-03,  -7.03964890e-04],
       [  1.10612083e-07,  -3.35930670e-05,  -4.26891913e-01,
         -4.55602281e-02,  -4.27629496e-05,   9.92897555e-05,
          1.88812617e-02,   4.46155509e-01,  -1.22524587e-01,
         -8.01354450e-01,   1.48738870e-03,  -2.06952923e-03,
         -1.50768611e-01,   7.70868139e-01,   7.12876254e-04,
          5.58993251e-05,   1.29806064e-06,  -2.32738356e-04,
         -5.66298603e-02,   1.53704487e-02],
       [  4.90824292e-07,   1.65395262e-06,   4.55669279e-02,
         -4.26958610e-01,   9.02191364e-05,  -1.84064872e-04,
          4.46140886e-01,  -1.89587565e-02,   8.01223141e-01,
         -1.22649145e-01,   1.95475649e-04,  -1.44435042e-03,
          7.70971693e-01,   1.50669631e-01,   4.40228194e-04,
         -2.65959060e-05,   5.98776586e-06,  -6.38442168e-05,
          1.52700868e-02,   5.67218244e-02],
       [ -4.16626133e-07,   8.31527063e-05,   3.20997869e-05,
          9.76798207e-05,   5.34277606e-01,   1.63090855e-04,
          7.37657693e-05,  -2.51626289e-05,  -1.43862280e-04,
          2.08085118e-03,   1.09324745e+00,   5.16771657e-04,
          1.25339543e-04,   1.24381202e-04,  -5.83031587e-06,
         -1.48191692e-05,   7.25676639e-05,  -3.59889916e-05,
          2.52454197e-05,   7.88363510e-06],
       [ -2.15096768e-02,  -3.66000956e-01,   1.18799954e-04,
          8.59014260e-05,   4.36736930e-04,  -1.91193006e+00,
         -6.71934722e-04,   6.05190741e-04,  -4.05097093e-04,
         -3.57147131e-04,   5.54413224e-04,  -8.60706244e-01,
         -2.03984935e-03,  -6.51534274e-03,   3.60635530e+00,
         -4.83440481e-04,  -7.82679236e-05,   8.20468064e-01,
         -2.95228657e-03,   1.63664818e-03],
       [ -1.80505109e-07,   9.24721750e-05,  -1.83906961e-01,
         -1.95748775e-02,  -5.18994383e-05,   3.86978688e-04,
          5.53650440e-02,   1.29845935e+00,   2.52234376e-01,
          1.64824523e+00,  -2.93223237e-03,   4.42115738e-03,
          2.23331367e-01,  -1.14259744e+00,  -6.88574073e-04,
         -5.09814125e-05,  -2.61299479e-04,  -2.09359750e-03,
         -5.17493812e-01,   1.38937328e-01],
       [  3.25710158e-08,   3.43595170e-05,   1.95481043e-02,
         -1.83831965e-01,  -3.20380882e-05,  -2.25910342e-04,
          1.29858799e+00,  -5.51678114e-02,  -1.64783911e+00,
          2.51979418e-01,  -6.05493058e-04,   2.60889639e-03,
         -1.14319091e+00,  -2.23563897e-01,  -4.85318838e-04,
          9.78587978e-05,   5.92654444e-05,  -3.72792092e-04,
          1.39049934e-01,   5.17219754e-01],
       [  8.36793564e-08,   5.66166932e-05,  -1.05328239e-05,
          1.08020123e-04,   5.94042305e-01,   4.43618520e-06,
         -3.06122069e-05,   1.08439790e-04,   1.92346537e-04,
         -2.03071254e-03,  -1.06195885e+00,  -3.62782230e-04,
         -2.21698576e-04,  -1.05296700e-04,   9.33446388e-06,
          1.41442614e-06,  -4.77837091e-05,   1.30377079e-05,
         -1.60292101e-05,  -6.42322694e-06],
       [ -6.19550554e-04,   3.17985326e-02,  -1.68875053e-05,
         -7.98899893e-06,  -7.36491371e-06,   1.39472671e-02,
          1.28406952e-05,   1.26989033e-05,  -6.64106141e-05,
          1.47222788e-04,   3.76956853e-05,  -1.55624189e-01,
         -1.72870296e-04,  -3.55597498e-04,   1.42284252e-02,
          7.28470135e-04,   3.50631974e-05,  -1.05563749e+00,
          3.64363021e-03,  -1.79039178e-03],
       [ -9.67760543e-07,   4.12807102e-06,   5.11978674e-05,
         -2.84649657e-05,  -9.33880023e-07,   2.32299351e-05,
          1.45598473e-05,   1.96219930e-05,   4.70199756e-05,
          1.09186456e-04,   1.89040196e-05,   1.43022583e-05,
         -1.28302570e-04,   1.93674449e-04,   3.05301964e-05,
         -8.86539082e-01,  -4.62653140e-01,  -6.27601352e-04,
          2.46016045e-04,   4.37165087e-06],
       [  4.01678789e-07,   4.03222940e-05,  -4.65659658e-05,
          6.73488104e-05,   2.35083763e-05,  -1.25653606e-06,
          1.67349758e-05,  -1.81491898e-05,  -1.42906790e-04,
         -3.64500706e-05,   5.37029345e-05,  -1.01689680e-04,
          2.03441258e-04,  -3.85629169e-05,  -4.74932815e-05,
          4.62653049e-01,  -8.86539257e-01,   3.06661120e-04,
          3.31114245e-04,  -9.70197450e-05],
       [ -3.43758012e-07,  -3.21081565e-05,  -1.97040004e-02,
         -2.16339182e-03,   1.55647573e-05,   5.00839438e-05,
         -7.95415377e-04,  -1.91276882e-02,  -1.80497181e-02,
         -1.18593756e-01,   2.55225850e-04,   3.63722764e-04,
          3.66612415e-02,  -1.88182624e-01,  -2.69850103e-04,
         -1.11833252e-04,  -4.56471117e-04,  -4.11119107e-03,
         -1.04816411e+00,   2.81679136e-01],
       [ -5.30515188e-07,   1.69752237e-05,  -2.12110608e-03,
          1.98093881e-02,   2.12898523e-05,  -6.57372277e-06,
          1.91198955e-02,  -7.59061824e-04,  -1.18667627e-01,
          1.81408510e-02,  -7.51683765e-05,  -2.25453041e-04,
          1.88318036e-01,   3.69969413e-02,   1.70755427e-04,
         -1.14008601e-04,   1.22535401e-05,   8.07876654e-04,
         -2.81734035e-01,  -1.04810960e+00],
       [ -1.19912523e-03,  -1.51908768e-01,  -2.87844399e-01,
         -3.06918494e-02,  -4.47728175e-05,   9.52762402e-02,
         -4.91029558e-03,  -1.12780083e-01,  -6.71077090e-02,
         -4.41689861e-01,   6.00116518e-04,   6.63007177e-01,
          1.66509072e-01,  -8.48633808e-01,   2.58062338e-01,
          6.00436088e-05,   1.97615791e-04,  -3.47862169e-01,
          6.56074665e-01,  -1.76816704e-01],
       [  4.62369959e-03,  -6.93267799e-02,  -2.50670918e-01,
         -2.68629529e-02,  -1.13834445e-05,   9.73099199e-01,
         -6.92633986e-02,  -1.63664114e+00,  -6.52539950e-02,
         -4.24198575e-01,   6.20256712e-04,  -2.71065238e-01,
         -2.99968431e-01,   1.53707394e+00,  -1.06373023e+00,
          2.51385189e-04,   1.27673458e-04,  -8.13230159e-02,
          1.35475433e-02,  -3.49899706e-03],
       [ -1.19940772e-03,  -1.51551754e-01,   1.70326399e-01,
         -2.33441853e-01,  -1.38974827e-04,   9.50228383e-02,
         -9.49949817e-02,   5.99625232e-02,   4.16007245e-01,
          1.61191602e-01,  -4.10344681e-04,   6.62710328e-01,
         -8.18087328e-01,   2.82017967e-01,   2.59442893e-01,
          5.59786292e-04,  -3.55929150e-04,  -3.51364775e-01,
         -4.78401958e-01,  -4.79877833e-01],
       [  4.62357709e-03,  -6.93573680e-02,   1.48721233e-01,
         -2.04231569e-01,   4.29572643e-05,   9.74573222e-01,
         -1.38216119e+00,   8.78527175e-01,   4.00209296e-01,
          1.57126183e-01,  -2.73854820e-04,  -2.67459369e-01,
          1.48038789e+00,  -5.06925705e-01,  -1.06532675e+00,
         -2.96564972e-04,   1.21125753e-04,  -8.14694266e-02,
         -9.58606219e-03,  -9.69733885e-03],
       [ -1.19918513e-03,  -1.51493231e-01,   1.17133342e-01,
          2.64062640e-01,  -7.35042567e-05,   9.49310963e-02,
          9.97293559e-02,   5.17555109e-02,  -3.47980673e-01,
          2.77817469e-01,  -1.03708348e-03,   6.61447255e-01,
          6.53069956e-01,   5.69245602e-01,   2.60353293e-01,
          2.84233154e-04,  -2.24529860e-05,  -3.52312419e-01,
         -1.73671727e-01,   6.54706031e-01],
       [  4.62374470e-03,  -6.93467243e-02,   1.02227504e-01,
          2.31099441e-01,  -3.27375745e-04,   9.73976286e-01,
          1.45249015e+00,   7.57898554e-01,  -3.35219508e-01,
          2.69605627e-01,  -2.73259785e-04,  -2.63428041e-01,
         -1.18000698e+00,  -1.02682349e+00,  -1.06667618e+00,
          7.68986496e-05,  -6.69328815e-05,  -8.14023784e-02,
         -3.30138846e-03,   1.27451828e-02]])
    ref_result_dm_beta = array([[  1.02852927e+00,  -4.01196359e-02,   1.82848617e-05,
          1.85793136e-06,   1.58759755e-05,  -9.31403326e-02,
          2.86024358e-05,   7.22022686e-06,   1.11752314e-05,
          5.61612710e-03,  -1.56534880e-07,   8.30510764e-06,
         -5.49024763e-06,   2.75084599e-06,  -3.09510465e-02,
         -8.97291245e-03,  -3.09057909e-02,  -9.00033850e-03,
         -3.08953156e-02,  -8.99915287e-03],
       [ -4.01196359e-02,   1.45483436e-01,  -1.91498265e-05,
          1.46990612e-05,  -3.15885503e-05,   1.38286542e-01,
         -4.88765366e-05,  -6.46370132e-06,  -2.14992077e-05,
         -1.21003351e-02,  -1.59670213e-06,  -1.53085082e-05,
          1.07092085e-05,  -7.17656468e-06,   5.76409884e-02,
          2.64751640e-02,   5.75465930e-02,   2.65227496e-02,
          5.75065325e-02,   2.65031059e-02],
       [  1.82848617e-05,  -1.91498265e-05,   1.84312518e-01,
          1.72650244e-07,  -1.81562056e-05,  -4.22470901e-05,
          7.94002233e-02,   3.04895861e-05,  -4.26915765e-07,
          6.49813216e-06,  -2.05554304e-05,   1.68088357e-05,
          8.51005704e-03,   2.96238266e-06,   1.24281894e-01,
          1.08235577e-01,  -6.20702287e-02,  -5.41807515e-02,
         -6.20289659e-02,  -5.41667413e-02],
       [  1.85793136e-06,   1.46990612e-05,   1.72650244e-07,
          1.84370039e-01,  -4.02428089e-05,  -3.18587479e-05,
         -2.24201602e-05,   7.93793549e-02,  -4.66001460e-05,
          2.69300409e-06,   1.44862779e-05,  -3.08732527e-05,
          2.58276207e-05,  -8.55443984e-03,  -1.22893288e-05,
          4.69497077e-05,   1.07431033e-01,   9.39750869e-02,
         -1.07406695e-01,  -9.40118339e-02],
       [  1.58759755e-05,  -3.15885503e-05,  -1.81562056e-05,
         -4.02428089e-05,   1.74810757e-08,  -3.04010104e-05,
         -7.80773730e-06,  -1.73264860e-05,   1.49176150e-08,
          2.64204146e-06,  -7.93891117e-10,   8.43458588e-09,
         -8.46480808e-07,   1.86831910e-06,  -2.48638988e-05,
         -1.64348008e-05,  -2.99319063e-05,  -2.09425248e-05,
          1.69620829e-05,   2.00893738e-05],
       [ -9.31403326e-02,   1.38286542e-01,  -4.22470901e-05,
         -3.18587479e-05,  -3.04010104e-05,   1.34419338e-01,
         -5.73260794e-05,  -2.60362818e-05,  -2.07077390e-05,
         -1.16249659e-02,  -1.48642128e-06,  -1.47664817e-05,
          9.23249141e-06,  -4.75201526e-06,   5.55877398e-02,
          2.52421361e-02,   5.54940526e-02,   2.52855238e-02,
          5.55090315e-02,   2.53134827e-02],
       [  2.86024358e-05,  -4.88765366e-05,   7.94002233e-02,
         -2.24201602e-05,  -7.80773730e-06,  -5.73260794e-05,
          3.42049371e-02,   3.45336529e-06,  -1.72174429e-07,
          6.19927010e-06,  -8.85642617e-06,   7.24917826e-06,
          3.66605185e-03,   2.32169807e-06,   5.35233157e-02,
          4.66195240e-02,  -2.67686259e-02,  -2.33594787e-02,
         -2.67246320e-02,  -2.33305061e-02],
       [  7.22022686e-06,  -6.46370132e-06,   3.04895861e-05,
          7.93793549e-02,  -1.73264860e-05,  -2.60362818e-05,
          3.45336529e-06,   3.41762857e-02,  -2.00615642e-05,
          2.23071703e-06,   6.23372228e-06,  -1.32881531e-05,
          1.25232206e-05,  -3.68305894e-03,   1.01068826e-05,
          3.57418022e-05,   4.62384092e-02,   4.04491036e-02,
         -4.62586080e-02,  -4.04874742e-02],
       [  1.11752314e-05,  -2.14992077e-05,  -4.26915765e-07,
         -4.66001460e-05,   1.49176150e-08,  -2.07077390e-05,
         -1.72174429e-07,  -2.00615642e-05,   1.49824190e-08,
          1.79891470e-06,  -3.38051898e-09,   1.00466980e-08,
         -2.79663449e-08,   2.16312143e-06,  -8.88093998e-06,
         -4.18463770e-06,  -3.55877813e-05,  -2.75525907e-05,
          1.87164996e-05,   1.99623985e-05],
       [  5.61612710e-03,  -1.21003351e-02,   6.49813216e-06,
          2.69300409e-06,   2.64204146e-06,  -1.16249659e-02,
          6.19927010e-06,   2.23071703e-06,   1.79891470e-06,
          1.01153059e-03,   1.31228722e-07,   1.28219768e-06,
         -6.70711124e-07,   4.17644737e-07,  -4.82462856e-03,
         -2.20290706e-03,  -4.81939042e-03,  -2.20920584e-03,
         -4.82060584e-03,  -2.21156000e-03],
       [ -1.56534880e-07,  -1.59670213e-06,  -2.05554304e-05,
          1.44862779e-05,  -7.93891117e-10,  -1.48642128e-06,
         -8.85642617e-06,   6.23372228e-06,  -3.38051898e-09,
          1.31228722e-07,   3.44860244e-09,  -4.13445170e-09,
         -9.47179986e-07,  -6.72397831e-07,  -1.44867392e-05,
         -1.23575859e-05,   1.47395217e-05,   1.31357434e-05,
         -2.14503185e-06,  -1.63625127e-06],
       [  8.30510764e-06,  -1.53085082e-05,   1.68088357e-05,
         -3.08732527e-05,   8.43458588e-09,  -1.47664817e-05,
          7.24917826e-06,  -1.32881531e-05,   1.00466980e-08,
          1.28219768e-06,  -4.13445170e-09,   8.32907788e-09,
          7.70540161e-07,   1.43342193e-06,   5.21084568e-06,
          7.06995721e-06,  -2.97627209e-05,  -2.34730174e-05,
          6.21864602e-06,   8.00768246e-06],
       [ -5.49024763e-06,   1.07092085e-05,   8.51005704e-03,
          2.58276207e-05,  -8.46480808e-07,   9.23249141e-06,
          3.66605185e-03,   1.25232206e-05,  -2.79663449e-08,
         -6.70711124e-07,  -9.47179986e-07,   7.70540161e-07,
          3.92929954e-04,  -1.06172736e-06,   5.74296802e-03,
          4.99956304e-03,  -2.84622458e-03,  -2.48634976e-03,
         -2.87440767e-03,  -2.51202943e-03],
       [  2.75084599e-06,  -7.17656468e-06,   2.96238266e-06,
         -8.55443984e-03,   1.86831910e-06,  -4.75201526e-06,
          2.32169807e-06,  -3.68305894e-03,   2.16312143e-06,
          4.17644737e-07,  -6.72397831e-07,   1.43342193e-06,
         -1.06172736e-06,   3.96911038e-04,  -1.59629802e-08,
         -1.61810542e-06,  -4.98819160e-03,  -4.36233413e-03,
          4.97989620e-03,   4.35992300e-03],
       [ -3.09510465e-02,   5.76409884e-02,   1.24281894e-01,
         -1.22893288e-05,  -2.48638988e-05,   5.55877398e-02,
          5.35233157e-02,   1.01068826e-05,  -8.88093998e-06,
         -4.82462856e-03,  -1.44867392e-05,   5.21084568e-06,
          5.74296802e-03,  -1.59629802e-08,   1.06874067e-01,
          8.35044390e-02,  -1.88392652e-02,  -2.60098893e-02,
         -1.88061656e-02,  -2.59896644e-02],
       [ -8.97291245e-03,   2.64751640e-02,   1.08235577e-01,
          4.69497077e-05,  -1.64348008e-05,   2.52421361e-02,
          4.66195240e-02,   3.57418022e-05,  -4.18463770e-06,
         -2.20290706e-03,  -1.23575859e-05,   7.06995721e-06,
          4.99956304e-03,  -1.61810542e-06,   8.35044390e-02,
          6.83850415e-02,  -2.59238906e-02,  -2.69641254e-02,
         -2.59584342e-02,  -2.70045159e-02],
       [ -3.09057909e-02,   5.75465930e-02,  -6.20702287e-02,
          1.07431033e-01,  -2.99319063e-05,   5.54940526e-02,
         -2.67686259e-02,   4.62384092e-02,  -3.55877813e-05,
         -4.81939042e-03,   1.47395217e-05,  -2.97627209e-05,
         -2.84622458e-03,  -4.98819160e-03,  -1.88392652e-02,
         -2.59238906e-02,   1.06475583e-01,   8.35130475e-02,
         -1.87318667e-02,  -2.60321600e-02],
       [ -9.00033850e-03,   2.65227496e-02,  -5.41807515e-02,
          9.39750869e-02,  -2.09425248e-05,   2.52855238e-02,
         -2.33594787e-02,   4.04491036e-02,  -2.75525907e-05,
         -2.20920584e-03,   1.31357434e-05,  -2.34730174e-05,
         -2.48634976e-03,  -4.36233413e-03,  -2.60098893e-02,
         -2.69641254e-02,   8.35130475e-02,   6.86603643e-02,
         -2.60080752e-02,  -2.71633016e-02],
       [ -3.08953156e-02,   5.75065325e-02,  -6.20289659e-02,
         -1.07406695e-01,   1.69620829e-05,   5.55090315e-02,
         -2.67246320e-02,  -4.62586080e-02,   1.87164996e-05,
         -4.82060584e-03,  -2.14503185e-06,   6.21864602e-06,
         -2.87440767e-03,   4.97989620e-03,  -1.88061656e-02,
         -2.59584342e-02,  -1.87318667e-02,  -2.60080752e-02,
          1.06400989e-01,   8.34990318e-02],
       [ -8.99915287e-03,   2.65031059e-02,  -5.41667413e-02,
         -9.40118339e-02,   2.00893738e-05,   2.53134827e-02,
         -2.33305061e-02,  -4.04874742e-02,   1.99623985e-05,
         -2.21156000e-03,  -1.63625127e-06,   8.00768246e-06,
         -2.51202943e-03,   4.35992300e-03,  -2.59896644e-02,
         -2.70045159e-02,  -2.60321600e-02,  -2.71633016e-02,
          8.34990318e-02,   6.86877907e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_numgga.py")

    l = {}
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], l[k], v), l[k] - l[var_name]
