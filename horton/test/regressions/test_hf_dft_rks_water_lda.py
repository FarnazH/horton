# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_hf_dft_rks_water_lda():
    ref_result_dm_alpha = array([[  9.14217156e-02,   4.60659109e-02,  -1.85306200e-02,
          3.96700459e-02,   1.22222580e-01,  -9.13373538e-02,
          1.92286231e-07,   1.98750934e-02,   6.18936389e-02,
         -6.06934995e-02,   4.22335150e-07,  -4.86536582e-03,
         -7.88099321e-07,   2.14366604e-08,  -3.65323172e-03,
         -8.89720546e-03,  -1.89733030e-02,  -1.91648572e-02],
       [  4.60659109e-02,   2.89646823e-02,   1.09459795e-02,
         -1.54336689e-02,   7.22212437e-02,  -5.54630000e-02,
          6.18878850e-06,  -3.19914883e-02,   3.65729631e-02,
         -3.91583116e-02,   5.11620560e-06,  -1.60649402e-03,
         -5.28655899e-07,  -3.94932910e-07,  -3.23612399e-03,
         -5.25733522e-03,  -1.91664678e-02,  -9.58002661e-03],
       [ -1.85306200e-02,   1.09459795e-02,   1.04053775e+00,
         -7.86076632e-02,  -1.21405754e-07,  -1.96961082e-02,
          3.78902619e-08,  -1.45164955e-01,   1.40864162e-07,
         -1.61149559e-02,   1.10447808e-08,   3.29399346e-03,
         -1.37386498e-07,  -1.28831789e-07,  -3.90022320e-03,
          2.13820488e-08,  -1.85306058e-02,   1.09465082e-02],
       [  3.96700459e-02,  -1.54336689e-02,  -7.86076632e-02,
          2.40369423e-01,   1.20014320e-06,   3.92293420e-02,
          4.76174530e-06,   2.75378227e-01,   1.57258437e-07,
          4.11884286e-02,   3.65128825e-06,  -6.60925214e-03,
          3.14624046e-07,  -1.63038917e-09,   8.14691299e-03,
         -1.00405882e-07,   3.96691492e-02,  -1.54353123e-02],
       [  1.22222580e-01,   7.22212437e-02,  -1.21405754e-07,
          1.20014320e-06,   2.70635136e-01,  -3.76157312e-07,
          8.86805844e-07,  -1.40868475e-06,   1.37049123e-01,
          4.64264889e-07,  -1.14914551e-08,   4.62013885e-07,
         -2.37963764e-06,  -1.04060725e-06,  -1.26748328e-06,
         -1.97002212e-02,  -1.22223205e-01,  -7.22199967e-02],
       [ -9.13373538e-02,  -5.54630000e-02,  -1.96961082e-02,
          3.92293420e-02,  -3.76157312e-07,   3.29396724e-01,
          2.59780450e-06,   1.30709776e-01,  -1.68113340e-06,
          2.29540791e-01,   4.64129475e-09,   1.13518663e-02,
         -7.22253864e-07,  -1.53972223e-06,   1.78533929e-02,
          1.04895272e-06,  -9.13371696e-02,  -5.54664791e-02],
       [  1.92286231e-07,   6.18878850e-06,   3.78902619e-08,
          4.76174530e-06,   8.86805844e-07,   2.59780450e-06,
          4.08081280e-01,  -1.07372790e-05,  -1.06470937e-06,
          2.54777911e-06,   3.27230373e-01,   8.40724414e-07,
          3.53919588e-07,  -2.29895567e-02,  -8.58787495e-07,
         -1.43143711e-06,   1.11380048e-06,   2.95367037e-06],
       [  1.98750934e-02,  -3.19914883e-02,  -1.45164955e-01,
          2.75378227e-01,  -1.40868475e-06,   1.30709776e-01,
         -1.07372790e-05,   3.41058360e-01,  -1.60700388e-06,
          1.06244020e-01,  -9.33981883e-06,  -4.34445598e-03,
          1.57711861e-07,   5.32493318e-07,   1.37676033e-02,
          3.57905344e-07,   1.98765329e-02,  -3.19928222e-02],
       [  6.18936389e-02,   3.65729631e-02,   1.40864162e-07,
          1.57258437e-07,   1.37049123e-01,  -1.68113340e-06,
         -1.06470937e-06,  -1.60700388e-06,   6.94014178e-02,
         -8.19650189e-07,  -1.21967796e-06,   1.91842241e-07,
         -1.20504253e-06,  -4.41675501e-07,  -7.29634864e-07,
         -9.97615492e-03,  -6.18932463e-02,  -3.65718089e-02],
       [ -6.06934995e-02,  -3.91583116e-02,  -1.61149559e-02,
          4.11884286e-02,   4.64264889e-07,   2.29540791e-01,
          2.54777911e-06,   1.06244020e-01,  -8.19650189e-07,
          1.60774304e-01,   5.99098793e-07,   7.44559090e-03,
         -4.79869771e-07,  -1.08923164e-06,   1.27931707e-02,
          6.70232929e-07,  -6.06940152e-02,  -3.91611567e-02],
       [  4.22335150e-07,   5.11620560e-06,   1.10447808e-08,
          3.65128825e-06,  -1.14914551e-08,   4.64129475e-09,
          3.27230373e-01,  -9.33981883e-06,  -1.21967796e-06,
          5.99098793e-07,   2.62398013e-01,   5.99644492e-07,
          2.83810494e-07,  -1.84347618e-02,  -7.99132398e-07,
         -1.09524097e-06,   1.81394930e-06,   2.90772670e-06],
       [ -4.86536582e-03,  -1.60649402e-03,   3.29399346e-03,
         -6.60925214e-03,   4.62013885e-07,   1.13518663e-02,
          8.40724414e-07,  -4.34445598e-03,   1.91842241e-07,
          7.44559090e-03,   5.99644492e-07,   6.62044643e-04,
         -3.84971476e-08,  -1.10091372e-07,   4.10695035e-04,
          6.16323180e-09,  -4.86579549e-03,  -1.60684827e-03],
       [ -7.88099321e-07,  -5.28655899e-07,  -1.37386498e-07,
          3.14624046e-07,  -2.37963764e-06,  -7.22253864e-07,
          3.53919588e-07,   1.57711861e-07,  -1.20504253e-06,
         -4.79869771e-07,   2.83810494e-07,  -3.84971476e-08,
          2.34978843e-11,  -1.99258136e-08,  -2.88576750e-08,
          1.73216232e-07,   1.36126307e-06,   7.41390156e-07],
       [  2.14366604e-08,  -3.94932910e-07,  -1.28831789e-07,
         -1.63038917e-09,  -1.04060725e-06,  -1.53972223e-06,
         -2.29895567e-02,   5.32493318e-07,  -4.41675501e-07,
         -1.08923164e-06,  -1.84347618e-02,  -1.10091372e-07,
         -1.99258136e-08,   1.29513346e-03,  -1.60254499e-08,
          1.52748305e-07,   8.64306917e-07,   3.16055369e-07],
       [ -3.65323172e-03,  -3.23612399e-03,  -3.90022320e-03,
          8.14691299e-03,  -1.26748328e-06,   1.78533929e-02,
         -8.58787495e-07,   1.37676033e-02,  -7.29634864e-07,
          1.27931707e-02,  -7.99132398e-07,   4.10695035e-04,
         -2.88576750e-08,  -1.60254499e-08,   1.12222256e-03,
          1.44169324e-07,  -3.65209003e-03,  -3.23566144e-03],
       [ -8.89720546e-03,  -5.25733522e-03,   2.13820488e-08,
         -1.00405882e-07,  -1.97002212e-02,   1.04895272e-06,
         -1.43143711e-06,   3.57905344e-07,  -9.97615492e-03,
          6.70232929e-07,  -1.09524097e-06,   6.16323180e-09,
          1.73216232e-07,   1.52748305e-07,   1.44169324e-07,
          1.43402932e-03,   8.89662620e-03,   5.25691076e-03],
       [ -1.89733030e-02,  -1.91664678e-02,  -1.85306058e-02,
          3.96691492e-02,  -1.22223205e-01,  -9.13371696e-02,
          1.11380048e-06,   1.98765329e-02,  -6.18932463e-02,
         -6.06940152e-02,   1.81394930e-06,  -4.86579549e-03,
          1.36126307e-06,   8.64306917e-07,  -3.65209003e-03,
          8.89662620e-03,   9.14224554e-02,   4.60664317e-02],
       [ -1.91648572e-02,  -9.58002661e-03,   1.09465082e-02,
         -1.54353123e-02,  -7.22199967e-02,  -5.54664791e-02,
          2.95367037e-06,  -3.19928222e-02,  -3.65718089e-02,
         -3.91611567e-02,   2.90772670e-06,  -1.60684827e-03,
          7.41390156e-07,   3.16055369e-07,  -3.23566144e-03,
          5.25691076e-03,   4.60664317e-02,   2.89652988e-02]])
    ref_result_energy = -75.840491329684454
    ref_result_exp_alpha = array([[  1.10127182e-04,   1.39081501e-01,   2.34941889e-01,
         -1.29924185e-01,   2.90937154e-06,   1.11739527e-01,
          1.14253284e-01,   8.42027945e-01,   7.33098627e-01,
          1.64144144e-04,   4.95946558e-01,  -3.99234508e-03,
         -1.68802397e-01,   1.13546491e-05,   9.74870108e-02,
         -1.22410762e-05,   8.32397754e-01,   9.60553437e-01],
       [  3.76291249e-03,   4.91728146e-03,   1.38827153e-01,
         -9.82511410e-02,   1.18383993e-05,   9.32958326e-01,
          1.25450625e+00,  -6.31410472e-01,  -5.73534154e-01,
         -1.06716919e-04,  -7.36192613e-02,  -9.64204640e-01,
         -6.78593676e-01,   6.52184160e-06,   4.93635946e-02,
          3.29815131e-06,   1.09384106e-01,  -1.55062211e-02],
       [  9.94156900e-01,  -2.12460936e-01,   6.98287510e-07,
         -8.39652569e-02,   2.47405631e-06,   9.53767094e-02,
         -1.17656793e-06,  -7.64006385e-07,   3.48872600e-02,
          6.24501086e-06,   6.60181216e-02,  -1.45260622e-06,
          7.09385866e-02,   8.58272350e-07,  -6.86373868e-04,
         -1.26154359e-06,   1.74165006e-02,   3.90429693e-07],
       [  3.33312071e-02,   4.54379561e-01,   2.98534258e-07,
          1.81101606e-01,   1.99992097e-06,  -1.78559184e-01,
         -5.29547619e-07,  -4.55862427e-07,  -1.41334867e-01,
          3.27739604e-05,  -3.63088281e-01,  -2.41001290e-06,
         -1.62305081e+00,  -1.39817736e-05,   1.34744241e-01,
          5.89028920e-06,   5.55154134e-01,  -6.09892641e-07],
       [  1.31016839e-09,   8.70011887e-07,   5.20226248e-01,
          3.58629272e-06,  -3.11850482e-06,  -8.38319658e-06,
         -4.35088337e-01,  -1.94047731e-01,  -1.14619264e-05,
         -1.14805844e-05,  -1.78162705e-05,  -9.78381307e-01,
          6.38660893e-06,   2.91340732e-05,  -9.08267268e-06,
          3.29776046e-06,  -3.33182663e-06,   3.70358373e-02],
       [ -1.73491379e-03,  -1.35791874e-01,  -4.34023804e-06,
          5.57632965e-01,  -1.51362974e-05,   2.81460804e-01,
         -6.04801189e-06,  -2.90467163e-05,   6.52953601e-01,
          1.76266641e-04,  -7.08320779e-01,   1.20824284e-05,
          1.81044135e-01,   3.07842268e-06,  -6.49989747e-03,
          5.91252928e-06,  -3.95865706e-02,  -5.17723694e-06],
       [  7.03324496e-08,  -1.00741037e-06,   5.53387829e-06,
          2.17533900e-05,   6.38812572e-01,  -5.68080751e-06,
         -4.32776269e-06,   4.56522763e-05,  -2.57883497e-04,
          9.63278916e-01,   1.39312330e-05,  -1.74325564e-05,
          3.86713147e-05,  -2.28411401e-06,  -4.16571600e-06,
          7.64665617e-03,  -9.82522793e-06,   1.72941299e-06],
       [ -1.64907648e-02,   4.68397070e-01,  -5.89314124e-06,
          3.48411243e-01,  -2.79320514e-05,  -1.09442308e+00,
          2.08433734e-05,  -1.76713208e-06,   1.74796140e-01,
         -6.53181083e-05,  -2.98822815e-03,   2.05196066e-05,
          2.54393821e+00,   2.06287103e-05,  -2.69500155e-01,
          3.25553023e-06,  -1.32657393e+00,  -3.51586118e-06],
       [ -5.66592593e-09,   5.08486601e-07,   2.63441525e-01,
         -8.40634974e-07,  -3.94880066e-06,  -7.63661902e-06,
         -7.46733269e-01,  -4.36399517e-01,  -7.43086709e-06,
          5.08704831e-05,   4.54542007e-05,   1.69471906e+00,
         -8.17324081e-06,  -4.29262959e-05,   1.38496246e-05,
         -9.31978453e-06,   3.08443732e-06,  -9.45143835e-01],
       [  2.83384911e-03,  -6.71145065e-02,  -1.72049391e-06,
          3.95299710e-01,  -9.57891680e-06,   4.20601052e-01,
         -6.83806211e-06,   2.00057874e-05,  -3.43595263e-01,
         -7.55792149e-05,   1.13305149e+00,  -2.81404817e-05,
         -6.27280875e-01,  -1.67438389e-05,   1.50897564e-01,
         -2.87893920e-05,   6.76003036e-01,   8.47282561e-06],
       [ -3.76409613e-08,   2.17647559e-07,   3.04849094e-06,
          1.39655974e-05,   5.12247813e-01,   2.23045387e-07,
          3.48910691e-06,  -4.99044749e-05,   2.77063757e-04,
         -1.03558004e+00,  -1.17026297e-05,   2.05944433e-05,
         -3.59371869e-05,  -2.05626648e-06,   1.53482932e-05,
          3.49627073e-02,   8.35149006e-06,  -1.62196431e-07],
       [  1.90790290e-04,  -2.06677137e-02,   8.17027582e-07,
          1.53249448e-02,   7.61593549e-07,   1.28650538e-02,
         -1.87133908e-06,   3.22109468e-06,  -1.33484446e-01,
         -3.46020644e-05,  -8.93969320e-02,   5.92601911e-06,
          1.58239058e-01,   1.39517147e-04,  -4.73050498e-01,
          1.21820926e-04,   9.80678880e-01,   2.35703947e-06],
       [  1.03623667e-08,   1.10103083e-06,  -4.57423162e-06,
         -1.02708575e-06,   5.54095136e-07,  -2.50984081e-06,
          7.99022775e-06,   1.31936168e-06,  -5.51941209e-06,
          1.29660157e-06,  -2.26565441e-06,   2.30649570e-05,
          6.02575840e-06,   9.99999964e-01,   2.51936282e-04,
          8.90319483e-05,  -2.26082963e-05,  -1.22547374e-05],
       [ -4.44727683e-09,   1.49947717e-06,  -2.21600802e-06,
         -3.37291513e-06,  -3.59879549e-02,  -4.46677187e-06,
          1.48603551e-06,  -3.28222170e-06,  -1.18122783e-05,
          1.59339353e-02,   2.22221785e-06,   1.88568287e-06,
          2.95350979e-05,  -8.90339363e-05,   2.77714019e-04,
          9.99225145e-01,   4.41108880e-06,  -5.73205664e-06],
       [ -1.13460906e-04,   4.71941954e-03,  -2.67295615e-06,
          3.31652889e-02,  -2.46624515e-06,   1.02929801e-02,
          3.59328661e-06,  -7.18787432e-07,   1.10284646e-01,
          2.52446575e-05,   1.07991495e-01,   2.26790765e-06,
         -1.81307828e-01,   2.10642070e-04,  -8.73789791e-01,
          2.51193380e-04,  -5.07570414e-01,  -7.87247627e-06],
       [  5.11688982e-09,  -7.55394321e-07,  -3.78685849e-02,
          1.40234613e-06,  -1.91278124e-06,   1.55929170e-06,
          1.71043494e-02,  -2.14104954e-01,  -6.35521114e-06,
          9.84441362e-06,  -4.10089954e-06,   2.60430588e-02,
         -2.28726080e-06,   1.49752898e-05,  -7.68481761e-06,
          6.21925269e-06,  -7.08752088e-06,   1.27315585e+00],
       [  1.10118288e-04,   1.39081192e-01,  -2.34941765e-01,
         -1.29927587e-01,   8.42251770e-06,   1.11736622e-01,
         -1.14256791e-01,  -8.42082755e-01,   7.33029633e-01,
          2.45695037e-04,   4.95968130e-01,   3.95775145e-03,
         -1.68797428e-01,  -1.04736349e-05,   9.74954851e-02,
         -3.06178245e-05,   8.32403765e-01,  -9.60541370e-01],
       [  3.76291145e-03,   4.91720272e-03,  -1.38823418e-01,
         -9.82595603e-02,   9.17963902e-06,   9.32922409e-01,
         -1.25453729e+00,   6.31454213e-01,  -5.73471702e-01,
         -1.39655621e-04,  -7.35818977e-02,   9.64200618e-01,
         -6.78606608e-01,  -2.04674125e-05,   4.93730011e-02,
          7.52607837e-06,   1.09382808e-01,   1.55053025e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_lda.py")

    l = {}
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], l[k], v), l[k] - l[var_name]
