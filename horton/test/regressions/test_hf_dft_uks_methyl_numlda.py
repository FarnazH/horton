# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_hf_dft_uks_methyl_numlda():
    ref_result_dm_alpha = array([[  1.03042697e+00,  -3.95358488e-02,   7.91582378e-06,
          5.89416882e-06,   1.57744367e-05,  -1.12406887e-01,
          1.45219987e-05,   2.64321629e-06,   1.23246949e-05,
          2.13854512e-03,  -1.06921434e-06,  -4.08656772e-06,
         -3.62174711e-06,   1.40486636e-07,  -2.92820243e-02,
         -4.72163967e-03,  -2.92810418e-02,  -4.70858825e-03,
         -2.92684167e-02,  -4.72077418e-03],
       [ -3.95358488e-02,   1.56874753e-01,  -1.20597309e-05,
         -1.85864531e-05,  -2.27465714e-05,   1.64008617e-01,
         -2.71318180e-05,  -8.54169949e-06,  -1.64259853e-05,
         -4.06391800e-03,   1.99314285e-06,   7.70521170e-06,
          6.87218133e-06,   1.81474756e-07,   5.29163759e-02,
          1.97722829e-02,   5.29084325e-02,   1.97425340e-02,
          5.28912614e-02,   1.97716176e-02],
       [  7.91582378e-06,  -1.20597309e-05,   2.06219569e-01,
          7.75533794e-06,  -1.31445836e-05,  -4.87444508e-05,
          9.61744742e-02,   6.98718166e-05,   4.00505029e-06,
         -1.11898767e-05,   7.04513889e-06,  -9.76984506e-06,
          9.01135160e-03,   2.90692060e-06,   1.20366196e-01,
          1.04198622e-01,  -6.01988600e-02,  -5.21081103e-02,
         -6.01421797e-02,  -5.20442635e-02],
       [  5.89416882e-06,  -1.85864531e-05,   7.75533794e-06,
          2.06263950e-01,   3.52970994e-06,   6.22108384e-06,
         -7.82093575e-05,   9.61735074e-02,  -9.33059743e-06,
          6.06217226e-06,  -3.54225059e-07,   1.19172070e-05,
          9.24815753e-06,  -9.01607565e-03,   1.92639946e-05,
          7.30819570e-05,   1.04240766e-01,   9.01924712e-02,
         -1.04204390e-01,  -9.03113367e-02],
       [  1.57744367e-05,  -2.27465714e-05,  -1.31445836e-05,
          3.52970994e-06,   3.54943654e-01,  -1.02808606e-04,
          4.59981123e-06,   4.11826907e-05,   3.17245932e-01,
          1.14553628e-05,  -2.55641939e-06,   1.19764776e-05,
         -3.87355752e-06,  -3.21091147e-06,   6.24069572e-05,
          5.32941838e-06,   1.02431050e-04,  -4.86758989e-05,
          2.65476748e-05,   9.43406949e-05],
       [ -1.12406887e-01,   1.64008617e-01,  -4.87444508e-05,
          6.22108384e-06,  -1.02808606e-04,   1.76417018e-01,
         -4.56078667e-05,   3.01573176e-06,  -8.77565046e-05,
         -4.32633612e-03,   2.12256101e-06,   8.20551839e-06,
          5.75391665e-06,  -9.48131790e-07,   5.64124362e-02,
          2.06351372e-02,   5.64485461e-02,   2.06420418e-02,
          5.64040118e-02,   2.06502190e-02],
       [  1.45219987e-05,  -2.71318180e-05,   9.61744742e-02,
         -7.82093575e-05,   4.59981123e-06,  -4.56078667e-05,
          4.48528571e-02,  -5.56538884e-06,   1.14626753e-05,
         -4.65742944e-06,   3.28542340e-06,  -4.56178967e-06,
          4.20261299e-03,   4.93242797e-06,   5.61277512e-02,
          4.85922994e-02,  -2.81235919e-02,  -2.43401116e-02,
         -2.80144636e-02,  -2.42387257e-02],
       [  2.64321629e-06,  -8.54169949e-06,   6.98718166e-05,
          9.61735074e-02,   4.11826907e-05,   3.01573176e-06,
         -5.56538884e-06,   4.48422946e-02,   3.09923325e-05,
          2.82078046e-06,  -1.63181995e-07,   5.55476929e-06,
          7.20695903e-06,  -4.20387310e-03,   4.77074350e-05,
          6.75710420e-05,   4.85844569e-02,   4.20367932e-02,
         -4.86060561e-02,  -4.21256416e-02],
       [  1.23246949e-05,  -1.64259853e-05,   4.00505029e-06,
         -9.33059743e-06,   3.17245932e-01,  -8.77565046e-05,
          1.14626753e-05,   3.09923325e-05,   2.83551998e-01,
          1.01354822e-05,  -2.28429846e-06,   1.07032101e-05,
         -2.77411219e-06,  -2.32390133e-06,   6.63026065e-05,
          1.32112471e-05,   8.19724609e-05,  -5.24553498e-05,
          2.67699611e-05,   8.63036406e-05],
       [  2.13854512e-03,  -4.06391800e-03,  -1.11898767e-05,
          6.06217226e-06,   1.14553628e-05,  -4.32633612e-03,
         -4.65742944e-06,   2.82078046e-06,   1.01354822e-05,
          1.06495803e-04,  -5.27332897e-08,  -2.00715503e-07,
         -6.82808820e-07,  -2.48653783e-07,  -1.39495195e-03,
         -5.17737569e-04,  -1.38185089e-03,  -5.05802462e-04,
         -1.38704117e-03,  -5.11443223e-04],
       [ -1.06921434e-06,   1.99314285e-06,   7.04513889e-06,
         -3.54225059e-07,  -2.55641939e-06,   2.12256101e-06,
          3.28542340e-06,  -1.63181995e-07,  -2.28429846e-06,
         -5.27332897e-08,   2.85343995e-10,  -3.41373413e-10,
          3.07961057e-07,   1.56084058e-08,   4.79291837e-06,
          3.81073661e-06,  -1.55521683e-06,  -1.68403108e-06,
         -1.19498320e-06,  -1.37251881e-06],
       [ -4.08656772e-06,   7.70521170e-06,  -9.76984506e-06,
          1.19172070e-05,   1.19764776e-05,   8.20551839e-06,
         -4.56178967e-06,   5.55476929e-06,   1.07032101e-05,
         -2.00715503e-07,  -3.41373413e-10,   1.93857544e-09,
         -4.26149837e-07,  -5.21205609e-07,  -3.06585690e-06,
         -3.96103718e-06,   1.15111610e-05,   8.64768230e-06,
         -5.39351245e-07,  -1.77897254e-06],
       [ -3.62174711e-06,   6.87218133e-06,   9.01135160e-03,
          9.24815753e-06,  -3.87355752e-06,   5.75391665e-06,
          4.20261299e-03,   7.20695903e-06,  -2.77411219e-06,
         -6.82808820e-07,   3.07961057e-07,  -4.26149837e-07,
          3.93777451e-04,  -2.62411711e-07,   5.26227311e-03,
          4.55419095e-03,  -2.62353015e-03,  -2.27218508e-03,
         -2.63005787e-03,  -2.27719246e-03],
       [  1.40486636e-07,   1.81474756e-07,   2.90692060e-06,
         -9.01607565e-03,  -3.21091147e-06,  -9.48131790e-07,
          4.93242797e-06,  -4.20387310e-03,  -2.32390133e-06,
         -2.48653783e-07,   1.56084058e-08,  -5.21205609e-07,
         -2.62411711e-07,   3.94104915e-04,   8.35315466e-07,
         -1.63400774e-06,  -4.55766956e-03,  -3.94333378e-03,
          4.55375132e-03,   3.94673107e-03],
       [ -2.92820243e-02,   5.29163759e-02,   1.20366196e-01,
          1.92639946e-05,   6.24069572e-05,   5.64124362e-02,
          5.61277512e-02,   4.77074350e-05,   6.63026065e-05,
         -1.39495195e-03,   4.79291837e-06,  -3.06585690e-06,
          5.26227311e-03,   8.35315466e-07,   8.83588929e-02,
          6.74870460e-02,  -1.70289445e-02,  -2.37501274e-02,
         -1.70230474e-02,  -2.37213408e-02],
       [ -4.72163967e-03,   1.97722829e-02,   1.04198622e-01,
          7.30819570e-05,   5.32941838e-06,   2.06351372e-02,
          4.85922994e-02,   6.75710420e-05,   1.32112471e-05,
         -5.17737569e-04,   3.81073661e-06,  -3.96103718e-06,
          4.55419095e-03,  -1.63400774e-06,   6.74870460e-02,
          5.51431784e-02,  -2.37150617e-02,  -2.38091456e-02,
         -2.37608502e-02,  -2.38357889e-02],
       [ -2.92810418e-02,   5.29084325e-02,  -6.01988600e-02,
          1.04240766e-01,   1.02431050e-04,   5.64485461e-02,
         -2.81235919e-02,   4.85844569e-02,   8.19724609e-05,
         -1.38185089e-03,  -1.55521683e-06,   1.15111610e-05,
         -2.62353015e-03,  -4.55766956e-03,  -1.70289445e-02,
         -2.37150617e-02,   8.83534167e-02,   6.74509917e-02,
         -1.70208086e-02,  -2.37874199e-02],
       [ -4.70858825e-03,   1.97425340e-02,  -5.21081103e-02,
          9.01924712e-02,  -4.86758989e-05,   2.06420418e-02,
         -2.43401116e-02,   4.20367932e-02,  -5.24553498e-05,
         -5.05802462e-04,  -1.68403108e-06,   8.64768230e-06,
         -2.27218508e-03,  -3.94333378e-03,  -2.37501274e-02,
         -2.38091456e-02,   6.74509917e-02,   5.50926790e-02,
         -2.37160655e-02,  -2.38519821e-02],
       [ -2.92684167e-02,   5.28912614e-02,  -6.01421797e-02,
         -1.04204390e-01,   2.65476748e-05,   5.64040118e-02,
         -2.80144636e-02,  -4.86060561e-02,   2.67699611e-05,
         -1.38704117e-03,  -1.19498320e-06,  -5.39351245e-07,
         -2.63005787e-03,   4.55375132e-03,  -1.70230474e-02,
         -2.37608502e-02,  -1.70208086e-02,  -2.37160655e-02,
          8.82544371e-02,   6.74581168e-02],
       [ -4.72077418e-03,   1.97716176e-02,  -5.20442635e-02,
         -9.03113367e-02,   9.43406949e-05,   2.06502190e-02,
         -2.42387257e-02,  -4.21256416e-02,   8.63036406e-05,
         -5.11443223e-04,  -1.37251881e-06,  -1.77897254e-06,
         -2.27719246e-03,   3.94673107e-03,  -2.37213408e-02,
         -2.38357889e-02,  -2.37874199e-02,  -2.38519821e-02,
          6.74581168e-02,   5.51642714e-02]])
    ref_result_energy = -39.414931258592176
    ref_result_exp_alpha = array([[  9.93910282e-01,  -2.06323336e-01,  -3.93136805e-05,
          2.20611068e-05,  -2.93924349e-05,  -1.56675807e-01,
          2.12727069e-05,   4.81996335e-05,   9.18626607e-06,
         -1.85051781e-05,  -2.25710733e-05,   4.68081470e-02,
         -7.02532744e-06,   4.78608763e-07,   3.94396905e-02,
         -2.82189994e-08,  -1.03878021e-05,  -4.01886517e-02,
          6.27625188e-05,  -3.08237193e-05],
       [  4.19788550e-02,   3.93843281e-01,   6.75010376e-05,
         -5.65972185e-05,   4.29964179e-05,   2.62891095e-01,
         -2.32321868e-05,   9.46735125e-06,  -3.39360478e-05,
         -3.45777021e-04,  -2.99497125e-04,   7.33317243e-01,
          1.32354806e-03,  -1.67133754e-03,  -1.92234791e+00,
         -1.77567085e-04,  -1.47729100e-04,  -2.75705862e-01,
          2.17887107e-04,  -1.53512596e-04],
       [  3.04702699e-07,   5.55875410e-05,  -4.49563831e-01,
          6.41242847e-02,   3.60683408e-05,   1.59398923e-04,
         -1.63578789e-01,   4.18184251e-01,  -8.40993243e-05,
         -1.20367282e-01,   8.38664889e-01,   8.26758331e-04,
         -1.19920666e-01,   7.19297257e-01,  -4.89387758e-04,
          4.64063238e-05,   1.27196759e-04,  -2.88559563e-06,
         -3.13564412e-02,   5.35499050e-02],
       [ -1.77689988e-07,   6.39987066e-06,   6.41142746e-02,
          4.49614660e-01,   4.66844095e-05,  -1.24891486e-04,
         -4.18066138e-01,  -1.63522517e-01,   2.81271151e-04,
         -8.38488194e-01,  -1.20199179e-01,  -6.30855488e-04,
          7.19607129e-01,   1.19798068e-01,   2.89095291e-04,
         -1.12821612e-04,   1.08871443e-04,   3.51010202e-05,
         -5.34583206e-02,  -3.14082131e-02],
       [ -2.30555357e-07,   7.34621370e-06,  -8.44398427e-06,
          7.09145736e-05,  -5.95771492e-01,   5.81793682e-05,
          1.13509348e-04,   5.04087047e-05,   1.06099168e+00,
          2.67016014e-04,   2.53342970e-04,  -2.05685258e-04,
          3.01378146e-05,  -1.05646944e-04,  -1.09742725e-04,
          2.35387231e-05,  -1.32005095e-05,   6.06869616e-05,
          2.06014570e-05,  -2.04357996e-06],
       [ -2.60728135e-02,   4.19210181e-01,   1.58228372e-04,
         -1.47856222e-05,   1.77628324e-04,   1.85138773e+00,
         -2.30470299e-04,  -8.07899572e-04,   9.51337629e-05,
          5.02458730e-04,   4.26065288e-04,  -1.15219565e+00,
         -2.35844941e-03,   2.95194451e-03,   3.55786390e+00,
          4.04943460e-04,   3.51339955e-04,   7.87221058e-01,
         -7.96007980e-04,   4.14828719e-04],
       [ -2.90690993e-07,  -2.86477253e-05,  -2.09688151e-01,
          2.97272313e-02,  -1.21067700e-06,   3.50325799e-04,
         -4.61055172e-01,   1.17683083e+00,   2.31500649e-04,
          2.47367529e-01,  -1.72233968e+00,  -1.36805513e-03,
          1.79775161e-01,  -1.07855449e+00,   8.24935709e-04,
         -1.18240153e-04,  -4.32412755e-04,  -5.82468676e-04,
         -2.68254832e-01,   4.56706606e-01],
       [ -1.21229416e-07,   3.33729760e-06,   2.97497535e-02,
          2.09659894e-01,  -4.45907376e-05,  -2.48153989e-04,
         -1.17709939e+00,  -4.61158853e-01,  -3.61929467e-04,
          1.72176158e+00,   2.47039314e-01,   1.17312206e-03,
         -1.07928681e+00,  -1.79478258e-01,  -4.73694185e-04,
          5.73660259e-04,  -2.41815777e-04,  -4.93933111e-04,
         -4.56709597e-01,  -2.68179562e-01],
       [  5.87721087e-08,   1.64416243e-05,  -4.57713373e-05,
          4.10643407e-05,  -5.32495985e-01,   5.97411858e-05,
         -7.50901438e-05,  -3.71431956e-05,  -1.09411841e+00,
         -2.45236897e-04,  -2.50004050e-04,   8.98189938e-05,
          3.77287392e-05,   1.26034051e-04,   5.56527949e-05,
         -9.66253833e-07,   1.03875336e-05,  -1.70994818e-05,
         -3.37854645e-05,   2.46992210e-06],
       [  9.42369154e-06,  -1.03196256e-02,   2.50562416e-05,
          1.00620913e-05,  -1.93690391e-05,   1.22507078e-02,
         -4.67356181e-05,   8.14791235e-06,   9.54882855e-06,
          8.80927065e-05,  -5.58086530e-06,  -1.83441547e-01,
          8.85178981e-07,   2.96404175e-04,  -3.41152780e-02,
         -3.49708511e-04,  -2.10395548e-04,  -1.05116205e+00,
          1.31287120e-03,  -4.93738560e-04],
       [ -2.46920739e-08,   5.06575257e-06,  -1.54781150e-05,
          1.41879595e-06,   4.27460471e-06,  -9.22318427e-06,
          2.99825802e-05,  -3.05115130e-05,   6.50420979e-06,
          4.77721473e-06,   5.86919444e-05,  -3.48557714e-06,
         -9.19298433e-06,  -2.88814766e-04,  -6.21341087e-05,
          3.40879312e-01,   9.40106814e-01,  -2.99694075e-04,
         -2.19469325e-04,   4.91165647e-04],
       [ -4.91107198e-08,   1.95705758e-05,   2.50063915e-05,
          2.29517228e-05,  -2.00934467e-05,  -2.99357934e-05,
          2.05061998e-05,   1.82788529e-05,   1.39000465e-05,
         -4.54774928e-05,  -8.77726821e-05,   1.65705763e-04,
         -3.38456370e-04,   4.62826166e-05,   9.31483443e-05,
         -9.40106636e-01,   3.40879385e-01,   2.11440712e-04,
         -6.37572524e-04,  -3.74780155e-04],
       [ -7.65248392e-08,   2.12274495e-05,  -1.96422156e-02,
          2.82151976e-03,   7.11625373e-06,  -3.33130743e-05,
          7.76014852e-03,  -1.98126520e-02,  -2.72207698e-05,
         -1.58359278e-02,   1.10101467e-01,   1.19315493e-04,
          3.38716066e-02,  -2.03772063e-01,   2.67968317e-04,
         -2.49260127e-04,  -5.96505792e-04,  -1.21442567e-03,
         -5.48715103e-01,   9.34309766e-01],
       [  7.42218497e-08,  -1.89129939e-06,  -2.80959119e-03,
         -1.96522459e-02,   3.09009303e-06,   1.20065786e-05,
         -1.97980691e-02,  -7.78916099e-03,  -4.55174185e-05,
          1.10086995e-01,   1.58827265e-02,   1.65063761e-05,
          2.03606054e-01,   3.37514942e-02,   2.62344486e-05,
         -8.41813399e-04,   2.48152569e-04,   9.25294588e-04,
          9.34351756e-01,   5.48714496e-01],
       [ -1.53694705e-03,   1.34573158e-01,  -2.62380783e-01,
          3.74559911e-02,  -9.48995529e-05,  -1.03226830e-01,
          4.48988669e-02,  -1.14609748e-01,  -5.66875656e-05,
         -5.72394356e-02,   3.96723306e-01,   6.27195869e-01,
          1.45626174e-01,  -8.74665427e-01,   3.11280461e-01,
         -6.82968879e-05,   1.57892502e-05,  -3.75758241e-01,
          3.48260790e-01,  -5.92660138e-01],
       [  5.54763235e-03,   4.96556811e-02,  -2.27128234e-01,
          3.25499514e-02,  -1.19564136e-06,  -9.60145323e-01,
          5.93252609e-01,  -1.51393375e+00,  -3.50432007e-05,
         -7.56729027e-02,   5.26206790e-01,  -1.73525542e-01,
         -2.53962009e-01,   1.52786859e+00,  -1.10032510e+00,
          6.38030587e-05,   2.39006590e-04,  -6.30250029e-02,
          2.54566522e-03,  -4.02577649e-03],
       [ -1.53714211e-03,   1.34504574e-01,   1.63662086e-01,
          2.08504860e-01,  -1.47759114e-04,  -1.03202383e-01,
          7.69612825e-02,   9.63196226e-02,   2.59582564e-04,
         -3.15947222e-01,  -2.48437803e-01,   6.28032430e-01,
         -8.30015838e-01,   3.11042945e-01,   3.09997574e-01,
         -1.06854664e-04,  -1.85093974e-04,  -3.76104147e-01,
          3.39545602e-01,   5.96978448e-01],
       [  5.54767644e-03,   4.95382221e-02,   1.41645960e-01,
          1.80400275e-01,   1.01822529e-04,  -9.59149577e-01,
          1.01499932e+00,   1.27120464e+00,  -1.26786788e-04,
         -4.16881841e-01,  -3.28082415e-01,  -1.76002312e-01,
          1.45174981e+00,  -5.44581062e-01,  -1.09793799e+00,
         -5.75119835e-04,  -1.57519366e-05,  -6.32554349e-02,
          2.36586757e-03,   4.25098826e-03],
       [ -1.53721359e-03,   1.34406818e-01,   9.87291519e-02,
         -2.45844283e-01,  -7.35511691e-05,  -1.03246070e-01,
         -1.21855762e-01,   1.84202762e-02,   1.60146304e-04,
          3.72419645e-01,  -1.49382900e-01,   6.27964986e-01,
          6.84667623e-01,   5.63388451e-01,   3.10700762e-01,
          2.46519767e-04,  -1.52172307e-04,  -3.76981095e-01,
         -6.86124602e-01,  -5.26811686e-03],
       [  5.54752184e-03,   4.95652118e-02,   8.53848784e-02,
         -2.13040204e-01,  -1.84263492e-04,  -9.59787822e-01,
         -1.60792723e+00,   2.43876093e-01,  -1.60610337e-04,
          4.92814096e-01,  -1.97679877e-01,  -1.74734900e-01,
         -1.19620794e+00,  -9.85172745e-01,  -1.09910367e+00,
          8.69705457e-05,  -3.79425251e-04,  -6.34011175e-02,
         -4.96313573e-03,  -9.20499617e-05]])
    ref_result_exp_beta = array([[  9.94136483e-01,   1.99383857e-01,  -4.17440299e-05,
          2.31698054e-05,   3.37166345e-05,   1.62566681e-01,
         -3.20617197e-05,   4.84770171e-05,  -2.26206511e-05,
          2.67151813e-05,  -1.80235009e-05,   5.46986621e-02,
         -3.33054320e-06,  -1.81611043e-05,   4.10309339e-02,
          1.98693181e-06,  -7.38994396e-06,   3.42230401e-02,
          7.95578674e-05,  -3.61982427e-05],
       [  4.02078317e-02,  -3.74383959e-01,   7.21000023e-05,
         -5.81114636e-05,  -4.69796977e-05,  -2.54162433e-01,
          3.52636675e-05,   1.28857949e-05,  -3.09071000e-04,
          2.66913619e-04,  -3.42762427e-05,   6.32958951e-01,
         -8.73619961e-04,  -1.32708791e-03,  -1.95777478e+00,
         -1.72595695e-04,  -1.53991941e-04,   3.08674699e-01,
          4.66329393e-04,  -2.41085272e-04],
       [  2.86458233e-07,  -6.08691666e-05,  -4.27352719e-01,
          6.23943424e-02,  -3.02489761e-05,  -1.41584262e-04,
          1.59054632e-01,   4.14390598e-01,  -8.50156154e-02,
         -8.30466020e-01,  -4.15148911e-04,   9.50136995e-04,
          1.19998846e-01,   7.50164926e-01,  -3.44039742e-04,
          3.91792677e-05,   1.07341470e-04,   4.06498883e-05,
         -3.09527046e-02,   5.26762253e-02],
       [ -2.31832844e-07,  -6.39729149e-06,   6.23866768e-02,
          4.27397721e-01,  -2.65279957e-05,   1.51397598e-04,
          4.14283471e-01,  -1.59000712e-01,  -8.30241484e-01,
          8.48340868e-02,   6.73797877e-04,  -6.26824954e-04,
         -7.50504454e-01,   1.19871285e-01,   1.62148227e-04,
         -9.04690695e-05,   9.75697330e-05,  -2.19995701e-06,
         -5.25835944e-02,  -3.10059829e-02],
       [  8.12927751e-08,  -2.29635004e-05,  -5.46797164e-06,
          6.28344585e-05,   5.45900880e-01,  -5.66534107e-05,
         -1.11889235e-04,   4.57646255e-05,  -8.75090484e-04,
          4.96673322e-04,  -1.08749175e+00,  -3.29398188e-04,
         -2.99411834e-05,  -1.32885419e-04,  -9.89398994e-05,
          2.16436099e-05,  -1.14596993e-05,  -6.62233003e-05,
          2.10536643e-05,  -2.01538871e-06],
       [ -2.46017108e-02,  -3.77485015e-01,   1.51601647e-04,
         -1.13747142e-05,  -1.88232513e-04,  -1.91257191e+00,
          3.66329865e-04,  -8.05726354e-04,   4.61953085e-04,
         -3.80467546e-04,   4.63599399e-05,  -1.02281541e+00,
          1.51164859e-03,   2.32818815e-03,   3.56631231e+00,
          3.74692529e-04,   3.39936054e-04,  -8.02470970e-01,
         -1.36328911e-03,   6.12569347e-04],
       [ -2.82186129e-07,   3.06106520e-05,  -1.90941956e-01,
          2.76868320e-02,   1.15213690e-05,  -3.17043374e-04,
          4.66281119e-01,   1.21296757e+00,   1.73513813e-01,
          1.69339072e+00,   7.78794220e-04,  -1.54220450e-03,
         -1.75961849e-01,  -1.10023799e+00,   5.88679464e-04,
         -1.18592608e-04,  -4.38886838e-04,   8.64974643e-04,
         -2.69204344e-01,   4.56693955e-01],
       [ -8.70474089e-08,  -1.95163252e-06,   2.77132651e-02,
          1.90897766e-01,   8.57376973e-05,   3.24757072e-04,
          1.21322755e+00,  -4.66377923e-01,   1.69275407e+00,
         -1.73187159e-01,  -1.54931534e-03,   1.13615715e-03,
          1.10101391e+00,  -1.75656577e-01,  -2.82423512e-04,
          5.88752235e-04,  -2.50328884e-04,   7.39737337e-04,
         -4.56695822e-01,  -2.69129386e-01],
       [ -5.39650756e-08,  -2.45468221e-05,  -4.41867110e-05,
          3.73703165e-05,   5.82688482e-01,  -5.45151183e-05,
          3.44343527e-05,  -2.53049645e-05,   8.94462937e-04,
         -4.97462531e-04,   1.06823230e+00,   1.99289318e-04,
         -3.95291268e-05,   1.48245184e-04,   4.62427044e-05,
         -4.30090886e-07,   9.69541241e-06,   1.92125760e-05,
         -3.35421866e-05,   2.38087983e-06],
       [ -5.54397493e-04,   2.53945732e-02,   2.11882645e-05,
          1.00396541e-05,   2.64729771e-05,   7.02480612e-03,
          4.00044008e-05,   1.26481369e-05,   7.98890812e-05,
          9.71680630e-06,  -1.57057000e-06,  -1.64616898e-01,
          9.98753344e-06,   3.02643441e-04,  -5.11243878e-03,
         -3.25269262e-04,  -1.90717053e-04,   1.05460455e+00,
          2.04129026e-03,  -7.39748880e-04],
       [  2.57209319e-08,  -6.77172421e-06,  -2.03775564e-05,
          2.61294666e-06,  -5.15908246e-06,   7.03574368e-06,
         -2.56296128e-05,  -2.46549519e-05,   6.36107406e-06,
         -6.25953049e-05,  -5.56336807e-06,  -7.71858982e-06,
          1.02086581e-05,  -2.62679167e-04,  -6.29095018e-05,
          3.47758271e-01,   9.37583964e-01,   2.76345794e-04,
         -2.46975917e-04,   5.29052454e-04],
       [  2.82431533e-08,  -2.33013905e-05,   2.55792264e-05,
          2.71829835e-05,   1.79644120e-05,   2.43731598e-05,
         -1.40670771e-05,   1.46886165e-05,  -5.36172545e-05,
          8.48193926e-05,  -1.32926088e-05,   1.60781452e-04,
          3.07148026e-04,   4.44890164e-05,   7.68804679e-05,
         -9.37583759e-01,   3.47758320e-01,  -1.99353303e-04,
         -7.05483310e-04,  -4.08478513e-04],
       [ -6.60336570e-08,  -2.38376311e-05,  -1.91674784e-02,
          2.81821038e-03,  -7.23064054e-06,   2.83366021e-05,
         -6.49828009e-03,  -1.69099543e-02,  -1.16043807e-02,
         -1.13040621e-01,  -3.33892818e-05,   1.18337541e-04,
         -3.13342848e-02,  -1.96490820e-01,   2.09440359e-04,
         -2.60068373e-04,  -6.39691297e-04,   1.80077428e-03,
         -5.50796946e-01,   9.34519707e-01],
       [  6.92011089e-08,   2.51654656e-06,  -2.80745829e-03,
         -1.91775365e-02,  -2.88146609e-06,  -1.11647893e-05,
          1.68943270e-02,  -6.52665804e-03,   1.13031063e-01,
         -1.16554377e-02,  -8.21033597e-05,   1.33788592e-05,
         -1.96322712e-01,   3.12144311e-02,  -1.86397705e-05,
         -9.09348611e-04,   2.82707773e-04,  -1.43667196e-03,
          9.34559911e-01,   5.50797121e-01],
       [ -1.54308445e-03,  -1.45582651e-01,  -2.74357562e-01,
          4.00861159e-02,   9.30481770e-05,   9.03456791e-02,
         -3.92192905e-02,  -1.02017749e-01,  -4.33982590e-02,
         -4.21038384e-01,  -2.35403587e-04,   6.48182776e-01,
         -1.38686224e-01,  -8.67836867e-01,   2.86576825e-01,
         -4.16593826e-05,   7.61703003e-05,   3.57951251e-01,
          3.46512432e-01,  -5.87275048e-01],
       [  5.23573381e-03,  -7.06373950e-02,  -2.53267311e-01,
          3.71377980e-02,  -1.53748835e-05,   9.77365716e-01,
         -5.89929138e-01,  -1.53409407e+00,  -4.90469977e-02,
         -4.77837037e-01,  -2.71246768e-04,  -2.13056661e-01,
          2.43228569e-01,   1.52387265e+00,  -1.07567105e+00,
          5.56336758e-05,   2.11768064e-04,   7.36623265e-02,
          4.47514239e-03,  -7.20514028e-03],
       [ -1.54327836e-03,  -1.45507685e-01,   1.71943373e-01,
          2.17572227e-01,   1.46849165e-04,   9.03287329e-02,
         -6.88897890e-02,   8.50930856e-02,  -3.44000529e-01,
          2.48630618e-01,   1.84901909e-04,   6.49077816e-01,
          8.20341623e-01,   3.13483440e-01,   2.85728953e-01,
         -1.68522505e-04,  -1.64879381e-04,   3.58589789e-01,
          3.36032946e-01,   5.92467804e-01],
       [  5.23576721e-03,  -7.05022233e-02,   1.58696773e-01,
          2.00755266e-01,  -1.45199766e-04,   9.76358221e-01,
         -1.03420981e+00,   1.27834241e+00,  -3.88202124e-01,
          2.80824253e-01,   7.55119047e-04,  -2.15701130e-01,
         -1.44227794e+00,  -5.51727352e-01,  -1.07405301e+00,
         -5.32235903e-04,  -1.83657322e-05,   7.38750901e-02,
          4.22510831e-03,   7.41928495e-03],
       [ -1.54336559e-03,  -1.45401573e-01,   1.02448747e-01,
         -2.57548833e-01,   6.77999984e-05,   9.03872615e-02,
          1.08103471e-01,   1.70390040e-02,   3.86591274e-01,
          1.73580547e-01,  -5.31781979e-04,   6.49035639e-01,
         -6.82204528e-01,   5.53662384e-01,   2.86140974e-01,
          2.98056568e-04,  -1.91576735e-04,   3.60020010e-01,
         -6.80183666e-01,  -6.36297152e-03],
       [  5.23565106e-03,  -7.05277162e-02,   9.44952894e-02,
         -2.37996632e-01,   2.30963221e-04,   9.77142459e-01,
          1.62360930e+00,   2.56885716e-01,   4.37555528e-01,
          1.96488569e-01,  -1.22277375e-04,  -2.14508858e-01,
          1.19829690e+00,  -9.73257999e-01,  -1.07472576e+00,
          7.56416430e-05,  -3.55478875e-04,   7.40239654e-02,
         -8.56414607e-03,  -1.54238009e-04]])
    ref_result_dm_beta = array([[  1.02806127e+00,  -3.46740589e-02,   7.42835401e-06,
          5.78671996e-06,  -4.49028762e-06,  -9.97218731e-02,
          1.44360992e-05,   2.78555899e-06,  -4.94010020e-06,
          4.51212050e-03,  -1.32368902e-06,  -4.61827662e-06,
         -3.95324885e-06,   2.43132431e-07,  -3.05484872e-02,
         -8.86749682e-03,  -3.05482512e-02,  -8.85390557e-03,
         -3.05352883e-02,  -8.86659357e-03],
       [ -3.46740589e-02,   1.41780055e-01,  -1.16309525e-05,
         -1.79363806e-05,   8.58305791e-06,   1.40335162e-01,
         -2.68484072e-05,  -8.35921369e-06,   9.17393241e-06,
         -9.52961170e-03,   2.53463303e-06,   8.72505701e-06,
          7.37630125e-06,  -2.69253284e-08,   5.44196636e-02,
          2.66356216e-02,   5.44134557e-02,   2.66051910e-02,
          5.43963220e-02,   2.66356003e-02],
       [  7.42835401e-06,  -1.16309525e-05,   1.86523443e-01,
          6.07823152e-06,   6.25864346e-06,  -4.24945145e-05,
          8.33270830e-02,   6.75972493e-05,   2.12164935e-05,
         -9.97187389e-06,   8.86801088e-06,  -9.23387158e-06,
          8.36711254e-03,   3.20736318e-06,   1.19757455e-01,
          1.10555941e-01,  -5.98963493e-02,  -5.52892158e-02,
         -5.98425060e-02,  -5.52281738e-02],
       [  5.78671996e-06,  -1.79363806e-05,   6.07823152e-06,
          1.86560913e-01,   2.65142739e-05,   7.04507890e-06,
         -7.89496573e-05,   8.33181647e-02,   1.32154539e-05,
          5.44859175e-06,  -1.54477627e-07,   1.32100597e-05,
          8.69920364e-06,  -8.37158991e-03,   1.73878604e-05,
          7.25472854e-05,   1.03717796e-01,   9.57033661e-02,
         -1.03683439e-01,  -9.58235486e-02],
       [ -4.49028762e-06,   8.58305791e-06,   6.25864346e-06,
          2.65142739e-05,   4.50375342e-09,   8.65147834e-06,
          2.78304134e-06,   1.18434391e-05,   3.15203040e-09,
         -5.81776911e-07,   4.30741208e-10,   2.10186999e-09,
          2.82433152e-07,  -1.18971530e-06,   7.35675469e-06,
          5.33837337e-06,   1.60669127e-05,   1.33634755e-05,
         -1.34094502e-05,  -1.38535800e-05],
       [ -9.97218731e-02,   1.40335162e-01,  -4.24945145e-05,
          7.04507890e-06,   8.65147834e-06,   1.43100170e-01,
         -4.08000284e-05,   2.78295956e-06,   9.25167989e-06,
         -9.57242719e-03,   2.55246889e-06,   8.79878662e-06,
          6.06350670e-06,  -1.15922333e-06,   5.49511958e-02,
          2.64969564e-02,   5.49885269e-02,   2.65064864e-02,
          5.49433264e-02,   2.65113606e-02],
       [  1.44360992e-05,  -2.68484072e-05,   8.33270830e-02,
         -7.89496573e-05,   2.78304134e-06,  -4.08000284e-05,
          3.72254016e-02,  -6.27332619e-06,   9.47100889e-06,
         -2.98886542e-06,   3.96135259e-06,  -4.13224995e-06,
          3.73790101e-03,   5.09755282e-06,   5.34917696e-02,
          4.93854102e-02,  -2.68117813e-02,  -2.47457585e-02,
         -2.66969340e-02,  -2.46346518e-02],
       [  2.78555899e-06,  -8.35921369e-06,   6.75972493e-05,
          8.33181647e-02,   1.18434391e-05,   2.78295956e-06,
         -6.27332619e-06,   3.72099422e-02,   5.90938349e-06,
          2.45329232e-06,  -6.59112384e-08,   5.89638330e-06,
          6.79557148e-06,  -3.73875358e-03,   4.92891083e-05,
          7.07917863e-05,   4.62994313e-02,   4.27218561e-02,
         -4.63260070e-02,  -4.28141034e-02],
       [ -4.94010020e-06,   9.17393241e-06,   2.12164935e-05,
          1.32154539e-05,   3.15203040e-09,   9.25167989e-06,
          9.47100889e-06,   5.90938349e-06,   3.95043491e-09,
         -6.23310660e-07,   1.16369549e-09,   4.56744856e-10,
          9.52848819e-07,  -5.92678813e-07,   1.71913496e-05,
          1.43109317e-05,   4.10164711e-06,   2.21871194e-06,
         -1.05856106e-05,  -1.13400799e-05],
       [  4.51212050e-03,  -9.52961170e-03,  -9.97187389e-06,
          5.44859175e-06,  -5.81776911e-07,  -9.57242719e-03,
         -2.98886542e-06,   2.45329232e-06,  -6.23310660e-07,
          6.45192215e-04,  -1.72384114e-07,  -5.90929168e-07,
         -9.83027416e-07,  -1.88148271e-07,  -3.70156274e-03,
         -1.80170166e-03,  -3.68842404e-03,  -1.78789922e-03,
         -3.69197081e-03,  -1.79431115e-03],
       [ -1.32368902e-06,   2.53463303e-06,   8.86801088e-06,
         -1.54477627e-07,   4.30741208e-10,   2.55246889e-06,
          3.96135259e-06,  -6.59112384e-08,   1.16369549e-09,
         -1.72384114e-07,   4.67563832e-10,  -2.92230512e-10,
          3.97939196e-07,   7.08229088e-09,   6.67881734e-06,
          5.73420134e-06,  -1.94875265e-06,  -2.23059652e-06,
         -1.77480746e-06,  -2.06859087e-06],
       [ -4.61827662e-06,   8.72505701e-06,  -9.23387158e-06,
          1.32100597e-05,   2.10186999e-09,   8.79878662e-06,
         -4.13224995e-06,   5.89638330e-06,   4.56744856e-10,
         -5.90929168e-07,  -2.92230512e-10,   1.93562204e-09,
         -4.13126636e-07,  -5.93002186e-07,  -2.53596439e-06,
         -3.82277096e-06,   1.37007917e-05,   1.11574442e-05,
         -9.90242344e-07,  -2.40683270e-06],
       [ -3.95324885e-06,   7.37630125e-06,   8.36711254e-03,
          8.69920364e-06,   2.82433152e-07,   6.06350670e-06,
          3.73790101e-03,   6.79557148e-06,   9.52848819e-07,
         -9.83027416e-07,   3.97939196e-07,  -4.13126636e-07,
          3.75334732e-04,  -2.34296622e-07,   5.37518083e-03,
          4.96083731e-03,  -2.67908811e-03,  -2.47436590e-03,
         -2.68604273e-03,  -2.48027784e-03],
       [  2.43132431e-07,  -2.69253284e-08,   3.20736318e-06,
         -8.37158991e-03,  -1.18971530e-06,  -1.15922333e-06,
          5.09755282e-06,  -3.73875358e-03,  -5.92678813e-07,
         -1.88148271e-07,   7.08229088e-09,  -5.93002186e-07,
         -2.34296622e-07,   3.75660312e-04,   1.12987000e-06,
         -1.34965847e-06,  -4.65559390e-03,  -4.29570713e-03,
          4.65116983e-03,   4.29872449e-03],
       [ -3.05484872e-02,   5.44196636e-02,   1.19757455e-01,
          1.73878604e-05,   7.35675469e-06,   5.49511958e-02,
          5.34917696e-02,   4.92891083e-05,   1.71913496e-05,
         -3.70156274e-03,   6.67881734e-06,  -2.53596439e-06,
          5.37518083e-03,   1.12987000e-06,   9.80756379e-02,
          8.12499844e-02,  -1.72665633e-02,  -2.52363388e-02,
         -1.72613901e-02,  -2.52063200e-02],
       [ -8.86749682e-03,   2.66356216e-02,   1.10555941e-01,
          7.25472854e-05,   5.33837337e-06,   2.64969564e-02,
          4.93854102e-02,   7.07917863e-05,   1.43109317e-05,
         -1.80170166e-03,   5.73420134e-06,  -3.82277096e-06,
          4.96083731e-03,  -1.34965847e-06,   8.12499844e-02,
          7.05405640e-02,  -2.51972717e-02,  -2.77295821e-02,
         -2.52489939e-02,  -2.77619175e-02],
       [ -3.05482512e-02,   5.44134557e-02,  -5.98963493e-02,
          1.03717796e-01,   1.60669127e-05,   5.49885269e-02,
         -2.68117813e-02,   4.62994313e-02,   4.10164711e-06,
         -3.68842404e-03,  -1.94875265e-06,   1.37007917e-05,
         -2.67908811e-03,  -4.65559390e-03,  -1.72665633e-02,
         -2.51972717e-02,   9.80770833e-02,   8.12161696e-02,
         -1.72606715e-02,  -2.52793922e-02],
       [ -8.85390557e-03,   2.66051910e-02,  -5.52892158e-02,
          9.57033661e-02,   1.33634755e-05,   2.65064864e-02,
         -2.47457585e-02,   4.27218561e-02,   2.21871194e-06,
         -1.78789922e-03,  -2.23059652e-06,   1.11574442e-05,
         -2.47436590e-03,  -4.29570713e-03,  -2.52363388e-02,
         -2.77295821e-02,   8.12161696e-02,   7.04853194e-02,
         -2.52029614e-02,  -2.77832262e-02],
       [ -3.05352883e-02,   5.43963220e-02,  -5.98425060e-02,
         -1.03683439e-01,  -1.34094502e-05,   5.49433264e-02,
         -2.66969340e-02,  -4.63260070e-02,  -1.05856106e-05,
         -3.69197081e-03,  -1.77480746e-06,  -9.90242344e-07,
         -2.68604273e-03,   4.65116983e-03,  -1.72613901e-02,
         -2.52489939e-02,  -1.72606715e-02,  -2.52029614e-02,
          9.79711882e-02,   8.12234739e-02],
       [ -8.86659357e-03,   2.66356003e-02,  -5.52281738e-02,
         -9.58235486e-02,  -1.38535800e-05,   2.65113606e-02,
         -2.46346518e-02,  -4.28141034e-02,  -1.13400799e-05,
         -1.79431115e-03,  -2.06859087e-06,  -2.40683270e-06,
         -2.48027784e-03,   4.29872449e-03,  -2.52063200e-02,
         -2.77619175e-02,  -2.52793922e-02,  -2.77832262e-02,
          8.12234739e-02,   7.05733586e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_numlda.py")

    l = {}
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], l[k], v), l[k] - l[var_name]
