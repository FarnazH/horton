# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_hf_dft_rks_water_numgga():
    ref_result_dm_alpha = array([[  9.81918461e-02,   4.70609063e-02,  -1.83776961e-02,
          4.01856054e-02,   1.25641354e-01,  -9.51359721e-02,
         -4.61986968e-06,   1.79675394e-02,   6.30045064e-02,
         -6.27635640e-02,   1.50156181e-06,  -4.92100925e-03,
          1.70024182e-06,   1.30188392e-06,  -3.75772321e-03,
         -9.10412439e-03,  -2.01971917e-02,  -1.90064763e-02],
       [  4.70609063e-02,   2.86115387e-02,   1.13863294e-02,
         -1.79816067e-02,   7.01669413e-02,  -5.61846461e-02,
         -2.03366494e-05,  -3.46142719e-02,   3.51866374e-02,
         -3.92728250e-02,  -1.37701911e-05,  -1.57019971e-03,
          1.06974528e-06,   2.01547807e-06,  -3.21745745e-03,
         -5.08375316e-03,  -1.90561493e-02,  -8.27873361e-03],
       [ -1.83776961e-02,   1.13863294e-02,   1.04147199e+00,
         -8.42621312e-02,  -7.14119004e-07,  -2.01366137e-02,
          4.26836317e-07,  -1.41427301e-01,   3.40548080e-06,
         -1.60705866e-02,  -1.06575845e-06,   3.10117181e-03,
          1.87004312e-07,   8.16497112e-07,  -3.73298202e-03,
          9.44288204e-07,  -1.83765324e-02,   1.14170135e-02],
       [  4.01856054e-02,  -1.79816067e-02,  -8.42621312e-02,
          2.48945153e-01,   2.52118743e-05,   4.20088198e-02,
         -1.84636493e-05,   2.78969677e-01,   3.13757432e-06,
          4.19321836e-02,  -1.17158177e-05,  -6.30984299e-03,
         -5.11546744e-07,  -9.96183832e-07,   8.00346339e-03,
         -4.19752180e-06,   4.01620070e-02,  -1.80628915e-02],
       [  1.25641354e-01,   7.01669413e-02,  -7.14119004e-07,
          2.52118743e-05,   2.66582151e-01,  -7.63394011e-05,
         -2.17385066e-05,  -8.10381888e-06,   1.33625283e-01,
         -1.89175241e-06,  -6.11785602e-06,  -2.87130760e-06,
          5.83066416e-06,   3.08511327e-06,  -2.08120565e-05,
         -1.93022950e-02,  -1.25569883e-01,  -7.02567667e-02],
       [ -9.51359721e-02,  -5.61846461e-02,  -2.01366137e-02,
          4.20088198e-02,  -7.63394011e-05,   3.26950213e-01,
         -1.72361437e-06,   1.32932559e-01,  -1.27279822e-04,
          2.25327111e-01,   9.49736912e-07,   1.11595040e-02,
          2.93947805e-06,  -1.76368909e-06,   1.71876902e-02,
          2.54754602e-05,  -9.50888474e-02,  -5.65512184e-02],
       [ -4.61986968e-06,  -2.03366494e-05,   4.26836317e-07,
         -1.84636493e-05,  -2.17385066e-05,  -1.72361437e-06,
          4.10471743e-01,   3.87727630e-05,   8.20635457e-06,
         -1.57400268e-05,   3.26917223e-01,  -6.99284243e-07,
         -1.67046930e-05,  -2.26147457e-02,   5.52625108e-06,
          8.08665950e-06,  -1.43764802e-05,  -5.96223029e-06],
       [  1.79675394e-02,  -3.46142719e-02,  -1.41427301e-01,
          2.78969677e-01,  -8.10381888e-06,   1.32932559e-01,
          3.87727630e-05,   3.37697459e-01,  -3.81200678e-05,
          1.05475611e-01,   3.47337941e-05,  -3.84304400e-03,
          2.33101175e-07,  -4.80608071e-06,   1.32525175e-02,
          3.37058171e-06,   1.79686793e-02,  -3.47923166e-02],
       [  6.30045064e-02,   3.51866374e-02,   3.40548080e-06,
          3.13757432e-06,   1.33625283e-01,  -1.27279822e-04,
          8.20635457e-06,  -3.81200678e-05,   6.69801891e-02,
         -6.21947506e-05,   1.21471249e-05,  -4.54041333e-06,
          2.92105655e-06,   4.94452947e-07,  -1.50644359e-05,
         -9.67535145e-03,  -6.29160439e-02,  -3.52011515e-02],
       [ -6.27635640e-02,  -3.92728250e-02,  -1.60705866e-02,
          4.19321836e-02,  -1.89175241e-06,   2.25327111e-01,
         -1.57400268e-05,   1.05475611e-01,  -6.21947506e-05,
          1.55987094e-01,  -1.07907057e-05,   7.28071029e-03,
          1.98020059e-06,  -5.07712851e-07,   1.21526926e-02,
          1.36224530e-05,  -6.27787022e-02,  -3.95530147e-02],
       [  1.50156181e-06,  -1.37701911e-05,  -1.06575845e-06,
         -1.17158177e-05,  -6.11785602e-06,   9.49736912e-07,
          3.26917223e-01,   3.47337941e-05,   1.21471249e-05,
         -1.07907057e-05,   2.60370836e-01,  -5.63618356e-07,
         -1.33040749e-05,  -1.80113490e-02,   4.58698609e-06,
          5.63001198e-06,  -1.68192474e-05,  -8.22221506e-06],
       [ -4.92100925e-03,  -1.57019971e-03,   3.10117181e-03,
         -6.30984299e-03,  -2.87130760e-06,   1.11595040e-02,
         -6.99284243e-07,  -3.84304400e-03,  -4.54041333e-06,
          7.28071029e-03,  -5.63618356e-07,   6.28513269e-04,
          1.28754013e-07,   3.16710991e-08,   4.01535631e-04,
          1.04621038e-06,  -4.91925668e-03,  -1.58207130e-03],
       [  1.70024182e-06,   1.06974528e-06,   1.87004312e-07,
         -5.11546744e-07,   5.83066416e-06,   2.93947805e-06,
         -1.67046930e-05,   2.33101175e-07,   2.92105655e-06,
          1.98020059e-06,  -1.33040749e-05,   1.28754013e-07,
          8.37027765e-10,   9.20368187e-07,   1.32686867e-07,
         -4.22245812e-07,  -3.79323565e-06,  -2.00531183e-06],
       [  1.30188392e-06,   2.01547807e-06,   8.16497112e-07,
         -9.96183832e-07,   3.08511327e-06,  -1.76368909e-06,
         -2.26147457e-02,  -4.80608071e-06,   4.94452947e-07,
         -5.07712851e-07,  -1.80113490e-02,   3.16710991e-08,
          9.20368187e-07,   1.24594871e-03,  -4.44619874e-07,
         -5.82271074e-07,   6.09241050e-08,   2.31732420e-07],
       [ -3.75772321e-03,  -3.21745745e-03,  -3.73298202e-03,
          8.00346339e-03,  -2.08120565e-05,   1.71876902e-02,
          5.52625108e-06,   1.32525175e-02,  -1.50644359e-05,
          1.21526926e-02,   4.58698609e-06,   4.01535631e-04,
          1.32686867e-07,  -4.44619874e-07,   1.04197165e-03,
          2.43792195e-06,  -3.73933642e-03,  -3.22825354e-03],
       [ -9.10412439e-03,  -5.08375316e-03,   9.44288204e-07,
         -4.19752180e-06,  -1.93022950e-02,   2.54754602e-05,
          8.08665950e-06,   3.37058171e-06,  -9.67535145e-03,
          1.36224530e-05,   5.63001198e-06,   1.04621038e-06,
         -4.22245812e-07,  -5.82271074e-07,   2.43792195e-06,
          1.39761409e-03,   9.08521361e-03,   5.08381922e-03],
       [ -2.01971917e-02,  -1.90561493e-02,  -1.83765324e-02,
          4.01620070e-02,  -1.25569883e-01,  -9.50888474e-02,
         -1.43764802e-05,   1.79686793e-02,  -6.29160439e-02,
         -6.27787022e-02,  -1.68192474e-05,  -4.91925668e-03,
         -3.79323565e-06,   6.09241050e-08,  -3.73933642e-03,
          9.08521361e-03,   9.81403722e-02,   4.72034877e-02],
       [ -1.90064763e-02,  -8.27873361e-03,   1.14170135e-02,
         -1.80628915e-02,  -7.02567667e-02,  -5.65512184e-02,
         -5.96223029e-06,  -3.47923166e-02,  -3.52011515e-02,
         -3.95530147e-02,  -8.22221506e-06,  -1.58207130e-03,
         -2.00531183e-06,   2.31732420e-07,  -3.22825354e-03,
          5.08381922e-03,   4.72034877e-02,   2.88005111e-02]])
    ref_result_energy = -76.318502264514493
    ref_result_exp_alpha = array([[  1.66991596e-04,   1.41640294e-01,  -2.43308899e-01,
         -1.37588568e-01,   3.99112379e-06,   1.16069136e-01,
          1.16020745e-01,  -8.38457087e-01,  -7.99928041e-01,
          3.70248355e-04,   3.86068110e-01,   2.23628048e-02,
         -1.71733923e-01,   2.89928787e-04,   9.48987556e-02,
          3.15299198e-04,  -8.29779565e-01,   9.58295575e-01],
       [  3.26892070e-03,   1.03919399e-03,  -1.35879701e-01,
         -1.00680093e-01,   3.22927730e-05,   9.29138464e-01,
          1.26163058e+00,   6.54832546e-01,   5.85570031e-01,
          6.95480061e-05,  -4.48006495e-03,   9.41430033e-01,
         -6.73866762e-01,   3.40345078e-04,   5.01604059e-02,
          1.06488254e-04,  -1.12308068e-01,  -1.29809291e-02],
       [  9.94909513e-01,  -2.11519185e-01,   8.75048808e-06,
         -8.29860363e-02,   7.74866969e-06,   9.32388683e-02,
          3.27699973e-04,   2.63748417e-04,  -4.37082685e-02,
          5.45406059e-05,   5.94112343e-02,  -3.76116774e-06,
          6.80774768e-02,  -1.10075979e-05,  -7.00381060e-04,
          8.52871265e-06,  -1.74722541e-02,  -2.53706806e-06],
       [  2.90597186e-02,   4.62703966e-01,  -6.34945178e-05,
          1.84406469e-01,   1.02916508e-05,  -1.72133934e-01,
         -7.68826752e-04,  -1.43629940e-03,   1.94987036e-01,
         -3.96879453e-04,  -3.53633664e-01,   2.17319033e-04,
         -1.61536744e+00,   6.90041900e-04,   1.35646142e-01,
          2.12497004e-04,  -5.61462707e-01,   2.62559616e-04],
       [  4.71762811e-07,   2.34876512e-05,  -5.16315947e-01,
         -1.00016055e-04,  -9.36667674e-07,   1.13689596e-03,
         -4.30819385e-01,   2.21203012e-01,   6.41085674e-04,
          8.71781608e-05,   2.00307632e-04,   9.76515212e-01,
          1.86827461e-06,   1.36354012e-05,  -1.90261391e-04,
          7.93144549e-05,   1.61582548e-04,   3.86174210e-02],
       [ -1.65011006e-03,  -1.30934356e-01,   3.40765887e-05,
          5.56600164e-01,  -5.16500577e-05,   2.81764050e-01,
          7.14495327e-04,   1.97674245e-03,  -5.50475906e-01,
         -1.04019617e-03,  -7.90253976e-01,   1.36036399e-04,
          1.88089681e-01,  -1.05395443e-04,  -8.16753765e-03,
          2.96631235e-05,   4.18800367e-02,  -9.49889354e-05],
       [  3.97929369e-08,  -7.96444544e-07,   4.32769274e-05,
         -6.26912125e-05,  -6.40680711e-01,   1.73157707e-05,
          3.20217312e-05,   1.64834829e-04,  -2.94503742e-04,
          9.62043277e-01,  -1.06960815e-03,  -8.42000156e-05,
         -5.47907442e-05,  -3.80828869e-05,  -1.72192101e-06,
         -6.78214312e-03,   7.15985586e-06,  -4.28383952e-05],
       [ -1.42403662e-02,   4.65040819e-01,  -3.06269813e-05,
          3.48183285e-01,  -9.49723020e-05,  -1.09841546e+00,
         -3.21014702e-03,   1.02355628e-03,  -1.79668431e-01,
          6.05079676e-05,   5.08565241e-03,  -5.02799853e-04,
          2.53744512e+00,  -1.30086859e-03,  -2.69895956e-01,
         -5.16973217e-04,   1.33619878e+00,  -5.00216113e-04],
       [ -1.42372727e-07,   5.12972677e-05,  -2.58805208e-01,
         -2.00765081e-04,  -3.02716961e-05,   2.43338581e-03,
         -7.58586735e-01,   3.98572474e-01,   1.72359923e-03,
         -2.43199090e-04,  -4.18202188e-04,  -1.69837809e+00,
         -8.50305411e-05,  -6.01341891e-06,   4.30754670e-04,
         -1.17339077e-04,  -6.10755686e-04,  -9.47118916e-01],
       [  2.56561576e-03,  -6.48047148e-02,  -7.47476506e-05,
          3.89590591e-01,  -1.35635808e-05,   4.31122590e-01,
          1.46338706e-03,  -1.26700246e-04,   1.79575352e-01,
          1.32848416e-03,   1.16335299e+00,  -5.07302459e-05,
         -6.34005438e-01,   7.21922523e-04,   1.50389652e-01,
          3.28961377e-04,  -6.78747780e-01,   2.83300437e-04],
       [ -8.33581398e-09,   3.81510901e-06,   1.27832220e-05,
         -4.46765438e-05,  -5.10265426e-01,  -3.67604514e-06,
         -4.71032259e-05,  -1.73009691e-04,   3.11505686e-04,
         -1.03655287e+00,   1.15401282e-03,   1.18211664e-04,
          4.50172502e-05,   6.71227630e-05,   1.11105480e-04,
         -3.51021705e-02,  -2.10272481e-05,   3.63879106e-05],
       [  1.94896291e-04,  -1.97849788e-02,   1.68181701e-06,
          1.53957570e-02,  -2.98257183e-07,   1.28653185e-02,
          4.57178737e-05,  -5.66648788e-04,   1.41588782e-01,
         -2.32185782e-05,  -6.80431484e-02,   1.17853381e-04,
          1.62607401e-01,  -2.30100252e-03,  -4.74466921e-01,
         -1.02090661e-03,  -9.79870859e-01,   2.31193376e-04],
       [ -5.29913628e-08,  -2.93483219e-06,  -1.12287875e-05,
          4.59375073e-06,   2.60660616e-05,   1.60008639e-05,
         -2.08027410e-05,  -2.49633043e-06,  -5.45541789e-05,
          5.59432197e-05,  -2.78686743e-05,  -3.20593334e-05,
          5.84135182e-05,   9.99989022e-01,  -4.68125889e-03,
         -1.34807511e-04,  -7.72765286e-05,   6.76894605e-05],
       [ -7.70613145e-08,  -2.70024285e-06,  -6.03923670e-06,
         -6.06237389e-07,   3.52979586e-02,   7.17027968e-06,
         -1.35411408e-05,   2.74464316e-05,  -5.54623931e-05,
          1.64625681e-02,  -2.82576543e-05,   6.36804856e-05,
          8.37072123e-05,  -1.25692975e-04,   2.32184913e-03,
         -9.99238514e-01,  -7.53152572e-05,   2.93225265e-05],
       [ -1.15311789e-04,   4.56928429e-03,   3.43216057e-05,
          3.19542738e-02,  -1.17590609e-05,   1.03886481e-02,
          1.04375264e-04,   5.48381171e-04,  -1.20745005e-01,
          2.60699990e-05,   8.97737828e-02,  -2.47311922e-04,
         -1.85309142e-01,  -4.04153960e-03,  -8.73051229e-01,
         -2.07778215e-03,   5.08620023e-01,  -3.66075267e-04],
       [ -2.65412432e-07,  -1.94318855e-05,   3.73846191e-02,
          3.89143124e-05,  -1.01004669e-05,  -2.02686646e-05,
          1.73291661e-02,   2.09903964e-01,   8.59791051e-04,
          9.17411025e-06,  -1.72216894e-04,  -3.35620138e-02,
         -2.54287547e-05,  -8.71435832e-05,  -2.64471307e-04,
          3.96548716e-05,   4.36906695e-04,   1.27369013e+00],
       [  1.67159430e-04,   1.41634701e-01,   2.43236662e-01,
         -1.37534997e-01,   5.20792575e-05,   1.16189087e-01,
         -1.14327928e-01,   8.45843586e-01,  -7.92658503e-01,
          1.13632078e-05,   3.85199840e-01,  -2.24551254e-02,
         -1.72137791e-01,   4.25723120e-04,   9.53894017e-02,
          2.99206268e-04,  -8.30412595e-01,  -9.57738286e-01],
       [  3.26881061e-03,   1.15876061e-03,   1.36092927e-01,
         -1.01327199e-01,   2.82895665e-05,   9.37263291e-01,
         -1.25653000e+00,  -6.59705366e-01,   5.79166625e-01,
          1.98319569e-04,  -3.41670532e-03,  -9.40863030e-01,
         -6.73494496e-01,   2.25651540e-04,   5.02789364e-02,
         -1.36097902e-05,  -1.12785407e-01,   1.30430547e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_numgga.py")

    l = {}
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], l[k], v), l[k] - l[var_name]
