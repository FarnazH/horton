# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_hf_dft_uks_methyl_lda():
    ref_result_dm_alpha = array([[  1.03044477e+00,  -3.95656720e-02,  -1.31317724e-06,
         -1.71927783e-06,   2.32386176e-06,  -1.12438355e-01,
         -2.09237741e-06,  -3.13480775e-06,   1.48222697e-06,
          2.14792498e-03,   4.22099528e-07,   5.08120145e-07,
          1.16666952e-06,   3.07136196e-07,  -2.92113325e-02,
         -4.75324698e-03,  -2.92096611e-02,  -4.75601745e-03,
         -2.92175548e-02,  -4.75086128e-03],
       [ -3.95656720e-02,   1.56945996e-01,   3.36167992e-06,
          4.18799841e-07,  -2.35699594e-06,   1.64057045e-01,
          4.49477943e-06,   4.50811698e-06,  -8.48391944e-07,
         -4.08260814e-03,  -7.95777951e-07,  -1.02431009e-06,
         -2.18898198e-06,  -6.25620374e-07,   5.27780740e-02,
          1.98339055e-02,   5.27723607e-02,   1.98372463e-02,
          5.27908617e-02,   1.98299533e-02],
       [ -1.31317724e-06,   3.36167992e-06,   2.06352242e-01,
         -3.81241678e-06,   1.03087012e-06,   2.99264447e-06,
          9.63989624e-02,  -5.03772149e-06,   3.91616587e-07,
          1.23254882e-06,   5.07368154e-07,   2.35383928e-06,
          9.03161151e-03,  -4.24986845e-07,   1.20081232e-01,
          1.04317141e-01,  -6.00326568e-02,  -5.21659896e-02,
         -6.00525780e-02,  -5.21514091e-02],
       [ -1.71927783e-06,   4.18799841e-07,  -3.81241678e-06,
          2.06349560e-01,  -3.18984660e-07,   1.53429060e-06,
          8.09295059e-06,   9.64025395e-02,   1.20337382e-06,
         -4.01862852e-07,   2.90049501e-06,   3.57209889e-06,
         -2.85514933e-06,  -9.02883632e-03,  -3.20446741e-06,
         -1.19151235e-05,   1.03985502e-01,   9.03490045e-02,
         -1.04015799e-01,  -9.03118410e-02],
       [  2.32386176e-06,  -2.35699594e-06,   1.03087012e-06,
         -3.18984660e-07,   3.54704987e-01,  -2.00917572e-05,
          2.68853316e-06,   7.88909284e-06,   3.17262293e-01,
         -2.03948976e-06,  -8.60132076e-07,   1.04503049e-06,
         -2.50754938e-06,   2.46316017e-06,   4.42143256e-06,
          5.18677720e-06,   1.18250873e-06,   4.63757161e-06,
          1.17288523e-05,   8.86731439e-06],
       [ -1.12438355e-01,   1.64057045e-01,   2.99264447e-06,
          1.53429060e-06,  -2.00917572e-05,   1.76441308e-01,
          4.50648114e-06,   5.31093764e-06,  -1.66345663e-05,
         -4.34550932e-03,  -8.47206265e-07,  -1.08816748e-06,
         -2.35511297e-06,  -7.07553476e-07,   5.62769949e-02,
          2.07150849e-02,   5.62719861e-02,   2.07195623e-02,
          5.62905579e-02,   2.07108459e-02],
       [ -2.09237741e-06,   4.49477943e-06,   9.63989624e-02,
          8.09295059e-06,   2.68853316e-06,   4.50648114e-06,
          4.50334824e-02,   2.25964154e-06,   2.15702975e-06,
          4.98878919e-07,   2.37139202e-07,   1.09977144e-06,
          4.21918333e-03,  -6.30567036e-07,   5.60978227e-02,
          4.87328859e-02,  -2.80387250e-02,  -2.43650317e-02,
         -2.80579840e-02,  -2.43668651e-02],
       [ -3.13480775e-06,   4.50811698e-06,  -5.03772149e-06,
          9.64025395e-02,   7.88909284e-06,   5.31093764e-06,
          2.25964154e-06,   4.50374098e-02,   7.75184837e-06,
         -3.01354606e-07,   1.35500576e-06,   1.66877387e-06,
         -1.47652972e-06,  -4.21809836e-03,  -1.92250912e-06,
         -6.66808600e-06,   4.85824406e-02,   4.22106827e-02,
         -4.85917594e-02,  -4.21905846e-02],
       [  1.48222697e-06,  -8.48391944e-07,   3.91616587e-07,
          1.20337382e-06,   3.17262293e-01,  -1.66345663e-05,
          2.15702975e-06,   7.75184837e-06,   2.83772054e-01,
         -1.85728373e-06,  -7.69323276e-07,   9.34728401e-07,
         -2.26610657e-06,   2.13800781e-06,   4.07400420e-06,
          4.53016357e-06,   2.39013187e-06,   5.09309698e-06,
          1.03228139e-05,   7.57290467e-06],
       [  2.14792498e-03,  -4.08260814e-03,   1.23254882e-06,
         -4.01862852e-07,  -2.03948976e-06,  -4.34550932e-03,
          4.98878919e-07,  -3.01354606e-07,  -1.85728373e-06,
          1.07426585e-04,   2.09461134e-08,   2.69212778e-08,
          1.15431649e-07,   3.34490999e-08,  -1.38957559e-03,
         -5.14997705e-04,  -1.39077542e-03,  -5.16258522e-04,
         -1.39086812e-03,  -5.15724375e-04],
       [  4.22099528e-07,  -7.95777951e-07,   5.07368154e-07,
          2.90049501e-06,  -8.60132076e-07,  -8.47206265e-07,
          2.37139202e-07,   1.35500576e-06,  -7.69323276e-07,
          2.09461134e-08,   4.81866899e-11,   5.87126171e-11,
          2.21868423e-08,  -1.26915617e-07,   2.41713052e-08,
          1.55831884e-07,   1.04298342e-06,   1.04114565e-06,
         -1.88090907e-06,  -1.49820952e-06],
       [  5.08120145e-07,  -1.02431009e-06,   2.35383928e-06,
          3.57209889e-06,   1.04503049e-06,  -1.08816748e-06,
          1.09977144e-06,   1.66877387e-06,   9.34728401e-07,
          2.69212778e-08,   5.87126171e-11,   9.85135143e-11,
          1.02984030e-07,  -1.56292935e-07,   1.02139623e-06,
          1.06039646e-06,   7.66972031e-07,   8.39571429e-07,
         -2.83408566e-06,  -2.28764685e-06],
       [  1.16666952e-06,  -2.18898198e-06,   9.03161151e-03,
         -2.85514933e-06,  -2.50754938e-06,  -2.35511297e-06,
          4.21918333e-03,  -1.47652972e-06,  -2.26610657e-06,
          1.15431649e-07,   2.21868423e-08,   1.02984030e-07,
          3.95295074e-04,   9.90168425e-08,   5.25491208e-03,
          4.56545089e-03,  -2.62965555e-03,  -2.28466985e-03,
         -2.62781801e-03,  -2.28167799e-03],
       [  3.07136196e-07,  -6.25620374e-07,  -4.24986845e-07,
         -9.02883632e-03,   2.46316017e-06,  -7.07553476e-07,
         -6.30567036e-07,  -4.21809836e-03,   2.13800781e-06,
          3.34490999e-08,  -1.26915617e-07,  -1.56292935e-07,
          9.90168425e-08,   3.95057250e-04,  -4.09578360e-07,
          1.45489569e-07,  -4.54992461e-03,  -3.95315276e-03,
          4.55118380e-03,   3.95167248e-03],
       [ -2.92113325e-02,   5.27780740e-02,   1.20081232e-01,
         -3.20446741e-06,   4.42143256e-06,   5.62769949e-02,
          5.60978227e-02,  -1.92250912e-06,   4.07400420e-06,
         -1.38957559e-03,   2.41713052e-08,   1.02139623e-06,
          5.25491208e-03,  -4.09578360e-07,   8.78730071e-02,
          6.73697135e-02,  -1.69410216e-02,  -2.36899959e-02,
         -1.69451812e-02,  -2.36830068e-02],
       [ -4.75324698e-03,   1.98339055e-02,   1.04317141e-01,
         -1.19151235e-05,   5.18677720e-06,   2.07150849e-02,
          4.87328859e-02,  -6.66808600e-06,   4.53016357e-06,
         -5.14997705e-04,   1.55831884e-07,   1.06039646e-06,
          4.56545089e-03,   1.45489569e-07,   6.73697135e-02,
          5.52415121e-02,  -2.36885776e-02,  -2.38689759e-02,
         -2.36861903e-02,  -2.38537353e-02],
       [ -2.92096611e-02,   5.27723607e-02,  -6.00326568e-02,
          1.03985502e-01,   1.18250873e-06,   5.62719861e-02,
         -2.80387250e-02,   4.85824406e-02,   2.39013187e-06,
         -1.39077542e-03,   1.04298342e-06,   7.66972031e-07,
         -2.62965555e-03,  -4.54992461e-03,  -1.69410216e-02,
         -2.36885776e-02,   8.78579505e-02,   6.73714750e-02,
         -1.69465597e-02,  -2.36743716e-02],
       [ -4.75601745e-03,   1.98372463e-02,  -5.21659896e-02,
          9.03490045e-02,   4.63757161e-06,   2.07195623e-02,
         -2.43650317e-02,   4.22106827e-02,   5.09309698e-06,
         -5.16258522e-04,   1.04114565e-06,   8.39571429e-07,
         -2.28466985e-03,  -3.95315276e-03,  -2.36899959e-02,
         -2.38689759e-02,   6.73714750e-02,   5.52531259e-02,
         -2.36923368e-02,  -2.38519353e-02],
       [ -2.92175548e-02,   5.27908617e-02,  -6.00525780e-02,
         -1.04015799e-01,   1.17288523e-05,   5.62905579e-02,
         -2.80579840e-02,  -4.85917594e-02,   1.03228139e-05,
         -1.39086812e-03,  -1.88090907e-06,  -2.83408566e-06,
         -2.62781801e-03,   4.55118380e-03,  -1.69451812e-02,
         -2.36861903e-02,  -1.69465597e-02,  -2.36923368e-02,
          8.79151990e-02,   6.73687738e-02],
       [ -4.75086128e-03,   1.98299533e-02,  -5.21514091e-02,
         -9.03118410e-02,   8.86731439e-06,   2.07108459e-02,
         -2.43668651e-02,  -4.21905846e-02,   7.57290467e-06,
         -5.15724375e-04,  -1.49820952e-06,  -2.28764685e-06,
         -2.28167799e-03,   3.95167248e-03,  -2.36830068e-02,
         -2.38537353e-02,  -2.36743716e-02,  -2.38519353e-02,
          6.73687738e-02,   5.52131557e-02]])
    ref_result_energy = -39.413110919531533
    ref_result_exp_alpha = array([[  9.93909013e-01,   2.06372580e-01,   3.67732998e-06,
         -5.43441555e-06,   4.60054238e-06,  -1.56647620e-01,
         -1.54956080e-05,  -8.44418663e-06,   1.29085213e-06,
         -4.57461744e-06,   9.92535870e-06,  -4.66921465e-02,
         -1.10863018e-06,  -9.19451127e-07,   3.95159654e-02,
         -4.02947673e-07,  -1.32995717e-06,   4.01371935e-02,
          4.03084323e-06,  -1.23634178e-05],
       [  4.19870158e-02,  -3.93932760e-01,  -7.51126945e-07,
          1.37855393e-05,  -5.12747937e-06,   2.62897531e-01,
          2.78220169e-05,   8.94785007e-06,   1.59978081e-06,
          1.55488269e-05,   9.79728589e-05,  -7.37365288e-01,
          3.77040603e-04,  -5.81184673e-04,  -1.92072302e+00,
          5.77222087e-06,  -1.66518388e-05,   2.76106365e-01,
          4.65674412e-05,  -5.74643164e-05],
       [ -4.26138000e-08,   7.20164372e-06,  -9.25074668e-02,
          4.44740952e-01,   9.32028677e-06,  -1.83206362e-05,
          3.11941885e-01,  -3.22660407e-01,   2.56199589e-05,
          7.33355693e-01,   4.26226339e-01,   4.74491904e-05,
         -6.22272285e-01,  -3.78211942e-01,   6.22147927e-06,
         -1.04087366e-05,  -6.13736259e-06,  -9.32880000e-07,
          5.00615225e-02,  -3.60793115e-02],
       [  1.23943784e-07,  -3.43957185e-06,  -4.44736352e-01,
         -9.25150824e-02,   9.65195283e-06,   5.57321308e-05,
         -3.22660199e-01,  -3.11924093e-01,   2.17231582e-06,
          4.26179831e-01,  -7.33444467e-01,  -3.76669055e-04,
         -3.78278561e-01,   6.22168942e-01,  -1.49389238e-04,
         -4.14221824e-06,   1.97982653e-06,   9.92609910e-07,
         -3.60739907e-02,  -5.00794228e-02],
       [ -5.02966874e-08,  -1.77443889e-06,   1.51033917e-05,
         -7.02169189e-06,   5.95571032e-01,   9.06021308e-06,
          1.48945549e-06,   2.39885804e-06,  -1.06110433e+00,
          2.81227074e-05,   8.50461641e-06,  -7.03658004e-06,
         -7.72015687e-07,  -3.79577242e-06,   2.03376236e-06,
         -3.58570963e-06,   7.60836783e-07,   1.40077903e-06,
          2.31050192e-06,  -5.09742777e-06],
       [ -2.60777786e-02,  -4.19238881e-01,  -2.90158950e-06,
          1.29123506e-05,  -3.49862642e-05,   1.85133948e+00,
          1.83817015e-04,   8.03523812e-05,  -5.05043169e-06,
         -6.27765568e-05,  -1.08931070e-04,   1.15986537e+00,
         -6.73456001e-04,   1.03860623e-03,   3.55531212e+00,
         -6.65171747e-06,   3.47404590e-05,  -7.87594234e-01,
         -1.01796903e-04,   1.85748384e-04],
       [  3.24136983e-08,  -4.05374857e-06,  -4.32368288e-02,
          2.07759602e-01,   8.06011799e-06,  -5.84683176e-05,
          8.78822762e-01,  -9.08982336e-01,  -4.54674436e-05,
         -1.50491127e+00,  -8.74650357e-01,  -5.32263114e-05,
          9.33053161e-01,   5.67092487e-01,  -2.03884473e-05,
         -4.13215687e-06,   2.73647558e-05,  -1.23177401e-04,
          4.29784040e-01,  -3.09619913e-01],
       [ -1.33722705e-08,  -1.25621242e-05,  -2.07770829e-01,
         -4.32282901e-02,   1.80055405e-05,   1.01648212e-04,
         -9.08972316e-01,  -8.78839830e-01,  -2.63290042e-06,
         -8.74584933e-01,   1.50508174e+00,   6.51407013e-04,
          5.67171813e-01,  -9.32785641e-01,   2.05431313e-04,
         -4.28001366e-06,  -2.50479647e-05,  -8.43190213e-05,
         -3.09623481e-01,  -4.29773787e-01],
       [  1.76805430e-08,  -4.77850353e-06,   1.05383928e-05,
         -8.09102627e-06,   5.32702709e-01,   1.05516665e-05,
          8.26356488e-07,   5.26471403e-06,   1.09401786e+00,
         -2.12408919e-05,  -1.53861503e-05,   2.09699443e-05,
          8.28926090e-06,  -1.10125290e-06,  -6.19778478e-06,
          1.19208888e-06,  -6.50679362e-08,  -4.32394387e-07,
         -6.35601676e-07,   1.98230565e-06],
       [  8.99498228e-06,   1.03646739e-02,   2.70068307e-07,
          2.65979911e-06,  -3.39351063e-06,   1.20909973e-02,
          1.66179013e-06,   8.33919592e-06,  -1.71078002e-06,
          2.09026859e-05,  -3.33325173e-05,   1.83299675e-01,
          8.62315302e-06,   4.11646085e-05,  -3.42855081e-02,
         -3.38754766e-06,  -2.15375016e-05,   1.05118369e+00,
          8.25696244e-05,  -2.59923456e-04],
       [  5.15176391e-09,   2.02065829e-06,  -6.47885651e-06,
         -2.06799983e-07,  -1.44404767e-06,   2.22501949e-06,
         -2.92164379e-06,   5.79198592e-06,   1.56678477e-06,
          9.85136466e-06,  -5.86015243e-06,   8.45913311e-06,
          2.57538807e-05,  -2.00803928e-06,  -3.19715123e-06,
         -8.23782421e-01,  -5.66906094e-01,  -1.58933381e-05,
          2.72963000e-05,   1.68577918e-05],
       [ -2.80279939e-08,   2.59734293e-06,  -8.75411383e-06,
          3.47164475e-06,   1.75493831e-06,   7.61169942e-07,
          3.77726517e-06,  -2.34815640e-07,  -1.52137178e-06,
          7.96852176e-06,  -5.54495386e-06,   1.28684029e-05,
          1.29153712e-05,  -1.31661844e-08,   9.92440442e-07,
          5.66906096e-01,  -8.23782421e-01,  -1.73012708e-05,
          3.30930949e-05,  -3.63934842e-06],
       [ -1.57679510e-09,   6.24555692e-06,  -4.04306713e-03,
          1.94665991e-02,  -3.87827005e-06,   5.61334291e-06,
         -1.46816859e-02,   1.51900117e-02,   5.08796411e-06,
          9.60454123e-02,   5.58120780e-02,   3.94029596e-05,
          1.76401479e-01,   1.07255154e-01,  -3.88190464e-06,
         -4.19947115e-06,   3.86026158e-05,  -2.38680376e-04,
          8.79169139e-01,  -6.33383055e-01],
       [ -9.03189129e-08,   1.68297395e-06,   1.94597298e-02,
          4.04672713e-03,   3.69002065e-06,  -4.54804835e-06,
         -1.51823839e-02,  -1.46833372e-02,  -1.84000884e-06,
         -5.58146323e-02,   9.60174541e-02,  -2.13586336e-05,
         -1.07252938e-01,   1.76417729e-01,  -4.98198553e-05,
          1.42202439e-05,   2.82166871e-05,   1.68025095e-04,
          6.33382995e-01,   8.79169450e-01],
       [ -1.53790761e-03,  -1.34132109e-01,  -5.38296056e-02,
          2.58808051e-01,   1.14404825e-05,  -1.03103076e-01,
         -8.58304384e-02,   8.87649559e-02,   1.40660963e-05,
          3.46119244e-01,   2.01261158e-01,  -6.27211236e-01,
          7.58186951e-01,   4.60844890e-01,   3.12072418e-01,
          1.31005776e-05,  -1.78638131e-05,   3.76297257e-01,
         -5.57107839e-01,   4.01301767e-01],
       [  5.54878989e-03,  -4.97491115e-02,  -4.67435455e-02,
          2.24835134e-01,   1.23972970e-05,  -9.59740838e-01,
         -1.13058435e+00,   1.16924371e+00,   1.27533973e-05,
          4.60502039e-01,   2.67621074e-01,   1.72249082e-01,
         -1.32352990e+00,  -8.04843937e-01,  -1.09940452e+00,
         -3.51828726e-06,  -2.57602602e-05,   6.33919942e-02,
         -3.98090170e-03,   2.84512063e-03],
       [ -1.53798005e-03,  -1.34132556e-01,  -1.97200893e-01,
         -1.75999616e-01,   4.51164192e-06,  -1.03101612e-01,
          1.19752986e-01,   2.99131115e-02,   5.71453431e-06,
          1.09074388e-03,  -4.00117385e-01,  -6.27069947e-01,
          2.01137776e-02,  -8.87148460e-01,   3.12266637e-01,
          7.09755647e-06,   1.58873537e-05,   3.76204497e-01,
          6.26263650e-01,   2.81702166e-01],
       [  5.54885305e-03,  -4.97705678e-02,  -1.71337954e-01,
         -1.52933253e-01,   1.01809051e-05,  -9.59991896e-01,
          1.57779488e+00,   3.94384536e-01,  -1.36254534e-05,
          1.58964184e-03,  -5.32898243e-01,   1.71764841e-01,
         -3.48777438e-02,   1.54833477e+00,  -1.09972530e+00,
         -5.03694010e-06,   7.01711058e-06,   6.33522036e-02,
          4.46540167e-03,   2.01155262e-03],
       [ -1.53782281e-03,  -1.34177098e-01,   2.51106180e-01,
         -8.27951772e-02,   1.19494779e-05,  -1.03110250e-01,
         -3.39527968e-02,  -1.18712268e-01,   9.67642907e-06,
         -3.47353884e-01,   1.99267460e-01,  -6.27306821e-01,
         -7.78158371e-01,   4.26089478e-01,   3.11823720e-01,
         -2.67967424e-05,  -5.60804974e-05,   3.76030013e-01,
         -6.89985137e-02,  -6.83322979e-01],
       [  5.54876647e-03,  -4.97499706e-02,   2.18027827e-01,
         -7.19112060e-02,   8.36407118e-06,  -9.59700371e-01,
         -4.47501517e-01,  -1.56372241e+00,  -1.55913710e-05,
         -4.61905104e-01,   2.65023575e-01,   1.72687153e-01,
          1.35883227e+00,  -7.44120644e-01,  -1.09907936e+00,
          1.42493733e-05,   1.96455324e-05,   6.33388630e-02,
         -4.79044512e-04,  -4.87353201e-03]])
    ref_result_exp_beta = array([[  9.94135117e-01,  -1.99438126e-01,  -4.87442683e-06,
         -5.60834643e-06,   5.25184854e-06,  -1.62542684e-01,
         -1.76148122e-05,  -1.10136258e-05,  -5.84913764e-06,
          1.22737921e-05,   1.22558254e-06,  -5.45744217e-02,
         -2.10414769e-06,   6.75980029e-06,   4.11035557e-02,
         -3.08350035e-07,   9.36586834e-07,   3.41718501e-02,
         -5.39009714e-06,  -1.61262714e-05],
       [  4.02168161e-02,   3.74496092e-01,   2.99498130e-06,
          1.42522533e-05,  -5.45061905e-06,   2.54193919e-01,
          2.93822637e-05,   1.32686748e-05,   1.70034631e-05,
          8.83516579e-05,  -4.77596495e-06,  -6.36676332e-01,
         -2.36167366e-04,   4.15029630e-04,  -1.95648167e+00,
          2.68984218e-06,   2.14061384e-05,   3.09069512e-01,
         -6.38829244e-05,  -1.08875936e-04],
       [ -3.26091555e-08,  -7.34878829e-06,   9.67669674e-02,
          4.21053521e-01,   7.23489266e-06,  -1.46535262e-05,
          2.98230580e-01,  -3.28453170e-01,   7.20100417e-01,
          4.24440736e-01,  -8.37384316e-05,   5.24576367e-05,
          6.50861104e-01,   3.89674721e-01,   1.69785938e-05,
         -9.90723865e-06,   3.08236729e-06,  -7.77369766e-06,
         -5.00989734e-02,  -3.43529761e-02],
       [  1.26586774e-07,   1.98880174e-06,   4.21049847e-01,
         -9.67743366e-02,   7.81470111e-06,   6.36614285e-05,
         -3.28451267e-01,  -2.98211032e-01,   4.24387083e-01,
         -7.20200918e-01,  -5.84464850e-05,  -4.09261117e-04,
          3.89746868e-01,  -6.50751586e-01,  -7.81222797e-05,
         -4.13273139e-06,  -4.12535871e-06,  -4.33329640e-06,
          3.43466775e-02,  -5.01185677e-02],
       [  1.36309433e-08,   5.10655269e-06,  -1.44476221e-05,
         -6.58225190e-06,   5.45722461e-01,   8.10314178e-06,
          2.06761658e-06,   2.25836730e-06,  -1.34078913e-04,
          3.39346235e-06,  -1.08758182e+00,  -9.76612201e-06,
          3.28278581e-06,   4.90806720e-06,   6.32044768e-06,
         -3.57793734e-06,  -8.72931145e-07,  -1.43927885e-07,
         -2.46375013e-06,  -6.16835040e-06],
       [ -2.46073875e-02,   3.77494368e-01,   3.58717074e-06,
          1.24097865e-05,  -3.47536024e-05,   1.91245532e+00,
          2.09013747e-04,   1.09508033e-04,  -5.66256490e-05,
         -1.04495068e-04,   1.01604471e-05,   1.02960323e+00,
          4.08115729e-04,  -7.29864077e-04,   3.56433799e+00,
         -2.01886528e-06,  -4.07446152e-05,  -8.02842150e-01,
          1.42586274e-04,   3.05126720e-04],
       [  2.88524795e-08,   4.77807580e-06,   4.33269181e-02,
          1.88421959e-01,   6.13658268e-06,  -5.01989198e-05,
          8.73861560e-01,  -9.62383080e-01,  -1.46708501e+00,
         -8.64715023e-01,   1.76423191e-04,  -6.09823170e-05,
         -9.54563795e-01,  -5.71491171e-01,  -3.42334543e-05,
         -1.14822596e-06,  -2.86094324e-05,  -1.85282222e-04,
         -4.37312282e-01,  -2.99736241e-01],
       [ -1.41779767e-08,   1.29677132e-05,   1.88436568e-01,
         -4.33177636e-02,   1.83046010e-05,   1.30113301e-04,
         -9.62374961e-01,  -8.73878211e-01,  -8.64643945e-01,
          1.46726921e+00,   1.18850336e-04,   6.90163713e-04,
         -5.71579896e-01,   9.54285901e-01,   9.75932310e-05,
         -9.16478097e-06,   3.15707298e-05,  -1.36205235e-04,
          2.99740350e-01,  -4.37300185e-01],
       [ -4.91314045e-09,   6.64227162e-06,  -1.09182712e-05,
         -7.85577616e-06,   5.82863753e-01,   8.64350029e-06,
          1.44111979e-06,   3.02989821e-06,   1.40664960e-04,
         -1.07326039e-05,   1.06813720e+00,   2.31230418e-05,
         -1.02101850e-05,   4.09338845e-07,  -9.31343171e-06,
          1.27782222e-06,  -2.30746249e-07,   2.92976261e-07,
          5.14588200e-07,   2.03537318e-06],
       [ -5.54586705e-04,  -2.54349837e-02,  -4.78112051e-07,
          2.20517557e-06,  -1.77763389e-06,  -7.16404346e-03,
         -1.99585270e-07,   6.88622671e-06,   2.03261603e-05,
         -3.09266527e-05,  -2.71204317e-06,   1.64512436e-01,
         -5.94474127e-06,  -4.55850186e-05,  -5.20701172e-03,
         -5.34966234e-06,   2.51951278e-05,   1.05462073e+00,
         -1.34354416e-04,  -4.14389398e-04],
       [ -1.34001184e-08,  -2.87721234e-06,   7.07002349e-06,
          2.32795052e-07,  -1.23769385e-06,   1.34025545e-06,
         -2.55712607e-06,   5.02591862e-06,   1.04732702e-05,
         -6.06172569e-06,   1.81604494e-06,   7.70704113e-06,
         -2.33320428e-05,   1.80598935e-06,  -1.35470140e-06,
         -8.64085440e-01,   5.03345159e-01,  -1.76737650e-05,
         -3.56852777e-05,   2.20043318e-05],
       [ -4.52830288e-08,  -3.32570437e-06,   9.98527884e-06,
          3.39600421e-06,   1.84626581e-06,   1.50585681e-07,
          3.25004999e-06,  -1.36963163e-06,   8.56664506e-06,
         -5.47007588e-06,  -1.42432433e-06,   1.21278524e-05,
         -1.07783338e-05,  -7.53205195e-07,   2.41581140e-06,
          5.03345161e-01,   8.64085439e-01,  -2.00541410e-05,
         -4.00547038e-05,   1.10740915e-06],
       [ -8.20275561e-10,  -6.75357405e-06,   4.34067608e-03,
          1.89134725e-02,  -4.40623157e-06,   4.99611253e-06,
         -1.20777855e-02,   1.33062654e-02,   9.77584463e-02,
          5.76094328e-02,  -9.72134668e-06,   4.02078146e-05,
         -1.70598629e-01,  -1.02176598e-01,  -5.93861212e-06,
          9.58553014e-07,  -4.41388187e-05,  -3.67060687e-04,
         -8.94786180e-01,  -6.13313561e-01],
       [ -8.87359223e-08,  -1.38286357e-06,  -1.89060842e-02,
          4.34383317e-03,   4.44677708e-06,  -4.39431423e-06,
         -1.32989073e-02,  -1.20800357e-02,  -5.76125139e-02,
          9.77289366e-02,   5.66616778e-06,  -2.31758650e-05,
          1.02175935e-01,  -1.70615631e-01,  -2.46534760e-05,
          2.06703667e-05,  -3.90631269e-05,   2.74119890e-04,
         -6.13313876e-01,   8.94786186e-01],
       [ -1.54406312e-03,   1.45112607e-01,   6.19471297e-02,
          2.69556875e-01,   1.13437050e-05,  -9.02895681e-02,
         -7.37634731e-02,   8.12254731e-02,   3.64183994e-01,
          2.14755848e-01,  -4.12779165e-05,  -6.48372537e-01,
         -7.54445442e-01,  -4.51656002e-01,   2.87439483e-01,
          9.77442156e-06,   2.36239529e-05,   3.58938275e-01,
          5.61630891e-01,   3.84863207e-01],
       [  5.23705783e-03,   7.07345784e-02,   5.73658788e-02,
          2.49715365e-01,   1.32785060e-05,  -9.76954578e-01,
         -1.10521728e+00,   1.21699997e+00,   4.14752938e-01,
          2.44438939e-01,  -5.31334782e-05,   2.12269290e-01,
          1.32386312e+00,   7.92857959e-01,  -1.07515306e+00,
         -5.35365871e-06,   2.47093073e-05,   7.40247142e-02,
          7.07199154e-03,   4.81405693e-03],
       [ -1.54413257e-03,   1.45112330e-01,   2.02449490e-01,
         -1.88400601e-01,   3.09481466e-06,  -9.02865249e-02,
          1.07191073e-01,   2.32351162e-02,   3.73425078e-03,
         -4.22492936e-01,   9.58168882e-06,  -6.48220386e-01,
         -1.41067416e-02,   8.79369223e-01,   2.87569299e-01,
          1.20493878e-05,  -2.27653179e-05,   3.58781159e-01,
         -6.14355186e-01,   2.93781143e-01],
       [  5.23711800e-03,   7.07595596e-02,   1.87572186e-01,
         -1.74573563e-01,   7.70529012e-06,  -9.77216697e-01,
          1.60646595e+00,   3.48505754e-01,   4.38750932e-03,
         -4.81708580e-01,  -1.78355627e-05,   2.11751664e-01,
          2.45561092e-02,  -1.54272411e+00,  -1.07536295e+00,
         -4.75762664e-06,  -6.50021640e-06,   7.39865141e-02,
         -7.73497244e-03,   3.68678388e-03],
       [ -1.54396959e-03,   1.45163286e-01,  -2.64473739e-01,
         -8.11388227e-02,   1.08142928e-05,  -9.02896246e-02,
         -3.34545931e-02,  -1.04490975e-01,  -3.68074343e-01,
          2.08176752e-01,   6.67538727e-05,  -6.48465430e-01,
          7.68324267e-01,  -4.27350818e-01,   2.87296391e-01,
         -3.11845305e-05,   5.61768426e-05,   3.58495884e-01,
          5.25165636e-02,  -6.79109181e-01],
       [  5.23702583e-03,   7.07379060e-02,  -2.44878360e-01,
         -7.51505161e-02,   3.60874961e-06,  -9.76874678e-01,
         -5.01575419e-01,  -1.56564684e+00,  -4.18953179e-01,
          2.36997603e-01,   3.79511791e-05,   2.12713253e-01,
         -1.34858435e+00,   7.50162478e-01,  -1.07500165e+00,
          1.36730943e-05,  -1.37284967e-05,   7.39686549e-02,
          6.44699011e-04,  -8.55614920e-03]])
    ref_result_dm_beta = array([[  1.02808020e+00,  -3.47078784e-02,  -1.39988747e-06,
         -1.78043197e-06,  -1.00477933e-06,  -9.97498501e-02,
         -2.19217708e-06,  -3.27593071e-06,  -1.32950570e-06,
          4.52137250e-03,   5.60468568e-07,   6.18187168e-07,
          1.21887310e-06,   2.55375004e-07,  -3.04778058e-02,
         -8.90250021e-03,  -3.04759360e-02,  -8.90567772e-03,
         -3.04842620e-02,  -8.89990043e-03],
       [ -3.47078784e-02,   1.41864791e-01,   3.53737574e-06,
          6.31675460e-07,   1.91278700e-06,   1.40380589e-01,
          4.60573344e-06,   4.80277737e-06,   2.48715703e-06,
         -9.54760959e-03,  -1.07801944e-06,  -1.24720653e-06,
         -2.24666065e-06,  -5.16160094e-07,   5.42860416e-02,
          2.67041600e-02,   5.42798288e-02,   2.67078607e-02,
          5.42990483e-02,   2.66998696e-02],
       [ -1.39988747e-06,   3.53737574e-06,   1.86650022e-01,
         -3.45829273e-06,  -4.16957303e-06,   2.79898139e-06,
          8.35283818e-02,  -4.66170234e-06,  -4.36428013e-06,
          1.06916561e-06,   7.82182493e-07,   2.39617000e-06,
          8.38362259e-03,  -4.98171394e-07,   1.19491263e-01,
          1.10694118e-01,  -5.97373907e-02,  -5.53545328e-02,
         -5.97571865e-02,  -5.53390365e-02],
       [ -1.78043197e-06,   6.31675460e-07,  -3.45829273e-06,
          1.86648355e-01,  -5.44616930e-06,   1.05707792e-06,
          8.38212350e-06,   8.35332741e-02,  -3.83688679e-06,
         -4.65369475e-07,   2.95429896e-06,   3.87564619e-06,
         -2.69776647e-06,  -8.38077973e-03,  -3.06984208e-06,
         -1.20029405e-05,   1.03473978e-01,   9.58716066e-02,
         -1.03504203e-01,  -9.58331974e-02],
       [ -1.00477933e-06,   1.91278700e-06,  -4.16957303e-06,
         -5.44616930e-06,   2.78136825e-10,   1.92721750e-06,
         -1.86618826e-06,  -2.43726691e-06,   2.43370626e-10,
         -1.29899684e-07,  -1.18370071e-10,  -1.83600307e-10,
         -1.87240279e-07,   2.44548830e-07,  -1.92827989e-06,
         -2.11121032e-06,  -9.43814646e-07,  -1.19947781e-06,
          5.09635330e-06,   4.39386549e-06],
       [ -9.97498501e-02,   1.40380589e-01,   2.79898139e-06,
          1.05707792e-06,   1.92721750e-06,   1.43107553e-01,
          4.29668442e-06,   5.03397845e-06,   2.50739843e-06,
         -9.58791857e-03,  -1.08577354e-06,  -1.25424262e-06,
         -2.29913319e-06,  -5.33753368e-07,   5.48207533e-02,
          2.65763233e-02,   5.48154712e-02,   2.65809538e-02,
          5.48343588e-02,   2.65724645e-02],
       [ -2.19217708e-06,   4.60573344e-06,   8.35283818e-02,
          8.38212350e-06,  -1.86618826e-06,   4.29668442e-06,
          3.73800689e-02,   2.35792177e-06,  -1.95322430e-06,
          2.73241913e-07,   3.50171090e-07,   1.07249749e-06,
          3.75178308e-03,  -6.68809127e-07,   5.34751093e-02,
          4.95376688e-02,  -2.67266063e-02,  -2.47662226e-02,
         -2.67464760e-02,  -2.47694867e-02],
       [ -3.27593071e-06,   4.80277737e-06,  -4.66170234e-06,
          8.35332741e-02,  -2.43726691e-06,   5.03397845e-06,
          2.35792177e-06,   3.73847813e-02,  -1.71702104e-06,
         -5.15443073e-07,   1.32212976e-06,   1.73444046e-06,
         -1.34731338e-06,  -3.75076423e-03,  -1.61464883e-06,
         -6.36461954e-06,   4.63118643e-02,   4.29085004e-02,
         -4.63198918e-02,  -4.28877557e-02],
       [ -1.32950570e-06,   2.48715703e-06,  -4.36428013e-06,
         -3.83688679e-06,   2.43370626e-10,   2.50739843e-06,
         -1.95322430e-06,  -1.71702104e-06,   2.25041435e-10,
         -1.68955054e-07,  -9.81322677e-11,  -1.57790140e-10,
         -1.96017581e-07,   1.72288426e-07,  -1.83005123e-06,
         -2.11823191e-06,   2.33515131e-07,  -2.06575905e-07,
          4.48922305e-06,   3.73384559e-06],
       [  4.52137250e-03,  -9.54760959e-03,   1.06916561e-06,
         -4.65369475e-07,  -1.29899684e-07,  -9.58791857e-03,
          2.73241913e-07,  -5.15443073e-07,  -1.68955054e-07,
          6.47246150e-04,   7.31864211e-08,   8.46170811e-08,
          2.11409699e-07,   5.38405175e-08,  -3.68951570e-03,
         -1.80151298e-03,  -3.69058566e-03,  -1.80314630e-03,
         -3.69142203e-03,  -1.80216948e-03],
       [  5.60468568e-07,  -1.07801944e-06,   7.82182493e-07,
          2.95429896e-06,  -1.18370071e-10,  -1.08577354e-06,
          3.50171090e-07,   1.32212976e-06,  -9.81322677e-11,
          7.31864211e-08,   5.83179354e-11,   8.09560229e-11,
          3.51109588e-08,  -1.32651291e-07,   8.32183117e-08,
          2.60120322e-07,   9.69966503e-07,   1.08183989e-06,
         -2.30636807e-06,  -1.95238685e-06],
       [  6.18187168e-07,  -1.24720653e-06,   2.39617000e-06,
          3.87564619e-06,  -1.83600307e-10,  -1.25424262e-06,
          1.07249749e-06,   1.73444046e-06,  -1.57790140e-10,
          8.46170811e-08,   8.09560229e-11,   1.22300905e-10,
          1.07595586e-07,  -1.74026175e-07,   1.05144393e-06,
          1.18536890e-06,   8.99173096e-07,   1.04454379e-06,
         -3.39909046e-06,  -2.93587812e-06],
       [  1.21887310e-06,  -2.24666065e-06,   8.38362259e-03,
         -2.69776647e-06,  -1.87240279e-07,  -2.29913319e-06,
          3.75178308e-03,  -1.34731338e-06,  -1.96017581e-07,
          2.11409699e-07,   3.51109588e-08,   1.07595586e-07,
          3.76561124e-04,   9.17912036e-08,   5.36616958e-03,
          4.97151252e-03,  -2.68552227e-03,  -2.48807949e-03,
         -2.68359241e-03,  -2.48477202e-03],
       [  2.55375004e-07,  -5.16160094e-07,  -4.98171394e-07,
         -8.38077973e-03,   2.44548830e-07,  -5.33753368e-07,
         -6.68809127e-07,  -3.75076423e-03,   1.72288426e-07,
          5.38405175e-08,  -1.32651291e-07,  -1.74026175e-07,
          9.17912036e-08,   3.76309075e-04,  -4.68087478e-07,
          5.94718934e-08,  -4.64610896e-03,  -4.30467129e-03,
          4.64750921e-03,   4.30315029e-03],
       [ -3.04778058e-02,   5.42860416e-02,   1.19491263e-01,
         -3.06984208e-06,  -1.92827989e-06,   5.48207533e-02,
          5.34751093e-02,  -1.61464883e-06,  -1.83005123e-06,
         -3.68951570e-03,   8.32183117e-08,   1.05144393e-06,
          5.36616958e-03,  -4.68087478e-07,   9.75583871e-02,
          8.11224895e-02,  -1.71834975e-02,  -2.51779168e-02,
         -1.71875075e-02,  -2.51699630e-02],
       [ -8.90250021e-03,   2.67041600e-02,   1.10694118e-01,
         -1.20029405e-05,  -2.11121032e-06,   2.65763233e-02,
          4.95376688e-02,  -6.36461954e-06,  -2.11823191e-06,
         -1.80151298e-03,   2.60120322e-07,   1.18536890e-06,
          4.97151252e-03,   5.94718934e-08,   8.11224895e-02,
          7.06793481e-02,  -2.51764482e-02,  -2.78008603e-02,
         -2.51733902e-02,  -2.77828356e-02],
       [ -3.04759360e-02,   5.42798288e-02,  -5.97373907e-02,
          1.03473978e-01,  -9.43814646e-07,   5.48154712e-02,
         -2.67266063e-02,   4.63118643e-02,   2.33515131e-07,
         -3.69058566e-03,   9.69966503e-07,   8.99173096e-07,
         -2.68552227e-03,  -4.64610896e-03,  -1.71834975e-02,
         -2.51764482e-02,   9.75405334e-02,   8.11236070e-02,
         -1.71886016e-02,  -2.51602298e-02],
       [ -8.90567772e-03,   2.67078607e-02,  -5.53545328e-02,
          9.58716066e-02,  -1.19947781e-06,   2.65809538e-02,
         -2.47662226e-02,   4.29085004e-02,  -2.06575905e-07,
         -1.80314630e-03,   1.08183989e-06,   1.04454379e-06,
         -2.48807949e-03,  -4.30467129e-03,  -2.51779168e-02,
         -2.78008603e-02,   8.11236070e-02,   7.06935296e-02,
         -2.51796087e-02,  -2.77802431e-02],
       [ -3.04842620e-02,   5.42990483e-02,  -5.97571865e-02,
         -1.03504203e-01,   5.09635330e-06,   5.48343588e-02,
         -2.67464760e-02,  -4.63198918e-02,   4.48922305e-06,
         -3.69142203e-03,  -2.30636807e-06,  -3.39909046e-06,
         -2.68359241e-03,   4.64750921e-03,  -1.71875075e-02,
         -2.51733902e-02,  -1.71886016e-02,  -2.51796087e-02,
          9.76046089e-02,   8.11219325e-02],
       [ -8.89990043e-03,   2.66998696e-02,  -5.53390365e-02,
         -9.58331974e-02,   4.39386549e-06,   2.65724645e-02,
         -2.47694867e-02,  -4.28877557e-02,   3.73384559e-06,
         -1.80216948e-03,  -1.95238685e-06,  -2.93587812e-06,
         -2.48477202e-03,   4.30315029e-03,  -2.51699630e-02,
         -2.77828356e-02,  -2.51602298e-02,  -2.77802431e-02,
          8.11219325e-02,   7.06442219e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_lda.py")

    l = {}
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], l[k], v), l[k] - l[var_name]
