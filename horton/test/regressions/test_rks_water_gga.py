# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_rks_water_gga():
    ref_result_dm_alpha = array([[  9.81972086e-02,   4.71954171e-02,  -1.83802034e-02,
          4.01859833e-02,   1.25608506e-01,  -9.51450515e-02,
          1.08407138e-06,   1.79621966e-02,   6.29228842e-02,
         -6.27810908e-02,   5.85597844e-07,  -4.91096246e-03,
         -6.86847711e-07,   4.94914253e-07,  -3.75835928e-03,
         -9.07114189e-03,  -2.01891023e-02,  -1.91001185e-02],
       [  4.71954171e-02,   2.87634708e-02,   1.13926747e-02,
         -1.80025977e-02,   7.03394154e-02,  -5.63374645e-02,
          3.05368767e-06,  -3.46744515e-02,   3.52363254e-02,
         -3.93882370e-02,   2.31227203e-06,  -1.57278821e-03,
         -3.61790862e-07,   7.69481420e-08,  -3.22397768e-03,
         -5.07984812e-03,  -1.90996087e-02,  -8.36111687e-03],
       [ -1.83802034e-02,   1.13926747e-02,   1.04147174e+00,
         -8.42680793e-02,  -2.56316435e-07,  -2.01343049e-02,
         -1.36696633e-07,  -1.41407143e-01,   5.07931386e-07,
         -1.60756024e-02,  -8.29429122e-08,   3.09319993e-03,
          4.37698966e-08,  -1.56479411e-07,  -3.72892454e-03,
         -2.72766433e-07,  -1.83799022e-02,   1.13936352e-02],
       [  4.01859833e-02,  -1.80025977e-02,  -8.42680793e-02,
          2.48952398e-01,  -2.88258704e-07,   4.19858356e-02,
          3.74930498e-06,   2.78942095e-01,  -1.45538650e-06,
          4.19375153e-02,   2.82969458e-06,  -6.29302516e-03,
         -1.12998204e-07,   1.40258379e-07,   7.99407845e-03,
          6.35400610e-07,   4.01861095e-02,  -1.80042165e-02],
       [  1.25608506e-01,   7.03394154e-02,  -2.56316435e-07,
         -2.88258704e-07,   2.66542662e-01,   3.06068751e-07,
         -1.18882919e-07,   3.84697725e-06,   1.33521852e-01,
         -1.38667266e-06,  -1.63110267e-09,  -5.48104683e-07,
         -1.16904877e-06,   5.79192317e-07,   1.03153932e-06,
         -1.92495793e-02,  -1.25607720e-01,  -7.03448874e-02],
       [ -9.51450515e-02,  -5.63374645e-02,  -2.01343049e-02,
          4.19858356e-02,   3.06068751e-07,   3.26980680e-01,
         -1.41295908e-06,   1.32934171e-01,  -2.53455954e-06,
          2.25321644e-01,  -2.21135331e-07,   1.11388038e-02,
          3.50080292e-07,  -5.80535898e-07,   1.72111351e-02,
         -3.65626489e-07,  -9.51441697e-02,  -5.63453770e-02],
       [  1.08407138e-06,   3.05368767e-06,  -1.36696633e-07,
          3.74930498e-06,  -1.18882919e-07,  -1.41295908e-06,
          4.10556811e-01,  -6.05556499e-06,  -9.40258924e-07,
          2.07424727e-06,   3.26904913e-01,  -6.80136627e-07,
         -3.33614223e-07,  -2.26246536e-02,  -5.68128015e-07,
          6.08524705e-07,   1.52224601e-06,  -4.14511370e-07],
       [  1.79621966e-02,  -3.46744515e-02,  -1.41407143e-01,
          2.78942095e-01,   3.84697725e-06,   1.32934171e-01,
         -6.05556499e-06,   3.37640228e-01,  -2.10683856e-07,
          1.05490731e-01,  -4.74598631e-06,  -3.82875932e-03,
         -2.80636102e-08,   5.32573438e-07,   1.32488365e-02,
          2.94816920e-07,   1.79587271e-02,  -3.46804709e-02],
       [  6.29228842e-02,   3.52363254e-02,   5.07931386e-07,
         -1.45538650e-06,   1.33521852e-01,  -2.53455954e-06,
         -9.40258924e-07,  -2.10683856e-07,   6.68864214e-02,
         -2.59811789e-06,  -7.02083343e-07,  -3.35331360e-07,
         -5.85624695e-07,   3.38677491e-07,   3.52216861e-07,
         -9.64288210e-03,  -6.29213438e-02,  -3.52380535e-02],
       [ -6.27810908e-02,  -3.93882370e-02,  -1.60756024e-02,
          4.19375153e-02,  -1.38667266e-06,   2.25321644e-01,
          2.07424727e-06,   1.05490731e-01,  -2.59811789e-06,
          1.55967664e-01,   2.25997947e-06,   7.26586790e-03,
          2.32836621e-07,  -5.45103481e-07,   1.21674451e-02,
         -1.01595260e-07,  -6.27789932e-02,  -3.93928875e-02],
       [  5.85597844e-07,   2.31227203e-06,  -8.29429122e-08,
          2.82969458e-06,  -1.63110267e-09,  -2.21135331e-07,
          3.26904913e-01,  -4.74598631e-06,  -7.02083343e-07,
          2.25997947e-06,   2.60297283e-01,  -5.02158555e-07,
         -2.65638819e-07,  -1.80148283e-02,  -4.11237116e-07,
          4.77816189e-07,   8.46817050e-07,  -4.98395872e-07],
       [ -4.91096246e-03,  -1.57278821e-03,   3.09319993e-03,
         -6.29302516e-03,  -5.48104683e-07,   1.11388038e-02,
         -6.80136627e-07,  -3.82875932e-03,  -3.35331360e-07,
          7.26586790e-03,  -5.02158555e-07,   6.25751013e-04,
          1.69516980e-08,   1.30004653e-09,   4.02039266e-04,
          6.88629252e-09,  -4.91039660e-03,  -1.57273825e-03],
       [ -6.86847711e-07,  -3.61790862e-07,   4.37698966e-08,
         -1.12998204e-07,  -1.16904877e-06,   3.50080292e-07,
         -3.33614223e-07,  -2.80636102e-08,  -5.85624695e-07,
          2.32836621e-07,  -2.65638819e-07,   1.69516980e-08,
          5.87589973e-12,   1.83810628e-08,   1.46631143e-08,
          8.44268406e-08,   4.14980910e-07,   2.55241688e-07],
       [  4.94914253e-07,   7.69481420e-08,  -1.56479411e-07,
          1.40258379e-07,   5.79192317e-07,  -5.80535898e-07,
         -2.26246536e-02,   5.32573438e-07,   3.38677491e-07,
         -5.45103481e-07,  -1.80148283e-02,   1.30004653e-09,
          1.83810628e-08,   1.24678227e-03,   6.94257530e-09,
         -7.48881049e-08,  -6.89488705e-08,  -3.41612983e-08],
       [ -3.75835928e-03,  -3.22397768e-03,  -3.72892454e-03,
          7.99407845e-03,   1.03153932e-06,   1.72111351e-02,
         -5.68128015e-07,   1.32488365e-02,   3.52216861e-07,
          1.21674451e-02,  -4.11237116e-07,   4.02039266e-04,
          1.46631143e-08,   6.94257530e-09,   1.04382043e-03,
         -7.68714192e-08,  -3.75927695e-03,  -3.22494860e-03],
       [ -9.07114189e-03,  -5.07984812e-03,  -2.72766433e-07,
          6.35400610e-07,  -1.92495793e-02,  -3.65626489e-07,
          6.08524705e-07,   2.94816920e-07,  -9.64288210e-03,
         -1.01595260e-07,   4.77816189e-07,   6.88629252e-09,
          8.44268406e-08,  -7.48881049e-08,  -7.68714192e-08,
          1.39019510e-03,   9.07156970e-03,   5.08030267e-03],
       [ -2.01891023e-02,  -1.90996087e-02,  -1.83799022e-02,
          4.01861095e-02,  -1.25607720e-01,  -9.51441697e-02,
          1.52224601e-06,   1.79587271e-02,  -6.29213438e-02,
         -6.27789932e-02,   8.46817050e-07,  -4.91039660e-03,
          4.14980910e-07,  -6.89488705e-08,  -3.75927695e-03,
          9.07156970e-03,   9.81956592e-02,   4.71996878e-02],
       [ -1.91001185e-02,  -8.36111687e-03,   1.13936352e-02,
         -1.80042165e-02,  -7.03448874e-02,  -5.63453770e-02,
         -4.14511370e-07,  -3.46804709e-02,  -3.52380535e-02,
         -3.93928875e-02,  -4.98395872e-07,  -1.57273825e-03,
          2.55241688e-07,  -3.41612983e-08,  -3.22494860e-03,
          5.08030267e-03,   4.71996878e-02,   2.87690994e-02]])
    ref_result_energy = -76.319086256846447
    ref_result_exp_alpha = array([[  1.67073245e-04,   1.41664919e-01,  -2.43295351e-01,
         -1.37606748e-01,  -5.69299829e-06,   1.16191510e-01,
          1.14703038e-01,   8.42159370e-01,   7.95763712e-01,
         -5.29912308e-05,  -3.86593514e-01,  -2.30300850e-02,
          1.72272261e-01,  -5.01404489e-05,  -9.52000991e-02,
         -9.33469045e-06,  -8.30085239e-01,   9.58038467e-01],
       [  3.26821468e-03,   1.10979082e-03,  -1.36242854e-01,
         -1.00942865e-01,  -7.67896713e-06,   9.32966644e-01,
          1.25955716e+00,  -6.57535520e-01,  -5.82734862e-01,
          4.77153531e-05,   4.55924982e-03,  -9.40470056e-01,
          6.73486058e-01,  -2.49510250e-05,  -5.02620566e-02,
         -3.81229754e-05,  -1.12422849e-01,  -1.27873606e-02],
       [  9.94910764e-01,  -2.11516414e-01,   4.66328093e-07,
         -8.29766233e-02,  -2.07063374e-06,   9.32491522e-02,
          1.64647719e-05,  -6.52822160e-06,   4.36547317e-02,
          1.70927070e-08,  -5.94418583e-02,   1.97151419e-06,
         -6.80683169e-02,  -1.22763980e-07,   7.04826486e-04,
          2.54888551e-06,  -1.74947165e-02,   1.27409450e-06],
       [  2.90524784e-02,   4.62726064e-01,   5.41855920e-07,
          1.84371712e-01,  -6.53731325e-07,  -1.72170296e-01,
         -4.43774974e-05,   3.20287732e-05,  -1.95234518e-01,
         -3.26918251e-05,   3.53588280e-01,   1.36623888e-05,
          1.61541777e+00,  -1.01258436e-04,  -1.35777690e-01,
         -7.63356982e-05,  -5.61214113e-01,   3.26189114e-05],
       [ -1.50966642e-08,   1.12566029e-06,  -5.16277658e-01,
         -2.85117557e-06,  -9.22649455e-08,   5.88054370e-05,
         -4.30728672e-01,  -2.22183017e-01,   1.02933022e-05,
          7.77174843e-06,  -4.41062712e-05,  -9.76355449e-01,
          1.33230059e-05,   2.24767569e-05,  -1.58761253e-05,
         -3.58253267e-06,  -7.87857942e-06,   3.85784652e-02],
       [ -1.65304429e-03,  -1.30945712e-01,  -3.94684925e-06,
          5.56624758e-01,   1.78706870e-05,   2.81700023e-01,
          4.97677630e-05,  -2.92263235e-05,   5.51456406e-01,
         -1.11799890e-04,   7.89661283e-01,  -3.08881499e-05,
         -1.87761164e-01,   9.47027346e-06,   8.19925454e-03,
          1.14599121e-05,   4.17623370e-02,   7.87821697e-07],
       [  3.52396881e-08,   1.03906329e-08,   3.44644773e-07,
          1.80351097e-05,  -6.40747051e-01,  -2.48820626e-07,
         -3.02190161e-06,   2.02312708e-05,  -1.10157768e-04,
         -9.61999242e-01,  -6.22711779e-05,  -1.09587034e-05,
         -1.97272682e-05,  -1.58320396e-06,   1.30347286e-05,
         -6.85359588e-03,   2.88103654e-06,   1.64582881e-06],
       [ -1.42366027e-02,   4.64990652e-01,  -8.36749017e-06,
          3.48168472e-01,   1.92556476e-05,  -1.09844268e+00,
         -1.55466788e-04,  -7.92953327e-06,   1.80841734e-01,
          3.23913701e-05,  -4.97032818e-03,  -4.26284983e-05,
         -2.53750947e+00,   2.08091363e-04,   2.70104332e-01,
          1.27628801e-04,   1.33588069e+00,  -7.95188589e-05],
       [  3.55121781e-08,  -2.70960039e-07,  -2.58624064e-01,
         -6.45665565e-06,   1.32811980e-06,   1.34452675e-04,
         -7.58508644e-01,  -3.97429579e-01,  -6.39189023e-05,
         -2.79469393e-05,   9.42589897e-05,   1.69861220e+00,
         -3.41714859e-05,  -5.81452777e-05,   2.57784892e-05,
          3.61407058e-06,  -4.32127546e-05,  -9.47296477e-01],
       [  2.56641102e-03,  -6.47542501e-02,   3.98584760e-07,
          3.89574078e-01,   7.72797800e-06,   4.31179456e-01,
          6.42652337e-05,  -1.63543563e-05,  -1.81252490e-01,
          8.13636703e-05,  -1.16321819e+00,   6.86003618e-05,
          6.33816356e-01,  -1.20405033e-04,  -1.50494708e-01,
         -4.74792942e-05,  -6.78667888e-01,   3.73560041e-05],
       [ -1.87125099e-08,  -8.88786777e-07,   9.42267004e-08,
          1.57729167e-05,  -5.10193400e-01,   6.79246433e-07,
          1.60080735e-06,  -2.02879562e-05,   1.18380182e-04,
          1.03659111e+00,   6.85297998e-05,   1.21938883e-05,
          1.54842236e-05,   8.22659903e-07,  -4.67661116e-06,
         -3.50409269e-02,  -3.08819032e-06,  -2.36287457e-06],
       [  1.95000675e-04,  -1.97358842e-02,   9.34112743e-07,
          1.53690591e-02,   1.49295651e-06,   1.28192668e-02,
          2.02177518e-06,   1.33578035e-05,  -1.41548660e-01,
          1.71904210e-05,   6.82163141e-02,  -7.95119263e-06,
         -1.62490302e-01,   3.16367370e-04,   4.74456914e-01,
          1.00900942e-04,  -9.79894273e-01,   5.97766232e-05],
       [ -8.49342801e-09,  -4.51879161e-07,   2.26380535e-06,
          5.22605596e-07,   5.20664234e-07,   3.14665500e-07,
          3.80290322e-06,  -4.11748688e-06,   2.57172205e-06,
         -1.74784696e-06,  -6.01529952e-06,   2.00103111e-05,
          2.18002493e-06,   9.99999761e-01,  -6.89760488e-04,
         -3.57063968e-05,  -1.22538036e-05,  -2.74541309e-05],
       [ -6.16088971e-09,   1.11583043e-06,  -1.12815469e-06,
         -1.91344362e-06,   3.53098162e-02,  -4.90382145e-07,
          6.95712601e-07,   2.57711234e-06,   3.17521478e-07,
         -1.63994496e-02,   2.72262056e-06,   3.28236792e-06,
         -3.76773691e-05,  -3.56055847e-05,   1.75226885e-04,
         -9.99241833e-01,  -1.19624534e-05,   1.28551865e-06],
       [ -1.15440138e-04,   4.53789093e-03,  -2.16466764e-06,
          3.19877381e-02,   1.78712090e-06,   1.03973749e-02,
         -1.20697921e-06,  -1.42225497e-05,   1.20629996e-01,
         -2.78055990e-08,  -8.99690440e-02,  -5.96491995e-06,
          1.85340060e-01,   6.07166802e-04,   8.73061575e-01,
          1.39796557e-04,   5.08602204e-01,  -2.51716970e-05],
       [ -8.80054214e-09,   1.35888971e-06,   3.72853254e-02,
         -7.21381980e-08,  -9.29655389e-07,  -7.20327087e-06,
          1.72513007e-02,  -2.09830951e-01,  -1.99720951e-05,
         -2.04667859e-06,   4.18435496e-06,   3.38004623e-02,
         -4.72837623e-07,   3.32745587e-05,  -6.48120556e-06,
          1.17593607e-06,   7.46408623e-05,   1.27370023e+00],
       [  1.67078409e-04,   1.41662813e-01,   2.43295974e-01,
         -1.37602212e-01,  -6.11502495e-06,   1.16206643e-01,
         -1.14641960e-01,  -8.42306646e-01,   7.95633322e-01,
         -9.09842804e-05,  -3.86546748e-01,   2.31281891e-02,
          1.72274022e-01,  -1.10826788e-04,  -9.51926785e-02,
         -1.60879005e-05,  -8.30199784e-01,  -9.57941229e-01],
       [  3.26825574e-03,   1.11077156e-03,   1.36254580e-01,
         -1.00954921e-01,  -2.12007077e-06,   9.33405606e-01,
         -1.25928299e+00,   6.57608162e-01,  -5.82642033e-01,
          5.82310636e-05,   4.61413619e-03,   9.40449046e-01,
          6.73428829e-01,  -4.74926600e-05,  -5.02389220e-02,
         -3.05503643e-05,  -1.12406929e-01,   1.28012322e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_gga.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]