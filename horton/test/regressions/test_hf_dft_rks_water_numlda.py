# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_hf_dft_rks_water_numlda():
    ref_result_dm_alpha = array([[  9.13790311e-02,   4.60733276e-02,  -1.85243718e-02,
          3.96506477e-02,   1.22194256e-01,  -9.13219644e-02,
          6.07890046e-07,   1.98677313e-02,   6.18738341e-02,
         -6.06960196e-02,  -5.46449679e-06,  -4.87280027e-03,
          6.95317274e-06,   2.09812571e-06,  -3.63944131e-03,
         -8.91746566e-03,  -1.89435015e-02,  -1.91643480e-02],
       [  4.60733276e-02,   2.89920583e-02,   1.09595984e-02,
         -1.54626743e-02,   7.22258200e-02,  -5.55395937e-02,
         -9.73527445e-06,  -3.20426857e-02,   3.65696078e-02,
         -3.92155138e-02,  -1.11324023e-05,  -1.60987563e-03,
          4.57758584e-06,   2.72284646e-06,  -3.23621898e-03,
         -5.27000050e-03,  -1.91351461e-02,  -9.57164847e-03],
       [ -1.85243718e-02,   1.09595984e-02,   1.04053713e+00,
         -7.85988883e-02,   5.01406117e-06,  -1.96974843e-02,
         -3.38252512e-06,  -1.45179891e-01,  -7.19408044e-06,
         -1.61066960e-02,  -3.04267127e-06,   3.30371685e-03,
          1.10867768e-06,   2.61969943e-06,  -3.90861311e-03,
          2.33472522e-06,  -1.85271015e-02,   1.09367671e-02],
       [  3.96506477e-02,  -1.54626743e-02,  -7.85988883e-02,
          2.40355622e-01,  -1.47173592e-05,   3.92423537e-02,
         -2.81289743e-05,   2.75389237e-01,   1.28017434e-05,
          4.11727719e-02,  -1.96741186e-05,  -6.62965507e-03,
         -2.35012778e-06,  -4.05723942e-06,   8.16530562e-03,
         -4.28480170e-06,   3.96597258e-02,  -1.54118121e-02],
       [  1.22194256e-01,   7.22258200e-02,   5.01406117e-06,
         -1.47173592e-05,   2.70690148e-01,   1.55516777e-05,
         -2.42180804e-05,  -3.48779084e-05,   1.37099004e-01,
          1.77846156e-05,  -4.36294236e-06,   3.94330675e-07,
          2.00426668e-05,   7.99777023e-06,   1.79980851e-06,
         -1.97522107e-02,  -1.22213608e-01,  -7.21472553e-02],
       [ -9.13219644e-02,  -5.55395937e-02,  -1.96974843e-02,
          3.92423537e-02,   1.55516777e-05,   3.29375070e-01,
         -6.40080779e-05,   1.30672100e-01,   7.19580174e-05,
          2.29560155e-01,  -7.22428250e-06,   1.13622291e-02,
          5.24258201e-06,   2.44348541e-06,   1.78248909e-02,
         -1.73986136e-06,  -9.13635567e-02,  -5.53022627e-02],
       [  6.07890046e-07,  -9.73527445e-06,  -3.38252512e-06,
         -2.81289743e-05,  -2.42180804e-05,  -6.40080779e-05,
          4.08003747e-01,   1.12439009e-04,  -3.51813533e-05,
         -2.27549836e-05,   3.27242014e-01,   5.32760913e-06,
          1.30251456e-06,  -2.29633555e-02,   1.31458642e-05,
          1.40861080e-05,   1.06333786e-05,  -1.33529819e-04],
       [  1.98677313e-02,  -3.20426857e-02,  -1.45179891e-01,
          2.75389237e-01,  -3.48779084e-05,   1.30672100e-01,
          1.12439009e-04,   3.41075241e-01,   2.17582035e-05,
          1.06201197e-01,   1.04989776e-04,  -4.36694913e-03,
         -1.22488745e-06,  -1.28850587e-05,   1.37787248e-02,
         -3.56844247e-06,   1.98872731e-02,  -3.19114804e-02],
       [  6.18738341e-02,   3.65696078e-02,  -7.19408044e-06,
          1.28017434e-05,   1.37099004e-01,   7.19580174e-05,
         -3.51813533e-05,   2.17582035e-05,   6.94378456e-02,
          5.44046806e-05,  -2.05807257e-05,   1.97987892e-06,
          1.01519857e-05,   5.33991432e-06,   4.70364599e-06,
         -1.00040904e-02,  -6.19137368e-02,  -3.65523351e-02],
       [ -6.06960196e-02,  -3.92155138e-02,  -1.61066960e-02,
          4.11727719e-02,   1.77846156e-05,   2.29560155e-01,
         -2.27549836e-05,   1.06201197e-01,   5.44046806e-05,
          1.60808493e-01,   1.23593194e-05,   7.45364958e-03,
          3.48099397e-06,   1.51588445e-07,   1.27756840e-02,
         -2.02683321e-06,  -6.07313343e-02,  -3.90530124e-02],
       [ -5.46449679e-06,  -1.11324023e-05,  -3.04267127e-06,
         -1.96741186e-05,  -4.36294236e-06,  -7.22428250e-06,
          3.27242014e-01,   1.04989776e-04,  -2.05807257e-05,
          1.23593194e-05,   2.62466557e-01,   5.87713937e-06,
          1.04653790e-06,  -1.84179058e-02,   1.28690465e-05,
          1.01988048e-05,  -1.10261361e-05,  -1.18422839e-04],
       [ -4.87280027e-03,  -1.60987563e-03,   3.30371685e-03,
         -6.62965507e-03,   3.94330675e-07,   1.13622291e-02,
          5.32760913e-06,  -4.36694913e-03,   1.97987892e-06,
          7.45364958e-03,   5.87713937e-06,   6.64314328e-04,
          2.82219603e-07,  -1.52665220e-07,   4.09016009e-04,
          1.30955281e-07,  -4.87407569e-03,  -1.60208219e-03],
       [  6.95317274e-06,   4.57758584e-06,   1.10867768e-06,
         -2.35012778e-06,   2.00426668e-05,   5.24258201e-06,
          1.30251456e-06,  -1.22488745e-06,   1.01519857e-05,
          3.48099397e-06,   1.04653790e-06,   2.82219603e-07,
          1.60932292e-09,  -7.27659251e-08,   2.07212466e-07,
         -1.46241283e-06,  -1.11439438e-05,  -6.10890873e-06],
       [  2.09812571e-06,   2.72284646e-06,   2.61969943e-06,
         -4.05723942e-06,   7.99777023e-06,   2.44348541e-06,
         -2.29633555e-02,  -1.28850587e-05,   5.33991432e-06,
          1.51588445e-07,  -1.84179058e-02,  -1.52665220e-07,
         -7.27659251e-08,   1.29242885e-03,  -9.44126129e-07,
         -1.27680582e-06,  -4.45654620e-06,   6.15045039e-06],
       [ -3.63944131e-03,  -3.23621898e-03,  -3.90861311e-03,
          8.16530562e-03,   1.79980851e-06,   1.78248909e-02,
          1.31458642e-05,   1.37787248e-02,   4.70364599e-06,
          1.27756840e-02,   1.28690465e-05,   4.09016009e-04,
          2.07212466e-07,  -9.44126129e-07,   1.12028838e-03,
         -2.99915521e-07,  -3.64258148e-03,  -3.22353873e-03],
       [ -8.91746566e-03,  -5.27000050e-03,   2.33472522e-06,
         -4.28480170e-06,  -1.97522107e-02,  -1.73986136e-06,
          1.40861080e-05,  -3.56844247e-06,  -1.00040904e-02,
         -2.02683321e-06,   1.01988048e-05,   1.30955281e-07,
         -1.46241283e-06,  -1.27680582e-06,  -2.99915521e-07,
          1.44131570e-03,   8.91693126e-03,   5.26487156e-03],
       [ -1.89435015e-02,  -1.91351461e-02,  -1.85271015e-02,
          3.96597258e-02,  -1.22213608e-01,  -9.13635567e-02,
          1.06333786e-05,   1.98872731e-02,  -6.19137368e-02,
         -6.07313343e-02,  -1.10261361e-05,  -4.87407569e-03,
         -1.11439438e-05,  -4.45654620e-06,  -3.64258148e-03,
          8.91693126e-03,   9.14113897e-02,   4.59825334e-02],
       [ -1.91643480e-02,  -9.57164847e-03,   1.09367671e-02,
         -1.54118121e-02,  -7.21472553e-02,  -5.53022627e-02,
         -1.33529819e-04,  -3.19114804e-02,  -3.65523351e-02,
         -3.90530124e-02,  -1.18422839e-04,  -1.60208219e-03,
         -6.10890873e-06,   6.15045039e-06,  -3.22353873e-03,
          5.26487156e-03,   4.59825334e-02,   2.88665127e-02]])
    ref_result_energy = -75.83985484836019
    ref_result_exp_alpha = array([[  1.10252363e-04,  -1.39045745e-01,   2.34881326e-01,
         -1.29907726e-01,   1.78206863e-05,   1.11915163e-01,
         -1.13761773e-01,   8.43616802e-01,   7.31245679e-01,
          1.27084647e-03,   4.96234298e-01,   4.27525388e-03,
          1.68581586e-01,   2.75015790e-04,  -9.74994968e-02,
          4.65614367e-04,  -8.32876687e-01,   9.60103263e-01],
       [  3.76385385e-03,  -4.91274782e-03,   1.38830027e-01,
         -9.83867788e-02,   2.92125352e-05,   9.35763253e-01,
         -1.25289266e+00,  -6.31715523e-01,  -5.72289855e-01,
         -7.73622072e-04,  -7.42693106e-02,   9.63970389e-01,
          6.78728646e-01,   1.75656829e-04,  -4.92135449e-02,
         -5.88573784e-05,  -1.09367517e-01,  -1.57443712e-02],
       [  9.94155572e-01,   2.12466999e-01,   5.76494819e-06,
         -8.39619054e-02,   1.73258831e-05,   9.53916425e-02,
          2.30773328e-04,   1.47005441e-04,   3.47689566e-02,
          4.18015299e-05,   6.60452293e-02,   5.03785162e-05,
         -7.09612086e-02,  -3.17098970e-06,   6.81302719e-04,
          2.33801728e-05,  -1.73922220e-02,  -5.06426792e-06],
       [  3.33388862e-02,  -4.54365587e-01,  -2.02599025e-05,
          1.81096764e-01,   1.55696595e-05,  -1.78656349e-01,
         -6.28220055e-04,  -6.70553560e-04,  -1.40432768e-01,
          4.16623472e-04,  -3.62812297e-01,  -3.94303864e-04,
          1.62314071e+00,   6.29567619e-04,  -1.34623964e-01,
         -2.19592084e-05,  -5.55309517e-01,  -4.58492763e-04],
       [  2.97312213e-08,   2.70203541e-05,   5.20278953e-01,
          4.47518536e-05,   1.02188674e-05,  -7.47523351e-04,
          4.34966018e-01,  -1.93793556e-01,   5.16637494e-05,
         -2.14414262e-04,  -7.10278825e-04,   9.78456487e-01,
          1.28944163e-04,  -2.12415588e-04,   1.18480174e-04,
          7.10979759e-05,   2.93403114e-05,   3.70608479e-02],
       [ -1.73255918e-03,   1.35757344e-01,  -2.51201941e-05,
          5.57621763e-01,  -2.31046098e-05,   2.81406019e-01,
          5.54387856e-04,   3.15083471e-05,   6.54080090e-01,
          5.64959730e-04,  -7.07343539e-01,  -5.70553416e-04,
         -1.80921528e-01,  -8.66024556e-05,   6.57018651e-03,
          1.91026120e-04,   3.96658820e-02,   8.91721324e-05],
       [ -7.09019134e-07,  -1.49416939e-05,  -3.39898641e-05,
         -1.37638420e-04,  -6.38751673e-01,   1.04533361e-04,
          9.35539759e-05,   7.36858065e-05,   1.30135974e-03,
         -9.63319783e-01,   2.70593998e-04,  -2.10862596e-04,
          4.26594861e-04,   1.11004471e-04,  -3.00508010e-05,
         -7.45346089e-03,  -5.82589060e-05,  -4.63460825e-05],
       [ -1.64949392e-02,  -4.68468704e-01,  -7.26557494e-05,
          3.48339225e-01,  -2.40183527e-04,  -1.09437179e+00,
         -2.04442504e-03,  -8.11314072e-06,   1.74318289e-01,
         -9.81656421e-04,  -3.36182594e-03,   3.19922449e-04,
         -2.54396663e+00,  -1.27016151e-03,   2.69328134e-01,
         -1.86977182e-04,   1.32664924e+00,   9.92761766e-04],
       [ -3.27324812e-07,   1.47793422e-05,   2.63510622e-01,
          1.37320882e-04,   4.10261743e-05,  -1.75011112e-03,
          7.46862148e-01,  -4.36928420e-01,   5.75558319e-04,
          4.21484631e-04,   1.82183573e-03,  -1.69457497e+00,
         -1.92815230e-04,   3.90730153e-04,  -2.61045219e-04,
         -1.88445458e-04,   4.16923703e-04,  -9.45032826e-01],
       [  2.83347131e-03,   6.71609843e-02,  -3.30771342e-06,
          3.95335202e-01,  -5.11050372e-05,   4.20684734e-01,
          9.10752111e-04,   9.77528561e-04,  -3.45268395e-01,
          1.96107525e-04,   1.13264167e+00,   9.07133762e-04,
          6.26990777e-01,   8.30750774e-04,  -1.50940895e-01,
          1.24179100e-04,  -6.76016699e-01,  -4.91135046e-04],
       [  3.87108782e-07,   1.10553283e-05,   1.67926524e-06,
         -3.68995764e-05,  -5.12314920e-01,   1.88291160e-05,
         -1.73840227e-05,  -4.79156355e-05,  -1.38488804e-03,
          1.03554030e+00,  -3.51438046e-04,   2.30491738e-04,
         -4.38763291e-04,  -1.73574444e-04,  -8.22425847e-05,
         -3.51239202e-02,   5.38072788e-05,   4.06966097e-05],
       [  1.90690991e-04,   2.07163980e-02,  -1.63846192e-06,
          1.53332739e-02,  -1.21632239e-05,   1.29185506e-02,
          4.83675574e-06,  -2.44666057e-04,  -1.33384742e-01,
         -2.18624293e-04,  -8.96744705e-02,  -8.64872489e-05,
         -1.58350750e-01,  -2.88762692e-03,   4.72808230e-01,
         -7.32427267e-04,  -9.80759334e-01,  -5.36039954e-04],
       [  4.52333574e-09,   8.12989223e-06,   3.85455356e-05,
          7.42405736e-06,  -2.04730024e-06,   2.80327546e-05,
          8.00574337e-05,  -1.53296591e-05,   5.11909443e-05,
          1.25878228e-04,  -2.72391107e-05,   1.48777028e-04,
          8.47332658e-05,   9.99981313e-01,   5.98155295e-03,
         -1.21631372e-03,  -7.73592804e-05,   2.26299086e-04],
       [ -1.62831015e-07,   1.13927985e-05,   1.46651153e-05,
          3.12664663e-06,   3.59503927e-02,   4.77550248e-05,
          2.21725109e-05,   2.97174181e-05,   1.58395207e-04,
         -1.61064919e-02,  -8.42071856e-05,   5.28696289e-05,
         -2.18871077e-04,  -1.20179482e-03,  -1.92793707e-03,
         -9.99221130e-01,  -1.54185916e-04,   1.06556759e-04],
       [ -1.13203402e-04,  -4.77518681e-03,   8.61918643e-07,
          3.31281529e-02,  -2.76058349e-05,   1.02091596e-02,
          1.92591190e-05,   2.15438631e-04,   1.10066158e-01,
          2.29424058e-04,   1.08242219e-01,  -4.03612783e-05,
          1.81165128e-01,  -5.20898219e-03,   8.73913262e-01,
         -1.79367521e-03,   5.07376445e-01,   1.93547527e-04],
       [  1.93823133e-07,   8.39702623e-06,  -3.79646851e-02,
         -6.87088600e-06,  -2.00310556e-05,   7.89179701e-05,
         -1.71772937e-02,  -2.14122475e-01,   2.43474111e-04,
         -5.94867093e-05,   3.39652841e-04,  -2.59376323e-02,
          1.35812155e-04,  -2.85020696e-04,   6.85061811e-05,
          1.27629280e-04,  -6.91369915e-04,   1.27315091e+00],
       [  1.10089473e-04,  -1.39079663e-01,  -2.34881725e-01,
         -1.29995215e-01,   2.71423945e-05,   1.11827962e-01,
          1.14801630e-01,  -8.40478305e-01,   7.33361916e-01,
          1.27393791e-03,   4.98082968e-01,  -3.21583828e-03,
          1.68329659e-01,   6.85602418e-04,  -9.76654681e-02,
          2.08632199e-04,  -8.31904414e-01,  -9.61027821e-01],
       [  3.76348757e-03,  -4.85343999e-03,  -1.38661637e-01,
         -9.79880882e-02,   2.37698365e-04,   9.30000725e-01,
          1.25636622e+00,   6.30461573e-01,  -5.74287985e-01,
         -1.44471363e-04,  -7.45240798e-02,  -9.64614838e-01,
          6.78849896e-01,   2.85697746e-04,  -4.93577060e-02,
         -7.15159957e-05,  -1.09379438e-01,   1.54563260e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_numlda.py")

    l = {}
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], l[k], v), l[k] - l[var_name]
