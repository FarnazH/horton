# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_hf_dft_uks_methyl_gga():
    ref_result_dm_alpha = array([[  1.03151753e+00,  -4.58389363e-02,   2.19308575e-06,
          5.17333520e-06,   2.92107204e-06,  -1.09614274e-01,
          1.54564987e-06,   5.47960530e-06,   2.30500115e-06,
          1.56453098e-03,  -9.86591677e-07,  -9.28389003e-07,
         -2.52081949e-07,   4.75478293e-07,  -2.91148706e-02,
         -3.84840580e-03,  -2.91176350e-02,  -3.84710514e-03,
         -2.91037316e-02,  -3.85913794e-03],
       [ -4.58389363e-02,   1.61077533e-01,  -3.58774929e-06,
         -4.90642027e-06,  -3.81973718e-07,   1.69060044e-01,
         -2.31463133e-06,  -7.83035322e-06,   2.70284849e-07,
         -2.58092905e-03,   2.16680269e-06,   1.94487108e-06,
          3.78622451e-07,  -9.36747199e-07,   5.46930893e-02,
          1.72457137e-02,   5.47004456e-02,   1.72449259e-02,
          5.46665389e-02,   1.72639039e-02],
       [  2.19308575e-06,  -3.58774929e-06,   2.00082007e-01,
          6.38412561e-06,   5.36472927e-06,  -6.44151413e-06,
          9.38812686e-02,  -1.90945202e-06,   1.91892345e-06,
         -2.34159507e-06,   4.31640083e-06,  -2.16750055e-06,
          8.94644200e-03,  -1.32502868e-06,   1.22935928e-01,
          1.01220997e-01,  -6.14714806e-02,  -5.05929281e-02,
         -6.14406036e-02,  -5.06377771e-02],
       [  5.17333520e-06,  -4.90642027e-06,   6.38412561e-06,
          2.00087188e-01,   5.60870780e-07,  -1.70614775e-05,
          9.11879842e-06,   9.38849385e-02,  -6.33774840e-07,
         -2.53635382e-06,  -1.41584475e-06,   1.85233461e-06,
         -2.36864551e-06,  -8.94262772e-03,   1.02349954e-06,
          7.57601612e-06,   1.06479521e-01,   8.76561619e-02,
         -1.06417494e-01,  -8.76919476e-02],
       [  2.92107204e-06,  -3.81973718e-07,   5.36472927e-06,
          5.60870780e-07,   3.60895941e-01,  -3.05282636e-05,
          7.95870720e-08,  -4.45572146e-06,   3.16805520e-01,
         -2.75667265e-06,  -2.65786256e-06,  -4.75875954e-06,
          1.13592123e-06,  -1.32137823e-06,   1.34677182e-05,
          2.13519659e-06,   1.14906352e-05,   1.15490315e-05,
          2.83296117e-06,   1.23427888e-05],
       [ -1.09614274e-01,   1.69060044e-01,  -6.44151413e-06,
         -1.70614775e-05,  -3.05282636e-05,   1.81152242e-01,
         -3.70544418e-06,  -1.38965673e-05,  -2.61576933e-05,
         -2.75895729e-03,   2.29677172e-06,   2.06420897e-06,
          2.89694561e-07,  -4.73471008e-07,   5.82201991e-02,
          1.80350697e-02,   5.82241434e-02,   1.80310351e-02,
          5.82007315e-02,   1.80615937e-02],
       [  1.54564987e-06,  -2.31463133e-06,   9.38812686e-02,
          9.11879842e-06,   7.95870720e-08,  -3.70544418e-06,
          4.40504011e-02,   1.97727769e-06,  -1.23946766e-06,
         -1.08838206e-06,   2.02528149e-06,  -1.01694041e-06,
          4.19779530e-03,  -8.95380187e-07,   5.76830333e-02,
          4.74942369e-02,  -2.88402365e-02,  -2.37362923e-02,
         -2.88322636e-02,  -2.37627024e-02],
       [  5.47960530e-06,  -7.83035322e-06,  -1.90945202e-06,
          9.38849385e-02,  -4.45572146e-06,  -1.38965673e-05,
          1.97727769e-06,   4.40527045e-02,  -4.43972164e-06,
         -1.10023075e-06,  -6.64488841e-07,   8.69200773e-07,
         -1.33076879e-06,  -4.19606096e-03,  -4.43050886e-06,
          4.82987592e-07,   4.99619458e-02,   4.11306865e-02,
         -4.99336210e-02,  -4.11461778e-02],
       [  2.30500115e-06,   2.70284849e-07,   1.91892345e-06,
         -6.33774840e-07,   3.16805520e-01,  -2.61576933e-05,
         -1.23946766e-06,  -4.43972164e-06,   2.78101596e-01,
         -2.42961770e-06,  -2.33319728e-06,  -4.17735785e-06,
          8.72393843e-07,  -1.10960558e-06,   1.03146563e-05,
          5.27405725e-07,   1.05516708e-05,   1.04151042e-05,
          4.14924621e-06,   1.20993803e-05],
       [  1.56453098e-03,  -2.58092905e-03,  -2.34159507e-06,
         -2.53635382e-06,  -2.75667265e-06,  -2.75895729e-03,
         -1.08838206e-06,  -1.10023075e-06,  -2.42961770e-06,
          4.20305497e-05,  -3.50328740e-08,  -3.14298167e-08,
         -1.13471334e-07,   1.32212164e-07,  -8.88860258e-04,
         -2.76677212e-04,  -8.88159937e-04,  -2.75989636e-04,
         -8.84827918e-04,  -2.74004315e-04],
       [ -9.86591677e-07,   2.16680269e-06,   4.31640083e-06,
         -1.41584475e-06,  -2.65786256e-06,   2.29677172e-06,
          2.02528149e-06,  -6.64488841e-07,  -2.33319728e-06,
         -3.50328740e-08,   1.51997981e-10,   1.47751998e-12,
          1.93022516e-07,   6.32507051e-08,   3.39275461e-06,
          2.41526226e-06,  -1.33899668e-06,  -1.48026772e-06,
          1.67834885e-07,  -2.40137792e-07],
       [ -9.28389003e-07,   1.94487108e-06,  -2.16750055e-06,
          1.85233461e-06,  -4.75875954e-06,   2.06420897e-06,
         -1.01694041e-06,   8.69200773e-07,  -4.17735785e-06,
         -3.14298167e-08,   1.47751998e-12,   1.26998277e-10,
         -9.69471572e-08,  -8.27733453e-08,  -6.66546420e-07,
         -8.88626013e-07,   2.31702667e-06,   1.56728633e-06,
          3.45326069e-07,  -5.54361308e-08],
       [ -2.52081949e-07,   3.78622451e-07,   8.94644200e-03,
         -2.36864551e-06,   1.13592123e-06,   2.89694561e-07,
          4.19779530e-03,  -1.33076879e-06,   8.72393843e-07,
         -1.13471334e-07,   1.93022516e-07,  -9.69471572e-08,
          4.00030136e-04,   5.93673028e-08,   5.49712750e-03,
          4.52604055e-03,  -2.74985491e-03,  -2.26331113e-03,
         -2.74565041e-03,  -2.26299050e-03],
       [  4.75478293e-07,  -9.36747199e-07,  -1.32502868e-06,
         -8.94262772e-03,  -1.32137823e-06,  -4.73471008e-07,
         -8.95380187e-07,  -4.19606096e-03,  -1.10960558e-06,
          1.32212164e-07,   6.32507051e-08,  -8.27733453e-08,
          5.93673028e-08,   3.99678735e-04,  -1.08217404e-06,
         -9.87971647e-07,  -4.75903720e-03,  -3.91753476e-03,
          4.75610862e-03,   3.91941322e-03],
       [ -2.91148706e-02,   5.46930893e-02,   1.22935928e-01,
          1.02349954e-06,   1.34677182e-05,   5.82201991e-02,
          5.76830333e-02,  -4.43050886e-06,   1.03146563e-05,
         -8.88860258e-04,   3.39275461e-06,  -6.66546420e-07,
          5.49712750e-03,  -1.08217404e-06,   9.42878126e-02,
          6.80354481e-02,  -1.90164675e-02,  -2.52449692e-02,
         -1.90078071e-02,  -2.52649569e-02],
       [ -3.84840580e-03,   1.72457137e-02,   1.01220997e-01,
          7.57601612e-06,   2.13519659e-06,   1.80350697e-02,
          4.74942369e-02,   4.82987592e-07,   5.27405725e-07,
         -2.76677212e-04,   2.41526226e-06,  -8.88626013e-07,
          4.52604055e-03,  -9.87971647e-07,   6.80354481e-02,
          5.30553509e-02,  -2.52527838e-02,  -2.37451838e-02,
         -2.52459686e-02,  -2.37701135e-02],
       [ -2.91176350e-02,   5.47004456e-02,  -6.14714806e-02,
          1.06479521e-01,   1.14906352e-05,   5.82241434e-02,
         -2.88402365e-02,   4.99619458e-02,   1.05516708e-05,
         -8.88159937e-04,  -1.33899668e-06,   2.31702667e-06,
         -2.74985491e-03,  -4.75903720e-03,  -1.90164675e-02,
         -2.52527838e-02,   9.43099378e-02,   6.80357603e-02,
         -1.90115048e-02,  -2.52613847e-02],
       [ -3.84710514e-03,   1.72449259e-02,  -5.05929281e-02,
          8.76561619e-02,   1.15490315e-05,   1.80310351e-02,
         -2.37362923e-02,   4.11306865e-02,   1.04151042e-05,
         -2.75989636e-04,  -1.48026772e-06,   1.56728633e-06,
         -2.26331113e-03,  -3.91753476e-03,  -2.52449692e-02,
         -2.37451838e-02,   6.80357603e-02,   5.30432695e-02,
         -2.52459632e-02,  -2.37634594e-02],
       [ -2.91037316e-02,   5.46665389e-02,  -6.14406036e-02,
         -1.06417494e-01,   2.83296117e-06,   5.82007315e-02,
         -2.88322636e-02,  -4.99336210e-02,   4.14924621e-06,
         -8.84827918e-04,   1.67834885e-07,   3.45326069e-07,
         -2.74565041e-03,   4.75610862e-03,  -1.90078071e-02,
         -2.52459686e-02,  -1.90115048e-02,  -2.52459632e-02,
          9.41940122e-02,   6.80309913e-02],
       [ -3.85913794e-03,   1.72639039e-02,  -5.06377771e-02,
         -8.76919476e-02,   1.23427888e-05,   1.80615937e-02,
         -2.37627024e-02,  -4.11461778e-02,   1.20993803e-05,
         -2.74004315e-04,  -2.40137792e-07,  -5.54361308e-08,
         -2.26299050e-03,   3.91941322e-03,  -2.52649569e-02,
         -2.37701135e-02,  -2.52613847e-02,  -2.37634594e-02,
          6.80309913e-02,   5.30976287e-02]])
    ref_result_energy = -39.761058268315274
    ref_result_exp_alpha = array([[  9.94857535e-01,   2.04391821e-01,   8.77182352e-07,
          2.01061521e-05,   6.18749768e-06,  -1.54002744e-01,
         -3.53797189e-05,  -1.16920853e-06,  -9.02917858e-07,
         -1.19252641e-06,   7.09691018e-06,   4.68970949e-02,
         -2.74442487e-06,   2.02220727e-06,   3.48081495e-02,
          1.00957123e-06,  -2.62514512e-06,  -4.11167026e-02,
         -3.72101640e-05,  -8.19910507e-07],
       [  3.60464770e-02,  -3.99722667e-01,   3.15368738e-06,
         -2.71897792e-05,  -3.10800788e-06,   2.57939228e-01,
          5.57136294e-05,  -4.95790202e-06,  -1.64670736e-05,
         -3.25290590e-05,  -9.07749635e-06,   6.60792823e-01,
          1.62258739e-04,  -4.26173057e-04,  -1.94833101e+00,
         -4.65806318e-08,  -1.99462951e-05,  -2.73732430e-01,
         -1.62074406e-04,   1.05029158e-05],
       [ -2.15350463e-07,  -1.03860331e-05,  -3.75598156e-01,
          2.42915592e-01,  -1.02962835e-05,  -5.58389094e-05,
          2.20675903e-01,  -3.85677250e-01,   2.62337576e-05,
         -8.03376970e-01,   1.99676802e-01,  -7.68401803e-06,
         -1.29941308e-01,   7.47056148e-01,  -1.69414503e-04,
          6.47382727e-06,  -1.14401414e-05,   5.72619505e-06,
          3.13612847e-02,   5.05044950e-02],
       [ -2.72968329e-07,  -1.12247284e-05,   2.42906720e-01,
          3.75610924e-01,  -1.54681791e-05,  -9.27463613e-05,
          3.85695864e-01,   2.20650622e-01,   7.18458317e-05,
          1.99653651e-01,   8.03409277e-01,  -1.55545459e-04,
         -7.47017254e-01,  -1.29989704e-01,  -1.02708953e-04,
          4.51792034e-07,   8.29553766e-06,   2.65243287e-06,
          5.04274187e-02,  -3.13957750e-02],
       [ -3.81639980e-08,  -3.75692345e-06,  -9.72505516e-06,
          3.25213203e-05,   6.00746180e-01,   1.53511047e-05,
          4.59193102e-06,  -1.11515211e-06,   1.05818300e+00,
          9.75576952e-06,  -1.00853917e-04,   1.10966953e-05,
          3.12787292e-07,  -8.74352854e-06,  -3.32123969e-06,
          5.15794995e-06,   2.21933260e-06,  -9.22912169e-08,
          7.66498468e-07,  -9.13491652e-07],
       [ -2.28642621e-02,  -4.25005193e-01,  -6.03628293e-06,
         -5.46395756e-05,  -5.33086688e-05,   1.84859485e+00,
          4.12919140e-04,  -2.49436041e-07,   2.37062692e-05,
          6.18454418e-05,   9.01065909e-05,  -9.88630048e-01,
         -3.15450939e-04,   7.93299231e-04,   3.60635140e+00,
         -2.19278066e-05,   5.51074755e-05,   7.92541038e-01,
          5.23046582e-04,  -1.07301895e-05],
       [  9.23081817e-08,  -3.28754405e-06,  -1.76228255e-01,
          1.13990874e-01,  -8.88793222e-06,  -1.27803563e-04,
          6.35802252e-01,  -1.11139838e+00,  -6.72791178e-05,
          1.64359135e+00,  -4.08531298e-01,   2.15536692e-06,
          1.96048731e-01,  -1.12724490e+00,   2.52622472e-04,
          7.41720458e-06,  -5.53752133e-06,  -2.35265366e-04,
          2.82068964e-01,   4.53512019e-01],
       [  9.72260111e-08,   8.57534352e-06,   1.13985870e-01,
          1.76238356e-01,  -1.51126820e-05,  -2.04139711e-04,
          1.11137676e+00,   6.35845717e-01,  -1.52114192e-04,
         -4.08457722e-01,  -1.64364859e+00,   2.97122793e-04,
          1.12715796e+00,   1.96126085e-01,   1.72889652e-04,
          6.68903503e-06,   1.15885371e-05,  -3.33210146e-04,
          4.53552990e-01,  -2.82050807e-01],
       [  1.35135048e-08,  -4.78764709e-06,  -4.66386728e-06,
          2.30455176e-05,   5.27353360e-01,   1.12303372e-05,
         -5.61450066e-06,   8.89088765e-06,  -1.09660643e+00,
         -3.17345940e-06,   9.52004080e-05,  -3.34290551e-05,
         -7.25896167e-06,   1.20605214e-05,  -3.74271343e-07,
          4.70579720e-06,   4.16844948e-07,  -5.06024834e-07,
         -1.19326339e-06,   8.26922382e-07],
       [  2.41603208e-04,   6.47858929e-03,   1.28280913e-06,
         -7.39829056e-06,  -4.52474116e-06,   1.69924544e-02,
          1.73895193e-05,   1.82376480e-06,   4.10760195e-06,
          8.02162933e-06,  -3.92531658e-05,  -1.85195528e-01,
         -5.21231662e-05,   4.25573679e-05,  -2.71531781e-02,
          3.02229895e-05,  -4.88390518e-05,  -1.05102290e+00,
         -7.18570866e-04,  -3.07291444e-05],
       [  1.19848097e-07,  -5.41161341e-06,  -9.83544031e-06,
          2.59076973e-06,  -4.40729632e-06,   1.95159959e-06,
         -4.16033068e-06,   4.12848541e-06,   6.02464614e-07,
         -1.41968100e-05,   1.69804242e-06,   1.26831159e-05,
         -4.31857067e-06,  -3.34202523e-05,   5.83537228e-06,
          6.97837657e-01,  -7.16255958e-01,   5.09576956e-05,
          6.86964126e-06,  -4.11522673e-05],
       [  6.52350225e-08,  -4.85949528e-06,   6.32643103e-06,
          8.58589195e-07,  -7.90869617e-06,  -1.40633404e-06,
         -4.40070214e-06,  -5.81682338e-06,  -4.64172807e-07,
          9.08429166e-06,   9.69192219e-06,   2.23104663e-05,
          1.58366279e-05,   1.56855843e-05,   3.44944054e-06,
          7.16255961e-01,   6.97837658e-01,  -1.58970030e-05,
         -1.07627985e-05,   5.59653491e-06],
       [ -8.28893916e-08,  -1.82888418e-06,  -1.67976971e-02,
          1.08567192e-02,   1.03124871e-06,  -5.04396421e-06,
         -1.09851557e-02,   1.92227516e-02,   1.48396672e-06,
         -1.13407597e-01,   2.81655124e-02,   1.97953731e-05,
          3.38602180e-02,  -1.94915558e-01,   7.16383667e-05,
          2.10754934e-05,  -1.52670264e-05,  -4.35731867e-04,
          5.72765335e-01,   9.20962138e-01],
       [  1.26004275e-07,   3.41464845e-06,  -1.08544434e-02,
         -1.67886774e-02,  -1.46641039e-06,   1.39904191e-05,
          1.91934734e-02,   1.09986141e-02,  -8.42882545e-06,
         -2.81936613e-02,  -1.13367269e-01,  -7.25795648e-05,
         -1.94814592e-01,  -3.39510645e-02,  -4.07054246e-05,
          1.36376356e-05,  -2.53208363e-05,   6.39760329e-04,
         -9.20991111e-01,   5.72755327e-01],
       [ -1.13371565e-03,  -1.36941820e-01,  -2.30780823e-01,
          1.49244100e-01,   9.72506686e-06,  -1.13350430e-01,
         -6.33269755e-02,   1.10632563e-01,  -1.02600805e-05,
         -4.14154395e-01,   1.03019896e-01,   6.36975547e-01,
          1.49879341e-01,  -8.61663834e-01,   2.85971647e-01,
         -3.99598535e-05,   3.09273320e-05,  -3.76253851e-01,
         -3.60516808e-01,  -5.79280565e-01],
       [  4.90444860e-03,  -4.27117353e-02,  -1.90008897e-01,
          1.22897258e-01,  -6.51417571e-06,  -9.52922172e-01,
         -8.08434312e-01,   1.41277398e+00,   4.35744903e-05,
         -4.53167640e-01,   1.12565620e-01,  -2.30534060e-01,
         -2.68837392e-01,   1.54586335e+00,  -1.09510800e+00,
          2.88805194e-05,  -3.66216525e-05,  -6.44345350e-02,
         -5.73938403e-03,  -9.11125910e-03],
       [ -1.13375211e-03,  -1.36954849e-01,   2.44671832e-01,
          1.25250860e-01,   1.54307579e-05,  -1.13378444e-01,
         -6.42055601e-02,  -1.10168300e-01,   1.68841891e-05,
          2.96211995e-01,   3.07264779e-01,   6.37080216e-01,
          6.71239387e-01,   5.60670567e-01,   2.85736658e-01,
          3.81414024e-06,  -8.48912751e-05,  -3.76298043e-01,
         -3.21782726e-01,   6.01600163e-01],
       [  4.90449496e-03,  -4.27053624e-02,   2.01396646e-01,
          1.03125679e-01,   1.65694586e-05,  -9.52905523e-01,
         -8.19568241e-01,  -1.40632333e+00,   2.50972044e-05,
          3.24055570e-01,   3.36068198e-01,  -2.30837992e-01,
         -1.20432557e+00,  -1.00619453e+00,  -1.09473371e+00,
          4.38929010e-06,   2.66626427e-05,  -6.44552478e-02,
         -5.13810706e-03,   9.48552495e-03],
       [ -1.13405581e-03,  -1.36844927e-01,  -1.38568738e-02,
         -2.74361193e-01,   1.84675812e-05,  -1.13401839e-01,
          1.27471781e-01,  -5.07170125e-04,  -4.53442814e-05,
          1.17919443e-01,  -4.10063252e-01,   6.37183865e-01,
         -8.21400628e-01,   3.01064325e-01,   2.85691336e-01,
          7.51913955e-06,  -1.12839858e-05,  -3.76887611e-01,
          6.81329297e-01,  -2.23458350e-02],
       [  4.90474047e-03,  -4.27321781e-02,  -1.14031159e-02,
         -2.26091500e-01,   3.22671090e-05,  -9.53448171e-01,
          1.62737576e+00,  -6.41136647e-03,  -5.47733568e-05,
          1.29083506e-01,  -4.48945764e-01,  -2.30518308e-01,
          1.47352970e+00,  -5.40299925e-01,  -1.09447695e+00,
          1.01467968e-05,  -7.30433458e-06,  -6.45789470e-02,
          1.08804257e-02,  -3.61805321e-04]])
    ref_result_exp_beta = array([[  9.95042422e-01,   1.96043965e-01,   8.35802543e-08,
          2.27968709e-05,  -1.00119657e-05,   1.61458966e-01,
         -4.85378864e-05,  -1.56570879e-05,  -7.26989607e-07,
          8.79702824e-06,   3.37715958e-07,  -5.84971935e-02,
         -3.28844107e-07,   3.19823965e-06,   3.62040900e-02,
         -3.07680119e-05,   1.51261725e-05,   3.14894481e-02,
          7.11728740e-05,   2.26174295e-05],
       [  3.45155763e-02,  -3.80021905e-01,  -1.12201413e-06,
         -3.12454064e-05,   1.80117702e-05,  -2.56270782e-01,
          7.64405201e-05,   1.39481185e-05,  -2.91178962e-05,
         -1.24807036e-05,   2.51077101e-05,  -5.41972342e-01,
         -2.59052787e-04,   2.80267318e-04,  -1.98024255e+00,
         -4.50995303e-05,   7.00658867e-05,   3.29852820e-01,
          6.40248132e-04,   2.39210863e-04],
       [ -3.19775639e-08,  -2.28237975e-05,  -3.70797899e-01,
          2.16594645e-01,   7.58439149e-05,   6.19024953e-05,
          2.84427526e-01,  -3.44215350e-01,  -7.84273125e-01,
          2.08353800e-01,  -7.58145715e-04,  -5.71491226e-05,
          1.67872917e-01,  -7.66444877e-01,  -1.08327190e-04,
          6.31890115e-06,   2.10446068e-05,   5.58336384e-05,
         -2.62821648e-02,  -5.22534842e-02],
       [ -4.06502304e-07,  -1.36772095e-05,   2.16582999e-01,
          3.70784782e-01,   3.93023395e-05,   1.38909813e-04,
          3.44221047e-01,   2.84404351e-01,   2.08328630e-01,
          7.84289488e-01,  -2.45782641e-04,   1.31814170e-04,
          7.66445572e-01,   1.67912659e-01,  -1.30446034e-04,
         -2.52992233e-05,  -8.86832211e-06,   5.92712225e-05,
         -5.21834317e-02,   2.63251804e-02],
       [ -2.54617228e-07,  -3.07037100e-07,   5.96643948e-05,
         -7.37089429e-05,  -5.34422123e-01,  -1.48679075e-05,
         -8.03901862e-06,   1.18397727e-05,   9.77521232e-04,
         -6.32701312e-04,  -1.09317831e+00,   3.36146016e-05,
          1.13959680e-04,  -1.76357252e-04,  -2.31138425e-05,
         -1.61228282e-05,  -2.29882485e-05,   1.73155106e-05,
         -1.75543295e-05,   1.84415969e-06],
       [ -2.15185566e-02,  -3.65910562e-01,  -4.84611110e-06,
         -4.86433117e-05,   7.30262990e-05,  -1.91181151e+00,
          5.72970078e-04,   1.74921035e-04,   8.63303497e-05,
          6.77905764e-05,  -7.20355501e-05,   8.64669449e-01,
          5.01527610e-04,  -5.19048441e-04,   3.60540697e+00,
          2.87595249e-04,  -2.23358709e-04,  -8.20818994e-01,
         -1.62564915e-03,  -5.92100234e-04],
       [  8.26999417e-08,  -5.87285776e-06,  -1.59691524e-01,
          9.32992599e-02,   4.48318981e-05,   1.62298022e-04,
          8.27859778e-01,  -1.00199859e+00,   1.61247788e+00,
         -4.28384212e-01,   1.42986835e-03,   1.10414758e-04,
         -2.48730618e-01,   1.13577293e+00,   1.54460783e-04,
          7.65643740e-05,  -8.95503462e-06,   8.69724618e-04,
         -2.41023365e-01,  -4.78586096e-01],
       [  2.18761581e-07,   7.41119255e-06,   9.32941056e-02,
          1.59695897e-01,   3.59931011e-05,   3.25800453e-04,
          1.00202409e+00,   8.27904525e-01,  -4.28321247e-01,
         -1.61246819e+00,   4.58405195e-04,  -2.48258864e-04,
         -1.13572918e+00,  -2.48803112e-01,   2.01515267e-04,
         -1.35123168e-05,  -4.67660642e-05,   7.86560739e-04,
         -4.78620109e-01,   2.41005110e-01],
       [  9.46046565e-08,  -8.27590639e-06,   1.51744144e-05,
         -1.30045138e-05,  -5.93901953e-01,  -3.31965787e-05,
          1.50957779e-04,  -7.58447093e-05,  -9.80403012e-04,
          6.35567367e-04,   1.06203875e+00,  -6.59032676e-06,
         -7.79369997e-05,   1.28465116e-04,   1.41366449e-05,
          1.36329732e-05,   5.11814269e-06,  -9.98789044e-06,
          9.37486560e-06,  -1.76006542e-06],
       [ -6.15627607e-04,   3.18143839e-02,  -3.34875583e-06,
         -4.45993326e-06,   9.16353612e-06,   1.40215606e-02,
          6.45062914e-06,  -2.29470064e-06,  -5.89338900e-06,
         -3.33943151e-05,   1.65283823e-05,   1.55744218e-01,
          5.47513993e-05,  -4.94419675e-05,   1.41698832e-02,
         -5.94724972e-04,   3.23608383e-04,   1.05562468e+00,
          2.08930586e-03,   7.91046653e-04],
       [ -1.23058993e-06,   1.68597433e-05,  -1.09158149e-05,
          6.67370423e-06,  -4.29923686e-06,   2.62941862e-05,
          1.45059603e-06,   5.25238624e-06,  -2.00886565e-05,
          6.96331635e-06,  -1.58709012e-05,  -4.74640877e-05,
          1.63171024e-05,   3.37633454e-05,   7.47934579e-05,
          9.86872689e-01,   1.61499223e-01,   5.11533262e-04,
         -1.33761347e-05,   1.56683971e-04],
       [ -3.74716826e-07,   6.20946367e-06,   4.22760625e-06,
          5.44641347e-06,   1.49695834e-05,   1.62101297e-05,
          8.31929675e-08,  -8.80518287e-06,   3.38339097e-06,
          1.43926492e-05,   1.10529456e-05,  -4.35423493e-05,
         -1.20748787e-05,  -2.50486336e-05,   3.64932223e-05,
          1.61499032e-01,  -9.86872785e-01,   3.98947809e-04,
          5.95729644e-05,  -2.13555571e-05],
       [  1.58908599e-07,  -7.05166017e-06,  -1.71855896e-02,
          1.00346354e-02,  -5.59509362e-06,  -6.89387264e-07,
         -1.20909555e-02,   1.46576245e-02,  -1.15988252e-01,
          3.07981922e-02,  -1.48477220e-04,  -1.69516231e-05,
         -4.10229912e-02,   1.87534611e-01,   4.82546932e-05,
          1.36101753e-04,   1.01145969e-05,   1.70608174e-03,
         -4.88158712e-01,  -9.69330746e-01],
       [  4.25086063e-09,   6.44968537e-06,  -1.00343090e-02,
         -1.71746520e-02,  -2.27152948e-06,  -1.02752525e-05,
          1.46272951e-02,   1.21005984e-02,  -3.08314219e-02,
         -1.15951366e-01,   3.77763953e-05,   7.13113124e-05,
          1.87429367e-01,   4.11145973e-02,  -4.38442544e-05,
          7.47474113e-05,   7.52920383e-05,  -1.57454027e-03,
          9.69357377e-01,  -4.88146937e-01],
       [ -1.19922501e-03,  -1.51450011e-01,  -2.49299116e-01,
          1.45614793e-01,  -8.59827186e-05,   9.50126345e-02,
         -7.16290184e-02,   8.66485137e-02,  -4.30160894e-01,
          1.14379839e-01,  -6.12030766e-04,  -6.62007294e-01,
         -1.85327461e-01,   8.45996630e-01,   2.60186238e-01,
         -3.81264731e-04,   1.03622702e-04,   3.49525745e-01,
          3.05781955e-01,   6.06066356e-01],
       [  4.62551184e-03,  -6.94685042e-02,  -2.18314048e-01,
          1.27537588e-01,  -1.75471691e-04,   9.73721262e-01,
         -1.04375430e+00,   1.26286362e+00,  -4.17169362e-01,
          1.10729694e-01,  -5.04348899e-05,   2.65867254e-01,
          3.34569144e-01,  -1.52793797e+00,  -1.06574735e+00,
          4.90923041e-05,   2.87406433e-05,   8.13693765e-02,
          6.25235996e-03,   1.21119338e-02],
       [ -1.19909877e-03,  -1.51464515e-01,   2.50799962e-01,
          1.43107209e-01,  -1.32718803e-05,   9.50267647e-02,
         -3.92737021e-02,  -1.05373130e-01,   3.14092830e-01,
          3.15488932e-01,   1.06849222e-04,  -6.62102575e-01,
         -6.39929484e-01,  -5.83438266e-01,   2.60059635e-01,
         -1.37587424e-04,   2.24403256e-04,   3.50256438e-01,
          3.72785868e-01,  -5.66849412e-01],
       [  4.62544903e-03,  -6.94612941e-02,   2.19580045e-01,
          1.25324022e-01,  -1.56723781e-05,   9.73616812e-01,
         -5.72303575e-01,  -1.53521981e+00,   3.04422992e-01,
          3.05731967e-01,   6.31323750e-05,   2.66229879e-01,
          1.15580052e+00,   1.05402920e+00,  -1.06558607e+00,
         -8.20058650e-06,  -2.34365967e-05,   8.14107521e-02,
          7.60348488e-03,  -1.12215963e-02],
       [ -1.19938705e-03,  -1.51341980e-01,  -1.46070159e-03,
         -2.88604081e-01,   4.46348794e-05,   9.50750121e-02,
          1.10851503e-01,   1.86695134e-02,   1.16122068e-01,
         -4.29670370e-01,   4.67118515e-04,  -6.62266401e-01,
          8.25457923e-01,  -2.62477158e-01,   2.59942966e-01,
         -2.49249288e-04,   8.98490681e-05,   3.51869255e-01,
         -6.76288699e-01,  -3.84299526e-02],
       [  4.62581439e-03,  -6.94846628e-02,  -1.26513384e-03,
         -2.52957458e-01,   1.11653092e-04,   9.74406656e-01,
          1.61517555e+00,   2.72133115e-01,   1.12629168e-01,
         -4.16728946e-01,   8.24345000e-05,   2.66028118e-01,
         -1.49082409e+00,   4.74230714e-01,  -1.06523872e+00,
          3.80201176e-05,  -3.56638308e-07,   8.15344271e-02,
         -1.34928943e-02,  -7.23263994e-04]])
    ref_result_dm_beta = array([[  1.02854266e+00,  -4.01565661e-02,   3.76638626e-07,
          5.36143706e-06,  -3.08184927e-07,  -9.31464202e-02,
          1.03364395e-06,   5.30703717e-06,  -1.52164655e-06,
          5.62444177e-03,   2.08065595e-06,   8.44608015e-07,
         -9.96396974e-07,   8.75592202e-07,  -3.08808443e-02,
         -9.01341740e-03,  -3.08835775e-02,  -9.01207353e-03,
         -3.08697046e-02,  -9.02492061e-03],
       [ -4.01565661e-02,   1.45608053e-01,   2.37510117e-06,
         -6.58980446e-06,   9.25423254e-08,   1.38311317e-01,
         -4.80595158e-07,  -7.88116794e-06,   3.13688958e-06,
         -1.21114128e-02,  -6.44914465e-06,  -2.37287579e-06,
          2.38973334e-06,  -1.90150989e-06,   5.75086830e-02,
          2.65554873e-02,   5.75137144e-02,   2.65523074e-02,
          5.74809046e-02,   2.65732345e-02],
       [  3.76638626e-07,   2.37510117e-06,   1.84404443e-01,
          1.42948931e-06,  -3.80860372e-05,  -2.53311185e-07,
          7.94214566e-02,  -4.05000414e-06,  -8.44208009e-06,
         -4.51946435e-07,   5.48734632e-06,  -3.88065881e-07,
          8.54583182e-03,   7.59945855e-07,   1.23982420e-01,
          1.08575866e-01,  -6.19964131e-02,  -5.42737259e-02,
         -6.19650701e-02,  -5.43185931e-02],
       [  5.36143706e-06,  -6.58980446e-06,   1.42948931e-06,
          1.84389571e-01,  -1.44079739e-05,  -1.39394759e-05,
          7.40904355e-06,   7.94186377e-02,  -1.53529737e-06,
         -2.81599038e-06,   1.10094364e-07,   2.92958701e-06,
         -1.41343424e-06,  -8.54137094e-03,  -1.42690273e-07,
          6.82165116e-06,   1.07383063e-01,   9.40264699e-02,
         -1.07324372e-01,  -9.40659266e-02],
       [ -3.08184927e-07,   9.25423254e-08,  -3.80860372e-05,
         -1.44079739e-05,   8.99202545e-09,   1.04276876e-07,
         -1.64038706e-05,  -6.20471451e-06,   1.86572192e-09,
         -8.01559889e-09,  -1.14611169e-09,  -1.50320906e-10,
         -1.76489924e-06,   6.67240024e-07,  -2.55659615e-05,
         -2.24078814e-05,   4.45451852e-06,   3.87979101e-06,
          2.12246475e-05,   1.85860746e-05],
       [ -9.31464202e-02,   1.38311317e-01,  -2.53311185e-07,
         -1.39394759e-05,   1.04276876e-07,   1.34353539e-01,
         -1.56225350e-06,  -1.08808563e-05,   3.01535897e-06,
         -1.16279674e-02,  -6.14237107e-06,  -2.26436164e-06,
          2.17456690e-06,  -1.47833942e-06,   5.54371406e-02,
          2.53146363e-02,   5.54401062e-02,   2.53099391e-02,
          5.54173989e-02,   2.53378392e-02],
       [  1.03364395e-06,  -4.80595158e-07,   7.94214566e-02,
          7.40904355e-06,  -1.64038706e-05,  -1.56225350e-06,
          3.42061596e-02,   1.18173163e-06,  -3.63602277e-06,
         -6.86872913e-08,   2.36342509e-06,  -1.67004224e-07,
          3.68061845e-03,   1.26398246e-08,   5.33975943e-02,
          4.67624459e-02,  -2.66979826e-02,  -2.33720521e-02,
         -2.66923934e-02,  -2.33983060e-02],
       [  5.30703717e-06,  -7.88116794e-06,  -4.05000414e-06,
          7.94186377e-02,  -6.20471451e-06,  -1.08808563e-05,
          1.18173163e-06,   3.42064902e-02,  -6.61165723e-07,
         -7.89807486e-07,   4.75038595e-08,   1.26189798e-06,
         -8.25083391e-07,  -3.67886334e-03,  -5.21374843e-06,
         -7.31277478e-07,   4.62506315e-02,   4.04986964e-02,
         -4.62262462e-02,  -4.05147886e-02],
       [ -1.52164655e-06,   3.13688958e-06,  -8.44208009e-06,
         -1.53529737e-06,   1.86572192e-09,   3.01535897e-06,
         -3.63602277e-06,  -6.61165723e-07,   4.67267916e-10,
         -2.62354915e-07,  -3.91263410e-10,  -5.78670472e-11,
         -3.91168571e-07,   7.10329912e-08,  -4.42732603e-06,
         -4.39751397e-06,   3.19298710e-06,   2.27500884e-06,
          4.97833344e-06,   3.84343288e-06],
       [  5.62444177e-03,  -1.21114128e-02,  -4.51946435e-07,
         -2.81599038e-06,  -8.01559889e-09,  -1.16279674e-02,
         -6.86872913e-08,  -7.89807486e-07,  -2.62354915e-07,
          1.01253373e-03,   5.37096647e-07,   1.97745475e-07,
         -2.11400465e-07,   3.15154086e-07,  -4.81736296e-03,
         -2.21278209e-03,  -4.81948941e-03,  -2.21400928e-03,
         -4.81282305e-03,  -2.21232599e-03],
       [  2.08065595e-06,  -6.44914465e-06,   5.48734632e-06,
          1.10094364e-07,  -1.14611169e-09,  -6.14237107e-06,
          2.36342509e-06,   4.75038595e-08,  -3.91263410e-10,
          5.37096647e-07,   4.49088797e-10,   9.53508004e-11,
          2.54197432e-07,  -4.97735841e-09,   1.13782066e-06,
          2.05428485e-06,  -4.33278271e-06,  -2.73563623e-06,
         -4.45820116e-06,  -2.84986340e-06],
       [  8.44608015e-07,  -2.37287579e-06,  -3.88065881e-07,
          2.92958701e-06,  -1.50320906e-10,  -2.26436164e-06,
         -1.67004224e-07,   1.26189798e-06,  -5.78670472e-11,
          1.97745475e-07,   9.53508004e-11,   8.60632280e-11,
         -1.80448168e-08,  -1.35671238e-07,  -1.20084760e-06,
         -6.61424993e-07,   8.96479691e-07,   1.17505162e-06,
         -2.51420652e-06,  -1.81350676e-06],
       [ -9.96396974e-07,   2.38973334e-06,   8.54583182e-03,
         -1.41343424e-06,  -1.76489924e-06,   2.17456690e-06,
          3.68061845e-03,  -8.25083391e-07,  -3.91168571e-07,
         -2.11400465e-07,   2.54197432e-07,  -1.80448168e-08,
          3.96038452e-04,   1.03725729e-07,   5.74660763e-03,
          5.03213397e-03,  -2.87304748e-03,  -2.51553856e-03,
         -2.86987262e-03,  -2.51610822e-03],
       [  8.75592202e-07,  -1.90150989e-06,   7.59945855e-07,
         -8.54137094e-03,   6.67240024e-07,  -1.47833942e-06,
          1.26398246e-08,  -3.67886334e-03,   7.10329912e-08,
          3.15154086e-07,  -4.97735841e-09,  -1.35671238e-07,
          1.03725729e-07,   3.95656999e-04,  -3.17090242e-07,
         -2.32856170e-07,  -4.97540029e-03,  -4.35618001e-03,
          4.97036816e-03,   4.35671434e-03],
       [ -3.08808443e-02,   5.75086830e-02,   1.23982420e-01,
         -1.42690273e-07,  -2.55659615e-05,   5.54371406e-02,
          5.33975943e-02,  -5.21374843e-06,  -4.42732603e-06,
         -4.81736296e-03,   1.13782066e-06,  -1.20084760e-06,
          5.74660763e-03,  -3.17090242e-07,   1.06292171e-01,
          8.35122060e-02,  -1.87449328e-02,  -2.59776896e-02,
         -1.87386954e-02,  -2.60010682e-02],
       [ -9.01341740e-03,   2.65554873e-02,   1.08575866e-01,
          6.82165116e-06,  -2.24078814e-05,   2.53146363e-02,
          4.67624459e-02,  -7.31277478e-07,  -4.39751397e-06,
         -2.21278209e-03,   2.05428485e-06,  -6.61424993e-07,
          5.03213397e-03,  -2.32856170e-07,   8.35122060e-02,
          6.87740001e-02,  -2.59851075e-02,  -2.71070764e-02,
         -2.59810140e-02,  -2.71369975e-02],
       [ -3.08835775e-02,   5.75137144e-02,  -6.19964131e-02,
          1.07383063e-01,   4.45451852e-06,   5.54401062e-02,
         -2.66979826e-02,   4.62506315e-02,   3.19298710e-06,
         -4.81948941e-03,  -4.33278271e-06,   8.96479691e-07,
         -2.87304748e-03,  -4.97540029e-03,  -1.87449328e-02,
         -2.59851075e-02,   1.06323211e-01,   8.35207708e-02,
         -1.87433042e-02,  -2.59984517e-02],
       [ -9.01207353e-03,   2.65523074e-02,  -5.42737259e-02,
          9.40264699e-02,   3.87979101e-06,   2.53099391e-02,
         -2.33720521e-02,   4.04986964e-02,   2.27500884e-06,
         -2.21400928e-03,  -2.73563623e-06,   1.17505162e-06,
         -2.51553856e-03,  -4.35618001e-03,  -2.59776896e-02,
         -2.71070764e-02,   8.35207708e-02,   6.87677164e-02,
         -2.59829147e-02,  -2.71315763e-02],
       [ -3.08697046e-02,   5.74809046e-02,  -6.19650701e-02,
         -1.07324372e-01,   2.12246475e-05,   5.54173989e-02,
         -2.66923934e-02,  -4.62262462e-02,   4.97833344e-06,
         -4.81282305e-03,  -4.45820116e-06,  -2.51420652e-06,
         -2.86987262e-03,   4.97036816e-03,  -1.87386954e-02,
         -2.59810140e-02,  -1.87433042e-02,  -2.59829147e-02,
          1.06200445e-01,   8.35169398e-02],
       [ -9.02492061e-03,   2.65732345e-02,  -5.43185931e-02,
         -9.40659266e-02,   1.85860746e-05,   2.53378392e-02,
         -2.33983060e-02,  -4.05147886e-02,   3.84343288e-06,
         -2.21232599e-03,  -2.84986340e-06,  -1.81350676e-06,
         -2.51610822e-03,   4.35671434e-03,  -2.60010682e-02,
         -2.71369975e-02,  -2.59984517e-02,  -2.71315763e-02,
          8.35169398e-02,   6.88387228e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_gga.py")

    l = {}
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], l[k], v), l[k] - l[var_name]
