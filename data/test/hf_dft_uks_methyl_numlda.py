# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_dm_alpha = array([[  1.03043133e+00,  -3.95371872e-02,  -1.42706272e-05,
         -6.30319952e-06,   4.26716761e-06,  -1.12431358e-01,
          6.27786796e-06,  -9.50040256e-06,   6.78753475e-06,
          2.13681166e-03,   3.82286782e-06,   3.17807013e-06,
         -2.34778496e-06,   6.06448848e-06,  -2.92577958e-02,
         -4.73234267e-03,  -2.92587484e-02,  -4.71851677e-03,
         -2.92795103e-02,  -4.70274679e-03],
       [ -3.95371872e-02,   1.56867302e-01,   5.60106572e-05,
         -9.93427226e-06,   3.45070962e-06,   1.64040438e-01,
          2.78489929e-06,   7.38821536e-06,  -1.90898474e-06,
         -4.06118806e-03,  -7.43097277e-06,  -5.90494535e-06,
          6.46383206e-06,  -1.11574232e-05,   5.28800059e-02,
          1.98051399e-02,   5.28447114e-02,   1.97471275e-02,
          5.29083672e-02,   1.97365594e-02],
       [ -1.42706272e-05,   5.60106572e-05,   2.06291436e-01,
         -1.89644692e-05,   1.13310449e-05,  -7.59187576e-06,
          9.62875216e-02,   2.59837644e-05,   1.45159954e-05,
          1.39863724e-06,   1.04538274e-05,   1.74047995e-05,
          9.00195212e-03,   1.86642639e-05,   1.20287850e-01,
          1.04169133e-01,  -6.01590865e-02,  -5.21150950e-02,
         -6.01685052e-02,  -5.20229366e-02],
       [ -6.30319952e-06,  -9.93427226e-06,  -1.89644692e-05,
          2.06215935e-01,   2.25553155e-06,   3.49750512e-05,
         -7.79335509e-05,   9.62625661e-02,   7.30054466e-06,
         -2.16318749e-05,   2.16349662e-05,   1.29497688e-05,
          1.17283978e-05,  -8.99912824e-03,   3.10966358e-07,
          5.58273021e-05,   1.04150425e-01,   9.01655443e-02,
         -1.04287921e-01,  -9.01572762e-02],
       [  4.26716761e-06,   3.45070962e-06,   1.13310449e-05,
          2.25553155e-06,   3.54831002e-01,  -1.99835744e-05,
         -3.79430714e-05,   3.88758226e-06,   3.17253666e-01,
         -4.65133600e-06,   2.73608480e-06,  -9.08052220e-06,
          9.93928819e-06,   2.28318188e-05,   4.26405663e-06,
          5.31434317e-05,   3.44543751e-05,  -2.31077919e-05,
          1.01593050e-04,  -8.66653807e-05],
       [ -1.12431358e-01,   1.64040438e-01,  -7.59187576e-06,
          3.49750512e-05,  -1.99835744e-05,   1.76493522e-01,
         -2.84733766e-05,   2.91363375e-05,  -2.32095285e-05,
         -4.32444861e-03,  -7.90544539e-06,  -6.29485302e-06,
          3.92391407e-06,  -1.38542721e-05,   5.63691738e-02,
          2.06593067e-02,   5.64134274e-02,   2.06683831e-02,
          5.64350950e-02,   2.06172675e-02],
       [  6.27786796e-06,   2.78489929e-06,   9.62875216e-02,
         -7.79335509e-05,  -3.79430714e-05,  -2.84733766e-05,
          4.49426966e-02,  -2.01218182e-05,  -3.18791483e-05,
          1.27313099e-06,   4.87291346e-06,   8.12143347e-06,
          4.20169857e-03,   1.17252719e-05,   5.61369501e-02,
          4.86184735e-02,  -2.81224193e-02,  -2.43581145e-02,
         -2.80570058e-02,  -2.42546810e-02],
       [ -9.50040256e-06,   7.38821536e-06,   2.59837644e-05,
          9.62625661e-02,   3.88758226e-06,   2.91363375e-05,
         -2.01218182e-05,   4.49358244e-02,   5.94277058e-06,
         -1.04125984e-05,   1.01005151e-05,   6.04742123e-06,
          6.99541822e-06,  -4.20083299e-03,   2.45613564e-05,
          4.51659025e-05,   4.86118548e-02,   4.20824129e-02,
         -4.86881436e-02,  -4.20931151e-02],
       [  6.78753475e-06,  -1.90898474e-06,   1.45159954e-05,
          7.30054466e-06,   3.17253666e-01,  -2.32095285e-05,
         -3.18791483e-05,   5.94277058e-06,   2.83655848e-01,
         -4.02808276e-06,   2.44734435e-06,  -8.11798329e-06,
          9.07823509e-06,   2.01840503e-05,   4.66002173e-06,
          4.91020005e-05,   3.04853579e-05,  -2.00869836e-05,
          8.51707466e-05,  -8.15318812e-05],
       [  2.13681166e-03,  -4.06118806e-03,   1.39863724e-06,
         -2.16318749e-05,  -4.65133600e-06,  -4.32444861e-03,
          1.27313099e-06,  -1.04125984e-05,  -4.02808276e-06,
          1.06358230e-04,   1.92323735e-07,   1.53701603e-07,
         -4.52650912e-08,   1.24716246e-06,  -1.38474581e-03,
         -5.11027874e-04,  -1.39738368e-03,  -5.21243219e-04,
         -1.37692286e-03,  -5.01821280e-04],
       [  3.82286782e-06,  -7.43097277e-06,   1.04538274e-05,
          2.16349662e-05,   2.73608480e-06,  -7.90544539e-06,
          4.87291346e-06,   1.01005151e-05,   2.44734435e-06,
          1.92323735e-07,   3.17676428e-09,   2.45403795e-09,
          4.57372624e-07,  -9.42500011e-07,   3.56226358e-06,
          4.34941789e-06,   5.34307445e-06,   5.88241246e-06,
         -1.65285347e-05,  -1.30317207e-05],
       [  3.17807013e-06,  -5.90494535e-06,   1.74047995e-05,
          1.29497688e-05,  -9.08052220e-06,  -6.29485302e-06,
          8.12143347e-06,   6.04742123e-06,  -8.11798329e-06,
          1.53701603e-07,   2.45403795e-09,   2.73967052e-09,
          7.59888542e-07,  -5.63759743e-07,   8.13238453e-06,
          8.04710390e-06,  -5.53532414e-07,   5.22024251e-07,
         -1.36490936e-05,  -1.07930433e-05],
       [ -2.34778496e-06,   6.46383206e-06,   9.00195212e-03,
          1.17283978e-05,   9.93928819e-06,   3.92391407e-06,
          4.20169857e-03,   6.99541822e-06,   9.07823509e-06,
         -4.52650912e-08,   4.57372624e-07,   7.59888542e-07,
          3.92819861e-04,   2.66831379e-07,   5.25037448e-03,
          4.54614679e-03,  -2.61745773e-03,  -2.26815416e-03,
         -2.63055677e-03,  -2.27511416e-03],
       [  6.06448848e-06,  -1.11574232e-05,   1.86642639e-05,
         -8.99912824e-03,   2.28318188e-05,  -1.38542721e-05,
          1.17252719e-05,  -4.20083299e-03,   2.01840503e-05,
          1.24716246e-06,  -9.42500011e-07,  -5.63759743e-07,
          2.66831379e-07,   3.92719947e-04,   6.43540885e-06,
          5.11239470e-06,  -4.55420744e-03,  -3.94073235e-03,
          4.54190340e-03,   3.92844135e-03],
       [ -2.92577958e-02,   5.28800059e-02,   1.20287850e-01,
          3.10966358e-07,   4.26405663e-06,   5.63691738e-02,
          5.61369501e-02,   2.45613564e-05,   4.66002173e-06,
         -1.38474581e-03,   3.56226358e-06,   8.13238453e-06,
          5.25037448e-03,   6.43540885e-06,   8.81919657e-02,
          6.73992954e-02,  -1.70139122e-02,  -2.37283836e-02,
         -1.70126190e-02,  -2.36911654e-02],
       [ -4.73234267e-03,   1.98051399e-02,   1.04169133e-01,
          5.58273021e-05,   5.31434317e-05,   2.06593067e-02,
          4.86184735e-02,   4.51659025e-05,   4.91020005e-05,
         -5.11027874e-04,   4.34941789e-06,   8.04710390e-06,
          4.54614679e-03,   5.11239470e-06,   6.73992954e-02,
          5.50947885e-02,  -2.36839831e-02,  -2.37955047e-02,
         -2.37480815e-02,  -2.38085965e-02],
       [ -2.92587484e-02,   5.28447114e-02,  -6.01590865e-02,
          1.04150425e-01,   3.44543751e-05,   5.64134274e-02,
         -2.81224193e-02,   4.86118548e-02,   3.04853579e-05,
         -1.39738368e-03,   5.34307445e-06,  -5.53532414e-07,
         -2.61745773e-03,  -4.55420744e-03,  -1.70139122e-02,
         -2.36839831e-02,   8.82051351e-02,   6.73887756e-02,
         -1.70411045e-02,  -2.37128209e-02],
       [ -4.71851677e-03,   1.97471275e-02,  -5.21150950e-02,
          9.01655443e-02,  -2.31077919e-05,   2.06683831e-02,
         -2.43581145e-02,   4.20824129e-02,  -2.00869836e-05,
         -5.21243219e-04,   5.88241246e-06,   5.22024251e-07,
         -2.26815416e-03,  -3.94073235e-03,  -2.37283836e-02,
         -2.37955047e-02,   6.73887756e-02,   5.50759951e-02,
         -2.37345230e-02,  -2.37895959e-02],
       [ -2.92795103e-02,   5.29083672e-02,  -6.01685052e-02,
         -1.04287921e-01,   1.01593050e-04,   5.64350950e-02,
         -2.80570058e-02,  -4.86881436e-02,   8.51707466e-05,
         -1.37692286e-03,  -1.65285347e-05,  -1.36490936e-05,
         -2.63055677e-03,   4.54190340e-03,  -1.70126190e-02,
         -2.37480815e-02,  -1.70411045e-02,  -2.37345230e-02,
          8.83974015e-02,   6.74300307e-02],
       [ -4.70274679e-03,   1.97365594e-02,  -5.20229366e-02,
         -9.01572762e-02,  -8.66653807e-05,   2.06172675e-02,
         -2.42546810e-02,  -4.20931151e-02,  -8.15318812e-05,
         -5.01821280e-04,  -1.30317207e-05,  -1.07930433e-05,
         -2.27511416e-03,   3.92844135e-03,  -2.36911654e-02,
         -2.38085965e-02,  -2.37128209e-02,  -2.37895959e-02,
          6.74300307e-02,   5.50257800e-02]])
    ref_result_energy = -39.414276667007648
    ref_result_exp_alpha = array([[  9.93910091e-01,  -2.06334825e-01,  -3.02176292e-05,
          3.36955369e-05,  -1.29863094e-05,   1.56679647e-01,
         -1.19771291e-04,  -2.69570761e-05,  -8.13223020e-06,
          2.71141544e-05,  -3.60103517e-05,  -4.67734605e-02,
         -1.98749895e-05,  -2.91706250e-06,   3.94389535e-02,
          5.44825628e-06,   8.02866359e-07,   4.01603326e-02,
          7.58809706e-05,   5.23784203e-05],
       [  4.19800769e-02,   3.93833663e-01,   1.30147075e-04,
         -1.02781141e-04,   4.53445215e-06,  -2.62855068e-01,
          2.92693504e-04,   1.14535819e-04,  -1.21478034e-04,
          3.58134373e-04,  -5.25395262e-04,  -7.33680272e-01,
          2.44820524e-03,  -3.31435041e-03,  -1.92219332e+00,
         -1.23684086e-04,  -1.04211784e-04,   2.75842649e-01,
          2.75083562e-04,   1.41644920e-04],
       [ -3.30023713e-07,  -2.73117857e-05,   1.85898060e-01,
         -4.14407227e-01,  -7.28270075e-05,  -2.61978872e-04,
         -4.48666361e-01,   1.09115977e-02,  -7.59885631e-04,
         -7.72777509e-01,  -3.47846704e-01,   2.74671430e-05,
         -6.11191963e-01,  -3.97552116e-01,  -1.50373728e-04,
         -1.40362968e-05,  -5.98717680e-05,  -3.71750831e-05,
          5.19687397e-02,   3.35394178e-02],
       [  4.70119598e-07,   6.32262739e-05,  -4.14348508e-01,
         -1.85825842e-01,  -7.08590931e-05,  -1.46514586e-06,
          1.08009394e-02,   4.48872759e-01,   4.15728263e-05,
         -3.47067192e-01,   7.73009484e-01,  -1.97894697e-03,
         -3.98318102e-01,   6.10741962e-01,  -1.05835983e-03,
          7.63473794e-05,   5.92915813e-05,   1.24941264e-06,
         -3.35489489e-02,   5.20746452e-02],
       [ -2.43626136e-07,   1.56968152e-05,   5.14015490e-05,
          1.00397050e-04,  -5.95676927e-01,   3.58391055e-05,
         -7.17634427e-05,   7.79498443e-05,   1.06104441e+00,
         -8.20639971e-04,  -5.33183654e-04,  -2.86183740e-05,
          3.15053318e-05,   9.37204165e-05,  -6.01263032e-05,
          3.36653972e-05,   1.45771527e-05,  -5.26373455e-06,
         -3.37208153e-05,   1.56191068e-05],
       [ -2.60736614e-02,   4.19301427e-01,  -1.37425666e-05,
         -1.54921143e-05,   4.44140758e-05,  -1.85139743e+00,
          1.19863857e-03,   1.72971964e-04,   3.09556061e-04,
         -5.53598804e-04,   5.62785900e-04,   1.15250035e+00,
         -4.38532706e-03,   5.80690020e-03,   3.55771011e+00,
          2.57416546e-04,   1.53570790e-04,  -7.87373204e-01,
         -9.44344690e-04,  -6.42972868e-04],
       [  5.32262035e-07,  -7.21613026e-05,   8.69077071e-02,
         -1.93364267e-01,   3.86045832e-05,  -1.03877566e-03,
         -1.26408401e+00,   3.07710120e-02,   1.46364158e-03,
          1.58618663e+00,   7.13871357e-01,   7.71535445e-05,
          9.17162968e-01,   5.95873791e-01,   1.03711070e-04,
         -3.98982159e-04,  -8.90348885e-05,  -1.01180056e-03,
          4.45208879e-01,   2.86839293e-01],
       [ -3.50215068e-08,   6.00253537e-05,  -1.93388475e-01,
         -8.68142441e-02,  -3.78444240e-05,   4.34543210e-04,
          3.08670643e-02,   1.26369402e+00,  -2.92826890e-04,
          7.12822979e-01,  -1.58684472e+00,   3.23989902e-03,
          5.97721777e-01,  -9.16129570e-01,   1.67255486e-03,
         -2.28852739e-05,  -4.30117851e-04,  -1.01037813e-04,
         -2.86914705e-01,   4.45242074e-01],
       [  1.29215638e-07,   1.29121925e-06,   3.92902955e-05,
          7.61934454e-05,  -5.32593494e-01,  -6.24875901e-05,
          4.48842212e-05,  -8.62644787e-05,  -1.09407054e+00,
          8.13996697e-04,   5.93301661e-04,   1.39188829e-04,
          6.09058474e-05,  -1.21878648e-04,   2.28708600e-05,
         -2.52854770e-05,   6.20671776e-07,  -6.81903873e-06,
         -2.50381822e-06,  -1.50263893e-05],
       [  8.95614028e-06,  -1.03129046e-02,   4.31439203e-05,
          1.66580366e-05,   7.51782563e-06,  -1.22165491e-02,
          3.27048826e-05,  -4.08972930e-06,   1.30176944e-05,
         -5.15390727e-05,   8.06587068e-05,   1.83180519e-01,
         -8.93990467e-05,   3.55159495e-04,  -3.39749831e-02,
         -1.74596529e-04,   1.38483737e-04,   1.05121190e+00,
          1.41172356e-03,   1.20848791e-03],
       [ -6.87966125e-08,  -1.88601822e-05,  -3.40460459e-05,
         -4.05159057e-05,  -4.60518166e-06,  -2.50356690e-05,
         -4.62742602e-06,  -1.48571684e-05,  -1.36300252e-05,
         -2.01502859e-05,   6.33602739e-05,   1.76577474e-04,
          9.63941865e-05,  -1.61164474e-05,  -4.53264150e-05,
          6.70642300e-01,  -7.41780668e-01,   1.76192540e-04,
          4.16212111e-04,  -2.99651397e-04],
       [  8.26893252e-08,  -1.50112010e-05,  -1.03573667e-05,
         -4.66471452e-05,   1.52683382e-05,  -1.65150495e-05,
         -3.31847728e-05,  -2.24439778e-05,  -2.41496993e-05,
         -4.56829975e-05,   9.55446868e-05,   4.70914983e-05,
          1.77593175e-04,  -2.30518434e-04,  -9.90317274e-05,
          7.41780614e-01,   6.70642215e-01,   2.21630540e-05,
          2.52427425e-04,   6.02030895e-04],
       [  3.61072766e-07,   8.97917891e-06,   8.08679805e-03,
         -1.80948426e-02,  -1.90374147e-05,  -2.21846599e-05,
          2.12365538e-02,  -5.38103395e-04,  -1.03858394e-04,
         -1.01350763e-01,  -4.54235586e-02,   9.04108762e-05,
          1.72731185e-01,   1.12533247e-01,  -1.10588114e-04,
         -5.82157841e-04,  -2.33449137e-04,  -1.94310214e-03,
          9.10844443e-01,   5.87021295e-01],
       [ -3.01045807e-07,  -3.21729718e-05,   1.80979571e-02,
          8.07351867e-03,  -3.54076226e-05,  -6.35937243e-06,
          4.87506623e-04,   2.13133128e-02,  -1.86013937e-05,
          4.56124626e-02,  -1.01346777e-01,   1.46411223e-05,
         -1.12488555e-01,   1.72924581e-01,  -3.71020887e-04,
          1.86965101e-05,   6.84302963e-04,   1.84986947e-04,
          5.86996320e-01,  -9.10820717e-01],
       [ -1.53776855e-03,   1.34334942e-01,   1.08394037e-01,
         -2.41649458e-01,  -3.49700712e-05,   1.03485998e-01,
          1.23585219e-01,  -3.08549525e-03,  -4.39755646e-04,
         -3.65810541e-01,  -1.64776269e-01,  -6.28085655e-01,
          7.43050537e-01,   4.83875243e-01,   3.11051741e-01,
          3.79165574e-04,   1.73044070e-04,   3.77229361e-01,
         -5.76354882e-01,  -3.71389617e-01],
       [  5.54782958e-03,   4.96111055e-02,   9.37473259e-02,
         -2.09318317e-01,  -1.15020524e-04,   9.60882243e-01,
          1.62502853e+00,  -3.96787304e-02,  -3.97421337e-04,
         -4.83766955e-01,  -2.18005844e-01,   1.74941873e-01,
         -1.29809323e+00,  -8.46588592e-01,  -1.09937665e+00,
          1.89152409e-05,  -5.19710915e-05,   6.34820044e-02,
         -4.29952004e-03,  -2.74814716e-03],
       [ -1.53768244e-03,   1.34438300e-01,  -2.63440554e-01,
          2.69839007e-02,  -7.24594857e-05,   1.03219799e-01,
         -6.44193983e-02,  -1.05530283e-01,   3.02417211e-04,
          4.04883513e-02,   3.98236551e-01,  -6.26812410e-01,
          4.75549581e-02,  -8.86040251e-01,   3.11911818e-01,
         -3.48550900e-04,   1.40088028e-04,   3.75768678e-01,
          6.11285932e-01,  -3.13548786e-01],
       [  5.54816795e-03,   4.96309252e-02,  -2.28107446e-01,
          2.34285684e-02,   2.44422102e-05,   9.58682427e-01,
         -8.47993093e-01,  -1.38806169e+00,   1.50287652e-04,
          5.39156072e-02,   5.29231468e-01,   1.72238128e-01,
         -8.22831390e-02,   1.54632775e+00,  -1.10125225e+00,
          5.20869845e-05,   1.81907649e-04,   6.32000796e-02,
          4.45505869e-03,  -2.23038883e-03],
       [ -1.53721751e-03,   1.34510518e-01,   1.55347665e-01,
          2.14870023e-01,  -1.17363027e-04,   1.03374889e-01,
         -5.94260361e-02,   1.08508463e-01,   2.33037205e-06,
          3.26386062e-01,  -2.35274907e-01,  -6.28447064e-01,
         -7.90353477e-01,   4.01065602e-01,   3.09404997e-01,
          2.20527173e-04,  -3.43551081e-04,   3.75228025e-01,
         -3.28480645e-02,   6.86103961e-01],
       [  5.54791953e-03,   4.95266146e-02,   1.34282122e-01,
          1.85769900e-01,   1.89769784e-04,   9.59283605e-01,
         -7.79006078e-01,   1.42739022e+00,   3.19973085e-05,
          4.29484748e-01,  -3.10122208e-01,   1.77053852e-01,
          1.38350024e+00,  -7.03143708e-01,  -1.09691711e+00,
         -4.33730581e-04,  -1.86873422e-04,   6.34637877e-02,
         -3.02154763e-04,   5.06375302e-03]])
    ref_result_exp_beta = array([[  9.94136245e-01,  -1.99396440e-01,   2.87309112e-05,
         -3.72424936e-05,  -1.17777880e-05,   1.62572570e-01,
          1.42830901e-04,  -2.94621762e-05,   3.30536020e-05,
          4.48488967e-05,   5.99189833e-06,   5.46603094e-02,
         -5.75625546e-07,  -3.69502131e-05,   4.10264124e-02,
         -4.36626494e-06,   5.01602153e-08,  -3.41949602e-02,
         -9.35313012e-05,   7.01208504e-05],
       [  4.02094139e-02,   3.74382359e-01,  -1.24948685e-04,
          1.12034860e-04,   1.34898988e-06,  -2.54137480e-01,
         -3.07131819e-04,   1.09523597e-04,   3.28825895e-04,
          4.59616875e-04,   9.69340528e-05,   6.33239724e-01,
          1.68805298e-03,  -2.43041749e-03,  -1.95766524e+00,
          1.10477809e-04,   9.92167055e-05,  -3.08805049e-01,
         -5.40232613e-04,   3.83811434e-04],
       [ -3.15015584e-07,  -3.31850823e-05,  -1.60975783e-01,
          4.00842268e-01,  -5.45810493e-05,  -3.21178385e-04,
          4.43349642e-01,   1.60989121e-02,  -7.50493610e-01,
          3.66014591e-01,  -1.98462870e-03,  -7.00518682e-05,
         -6.40849746e-01,  -4.07811733e-01,  -1.04366536e-04,
          2.03594131e-05,   5.39396138e-05,   9.97773829e-05,
         -5.09493477e-02,   3.33492458e-02],
       [  5.16157817e-07,   6.54817085e-05,   4.00787275e-01,
          1.60904133e-01,  -4.95733779e-05,   6.66470402e-06,
         -1.59873016e-02,   4.43545447e-01,  -3.65179470e-01,
         -7.50792015e-01,   1.35058960e-04,   2.15157015e-03,
         -4.08605989e-01,   6.40380455e-01,  -6.66752163e-04,
         -6.72590859e-05,  -4.64501765e-05,   7.43620329e-06,
          3.33573438e-02,   5.10570622e-02],
       [ -4.72331864e-08,   2.59508010e-05,  -4.81706434e-05,
         -8.81726520e-05,  -5.45814756e-01,   4.31001843e-05,
          7.09866035e-05,   7.78398703e-05,   2.26505774e-03,
         -1.17326417e-03,  -1.08753250e+00,   1.40608302e-05,
          2.42586439e-05,   1.15679512e-04,  -5.19996585e-05,
         -3.08928731e-05,  -1.42606152e-05,   1.04855058e-05,
          3.41414055e-05,   1.61773170e-05],
       [ -2.46028578e-02,   3.77570700e-01,   3.03072363e-05,
          6.65642312e-06,   1.39926894e-06,  -1.91256654e+00,
         -1.49039652e-03,   2.04661263e-04,  -5.14768233e-04,
         -4.93482889e-04,  -2.43699892e-04,  -1.02290064e+00,
         -2.95790244e-03,   4.17812135e-03,   3.56624828e+00,
         -2.35311292e-04,  -1.52559991e-04,   8.02605899e-01,
          1.54953081e-03,  -1.20407158e-03],
       [  5.18751369e-07,  -7.99068857e-05,  -7.21216730e-02,
          1.79160848e-01,   7.72874126e-05,  -1.20988586e-03,
          1.29917908e+00,   4.71862497e-02,   1.52948386e+00,
         -7.45790586e-01,   4.10308048e-03,  -1.53038152e-05,
          9.40623821e-01,   5.97869683e-01,   3.93782844e-05,
          4.18367589e-04,   9.28595204e-05,   1.52731157e-03,
         -4.43752292e-01,   2.89945146e-01],
       [ -6.20062875e-08,   6.53834274e-05,   1.79198661e-01,
          7.20271963e-02,  -7.56652659e-06,   4.63938790e-04,
         -4.72811443e-02,   1.29879740e+00,   7.44699166e-01,
          1.53022324e+00,  -9.08709607e-05,  -3.43936887e-03,
          5.99758459e-01,  -9.39569140e-01,   1.05645546e-03,
          2.51754655e-07,   4.51886557e-04,   1.96687470e-04,
          2.90023138e-01,   4.43785397e-01],
       [  5.81326883e-08,   7.02642938e-06,  -3.96684932e-05,
         -6.97118592e-05,  -5.82773076e-01,  -3.43707455e-05,
         -1.18107433e-05,  -5.37281990e-05,  -2.26271223e-03,
          1.10549538e-03,   1.06818369e+00,  -1.25649816e-04,
          6.81206710e-05,  -1.40404769e-04,   1.70866183e-05,
          2.39118453e-05,  -5.26372227e-07,   4.27338307e-06,
          2.26978759e-06,  -1.45875644e-05],
       [ -5.54742958e-04,  -2.53851574e-02,  -3.96111567e-05,
         -1.67836350e-05,   2.08227307e-06,   7.05341689e-03,
         -1.43240334e-05,  -8.38242631e-06,  -4.85168561e-05,
         -7.30708850e-05,  -1.34526143e-05,  -1.64366897e-01,
         -1.06753191e-04,   3.73915326e-04,  -4.98107908e-03,
          1.71508274e-04,  -1.34481039e-04,  -1.05464242e+00,
         -2.18265357e-03,   1.93934594e-03],
       [ -1.74817497e-07,  -2.31437076e-05,   3.40237452e-05,
          3.95423670e-05,  -5.80802909e-06,  -1.90502715e-05,
          8.09767121e-06,  -1.32765570e-05,  -2.26763584e-05,
         -6.08768595e-05,   1.21604648e-05,  -1.68097962e-04,
          8.55149711e-05,  -1.63382898e-05,  -2.84373416e-05,
         -6.68951588e-01,   7.43305699e-01,  -1.76440408e-04,
         -4.74967697e-04,  -3.29861130e-04],
       [ -3.59120461e-08,  -1.92904894e-05,   1.56796371e-05,
          4.60274646e-05,   1.29778755e-05,  -1.12614068e-05,
          3.20888465e-05,  -1.69825100e-05,  -5.18302240e-05,
         -9.44344270e-05,   2.33483987e-05,  -4.62416938e-05,
          1.61962703e-04,  -2.09779473e-04,  -8.83831678e-05,
         -7.43305662e-01,  -6.68951497e-01,  -2.59021486e-05,
         -2.69350713e-04,   6.46382888e-04],
       [  3.52873638e-07,   7.22985113e-06,  -7.18347332e-03,
          1.79638814e-02,  -1.86325173e-05,  -2.19607212e-05,
         -1.80709363e-02,  -6.75650267e-04,  -1.02062896e-01,
          4.95653042e-02,  -2.63638767e-04,  -9.67754482e-05,
          1.67442041e-01,   1.06729046e-01,  -1.23977385e-04,
          6.36378456e-04,   2.40125153e-04,   3.00853210e-03,
         -9.08091564e-01,   5.93525295e-01],
       [ -3.09080451e-07,  -3.39231924e-05,  -1.79674369e-02,
         -7.17230208e-03,  -3.60470097e-05,  -3.72941614e-06,
         -6.27232652e-04,   1.81475086e-02,   4.97567125e-02,
          1.02050945e-01,  -2.41083938e-06,  -7.17041856e-06,
         -1.06682122e-01,   1.67635778e-01,  -2.29103451e-04,
          9.18636401e-06,  -7.46689447e-04,  -3.76907739e-04,
         -5.93503918e-01,  -9.08069689e-01],
       [ -1.54391208e-03,   1.45330124e-01,  -1.03262382e-01,
          2.57148747e-01,  -3.45543259e-05,   9.06335174e-02,
         -1.09760841e-01,  -4.06522386e-03,  -3.80783687e-01,
          1.85825610e-01,  -9.22586509e-04,   6.49164803e-01,
          7.41222906e-01,   4.71870210e-01,   2.86439445e-01,
         -4.05961431e-04,  -1.66834838e-04,  -3.60469800e-01,
          5.68943368e-01,  -3.71732880e-01],
       [  5.23600672e-03,   7.05790710e-02,  -9.52405110e-02,
          2.37528530e-01,  -1.30910122e-04,   9.78325074e-01,
         -1.64183547e+00,  -5.97855854e-02,  -4.30675681e-01,
          2.10293276e-01,  -1.21342854e-03,  -2.14746381e-01,
         -1.30189342e+00,  -8.29811353e-01,  -1.07497283e+00,
         -2.35988599e-05,   4.54943365e-05,  -7.41071318e-02,
          7.27985028e-03,  -4.71790021e-03],
       [ -1.54382968e-03,   1.45442016e-01,   2.74273678e-01,
         -3.91728401e-02,  -6.69459236e-05,   9.03695921e-02,
          5.83585043e-02,  -9.30783704e-02,   2.98171624e-02,
         -4.21657121e-01,   4.20742021e-04,   6.47802465e-01,
          3.85282585e-02,  -8.78751275e-01,   2.86943838e-01,
          3.68338524e-04,  -1.84280012e-04,  -3.58103909e-01,
         -6.08432560e-01,  -3.06817149e-01],
       [  5.23634907e-03,   7.06061923e-02,   2.53248309e-01,
         -3.62403709e-02,   4.05009079e-05,   9.75800291e-01,
          8.74001456e-01,  -1.39270399e+00,   3.39936246e-02,
         -4.79498776e-01,   7.67421751e-04,  -2.11831521e-01,
         -6.70561013e-02,   1.54173509e+00,  -1.07620735e+00,
         -4.29752158e-05,  -1.65452164e-04,  -7.38304053e-02,
         -7.80902683e-03,  -3.79769299e-03],
       [ -1.54335922e-03,   1.45520007e-01,  -1.71345686e-01,
         -2.18156343e-01,  -1.18587526e-04,   9.05057717e-02,
          5.16622610e-02,   9.70155833e-02,   3.52131181e-01,
          2.37754918e-01,   6.07352271e-04,   6.49517972e-01,
         -7.78998201e-01,   4.04946686e-01,   2.85338969e-01,
         -1.89841416e-04,   3.83712217e-04,  -3.57389045e-01,
          3.66940805e-02,   6.80413738e-01],
       [  5.23607765e-03,   7.04930863e-02,  -1.57954302e-01,
         -2.01141846e-01,   2.77129165e-04,   9.76469909e-01,
          7.70215288e-01,   1.45211866e+00,   3.96214675e-01,
          2.67997739e-01,   6.17514276e-04,  -2.16882686e-01,
          1.37065005e+00,  -7.13537728e-01,  -1.07344523e+00,
          3.97441643e-04,   1.77538020e-04,  -7.40597067e-02,
          4.68967751e-04,   8.77538366e-03]])
    ref_result_dm_beta = array([[  1.02806582e+00,  -3.46768943e-02,  -1.32474030e-05,
         -7.00700013e-06,  -5.20968926e-06,  -9.97448358e-02,
          7.70601686e-06,  -1.06329141e-05,  -1.33310143e-06,
          4.51021941e-03,   4.44047977e-06,   3.80948777e-06,
         -1.96630275e-06,   6.20750848e-06,  -3.05257142e-02,
         -8.87949351e-03,  -3.05260603e-02,  -8.86433897e-03,
         -3.05472810e-02,  -8.84775481e-03],
       [ -3.46768943e-02,   1.41779014e-01,   5.25795835e-05,
         -7.53864548e-06,   9.68694683e-06,   1.40366542e-01,
         -8.14121515e-07,   1.01528567e-05,   2.61553936e-06,
         -9.52605877e-03,  -8.67143441e-06,  -7.22026031e-06,
          5.63121415e-06,  -1.12708146e-05,   5.43886777e-02,
          2.66726086e-02,   5.43502005e-02,   2.66085374e-02,
          5.44150462e-02,   2.65991336e-02],
       [ -1.32474030e-05,   5.25795835e-05,   1.86587757e-01,
         -1.98281291e-05,  -2.75898175e-05,  -1.47431272e-05,
          8.34250733e-02,   2.49694446e-05,  -2.15579966e-05,
          4.91993281e-07,   1.03674501e-05,   1.59263520e-05,
          8.35704954e-03,   1.73711048e-05,   1.19694028e-01,
          1.10540553e-01,  -5.98583976e-02,  -5.52958917e-02,
         -5.98686016e-02,  -5.52016437e-02],
       [ -7.00700013e-06,  -7.53864548e-06,  -1.98281291e-05,
          1.86520618e-01,  -3.34918048e-05,   3.78442422e-05,
         -7.76615544e-05,   8.34100128e-02,  -2.71150924e-05,
         -2.02432369e-05,   1.99973032e-05,   1.36823786e-05,
          1.14089432e-05,  -8.35517828e-03,  -4.27288010e-07,
          5.27532793e-05,   1.03631899e-01,   9.56721481e-02,
         -1.03765883e-01,  -9.56659644e-02],
       [ -5.20968926e-06,   9.68694683e-06,  -2.75898175e-05,
         -3.34918048e-05,   1.07650954e-08,   9.77452247e-06,
         -1.23249872e-05,  -1.49812428e-05,   8.23842287e-09,
         -6.53807639e-07,  -5.72370468e-09,  -5.31190380e-09,
         -1.23769861e-06,   1.49702303e-06,  -1.39365444e-05,
         -1.45286415e-05,  -5.99239121e-06,  -7.17599099e-06,
          3.12568082e-05,   2.71687298e-05],
       [ -9.97448358e-02,   1.40366542e-01,  -1.47431272e-05,
          3.78442422e-05,   9.77452247e-06,   1.43164901e-01,
         -3.11816286e-05,   3.05696731e-05,   2.63518492e-06,
         -9.57104312e-03,  -8.73278086e-06,  -7.28185801e-06,
          2.62289353e-06,  -1.33899520e-05,   5.49089572e-02,
          2.65184547e-02,   5.49606428e-02,   2.65373748e-02,
          5.49754503e-02,   2.64812263e-02],
       [  7.70601686e-06,  -8.14121515e-07,   8.34250733e-02,
         -7.76615544e-05,  -1.23249872e-05,  -3.11816286e-05,
          3.73001343e-02,  -1.96032156e-05,  -9.62922808e-06,
          1.87828935e-06,   4.62951013e-06,   7.11702366e-06,
          3.73650732e-03,   1.08505148e-05,   5.35068222e-02,
          4.94190683e-02,  -2.68109105e-02,  -2.47631651e-02,
         -2.67389861e-02,  -2.46504499e-02],
       [ -1.06329141e-05,   1.01528567e-05,   2.49694446e-05,
          8.34100128e-02,  -1.49812428e-05,   3.05696731e-05,
         -1.96032156e-05,   3.73000673e-02,  -1.21292347e-05,
         -9.96946626e-06,   8.94362286e-06,   6.12080380e-06,
          6.61776338e-06,  -3.73634392e-03,   2.67665632e-05,
          4.61856237e-05,   4.63374705e-02,   4.27760770e-02,
         -4.64085859e-02,  -4.27882556e-02],
       [ -1.33310143e-06,   2.61553936e-06,  -2.15579966e-05,
         -2.71150924e-05,   8.23842287e-09,   2.63518492e-06,
         -9.62922808e-06,  -1.21292347e-05,   6.48215181e-09,
         -1.74670730e-07,  -4.26720807e-09,  -3.96448397e-09,
         -9.67284554e-07,   1.21249731e-06,  -1.28146243e-05,
         -1.22870013e-05,  -7.13302980e-06,  -7.02593013e-06,
          2.30218229e-05,   2.07806356e-05],
       [  4.51021941e-03,  -9.52605877e-03,   4.91993281e-07,
         -2.02432369e-05,  -6.53807639e-07,  -9.57104312e-03,
          1.87828935e-06,  -9.96946626e-06,  -1.74670730e-07,
          6.44715748e-04,   5.85590563e-07,   4.88318302e-07,
         -2.00681962e-07,   1.69365116e-06,  -3.68859710e-03,
         -1.79477912e-03,  -3.70142238e-03,  -1.80467866e-03,
         -3.68274027e-03,  -1.78274841e-03],
       [  4.44047977e-06,  -8.67143441e-06,   1.03674501e-05,
          1.99973032e-05,  -5.72370468e-09,  -8.73278086e-06,
          4.62951013e-06,   8.94362286e-06,  -4.26720807e-09,
          5.85590563e-07,   3.25614296e-09,   2.79870760e-09,
          4.65462791e-07,  -8.94144383e-07,   3.28747861e-06,
          4.51373094e-06,   4.41915189e-06,   5.55037714e-06,
         -1.78217217e-05,  -1.49582517e-05],
       [  3.80948777e-06,  -7.22026031e-06,   1.59263520e-05,
          1.36823786e-05,  -5.31190380e-09,  -7.28185801e-06,
          7.11702366e-06,   6.12080380e-06,  -3.96448397e-09,
          4.88318302e-07,   2.79870760e-09,   2.73553738e-09,
          7.14056926e-07,  -6.10896308e-07,   7.41335588e-06,
          8.07780257e-06,  -3.11752864e-07,   9.37206867e-07,
         -1.55312547e-05,  -1.30913694e-05],
       [ -1.96630275e-06,   5.63121415e-06,   8.35704954e-03,
          1.14089432e-05,  -1.23769861e-06,   2.62289353e-06,
          3.73650732e-03,   6.61776338e-06,  -9.67284554e-07,
         -2.00681962e-07,   4.65462791e-07,   7.14056926e-07,
          3.74303458e-04,   2.26917410e-07,   5.36222359e-03,
          4.95160465e-03,  -2.67289018e-03,  -2.46971509e-03,
         -2.68701931e-03,  -2.47810886e-03],
       [  6.20750848e-06,  -1.12708146e-05,   1.73711048e-05,
         -8.35517828e-03,   1.49702303e-06,  -1.33899520e-05,
          1.08505148e-05,  -3.73634392e-03,   1.21249731e-06,
          1.69365116e-06,  -8.94144383e-07,  -6.10896308e-07,
          2.26917410e-07,   3.74272053e-04,   6.08892347e-06,
          5.21265580e-06,  -4.65197581e-03,  -4.29269931e-03,
          4.63838609e-03,   4.27828623e-03],
       [ -3.05257142e-02,   5.43886777e-02,   1.19694028e-01,
         -4.27288010e-07,  -1.39365444e-05,   5.49089572e-02,
          5.35068222e-02,   2.67665632e-05,  -1.28146243e-05,
         -3.68859710e-03,   3.28747861e-06,   7.41335588e-06,
          5.36222359e-03,   6.08892347e-06,   9.79118464e-02,
          8.11641141e-02,  -1.72559258e-02,  -2.52171007e-02,
         -1.72542326e-02,  -2.51759173e-02],
       [ -8.87949351e-03,   2.66726086e-02,   1.10540553e-01,
          5.27532793e-05,  -1.45286415e-05,   2.65184547e-02,
          4.94190683e-02,   4.61856237e-05,  -1.22870013e-05,
         -1.79477912e-03,   4.51373094e-06,   8.07780257e-06,
          4.95160465e-03,   5.21265580e-06,   8.11641141e-02,
          7.04993761e-02,  -2.51695779e-02,  -2.77169175e-02,
         -2.52366959e-02,  -2.77304842e-02],
       [ -3.05260603e-02,   5.43502005e-02,  -5.98583976e-02,
          1.03631899e-01,  -5.99239121e-06,   5.49606428e-02,
         -2.68109105e-02,   4.63374705e-02,  -7.13302980e-06,
         -3.70142238e-03,   4.41915189e-06,  -3.11752864e-07,
         -2.67289018e-03,  -4.65197581e-03,  -1.72559258e-02,
         -2.51695779e-02,   9.79164053e-02,   8.11400713e-02,
         -1.72827051e-02,  -2.51988282e-02],
       [ -8.86433897e-03,   2.66085374e-02,  -5.52958917e-02,
          9.56721481e-02,  -7.17599099e-06,   2.65373748e-02,
         -2.47631651e-02,   4.27760770e-02,  -7.02593013e-06,
         -1.80467866e-03,   5.55037714e-06,   9.37206867e-07,
         -2.46971509e-03,  -4.29269931e-03,  -2.52171007e-02,
         -2.77169175e-02,   8.11400713e-02,   7.04607860e-02,
         -2.52204175e-02,  -2.77075359e-02],
       [ -3.05472810e-02,   5.44150462e-02,  -5.98686016e-02,
         -1.03765883e-01,   3.12568082e-05,   5.49754503e-02,
         -2.67389861e-02,  -4.64085859e-02,   2.30218229e-05,
         -3.68274027e-03,  -1.78217217e-05,  -1.55312547e-05,
         -2.68701931e-03,   4.63838609e-03,  -1.72542326e-02,
         -2.52366959e-02,  -1.72827051e-02,  -2.52204175e-02,
          9.81299310e-02,   8.11951599e-02],
       [ -8.84775481e-03,   2.65991336e-02,  -5.52016437e-02,
         -9.56659644e-02,   2.71687298e-05,   2.64812263e-02,
         -2.46504499e-02,  -4.27882556e-02,   2.07806356e-05,
         -1.78274841e-03,  -1.49582517e-05,  -1.30913694e-05,
         -2.47810886e-03,   4.27828623e-03,  -2.51759173e-02,
         -2.77304842e-02,  -2.51988282e-02,  -2.77075359e-02,
          8.11951599e-02,   7.04042074e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_numlda.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
