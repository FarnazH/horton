# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_uks_methyl_numgga():
    ref_result_dm_alpha = array([[  1.03149386e+00,  -4.57991299e-02,   4.81014885e-06,
         -5.99621598e-06,  -1.74505590e-05,  -1.09572211e-01,
          7.05724822e-06,   1.11755975e-06,  -1.25379655e-05,
          1.55193915e-03,  -2.90833363e-06,  -2.70490516e-06,
         -4.19484572e-06,   6.98163112e-06,  -2.92086104e-02,
         -3.79738476e-03,  -2.91835976e-02,  -3.82234170e-03,
         -2.92040807e-02,  -3.78752857e-03],
       [ -4.57991299e-02,   1.60987100e-01,   1.25868109e-05,
         -7.84500075e-06,   1.71016383e-05,   1.68995164e-01,
         -3.45776362e-06,  -1.23801854e-05,   8.79455449e-06,
         -2.55508409e-03,   5.54466915e-06,   5.12701361e-06,
          9.41400731e-06,  -1.34500823e-05,   5.48930540e-02,
          1.71539702e-02,   5.48123464e-02,   1.71779986e-02,
          5.48760197e-02,   1.71271593e-02],
       [  4.81014885e-06,   1.25868109e-05,   1.99931931e-01,
         -1.18228098e-05,  -3.32800785e-05,  -4.55401592e-05,
          9.37651781e-02,   8.27143007e-05,  -2.67937932e-05,
          1.25854611e-06,  -8.79834986e-06,  -6.20511611e-06,
          8.93329447e-03,   2.72772148e-06,   1.23342262e-01,
          1.00810533e-01,  -6.16384131e-02,  -5.05021817e-02,
         -6.16648842e-02,  -5.03062772e-02],
       [ -5.99621598e-06,  -7.84500075e-06,  -1.18228098e-05,
          1.99898830e-01,  -1.75500159e-05,   2.57303571e-05,
         -1.27891659e-04,   9.37808464e-02,  -1.63885598e-05,
         -5.04205979e-06,  -1.30580306e-05,  -1.70252455e-05,
          1.41663818e-05,  -8.95686389e-03,  -5.35328659e-06,
          1.08951470e-04,   1.06668207e-01,   8.73455888e-02,
         -1.06799191e-01,  -8.73771134e-02],
       [ -1.74505590e-05,   1.71016383e-05,  -3.32800785e-05,
         -1.75500159e-05,   3.61118530e-01,   1.59006345e-04,
         -1.90905755e-05,  -7.41947742e-05,   3.16787822e-01,
          9.90806994e-06,   9.90057736e-07,   5.29679552e-06,
         -1.31048421e-05,   7.93956257e-07,   7.18968352e-06,
         -6.52530995e-05,  -2.48142247e-05,  -1.97779287e-05,
         -1.27520635e-04,  -6.47945370e-05],
       [ -1.09572211e-01,   1.68995164e-01,  -4.55401592e-05,
          2.57303571e-05,   1.59006345e-04,   1.81114713e-01,
         -3.13350594e-05,   2.79943009e-06,   1.32908818e-04,
         -2.73199647e-03,   5.90160286e-06,   5.45831641e-06,
          7.36926758e-06,  -1.58099216e-05,   5.84083961e-02,
          1.79125242e-02,   5.83952763e-02,   1.79975379e-02,
          5.84264836e-02,   1.79136098e-02],
       [  7.05724822e-06,  -3.45776362e-06,   9.37651781e-02,
         -1.27891659e-04,  -1.90905755e-05,  -3.13350594e-05,
          4.39745850e-02,  -1.86050771e-05,  -1.56200964e-05,
          7.43600160e-07,  -4.11864106e-06,  -2.90004116e-06,
          4.18957623e-03,   6.76206763e-06,   5.78425102e-02,
          4.72776139e-02,  -2.89760232e-02,  -2.37392461e-02,
         -2.88577884e-02,  -2.35404277e-02],
       [  1.11755975e-06,  -1.23801854e-05,   8.27143007e-05,
          9.37808464e-02,  -7.41947742e-05,   2.79943009e-06,
         -1.86050771e-05,   4.39965428e-02,  -6.55511139e-05,
         -2.22740346e-06,  -6.13043102e-06,  -7.99123546e-06,
          1.05913228e-05,  -4.20203526e-03,   4.89473047e-05,
          9.47004037e-05,   5.00123018e-02,   4.09542289e-02,
         -5.01341216e-02,  -4.10153539e-02],
       [ -1.25379655e-05,   8.79455449e-06,  -2.67937932e-05,
         -1.63885598e-05,   3.16787822e-01,   1.32908818e-04,
         -1.56200964e-05,  -6.55511139e-05,   2.77899127e-01,
          8.79114212e-06,   8.68262887e-07,   4.64637501e-06,
         -1.13892416e-05,   7.41544156e-07,   5.65834265e-06,
         -5.66928469e-05,  -2.51653289e-05,  -1.90518555e-05,
         -1.14205797e-04,  -5.76698693e-05],
       [  1.55193915e-03,  -2.55508409e-03,   1.25854611e-06,
         -5.04205979e-06,   9.90806994e-06,  -2.73199647e-03,
          7.43600160e-07,  -2.22740346e-06,   8.79114212e-06,
          4.12214467e-05,  -8.87785799e-08,  -8.18385268e-08,
         -8.64925550e-08,   4.47243134e-07,  -8.81342236e-04,
         -2.70652237e-04,  -8.84157305e-04,  -2.74397566e-04,
         -8.79663372e-04,  -2.69064502e-04],
       [ -2.90833363e-06,   5.54466915e-06,  -8.79834986e-06,
         -1.30580306e-05,   9.90057736e-07,   5.90160286e-06,
         -4.11864106e-06,  -6.13043102e-06,   8.68262887e-07,
         -8.87785799e-08,   1.43565402e-09,   1.57794920e-09,
         -3.93809378e-07,   5.84515272e-07,  -3.51982864e-06,
         -3.85479747e-06,  -2.34965469e-06,  -2.89287811e-06,
          1.15980260e-05,   8.51023065e-06],
       [ -2.70490516e-06,   5.12701361e-06,  -6.20511611e-06,
         -1.70252455e-05,   5.29679552e-06,   5.45831641e-06,
         -2.90004116e-06,  -7.99123546e-06,   4.64637501e-06,
         -8.18385268e-08,   1.57794920e-09,   1.88506571e-09,
         -2.78392654e-07,   7.62338896e-07,  -2.06341291e-06,
         -2.59453756e-06,  -5.40977044e-06,  -5.32605954e-06,
          1.27723084e-05,   9.54645413e-06],
       [ -4.19484572e-06,   9.41400731e-06,   8.93329447e-03,
          1.41663818e-05,  -1.31048421e-05,   7.36926758e-06,
          4.18957623e-03,   1.05913228e-05,  -1.13892416e-05,
         -8.64925550e-08,  -3.93809378e-07,  -2.78392654e-07,
          3.99156545e-04,  -5.37307934e-07,   5.51418207e-03,
          4.50533490e-03,  -2.74322622e-03,  -2.24915805e-03,
         -2.76009410e-03,  -2.25324990e-03],
       [  6.98163112e-06,  -1.34500823e-05,   2.72772148e-06,
         -8.95686389e-03,   7.93956257e-07,  -1.58099216e-05,
          6.76206763e-06,  -4.20203526e-03,   7.41544156e-07,
          4.47243134e-07,   5.84515272e-07,   7.62338896e-07,
         -5.37307934e-07,   4.01331281e-04,  -3.14677808e-06,
         -5.24066293e-06,  -4.78489533e-03,  -3.91571798e-03,
          4.77992997e-03,   3.91308655e-03],
       [ -2.92086104e-02,   5.48930540e-02,   1.23342262e-01,
         -5.35328659e-06,   7.18968352e-06,   5.84083961e-02,
          5.78425102e-02,   4.89473047e-05,   5.65834265e-06,
         -8.81342236e-04,  -3.51982864e-06,  -2.06341291e-06,
          5.51418207e-03,  -3.14677808e-06,   9.49860281e-02,
          6.80238982e-02,  -1.91537613e-02,  -2.53105706e-02,
         -1.91531697e-02,  -2.52112625e-02],
       [ -3.79738476e-03,   1.71539702e-02,   1.00810533e-01,
          1.08951470e-04,  -6.52530995e-05,   1.79125242e-02,
          4.72776139e-02,   9.47004037e-05,  -5.66928469e-05,
         -2.70652237e-04,  -3.85479747e-06,  -2.59453756e-06,
          4.50533490e-03,  -5.24066293e-06,   6.80238982e-02,
          5.26588224e-02,  -2.51934212e-02,  -2.35826526e-02,
         -2.53235861e-02,  -2.35904375e-02],
       [ -2.91835976e-02,   5.48123464e-02,  -6.16384131e-02,
          1.06668207e-01,  -2.48142247e-05,   5.83952763e-02,
         -2.89760232e-02,   5.00123018e-02,  -2.51653289e-05,
         -8.84157305e-04,  -2.34965469e-06,  -5.40977044e-06,
         -2.74322622e-03,  -4.78489533e-03,  -1.91537613e-02,
         -2.51934212e-02,   9.47673468e-02,   6.80125932e-02,
         -1.91101547e-02,  -2.52983821e-02],
       [ -3.82234170e-03,   1.71779986e-02,  -5.05021817e-02,
          8.73455888e-02,  -1.97779287e-05,   1.79975379e-02,
         -2.37392461e-02,   4.09542289e-02,  -1.90518555e-05,
         -2.74397566e-04,  -2.89287811e-06,  -5.32605954e-06,
         -2.24915805e-03,  -3.91571798e-03,  -2.53105706e-02,
         -2.35826526e-02,   6.80125932e-02,   5.27551502e-02,
         -2.52459942e-02,  -2.36427676e-02],
       [ -2.92040807e-02,   5.48760197e-02,  -6.16648842e-02,
         -1.06799191e-01,  -1.27520635e-04,   5.84264836e-02,
         -2.88577884e-02,  -5.01341216e-02,  -1.14205797e-04,
         -8.79663372e-04,   1.15980260e-05,   1.27723084e-05,
         -2.76009410e-03,   4.77992997e-03,  -1.91531697e-02,
         -2.53235861e-02,  -1.91101547e-02,  -2.52459942e-02,
          9.49693735e-02,   6.80253802e-02],
       [ -3.78752857e-03,   1.71271593e-02,  -5.03062772e-02,
         -8.73771134e-02,  -6.47945370e-05,   1.79136098e-02,
         -2.35404277e-02,  -4.10153539e-02,  -5.76698693e-05,
         -2.69064502e-04,   8.51023065e-06,   9.54645413e-06,
         -2.25324990e-03,   3.91308655e-03,  -2.52112625e-02,
         -2.35904375e-02,  -2.52983821e-02,  -2.36427676e-02,
          6.80253802e-02,   5.26768830e-02]])
    ref_result_energy = -39.763647865330526
    ref_result_exp_alpha = array([[  9.94858961e-01,  -2.04326954e-01,   1.26942857e-06,
          1.65097581e-06,   3.45084767e-05,   1.54052344e-01,
         -7.47048204e-05,   5.26907407e-05,  -1.00064920e-05,
          2.43493732e-06,   6.83264178e-05,   4.70015760e-02,
         -3.54558706e-06,   3.31636527e-05,   3.47148634e-02,
         -1.56394899e-05,  -8.31525519e-06,  -4.11781542e-02,
         -3.05384733e-05,  -2.67784087e-05],
       [  3.60373066e-02,   3.99610361e-01,   6.07168794e-05,
          2.00265163e-05,  -3.80871224e-05,  -2.58132511e-01,
          1.05946732e-04,  -9.14599121e-05,  -3.74733713e-06,
          2.83384068e-04,   3.95268921e-04,   6.56677144e-01,
         -5.54824079e-04,   1.84138759e-03,  -1.94978969e+00,
         -3.78106770e-05,  -1.89949834e-04,  -2.73226123e-01,
         -1.74114749e-04,   1.21557804e-05],
       [  1.50868987e-07,  -2.16933673e-05,   4.09473913e-01,
         -1.79619153e-01,   9.93813193e-05,  -6.24413896e-05,
          3.30443412e-01,   2.97086542e-01,   8.36632105e-04,
         -4.49829761e-01,   6.93816094e-01,  -1.36468107e-03,
         -5.37850010e-01,   5.36045389e-01,   2.96843557e-04,
          2.50302685e-05,  -2.28606407e-05,  -5.46629098e-05,
          4.87073334e-02,  -3.47691812e-02],
       [  6.54418243e-07,   2.80604278e-05,  -1.79628464e-01,
         -4.09429440e-01,   7.86053965e-05,  -2.92093347e-04,
         -2.97126366e-01,   3.30449369e-01,  -1.23864883e-04,
         -6.93471646e-01,  -4.50358992e-01,   1.29634048e-03,
         -5.36548166e-01,  -5.37345963e-01,  -1.04263035e-04,
         -1.52405069e-04,   4.23095750e-06,  -1.65771744e-06,
         -3.47301564e-02,  -4.88423068e-02],
       [  3.25222258e-07,  -1.45275622e-05,   2.74792554e-05,
         -8.45613611e-05,  -6.00931416e-01,   1.16558371e-04,
         -5.13313908e-05,   7.41831102e-05,   1.05807712e+00,
          6.16103281e-04,  -1.00450815e-03,   1.80096994e-04,
         -1.84220847e-04,   2.79423509e-05,   5.15123393e-05,
         -3.88977866e-06,  -8.64943950e-06,   2.85905231e-06,
          4.72645125e-05,  -2.70884825e-05],
       [ -2.28586773e-02,   4.24961257e-01,  -8.66984330e-05,
          4.41419429e-06,  -2.74795042e-04,  -1.84826436e+00,
          8.13761958e-04,  -8.98371742e-04,   4.26032001e-05,
         -3.96659135e-04,  -4.58589595e-04,  -9.80550727e-01,
          1.07120813e-03,  -3.24487965e-03,   3.60884211e+00,
          8.68446544e-05,   4.77345590e-04,   7.92026765e-01,
          5.17914078e-04,   2.17442014e-04],
       [  7.58511358e-08,  -3.36147658e-05,   1.92147125e-01,
         -8.39882051e-02,   5.23743037e-05,   1.28164105e-04,
          9.51364038e-01,   8.57061665e-01,  -1.74495356e-03,
          9.21068572e-01,  -1.41955028e+00,   2.83689498e-03,
          8.12188265e-01,  -8.08962755e-01,  -2.30874808e-04,
          1.52969288e-04,   1.44796314e-04,  -7.87544371e-05,
          4.34099277e-01,  -3.10655631e-01],
       [ -2.10152130e-07,  -8.56407636e-06,  -8.40903608e-02,
         -1.92159654e-01,   1.46662790e-04,  -7.76621376e-04,
         -8.56949825e-01,   9.51468990e-01,   1.34027392e-04,
          1.41866691e+00,   9.22055180e-01,  -2.02606612e-03,
          8.10504388e-01,   8.11151580e-01,   2.10754469e-04,
          2.78919574e-04,   2.08864339e-04,   4.68763826e-04,
         -3.10647436e-01,  -4.33932527e-01],
       [ -1.11656908e-07,  -2.82322655e-05,   2.99136682e-05,
         -7.43054441e-05,  -5.27161341e-01,   3.83428062e-05,
          3.64493510e-05,   1.29113725e-05,  -1.09669809e+00,
         -5.72066430e-04,   1.05766584e-03,  -8.14762001e-05,
          9.00241067e-05,  -2.50406885e-05,  -2.48712729e-05,
         -6.18939323e-06,   7.13647842e-06,  -6.72974171e-06,
         -2.95801291e-05,  -1.35191230e-05],
       [  2.42266288e-04,  -6.41579303e-03,   6.65626612e-06,
          8.96150444e-06,  -1.63203505e-05,  -1.71964652e-02,
          1.58703568e-05,  -1.05325151e-05,   2.80895055e-05,
         -2.59692251e-05,  -2.05544077e-04,  -1.85332555e-01,
          8.11002205e-05,  -2.28550228e-04,  -2.70226664e-02,
         -2.72161938e-05,  -4.78778379e-04,  -1.05099887e+00,
         -6.56308848e-04,  -6.39752901e-04],
       [ -7.24808303e-08,   1.38807725e-05,  -6.29398525e-06,
          3.46551884e-05,  -1.67642547e-06,   2.53113022e-05,
         -1.64899730e-05,   1.65687311e-05,  -7.32651451e-06,
          9.84060970e-05,   4.76621815e-05,   1.94458500e-04,
         -1.16899975e-04,  -1.43628800e-04,   9.57609772e-05,
          3.60105201e-01,  -9.32911553e-01,   3.78564228e-04,
         -4.52376287e-05,  -1.94754588e-04],
       [ -8.27337159e-08,   1.28336678e-05,   2.59441395e-06,
          4.04538732e-05,  -8.83568976e-06,   2.13563169e-05,
         -3.40604575e-05,   2.96799266e-05,   1.25444199e-06,
          1.27181187e-04,   3.38918871e-05,   1.51699379e-04,
         -2.89384779e-04,  -2.01182908e-04,   2.79617441e-05,
          9.32911486e-01,   3.60105106e-01,  -2.16355396e-04,
         -6.11593926e-05,   5.00941994e-04],
       [  1.21753820e-07,   2.11723001e-05,   1.82828087e-02,
         -8.05577758e-03,   2.37765841e-05,   1.71355771e-05,
         -1.65555413e-02,  -1.50012762e-02,   1.15322551e-04,
         -6.38154411e-02,   9.79513999e-02,   1.75197345e-04,
          1.40310898e-01,  -1.39547462e-01,  -1.58582414e-04,
          3.30986246e-04,   2.18432489e-04,  -1.70617769e-04,
          8.82100944e-01,  -6.30941225e-01],
       [ -3.69028790e-07,  -3.57688431e-05,   8.05311684e-03,
          1.83433088e-02,  -3.53329199e-06,  -5.80491184e-06,
         -1.49558879e-02,   1.66363186e-02,  -2.55488513e-05,
          9.81445090e-02,   6.36840778e-02,  -5.87548741e-05,
         -1.39761325e-01,  -1.40425370e-01,  -1.57725081e-05,
         -4.01624242e-04,  -3.16215913e-04,  -9.14980808e-04,
          6.30941140e-01,   8.82034606e-01],
       [ -1.13273788e-03,   1.37435799e-01,   2.52621070e-01,
         -1.10809651e-01,   1.18451538e-05,   1.13730205e-01,
         -9.49314515e-02,  -8.57363815e-02,   4.96424489e-04,
         -2.33363635e-01,   3.59066817e-01,   6.37847219e-01,
          6.18647503e-01,  -6.16498357e-01,   2.83772817e-01,
         -3.11964920e-04,  -1.56392030e-04,  -3.76419404e-01,
         -5.55137447e-01,   3.96689980e-01],
       [  4.90298043e-03,   4.24577554e-02,   2.06366439e-01,
         -9.08020599e-02,   1.29737632e-04,   9.52575681e-01,
         -1.20974231e+00,  -1.08821313e+00,   3.62276059e-04,
         -2.52287668e-01,   3.89739583e-01,  -2.35521057e-01,
         -1.11264789e+00,   1.10896951e+00,  -1.09383641e+00,
          1.40573098e-05,  -1.97182347e-04,  -6.43330535e-02,
         -8.52802092e-03,   6.20756734e-03],
       [ -1.13302947e-03,   1.37308600e-01,  -2.22065626e-01,
         -1.63093007e-01,   5.07559842e-05,   1.13660407e-01,
          1.21338550e-01,  -3.95157504e-02,  -3.53378835e-04,
         -1.93784731e-01,  -3.80026142e-01,   6.37087758e-01,
          2.24600753e-01,   8.45138597e-01,   2.84843991e-01,
          8.60121596e-05,  -2.47240795e-04,  -3.77181309e-01,
          6.20872951e-01,   2.82242754e-01],
       [  4.90335707e-03,   4.25790007e-02,  -1.81904185e-01,
         -1.33525443e-01,   4.23160691e-05,   9.53755885e-01,
          1.54729805e+00,  -5.02254779e-01,  -1.85541669e-04,
         -2.10859686e-01,  -4.15327643e-01,  -2.31024928e-01,
         -4.04613204e-01,  -1.51682887e+00,  -1.09518815e+00,
         -2.72939254e-04,  -6.60325897e-05,  -6.43063251e-02,
          9.61453184e-03,   3.92100689e-03],
       [ -1.13236018e-03,   1.37416851e-01,  -3.03244826e-02,
          2.74162472e-01,   1.68904463e-04,   1.13586912e-01,
         -2.67818692e-02,   1.24984789e-01,  -4.05397827e-04,
          4.27490974e-01,   2.33849799e-02,   6.37591793e-01,
         -8.43321845e-01,  -2.26898296e-01,   2.84419889e-01,
         -3.20899033e-04,   2.35730829e-04,  -3.76186860e-01,
         -6.64791484e-02,  -6.79367896e-01],
       [  4.90284373e-03,   4.24100486e-02,  -2.45187857e-02,
          2.24171804e-01,   7.40974071e-05,   9.51917851e-01,
         -3.38650925e-01,   1.59213747e+00,  -7.23142899e-05,
          4.63130542e-01,   2.40659784e-02,  -2.33441943e-01,
          1.51647541e+00,   4.09125598e-01,  -1.09453072e+00,
          5.08116498e-04,  -1.22486569e-04,  -6.42691468e-02,
         -1.18289669e-03,  -1.01985611e-02]])
    ref_result_exp_beta = array([[  9.95044126e-01,   1.95969182e-01,  -1.81272534e-06,
         -1.19508992e-06,  -3.45829935e-05,   1.61501899e-01,
         -1.02571469e-04,  -7.64722906e-05,   3.12823335e-07,
          7.97887757e-05,   2.02839287e-05,  -5.86186753e-02,
          1.48275442e-05,  -6.22588677e-05,   3.61340438e-02,
          3.77841746e-06,   1.18449032e-05,   3.15350623e-02,
          6.34341316e-05,  -4.08682921e-05],
       [  3.45032122e-02,  -3.79839849e-01,  -5.30033024e-05,
         -1.11260993e-05,   1.45412321e-05,  -2.56394944e-01,
          1.40045717e-04,   1.03383182e-04,  -2.18343194e-04,
          2.69517194e-04,   1.68440050e-04,  -5.38639355e-01,
          5.23256624e-04,  -9.90750662e-04,  -1.98122169e+00,
          2.19399568e-05,  -1.79361750e-04,   3.29545132e-01,
          6.17862924e-04,  -1.73359488e-04],
       [  6.93741242e-08,   2.64282792e-05,  -3.99454862e-01,
          1.57251889e-01,  -1.17404704e-04,  -2.21638910e-05,
          3.61076558e-01,  -2.62704739e-01,   4.72328001e-01,
          6.58617387e-01,   1.01951503e-03,   1.43878013e-03,
          5.75170204e-01,  -5.35236113e-01,   8.91203174e-05,
          4.49426220e-05,  -3.04824510e-05,   9.51093480e-05,
         -4.85033571e-02,  -3.34192673e-02],
       [  1.19146445e-06,  -4.65306640e-05,   1.57271182e-01,
          3.99381039e-01,  -1.39664676e-05,  -3.90667486e-04,
         -2.62740115e-01,  -3.61069110e-01,   6.58181119e-01,
         -4.72891757e-01,   9.39477761e-04,  -1.33616723e-03,
          5.35830940e-01,   5.74677895e-01,   9.37773118e-05,
         -1.20678809e-04,  -2.51637574e-05,  -1.03058783e-04,
          3.33759130e-02,  -4.86421260e-02],
       [ -8.00445445e-07,   5.90641088e-05,   3.36521428e-05,
          1.40872668e-04,   5.34361706e-01,   1.06128948e-04,
         -5.54524018e-05,  -8.05350447e-05,   1.64750259e-03,
          2.70337206e-04,  -1.09320714e+00,  -2.17670211e-04,
          1.70297707e-04,  -2.05347257e-04,  -4.64450535e-05,
         -4.70834738e-05,  -5.17665070e-05,   5.10289670e-05,
         -5.81804121e-05,  -2.55946660e-05],
       [ -2.15093026e-02,  -3.65947775e-01,   8.36954416e-05,
         -1.11421212e-05,   2.39547719e-04,  -1.91168525e+00,
          1.12095118e-03,   1.20903975e-03,   2.59107948e-04,
         -3.54356732e-04,  -4.50997356e-04,   8.58508486e-01,
         -1.02926589e-03,   1.70541522e-03,   3.60700545e+00,
         -1.65223162e-04,   2.80459353e-04,  -8.20537180e-01,
         -1.55030566e-03,   6.51652709e-04],
       [  2.48153156e-07,   3.71971366e-05,  -1.72078041e-01,
          6.74419692e-02,  -3.97910584e-05,   2.58269395e-04,
          1.05023734e+00,  -7.65733540e-01,  -9.72034189e-01,
         -1.35428926e+00,  -2.06340460e-03,  -2.89422153e-03,
         -8.52981263e-01,   7.93261947e-01,   4.95591926e-05,
          1.63335751e-04,   1.26267233e-04,   4.51728669e-04,
         -4.40562391e-01,  -3.04530308e-01],
       [ -3.69357439e-07,   1.40022998e-05,   6.75465610e-02,
          1.72088622e-01,  -1.27176585e-04,  -9.96254950e-04,
         -7.65622241e-01,  -1.05039040e+00,  -1.35321488e+00,
          9.73031602e-01,  -1.69068611e-03,   2.03494749e-03,
         -7.94940201e-01,  -8.51977842e-01,  -8.41691037e-05,
          2.61769865e-04,   3.29889148e-04,  -1.06043518e-03,
          3.04520514e-01,  -4.40396770e-01],
       [  2.83661444e-07,   4.14901438e-05,  -1.45251057e-05,
          9.27130823e-05,   5.93960618e-01,  -2.07090203e-05,
          1.41373509e-04,   6.33506542e-05,  -1.69002814e-03,
         -2.04044415e-04,   1.06200520e+00,   1.23900219e-04,
         -8.14234640e-05,   1.63026026e-04,   5.23298880e-05,
          1.87247878e-05,   2.77985903e-05,  -2.06994041e-05,
          3.45842970e-05,  -1.30900775e-05],
       [ -6.18255705e-04,   3.17885073e-02,  -2.32921672e-06,
          1.68409407e-07,  -1.90421959e-05,   1.39035626e-02,
         -1.26679336e-05,  -9.62299344e-06,   3.29864277e-05,
         -1.68093670e-04,   1.12708187e-05,   1.55795570e-01,
         -8.68470140e-05,   2.36959104e-04,   1.42678947e-02,
          3.69704949e-04,  -6.16640115e-05,   1.05561807e+00,
          1.95120601e-03,  -1.23549780e-03],
       [ -6.09506236e-07,  -1.59592843e-05,   9.25314366e-06,
         -3.51014456e-05,  -1.74796996e-06,   2.22251201e-05,
         -1.97455258e-05,  -1.10218841e-05,  -8.74719161e-05,
          5.69525162e-05,   1.13333245e-05,  -1.91564587e-04,
          8.29620125e-05,   1.45424857e-04,   9.34311066e-05,
          5.96655390e-01,  -8.02497455e-01,  -2.29101283e-04,
          1.60314005e-04,  -1.24229538e-04],
       [  1.19930977e-06,  -3.76351695e-05,  -1.73035208e-06,
         -4.34804367e-05,   3.15429950e-05,  -1.02332944e-05,
         -2.42080151e-05,  -2.61539737e-05,  -1.18735724e-04,
          3.31698300e-05,  -4.75714380e-05,  -1.11290476e-04,
          2.50382764e-04,   1.82064185e-04,  -4.41670188e-05,
          8.02497253e-01,   5.96655304e-01,  -2.27171980e-04,
          5.39485327e-06,   6.49073239e-04],
       [  4.79700215e-07,  -2.71135720e-05,  -1.84888076e-02,
          7.31248555e-03,  -2.30693185e-05,   6.66748880e-06,
         -1.54731495e-02,   1.13684279e-02,   7.01911159e-02,
          9.74025605e-02,   1.34466924e-04,  -1.95168892e-04,
         -1.40734111e-01,   1.30673556e-01,  -1.09153644e-04,
          3.74708278e-04,   2.03563039e-04,   9.31731517e-04,
         -8.92932496e-01,  -6.16867670e-01],
       [ -6.86966611e-07,   4.01919751e-05,  -7.30341525e-03,
         -1.85535074e-02,   6.03344965e-06,  -7.73468389e-07,
         -1.13144569e-02,  -1.55449269e-02,  -9.76229052e-02,
          7.00583888e-02,  -1.21753601e-04,   4.88144018e-05,
          1.30877775e-01,   1.40850454e-01,   5.25779269e-05,
         -4.22526740e-04,  -5.20338907e-04,   2.16930313e-03,
         -6.16869077e-01,   8.92865637e-01],
       [ -1.19867394e-03,  -1.51976754e-01,  -2.69600145e-01,
          1.06132887e-01,   2.72128009e-05,   9.52594013e-02,
         -9.10762910e-02,   6.66091134e-02,   2.60681401e-01,
          3.62579834e-01,   3.91306760e-04,  -6.62837393e-01,
         -6.32966580e-01,   5.88893698e-01,   2.58627771e-01,
         -2.19141322e-04,   1.53321241e-05,   3.49990022e-01,
          5.58799777e-01,   3.85185717e-01],
       [  4.62319068e-03,  -6.91701617e-02,  -2.34310726e-01,
          9.25213618e-02,  -5.73314475e-05,   9.73390578e-01,
         -1.32433075e+00,   9.63828005e-01,   2.49733736e-01,
          3.48806929e-01,   8.99506997e-04,   2.70395071e-01,
          1.14613855e+00,  -1.06626299e+00,  -1.06499798e+00,
          5.88419555e-05,  -2.03251757e-04,   8.13425243e-02,
          1.09886671e-02,   7.58770211e-03],
       [ -1.19899559e-03,  -1.51837554e-01,   2.26503572e-01,
          1.80123335e-01,  -8.38847823e-05,   9.52488372e-02,
          1.02838687e-01,   4.56980731e-02,   1.83274046e-01,
         -4.05437985e-01,   4.49004382e-04,  -6.61911182e-01,
         -1.93522864e-01,  -8.44146383e-01,   2.59086751e-01,
          2.07457677e-04,  -1.49892034e-04,   3.52138062e-01,
         -6.12265856e-01,   2.90529038e-01],
       [  4.62380224e-03,  -6.93075965e-02,   1.97362366e-01,
          1.56882102e-01,  -1.26443237e-04,   9.75031158e-01,
          1.49678741e+00,   6.63377673e-01,   1.76536279e-01,
         -3.92628614e-01,  -1.35572812e-04,   2.65699888e-01,
          3.51230897e-01,   1.52536870e+00,  -1.06534375e+00,
         -2.27547215e-04,  -1.39570621e-04,   8.13315986e-02,
         -1.19205199e-02,   5.19934613e-03],
       [ -1.19795407e-03,  -1.51953725e-01,   4.28576610e-02,
         -2.86538843e-01,  -1.12775919e-04,   9.51216804e-02,
         -1.21580610e-02,  -1.12063131e-01,  -4.44250198e-01,
          4.52636148e-02,  -5.07733726e-04,  -6.62426758e-01,
          8.26847326e-01,   2.52868049e-01,   2.59008756e-01,
         -9.21588187e-05,   3.39197610e-04,   3.49780162e-01,
          5.54575393e-02,  -6.76716655e-01],
       [  4.62304230e-03,  -6.91126137e-02,   3.69984748e-02,
         -2.49256570e-01,   6.37479957e-05,   9.72713317e-01,
         -1.73986132e-01,  -1.62930356e+00,  -4.26174615e-01,
          4.22840362e-02,  -5.63186121e-04,   2.68117639e-01,
         -1.49680028e+00,  -4.58781889e-01,  -1.06534059e+00,
          4.51997997e-04,   4.96446474e-06,   8.12935306e-02,
          1.36177963e-03,  -1.29825671e-02]])
    ref_result_dm_beta = array([[  1.02851673e+00,  -4.01047084e-02,   5.78603047e-06,
         -8.70734732e-06,   1.07733947e-05,  -9.31171763e-02,
          7.77482215e-06,   2.04461736e-06,   8.40863213e-06,
          5.61437557e-03,  -3.73397906e-06,  -6.18180394e-06,
         -4.81167587e-06,   7.22800801e-06,  -3.09751341e-02,
         -8.95463521e-03,  -3.09491629e-02,  -8.98181095e-03,
         -3.09700017e-02,  -8.94356804e-03],
       [ -4.01047084e-02,   1.45468852e-01,   9.37424226e-06,
          4.96073342e-06,  -2.24544238e-05,   1.38259409e-01,
         -5.76154053e-06,  -1.08185136e-05,  -1.57427434e-05,
         -1.20958746e-02,   6.04082128e-06,   1.43370481e-05,
          1.12144390e-05,  -1.46961054e-05,   5.76985940e-02,
          2.64445045e-02,   5.76185941e-02,   2.64731243e-02,
          5.76776801e-02,   2.64120283e-02],
       [  5.78603047e-06,   9.37424226e-06,   1.84292410e-01,
         -1.93451058e-05,   8.71144635e-06,  -4.48606430e-05,
          7.93427937e-02,   7.94155169e-05,   2.03824719e-05,
          1.80143967e-06,  -9.21296808e-06,  -6.14718919e-06,
          8.53534385e-03,  -1.92306285e-07,   1.24378686e-01,
          1.08143887e-01,  -6.21572424e-02,  -5.41691616e-02,
         -6.21825181e-02,  -5.39771289e-02],
       [ -8.70734732e-06,   4.96073342e-06,  -1.93451058e-05,
          1.84239490e-01,   6.15507152e-05,   2.57838118e-05,
         -1.27918468e-04,   7.93520174e-02,   3.47410584e-05,
         -1.77849956e-06,  -1.25628728e-05,  -1.76322562e-05,
          1.27168410e-05,  -8.55855096e-03,  -5.80845219e-06,
          1.04175332e-04,   1.07567401e-01,   9.36983672e-02,
         -1.07690888e-01,  -9.37263853e-02],
       [  1.07733947e-05,  -2.24544238e-05,   8.71144635e-06,
          6.15507152e-05,   2.44626085e-08,  -2.15849307e-05,
          3.71208020e-06,   2.65160776e-05,   1.50195522e-08,
          1.87704520e-06,  -5.57487202e-09,  -8.40488973e-09,
          4.06337316e-07,  -2.85704580e-06,  -3.09231456e-06,
          1.06152473e-06,   2.40336386e-05,   2.46464091e-05,
         -4.78921751e-05,  -3.79515686e-05],
       [ -9.31171763e-02,   1.38259409e-01,  -4.48606430e-05,
          2.57838118e-05,  -2.15849307e-05,   1.34380381e-01,
         -2.87785706e-05,  -1.35351623e-06,  -1.51844585e-05,
         -1.16196316e-02,   5.85451310e-06,   1.37468054e-05,
          8.28378241e-06,  -1.50994474e-05,   5.56175887e-02,
          2.51925936e-02,   5.56073733e-02,   2.52782932e-02,
          5.56396382e-02,   2.51979889e-02],
       [  7.77482215e-06,  -5.76154053e-06,   7.93427937e-02,
         -1.27918468e-04,   3.71208020e-06,  -2.87785706e-05,
          3.41592653e-02,  -1.73160395e-05,   8.75371588e-06,
          1.59689355e-06,  -3.95868509e-06,  -2.63605423e-06,
          3.67468341e-03,   5.47354511e-06,   5.35444116e-02,
          4.65569657e-02,  -2.68340845e-02,  -2.33838702e-02,
         -2.67052466e-02,  -2.31795337e-02],
       [  2.04461736e-06,  -1.08185136e-05,   7.94155169e-05,
          7.93520174e-02,   2.65160776e-05,  -1.35351623e-06,
         -1.73160395e-05,   3.41769866e-02,   1.49741049e-05,
          3.17429916e-07,  -5.41576401e-06,  -7.59842933e-06,
          9.54013179e-06,  -3.68617034e-03,   5.15463527e-05,
          9.40000496e-05,   4.62945642e-02,   4.03277728e-02,
         -4.64172902e-02,  -4.03960513e-02],
       [  8.40863213e-06,  -1.57427434e-05,   2.03824719e-05,
          3.47410584e-05,   1.50195522e-08,  -1.51844585e-05,
          8.75371588e-06,   1.49741049e-05,   1.05264048e-08,
          1.31816861e-06,  -4.05036709e-09,  -5.56577890e-09,
          9.45388454e-07,  -1.61238399e-06,   7.45290600e-06,
          9.11406137e-06,   7.11237976e-06,   8.80515557e-06,
         -3.34900996e-05,  -2.65113423e-05],
       [  5.61437557e-03,  -1.20958746e-02,   1.80143967e-06,
         -1.77849956e-06,   1.87704520e-06,  -1.16196316e-02,
          1.59689355e-06,   3.17429916e-07,   1.31816861e-06,
          1.01089116e-03,  -5.06970810e-07,  -1.19709015e-06,
         -8.17780239e-07,   1.29178875e-06,  -4.82972446e-03,
         -2.20111167e-03,  -4.82644465e-03,  -2.20647655e-03,
         -4.82979178e-03,  -2.19997312e-03],
       [ -3.73397906e-06,   6.04082128e-06,  -9.21296808e-06,
         -1.25628728e-05,  -5.57487202e-09,   5.85451310e-06,
         -3.95868509e-06,  -5.41576401e-06,  -4.05036709e-09,
         -5.06970810e-07,   1.57245894e-09,   2.10975815e-09,
         -4.27166961e-07,   5.83036167e-07,  -3.79158464e-06,
         -4.31264205e-06,  -1.80394602e-06,  -2.57830657e-06,
          1.28791436e-05,   1.01907882e-05],
       [ -6.18180394e-06,   1.43370481e-05,  -6.14718919e-06,
         -1.76322562e-05,  -8.40488973e-09,   1.37468054e-05,
         -2.63605423e-06,  -7.59842933e-06,  -5.56577890e-09,
         -1.19709015e-06,   2.10975815e-09,   3.31069008e-09,
         -2.84937473e-07,   8.17682689e-07,   1.56992746e-06,
         -1.00870143e-06,  -2.50889381e-06,  -4.54717776e-06,
          1.80999733e-05,   1.33786109e-05],
       [ -4.81167587e-06,   1.12144390e-05,   8.53534385e-03,
          1.27168410e-05,   4.06337316e-07,   8.28378241e-06,
          3.67468341e-03,   9.54013179e-06,   9.45388454e-07,
         -8.17780239e-07,  -4.27166961e-07,  -2.84937473e-07,
          3.95308889e-04,  -6.42344877e-07,   5.76479846e-03,
          5.01056197e-03,  -2.86651071e-03,  -2.49991006e-03,
         -2.88358116e-03,  -2.50486855e-03],
       [  7.22800801e-06,  -1.46961054e-05,  -1.92306285e-07,
         -8.55855096e-03,  -2.85704580e-06,  -1.50994474e-05,
          5.47354511e-06,  -3.68617034e-03,  -1.61238399e-06,
          1.29178875e-06,   5.83036167e-07,   8.17682689e-07,
         -6.42344877e-07,   3.97575255e-04,  -6.24545986e-06,
         -8.11325478e-06,  -5.00227540e-03,  -4.35492447e-03,
          4.99719807e-03,   4.35159737e-03],
       [ -3.09751341e-02,   5.76985940e-02,   1.24378686e-01,
         -5.80845219e-06,  -3.09231456e-06,   5.56175887e-02,
          5.35444116e-02,   5.15463527e-05,   7.45290600e-06,
         -4.82972446e-03,  -3.79158464e-06,   1.56992746e-06,
          5.76479846e-03,  -6.24545986e-06,   1.07046800e-01,
          8.34964703e-02,  -1.88711628e-02,  -2.60309477e-02,
         -1.88707618e-02,  -2.59311567e-02],
       [ -8.95463521e-03,   2.64445045e-02,   1.08143887e-01,
          1.04175332e-04,   1.06152473e-06,   2.51925936e-02,
          4.65569657e-02,   9.40000496e-05,   9.11406137e-06,
         -2.20111167e-03,  -4.31264205e-06,  -1.00870143e-06,
          5.01056197e-03,  -8.11325478e-06,   8.34964703e-02,
          6.82675835e-02,  -2.59098541e-02,  -2.69137472e-02,
         -2.60478492e-02,  -2.69287971e-02],
       [ -3.09491629e-02,   5.76185941e-02,  -6.21572424e-02,
          1.07567401e-01,   2.40336386e-05,   5.56073733e-02,
         -2.68340845e-02,   4.62945642e-02,   7.11237976e-06,
         -4.82644465e-03,  -1.80394602e-06,  -2.50889381e-06,
         -2.86651071e-03,  -5.00227540e-03,  -1.88711628e-02,
         -2.59098541e-02,   1.06804335e-01,   8.34793145e-02,
         -1.88312127e-02,  -2.60283176e-02],
       [ -8.98181095e-03,   2.64731243e-02,  -5.41691616e-02,
          9.36983672e-02,   2.46464091e-05,   2.52782932e-02,
         -2.33838702e-02,   4.03277728e-02,   8.80515557e-06,
         -2.20647655e-03,  -2.57830657e-06,  -4.54717776e-06,
         -2.49991006e-03,  -4.35492447e-03,  -2.60309477e-02,
         -2.69137472e-02,   8.34793145e-02,   6.83887633e-02,
         -2.59683311e-02,  -2.69904030e-02],
       [ -3.09700017e-02,   5.76776801e-02,  -6.21825181e-02,
         -1.07690888e-01,  -4.78921751e-05,   5.56396382e-02,
         -2.67052466e-02,  -4.64172902e-02,  -3.34900996e-05,
         -4.82979178e-03,   1.28791436e-05,   1.80999733e-05,
         -2.88358116e-03,   4.99719807e-03,  -1.88707618e-02,
         -2.60478492e-02,  -1.88312127e-02,  -2.59683311e-02,
          1.07032734e-01,   8.35037932e-02],
       [ -8.94356804e-03,   2.64120283e-02,  -5.39771289e-02,
         -9.37263853e-02,  -3.79515686e-05,   2.51979889e-02,
         -2.31795337e-02,  -4.03960513e-02,  -2.65113423e-05,
         -2.19997312e-03,   1.01907882e-05,   1.33786109e-05,
         -2.50486855e-03,   4.35159737e-03,  -2.59311567e-02,
         -2.69287971e-02,  -2.60283176e-02,  -2.69904030e-02,
          8.35037932e-02,   6.82956979e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha', 'ref_result_exp_beta', 'ref_result_dm_beta']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_numgga.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]