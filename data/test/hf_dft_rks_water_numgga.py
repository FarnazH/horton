# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_dm_alpha = array([[  9.81543264e-02,   4.71688020e-02,  -1.83737500e-02,
          4.01502289e-02,   1.25568416e-01,  -9.51434013e-02,
          1.90745693e-05,   1.80032738e-02,   6.29018699e-02,
         -6.28202312e-02,   3.57926139e-06,  -4.92124169e-03,
          2.32710725e-06,  -8.04369245e-06,  -3.74989408e-03,
         -9.09033932e-03,  -2.01505904e-02,  -1.91323820e-02],
       [  4.71688020e-02,   2.87461488e-02,   1.13931327e-02,
         -1.80102648e-02,   7.03600160e-02,  -5.62548048e-02,
         -6.24027203e-05,  -3.46230531e-02,   3.52444967e-02,
         -3.93478472e-02,  -5.63381579e-05,  -1.57194122e-03,
          1.12536093e-06,  -9.59531705e-07,  -3.21821235e-03,
         -5.09340393e-03,  -1.91207740e-02,  -8.40671238e-03],
       [ -1.83737500e-02,   1.13931327e-02,   1.04146969e+00,
         -8.42535774e-02,   3.05856685e-06,  -2.01342247e-02,
         -6.37057736e-06,  -1.41415376e-01,  -3.48427337e-06,
         -1.60639473e-02,  -5.91340514e-06,   3.10314764e-03,
         -2.37177202e-07,  -1.22360511e-06,  -3.73737898e-03,
          3.76267547e-07,  -1.83753757e-02,   1.13807885e-02],
       [  4.01502289e-02,  -1.80102648e-02,  -8.42535774e-02,
          2.48919926e-01,  -1.52251971e-05,   4.20379285e-02,
         -2.37162550e-06,   2.78943185e-01,   3.87923906e-06,
          4.19431203e-02,   6.06372729e-07,  -6.31182273e-03,
          7.10165393e-07,   3.89828980e-06,   8.01476633e-03,
         -2.04156096e-07,   4.01613738e-02,  -1.79783143e-02],
       [  1.25568416e-01,   7.03600160e-02,   3.05856685e-06,
         -1.52251971e-05,   2.66578969e-01,   1.57008671e-05,
          1.30065087e-05,  -1.20528500e-05,   1.33559037e-01,
          7.37040348e-06,  -2.65346476e-07,   2.10132740e-07,
          1.28196419e-06,  -9.26597577e-06,   1.76399684e-06,
         -1.92986935e-02,  -1.25592034e-01,  -7.03098470e-02],
       [ -9.51434013e-02,  -5.62548048e-02,  -2.01342247e-02,
          4.20379285e-02,   1.57008671e-05,   3.26950250e-01,
         -3.74790697e-05,   1.32743353e-01,   4.48488132e-05,
          2.25403516e-01,  -7.43976859e-06,   1.11567545e-02,
         -4.92587545e-06,   1.39156479e-05,   1.71951721e-02,
         -2.17564090e-06,  -9.51629122e-02,  -5.61197077e-02],
       [  1.90745693e-05,  -6.24027203e-05,  -6.37057736e-06,
         -2.37162550e-06,   1.30065087e-05,  -3.74790697e-05,
          4.10493975e-01,   1.21217844e-04,  -3.99091237e-05,
         -3.78436694e-05,   3.26914579e-01,  -1.77451412e-05,
          4.51048831e-06,  -2.26035859e-02,  -8.05616787e-06,
         -8.79788108e-06,   1.98224830e-05,  -1.58265886e-04],
       [  1.80032738e-02,  -3.46230531e-02,  -1.41415376e-01,
          2.78943185e-01,  -1.20528500e-05,   1.32743353e-01,
          1.21217844e-04,   3.37551853e-01,   1.62439383e-05,
          1.05356819e-01,   1.05201367e-04,  -3.85415616e-03,
         -5.49614596e-07,   5.54279607e-07,   1.32556351e-02,
         -8.19337779e-07,   1.80099253e-02,  -3.45526111e-02],
       [  6.29018699e-02,   3.52444967e-02,  -3.48427337e-06,
          3.87923906e-06,   1.33559037e-01,   4.48488132e-05,
         -3.99091237e-05,   1.62439383e-05,   6.69145771e-02,
          2.95486030e-05,  -3.71033907e-05,   1.15376271e-06,
          6.41248461e-07,  -2.08456267e-06,   2.99075749e-06,
         -9.66885999e-03,  -6.29323196e-02,  -3.52326475e-02],
       [ -6.28202312e-02,  -3.93478472e-02,  -1.60639473e-02,
          4.19431203e-02,   7.37040348e-06,   2.25403516e-01,
         -3.78436694e-05,   1.05356819e-01,   2.95486030e-05,
          1.56090488e-01,  -1.47094482e-05,   7.28183536e-03,
         -3.32478476e-06,   1.03739914e-05,   1.21619244e-02,
         -1.31175940e-06,  -6.28305663e-02,  -3.92525927e-02],
       [  3.57926139e-06,  -5.63381579e-05,  -5.91340514e-06,
          6.06372729e-07,  -2.65346476e-07,  -7.43976859e-06,
          3.26914579e-01,   1.05201367e-04,  -3.71033907e-05,
         -1.47094482e-05,   2.60352525e-01,  -1.33546556e-05,
          3.59173103e-06,  -1.80013393e-02,  -5.24691665e-06,
         -6.23755448e-06,   1.41837611e-05,  -1.27067164e-04],
       [ -4.92124169e-03,  -1.57194122e-03,   3.10314764e-03,
         -6.31182273e-03,   2.10132740e-07,   1.11567545e-02,
         -1.77451412e-05,  -3.85415616e-03,   1.15376271e-06,
          7.28183536e-03,  -1.33546556e-05,   6.28527835e-04,
         -2.11116955e-07,   1.31009739e-06,   4.01277412e-04,
         -1.28812995e-08,  -4.92151859e-03,  -1.56733024e-03],
       [  2.32710725e-06,   1.12536093e-06,  -2.37177202e-07,
          7.10165393e-07,   1.28196419e-06,  -4.92587545e-06,
          4.51048831e-06,  -5.49614596e-07,   6.41248461e-07,
         -3.32478476e-06,   3.59173103e-06,  -2.11116955e-07,
          1.37349307e-10,  -2.48574412e-07,  -2.27039736e-07,
         -9.28835411e-08,   1.11948952e-06,   4.45779380e-07],
       [ -8.04369245e-06,  -9.59531705e-07,  -1.22360511e-06,
          3.89828980e-06,  -9.26597577e-06,   1.39156479e-05,
         -2.26035859e-02,   5.54279607e-07,  -2.08456267e-06,
          1.03739914e-05,  -1.80013393e-02,   1.31009739e-06,
         -2.48574412e-07,   1.24465260e-03,   1.12043180e-06,
          1.10335318e-06,  -2.97961512e-08,   8.83595513e-06],
       [ -3.74989408e-03,  -3.21821235e-03,  -3.73737898e-03,
          8.01476633e-03,   1.76399684e-06,   1.71951721e-02,
         -8.05616787e-06,   1.32556351e-02,   2.99075749e-06,
          1.21619244e-02,  -5.24691665e-06,   4.01277412e-04,
         -2.27039736e-07,   1.12043180e-06,   1.04319697e-03,
         -2.10281576e-07,  -3.75186626e-03,  -3.21147033e-03],
       [ -9.09033932e-03,  -5.09340393e-03,   3.76267547e-07,
         -2.04156096e-07,  -1.92986935e-02,  -2.17564090e-06,
         -8.79788108e-06,  -8.19337779e-07,  -9.66885999e-03,
         -1.31175940e-06,  -6.23755448e-06,  -1.28812995e-08,
         -9.28835411e-08,   1.10335318e-06,  -2.10281576e-07,
          1.39710801e-03,   9.09214715e-03,   5.09023851e-03],
       [ -2.01505904e-02,  -1.91207740e-02,  -1.83753757e-02,
          4.01613738e-02,  -1.25592034e-01,  -9.51629122e-02,
          1.98224830e-05,   1.80099253e-02,  -6.29323196e-02,
         -6.28305663e-02,   1.41837611e-05,  -4.92151859e-03,
          1.11948952e-06,  -2.97961512e-08,  -3.75186626e-03,
          9.09214715e-03,   9.81782088e-02,   4.71117712e-02],
       [ -1.91323820e-02,  -8.40671238e-03,   1.13807885e-02,
         -1.79783143e-02,  -7.03098470e-02,  -5.61197077e-02,
         -1.58265886e-04,  -3.45526111e-02,  -3.52326475e-02,
         -3.92525927e-02,  -1.27067164e-04,  -1.56733024e-03,
          4.45779380e-07,   8.83595513e-06,  -3.21147033e-03,
          5.09023851e-03,   4.71117712e-02,   2.86699593e-02]])
    ref_result_energy = -76.318442140824928
    ref_result_exp_alpha = array([[  1.67305175e-04,  -1.41635018e-01,   2.43217331e-01,
         -1.37619523e-01,  -4.33798028e-05,   1.16568419e-01,
          1.14225219e-01,  -8.43746031e-01,  -7.93750617e-01,
         -4.02688409e-04,   3.87296797e-01,  -2.28876559e-02,
         -1.72108532e-01,   2.59785552e-03,   9.54415825e-02,
          7.39527627e-04,   8.30148366e-01,  -9.58012275e-01],
       [  3.26907181e-03,  -1.05530474e-03,   1.36281840e-01,
         -1.00805026e-01,   8.59968731e-05,   9.34760192e-01,
          1.25865083e+00,   6.57830848e-01,   5.81560641e-01,
         -6.11821190e-04,  -5.16608276e-03,  -9.40380483e-01,
         -6.73577411e-01,   9.34426481e-04,   5.05744191e-02,
          7.05616791e-05,   1.12135883e-01,   1.27733168e-02],
       [  9.94909568e-01,   2.11522300e-01,   5.53335229e-06,
         -8.29635793e-02,  -3.62976384e-06,   9.32854468e-02,
         -1.29762535e-04,  -1.13418150e-04,  -4.35476789e-02,
         -1.30996588e-04,   5.94344252e-02,  -2.24757394e-05,
          6.81079636e-02,   3.71934268e-06,  -7.26999506e-04,
          1.25116075e-05,   1.74954017e-02,  -5.25750648e-07],
       [  2.90598039e-02,  -4.62674281e-01,  -2.79088651e-05,
          1.84412165e-01,   3.31633397e-05,  -1.72236504e-01,
          3.09725623e-04,   5.56103079e-04,   1.94432795e-01,
          7.72565649e-04,  -3.52989158e-01,   2.28965036e-04,
         -1.61573058e+00,   2.95939795e-03,   1.36521049e-01,
          4.95877367e-04,   5.60788382e-01,  -4.86426317e-06],
       [ -2.25158555e-07,   1.73196265e-05,   5.16312665e-01,
          3.89767925e-05,   2.50393539e-06,  -4.54156051e-04,
         -4.30560845e-01,   2.21875468e-01,  -1.29503572e-04,
         -6.84805764e-05,  -2.35471640e-04,  -9.76475672e-01,
         -7.16169512e-05,  -1.11275046e-04,   1.10651991e-05,
         -3.30553711e-05,  -7.81909214e-06,  -3.87065120e-02],
       [ -1.65057813e-03,   1.30890779e-01,  -1.61293382e-05,
          5.56610187e-01,   1.54463635e-04,   2.81413841e-01,
         -2.91725866e-04,  -5.52873782e-04,  -5.52556907e-01,
          2.73236185e-03,  -7.89074091e-01,   1.39080335e-04,
          1.87459014e-01,  -2.05251751e-04,  -8.65102793e-03,
         -3.20423680e-05,  -4.17821138e-02,  -2.68105267e-05],
       [ -2.21698895e-07,   3.09659532e-06,   2.82894081e-05,
          1.09789932e-04,  -6.40697866e-01,   2.13889690e-04,
         -8.08073732e-05,  -1.44807606e-04,   1.06024104e-03,
          9.62028690e-01,   2.61808048e-03,  -5.30260082e-05,
          1.98625282e-05,  -1.01243522e-05,  -3.60267842e-05,
          6.72916285e-03,   8.53807045e-05,   1.27390608e-05],
       [ -1.42410670e-02,  -4.65151241e-01,  -3.39995495e-05,
          3.47826830e-01,  -1.31618182e-04,  -1.09867448e+00,
          1.25902647e-03,  -2.31467527e-04,  -1.80552913e-01,
          3.69532548e-04,   4.34487361e-03,  -2.64837406e-04,
          2.53776169e+00,  -6.09053408e-03,  -2.71404431e-01,
         -1.14973156e-03,  -1.33500642e+00,   2.11876795e-05],
       [  4.33411571e-08,   1.01658971e-05,   2.58678450e-01,
          8.55253552e-05,   7.37269570e-05,  -9.39167448e-04,
         -7.58664957e-01,   3.98227263e-01,  -8.10593110e-04,
          1.18573381e-04,   5.83428618e-04,   1.69830925e+00,
          1.01350219e-04,  -2.61865200e-05,   2.20473050e-05,
         -4.18675468e-05,  -2.14573286e-05,   9.47363647e-01],
       [  2.56622449e-03,   6.48405708e-02,  -1.74265097e-05,
          3.89717379e-01,   1.26064857e-04,   4.31542109e-01,
         -5.95909675e-04,  -2.79068600e-04,   1.82806886e-01,
         -3.47052822e-03,   1.16307246e+00,  -2.56731866e-04,
         -6.33291107e-01,   3.56111031e-03,   1.51273946e-01,
          8.06160649e-04,   6.78477727e-01,   1.73154270e-05],
       [  7.77725530e-08,   1.21501399e-05,   1.95041402e-06,
          1.25454032e-04,  -5.10247672e-01,  -4.31276167e-05,
          4.35267707e-05,   1.58919764e-04,  -1.08794649e-03,
         -1.03655660e+00,  -2.85547792e-03,   8.98665540e-05,
         -3.79583455e-05,   1.15228267e-05,  -2.46501481e-04,
          3.51367455e-02,  -8.71857528e-05,  -2.17985114e-05],
       [  1.95254303e-04,   1.97888954e-02,  -1.39928154e-06,
          1.53911631e-02,   3.05314468e-05,   1.28643076e-02,
         -2.54412155e-05,   2.41189401e-04,   1.41624210e-01,
         -4.30244338e-05,  -6.84274452e-02,   3.38591153e-05,
          1.61985162e-01,  -1.04810172e-02,  -4.74134519e-01,
         -2.76485760e-03,   9.80046373e-01,   7.88872382e-06],
       [  9.72276284e-08,  -4.62237507e-06,   2.41162649e-06,
         -7.76052476e-06,  -6.98077111e-06,  -1.43519823e-05,
         -4.27362975e-06,   3.67603430e-05,   6.94554049e-05,
          7.75521694e-06,  -8.82456137e-05,  -1.10852989e-04,
         -1.02661261e-04,   9.99747161e-01,  -2.24804052e-02,
         -3.63485097e-04,  -1.83899589e-04,   2.07437748e-04],
       [  1.30407138e-07,   1.35927989e-07,  -1.81186320e-05,
          1.50918925e-05,   3.52796133e-02,   1.17709784e-05,
          6.68749673e-06,   5.81288896e-05,   9.03657767e-06,
          1.65060606e-02,   4.73813953e-05,  -3.80151461e-05,
         -2.31272699e-04,   2.26954247e-04,  -6.06594087e-03,
          9.99222686e-01,  -7.37989558e-05,   9.35239392e-05],
       [ -1.15290855e-04,  -4.58696869e-03,   1.10378971e-06,
          3.19709510e-02,   1.80267707e-05,   1.02891345e-02,
         -9.43136867e-06,  -2.08676738e-04,  -1.20469890e-01,
         -5.39689268e-05,   9.05638665e-02,  -4.32450494e-05,
         -1.85513078e-01,  -1.97252731e-02,  -8.72872317e-01,
         -5.37846167e-03,  -5.08388508e-01,   3.37677481e-05],
       [  1.94717971e-08,   6.43372517e-07,  -3.73778820e-02,
         -5.19255663e-06,   1.20804087e-05,   2.46561576e-05,
          1.73483537e-02,   2.09847380e-01,  -3.38682632e-04,
          6.01644223e-05,   1.41046343e-04,   3.38105439e-02,
          5.33845207e-06,   2.59526838e-04,  -4.55191451e-05,
          1.05739716e-04,  -3.45499106e-06,  -1.27369314e+00],
       [  1.67321790e-04,  -1.41648104e-01,  -2.43232877e-01,
         -1.37665708e-01,  -6.60335010e-05,   1.16558051e-01,
         -1.14943007e-01,   8.40765534e-01,  -7.96442163e-01,
         -1.89036461e-04,   3.88017774e-01,   2.24321626e-02,
         -1.72028381e-01,   2.14584774e-03,   9.55353419e-02,
          4.54591340e-04,   8.30177074e-01,   9.58002268e-01],
       [  3.26906223e-03,  -1.01773531e-03,  -1.36169423e-01,
         -1.00579282e-01,   2.23630211e-04,   9.31541182e-01,
         -1.26063572e+00,  -6.56125392e-01,   5.83791191e-01,
         -8.19439792e-04,  -5.51637915e-03,   9.40773473e-01,
         -6.73589358e-01,   1.18515162e-03,   5.05223568e-02,
          2.31096942e-04,   1.11999744e-01,  -1.27958207e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_numgga.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
