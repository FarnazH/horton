# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_uks_methyl_lda():
    ref_result_dm_alpha = array([[  1.03044642e+00,  -3.95667898e-02,   9.45932655e-07,
         -4.54255875e-07,  -1.85922937e-06,  -1.12443744e-01,
          6.08356898e-07,  -4.32428029e-07,  -1.46209296e-06,
          2.14734018e-03,  -6.50371233e-07,   3.29835642e-07,
          1.93240043e-07,  -5.44316588e-07,  -2.92091358e-02,
         -4.75384743e-03,  -2.92051319e-02,  -4.75735609e-03,
         -2.92059070e-02,  -4.75790467e-03],
       [ -3.95667898e-02,   1.56944917e-01,   6.41514250e-07,
          9.18975121e-09,   1.35765665e-06,   1.64063112e-01,
          3.73889538e-08,   5.98846822e-07,   6.98851754e-07,
         -4.08157483e-03,   1.17261684e-06,  -6.05581021e-07,
         -3.37490401e-07,   1.03801881e-06,   5.27734024e-02,
          1.98355725e-02,   5.27630112e-02,   1.98400214e-02,
          5.27651645e-02,   1.98417743e-02],
       [  9.45932655e-07,   6.41514250e-07,   2.06358936e-01,
         -1.23060891e-06,  -7.30105658e-06,  -1.99186886e-06,
          9.64118886e-02,  -4.56863813e-07,  -4.08593153e-06,
          2.94435748e-07,   8.59787152e-07,   1.92898714e-06,
          9.02494516e-03,   3.09239704e-06,   1.20074556e-01,
          1.04319312e-01,  -6.00270988e-02,  -5.21690836e-02,
         -6.00295173e-02,  -5.21637452e-02],
       [ -4.54255875e-07,   9.18975121e-09,  -1.23060891e-06,
          2.06358334e-01,  -1.55533785e-08,   3.48261122e-06,
         -1.96447809e-06,   9.64172550e-02,   1.64370593e-06,
         -6.83331412e-07,   2.32044285e-06,  -4.16297416e-06,
         -6.27587768e-07,  -9.02697757e-03,   5.36763746e-06,
         -2.72008486e-06,   1.03968858e-01,   9.03557843e-02,
         -1.03970802e-01,  -9.03574648e-02],
       [ -1.85922937e-06,   1.35765665e-06,  -7.30105658e-06,
         -1.55533785e-08,   3.54694838e-01,   1.48513935e-05,
         -1.24980562e-05,   5.67323153e-06,   3.17262986e-01,
          4.33175017e-07,  -1.76403249e-06,  -1.30222989e-06,
          2.19396178e-06,   1.85184366e-06,   1.31800532e-06,
          3.51083821e-06,  -1.56610832e-05,  -8.01794718e-06,
         -7.50666967e-06,  -3.91140893e-06],
       [ -1.12443744e-01,   1.64063112e-01,  -1.99186886e-06,
          3.48261122e-06,   1.48513935e-05,   1.76455500e-01,
         -1.21218778e-06,   2.25381532e-06,   1.27402328e-05,
         -4.34459384e-03,   1.25047265e-06,  -6.45530182e-07,
         -4.73313195e-07,   9.54269376e-07,   5.62732822e-02,
          2.07167100e-02,   5.62663126e-02,   2.07249938e-02,
          5.62651122e-02,   2.07238199e-02],
       [  6.08356898e-07,   3.73889538e-08,   9.64118886e-02,
         -1.96447809e-06,  -1.24980562e-05,  -1.21218778e-06,
          4.50440987e-02,  -8.62829424e-07,  -1.00369738e-05,
          1.44486499e-07,   4.01724269e-07,   9.01294501e-07,
          4.21649777e-03,   1.50551752e-06,   5.60993207e-02,
          4.87384513e-02,  -2.80457389e-02,  -2.43742883e-02,
         -2.80454689e-02,  -2.43705774e-02],
       [ -4.32428029e-07,   5.98846822e-07,  -4.56863813e-07,
          9.64172550e-02,   5.67323153e-06,   2.25381532e-06,
         -8.62829424e-07,   4.50492446e-02,   5.84901281e-06,
         -3.34805951e-07,   1.08416228e-06,  -1.94509756e-06,
         -2.88024619e-07,  -4.21769440e-03,   2.77775814e-06,
         -1.13596334e-06,   4.85777626e-02,   4.22171754e-02,
         -4.85783385e-02,  -4.22178703e-02],
       [ -1.46209296e-06,   6.98851754e-07,  -4.08593153e-06,
          1.64370593e-06,   3.17262986e-01,   1.27402328e-05,
         -1.00369738e-05,   5.84901281e-06,   2.83781413e-01,
          4.00943939e-07,  -1.57784469e-06,  -1.16481083e-06,
          2.06933778e-06,   1.58393529e-06,   2.42696624e-06,
          4.31099165e-06,  -1.40587050e-05,  -7.12916060e-06,
         -8.43521832e-06,  -4.90756938e-06],
       [  2.14734018e-03,  -4.08157483e-03,   2.94435748e-07,
         -6.83331412e-07,   4.33175017e-07,  -4.34459384e-03,
          1.44486499e-07,  -3.34805951e-07,   4.00943939e-07,
          1.07372753e-04,  -3.08930570e-08,   1.59580909e-08,
          2.24541405e-08,   2.56179102e-09,  -1.38969688e-03,
         -5.15424975e-04,  -1.39003951e-03,  -5.16077210e-04,
         -1.38940793e-03,  -5.15525135e-04],
       [ -6.50371233e-07,   1.17261684e-06,   8.59787152e-07,
          2.32044285e-06,  -1.76403249e-06,   1.25047265e-06,
          4.01724269e-07,   1.08416228e-06,  -1.57784469e-06,
         -3.08930570e-08,   4.73326456e-11,  -3.68845968e-11,
          3.75804091e-08,  -1.01494569e-07,   9.00152354e-07,
          5.82697599e-07,   1.31883836e-06,   9.46864770e-07,
         -1.01942538e-06,  -1.08519540e-06],
       [  3.29835642e-07,  -6.05581021e-07,   1.92898714e-06,
         -4.16297416e-06,  -1.30222989e-06,  -6.45530182e-07,
          9.01294501e-07,  -1.94509756e-06,  -1.16481083e-06,
          1.59580909e-08,  -3.68845968e-11,   1.09160973e-10,
          8.43664987e-08,   1.82123468e-07,   9.15892092e-07,
          8.98671594e-07,  -2.86480720e-06,  -2.38692125e-06,
          1.32999532e-06,   1.25871916e-06],
       [  1.93240043e-07,  -3.37490401e-07,   9.02494516e-03,
         -6.27587768e-07,   2.19396178e-06,  -4.73313195e-07,
          4.21649777e-03,  -2.88024619e-07,   2.06933778e-06,
          2.24541405e-08,   3.75804091e-08,   8.43664987e-08,
          3.94698872e-04,   1.60353241e-07,   5.25124208e-03,
          4.56227660e-03,  -2.62565080e-03,  -2.28187118e-03,
         -2.62517836e-03,  -2.28113522e-03],
       [ -5.44316588e-07,   1.03801881e-06,   3.09239704e-06,
         -9.02697757e-03,   1.85184366e-06,   9.54269376e-07,
          1.50551752e-06,  -4.21769440e-03,   1.58393529e-06,
          2.56179102e-09,  -1.01494569e-07,   1.82123468e-07,
          1.60353241e-07,   3.94877856e-04,   1.88716181e-06,
          1.78625601e-06,  -4.54856330e-03,  -3.95317734e-03,
          4.54758808e-03,   3.95197691e-03],
       [ -2.92091358e-02,   5.27734024e-02,   1.20074556e-01,
          5.36763746e-06,   1.31800532e-06,   5.62732822e-02,
          5.60993207e-02,   2.77775814e-06,   2.42696624e-06,
         -1.38969688e-03,   9.00152354e-07,   9.15892092e-07,
          5.25124208e-03,   1.88716181e-06,   8.78609975e-02,
          6.73663232e-02,  -1.69354557e-02,  -2.36856017e-02,
         -1.69422553e-02,  -2.36872231e-02],
       [ -4.75384743e-03,   1.98355725e-02,   1.04319312e-01,
         -2.72008486e-06,   3.51083821e-06,   2.07167100e-02,
          4.87384513e-02,  -1.13596334e-06,   4.31099165e-06,
         -5.15424975e-04,   5.82697599e-07,   8.98671594e-07,
          4.56227660e-03,   1.78625601e-06,   6.73663232e-02,
          5.52427812e-02,  -2.36816128e-02,  -2.38660911e-02,
         -2.36804480e-02,  -2.38613326e-02],
       [ -2.92051319e-02,   5.27630112e-02,  -6.00270988e-02,
          1.03968858e-01,  -1.56610832e-05,   5.62663126e-02,
         -2.80457389e-02,   4.85777626e-02,  -1.40587050e-05,
         -1.39003951e-03,   1.31883836e-06,  -2.86480720e-06,
         -2.62565080e-03,  -4.54856330e-03,  -1.69354557e-02,
         -2.36816128e-02,   8.78292699e-02,   6.73648901e-02,
         -1.69345004e-02,  -2.36839262e-02],
       [ -4.75735609e-03,   1.98400214e-02,  -5.21690836e-02,
          9.03557843e-02,  -8.01794718e-06,   2.07249938e-02,
         -2.43742883e-02,   4.22171754e-02,  -7.12916060e-06,
         -5.16077210e-04,   9.46864770e-07,  -2.38692125e-06,
         -2.28187118e-03,  -3.95317734e-03,  -2.36856017e-02,
         -2.38660911e-02,   6.73648901e-02,   5.52596790e-02,
         -2.36820934e-02,  -2.38680373e-02],
       [ -2.92059070e-02,   5.27651645e-02,  -6.00295173e-02,
         -1.03970802e-01,  -7.50666967e-06,   5.62651122e-02,
         -2.80454689e-02,  -4.85783385e-02,  -8.43521832e-06,
         -1.38940793e-03,  -1.01942538e-06,   1.32999532e-06,
         -2.62517836e-03,   4.54758808e-03,  -1.69422553e-02,
         -2.36804480e-02,  -1.69345004e-02,  -2.36820934e-02,
          8.78348330e-02,   6.73671465e-02],
       [ -4.75790467e-03,   1.98417743e-02,  -5.21637452e-02,
         -9.03574648e-02,  -3.91140893e-06,   2.07238199e-02,
         -2.43705774e-02,  -4.22178703e-02,  -4.90756938e-06,
         -5.15525135e-04,  -1.08519540e-06,   1.25871916e-06,
         -2.28113522e-03,   3.95197691e-03,  -2.36872231e-02,
         -2.38613326e-02,  -2.36839262e-02,  -2.38680373e-02,
          6.73671465e-02,   5.52594413e-02]])
    ref_result_energy = -39.412919303491627
    ref_result_exp_alpha = array([[  9.93908962e-01,   2.06376811e-01,  -3.34100334e-07,
         -3.93193699e-08,   3.84474215e-06,  -1.56645610e-01,
         -3.51375630e-06,  -1.50126639e-05,   5.71320375e-07,
          8.82742983e-06,  -4.16075832e-06,   4.66869072e-02,
          1.57394628e-06,  -2.50135514e-06,   3.95159365e-02,
          1.87171577e-06,   1.39610503e-06,   4.01306784e-02,
         -2.90161696e-06,  -8.66088848e-06],
       [  4.19872767e-02,  -3.93931405e-01,   3.57304105e-06,
          5.19180723e-06,  -3.48547256e-06,   2.62887691e-01,
          9.49323962e-06,   2.01611880e-05,   1.48432929e-05,
          9.64025205e-05,  -5.33360733e-05,   7.37424768e-01,
          5.52801136e-04,  -9.27881962e-05,  -1.92069855e+00,
         -5.25847776e-06,   3.56374350e-06,   2.76129349e-01,
          5.61017217e-06,  -1.62116915e-05],
       [ -7.24741381e-08,   5.51259599e-06,   3.20706427e-01,
          3.21723912e-01,   2.28339422e-05,  -4.61369067e-05,
          5.08644609e-02,   4.45884079e-01,  -7.61429282e-05,
          8.22745320e-01,  -2.06387085e-01,  -3.38971975e-04,
          6.52031505e-01,  -3.24208609e-01,   1.20047079e-04,
          1.44856366e-05,  -2.29318170e-08,   6.82650368e-06,
          5.08630120e-02,   3.48763988e-02],
       [ -8.31461384e-08,  -1.34080283e-06,   3.21721531e-01,
         -3.20707878e-01,  -7.51375519e-06,  -1.61829569e-05,
          4.45887728e-01,  -5.08802245e-02,  -6.70754313e-05,
         -2.06355052e-01,  -8.22839650e-01,  -2.99485357e-05,
         -3.24209952e-01,  -6.51919763e-01,  -6.25202658e-05,
         -3.08086262e-06,  -4.54902718e-06,  -1.17322965e-05,
          3.48617600e-02,  -5.08604501e-02],
       [  5.34217994e-08,   1.82906356e-06,   2.78699896e-06,
          1.67975292e-05,  -5.95562564e-01,  -6.80620526e-06,
          4.44959454e-07,   7.55032480e-06,   1.06110907e+00,
          6.12642644e-05,  -1.09232763e-04,  -3.23114407e-06,
          1.82205394e-05,  -1.31984567e-07,   6.96664685e-06,
         -3.13817290e-06,   3.96716698e-06,   1.53128437e-06,
         -2.61174718e-06,  -9.70236891e-07],
       [ -2.60779052e-02,  -4.19255810e-01,   5.04378239e-06,
         -4.03924251e-06,  -2.62264930e-05,   1.85135188e+00,
          7.29188003e-05,   1.71182395e-04,  -2.78262223e-05,
         -1.21291020e-04,   8.88979065e-05,  -1.15996553e+00,
         -9.93215773e-04,   1.37526651e-04,   3.55526566e+00,
          5.98834567e-06,  -1.23894740e-05,  -7.87618619e-01,
          1.62803714e-05,   7.53751246e-05],
       [ -5.36491934e-09,   3.24435756e-06,   1.49833433e-01,
          1.50313132e-01,   2.59259714e-05,  -1.08981061e-04,
          1.43327190e-01,   1.25622471e+00,   1.62050371e-04,
         -1.68832423e+00,   4.23485341e-01,   6.01646551e-04,
         -9.77646837e-01,   4.86079823e-01,  -1.61154333e-04,
         -2.75157622e-05,  -1.50974603e-05,   8.25221670e-05,
          4.36933918e-01,   2.99498668e-01],
       [  5.10359086e-08,  -2.12607667e-06,   1.50318850e-01,
         -1.49844870e-01,  -1.30487050e-05,  -3.25984746e-05,
          1.25621764e+00,  -1.43301223e-01,   1.36624017e-04,
          4.23440427e-01,   1.68846792e+00,  -1.25326034e-05,
          4.86139184e-01,   9.77396917e-01,   5.97257112e-05,
          7.89810743e-06,   2.48744248e-05,  -5.31859202e-05,
          2.99519223e-01,  -4.36923554e-01],
       [ -2.02943714e-08,   2.93749439e-06,   8.87644941e-06,
          1.62599636e-05,  -5.32711439e-01,  -7.77351149e-06,
         -4.38242066e-06,   1.16363893e-05,  -1.09401360e+00,
         -7.28043167e-05,   1.08239061e-04,   1.93647667e-05,
         -3.46490399e-06,  -4.88689685e-07,  -1.61799327e-06,
          4.38162619e-07,  -9.28576732e-07,   7.61235130e-07,
          3.29649028e-06,  -8.52851943e-08],
       [  8.90160470e-06,   1.03620783e-02,  -6.74848506e-07,
          1.41040635e-06,  -6.95438243e-07,   1.20784880e-02,
          8.22509380e-07,   2.82196403e-06,  -2.17766724e-06,
         -2.74273743e-05,   1.31856516e-05,  -1.83239114e-01,
         -4.11451296e-05,   1.35434672e-05,  -3.42553521e-02,
         -1.97600917e-05,   3.12133020e-05,   1.05119542e+00,
         -7.39124324e-05,  -1.69391283e-04],
       [ -3.54917943e-08,  -2.98049664e-06,   4.95384236e-06,
         -2.26593439e-06,   2.96192303e-06,  -7.32351858e-06,
         -1.61942838e-06,   3.50602181e-06,  -2.01099819e-06,
         -2.97102944e-06,  -5.93974270e-06,   2.92168144e-05,
          2.30317701e-05,   2.59951048e-06,   1.11635421e-05,
         -9.77983041e-01,   2.08684378e-01,  -1.90122263e-05,
         -1.33025778e-05,  -1.26309105e-05],
       [  1.23567041e-08,   1.53866601e-06,  -3.49248139e-06,
          9.47703763e-06,   2.18681217e-06,   1.25137530e-06,
          3.39122277e-06,   1.27348885e-06,  -1.81053069e-06,
          6.32977966e-06,   1.27989417e-05,  -1.10291584e-05,
         -2.48064430e-05,  -2.12842262e-05,  -7.06562164e-06,
          2.08684377e-01,   9.77983040e-01,  -2.72937216e-05,
         -7.01167672e-06,   3.99076891e-05],
       [ -4.21774259e-08,   1.16491638e-06,   1.40249482e-02,
          1.40712334e-02,  -3.22134056e-06,  -1.88888106e-06,
         -2.39215956e-03,  -2.09807724e-02,  -4.97247421e-06,
          1.07717869e-01,  -2.70075182e-02,   2.26628436e-05,
         -1.84776928e-01,   9.18811982e-02,  -2.30372688e-05,
         -2.77366586e-05,  -1.57510793e-05,   1.59607508e-04,
          8.93757301e-01,   6.12662226e-01],
       [ -1.62297217e-08,  -2.57937666e-06,  -1.40687246e-02,
          1.40338430e-02,  -2.77942865e-06,  -4.43227045e-06,
          2.09725785e-02,  -2.39322106e-03,   8.65414703e-06,
          2.70254196e-02,   1.07701098e-01,   3.33363268e-05,
         -9.19083948e-02,  -1.84784456e-01,  -5.99225588e-07,
         -1.64667307e-05,  -4.55390621e-05,   1.04910914e-04,
         -6.12666262e-01,   8.93751868e-01],
       [ -1.53799458e-03,  -1.34125728e-01,   1.86620578e-01,
          1.87194250e-01,   3.52789139e-06,  -1.03102352e-01,
         -1.39688517e-02,  -1.22705524e-01,  -2.22204850e-05,
          3.88476638e-01,  -9.74171634e-02,   6.27345840e-01,
         -7.94428342e-01,   3.95051412e-01,   3.11888934e-01,
          1.39892635e-05,   1.52336261e-05,   3.76019804e-01,
         -5.66329575e-01,  -3.88313955e-01],
       [  5.54887064e-03,  -4.97578313e-02,   1.62121772e-01,
          1.62642874e-01,  -7.01506639e-07,  -9.59660339e-01,
         -1.84431051e-01,  -1.61602574e+00,  -5.83715631e-05,
          5.16525362e-01,  -1.29603655e-01,  -1.72689416e-01,
          1.38720901e+00,  -6.89685998e-01,  -1.09911996e+00,
          1.56794851e-05,   1.02017051e-05,   6.34001230e-02,
         -4.13774126e-03,  -2.78613749e-03],
       [ -1.53806651e-03,  -1.34106257e-01,   6.88039314e-02,
         -2.55163558e-01,   1.90094730e-05,  -1.03090642e-01,
         -9.92285530e-02,   7.34469949e-02,  -1.27390095e-05,
         -2.78413379e-01,  -2.87596340e-01,   6.27150054e-01,
          7.39472970e-01,   4.90507028e-01,   3.12245866e-01,
          3.54748643e-05,   2.22542202e-05,   3.76249964e-01,
         -5.30638365e-02,   6.84499471e-01],
       [  5.54888031e-03,  -4.97751182e-02,   5.97922694e-02,
         -2.21757153e-01,   7.33558581e-06,  -9.59871691e-01,
         -1.30732222e+00,   9.67546006e-01,   5.72017343e-06,
         -3.70564233e-01,  -3.82747332e-01,  -1.71912637e-01,
         -1.29061601e+00,  -8.56245710e-01,  -1.09962829e+00,
         -4.21650372e-05,  -3.63439529e-05,   6.33949612e-02,
         -3.82829310e-04,   4.97485375e-03],
       [ -1.53808098e-03,  -1.34110406e-01,  -2.55388689e-01,
          6.79962522e-02,   1.29149681e-05,  -1.03115238e-01,
          1.13250216e-01,   4.92023341e-02,   5.14816411e-05,
         -1.09703068e-01,   3.84864319e-01,   6.27161884e-01,
          5.51704737e-02,  -8.85717869e-01,   3.12100276e-01,
          9.28882922e-06,   1.04907137e-05,   3.76122987e-01,
          6.19345430e-01,  -2.96428115e-01],
       [  5.54892968e-03,  -4.97784166e-02,  -2.21940939e-01,
          5.91016376e-02,   7.04342429e-06,  -9.59926378e-01,
          1.49159428e+00,   6.48238260e-01,   6.19286562e-05,
         -1.46157203e-01,   5.12389612e-01,  -1.72004716e-01,
         -9.59938348e-02,   1.54595454e+00,  -1.09944571e+00,
         -1.09159949e-05,   1.37109177e-05,   6.33932639e-02,
          4.51693736e-03,  -2.14071547e-03]])
    ref_result_exp_beta = array([[  9.94135061e-01,   1.99442664e-01,   1.52194719e-07,
          2.69362633e-07,  -4.37213835e-06,   1.62541256e-01,
         -3.65199062e-06,   1.70120168e-05,   1.07353666e-05,
          4.99835664e-06,  -2.60291263e-07,   5.45681570e-02,
          7.18722249e-06,   3.90146060e-06,   4.11023336e-02,
         -1.53904826e-06,   1.07779065e-06,   3.41652928e-02,
          4.35913335e-06,  -1.07583166e-05],
       [  4.02171174e-02,  -3.74495743e-01,   3.42147818e-06,
          4.26855152e-06,   3.80145948e-06,  -2.54183873e-01,
          8.97302538e-06,  -2.19666364e-05,   9.00286726e-05,
          4.72585855e-05,  -1.00523034e-05,   6.36708010e-01,
          3.96617838e-04,   6.30546976e-05,  -1.95646938e+00,
          3.89307535e-06,   7.04260249e-06,   3.09090826e-01,
          1.20556286e-05,  -4.84685622e-05],
       [ -6.73275434e-08,   4.19804683e-06,   3.23641372e-01,
          2.86203088e-01,  -2.15709074e-05,   5.11129063e-05,
          6.75101665e-02,  -4.38461820e-01,   8.12355640e-01,
          1.96956143e-01,  -4.75191549e-05,  -3.68904640e-04,
          6.78178728e-01,   3.39906288e-01,   7.03437622e-05,
         -1.24856910e-05,   7.34701464e-07,   1.23201526e-05,
         -5.02965939e-02,   3.39959735e-02],
       [ -7.31348789e-08,  -2.35902804e-06,   2.86200908e-01,
         -3.23642120e-01,   6.50655001e-06,   1.42247024e-05,
          4.38464936e-01,   6.75270302e-02,  -1.96918293e-01,
          8.12459754e-01,  -2.20201673e-04,  -2.62474996e-05,
         -3.39909990e-01,   6.78061023e-01,  -4.65219195e-05,
          2.73272758e-06,  -2.90210983e-06,  -1.37775185e-05,
         -3.39812700e-02,  -5.02939042e-02],
       [  6.97858437e-09,   4.19609448e-06,   4.50068253e-06,
          1.67388356e-05,   5.45715499e-01,   6.36685926e-06,
          4.95605900e-07,  -6.75471564e-06,  -6.41308758e-06,
         -2.87721578e-04,  -1.08758529e+00,  -1.11841377e-06,
          1.88194625e-05,   4.00829811e-07,   5.02192043e-06,
          3.66453669e-06,   3.86551674e-06,   2.34849653e-06,
          2.80090637e-06,  -9.76425736e-07],
       [ -2.46075463e-02,  -3.77509744e-01,   4.47316746e-06,
         -4.10651048e-06,   2.60161282e-05,  -1.91246749e+00,
          7.66068392e-05,  -1.93598245e-04,  -1.18747259e-04,
         -8.45441913e-05,   1.61966364e-05,  -1.02963336e+00,
         -7.03814663e-04,  -8.48349764e-05,   3.56431678e+00,
         -5.06149918e-06,  -1.62718793e-05,  -8.02861627e-01,
         -5.82037770e-05,   1.48349878e-04],
       [ -7.21648978e-09,   2.76940009e-06,   1.44847153e-01,
          1.28095235e-01,  -2.63661473e-05,   1.24539739e-04,
          1.97848953e-01,  -1.28481114e+00,  -1.65501411e+00,
         -4.01223698e-01,   9.45219433e-05,   6.38381550e-04,
         -9.94603826e-01,  -4.98463335e-01,  -8.63237689e-05,
          2.80848264e-05,  -1.60768914e-05,   1.31413904e-04,
         -4.39322073e-01,   2.96836638e-01],
       [  4.55350552e-08,  -2.48072616e-06,   1.28100658e-01,
         -1.44858644e-01,   1.24822201e-05,   3.01113737e-05,
          1.28480541e+00,   1.97822766e-01,   4.01170966e-01,
         -1.65516849e+00,   4.47321430e-04,  -2.20587057e-05,
          4.98527244e-01,  -9.94344313e-01,   3.74690283e-05,
         -4.41983220e-06,   2.25492824e-05,  -7.62252512e-05,
         -2.96856989e-01,  -4.39312217e-01],
       [ -3.61966816e-09,   4.35000725e-06,   1.04355261e-05,
          1.65551495e-05,   5.82870590e-01,   6.10280112e-06,
         -2.85194954e-06,  -1.10605035e-05,  -4.66196323e-06,
          2.87263871e-04,   1.06813344e+00,   1.75694666e-05,
         -3.57841738e-06,   1.84767465e-07,  -1.75070096e-07,
         -7.33494620e-07,  -7.38202945e-07,   5.19874421e-07,
         -3.07086023e-06,  -5.36662163e-07],
       [ -5.54668056e-04,   2.54314954e-02,  -8.06435373e-07,
          1.55093990e-06,  -4.93016869e-07,   7.17450395e-03,
          3.03048464e-07,  -3.59334669e-07,  -2.55827394e-05,
         -1.21557725e-05,   2.31860753e-06,  -1.64451706e-01,
         -4.57297739e-05,  -1.31655737e-05,  -5.17759969e-03,
          2.02798040e-05,   2.82459527e-05,   1.05463041e+00,
          1.29557745e-04,  -2.62047853e-04],
       [ -8.15500633e-10,  -4.55812500e-06,   4.59596875e-06,
         -2.96807258e-06,  -2.97979093e-06,   6.09168756e-06,
         -1.52079723e-06,  -2.75276739e-06,  -3.33897157e-06,
          6.21176814e-06,   2.41578327e-06,   2.82286744e-05,
          2.12247284e-05,  -3.13745104e-06,   8.84640258e-06,
          9.86154535e-01,   1.65828922e-01,  -1.88953455e-05,
          1.88203495e-05,  -1.27560299e-05],
       [ -5.58731502e-09,   2.23694085e-06,  -3.41905382e-06,
          1.04045448e-05,  -2.27038382e-06,  -6.50667084e-07,
          2.64521083e-06,  -1.31675082e-06,   6.73718700e-06,
         -1.34449059e-05,   1.81024796e-06,  -1.10867595e-05,
         -2.33824618e-05,   1.91703632e-05,  -4.68917686e-06,
         -1.65828921e-01,   9.86154534e-01,  -2.50162386e-05,
          4.54902781e-06,   3.88172076e-05],
       [ -4.20643385e-08,   1.02990224e-06,   1.45234041e-02,
          1.28456680e-02,   3.63831338e-06,   1.71744647e-06,
         -2.73241125e-03,   1.77531934e-02,   1.10246271e-01,
          2.67141595e-02,  -1.17126559e-05,   2.49515160e-05,
         -1.77693793e-01,  -8.90661046e-02,  -5.23579539e-06,
          3.16948428e-05,  -1.73492026e-05,   2.59376753e-04,
         -8.98860319e-01,   6.07363734e-01],
       [ -1.61193996e-08,  -3.00469616e-06,  -1.28417345e-02,
          1.45322106e-02,   3.01593134e-06,   3.76177860e-06,
          1.77450602e-02,   2.73257113e-03,   2.67342467e-02,
         -1.10228644e-01,   2.99595977e-05,   3.52562053e-05,
         -8.90931491e-02,   1.77701282e-01,   3.33958918e-06,
          1.08177891e-05,  -4.38534669e-05,   1.51988280e-04,
          6.07368018e-01,   8.98855034e-01],
       [ -1.54415048e-03,  -1.45108642e-01,   2.07184450e-01,
          1.83201202e-01,  -4.11120357e-06,   9.02901312e-02,
         -1.66714385e-02,   1.08471888e-01,   4.11026712e-01,
          9.96175131e-02,  -3.83928776e-05,   6.48514760e-01,
         -7.86009148e-01,  -3.94009154e-01,   2.87327399e-01,
         -1.72956101e-05,   1.41879770e-05,   3.58520571e-01,
          5.64197567e-01,  -3.81348271e-01],
       [  5.23714407e-03,  -7.07455934e-02,   1.91932497e-01,
          1.69737079e-01,   2.44724470e-07,   9.76844732e-01,
         -2.50265048e-01,   1.62487437e+00,   4.67769150e-01,
          1.13446472e-01,  -1.44360911e-05,  -2.12748799e-01,
          1.37961065e+00,   6.91428891e-01,  -1.07500501e+00,
         -1.43293135e-05,   1.22635858e-05,   7.40277865e-02,
          7.20498097e-03,  -4.82335327e-03],
       [ -1.54422258e-03,  -1.45086264e-01,   5.50657895e-02,
         -2.70973739e-01,  -1.83296900e-05,   9.02795556e-02,
         -8.55500520e-02,  -6.86711527e-02,  -2.91583466e-01,
          3.06016689e-01,  -7.85407125e-05,   6.48304086e-01,
          7.34438433e-01,  -4.83768435e-01,   2.87559533e-01,
         -3.29496798e-05,   2.18243330e-05,   3.58866110e-01,
          4.80981179e-02,   6.79111640e-01],
       [  5.23715531e-03,  -7.07647545e-02,   5.10284660e-02,
         -2.51125190e-01,  -2.98262417e-06,   9.77085137e-01,
         -1.28206234e+00,  -1.02896738e+00,  -3.32195932e-01,
          3.48614132e-01,  -1.10741193e-04,  -2.11924882e-01,
         -1.28850075e+00,   8.48857124e-01,  -1.07530848e+00,
          3.78430026e-05,  -3.39303041e-05,   7.40273651e-02,
          6.13527854e-04,   8.63439535e-03],
       [ -1.54423538e-03,  -1.45089953e-01,  -2.62211737e-01,
          8.77991653e-02,  -1.22779304e-05,   9.03037514e-02,
          1.02276237e-01,  -3.97455069e-02,  -1.19057973e-01,
         -4.05479737e-01,   1.03688164e-04,   6.48323399e-01,
          5.19255612e-02,   8.77967669e-01,   2.87452647e-01,
         -3.87534992e-06,   9.33523935e-06,   3.58689401e-01,
         -6.12193810e-01,  -2.98092298e-01],
       [  5.23719919e-03,  -7.07686463e-02,  -2.42992302e-01,
          8.13748325e-02,  -5.49842390e-06,   9.77130025e-01,
          1.53216283e+00,  -5.95634415e-01,  -1.35786343e-01,
         -4.62103365e-01,   1.23640505e-04,  -2.12035985e-01,
         -9.08239368e-02,  -1.54036828e+00,  -1.07518641e+00,
          1.02808991e-05,   1.29122716e-05,   7.40245258e-02,
         -7.80275144e-03,  -3.78737038e-03]])
    ref_result_dm_beta = array([[  1.02808190e+00,  -3.47091983e-02,   8.96689013e-07,
         -5.86814642e-07,   8.43808578e-07,  -9.97547808e-02,
          6.01709784e-07,  -4.69017872e-07,   8.63971633e-07,
          4.52071090e-03,  -9.09895384e-07,   4.40589190e-07,
          1.69259617e-07,  -6.13329463e-07,  -3.04758663e-02,
         -8.90318122e-03,  -3.04716203e-02,  -8.90712640e-03,
         -3.04723204e-02,  -8.90781417e-03],
       [ -3.47091983e-02,   1.41864521e-01,   7.54143203e-07,
          4.78250331e-07,  -1.57101852e-06,   1.40386178e-01,
          4.95578137e-09,   7.50809570e-07,  -1.62907683e-06,
         -9.54629618e-03,   1.70696879e-06,  -8.37916928e-07,
         -2.82862282e-07,   1.14269150e-06,   5.42819623e-02,
          2.67059209e-02,   5.42711197e-02,   2.67108185e-02,
          5.42729466e-02,   2.67126911e-02],
       [  8.96689013e-07,   7.54143203e-07,   1.86656008e-01,
         -9.19762987e-07,   6.24733283e-06,  -1.31076133e-06,
          8.35398054e-02,  -3.18625858e-07,   8.11552204e-06,
          2.89685901e-07,   6.37964955e-07,   1.87127530e-06,
          8.37684674e-03,   3.04695428e-06,   1.19485613e-01,
          1.10696265e-01,  -5.97325683e-02,  -5.53581746e-02,
         -5.97347894e-02,  -5.53529259e-02],
       [ -5.86814642e-07,   4.78250331e-07,  -9.19762987e-07,
          1.86655244e-01,  -4.12930405e-06,   3.50161502e-06,
         -1.62685172e-06,   8.35449053e-02,  -2.37129727e-06,
         -7.92705438e-07,   2.27597483e-06,  -4.34588151e-06,
         -7.87798756e-07,  -8.37855393e-03,   5.09468876e-06,
         -2.64669394e-06,   1.03458747e-01,   9.58792399e-02,
         -1.03460414e-01,  -9.58807651e-02],
       [  8.43808578e-07,  -1.57101852e-06,   6.24733283e-06,
         -4.12930405e-06,   3.18051338e-10,  -1.58425320e-06,
          2.79608832e-06,  -1.84823551e-06,   3.42333317e-10,
          1.06729144e-07,  -4.81226751e-11,   1.68157871e-10,
          2.80391142e-07,   1.85443157e-07,   3.39015911e-06,
          3.40821555e-06,  -4.89674491e-06,  -4.27077240e-06,
         -3.19284730e-07,  -2.84200898e-08],
       [ -9.97547808e-02,   1.40386178e-01,  -1.31076133e-06,
          3.50161502e-06,  -1.58425320e-06,   1.43119156e-01,
         -9.23402430e-07,   2.10325515e-06,  -1.64208038e-06,
         -9.58698974e-03,   1.72078939e-06,  -8.44387535e-07,
         -3.75549520e-07,   1.01757898e-06,   5.48180976e-02,
          2.65784299e-02,   5.48108361e-02,   2.65867612e-02,
          5.48093365e-02,   2.65855487e-02],
       [  6.01709784e-07,   4.95578137e-09,   8.35398054e-02,
         -1.62685172e-06,   2.79608832e-06,  -9.23402430e-07,
          3.73890943e-02,  -6.86517215e-07,   3.63220420e-06,
          1.52290997e-07,   2.85508864e-07,   8.37538683e-07,
          3.74914344e-03,   1.41824061e-06,   5.34768787e-02,
          4.95431827e-02,  -2.67347247e-02,  -2.47768043e-02,
         -2.67343716e-02,  -2.47732068e-02],
       [ -4.69017872e-07,   7.50809570e-07,  -3.18625858e-07,
          8.35449053e-02,  -1.84823551e-06,   2.10325515e-06,
         -6.86517215e-07,   3.73938126e-02,  -1.06136963e-06,
         -3.91085965e-07,   1.01870898e-06,  -1.94517267e-06,
         -3.48435601e-07,  -3.75015177e-03,   2.54653514e-06,
         -1.02823315e-06,   4.63072136e-02,   4.29146034e-02,
         -4.63076057e-02,  -4.29151388e-02],
       [  8.63971633e-07,  -1.62907683e-06,   8.11552204e-06,
         -2.37129727e-06,   3.42333317e-10,  -1.64208038e-06,
          3.63220420e-06,  -1.06136963e-06,   4.01895206e-10,
          1.10644982e-07,  -2.10027105e-11,   1.46299639e-10,
          3.64225821e-07,   1.06559605e-07,   4.56379185e-06,
          4.50517920e-06,  -4.54248204e-06,  -3.93274698e-06,
         -1.91391713e-06,  -1.49643838e-06],
       [  4.52071090e-03,  -9.54629618e-03,   2.89685901e-07,
         -7.92705438e-07,   1.06729144e-07,  -9.58698974e-03,
          1.52290997e-07,  -3.91085965e-07,   1.10644982e-07,
          6.47068728e-04,  -1.15927793e-07,   5.69107478e-08,
          3.44258900e-08,  -4.35103419e-08,  -3.68935624e-03,
         -1.80196206e-03,  -3.68936881e-03,  -1.80298846e-03,
         -3.68865032e-03,  -1.80233467e-03],
       [ -9.09895384e-07,   1.70696879e-06,   6.37964955e-07,
          2.27597483e-06,  -4.81226751e-11,   1.72078939e-06,
          2.85508864e-07,   1.01870898e-06,  -2.10027105e-11,
         -1.15927793e-07,   5.07089513e-11,  -5.67913405e-11,
          2.86179893e-08,  -1.02139182e-07,   1.06988958e-06,
          7.00792384e-07,   1.71866960e-06,   1.30242999e-06,
         -8.04375006e-07,  -1.03574609e-06],
       [  4.40589190e-07,  -8.37916928e-07,   1.87127530e-06,
         -4.34588151e-06,   1.68157871e-10,  -8.44387535e-07,
          8.37538683e-07,  -1.94517267e-06,   1.46299639e-10,
          5.69107478e-08,  -5.67913405e-11,   1.24947964e-10,
          8.39993431e-08,   1.95100483e-07,   8.73159468e-07,
          9.51526317e-07,  -3.33216645e-06,  -2.94563240e-06,
          1.48547189e-06,   1.51913193e-06],
       [  1.69259617e-07,  -2.82862282e-07,   8.37684674e-03,
         -7.87798756e-07,   2.80391142e-07,  -3.75549520e-07,
          3.74914344e-03,  -3.48435601e-07,   3.64225821e-07,
          3.44258900e-08,   2.86179893e-08,   8.39993431e-08,
          3.75940548e-04,   1.70249938e-07,   5.36221625e-03,
          4.96782561e-03,  -2.68124550e-03,  -2.48483656e-03,
         -2.68051762e-03,  -2.48383408e-03],
       [ -6.13329463e-07,   1.14269150e-06,   3.04695428e-06,
         -8.37855393e-03,   1.85443157e-07,   1.01757898e-06,
          1.41824061e-06,  -3.75015177e-03,   1.06559605e-07,
         -4.35103419e-08,  -1.02139182e-07,   1.95100483e-07,
          1.70249938e-07,   3.76095390e-04,   2.14677405e-06,
          2.12128577e-06,  -4.64455199e-03,  -4.30448502e-03,
          4.64360572e-03,   4.30321079e-03],
       [ -3.04758663e-02,   5.42819623e-02,   1.19485613e-01,
          5.09468876e-06,   3.39015911e-06,   5.48180976e-02,
          5.34768787e-02,   2.54653514e-06,   4.56379185e-06,
         -3.68935624e-03,   1.06988958e-06,   8.73159468e-07,
          5.36221625e-03,   2.14677405e-06,   9.75469659e-02,
          8.11191476e-02,  -1.71782825e-02,  -2.51736351e-02,
         -1.71850899e-02,  -2.51751976e-02],
       [ -8.90318122e-03,   2.67059209e-02,   1.10696265e-01,
         -2.64669394e-06,   3.40821555e-06,   2.65784299e-02,
          4.95431827e-02,  -1.02823315e-06,   4.50517920e-06,
         -1.80196206e-03,   7.00792384e-07,   9.51526317e-07,
          4.96782561e-03,   2.12128577e-06,   8.11191476e-02,
          7.06810875e-02,  -2.51692433e-02,  -2.77975000e-02,
         -2.51677856e-02,  -2.77917819e-02],
       [ -3.04716203e-02,   5.42711197e-02,  -5.97325683e-02,
          1.03458747e-01,  -4.89674491e-06,   5.48108361e-02,
         -2.67347247e-02,   4.63072136e-02,  -4.54248204e-06,
         -3.68936881e-03,   1.71866960e-06,  -3.33216645e-06,
         -2.68124550e-03,  -4.64455199e-03,  -1.71782825e-02,
         -2.51692433e-02,   9.75114037e-02,   8.11171331e-02,
         -1.71772191e-02,  -2.51715280e-02],
       [ -8.90712640e-03,   2.67108185e-02,  -5.53581746e-02,
          9.58792399e-02,  -4.27077240e-06,   2.65867612e-02,
         -2.47768043e-02,   4.29146034e-02,  -3.93274698e-06,
         -1.80298846e-03,   1.30242999e-06,  -2.94563240e-06,
         -2.48483656e-03,  -4.30448502e-03,  -2.51736351e-02,
         -2.77975000e-02,   8.11171331e-02,   7.07028056e-02,
         -2.51696708e-02,  -2.77994277e-02],
       [ -3.04723204e-02,   5.42729466e-02,  -5.97347894e-02,
         -1.03460414e-01,  -3.19284730e-07,   5.48093365e-02,
         -2.67343716e-02,  -4.63076057e-02,  -1.91391713e-06,
         -3.68865032e-03,  -8.04375006e-07,   1.48547189e-06,
         -2.68051762e-03,   4.64360572e-03,  -1.71850899e-02,
         -2.51677856e-02,  -1.71772191e-02,  -2.51696708e-02,
          9.75171545e-02,   8.11197801e-02],
       [ -8.90781417e-03,   2.67126911e-02,  -5.53529259e-02,
         -9.58807651e-02,  -2.84200898e-08,   2.65855487e-02,
         -2.47732068e-02,  -4.29151388e-02,  -1.49643838e-06,
         -1.80233467e-03,  -1.03574609e-06,   1.51913193e-06,
         -2.48383408e-03,   4.30321079e-03,  -2.51751976e-02,
         -2.77917819e-02,  -2.51715280e-02,  -2.77994277e-02,
          8.11197801e-02,   7.07027133e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha', 'ref_result_exp_beta', 'ref_result_dm_beta']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_lda.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]