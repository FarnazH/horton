# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_hf_dft_uks_methyl_hybgga():
    ref_result_dm_alpha = array([[  1.03161203e+00,  -4.82056328e-02,  -5.12878064e-07,
         -3.35408351e-06,  -2.11139832e-06,  -1.05604275e-01,
          4.90880190e-07,  -1.82003070e-06,  -1.26306115e-06,
          1.77807272e-03,  -2.19573807e-07,   5.00656371e-07,
         -6.02787496e-08,   3.27030732e-07,  -2.90660167e-02,
         -4.66328106e-03,  -2.90640345e-02,  -4.66472885e-03,
         -2.90691220e-02,  -4.65809553e-03],
       [ -4.82056328e-02,   1.63502976e-01,   1.30295647e-06,
          6.31863457e-06,   3.14541392e-06,   1.67158061e-01,
         -9.25851810e-07,   3.01767017e-06,   1.54621203e-06,
         -2.93757493e-03,   3.41567307e-07,  -1.05461975e-06,
          7.78331507e-08,  -8.25329031e-07,   5.55356350e-02,
          1.81791141e-02,   5.55308375e-02,   1.81816215e-02,
          5.55423406e-02,   1.81688136e-02],
       [ -5.12878064e-07,   1.30295647e-06,   2.00954818e-01,
         -5.19162408e-06,  -4.89201554e-06,  -9.42207214e-07,
          9.13874264e-02,  -8.87752718e-06,  -3.57635820e-06,
         -1.98506834e-06,   2.47607221e-07,   5.03444077e-07,
          1.05478897e-02,  -2.85527771e-06,   1.23426693e-01,
          1.03303440e-01,  -6.17129196e-02,  -5.16483378e-02,
         -6.17229437e-02,  -5.16476652e-02],
       [ -3.35408351e-06,   6.31863457e-06,  -5.19162408e-06,
          2.00959590e-01,  -2.45633607e-06,   1.11945729e-05,
          2.61095338e-06,   9.13878287e-02,  -8.61568395e-07,
          1.93622701e-06,   5.58470987e-08,  -2.49001233e-06,
          3.71588942e-06,  -1.05501810e-02,  -7.92878432e-06,
         -6.01313386e-06,   1.06881336e-01,   8.94688344e-02,
         -1.06905948e-01,  -8.94546004e-02],
       [ -2.11139832e-06,   3.14541392e-06,  -4.89201554e-06,
         -2.45633607e-06,   3.65770644e-01,   1.50472908e-05,
         -2.14024154e-06,   7.44359550e-07,   3.16398511e-01,
          2.81591335e-07,  -2.50674175e-06,   3.16118467e-06,
          6.12249297e-07,   6.19870122e-08,  -5.20053347e-07,
         -4.99374179e-06,  -9.17676456e-06,  -3.66300104e-06,
         -9.57923664e-06,  -2.81737488e-06],
       [ -1.05604275e-01,   1.67158061e-01,  -9.42207214e-07,
          1.11945729e-05,   1.50472908e-05,   1.74012663e-01,
         -1.99600538e-06,   5.25235848e-06,   1.18033094e-05,
         -3.05372948e-03,   3.55701190e-07,  -1.08865991e-06,
         -3.79890321e-08,  -1.09261189e-06,   5.74783496e-02,
          1.85457774e-02,   5.74779892e-02,   1.85522103e-02,
          5.74848943e-02,   1.85348159e-02],
       [  4.90880190e-07,  -9.25851810e-07,   9.13874264e-02,
          2.61095338e-06,  -2.14024154e-06,  -1.99600538e-06,
          4.15598980e-02,  -1.77617874e-06,  -1.55328638e-06,
         -8.75162853e-07,   1.12600953e-07,   2.28898240e-07,
          4.79682210e-03,  -1.55950008e-06,   5.61297491e-02,
          4.69787277e-02,  -2.80628149e-02,  -2.34858651e-02,
         -2.80726630e-02,  -2.34899859e-02],
       [ -1.82003070e-06,   3.01767017e-06,  -8.87752718e-06,
          9.13878287e-02,   7.44359550e-07,   5.25235848e-06,
         -1.77617874e-06,   4.15592770e-02,   1.21831600e-06,
          8.77761276e-07,   2.53764182e-08,  -1.13235235e-06,
          1.34778321e-06,  -4.79777107e-03,  -7.55601977e-06,
         -6.06860571e-06,   4.86071147e-02,   4.06882908e-02,
         -4.86141999e-02,  -4.06784365e-02],
       [ -1.26306115e-06,   1.54621203e-06,  -3.57635820e-06,
         -8.61568395e-07,   3.16398511e-01,   1.18033094e-05,
         -1.55328638e-06,   1.21831600e-06,   2.73690684e-01,
          2.64886839e-07,  -2.16838025e-06,   2.73447801e-06,
          5.64029594e-07,  -1.27039309e-08,  -4.49075971e-07,
         -4.11327528e-06,  -7.86912495e-06,  -2.90506206e-06,
         -9.56129529e-06,  -3.29823237e-06],
       [  1.77807272e-03,  -2.93757493e-03,  -1.98506834e-06,
          1.93622701e-06,   2.81591335e-07,  -3.05372948e-03,
         -8.75162853e-07,   8.77761276e-07,   2.64886839e-07,
          5.35954526e-05,  -6.24749088e-09,   1.90904865e-08,
         -1.04349520e-07,  -9.27463078e-08,  -1.01036276e-03,
         -3.26998999e-04,  -1.00737801e-03,  -3.24619022e-04,
         -1.00976806e-03,  -3.26212488e-04],
       [ -2.19573807e-07,   3.41567307e-07,   2.47607221e-07,
          5.58470987e-08,  -2.50674175e-06,   3.55701190e-07,
          1.12600953e-07,   2.53764182e-08,  -2.16838025e-06,
         -6.24749088e-09,   1.82275349e-11,  -2.39614962e-11,
          1.29917968e-08,  -2.93634412e-09,   2.69567043e-07,
          1.65198249e-07,   7.12199924e-08,  -8.48457646e-10,
          1.18480221e-08,  -5.05825183e-08],
       [  5.00656371e-07,  -1.05461975e-06,   5.03444077e-07,
         -2.49001233e-06,   3.16118467e-06,  -1.08865991e-06,
          2.28898240e-07,  -1.13235235e-06,   2.73447801e-06,
          1.90904865e-08,  -2.39614962e-11,   6.62712609e-11,
          2.63832335e-08,   1.30717970e-07,  -5.12626902e-08,
          1.41703390e-07,  -1.83950017e-06,  -1.35510003e-06,
          8.09271959e-07,   8.61895967e-07],
       [ -6.02787496e-08,   7.78331507e-08,   1.05478897e-02,
          3.71588942e-06,   6.12249297e-07,  -3.79890321e-08,
          4.79682210e-03,   1.34778321e-06,   5.64029594e-07,
         -1.04349520e-07,   1.29917968e-08,   2.63832335e-08,
          5.53646806e-04,  -3.59257119e-07,   6.47853012e-03,
          5.42228096e-03,  -3.23711618e-03,  -2.70918583e-03,
         -3.24188532e-03,  -2.71270158e-03],
       [  3.27030732e-07,  -8.25329031e-07,  -2.85527771e-06,
         -1.05501810e-02,   6.19870122e-08,  -1.09261189e-06,
         -1.55950008e-06,  -4.79777107e-03,  -1.27039309e-08,
         -9.27463078e-08,  -2.93634412e-09,   1.30717970e-07,
         -3.59257119e-07,   5.53874179e-04,  -1.67258302e-06,
         -1.34709289e-06,  -5.61037227e-03,  -4.69627687e-03,
          5.61325016e-03,   4.69702766e-03],
       [ -2.90660167e-02,   5.55356350e-02,   1.23426693e-01,
         -7.92878432e-06,  -5.20053347e-07,   5.74783496e-02,
          5.61297491e-02,  -7.55601977e-06,  -4.49075971e-07,
         -1.01036276e-03,   2.69567043e-07,  -5.12626902e-08,
          6.47853012e-03,  -1.67258302e-06,   9.48299289e-02,
          6.96148346e-02,  -1.88879464e-02,  -2.55586073e-02,
         -1.88828294e-02,  -2.55564324e-02],
       [ -4.66328106e-03,   1.81791141e-02,   1.03303440e-01,
         -6.01313386e-06,  -4.99374179e-06,   1.85457774e-02,
          4.69787277e-02,  -6.06860571e-06,  -4.11327528e-06,
         -3.26998999e-04,   1.65198249e-07,   1.41703390e-07,
          5.42228096e-03,  -1.34709289e-06,   6.96148346e-02,
          5.51260554e-02,  -2.55611454e-02,  -2.45303350e-02,
         -2.55607166e-02,  -2.45278092e-02],
       [ -2.90640345e-02,   5.55308375e-02,  -6.17129196e-02,
          1.06881336e-01,  -9.17676456e-06,   5.74779892e-02,
         -2.80628149e-02,   4.86071147e-02,  -7.86912495e-06,
         -1.00737801e-03,   7.12199924e-08,  -1.83950017e-06,
         -3.23711618e-03,  -5.61037227e-03,  -1.88879464e-02,
         -2.55611454e-02,   9.48119538e-02,   6.96093441e-02,
         -1.88808489e-02,  -2.55532009e-02],
       [ -4.66472885e-03,   1.81816215e-02,  -5.16483378e-02,
          8.94688344e-02,  -3.66300104e-06,   1.85522103e-02,
         -2.34858651e-02,   4.06882908e-02,  -2.90506206e-06,
         -3.24619022e-04,  -8.48457646e-10,  -1.35510003e-06,
         -2.70918583e-03,  -4.69627687e-03,  -2.55586073e-02,
         -2.45303350e-02,   6.96093441e-02,   5.51271732e-02,
         -2.55644633e-02,  -2.45307689e-02],
       [ -2.90691220e-02,   5.55423406e-02,  -6.17229437e-02,
         -1.06905948e-01,  -9.57923664e-06,   5.74848943e-02,
         -2.80726630e-02,  -4.86141999e-02,  -9.56129529e-06,
         -1.00976806e-03,   1.18480221e-08,   8.09271959e-07,
         -3.24188532e-03,   5.61325016e-03,  -1.88828294e-02,
         -2.55607166e-02,  -1.88808489e-02,  -2.55644633e-02,
          9.48601491e-02,   6.96175032e-02],
       [ -4.65809553e-03,   1.81688136e-02,  -5.16476652e-02,
         -8.94546004e-02,  -2.81737488e-06,   1.85348159e-02,
         -2.34899859e-02,  -4.06784365e-02,  -3.29823237e-06,
         -3.26212488e-04,  -5.05825183e-08,   8.61895967e-07,
         -2.71270158e-03,   4.69702766e-03,  -2.55564324e-02,
         -2.45278092e-02,  -2.55532009e-02,  -2.45307689e-02,
          6.96175032e-02,   5.51149358e-02]])
    ref_result_energy = -39.829367436865937
    ref_result_exp_alpha = array([[  9.95043872e-01,   2.03714813e-01,  -8.93579434e-06,
          8.38686045e-06,   3.47867912e-06,  -1.52589105e-01,
         -1.24487060e-05,   1.64168781e-05,  -1.30527838e-06,
         -3.33113799e-06,   9.36196909e-07,  -4.93198834e-02,
         -2.28084311e-06,   3.57116489e-06,   3.63180795e-02,
         -5.10485746e-07,   1.02159442e-06,  -4.10972649e-02,
          1.40132497e-05,  -1.92946548e-05],
       [  3.40437300e-02,  -4.02919350e-01,   1.66916511e-05,
         -1.49185999e-05,  -5.07837375e-06,   2.38995944e-01,
          2.85257824e-05,  -2.63847288e-05,  -1.40973764e-05,
         -5.73788155e-05,   2.45815591e-05,  -6.72442253e-01,
          7.41871363e-04,  -5.15340622e-04,  -1.94673108e+00,
         -9.21088843e-06,  -1.65269116e-05,  -2.69476221e-01,
          5.50874490e-05,  -7.19980471e-05],
       [  4.56460961e-08,  -1.11880301e-06,   3.26013553e-01,
          3.07684895e-01,   1.04839414e-05,   3.06730278e-05,
          2.21500705e-01,   3.62909771e-01,  -2.08751308e-05,
         -4.24585176e-01,  -7.01045158e-01,   2.82068832e-05,
         -2.23997527e-01,  -7.44372638e-01,   1.11014152e-04,
         -1.00482495e-05,   5.69023802e-06,  -2.07161035e-05,
         -5.10318293e-02,  -3.15670127e-02],
       [  2.65603681e-07,   9.15689077e-06,   3.07680115e-01,
         -3.26025360e-01,  -5.87610352e-06,   6.61551064e-05,
         -3.62923809e-01,   2.21485693e-01,   4.01483691e-05,
         -7.00996703e-01,   4.24584658e-01,   1.70780464e-04,
          7.44396703e-01,  -2.24044484e-01,   3.17602305e-04,
          6.05189588e-06,   8.83040191e-06,  -1.26679074e-05,
          3.15189008e-02,  -5.10919925e-02],
       [  2.93406241e-08,  -1.88120814e-07,  -6.85292530e-06,
          1.19650665e-05,  -6.04789763e-01,  -7.79095921e-06,
          2.76866294e-06,  -8.23512309e-06,  -1.05587716e+00,
         -3.82554886e-05,   6.50721703e-05,   1.34369063e-05,
         -1.37097160e-05,  -1.54820924e-05,   3.89252010e-06,
          7.97273947e-06,  -4.17274501e-06,  -1.63447425e-06,
         -4.11778718e-07,   4.45382000e-07],
       [ -2.08343096e-02,  -4.16627678e-01,   2.07291865e-05,
         -2.64898800e-05,  -2.47778515e-05,   1.88772982e+00,
          1.62446540e-04,  -2.46220496e-04,   2.55821979e-05,
          8.86351060e-05,  -3.87224704e-05,   1.04444580e+00,
         -1.36286617e-03,   9.52796743e-04,   3.57257436e+00,
          1.52194791e-05,   2.64085392e-05,   7.86157257e-01,
         -1.87748563e-04,   2.58055877e-04],
       [ -2.07978823e-08,   3.26345634e-06,   1.48267555e-01,
          1.39916618e-01,   4.62845991e-06,   7.02747524e-05,
          6.83674549e-01,   1.12012537e+00,   2.80775530e-05,
          8.71007292e-01,   1.43821377e+00,  -9.17771321e-05,
          3.25451950e-01,   1.08157843e+00,  -1.37114456e-04,
         -1.18666090e-05,  -2.09725796e-05,  -6.14105634e-06,
         -4.49948432e-01,  -2.77840202e-01],
       [ -9.85367329e-08,   3.78695443e-06,   1.39909192e-01,
         -1.48272370e-01,  -5.75093021e-06,   1.68613880e-04,
         -1.12010170e+00,   6.83704832e-01,  -1.04384264e-04,
          1.43808622e+00,  -8.71046041e-01,  -3.70814369e-04,
         -1.08168627e+00,   3.25617102e-01,  -4.38300182e-04,
         -3.06061072e-05,  -5.76644018e-06,   2.57634419e-04,
          2.77865505e-01,  -4.49898926e-01],
       [ -5.39971060e-09,   2.75424518e-06,  -2.93029845e-06,
          9.30512647e-06,  -5.23154539e-01,  -8.33457906e-06,
         -6.17810444e-07,   1.58355206e-05,   1.09861575e+00,
          4.00021112e-05,  -6.44258427e-05,  -2.74740567e-05,
          1.30331355e-05,   5.93992037e-06,   1.37813066e-06,
         -6.23471320e-07,   3.69767759e-06,  -5.14678454e-07,
         -4.20501777e-07,  -1.26352790e-06],
       [  2.89298000e-04,   7.31517163e-03,  -3.41102268e-07,
         -6.05400807e-06,  -4.72553455e-07,   1.48247942e-02,
          4.52644878e-06,  -9.09665793e-06,   4.01454326e-06,
          2.28614325e-06,   6.37926148e-06,   1.83881789e-01,
         -7.30361807e-05,   3.87106625e-05,  -3.07204201e-02,
          4.42491105e-06,  -1.87907608e-05,  -1.05118279e+00,
          2.68205712e-04,  -3.76954812e-04],
       [ -4.63299501e-08,  -8.51223422e-07,   4.89606101e-07,
          2.90670555e-07,   4.15901321e-06,  -4.62815999e-06,
          1.91385295e-06,   3.39818766e-06,   5.09490567e-06,
         -4.80975155e-07,  -2.21793583e-06,  -1.82784965e-05,
          8.83570031e-07,  -9.56032607e-06,   8.46590204e-06,
          5.54842365e-01,  -8.31955497e-01,   1.37034208e-05,
          1.86187063e-05,  -2.14022516e-05],
       [ -3.21537588e-08,   2.61419743e-06,  -2.99333738e-06,
          4.80805841e-06,  -5.22853584e-06,  -6.35581079e-07,
         -4.25678314e-06,   1.57507800e-06,  -1.09565690e-06,
          9.08792032e-06,  -1.07137014e-05,   6.53980715e-06,
          3.17600853e-05,  -9.08446658e-07,   4.75227308e-06,
         -8.31955495e-01,  -5.54842364e-01,   7.41184391e-06,
          1.51331087e-05,   5.62995548e-05],
       [ -2.58331883e-08,  -8.35307739e-08,   1.71181779e-02,
          1.61435527e-02,  -8.86923734e-07,  -2.69693386e-06,
         -9.05058129e-03,  -1.48483436e-02,  -6.59969818e-06,
         -5.96664262e-02,  -9.84686762e-02,  -1.38692210e-05,
          5.64172563e-02,   1.87659967e-01,  -2.38817781e-05,
         -3.28897761e-05,  -2.97950044e-05,  -3.06693808e-05,
         -9.23229650e-01,  -5.70132104e-01],
       [ -1.11370339e-07,   7.36122409e-07,  -1.61579837e-02,
          1.71112298e-02,   4.19075724e-07,  -5.48216483e-06,
         -1.48433507e-02,   9.07965822e-03,  -8.28943502e-06,
          9.85116523e-02,  -5.96330592e-02,  -1.92595490e-05,
          1.87657320e-01,  -5.65554785e-02,   1.06784310e-04,
          5.89286649e-05,   3.73483364e-06,  -4.98601283e-04,
         -5.70153005e-01,   9.23206030e-01],
       [ -9.75471213e-04,  -1.37914245e-01,   2.00232312e-01,
          1.88985808e-01,   2.37569254e-06,  -1.00038158e-01,
         -5.58466938e-02,  -9.15347650e-02,  -3.60567476e-05,
         -2.26262075e-01,  -3.73449567e-01,  -6.36400090e-01,
          2.51776454e-01,   8.36558254e-01,   2.91823665e-01,
          2.40487086e-05,   2.27143885e-05,  -3.76317990e-01,
          5.79053776e-01,   3.57455682e-01],
       [  4.47314899e-03,  -4.47394663e-02,   1.67586876e-01,
          1.58174058e-01,   9.50944664e-06,  -9.72111481e-01,
         -8.67611066e-01,  -1.42115944e+00,   2.21406848e-05,
         -2.31315039e-01,  -3.82094310e-01,   2.08991169e-01,
         -4.41969303e-01,  -1.46999225e+00,  -1.08220036e+00,
         -9.65564247e-06,  -7.64465390e-06,  -6.35745436e-02,
          9.49316116e-03,   5.76933217e-03],
       [ -9.75595046e-04,  -1.37891099e-01,   6.35266289e-02,
         -2.67883219e-01,   9.20040390e-06,  -1.00055987e-01,
          1.07219560e-01,  -2.64152658e-03,   3.14599665e-05,
         -2.10425705e-01,   3.82674990e-01,  -6.36506528e-01,
         -8.50354373e-01,  -2.00269114e-01,   2.91724296e-01,
         -2.18282038e-05,  -2.41307140e-05,  -3.76576367e-01,
         -5.98970310e-01,   3.22490954e-01],
       [  4.47323512e-03,  -4.47362282e-02,   5.31936662e-02,
         -2.24223675e-01,   1.04491838e-06,  -9.72162593e-01,
          1.66451618e+00,  -4.04872924e-02,   1.45122089e-05,
         -2.15081853e-01,   3.91410979e-01,   2.09182579e-01,
          1.49437685e+00,   3.51522054e-01,  -1.08198362e+00,
          2.93546372e-05,   8.26753781e-06,  -6.36144944e-02,
         -9.82582412e-03,   5.23439860e-03],
       [ -9.75325368e-04,  -1.37946027e-01,  -2.63818619e-01,
          7.89292696e-02,   2.04358401e-05,  -9.99890226e-02,
         -5.13321625e-02,   9.41192746e-02,  -3.07600654e-05,
          4.36511612e-01,  -9.16003081e-03,  -6.36262231e-01,
          5.98509617e-01,  -6.36185229e-01,   2.92289946e-01,
         -3.27369687e-05,   1.54373594e-05,  -3.76153056e-01,
          2.02812188e-02,  -6.80430920e-01],
       [  4.47301427e-03,  -4.47265597e-02,  -2.20754280e-01,
          6.60454247e-02,   8.49038681e-06,  -9.71788711e-01,
         -7.97203914e-01,   1.46208062e+00,  -2.97292397e-05,
          4.46446715e-01,  -9.32833890e-03,   2.08567349e-01,
         -1.05137418e+00,   1.11770033e+00,  -1.08300075e+00,
         -1.35215441e-05,  -3.00870136e-05,  -6.34997194e-02,
          3.27146087e-04,  -1.10104818e-02]])
    ref_result_exp_beta = array([[  9.95305033e-01,  -1.94680158e-01,   9.62349900e-06,
          9.50691414e-06,   3.10495099e-06,  -1.60146942e-01,
          2.45327237e-05,   7.97348188e-06,  -4.39602023e-06,
         -1.22126639e-06,  -1.88337246e-06,  -5.98222984e-02,
         -6.15423559e-06,  -6.06901452e-08,   3.89526619e-02,
          2.00816419e-05,   7.49857698e-06,   3.25633291e-02,
         -3.18159304e-05,  -3.74705382e-05],
       [  3.22942602e-02,   3.80285917e-01,  -1.70908657e-05,
         -1.19954365e-05,   4.21501355e-07,   2.37237350e-01,
         -4.00915111e-05,  -2.41060526e-05,  -5.26741716e-05,
         -1.30146399e-05,  -6.20707865e-06,  -5.89153426e-01,
         -5.92084445e-04,  -4.17568390e-04,  -1.97134921e+00,
          4.39709767e-05,   1.12410011e-05,   3.16099207e-01,
         -2.79761849e-04,  -3.22475696e-04],
       [  2.51751435e-07,   6.08759101e-06,  -3.11500141e-01,
          2.93702118e-01,  -1.16632990e-05,   4.25911575e-05,
          2.97253186e-01,  -3.03384678e-01,  -4.07388369e-01,
          6.94080512e-01,   1.26825424e-04,   2.82091284e-05,
          1.81120858e-01,  -7.83295210e-01,   1.16148773e-04,
          1.72244261e-05,   7.77576571e-06,   1.80035728e-05,
          4.81305583e-02,  -3.52600229e-02],
       [  7.54906142e-08,  -2.22239901e-05,  -2.93712884e-01,
         -3.11494344e-01,  -5.47664941e-05,   7.75373175e-05,
          3.03382765e-01,   2.97264042e-01,  -6.94039484e-01,
         -4.07370858e-01,   4.54721781e-04,   2.48015517e-04,
         -7.83331559e-01,  -1.81128255e-01,   2.26840647e-04,
         -1.64738748e-05,  -2.11609832e-05,  -4.03490447e-05,
         -3.52214494e-02,  -4.81931283e-02],
       [  1.01697860e-08,  -6.87457871e-06,  -6.73551829e-05,
         -2.57746902e-05,  -5.04120283e-01,  -5.42350629e-06,
          7.64470960e-06,   1.07686533e-05,  -7.10585251e-04,
         -1.95776862e-04,  -1.10747885e+00,   4.69670700e-05,
          1.48087627e-04,   7.51002009e-05,  -1.03455508e-05,
          6.90917662e-06,   1.01293730e-05,   1.45459106e-05,
          1.43524768e-05,   3.57808664e-06],
       [ -1.96609289e-02,   3.57256740e-01,  -1.48521455e-05,
         -2.24307067e-05,  -1.49517549e-05,   1.95047502e+00,
         -3.48054205e-04,  -9.42433966e-05,   6.55895513e-05,
         -5.10456851e-06,  -7.01065447e-06,   9.80977553e-01,
          1.09096059e-03,   7.74853518e-04,   3.55919236e+00,
         -2.24963654e-04,  -7.11614605e-05,  -8.04484447e-01,
          7.18820138e-04,   8.39792073e-04],
       [ -1.40716403e-07,  -3.94779889e-06,  -1.32811254e-01,
          1.25208144e-01,  -2.05898513e-05,   9.42198612e-05,
          9.35389715e-01,  -9.54744162e-01,   8.35992357e-01,
         -1.42434512e+00,  -2.27088657e-04,  -8.95591336e-05,
         -2.58686786e-01,   1.11884688e+00,  -1.42958964e-04,
          3.10420757e-05,   3.68627093e-05,   5.47199058e-05,
          4.27030053e-01,  -3.12415528e-01],
       [ -6.62029728e-08,  -7.05907595e-06,  -1.25204300e-01,
         -1.32809063e-01,  -2.83354272e-05,   2.18447083e-04,
          9.54738687e-01,   9.35387850e-01,   1.42424673e+00,
          8.35977616e-01,  -8.60606033e-04,  -4.98964107e-04,
          1.11897727e+00,   2.58795787e-01,  -2.97167285e-04,
          1.47515850e-05,   6.41061559e-05,  -7.60652153e-04,
         -3.12434684e-01,  -4.26980529e-01],
       [ -1.10403317e-08,  -5.11783947e-06,  -1.95745189e-05,
          3.50445013e-07,  -6.22918642e-01,   3.97268624e-06,
         -1.08131845e-04,  -4.76601381e-05,   7.06482342e-04,
          1.92223940e-04,   1.04528419e+00,  -5.53973041e-05,
         -1.14013800e-04,  -5.98685472e-05,   1.16304690e-05,
         -4.63177436e-06,  -9.63386218e-06,  -6.37824427e-06,
         -6.61683130e-06,  -3.31920311e-06],
       [ -6.49003839e-04,  -3.11870177e-02,   2.74132738e-06,
         -1.38994266e-06,   5.82763380e-06,  -1.24330324e-02,
         -5.91447654e-06,  -1.96932423e-06,   8.36851219e-06,
          3.87489408e-06,   1.80843358e-05,   1.56872292e-01,
          8.55805359e-05,   3.68716959e-05,   3.24141083e-03,
          4.24604399e-04,   1.38988410e-04,   1.05558785e+00,
         -9.50508542e-04,  -1.11218412e-03],
       [  2.02456490e-07,   9.48236791e-06,   3.75352872e-06,
         -1.09560646e-06,   1.32385175e-06,   6.30321152e-06,
         -2.05092942e-06,   7.39989401e-07,   4.90115916e-06,
          9.66885985e-07,  -2.06435343e-06,  -3.90144101e-06,
         -1.27080676e-06,   4.34157454e-06,  -1.72344510e-05,
          7.44907108e-01,  -6.67168159e-01,  -2.10869911e-04,
         -3.35247916e-05,  -3.56837014e-05],
       [  1.01864368e-06,   1.12271360e-05,   1.01149867e-06,
          9.59338111e-07,   1.09273630e-06,   1.63643588e-05,
          4.51346499e-06,   9.20064238e-06,   3.38294784e-06,
          6.81776968e-06,   1.04656169e-05,   2.46359173e-05,
         -4.27587343e-05,   6.61254450e-06,  -4.33099177e-05,
          6.67168066e-01,   7.44907119e-01,  -3.69365768e-04,
         -4.51558864e-05,   1.14814078e-04],
       [ -3.40550380e-08,   1.33770733e-06,  -1.69143799e-02,
          1.59385961e-02,   6.61630298e-06,  -1.39757150e-06,
         -1.02728100e-02,   1.04685249e-02,  -5.93761180e-02,
          1.01125684e-01,   3.40168973e-05,  -1.50864964e-05,
         -4.27024506e-02,   1.84930821e-01,  -2.20494301e-05,
          7.75642145e-05,   7.77399421e-05,   1.13045258e-04,
          8.76459006e-01,  -6.41252264e-01],
       [  8.57982458e-08,   5.53146985e-06,   1.59543953e-02,
          1.69070673e-02,   1.44185343e-07,   9.45349559e-07,
          1.04939834e-02,   1.02626592e-02,   1.01167852e-01,
          5.93483963e-02,  -9.31350449e-05,  -1.25672663e-05,
         -1.84941151e-01,  -4.28388745e-02,   7.49507557e-05,
         -1.40591060e-05,  -9.43344910e-05,   1.51821838e-03,
          6.41268703e-01,   8.76433618e-01],
       [ -1.01970776e-03,   1.53355641e-01,  -2.10073994e-01,
          1.98088942e-01,   1.88192153e-05,  -8.15125180e-02,
         -6.58402703e-02,   6.71651521e-02,  -2.31016823e-01,
          3.93447637e-01,   7.74399118e-05,  -6.55590931e-01,
         -1.94773256e-01,   8.41932314e-01,   2.75938420e-01,
          9.94146773e-05,   7.09100485e-06,   3.53130264e-01,
         -5.45900109e-01,   3.98859426e-01],
       [  4.22094385e-03,   7.22977125e-02,  -1.86165579e-01,
          1.75548204e-01,   6.25564017e-05,  -9.91744951e-01,
         -1.17277987e+00,   1.19730593e+00,  -2.05521769e-01,
          3.50299587e-01,   2.20186677e-05,   2.26841247e-01,
          3.44494495e-01,  -1.49098603e+00,  -1.05819729e+00,
          1.26908944e-05,  -2.06762520e-07,   7.72456318e-02,
         -1.10640784e-02,   7.89990275e-03],
       [ -1.01969010e-03,   1.53329248e-01,  -6.64959948e-02,
         -2.80971399e-01,   3.52114133e-05,  -8.15259026e-02,
         -2.53032574e-02,  -9.06079980e-02,  -2.25396388e-01,
         -3.96825603e-01,   2.84262563e-04,  -6.55699854e-01,
          8.26411907e-01,  -2.52412310e-01,   2.75895097e-01,
          2.13236446e-04,   7.32838333e-05,   3.54018045e-01,
          6.18133341e-01,   2.72543368e-01],
       [  4.22087564e-03,   7.22906626e-02,  -5.89559573e-02,
         -2.49020227e-01,   6.43570555e-05,  -9.91779226e-01,
         -4.50132987e-01,  -1.61437654e+00,  -2.00422266e-01,
         -3.53095630e-01,   1.19800033e-05,   2.27100182e-01,
         -1.46370321e+00,   4.46639097e-01,  -1.05811589e+00,
         -3.30776623e-05,  -4.12317201e-05,   7.73043012e-02,
          1.24154744e-02,   5.37961644e-03],
       [ -1.01959167e-03,   1.53389359e-01,   2.76616382e-01,
          8.28942361e-02,  -3.03426111e-05,  -8.14585471e-02,
          9.10734227e-02,   2.34147020e-02,   4.56178526e-01,
          3.25844154e-03,  -4.51231814e-04,  -6.55409980e-01,
         -6.31786390e-01,  -5.89511369e-01,   2.76314074e-01,
          1.73213119e-04,   1.21638519e-04,   3.52481480e-01,
         -7.32594848e-02,  -6.72584582e-01],
       [  4.22072982e-03,   7.22849998e-02,   2.45079924e-01,
          7.34438877e-02,  -1.36871541e-04,  -9.91334914e-01,
          1.62351513e+00,   4.17257540e-01,   4.06059939e-01,
          2.88984185e-03,   4.50942827e-05,   2.26310482e-01,
          1.11852409e+00,   1.04377237e+00,  -1.05883536e+00,
          1.54387726e-05,   1.57124186e-05,   7.71752158e-02,
         -1.51204114e-03,  -1.34806406e-02]])
    ref_result_dm_beta = array([[  1.02853247e+00,  -4.18914776e-02,  -1.13825791e-06,
         -1.38650654e-06,   1.34801982e-06,  -8.91194252e-02,
          5.38509224e-07,  -1.15890722e-06,   9.86101565e-07,
          5.42553674e-03,  -1.64443279e-06,  -1.17186535e-06,
         -3.05580982e-07,  -6.77186225e-07,  -3.08703585e-02,
         -9.87392085e-03,  -3.08683748e-02,  -9.87543711e-03,
         -3.08732182e-02,  -9.86848722e-03],
       [ -4.18914776e-02,   1.45660278e-01,   4.12421546e-06,
          3.07497542e-07,  -2.61419012e-06,   1.35224773e-01,
         -7.34831623e-07,   1.04609506e-06,  -1.94773083e-06,
         -1.18809418e-02,   3.61233998e-06,   4.30249750e-06,
          6.05740645e-07,   1.63081313e-06,   5.82872696e-02,
          2.76311799e-02,   5.82805241e-02,   2.76314297e-02,
          5.82931581e-02,   2.76202054e-02],
       [ -1.13825791e-06,   4.12421546e-06,   1.83293249e-01,
          5.05508510e-06,   1.34097863e-05,   1.97373612e-07,
          7.81446195e-02,  -5.14788852e-06,   6.19962448e-06,
         -1.45422142e-06,  -1.49191445e-06,  -3.32627696e-08,
          9.95003342e-03,  -4.15530258e-06,   1.23618156e-01,
          1.09549924e-01,  -6.18074413e-02,  -5.47725322e-02,
         -6.18188877e-02,  -5.47713602e-02],
       [ -1.38650654e-06,   3.07497542e-07,   5.05508510e-06,
          1.83295977e-01,   2.78127250e-05,   3.40979408e-06,
          6.74587775e-06,   7.81434197e-02,   5.64073501e-06,
          3.21064304e-07,  -7.61403699e-07,  -5.97094360e-07,
          3.18920138e-06,  -9.95246143e-03,  -5.55473666e-06,
         -4.64954856e-06,   1.07048312e-01,   9.48828929e-02,
         -1.07070279e-01,  -9.48620777e-02],
       [  1.34801982e-06,  -2.61419012e-06,   1.34097863e-05,
          2.78127250e-05,   5.24844213e-09,  -2.45616376e-06,
          5.71782409e-06,   1.18566731e-05,   1.34464895e-09,
          2.14378526e-07,  -2.89869812e-10,  -1.70222839e-10,
          7.28382616e-07,  -1.51046721e-06,   7.98812138e-06,
          7.51648550e-06,   1.06669412e-05,   9.89295737e-06,
         -2.18233454e-05,  -1.88976509e-05],
       [ -8.91194252e-02,   1.35224773e-01,   1.97373612e-07,
          3.40979408e-06,  -2.45616376e-06,   1.28018950e-01,
         -2.24545522e-06,   2.31832335e-06,  -1.82926622e-06,
         -1.11290130e-02,   3.38348100e-06,   3.99100769e-06,
          3.71884217e-07,   1.35818118e-06,   5.48060576e-02,
          2.57446720e-02,   5.48052518e-02,   2.57498130e-02,
          5.48134658e-02,   2.57360410e-02],
       [  5.38509224e-07,  -7.34831623e-07,   7.81446195e-02,
          6.74587775e-06,   5.71782409e-06,  -2.24545522e-06,
          3.33159110e-02,  -2.37620519e-07,   2.64330152e-06,
         -4.16017518e-07,  -6.36138805e-07,  -1.42697127e-08,
          4.24206342e-03,  -2.02084860e-06,   5.27019415e-02,
          4.67046676e-02,  -2.63490947e-02,  -2.33496319e-02,
         -2.63593376e-02,  -2.33538843e-02],
       [ -1.15890722e-06,   1.04609506e-06,  -5.14788852e-06,
          7.81434197e-02,   1.18566731e-05,   2.31832335e-06,
         -2.37620519e-07,   3.33143924e-02,   2.40451967e-06,
          6.16867397e-08,  -3.24522126e-07,  -2.54527142e-07,
          9.63193332e-07,  -4.24297005e-03,  -6.92303739e-06,
         -6.17286770e-06,   4.56400658e-02,   4.04531829e-02,
         -4.56437645e-02,  -4.04395960e-02],
       [  9.86101565e-07,  -1.94773083e-06,   6.19962448e-06,
          5.64073501e-06,   1.34464895e-09,  -1.82926622e-06,
          2.64330152e-06,   2.40451967e-06,   4.09497200e-10,
          1.59683413e-07,  -1.22452389e-10,  -7.70082399e-11,
          3.36629775e-07,  -3.06429622e-07,   3.39559011e-06,
          3.33484912e-06,   4.18403479e-07,   6.96945069e-07,
         -6.17122638e-06,  -5.14188726e-06],
       [  5.42553674e-03,  -1.18809418e-02,  -1.45422142e-06,
          3.21064304e-07,   2.14378526e-07,  -1.11290130e-02,
         -4.16017518e-07,   6.16867397e-08,   1.59683413e-07,
          9.73051270e-04,  -2.95833416e-07,  -3.50809431e-07,
         -1.10347984e-07,  -1.52340779e-07,  -4.78289579e-03,
         -2.25824429e-03,  -4.78101089e-03,  -2.25708477e-03,
         -4.78245110e-03,  -2.25652291e-03],
       [ -1.64443279e-06,   3.61233998e-06,  -1.49191445e-06,
         -7.61403699e-07,  -2.89869812e-10,   3.38348100e-06,
         -6.36138805e-07,  -3.24522126e-07,  -1.22452389e-10,
         -2.95833416e-07,   1.05253552e-10,   1.09413859e-10,
         -8.09908028e-08,   4.14147158e-08,   4.47707060e-07,
         -2.05308927e-07,   1.51221455e-06,   7.38130884e-07,
          2.40202303e-06,   1.52599941e-06],
       [ -1.17186535e-06,   4.30249750e-06,  -3.32627696e-08,
         -5.97094360e-07,  -1.70222839e-10,   3.99100769e-06,
         -1.42697127e-08,  -2.54527142e-07,  -7.70082399e-11,
         -3.50809431e-07,   1.09413859e-10,   1.29042121e-10,
         -1.80388658e-09,   3.24699145e-08,   1.69828817e-06,
          7.96114732e-07,   1.38310805e-06,   5.16932208e-07,
          2.08099300e-06,   1.13471128e-06],
       [ -3.05580982e-07,   6.05740645e-07,   9.95003342e-03,
          3.18920138e-06,   7.28382616e-07,   3.71884217e-07,
          4.24206342e-03,   9.63193332e-07,   3.36629775e-07,
         -1.10347984e-07,  -8.09908028e-08,  -1.80388658e-09,
          5.40135406e-04,  -3.83830155e-07,   6.71073872e-03,
          5.94696590e-03,  -3.35334629e-03,  -2.97173322e-03,
         -3.35737255e-03,  -2.97468696e-03],
       [ -6.77186225e-07,   1.63081313e-06,  -4.15530258e-06,
         -9.95246143e-03,  -1.51046721e-06,   1.35818118e-06,
         -2.02084860e-06,  -4.24297005e-03,  -3.06429622e-07,
         -1.52340779e-07,   4.14147158e-08,   3.24699145e-08,
         -3.83830155e-07,   5.40391058e-04,  -1.65259548e-06,
         -1.75397458e-06,  -5.81045360e-03,  -5.15040419e-03,
          5.81559025e-03,   5.15221938e-03],
       [ -3.08703585e-02,   5.82872696e-02,   1.23618156e-01,
         -5.55473666e-06,   7.98812138e-06,   5.48060576e-02,
          5.27019415e-02,  -6.92303739e-06,   3.39559011e-06,
         -4.78289579e-03,   4.47707060e-07,   1.69828817e-06,
          6.71073872e-03,  -1.65259548e-06,   1.06889317e-01,
          8.49656690e-02,  -1.81733039e-02,  -2.58611618e-02,
         -1.81653152e-02,  -2.58554889e-02],
       [ -9.87392085e-03,   2.76311799e-02,   1.09549924e-01,
         -4.64954856e-06,   7.51648550e-06,   2.57446720e-02,
          4.67046676e-02,  -6.17286770e-06,   3.33484912e-06,
         -2.25824429e-03,  -2.05308927e-07,   7.96114732e-07,
          5.94696590e-03,  -1.75397458e-06,   8.49656690e-02,
          7.07195742e-02,  -2.58637116e-02,  -2.74952184e-02,
         -2.58591223e-02,  -2.74886503e-02],
       [ -3.08683748e-02,   5.82805241e-02,  -6.18074413e-02,
          1.07048312e-01,   1.06669412e-05,   5.48052518e-02,
         -2.63490947e-02,   4.56400658e-02,   4.18403479e-07,
         -4.78101089e-03,   1.51221455e-06,   1.38310805e-06,
         -3.35334629e-03,  -5.81045360e-03,  -1.81733039e-02,
         -2.58637116e-02,   1.06877525e-01,   8.49678506e-02,
         -1.81646701e-02,  -2.58533518e-02],
       [ -9.87543711e-03,   2.76314297e-02,  -5.47725322e-02,
          9.48828929e-02,   9.89295737e-06,   2.57498130e-02,
         -2.33496319e-02,   4.04531829e-02,   6.96945069e-07,
         -2.25708477e-03,   7.38130884e-07,   5.16932208e-07,
         -2.97173322e-03,  -5.15040419e-03,  -2.58611618e-02,
         -2.74952184e-02,   8.49678506e-02,   7.07306188e-02,
         -2.58661971e-02,  -2.74945737e-02],
       [ -3.08732182e-02,   5.82931581e-02,  -6.18188877e-02,
         -1.07070279e-01,  -2.18233454e-05,   5.48134658e-02,
         -2.63593376e-02,  -4.56437645e-02,  -6.17122638e-06,
         -4.78245110e-03,   2.40202303e-06,   2.08099300e-06,
         -3.35737255e-03,   5.81559025e-03,  -1.81653152e-02,
         -2.58591223e-02,  -1.81646701e-02,  -2.58661971e-02,
          1.06917398e-01,   8.49646313e-02],
       [ -9.86848722e-03,   2.76202054e-02,  -5.47713602e-02,
         -9.48620777e-02,  -1.88976509e-05,   2.57360410e-02,
         -2.33538843e-02,  -4.04395960e-02,  -5.14188726e-06,
         -2.25652291e-03,   1.52599941e-06,   1.13471128e-06,
         -2.97468696e-03,   5.15221938e-03,  -2.58554889e-02,
         -2.74886503e-02,  -2.58533518e-02,  -2.74945737e-02,
          8.49646313e-02,   7.07010973e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_hybgga.py")

    l = {}
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], l[k], v), l[k] - l[var_name]
