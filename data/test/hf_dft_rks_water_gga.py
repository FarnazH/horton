# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_dm_alpha = array([[  9.81962418e-02,   4.71993821e-02,  -1.83797914e-02,
          4.01845095e-02,   1.25605709e-01,  -9.51464579e-02,
          9.09841973e-07,   1.79607961e-02,   6.29202076e-02,
         -6.27828289e-02,   8.61634706e-07,  -4.91074817e-03,
          1.51553580e-07,  -2.26710138e-07,  -3.75893657e-03,
         -9.07125440e-03,  -2.01865263e-02,  -1.91016198e-02],
       [  4.71993821e-02,   2.87684043e-02,   1.13933143e-02,
         -1.80041532e-02,   7.03452327e-02,  -5.63420713e-02,
          2.00311598e-06,  -3.46773378e-02,   3.52382336e-02,
         -3.93918477e-02,   1.65710800e-06,  -1.57279197e-03,
          1.19614257e-07,  -1.80581971e-07,  -3.22473053e-03,
         -5.08033361e-03,  -1.91005407e-02,  -8.36326513e-03],
       [ -1.83797914e-02,   1.13933143e-02,   1.04147170e+00,
         -8.42676410e-02,   4.63957948e-07,  -2.01342172e-02,
          9.92106267e-08,  -1.41407616e-01,  -1.15434025e-07,
         -1.60754413e-02,   7.34144386e-09,   3.09321107e-03,
          9.56601677e-08,   5.86376057e-08,  -3.72950382e-03,
         -4.06089625e-09,  -1.83799724e-02,   1.13930092e-02],
       [  4.01845095e-02,  -1.80041532e-02,  -8.42676410e-02,
          2.48950674e-01,  -4.20494966e-06,   4.19834729e-02,
          1.30864221e-07,   2.78941714e-01,  -1.47235422e-06,
          4.19357915e-02,   2.36329327e-07,  -6.29308010e-03,
         -2.15676122e-07,  -1.77054284e-07,   7.99525815e-03,
          3.49985769e-07,   4.01878310e-02,  -1.80018641e-02],
       [  1.25605709e-01,   7.03452327e-02,   4.63957948e-07,
         -4.20494966e-06,   2.66543588e-01,   3.26442030e-06,
         -1.46509456e-06,   4.07665977e-06,   1.33520497e-01,
         -8.61206642e-07,  -5.23268145e-07,  -9.72852587e-08,
          3.65356251e-07,  -1.79375377e-07,  -6.04163209e-07,
         -1.92491395e-02,  -1.25609471e-01,  -7.03448381e-02],
       [ -9.51464579e-02,  -5.63420713e-02,  -2.01342172e-02,
          4.19834729e-02,   3.26442030e-06,   3.26978969e-01,
         -5.30016623e-07,   1.32936234e-01,   1.58100579e-06,
          2.25320633e-01,   1.88456944e-07,   1.11384219e-02,
         -8.13752786e-08,   8.38333061e-08,   1.72108852e-02,
          7.70189936e-07,  -9.51487091e-02,  -5.63363208e-02],
       [  9.09841973e-07,   2.00311598e-06,   9.92106267e-08,
          1.30864221e-07,  -1.46509456e-06,  -5.30016623e-07,
          4.10558916e-01,  -1.75720718e-06,  -1.34509342e-06,
          5.78562594e-07,   3.26904698e-01,  -7.33281848e-07,
          2.42668485e-07,  -2.26227951e-02,   2.03984650e-07,
          3.78680115e-07,  -1.46679843e-06,   8.15705752e-07],
       [  1.79607961e-02,  -3.46773378e-02,  -1.41407616e-01,
          2.78941714e-01,   4.07665977e-06,   1.32936234e-01,
         -1.75720718e-06,   3.37644012e-01,   2.71539190e-06,
          1.05492169e-01,  -1.09244463e-06,  -3.82879520e-03,
         -2.54710911e-07,  -7.14922315e-08,   1.32503456e-02,
          2.26394565e-08,   1.79564831e-02,  -3.46774126e-02],
       [  6.29202076e-02,   3.52382336e-02,  -1.15434025e-07,
         -1.47235422e-06,   1.33520497e-01,   1.58100579e-06,
         -1.34509342e-06,   2.71539190e-06,   6.68848322e-02,
         -4.34855458e-07,  -7.48769419e-07,  -7.10665263e-08,
          1.83018137e-07,  -5.61780773e-08,  -2.90176837e-07,
         -9.64253050e-03,  -6.29217832e-02,  -3.52380751e-02],
       [ -6.27828289e-02,  -3.93918477e-02,  -1.60754413e-02,
          4.19357915e-02,  -8.61206642e-07,   2.25320633e-01,
          5.78562594e-07,   1.05492169e-01,  -4.34855458e-07,
          1.55967075e-01,   8.84185128e-07,   7.26561596e-03,
         -6.69906539e-08,  -3.65931302e-09,   1.21673508e-02,
          7.51097433e-07,  -6.27814881e-02,  -3.93862904e-02],
       [  8.61634706e-07,   1.65710800e-06,   7.34144386e-09,
          2.36329327e-07,  -5.23268145e-07,   1.88456944e-07,
          3.26904698e-01,  -1.09244463e-06,  -7.48769419e-07,
          8.84185128e-07,   2.60295606e-01,  -5.64798783e-07,
          1.93223788e-07,  -1.80132442e-02,   1.95841161e-07,
          2.55065461e-07,  -1.63705555e-06,   3.72098919e-07],
       [ -4.91074817e-03,  -1.57279197e-03,   3.09321107e-03,
         -6.29308010e-03,  -9.72852587e-08,   1.11384219e-02,
         -7.33281848e-07,  -3.82879520e-03,  -7.10665263e-08,
          7.26561596e-03,  -5.64798783e-07,   6.25723897e-04,
          3.76041382e-09,   4.78845288e-08,   4.01972271e-04,
          4.39938705e-08,  -4.91060458e-03,  -1.57245769e-03],
       [  1.51553580e-07,   1.19614257e-07,   9.56601677e-08,
         -2.15676122e-07,   3.65356251e-07,  -8.13752786e-08,
          2.42668485e-07,  -2.54710911e-07,   1.83018137e-07,
         -6.69906539e-08,   1.93223788e-07,   3.76041382e-09,
          8.37878592e-13,  -1.33718448e-08,  -9.17465461e-09,
         -2.63851712e-08,  -1.92793532e-07,  -7.32345051e-08],
       [ -2.26710138e-07,  -1.80581971e-07,   5.86376057e-08,
         -1.77054284e-07,  -1.79375377e-07,   8.38333061e-08,
         -2.26227951e-02,  -7.14922315e-08,  -5.61780773e-08,
         -3.65931302e-09,  -1.80132442e-02,   4.78845288e-08,
         -1.33718448e-08,   1.24657104e-03,  -1.25708567e-08,
         -2.08175972e-09,   1.49396688e-07,   2.21410427e-08],
       [ -3.75893657e-03,  -3.22473053e-03,  -3.72950382e-03,
          7.99525815e-03,  -6.04163209e-07,   1.72108852e-02,
          2.03984650e-07,   1.32503456e-02,  -2.90176837e-07,
          1.21673508e-02,   1.95841161e-07,   4.01972271e-04,
         -9.17465461e-09,  -1.25708567e-08,   1.04386264e-03,
          9.45663155e-08,  -3.75834150e-03,  -3.22403947e-03],
       [ -9.07125440e-03,  -5.08033361e-03,  -4.06089625e-09,
          3.49985769e-07,  -1.92491395e-02,   7.70189936e-07,
          3.78680115e-07,   2.26394565e-08,  -9.64253050e-03,
          7.51097433e-07,   2.55065461e-07,   4.39938705e-08,
         -2.63851712e-08,  -2.08175972e-09,   9.45663155e-08,
          1.39012675e-03,   9.07090420e-03,   5.07996634e-03],
       [ -2.01865263e-02,  -1.91005407e-02,  -1.83799724e-02,
          4.01878310e-02,  -1.25609471e-01,  -9.51487091e-02,
         -1.46679843e-06,   1.79564831e-02,  -6.29217832e-02,
         -6.27814881e-02,  -1.63705555e-06,  -4.91060458e-03,
         -1.92793532e-07,   1.49396688e-07,  -3.75834150e-03,
          9.07090420e-03,   9.81989850e-02,   4.71977133e-02],
       [ -1.91016198e-02,  -8.36326513e-03,   1.13930092e-02,
         -1.80018641e-02,  -7.03448381e-02,  -5.63363208e-02,
          8.15705752e-07,  -3.46774126e-02,  -3.52380751e-02,
         -3.93862904e-02,   3.72098919e-07,  -1.57245769e-03,
         -7.32345051e-08,   2.21410427e-08,  -3.22403947e-03,
          5.07996634e-03,   4.71977133e-02,   2.87657002e-02]])
    ref_result_energy = -76.319084096715329
    ref_result_exp_alpha = array([[ -1.67103901e-04,   1.41663981e-01,  -2.43293224e-01,
         -1.37607972e-01,  -2.28048683e-06,   1.16204543e-01,
          1.14644016e-01,   8.42268424e-01,   7.95616035e-01,
          5.44751769e-05,   3.86660019e-01,   2.30763931e-02,
         -1.72315939e-01,  -1.42423227e-04,   9.52183862e-02,
          2.52553993e-06,   8.30181788e-01,   9.57949938e-01],
       [ -3.26826964e-03,   1.11004288e-03,  -1.36255633e-01,
         -1.00950055e-01,  -3.57433621e-06,   9.33221586e-01,
          1.25942269e+00,  -6.57566178e-01,  -5.82661462e-01,
          2.84394768e-06,  -4.67386661e-03,   9.40454354e-01,
         -6.73439816e-01,  -7.31598825e-05,   5.02529638e-02,
         -1.26886733e-05,   1.12398548e-01,  -1.28028220e-02],
       [ -9.94910767e-01,  -2.11516557e-01,  -3.10866665e-07,
         -8.29759891e-02,   2.50995608e-08,   9.32501759e-02,
         -2.95016653e-06,   4.21266906e-06,   4.36471356e-02,
          4.91498228e-06,   5.94448432e-02,   1.34719654e-06,
          6.80691968e-02,   3.63676266e-07,  -7.05563280e-04,
          1.53167251e-06,   1.74957542e-02,   6.45742736e-07],
       [ -2.90524786e-02,   4.62726248e-01,   6.90799463e-06,
          1.84366570e-01,  -5.69241666e-07,  -1.72171461e-01,
          1.30079937e-05,  -2.79903439e-05,  -1.95223318e-01,
         -2.55114408e-05,  -3.53565669e-01,  -1.80692803e-05,
         -1.61543169e+00,  -1.81387890e-04,   1.35811277e-01,
         -3.42262367e-05,   5.61185239e-01,  -5.49740755e-05],
       [ -3.77944572e-09,  -3.77807891e-06,  -5.16278554e-01,
          6.01968703e-06,  -8.46770051e-07,  -2.66528936e-06,
         -4.30722771e-01,  -2.22190536e-01,   1.79843336e-05,
          8.81014414e-06,  -3.79964413e-05,   9.76355677e-01,
         -7.27835291e-06,  -6.80797353e-06,  -8.31298198e-06,
          4.97616026e-06,   4.16941598e-06,   3.85833138e-02],
       [  1.65308765e-03,  -1.30944118e-01,   1.12619012e-06,
          5.56623595e-01,  -1.35655393e-06,   2.81692519e-01,
         -6.75626269e-06,  -1.16767858e-05,   5.51575906e-01,
         -8.12930689e-05,  -7.89590990e-01,  -4.80014759e-05,
          1.87721210e-01,   1.47933956e-05,  -8.22313779e-03,
          7.12480241e-06,  -4.17594082e-02,   1.03733293e-05],
       [ -1.13234527e-08,   4.51449309e-07,   3.88865724e-06,
         -2.40702355e-06,  -6.40748692e-01,  -2.55483110e-06,
          4.69043068e-07,  -2.99528335e-05,   1.41419719e-05,
          9.61998165e-01,  -9.00988529e-05,  -1.36680933e-05,
          2.53291421e-06,  -1.86105216e-05,  -5.48975201e-06,
         -6.85198772e-03,  -9.35410212e-07,  -2.28826612e-06],
       [  1.42366306e-02,   4.64992138e-01,  -7.24013137e-06,
          3.48171924e-01,   1.76389039e-06,  -1.09845090e+00,
          1.25486361e-05,   9.54205819e-06,   1.80914316e-01,
         -1.24195353e-05,   4.93428883e-03,   1.55804722e-05,
          2.53752008e+00,   3.67657313e-04,  -2.70166085e-01,
          5.35027709e-05,  -1.33583016e+00,   1.04638725e-04],
       [  5.59252508e-08,  -6.00999387e-07,  -2.58620994e-01,
          3.22118635e-06,   5.29658243e-07,  -2.19132792e-05,
         -7.58509978e-01,  -3.97436892e-01,  -3.47333106e-05,
         -3.70658911e-05,   8.15575464e-05,  -1.69860614e+00,
          2.74690223e-05,   1.77849890e-05,   1.74170537e-05,
         -1.13133117e-05,  -3.96694620e-05,  -9.47304068e-01],
       [ -2.56644920e-03,  -6.47533807e-02,   6.68508225e-06,
          3.89573468e-01,  -2.41284602e-06,   4.31194359e-01,
         -8.57591214e-06,   3.54195511e-05,  -1.81439145e-01,
          1.15216512e-04,   1.16320229e+00,   5.04243519e-05,
         -6.33780993e-01,  -2.17514069e-04,   1.50541505e-01,
         -1.71761213e-05,   6.78658850e-01,  -4.60831797e-05],
       [  3.45477711e-09,   2.22418053e-07,   1.85029608e-06,
         -8.51765389e-07,  -5.10191759e-01,   9.03666807e-07,
         -3.05845182e-06,   3.03647216e-05,  -1.46066328e-05,
         -1.03659198e+00,   9.63583334e-05,   1.55536527e-05,
         -1.01777977e-06,   3.42471405e-05,   4.53010191e-06,
         -3.50390972e-02,   2.21086037e-06,   2.01735908e-06],
       [ -1.95012503e-04,  -1.97356124e-02,   5.12023449e-07,
          1.53685255e-02,   1.07373216e-06,   1.28188872e-02,
          7.21872798e-07,  -2.28346031e-06,  -1.41546459e-01,
         -5.56457052e-06,  -6.82388389e-02,  -5.72221602e-06,
          1.62470645e-01,   6.81433214e-04,  -4.74433898e-01,
          1.65977606e-05,   9.79907265e-01,  -3.54498590e-05],
       [  2.60010833e-09,  -3.72720664e-07,  -7.06998592e-07,
         -2.33881403e-07,  -3.78549953e-07,   1.05414290e-06,
         -5.28258098e-07,  -1.02108407e-06,   2.45010461e-07,
         -2.19130682e-05,  -5.17769285e-06,  -7.66431361e-06,
         -7.95811952e-06,  -9.99998912e-01,  -1.43906845e-03,
         -3.23816293e-04,  -3.55411131e-07,  -4.00950149e-06],
       [  1.40645838e-08,  -3.95288383e-07,   2.89539196e-07,
          1.42820004e-07,   3.53068247e-02,   7.67301084e-07,
         -1.73300031e-06,  -2.64865748e-06,   2.86946082e-06,
          1.63992141e-02,  -3.46752734e-06,   3.46600941e-06,
          1.97991295e-05,   3.23232648e-04,  -2.39049223e-05,
         -9.99241907e-01,   2.05139039e-06,   7.52228050e-06],
       [  1.15425506e-04,   4.54068817e-03,   1.51014229e-06,
          3.19880006e-02,  -4.35348222e-07,   1.03902314e-02,
         -7.40094323e-07,  -1.13943243e-07,   1.20613365e-01,
          1.62678397e-06,   9.00124773e-02,  -5.58540578e-06,
         -1.85344690e-01,   1.25762522e-03,  -8.73070536e-01,
          1.66329503e-05,  -5.08580324e-01,   1.33301490e-05],
       [ -4.77746117e-08,  -2.96766417e-07,   3.72844086e-02,
          1.23848594e-06,  -3.64722549e-07,   8.92341600e-07,
          1.72514891e-02,  -2.09824207e-01,   9.38875473e-07,
         -4.31369618e-06,   1.50513991e-05,  -3.38073706e-02,
         -2.53871102e-05,  -4.66902351e-06,  -2.09454234e-06,
          9.92260736e-06,   4.97046857e-05,   1.27370118e+00],
       [ -1.67062217e-04,   1.41665736e-01,   2.43295230e-01,
         -1.37612588e-01,   4.38173647e-06,   1.16219450e-01,
         -1.14675801e-01,  -8.42211202e-01,   7.95645123e-01,
         -6.72947160e-07,   3.86704402e-01,  -2.30773240e-02,
         -1.72259395e-01,  -1.32901035e-04,   9.52285707e-02,
         -7.72018059e-06,   8.30110949e-01,  -9.58021652e-01],
       [ -3.26822361e-03,   1.10728585e-03,   1.36252500e-01,
         -1.00940925e-01,  -6.74546286e-08,   9.33147430e-01,
         -1.25944153e+00,   6.57552757e-01,  -5.82755583e-01,
          1.95598032e-05,  -4.64421692e-03,  -9.40448597e-01,
         -6.73450528e-01,  -5.90671708e-05,   5.02646322e-02,
         -1.76569773e-05,   1.12389923e-01,   1.27655161e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_gga.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
