# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_dm_alpha = array([[  9.13719878e-02,   4.60940498e-02,  -1.85270924e-02,
          3.96587059e-02,   1.22184928e-01,  -9.13164138e-02,
          9.63551442e-06,   1.98599220e-02,   6.18718116e-02,
         -6.06716204e-02,   3.69761279e-06,  -4.87282530e-03,
          5.91521291e-06,  -5.86539908e-06,  -3.64350793e-03,
         -8.91883352e-03,  -1.89551172e-02,  -1.91492197e-02],
       [  4.60940498e-02,   2.90217236e-02,   1.09643923e-02,
         -1.54730714e-02,   7.22463663e-02,  -5.55915866e-02,
         -9.13053610e-05,  -3.20771101e-02,   3.65815732e-02,
         -3.92425878e-02,  -7.49234379e-05,  -1.61243970e-03,
          3.60956359e-06,   2.54774879e-06,  -3.23997000e-03,
         -5.27288632e-03,  -1.91399578e-02,  -9.55634147e-03],
       [ -1.85270924e-02,   1.09643923e-02,   1.04053896e+00,
         -7.86053185e-02,   6.55484911e-06,  -1.96976523e-02,
         -1.04805462e-06,  -1.45189422e-01,  -5.02717430e-06,
         -1.61114217e-02,   1.63436218e-06,   3.30090760e-03,
          4.49085258e-07,   1.09549576e-06,  -3.90351430e-03,
          1.72688110e-06,  -1.85304089e-02,   1.09553329e-02],
       [  3.96587059e-02,  -1.54730714e-02,  -7.86053185e-02,
          2.40374124e-01,  -3.85328711e-05,   3.92082463e-02,
         -2.48107679e-05,   2.75406958e-01,  -3.16574035e-06,
          4.11568017e-02,  -2.38932164e-05,  -6.62569494e-03,
         -7.63552662e-07,  -6.48658618e-07,   8.15263314e-03,
         -1.06888169e-06,   3.96876432e-02,  -1.54413856e-02],
       [  1.22184928e-01,   7.22463663e-02,   6.55484911e-06,
         -3.85328711e-05,   2.70663230e-01,   1.85747346e-05,
          1.00521059e-05,   1.62567981e-05,   1.37063437e-01,
         -2.91357213e-06,   1.77012074e-06,   6.35673304e-07,
          1.28737941e-05,  -1.77623145e-06,  -4.38391967e-06,
         -1.97524462e-02,  -1.22207766e-01,  -7.22261642e-02],
       [ -9.13164138e-02,  -5.55915866e-02,  -1.96976523e-02,
          3.92082463e-02,   1.85747346e-05,   3.29422642e-01,
         -2.28897447e-06,   1.30825791e-01,   2.91304064e-05,
          2.29497394e-01,  -7.67344846e-07,   1.13682935e-02,
         -8.84905946e-07,   1.44395931e-05,   1.78248392e-02,
          2.57058507e-06,  -9.13326323e-02,  -5.55132126e-02],
       [  9.63551442e-06,  -9.13053610e-05,  -1.04805462e-06,
         -2.48107679e-05,   1.00521059e-05,  -2.28897447e-06,
          4.08040516e-01,   5.95048158e-05,   3.63977616e-05,
         -1.35191980e-05,   3.27236325e-01,  -1.07214467e-06,
          7.46036839e-06,  -2.29797712e-02,   1.50897975e-06,
          1.11687589e-06,  -1.76012149e-05,   4.64312821e-05],
       [  1.98599220e-02,  -3.20771101e-02,  -1.45189422e-01,
          2.75406958e-01,   1.62567981e-05,   1.30825791e-01,
          5.95048158e-05,   3.41189710e-01,   3.16435792e-05,
          1.06290742e-01,   4.35359172e-05,  -4.35424802e-03,
         -1.08252751e-06,  -1.83677309e-06,   1.37739358e-02,
         -4.47438742e-06,   1.98388936e-02,  -3.20500177e-02],
       [  6.18718116e-02,   3.65815732e-02,  -5.02717430e-06,
         -3.16574035e-06,   1.37063437e-01,   2.91304064e-05,
          3.63977616e-05,   3.16435792e-05,   6.94087151e-02,
          1.30816197e-05,   2.60037961e-05,   5.24912718e-07,
          6.51974912e-06,  -2.66199856e-06,  -7.92058131e-07,
         -1.00026078e-02,  -6.18882691e-02,  -3.65790745e-02],
       [ -6.06716204e-02,  -3.92425878e-02,  -1.61114217e-02,
          4.11568017e-02,  -2.91357213e-06,   2.29497394e-01,
         -1.35191980e-05,   1.06290742e-01,   1.30816197e-05,
          1.60700073e-01,  -1.03370342e-05,   7.45423211e-03,
         -6.55591331e-07,   1.05124148e-05,   1.27702979e-02,
          2.69456031e-06,  -6.06689498e-02,  -3.91794930e-02],
       [  3.69761279e-06,  -7.49234379e-05,   1.63436218e-06,
         -2.38932164e-05,   1.77012074e-06,  -7.67344846e-07,
          3.27236325e-01,   4.35359172e-05,   2.60037961e-05,
         -1.03370342e-05,   2.62433774e-01,  -6.81705876e-07,
          5.98270255e-06,  -1.84290911e-02,   1.16151988e-06,
          1.35492233e-06,  -1.24645966e-05,   3.88956760e-05],
       [ -4.87282530e-03,  -1.61243970e-03,   3.30090760e-03,
         -6.62569494e-03,   6.35673304e-07,   1.13682935e-02,
         -1.07214467e-06,  -4.35424802e-03,   5.24912718e-07,
          7.45423211e-03,  -6.81705876e-07,   6.64329664e-04,
         -8.10258255e-09,   6.82092942e-07,   4.09754120e-04,
          2.37704709e-07,  -4.87317867e-03,  -1.60975358e-03],
       [  5.91521291e-06,   3.60956359e-06,   4.49085258e-07,
         -7.63552662e-07,   1.28737941e-05,  -8.84905946e-07,
          7.46036839e-06,  -1.08252751e-06,   6.51974912e-06,
         -6.55591331e-07,   5.98270255e-06,  -8.10258255e-09,
          7.52950725e-10,  -4.20233853e-07,  -6.50497714e-08,
         -9.39467470e-07,  -5.70936937e-06,  -3.25973377e-06],
       [ -5.86539908e-06,   2.54774879e-06,   1.09549576e-06,
         -6.48658618e-07,  -1.77623145e-06,   1.44395931e-05,
         -2.29797712e-02,  -1.83677309e-06,  -2.66199856e-06,
          1.05124148e-05,  -1.84290911e-02,   6.82092942e-07,
         -4.20233853e-07,   1.29416110e-03,   5.92854116e-07,
          2.56532018e-08,  -3.23871040e-06,  -4.55946172e-06],
       [ -3.64350793e-03,  -3.23997000e-03,  -3.90351430e-03,
          8.15263314e-03,  -4.38391967e-06,   1.78248392e-02,
          1.50897975e-06,   1.37739358e-02,  -7.92058131e-07,
          1.27702979e-02,   1.16151988e-06,   4.09754120e-04,
         -6.50497714e-08,   5.92854116e-07,   1.11958367e-03,
          4.20218491e-07,  -3.63967182e-03,  -3.23283627e-03],
       [ -8.91883352e-03,  -5.27288632e-03,   1.72688110e-06,
         -1.06888169e-06,  -1.97524462e-02,   2.57058507e-06,
          1.11687589e-06,  -4.47438742e-06,  -1.00026078e-02,
          2.69456031e-06,   1.35492233e-06,   2.37704709e-07,
         -9.39467470e-07,   2.56532018e-08,   4.20218491e-07,
          1.44149306e-03,   8.91644301e-03,   5.27042369e-03],
       [ -1.89551172e-02,  -1.91399578e-02,  -1.85304089e-02,
          3.96876432e-02,  -1.22207766e-01,  -9.13326323e-02,
         -1.76012149e-05,   1.98388936e-02,  -6.18882691e-02,
         -6.06689498e-02,  -1.24645966e-05,  -4.87317867e-03,
         -5.70936937e-06,  -3.23871040e-06,  -3.63967182e-03,
          8.91644301e-03,   9.13897519e-02,   4.60668132e-02],
       [ -1.91492197e-02,  -9.55634147e-03,   1.09553329e-02,
         -1.54413856e-02,  -7.22261642e-02,  -5.55132126e-02,
          4.64312821e-05,  -3.20500177e-02,  -3.65790745e-02,
         -3.91794930e-02,   3.88956760e-05,  -1.60975358e-03,
         -3.25973377e-06,  -4.55946172e-06,  -3.23283627e-03,
          5.27042369e-03,   4.60668132e-02,   2.89810998e-02]])
    ref_result_energy = -75.839950406864816
    ref_result_exp_alpha = array([[ -1.10156119e-04,   1.39056491e-01,   2.34878365e-01,
         -1.29874470e-01,   1.00136476e-05,   1.11550043e-01,
          1.13950915e-01,   8.42092898e-01,   7.33700702e-01,
         -1.96838898e-03,   4.95354433e-01,   4.00356253e-03,
          1.68734554e-01,  -1.75324938e-03,  -9.71866947e-02,
          1.13822614e-04,  -8.32978537e-01,   9.59961204e-01],
       [ -3.76378801e-03,   4.93055349e-03,   1.38877198e-01,
         -9.84698822e-02,   1.61837000e-04,   9.34357652e-01,
          1.25405948e+00,  -6.31004913e-01,  -5.72978203e-01,
          1.41134474e-03,  -7.34506198e-02,   9.64069660e-01,
          6.78489470e-01,  -6.21695296e-04,  -4.90226628e-02,
         -3.27991886e-04,  -1.09613333e-01,  -1.57438690e-02],
       [ -9.94155485e-01,  -2.12464836e-01,   5.28505913e-06,
         -8.39793166e-02,   1.82563028e-05,   9.53442398e-02,
         -9.56950620e-05,   1.99647504e-05,   3.49373308e-02,
         -1.08498591e-04,   6.60375878e-02,   4.12003581e-06,
         -7.09402356e-02,   2.28089267e-06,   6.69014175e-04,
          2.89078731e-05,  -1.73787824e-02,  -1.85971625e-06],
       [ -3.33389656e-02,   4.54393571e-01,  -5.94809136e-05,
          1.81077672e-01,   1.49924999e-06,  -1.78324614e-01,
          3.53422957e-04,  -1.65658938e-04,  -1.41089514e-01,
         -3.46828711e-05,  -3.63550019e-01,  -4.23658662e-05,
          1.62283190e+00,  -2.41684049e-03,  -1.34079863e-01,
         -5.46159703e-04,  -5.55780058e-01,  -6.53600717e-04],
       [ -2.21744258e-07,  -3.59844010e-05,   5.20253106e-01,
          4.83252171e-05,  -3.80334821e-05,  -2.51224840e-04,
         -4.34970241e-01,  -1.94078107e-01,   3.70087590e-05,
          3.19917332e-04,  -3.13605262e-04,   9.78409392e-01,
          6.17670741e-05,   3.87222124e-04,   7.51964723e-05,
         -6.79163528e-05,   3.05762546e-05,   3.71386161e-02],
       [  1.73193894e-03,  -1.35812301e-01,  -2.55006555e-05,
          5.57651054e-01,  -1.39019042e-04,   2.81504405e-01,
         -2.90641878e-04,  -1.83289815e-04,   6.52431328e-01,
         -1.70169181e-03,  -7.08650522e-01,  -3.58860787e-04,
         -1.81456952e-01,   1.57217277e-04,   6.20006358e-03,
          5.81109111e-05,   3.97788186e-02,   1.31871713e-04],
       [  4.24359969e-07,   1.15275391e-05,  -2.73613910e-05,
         -1.60549072e-04,  -6.38780480e-01,   1.49532233e-05,
          1.24959646e-04,  -6.95544724e-04,   2.96539791e-03,
          9.63295671e-01,   3.30109741e-04,  -4.05723596e-04,
          3.26843678e-04,  -1.28243654e-04,  -1.09866066e-04,
          7.58432499e-03,  -1.03939022e-04,  -3.62414884e-05],
       [  1.64943475e-02,   4.68381025e-01,   3.12469778e-05,
          3.48621337e-01,  -1.72333371e-04,  -1.09461292e+00,
          6.57870371e-04,   4.36687865e-05,   1.73655816e-01,
          4.52698354e-04,  -2.47605852e-03,   4.06318706e-05,
         -2.54354215e+00,   4.95225886e-03,   2.68322039e-01,
          8.01090904e-04,   1.32750606e+00,   1.36670122e-03],
       [  6.09944714e-07,   1.77738854e-06,   2.63455358e-01,
          6.46969994e-05,  -6.82809833e-05,  -8.49922302e-04,
         -7.46828511e-01,  -4.36707321e-01,  -3.30203234e-04,
         -1.00532064e-03,   5.67633196e-04,  -1.69461319e+00,
         -1.53429605e-04,  -6.90042174e-04,  -1.90594445e-04,
          7.84837801e-05,   4.76375804e-04,  -9.45110816e-01],
       [ -2.83281252e-03,  -6.71232325e-02,  -4.69603130e-05,
          3.95204437e-01,  -7.93678824e-05,   4.20568487e-01,
         -2.68269925e-04,   2.34470346e-04,  -3.42474459e-01,
          3.70929630e-04,   1.13318821e+00,   4.33070521e-04,
          6.27578748e-01,  -2.94853038e-03,  -1.50240854e-01,
         -6.99043714e-05,  -6.76280390e-01,  -6.47691162e-04],
       [ -2.59640662e-07,   4.84346406e-07,  -3.40364562e-05,
         -1.28975128e-04,  -5.12282875e-01,   6.43773889e-06,
         -5.75282903e-05,   7.17575983e-04,  -3.18988000e-03,
         -1.03555562e+00,  -3.61443821e-04,   4.54705452e-04,
         -3.01250247e-04,   2.57204483e-04,   1.88771179e-04,
          3.50126471e-02,   1.04764097e-04,   3.13039165e-05],
       [ -1.90448492e-04,  -2.07096048e-02,  -1.63419146e-06,
          1.53429514e-02,  -2.56071854e-06,   1.29352447e-02,
          4.17537440e-06,   2.19228463e-07,  -1.33396922e-01,
          4.51374376e-04,  -8.93594494e-02,   4.20303739e-06,
         -1.58755202e-01,   9.26138402e-03,   4.73041885e-01,
         -7.58585103e-04,  -9.80568551e-01,  -6.00252404e-04],
       [ -9.31891387e-08,  -9.58056507e-07,   2.47508644e-05,
         -1.82168367e-06,  -1.16755152e-05,   1.00863899e-05,
         -6.24810390e-05,   3.38792738e-06,   2.59724948e-05,
         -1.57501178e-04,  -5.56869449e-05,   3.48155851e-04,
          1.31751775e-04,  -9.99803928e-01,   1.96497445e-02,
          2.40754536e-03,   1.45949243e-05,   1.56766836e-04],
       [ -8.76614190e-08,  -1.40813463e-05,  -7.88118398e-07,
          3.14403295e-05,   3.59744562e-02,   3.11352294e-05,
         -1.39930522e-05,  -3.86006075e-05,   5.53955826e-05,
          1.59883843e-02,   1.59197471e-05,   5.10158796e-05,
          4.97331333e-04,   2.43734364e-03,   1.73291601e-03,
          9.99220201e-01,   4.95416326e-06,  -1.67101258e-06],
       [  1.13225545e-04,   4.75126133e-03,  -1.11786006e-05,
          3.31209544e-02,  -1.06001177e-05,   1.03025209e-02,
         -2.24414649e-05,  -4.32308040e-05,   1.10417717e-01,
         -2.70323246e-04,   1.07655205e-01,  -9.21158516e-05,
          1.81158416e-01,   1.71941334e-02,   8.73624776e-01,
         -1.65414624e-03,   5.07658750e-01,   2.56741771e-04],
       [ -3.67589733e-07,  -7.74277973e-06,  -3.79670210e-02,
          9.84839386e-07,  -1.22565580e-07,   4.48061894e-05,
          1.72196114e-02,  -2.14041861e-01,  -9.11939766e-05,
         -1.20900751e-04,   1.29855291e-04,  -2.60677970e-02,
          2.39706029e-04,   1.88256451e-04,   2.16111682e-05,
         -3.26897907e-06,  -8.04700958e-04,   1.27316116e+00],
       [ -1.09821791e-04,   1.39076873e-01,  -2.34878884e-01,
         -1.29920061e-01,   7.27856991e-05,   1.11499722e-01,
         -1.14327847e-01,  -8.42151283e-01,   7.33490779e-01,
         -3.20088235e-03,   4.95492359e-01,  -3.74882279e-03,
          1.68232878e-01,  -2.06247818e-03,  -9.73011398e-02,
          6.10451097e-05,  -8.31766434e-01,  -9.61074916e-01],
       [ -3.76321323e-03,   4.91459421e-03,  -1.38819390e-01,
         -9.83459862e-02,  -4.19237126e-05,   9.31841797e-01,
         -1.25538783e+00,   6.31228970e-01,  -5.73346106e-01,
          1.69420736e-03,  -7.30865281e-02,  -9.64214626e-01,
          6.78807364e-01,  -1.13668831e-03,  -4.91666059e-02,
         -2.11843160e-04,  -1.09790300e-01,   1.52736284e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_numlda.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
