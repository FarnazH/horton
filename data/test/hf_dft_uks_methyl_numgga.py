# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_dm_alpha = array([[  1.03149988e+00,  -4.58029679e-02,  -3.73678467e-05,
          2.05488067e-05,  -6.51992204e-06,  -1.09588584e-01,
         -3.79027961e-05,   2.28363555e-05,  -6.20949971e-06,
          1.55083201e-03,   2.91941438e-06,   2.41927511e-06,
         -3.37196742e-06,  -8.25504300e-06,  -2.91209175e-02,
         -3.86484455e-03,  -2.92347446e-02,  -3.75529706e-03,
         -2.91645483e-02,  -3.83106969e-03],
       [ -4.58029679e-02,   1.60980985e-01,   2.70089474e-05,
          8.07273747e-06,   2.82838271e-06,   1.69010442e-01,
          5.14256193e-05,  -1.99189960e-05,   1.85395296e-06,
         -2.55312685e-03,  -4.95192807e-06,  -4.62982736e-06,
          5.14940369e-06,   1.53580405e-05,   5.46718012e-02,
          1.72509591e-02,   5.49695879e-02,   1.70920428e-02,
          5.47740789e-02,   1.71981393e-02],
       [ -3.73678467e-05,   2.70089474e-05,   1.99982436e-01,
          3.48562969e-05,   4.67255720e-05,   1.42265309e-04,
          9.38985881e-02,   1.30284931e-04,   3.29086124e-05,
          1.54988379e-06,  -2.71705075e-05,   4.11859185e-06,
          8.91885548e-03,   1.33234772e-05,   1.22909099e-01,
          1.01064595e-01,  -6.17764246e-02,  -5.04426152e-02,
         -6.16082531e-02,  -5.04416709e-02],
       [  2.05488067e-05,   8.07273747e-06,   3.48562969e-05,
          1.99862260e-01,  -1.81355185e-05,  -8.72499197e-05,
         -3.71720313e-05,   9.38279666e-02,  -1.19749101e-05,
         -8.37821377e-06,   3.71372841e-06,  -7.07116968e-06,
         -8.84236186e-06,  -8.92793959e-03,   5.10853800e-05,
          8.12034383e-05,   1.06946963e-01,   8.71221716e-02,
         -1.06610355e-01,  -8.73906284e-02],
       [ -6.51992204e-06,   2.82838271e-06,   4.67255720e-05,
         -1.81355185e-05,   3.61074649e-01,   6.99269569e-05,
          1.91167782e-05,   5.29821290e-05,   3.16791321e-01,
          2.43933709e-05,   1.59023255e-05,  -2.84859682e-05,
          8.98340275e-06,   8.35399672e-06,  -1.02015357e-04,
          2.13121437e-05,   2.58391682e-05,  -8.57300122e-05,
          1.53694141e-05,   8.51350686e-07],
       [ -1.09588584e-01,   1.69010442e-01,   1.42265309e-04,
         -8.72499197e-05,   6.99269569e-05,   1.81154308e-01,
          1.08063283e-04,  -6.61659236e-05,   6.07259770e-05,
         -2.73024539e-03,  -5.30418745e-06,  -4.92690348e-06,
          1.05277788e-05,   2.05828926e-05,   5.82867646e-02,
          1.81050253e-02,   5.84471678e-02,   1.78082371e-02,
          5.83419476e-02,   1.80047883e-02],
       [ -3.79027961e-05,   5.14256193e-05,   9.38985881e-02,
         -3.71720313e-05,   1.91167782e-05,   1.08063283e-04,
          4.40886198e-02,   3.60327448e-05,   1.29742011e-05,
          1.07719632e-07,  -1.27598073e-05,   1.93481262e-06,
          4.18771113e-03,   8.65115710e-06,   5.77232943e-02,
          4.74574034e-02,  -2.90214381e-02,  -2.37037668e-02,
         -2.88853141e-02,  -2.36565487e-02],
       [  2.28363555e-05,  -1.99189960e-05,   1.30284931e-04,
          9.38279666e-02,   5.29821290e-05,  -6.61659236e-05,
          3.60327448e-05,   4.40488519e-02,   4.83277162e-05,
         -3.54672664e-06,   1.73142764e-06,  -3.32146713e-06,
          9.30106333e-07,  -4.19133124e-03,   8.58355364e-05,
          9.31600249e-05,   5.01642768e-02,   4.08693820e-02,
         -5.00928750e-02,  -4.10579342e-02],
       [ -6.20949971e-06,   1.85395296e-06,   3.29086124e-05,
         -1.19749101e-05,   3.16791321e-01,   6.07259770e-05,
          1.29742011e-05,   4.83277162e-05,   2.77939040e-01,
          2.14108599e-05,   1.39532047e-05,  -2.49926484e-05,
          7.52079193e-06,   7.15293404e-06,  -9.46770202e-05,
          1.45452199e-05,   2.70704512e-05,  -7.15266897e-05,
          1.36709914e-05,   9.97233050e-07],
       [  1.55083201e-03,  -2.55312685e-03,   1.54988379e-06,
         -8.37821377e-06,   2.43933709e-05,  -2.73024539e-03,
          1.07719632e-07,  -3.54672664e-06,   2.14108599e-05,
          4.11614291e-05,   8.04102958e-08,   7.27256261e-08,
          6.98261137e-09,   1.23304501e-07,  -8.76844264e-04,
         -2.71743103e-04,  -8.87851537e-04,  -2.74294178e-04,
         -8.75903711e-04,  -2.68788724e-04],
       [  2.91941438e-06,  -4.95192807e-06,  -2.71705075e-05,
          3.71372841e-06,   1.59023255e-05,  -5.30418745e-06,
         -1.27598073e-05,   1.73142764e-06,   1.39532047e-05,
          8.04102958e-08,   4.61598782e-09,  -1.80235819e-09,
         -1.21176718e-06,  -1.68070877e-07,  -1.84043166e-05,
         -1.42583127e-05,   8.67536775e-06,   7.94763719e-06,
          4.68374210e-06,   4.70027567e-06],
       [  2.41927511e-06,  -4.62982736e-06,   4.11859185e-06,
         -7.07116968e-06,  -2.84859682e-05,  -4.92690348e-06,
          1.93481262e-06,  -3.32146713e-06,  -2.49926484e-05,
          7.27256261e-08,  -1.80235819e-09,   2.71697670e-09,
          1.83391269e-07,   3.15128946e-07,   9.53973221e-07,
          1.58472763e-06,  -6.65659416e-06,  -4.60715709e-06,
          9.11117914e-07,   1.55892694e-06],
       [ -3.37196742e-06,   5.14940369e-06,   8.91885548e-03,
         -8.84236186e-06,   8.98340275e-06,   1.05277788e-05,
          4.18771113e-03,   9.30106333e-07,   7.52079193e-06,
          6.98261137e-09,  -1.21176718e-06,   1.83391269e-07,
          3.97765616e-04,   1.05916790e-06,   5.48286699e-03,
          4.50771691e-03,  -2.75932495e-03,  -2.25376504e-03,
         -2.74072066e-03,  -2.24464058e-03],
       [ -8.25504300e-06,   1.53580405e-05,   1.33234772e-05,
         -8.92793959e-03,   8.35399672e-06,   2.05828926e-05,
          8.65115710e-06,  -4.19133124e-03,   7.15293404e-06,
          1.23304501e-07,  -1.68070877e-07,   3.15128946e-07,
          1.05916790e-06,   3.98817998e-04,   1.22348907e-05,
          5.57259193e-06,  -4.77656203e-03,  -3.89387765e-03,
          4.76313842e-03,   3.90170478e-03],
       [ -2.91209175e-02,   5.46718012e-02,   1.22909099e-01,
          5.10853800e-05,  -1.02015357e-04,   5.82867646e-02,
          5.77232943e-02,   8.58355364e-05,  -9.46770202e-05,
         -8.76844264e-04,  -1.84043166e-05,   9.53973221e-07,
          5.48286699e-03,   1.22348907e-05,   9.42762921e-02,
          6.79524745e-02,  -1.91065089e-02,  -2.51994557e-02,
         -1.90988127e-02,  -2.51860477e-02],
       [ -3.86484455e-03,   1.72509591e-02,   1.01064595e-01,
          8.12034383e-05,   2.13121437e-05,   1.81050253e-02,
          4.74574034e-02,   9.31600249e-05,   1.45452199e-05,
         -2.71743103e-04,  -1.42583127e-05,   1.58472763e-06,
          4.50771691e-03,   5.57259193e-06,   6.79524745e-02,
          5.29215812e-02,  -2.53135184e-02,  -2.36326841e-02,
         -2.53164485e-02,  -2.36756422e-02],
       [ -2.92347446e-02,   5.49695879e-02,  -6.17764246e-02,
          1.06946963e-01,   2.58391682e-05,   5.84471678e-02,
         -2.90214381e-02,   5.01642768e-02,   2.70704512e-05,
         -8.87851537e-04,   8.67536775e-06,  -6.65659416e-06,
         -2.75932495e-03,  -4.77656203e-03,  -1.91065089e-02,
         -2.53135184e-02,   9.52775653e-02,   6.80342799e-02,
         -1.91254968e-02,  -2.53188097e-02],
       [ -3.75529706e-03,   1.70920428e-02,  -5.04426152e-02,
          8.71221716e-02,  -8.57300122e-05,   1.78082371e-02,
         -2.37037668e-02,   4.08693820e-02,  -7.15266897e-05,
         -2.74294178e-04,   7.94763719e-06,  -4.60715709e-06,
         -2.25376504e-03,  -3.89387765e-03,  -2.51994557e-02,
         -2.36326841e-02,   6.80342799e-02,   5.25252051e-02,
         -2.51293494e-02,  -2.35427992e-02],
       [ -2.91645483e-02,   5.47740789e-02,  -6.16082531e-02,
         -1.06610355e-01,   1.53694141e-05,   5.83419476e-02,
         -2.88853141e-02,  -5.00928750e-02,   1.36709914e-05,
         -8.75903711e-04,   4.68374210e-06,   9.11117914e-07,
         -2.74072066e-03,   4.76313842e-03,  -1.90988127e-02,
         -2.53164485e-02,  -1.91254968e-02,  -2.51293494e-02,
          9.46626674e-02,   6.79883047e-02],
       [ -3.83106969e-03,   1.71981393e-02,  -5.04416709e-02,
         -8.73906284e-02,   8.51350686e-07,   1.80047883e-02,
         -2.36565487e-02,  -4.10579342e-02,   9.97233050e-07,
         -2.68788724e-04,   4.70027567e-06,   1.55892694e-06,
         -2.24464058e-03,   3.90170478e-03,  -2.51860477e-02,
         -2.36756422e-02,  -2.53188097e-02,  -2.35427992e-02,
          6.79883047e-02,   5.27678255e-02]])
    ref_result_energy = -39.76265988209984
    ref_result_exp_alpha = array([[  9.94858813e-01,   2.04342369e-01,  -7.81417456e-05,
         -1.11452834e-04,  -1.96299889e-05,   1.54044391e-01,
          1.32388566e-04,   1.84514260e-04,  -8.12233784e-07,
          6.85942958e-05,   4.58585824e-06,  -4.69782102e-02,
          2.68410975e-05,  -1.89580743e-05,   3.47176381e-02,
         -9.16232161e-06,  -1.00469629e-05,  -4.11580909e-02,
         -1.07986448e-04,  -1.70479895e-04],
       [  3.60380725e-02,  -3.99602624e-01,   2.55641221e-05,
          1.27520110e-04,   1.99043312e-05,  -2.58168065e-01,
         -2.97939638e-04,  -3.17546024e-04,   3.44699253e-05,
          3.22109234e-04,   4.53944605e-04,  -6.57169668e-01,
          1.97186105e-03,   1.73911181e-03,  -1.94960604e+00,
          3.32283894e-04,  -2.53160764e-04,  -2.73321952e-01,
         -6.80434324e-04,  -6.17953240e-04],
       [  7.35877310e-07,   7.76953234e-05,   5.84088598e-02,
          4.43363112e-01,   1.43140151e-04,  -4.64751554e-04,
          4.35696002e-01,   8.71664239e-02,   3.87603806e-05,
         -4.29953676e-01,   7.07141330e-01,  -1.32086093e-03,
         -3.53747028e-01,  -6.71051147e-01,  -3.95618075e-04,
          6.98871095e-05,  -7.44416178e-05,  -8.15237069e-06,
         -5.58984557e-02,  -2.07407997e-02],
       [ -1.44810206e-06,  -2.99167206e-05,  -4.43219670e-01,
          5.84686163e-02,   1.50789729e-05,   5.78946771e-04,
          8.73292257e-02,  -4.35681268e-01,  -3.74822067e-04,
          7.06134858e-01,   4.30432627e-01,   2.14322946e-03,
          6.72199064e-01,  -3.53081899e-01,  -1.73025695e-04,
         -3.78857987e-05,  -1.04637468e-04,   4.81669701e-05,
         -2.04947062e-02,   5.63471199e-02],
       [  5.97919380e-07,   2.28963412e-05,   4.88247161e-05,
         -9.50477831e-05,   6.00894899e-01,   2.93246689e-05,
          3.29102547e-05,   1.42482262e-04,  -1.05809847e+00,
         -3.29118136e-04,  -1.59571717e-04,  -6.63749672e-05,
          1.30338123e-05,   7.92384161e-05,  -4.97862570e-06,
         -4.52452316e-05,  -1.05230117e-05,   4.37815075e-05,
          4.72600172e-05,   3.78445736e-05],
       [ -2.28589671e-02,  -4.25007662e-01,   2.73208257e-04,
          3.59436298e-04,   1.32535913e-04,  -1.84818962e+00,
         -1.30568979e-03,  -2.33532677e-03,  -3.13184902e-05,
          1.39356598e-04,  -8.71230761e-04,   9.81488691e-01,
         -3.29292121e-03,  -3.22915059e-03,   3.60859031e+00,
         -6.20565235e-04,   5.97525921e-04,   7.92146177e-01,
          1.91958351e-03,   2.23397300e-03],
       [ -1.83462680e-07,  -6.05090089e-05,   2.75436891e-02,
          2.08158511e-01,   6.25033950e-05,  -1.06380603e-03,
          1.25573985e+00,   2.50663926e-01,   8.90064785e-05,
          8.79174796e-01,  -1.44687120e+00,   1.93942221e-03,
          5.34334193e-01,   1.01264678e+00,   5.20737855e-04,
         -3.12293519e-04,  -1.89431377e-04,   1.74703183e-03,
         -5.01185685e-01,  -1.83830711e-01],
       [  3.91220897e-07,   4.54797525e-05,  -2.08041869e-01,
          2.77013666e-02,   1.09453799e-04,   1.09027406e-03,
          2.50280280e-01,  -1.25588747e+00,   5.08128362e-04,
         -1.44478159e+00,  -8.80187241e-01,  -3.29106762e-03,
         -1.01550154e+00,   5.32910916e-01,   2.08296420e-04,
          5.53510514e-04,   2.47531493e-04,  -1.26314267e-03,
         -1.84057043e-01,   5.00947611e-01],
       [ -2.74847998e-07,   2.15702996e-05,   3.17405764e-05,
         -1.00167563e-04,   5.27199194e-01,   4.09449720e-05,
         -9.38531733e-05,  -1.31880457e-04,   1.09668047e+00,
          3.43091415e-04,   2.19422107e-04,   6.02637455e-06,
          6.28430806e-05,   1.39632792e-05,   1.50264367e-05,
          2.82755737e-05,  -4.86268033e-05,  -1.35626064e-05,
         -1.32785003e-05,  -1.00021975e-05],
       [  2.42040350e-04,   6.41099889e-03,   1.84552738e-05,
         -6.08859804e-08,   4.03368948e-05,  -1.71553212e-02,
         -7.33824391e-05,  -9.02793447e-05,  -3.25232723e-05,
         -3.56906686e-04,  -1.41199533e-05,   1.85168781e-01,
          9.21728676e-05,   7.69340844e-05,  -2.69637197e-02,
          1.88719243e-04,  -6.42260722e-04,  -1.05102242e+00,
         -2.27029137e-03,  -3.35086356e-03],
       [  3.78599176e-07,   1.24079481e-05,  -1.61845695e-05,
         -5.91697482e-05,   2.64331374e-05,  -4.88447920e-05,
          4.11327023e-05,  -9.38743118e-06,   3.72118727e-05,
          3.13671398e-05,  -1.01917042e-04,   1.94804127e-04,
         -7.62178642e-05,  -2.53391629e-04,  -1.99737197e-04,
         -6.88700712e-01,   7.25045346e-01,  -5.27198328e-04,
         -1.38515575e-04,   3.30814206e-04],
       [  5.20054526e-08,   1.15927372e-05,   1.68937270e-05,
          7.07722984e-06,  -4.74245962e-05,  -6.46085471e-06,
         -9.36334995e-06,   2.03005194e-05,   1.09853314e-05,
         -1.41906777e-05,   7.81630371e-07,   3.38547959e-06,
         -1.53436701e-04,   4.39809162e-05,  -7.79566344e-05,
         -7.25045102e-01,  -6.88700651e-01,   2.89958672e-04,
          2.69406800e-04,   9.06024460e-04],
       [  3.42025432e-07,  -6.37781466e-06,   2.62797255e-03,
          1.97701473e-02,   1.78639318e-05,  -4.50529336e-05,
         -2.18055211e-02,  -4.43127298e-03,  -3.33882239e-05,
         -6.07085677e-02,   9.95587007e-02,   3.47616698e-04,
          9.21070323e-02,   1.74822414e-01,   1.42065843e-04,
         -4.81758200e-04,  -3.88872956e-04,   3.49136119e-03,
         -1.01818225e+00,  -3.73724799e-01],
       [  7.57982135e-07,  -3.79167296e-05,   1.98032079e-02,
         -2.57884546e-03,   1.18870764e-05,  -3.53715010e-05,
          4.29660907e-03,  -2.20253814e-02,   2.10157808e-05,
         -1.00057548e-01,  -6.05597023e-02,   1.54014022e-04,
          1.75453186e-01,  -9.19242942e-02,  -1.32008702e-04,
         -8.76170133e-04,  -3.12764398e-04,   2.51446386e-03,
          3.73810858e-01,  -1.01801675e+00],
       [ -1.13373068e-03,  -1.36828443e-01,   3.58444684e-02,
          2.72521794e-01,  -1.24352167e-04,   1.13622783e-01,
         -1.25257400e-01,  -2.50333717e-02,   3.61820892e-05,
         -2.21395686e-01,   3.64971063e-01,  -6.37184926e-01,
          4.07468764e-01,   7.74318924e-01,   2.85476213e-01,
         -3.80843383e-05,   3.68014845e-04,  -3.78387089e-01,
          6.39014467e-01,   2.33952286e-01],
       [  4.90379110e-03,  -4.26546827e-02,   2.93806530e-02,
          2.24086702e-01,   7.01824856e-05,   9.54518458e-01,
         -1.59513505e+00,  -3.17272646e-01,  -1.55069891e-04,
         -2.41945301e-01,   3.98913566e-01,   2.31184056e-01,
         -7.30921276e-01,  -1.38846974e+00,  -1.09573092e+00,
          4.63087478e-04,  -2.95894676e-04,  -6.47208009e-02,
          1.02762870e-02,   3.34647864e-03],
       [ -1.13173642e-03,  -1.37712768e-01,  -2.55228525e-01,
         -1.05687963e-01,   5.22818837e-05,   1.13560656e-01,
          4.11772502e-02,   1.21330789e-01,  -1.09065002e-04,
          4.28675566e-01,   9.74569564e-03,  -6.37948659e-01,
         -8.71746465e-01,  -3.45557175e-02,   2.83843663e-01,
         -5.42371811e-04,  -3.78769739e-04,  -3.74372557e-01,
         -1.17414113e-01,  -6.73797936e-01],
       [  4.90229082e-03,  -4.23713526e-02,  -2.07957442e-01,
         -8.63688400e-02,  -1.37787350e-04,   9.50412882e-01,
          5.22726856e-01,   1.54228407e+00,   3.50818624e-05,
          4.62507769e-01,   1.07552586e-02,   2.35868849e-01,
          1.57008287e+00,   6.26059369e-02,  -1.09391403e+00,
         -2.65674871e-05,  -2.20536767e-04,  -6.40422150e-02,
         -2.00403640e-03,  -1.00100265e-02],
       [ -1.13353755e-03,  -1.37213179e-01,   2.18421806e-01,
         -1.67707623e-01,  -1.34574578e-05,   1.13689667e-01,
          8.43394811e-02,  -9.62626045e-02,   9.30473825e-05,
         -2.04698547e-01,  -3.74251354e-01,  -6.37482884e-01,
          4.67137121e-01,  -7.39574861e-01,   2.84238844e-01,
          3.01782618e-04,  -2.94616089e-04,  -3.76648135e-01,
         -5.24382975e-01,   4.35816321e-01],
       [  4.90358742e-03,  -4.26282209e-02,   1.79055928e-01,
         -1.37352006e-01,  -3.32058216e-05,   9.53371340e-01,
          1.07446639e+00,  -1.22119813e+00,   1.04280553e-04,
         -2.23219929e-01,  -4.09175652e-01,   2.31983904e-01,
         -8.38397238e-01,   1.32839627e+00,  -1.09403462e+00,
          2.13522496e-04,   9.68020029e-05,  -6.44866401e-02,
         -8.58984275e-03,   6.57568203e-03]])
    ref_result_exp_beta = array([[  9.95044104e-01,   1.95985288e-01,   8.61788942e-05,
         -1.23521221e-04,   1.50659560e-05,   1.61496912e-01,
          1.77715386e-04,  -2.55382413e-04,  -8.25469730e-05,
         -5.74646435e-06,   3.81237625e-06,   5.85893983e-02,
          4.80098532e-05,  -7.50426093e-06,   3.61335440e-02,
         -3.08082321e-05,   8.32940766e-06,  -3.15130478e-02,
          1.70096020e-04,  -2.70136359e-04],
       [  3.45023207e-02,  -3.79833539e-01,  -5.82194206e-05,
          1.60406256e-04,  -4.48528958e-06,  -2.56423870e-01,
         -3.61332227e-04,   4.08500807e-04,  -1.44925307e-04,
         -4.13800757e-04,   1.30456252e-04,   5.39020658e-01,
          7.95639700e-04,   1.06742066e-03,  -1.98109410e+00,
          3.28846567e-04,  -1.19881500e-04,  -3.29662862e-01,
          1.57249470e-03,  -2.01123911e-03],
       [  7.55339305e-07,   9.98285264e-05,  -5.45961997e-02,
          4.25883030e-01,  -1.87541937e-04,  -6.57437082e-04,
          4.35843099e-01,  -9.71435215e-02,   4.29852381e-01,
         -6.88006140e-01,   4.22726074e-04,   1.33896213e-03,
         -3.79579341e-01,  -6.86964334e-01,  -1.68264382e-05,
          6.65971633e-05,  -2.76379929e-05,   2.24643842e-04,
          5.52272530e-02,  -1.98070756e-02],
       [ -1.75589794e-06,  -3.74634598e-05,   4.25701103e-01,
          5.46741004e-02,  -9.43322118e-06,   7.49955449e-04,
          9.73180343e-02,   4.35773855e-01,  -6.86885533e-01,
         -4.30363139e-01,   2.05204777e-04,  -2.08596096e-03,
          6.88223730e-01,  -3.78917843e-01,  -3.94738431e-04,
          2.63098948e-05,  -1.06345460e-04,  -1.64209180e-04,
          1.95515018e-02,   5.56911218e-02],
       [  9.54233306e-09,   5.00609976e-05,  -4.20380529e-05,
          5.39440197e-06,  -5.34263198e-01,   1.05955155e-05,
          4.41592879e-05,  -1.29893962e-04,   1.30350102e-05,
         -7.89918602e-04,  -1.09325630e+00,   6.00022688e-05,
          8.66453802e-05,   2.72831647e-04,  -6.74008704e-05,
         -4.15966653e-05,  -8.32946642e-05,   1.32212843e-05,
         -4.20977083e-05,   5.15387608e-05],
       [ -2.15075277e-02,  -3.65988700e-01,  -2.28657492e-04,
          3.23415071e-04,  -4.42544101e-05,  -1.91161911e+00,
         -1.85397256e-03,   3.21047474e-03,  -2.78501475e-04,
          7.99810008e-04,  -2.74448303e-04,  -8.59137425e-01,
         -1.11852533e-03,  -1.96368608e-03,   3.60684929e+00,
         -4.67068687e-04,   1.94230911e-04,   8.20667448e-01,
         -3.96406246e-03,   5.45041755e-03],
       [  6.32549605e-08,  -5.56590390e-05,  -2.36637844e-02,
          1.83542829e-01,  -6.72391929e-05,  -1.56167895e-03,
          1.26871092e+00,  -2.82282747e-01,  -8.83415733e-01,
          1.41480575e+00,  -6.42525350e-04,  -1.89509059e-03,
          5.63080809e-01,   1.01810976e+00,  -5.82813712e-05,
         -2.41173520e-04,  -3.93679566e-04,   3.64833415e-03,
          5.04839502e-01,  -1.78874128e-01],
       [  3.84697976e-07,   3.81301606e-05,   1.83459072e-01,
          2.38168184e-02,  -1.25140764e-04,   1.52223694e-03,
          2.81885210e-01,   1.26895802e+00,   1.41249790e+00,
          8.84440214e-01,  -6.31153658e-04,   3.09257076e-03,
         -1.02107927e+00,   5.61687479e-01,   5.40209106e-04,
          4.75940004e-04,   3.86103023e-04,  -2.77594339e-03,
          1.79115532e-01,   5.04600064e-01],
       [ -6.81563163e-08,   3.22593006e-05,  -3.09528430e-05,
         -6.83612419e-05,  -5.94056322e-01,  -1.79026404e-05,
         -2.06292225e-04,   1.16034877e-04,  -2.91672942e-05,
          7.36434900e-04,   1.06195278e+00,  -1.19528179e-05,
          1.42690152e-05,  -1.33780863e-04,   6.39408727e-05,
          4.52741237e-05,  -8.12877860e-06,   5.21262772e-07,
          1.21520114e-05,  -1.67606258e-05],
       [ -6.20113694e-04,   3.17865707e-02,  -1.53203570e-05,
         -1.25817377e-05,  -1.72739808e-05,   1.39397508e-02,
         -3.37753348e-05,   2.92365467e-05,   3.16368582e-04,
          8.55786568e-06,  -1.26625296e-05,  -1.55634857e-01,
          8.75681152e-05,   5.77892674e-05,   1.43496189e-02,
         -1.47818295e-04,  -2.25611669e-04,  -1.05560512e+00,
          4.86441318e-03,  -7.47576073e-03],
       [  1.38062314e-06,   3.40554400e-06,   2.06872936e-05,
         -6.58236611e-05,  -4.25111974e-05,  -6.17739463e-05,
          2.94679135e-05,   1.63177357e-05,  -4.08642265e-05,
          1.00847910e-04,   1.71617072e-05,  -2.22287782e-04,
         -5.31344075e-05,  -2.22382546e-04,  -2.35799056e-04,
         -8.75576621e-01,   4.83078869e-01,   4.63402823e-05,
          2.11932868e-04,   3.98785564e-04],
       [  1.47709155e-07,   1.53599612e-05,  -1.37181722e-05,
          1.18358562e-05,   6.79679491e-05,  -1.03601200e-06,
         -4.11997710e-06,  -1.96842236e-05,   8.67554195e-06,
         -1.48587440e-05,   5.19571469e-05,   1.40063060e-06,
         -1.46121994e-04,   3.56539926e-05,  -7.17879157e-05,
         -4.83078366e-01,  -8.75576395e-01,   2.45034507e-04,
         -4.19170452e-04,   9.98512522e-04],
       [  9.37162823e-07,  -1.09505409e-05,  -2.55004722e-03,
          1.96785301e-02,  -5.53057168e-06,  -5.02086432e-05,
         -1.86435510e-02,   4.22509136e-03,   6.35923421e-02,
         -1.01466480e-01,   6.85984221e-05,  -3.77566054e-04,
          9.27052059e-02,   1.67862856e-01,   9.29634673e-06,
         -3.70035237e-04,  -7.03119031e-04,   7.37320768e-03,
          1.02295311e+00,  -3.62706420e-01],
       [  1.12440230e-06,  -4.08299687e-05,  -1.97179734e-02,
         -2.49271119e-03,  -1.97767380e-05,  -3.86738546e-05,
          4.09991298e-03,   1.88614781e-02,   1.02000153e-01,
          6.34383236e-02,  -8.01247410e-05,  -1.77894088e-04,
          1.68496147e-01,  -9.25340346e-02,  -2.22170325e-04,
         -8.44644615e-04,  -5.57213703e-04,   5.63377198e-03,
         -3.62826573e-01,  -1.02278525e+00],
       [ -1.20002870e-03,  -1.51310020e-01,  -3.66879563e-02,
          2.86428000e-01,   1.69929650e-04,   9.52666349e-02,
         -1.10008964e-01,   2.44937354e-02,   2.35587111e-01,
         -3.77751497e-01,   4.55826085e-04,   6.62124060e-01,
          4.18570618e-01,   7.58778817e-01,   2.59524702e-01,
         -2.96455865e-04,   5.76291158e-04,  -3.54829253e-01,
         -6.37105372e-01,   2.24277510e-01],
       [  4.62358179e-03,  -6.93691573e-02,  -3.19983872e-02,
          2.50492925e-01,  -2.42886538e-05,   9.76015870e-01,
         -1.59783120e+00,   3.53997240e-01,   2.28068282e-01,
         -3.66093440e-01,  -1.69780419e-04,  -2.66113582e-01,
         -7.56268876e-01,  -1.36984740e+00,  -1.06562326e+00,
          4.90024104e-04,  -1.15932159e-04,  -8.17817558e-02,
         -1.26755485e-02,   3.80077054e-03],
       [ -1.19752798e-03,  -1.52291674e-01,   2.67662610e-01,
         -1.11902788e-01,  -9.81222366e-05,   9.50525587e-02,
          3.39896425e-02,  -1.07784866e-01,  -4.46859870e-01,
         -1.56204488e-02,  -4.16159503e-05,   6.62800081e-01,
         -8.63445874e-01,  -1.71551665e-02,   2.58828913e-01,
         -6.85690264e-04,  -4.29402643e-04,  -3.45484244e-01,
          1.24940134e-01,  -6.69985086e-01],
       [  4.62215076e-03,  -6.90927064e-02,   2.32043233e-01,
         -9.72700780e-02,   5.85142121e-05,   9.70658936e-01,
          4.92340400e-01,  -1.56398264e+00,  -4.26983281e-01,
         -1.51187139e-02,   3.60796144e-04,  -2.70526318e-01,
          1.56524133e+00,   3.12795835e-02,  -1.06542818e+00,
          6.73110152e-05,  -2.27458840e-04,  -8.10442727e-02,
          2.82896267e-03,  -1.30207552e-02],
       [ -1.19968208e-03,  -1.51739839e-01,  -2.30058977e-01,
         -1.75340571e-01,  -3.78463185e-05,   9.52851812e-02,
          7.62514112e-02,   8.32986027e-02,   2.08788085e-01,
          3.92896936e-01,  -4.00329345e-04,   6.62404396e-01,
          4.48197112e-01,  -7.41148592e-01,   2.58761857e-01,
          2.14772665e-04,  -9.87818151e-05,  -3.51162853e-01,
          5.17412212e-01,   4.37760371e-01],
       [  4.62354273e-03,  -6.93623347e-02,  -2.00608098e-01,
         -1.52749703e-01,  -1.01675447e-04,   9.74455029e-01,
          1.10840056e+00,   1.20482455e+00,   2.01534046e-01,
          3.80781938e-01,   1.19477318e-05,  -2.66948303e-01,
         -8.10168495e-01,   1.33993077e+00,  -1.06474383e+00,
          1.67570555e-04,   1.27364661e-04,  -8.15031988e-02,
          1.08268086e-02,   8.09810675e-03]])
    ref_result_dm_beta = array([[  1.02852303e+00,  -4.01105025e-02,  -3.69892525e-05,
          2.08296739e-05,   9.81200026e-06,  -9.31293838e-02,
         -3.55588417e-05,   2.07104693e-05,   6.25624205e-06,
          5.61265948e-03,   2.05117699e-06,   3.15482505e-06,
         -3.86383252e-06,  -8.27554125e-06,  -3.08871634e-02,
         -9.02835407e-03,  -3.10016340e-02,  -8.90989560e-03,
         -3.09306830e-02,  -8.99179734e-03],
       [ -4.01105025e-02,   1.45464024e-01,   3.35962857e-05,
         -1.80334430e-06,  -1.90003407e-05,   1.38272795e-01,
          5.19659344e-05,  -2.13067164e-05,  -1.22577814e-05,
         -1.20950033e-02,  -1.25777529e-06,  -5.82681921e-06,
          7.49633981e-06,   1.62972346e-05,   5.74793157e-02,
          2.65502855e-02,   5.77706556e-02,   2.63740951e-02,
          5.75797712e-02,   2.64928556e-02],
       [ -3.69892525e-05,   3.35962857e-05,   1.84357148e-01,
          4.30921236e-05,   4.59709987e-06,   1.13636563e-04,
          7.94596680e-02,   1.27005888e-04,  -2.74209549e-05,
         -1.35222455e-06,  -2.91590508e-05,   5.79120319e-06,
          8.51998639e-03,   1.49253515e-05,   1.23972792e-01,
          1.08420794e-01,  -6.22860676e-02,  -5.41012502e-02,
         -6.21293848e-02,  -5.41079918e-02],
       [  2.08296739e-05,  -1.80334430e-06,   4.30921236e-05,
          1.84210767e-01,  -1.76041026e-05,  -6.58373043e-05,
         -3.86665525e-05,   7.94009093e-02,  -1.69161542e-05,
         -8.40537792e-06,   5.20764616e-06,  -5.19007201e-06,
         -9.65798042e-06,  -8.53024750e-03,   4.77557390e-05,
          7.62966371e-05,   1.07831803e-01,   9.34654560e-02,
         -1.07517289e-01,  -9.37479654e-02],
       [  9.81200026e-06,  -1.90003407e-05,   4.59709987e-06,
         -1.76041026e-05,   4.29981605e-09,  -1.83002000e-05,
          1.98192559e-06,  -7.58253030e-06,   2.54578954e-09,
          1.59093086e-06,  -1.05421675e-09,   1.40880309e-09,
          2.12787647e-07,   8.13485158e-07,  -4.48329850e-06,
         -7.74481938e-07,  -1.94759539e-05,  -1.37368322e-05,
          1.13445475e-06,   4.13974288e-06],
       [ -9.31293838e-02,   1.38272795e-01,   1.13636563e-04,
         -6.58373043e-05,  -1.83002000e-05,   1.34410408e-01,
          8.51321206e-05,  -4.81735831e-05,  -1.18134250e-05,
         -1.16201853e-02,  -1.30219873e-06,  -5.61815348e-06,
          1.09333822e-05,   1.86218001e-05,   5.55045669e-02,
          2.53771745e-02,   5.56654175e-02,   2.51032400e-02,
          5.55567472e-02,   2.52828540e-02],
       [ -3.55588417e-05,   5.19659344e-05,   7.94596680e-02,
         -3.86665525e-05,   1.98192559e-06,   8.51321206e-05,
          3.42478932e-02,   3.00632109e-05,  -1.18166193e-05,
         -3.71776558e-06,  -1.25697842e-05,   2.49616034e-06,
          3.67219958e-03,   9.08776858e-06,   5.34483788e-02,
          4.67372200e-02,  -2.68643653e-02,  -2.33403808e-02,
         -2.67299683e-02,  -2.32850834e-02],
       [  2.07104693e-05,  -2.13067164e-05,   1.27005888e-04,
          7.94009093e-02,  -7.58253030e-06,  -4.81735831e-05,
          3.00632109e-05,   3.42244744e-02,  -7.30579725e-06,
         -1.90154447e-06,   2.22770320e-06,  -2.23285258e-06,
          8.47378530e-07,  -3.67681005e-03,   8.52937427e-05,
          9.28972963e-05,   4.64341572e-02,   4.02511203e-02,
         -4.63882464e-02,  -4.04440268e-02],
       [  6.25624205e-06,  -1.22577814e-05,  -2.74209549e-05,
         -1.69161542e-05,   2.54578954e-09,  -1.18134250e-05,
         -1.18166193e-05,  -7.30579725e-06,   6.67101269e-09,
          1.02621110e-06,   3.96869578e-09,   1.10460875e-10,
         -1.26668038e-06,   7.79446403e-07,  -2.33234245e-05,
         -1.83705309e-05,  -5.54541297e-06,  -2.76112746e-06,
          1.42157724e-05,   1.44153223e-05],
       [  5.61265948e-03,  -1.20950033e-02,  -1.35222455e-06,
         -8.40537792e-06,   1.59093086e-06,  -1.16201853e-02,
         -3.71776558e-06,  -1.90154447e-06,   1.02621110e-06,
          1.01077073e-03,   1.07915073e-07,   4.88241864e-07,
         -5.57307720e-07,  -9.65126323e-07,  -4.81192621e-03,
         -2.21053612e-03,  -4.84278037e-03,  -2.20141742e-03,
         -4.81681139e-03,  -2.20266079e-03],
       [  2.05117699e-06,  -1.25777529e-06,  -2.91590508e-05,
          5.20764616e-06,  -1.05421675e-09,  -1.30219873e-06,
         -1.25697842e-05,   2.22770320e-06,   3.96869578e-09,
          1.07915073e-07,   4.77320063e-09,  -1.01016075e-09,
         -1.34795480e-06,  -2.43971178e-07,  -2.01275351e-05,
         -1.73782974e-05,   1.23816487e-05,   1.09731392e-05,
          6.26270194e-06,   5.67369284e-06],
       [  3.15482505e-06,  -5.82681921e-06,   5.79120319e-06,
         -5.19007201e-06,   1.40880309e-09,  -5.61815348e-06,
          2.49616034e-06,  -2.23285258e-06,   1.10460875e-10,
          4.88241864e-07,  -1.01016075e-09,   5.64075708e-10,
          2.67727364e-07,   2.40214504e-07,   1.56898111e-06,
          2.33887721e-06,  -7.33394383e-06,  -5.39349466e-06,
         -1.25225726e-06,  -1.22387510e-07],
       [ -3.86383252e-06,   7.49633981e-06,   8.51998639e-03,
         -9.65798042e-06,   2.12787647e-07,   1.09333822e-05,
          3.67219958e-03,   8.47378530e-07,  -1.26668038e-06,
         -5.57307720e-07,  -1.34795480e-06,   2.67727364e-07,
          3.93748491e-04,   1.22988447e-06,   5.73170337e-03,
          5.01170205e-03,  -2.88297543e-03,  -2.50509867e-03,
         -2.86212366e-03,  -2.49356608e-03],
       [ -8.27554125e-06,   1.62972346e-05,   1.49253515e-05,
         -8.53024750e-03,   8.13485158e-07,   1.86218001e-05,
          9.08776858e-06,  -3.67681005e-03,   7.79446403e-07,
         -9.65126323e-07,  -2.43971178e-07,   2.40214504e-07,
          1.22988447e-06,   3.95013516e-04,   1.56120640e-05,
          9.37939913e-06,  -4.99260462e-03,  -4.33012722e-03,
          4.97956257e-03,   4.33918070e-03],
       [ -3.08871634e-02,   5.74793157e-02,   1.23972792e-01,
          4.77557390e-05,  -4.48329850e-06,   5.55045669e-02,
          5.34483788e-02,   8.52937427e-05,  -2.33234245e-05,
         -4.81192621e-03,  -2.01275351e-05,   1.56898111e-06,
          5.73170337e-03,   1.56120640e-05,   1.06283224e-01,
          8.34128779e-02,  -1.88274055e-02,  -2.59252083e-02,
         -1.88208613e-02,  -2.59022227e-02],
       [ -9.02835407e-03,   2.65502855e-02,   1.08420794e-01,
          7.62966371e-05,  -7.74481938e-07,   2.53771745e-02,
          4.67372200e-02,   9.28972963e-05,  -1.83705309e-05,
         -2.21053612e-03,  -1.73782974e-05,   2.33887721e-06,
          5.01170205e-03,   9.37939913e-06,   8.34128779e-02,
          6.86040856e-02,  -2.60368466e-02,  -2.69762221e-02,
         -2.60395442e-02,  -2.70105994e-02],
       [ -3.10016340e-02,   5.77706556e-02,  -6.22860676e-02,
          1.07831803e-01,  -1.94759539e-05,   5.56654175e-02,
         -2.68643653e-02,   4.64341572e-02,  -5.54541297e-06,
         -4.84278037e-03,   1.23816487e-05,  -7.33394383e-06,
         -2.88297543e-03,  -4.99260462e-03,  -1.88274055e-02,
         -2.60368466e-02,   1.07359659e-01,   8.35107442e-02,
         -1.88469303e-02,  -2.60443842e-02],
       [ -8.90989560e-03,   2.63740951e-02,  -5.41012502e-02,
          9.34654560e-02,  -1.37368322e-05,   2.51032400e-02,
         -2.33403808e-02,   4.02511203e-02,  -2.76112746e-06,
         -2.20141742e-03,   1.09731392e-05,  -5.39349466e-06,
         -2.50509867e-03,  -4.33012722e-03,  -2.59252083e-02,
         -2.69762221e-02,   8.35107442e-02,   6.81006305e-02,
         -2.58496449e-02,  -2.68779459e-02],
       [ -3.09306830e-02,   5.75797712e-02,  -6.21293848e-02,
         -1.07517289e-01,   1.13445475e-06,   5.55567472e-02,
         -2.67299683e-02,  -4.63882464e-02,   1.42157724e-05,
         -4.81681139e-03,   6.26270194e-06,  -1.25225726e-06,
         -2.86212366e-03,   4.97956257e-03,  -1.88208613e-02,
         -2.60395442e-02,  -1.88469303e-02,  -2.58496449e-02,
          1.06697897e-01,   8.34544158e-02],
       [ -8.99179734e-03,   2.64928556e-02,  -5.41079918e-02,
         -9.37479654e-02,   4.13974288e-06,   2.52828540e-02,
         -2.32850834e-02,  -4.04440268e-02,   1.44153223e-05,
         -2.20266079e-03,   5.67369284e-06,  -1.22387510e-07,
         -2.49356608e-03,   4.33918070e-03,  -2.59022227e-02,
         -2.70105994e-02,  -2.60443842e-02,  -2.68779459e-02,
          8.34544158e-02,   6.84085992e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_numgga.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
