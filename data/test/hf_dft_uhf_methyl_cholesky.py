# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_energy = -39.554863031594934
    ref_result_exp_alpha = array([[  1.00211388e+00,  -1.86805040e-02,   1.46611215e-15,
          6.98466046e-10,   9.02749400e-16,  -7.17444336e-02,
          2.09873453e-08,  -6.97212317e-15,   1.86249314e-14,
         -3.38855293e-08,   6.17519715e-02,   1.25964807e-14,
          1.45924050e-07,  -6.31015719e-14,  -8.27594200e-01,
          8.66163342e-18,   7.09510326e-17,  -1.22639218e-15,
          5.58837758e-07,   2.52911469e-14,  -3.23282711e-01,
          3.56768090e-17,  -2.94240203e-18,   7.56808364e-18,
         -2.87973918e-15,   5.89160407e-08,   2.87030013e-01,
          5.19471320e-07,   2.16200386e-14],
       [  4.81947429e-03,   4.03940809e-01,   2.12036772e-15,
          4.17887506e-08,   1.90866188e-15,   1.30920187e-01,
         -1.20360674e-09,   4.20704432e-14,   3.90805267e-14,
          1.02627496e-08,  -1.02200393e-02,  -1.18473969e-15,
          2.90638922e-07,  -1.34535826e-13,  -1.86234495e+00,
          2.39359404e-17,   1.49100151e-16,  -3.03993216e-15,
          1.13829262e-06,   4.61629270e-14,  -6.34229959e-01,
          3.12527268e-17,  -4.95595652e-18,   1.76025030e-17,
         -5.38534152e-15,   2.67811992e-07,   8.86828696e-01,
          1.28040005e-06,   7.40150038e-14],
       [ -6.43060065e-03,   3.67860832e-01,  -1.18671929e-14,
          9.77327015e-08,  -5.11565786e-15,   1.96808495e+00,
         -7.88874075e-07,   5.44352995e-13,  -6.97089765e-14,
         -2.92780149e-07,  -1.43869048e-01,  -3.07865572e-14,
         -2.79328936e-07,   2.00091151e-13,   3.77827501e+00,
         -2.43747133e-17,  -3.00073639e-16,   3.18112550e-15,
         -2.02375792e-06,  -1.07047175e-13,   1.30875402e+00,
         -2.29266655e-16,   2.27976901e-18,  -3.49132174e-17,
          1.63951271e-14,   5.93699910e-07,   1.84265489e+00,
          1.49634749e-06,   2.23348284e-13],
       [ -2.70837518e-10,  -4.64448262e-08,  -5.06915647e-09,
          4.35400424e-01,   5.09253076e-17,   8.22646974e-08,
          3.10505436e-01,  -1.44053476e-07,  -1.74533484e-09,
         -2.96028777e-01,  -3.99049450e-07,  -7.45745911e-16,
          8.79426039e-01,  -1.72044255e-07,   7.47334813e-08,
         -5.50472696e-16,  -7.17146811e-17,   1.09538978e-15,
          9.46793698e-02,   8.84684133e-10,   1.06973514e-07,
          3.29626790e-17,   4.08819258e-17,   2.46343460e-17,
          4.80843445e-09,   5.18950263e-01,   3.61052332e-07,
         -1.11820602e+00,  -4.92487396e-09],
       [  5.09847379e-17,  -1.72569022e-16,  -4.35400446e-01,
         -5.06915734e-09,   7.11100686e-16,  -2.78380456e-14,
          1.44053443e-07,   3.10505424e-01,  -2.96028819e-01,
          1.74533586e-09,   2.84996326e-14,  -9.18476679e-16,
          1.72044251e-07,   8.79425951e-01,  -4.69024112e-14,
          3.28210194e-16,  -3.40413222e-16,  -1.27259763e-07,
          8.84681413e-10,  -9.46792724e-02,  -2.00700407e-14,
          4.20586041e-16,  -1.17078061e-16,  -6.12376414e-16,
          5.18949830e-01,  -4.80844147e-09,  -1.09218783e-13,
         -4.92487887e-09,   1.11820667e+00],
       [ -1.54007513e-17,   2.99409746e-16,   1.40134350e-16,
          2.05942738e-16,   6.11538805e-01,   7.62728899e-17,
         -1.33395131e-16,   2.63589994e-16,  -1.36261329e-15,
         -6.11508329e-16,  -1.95994429e-13,   9.97611821e-01,
          3.79442906e-16,   3.95930305e-16,   1.03722593e-15,
         -6.95017500e-08,   7.33054499e-16,  -2.14118049e-16,
         -5.13124909e-18,   1.26436654e-16,   7.53667453e-16,
          1.92364708e-01,   1.35593925e-14,   1.77525207e-07,
         -3.23974810e-16,  -3.24945299e-17,   3.45703389e-16,
          2.87954010e-17,   1.73601912e-16],
       [  3.86748228e-10,   8.19274597e-10,  -2.50835707e-09,
          2.15447762e-01,  -4.96405369e-16,   1.61570391e-07,
          1.37338849e+00,  -6.37159094e-07,   7.47576527e-09,
          1.26797529e+00,   1.64249782e-06,   1.60550301e-15,
         -1.70373234e+00,   3.33305331e-07,  -5.02681461e-07,
          8.25784830e-16,   7.73431949e-16,  -2.32318775e-15,
         -1.12508356e+00,  -1.05127483e-08,  -2.35192065e-06,
          1.99472350e-16,  -1.02094097e-16,  -2.13801272e-16,
          5.99844025e-09,   6.47381259e-01,   2.83959065e-07,
         -7.39151276e-01,  -3.25540414e-09],
       [ -6.40653730e-16,  -3.51847847e-15,  -2.15447747e-01,
         -2.50835679e-09,   1.33843786e-16,  -2.10642034e-13,
          6.37159145e-07,   1.37338849e+00,   1.26797528e+00,
         -7.47576783e-09,  -7.03777567e-14,   1.77959246e-15,
         -3.33305268e-07,  -1.70373221e+00,   9.41208343e-14,
         -9.32829993e-16,   5.05523362e-16,   1.13994900e-06,
         -1.05127367e-08,   1.12508345e+00,   1.21490872e-13,
          1.05670841e-16,   9.02484714e-16,  -8.80026018e-16,
          6.47380638e-01,  -5.99844705e-09,  -4.86323726e-14,
         -3.25542363e-09,   7.39151604e-01],
       [  5.49702698e-18,  -1.41100562e-16,   1.39702200e-15,
          4.18292729e-16,   5.14104093e-01,  -5.26074179e-16,
          5.99412003e-17,  -2.87147089e-16,   1.49771879e-15,
          7.48768508e-16,   2.12595092e-13,  -1.08201745e+00,
         -6.63452705e-16,  -4.45526476e-16,   1.21636026e-16,
          2.96526984e-08,  -2.18825174e-16,   1.09753770e-16,
          1.93588016e-16,  -2.90547432e-16,   2.96726303e-17,
          4.29171640e-01,   1.16905544e-14,   1.80522207e-07,
          3.04707717e-16,  -1.22402614e-16,   3.00998369e-16,
         -5.05202161e-17,  -3.05303397e-16],
       [  5.00112759e-05,   1.71872587e-02,   1.05927117e-15,
          2.02618464e-09,   1.09135806e-15,  -3.27836347e-03,
          2.29401837e-08,  -4.27275718e-15,  -4.08371010e-15,
          1.93817736e-07,  -2.77224603e-01,  -5.41191733e-14,
         -1.30605309e-07,   2.52363937e-14,   3.46105257e-03,
         -1.70593776e-17,   1.01246732e-18,   2.25767997e-15,
          1.80716395e-06,   1.26977350e-13,  -1.00885258e+00,
          2.73014160e-16,  -1.14278422e-17,   2.99036845e-17,
         -2.86216744e-15,  -3.31751475e-07,  -8.91379245e-01,
         -7.48658844e-07,  -9.47881927e-14],
       [  1.37829890e-19,   1.01268785e-17,  -2.64464555e-17,
         -9.18296476e-17,  -3.85244014e-09,   7.63606641e-18,
         -2.10229037e-16,   8.19744364e-17,   2.49699337e-17,
         -3.55109599e-16,   5.15908541e-18,   3.66423007e-09,
         -3.77239963e-16,   1.55375702e-16,  -1.08161783e-17,
         -6.53632226e-01,   3.17469032e-10,   3.43015887e-16,
         -3.28188400e-17,  -9.25612559e-17,  -1.57648580e-17,
          2.49847021e-07,  -8.06302984e-08,  -9.53229425e-01,
         -4.13218416e-16,   9.45074515e-17,  -3.10699933e-18,
          3.59721992e-17,  -5.07257675e-16],
       [  3.24615032e-20,  -2.36930490e-18,   3.33788347e-16,
          2.59799957e-18,   1.16226473e-16,   3.31423878e-19,
          3.58219621e-16,  -1.43866930e-16,  -8.46987145e-18,
         -2.54561995e-17,   4.10397760e-17,   4.16333634e-17,
         -1.68832655e-16,   1.87143477e-16,  -4.38449253e-17,
         -3.17470009e-10,  -6.53632233e-01,   2.85407492e-16,
         -1.88765047e-16,  -2.97779291e-17,  -2.73928331e-17,
          7.54951657e-15,   9.53229472e-01,  -8.06303019e-08,
          2.55616782e-17,   2.43365260e-17,   5.05869831e-18,
          3.09049938e-18,  -1.03767944e-16],
       [  3.21103484e-11,  -1.61720928e-09,  -2.64068021e-10,
          2.26813549e-02,   8.85348430e-17,  -1.09098509e-09,
          1.88989766e-02,  -8.76784111e-09,  -8.48917645e-10,
         -1.43986466e-01,  -5.38501410e-08,   3.04431173e-17,
         -2.92960972e-01,   5.73126728e-08,  -5.99360006e-08,
          4.79586368e-16,   1.66773294e-16,   7.34429188e-16,
         -5.38437775e-01,  -5.03114188e-09,  -1.09125274e-06,
          9.20761884e-17,   5.19523789e-18,  -2.18203356e-16,
         -5.19959652e-09,  -5.61163990e-01,   1.71571782e-06,
         -1.51408298e+00,  -6.66841810e-09],
       [  3.10352872e-17,   5.12610787e-16,   2.26813653e-02,
          2.64068627e-10,  -2.43885849e-16,   8.76382300e-15,
         -8.76785301e-09,  -1.88989929e-02,   1.43986412e-01,
         -8.48918972e-10,  -5.78009862e-15,   5.62433114e-16,
          5.73126950e-08,   2.92961128e-01,   6.68909372e-15,
          4.32117563e-17,   8.36434061e-17,  -5.75361579e-07,
          5.03114148e-09,  -5.38437759e-01,  -4.65790601e-14,
         -1.84529388e-16,  -3.32216165e-18,   9.21615067e-16,
          5.61164427e-01,  -5.19958342e-09,   1.42236917e-13,
          6.66841320e-09,  -1.51408298e+00],
       [ -2.59067215e-04,   1.74048193e-01,  -4.07641183e-09,
          3.50131614e-01,   5.27128222e-16,  -6.59595160e-02,
         -3.93452253e-02,   1.82535177e-08,  -4.73339104e-09,
         -8.02842372e-01,   6.74399772e-01,   1.32338780e-13,
         -3.85257688e-01,   7.53688846e-08,  -6.50269492e-02,
          8.78675987e-17,   1.41025392e-16,   3.30660383e-15,
          7.17591662e-01,   6.70520318e-09,  -4.96520699e-01,
         -2.07185791e-17,  -7.73745398e-17,   3.19596284e-16,
         -3.40730391e-10,  -3.67743422e-02,  -7.44081686e-01,
          1.24034520e+00,   5.46272895e-09],
       [  1.18454657e-03,   1.88783658e-02,  -1.51634571e-09,
          1.30242545e-01,   1.01587174e-15,  -9.60810675e-01,
         -1.98044193e+00,   9.18790617e-07,   3.16684952e-12,
          5.38027467e-04,  -3.94938832e-01,  -7.78143714e-14,
          1.62142488e+00,  -3.17203353e-07,  -8.85017977e-01,
         -6.54917963e-16,  -9.56748845e-16,  -3.12326774e-15,
          2.70239399e-01,   2.52511200e-09,  -9.22130967e-02,
         -4.86970500e-17,   1.66696711e-16,  -1.76141790e-16,
         -5.90784487e-09,  -6.37603400e-01,  -4.08891135e-01,
          4.74962489e-01,   2.09180114e-09],
       [  5.66507805e-04,  -2.62927403e-02,   2.72907048e-10,
         -2.34406282e-02,  -5.76197468e-16,   1.33251194e-02,
          2.48604924e-02,  -1.15335836e-08,   2.68358818e-11,
          4.55177127e-03,   9.68978471e-02,   1.91052487e-14,
         -2.64636970e-01,   5.17715840e-08,   1.61273727e-01,
         -6.80549412e-17,   2.82308965e-17,   3.42622369e-15,
          2.46958362e-01,   2.30758010e-09,  -1.35524256e-01,
         -3.96853407e-17,  -4.34911985e-17,   1.29827702e-16,
          5.34649795e-09,   5.77020986e-01,   9.27449144e-01,
         -1.17935503e+00,  -5.19409743e-09],
       [  6.06206017e-17,   1.57434237e-16,  -9.73388736e-03,
         -1.13326904e-10,   5.03800904e-17,   1.38122969e-15,
          2.44971182e-09,   5.28032904e-03,   7.80023617e-02,
         -4.59888925e-10,  -2.16366038e-15,  -8.26583753e-16,
          9.77640307e-09,   4.99733076e-02,   7.01792426e-15,
         -2.52910043e-17,  -3.67245504e-16,  -5.87929345e-01,
          5.10713818e-09,  -5.46570468e-01,  -5.82880925e-14,
         -3.59713840e-16,  -2.69146117e-16,  -2.97505059e-16,
         -7.88703457e-01,   7.30789725e-09,  -4.56524357e-14,
         -1.83187447e-09,   4.15933364e-01],
       [  5.82960640e-19,   1.01152956e-18,  -3.74015140e-17,
          1.86093264e-17,   1.75544185e-02,  -1.47079598e-17,
         -4.63570471e-17,   7.39534554e-17,  -2.19646570e-16,
         -8.64715216e-17,  -7.34776504e-15,   3.75087842e-02,
         -1.03312382e-16,   2.20365191e-16,   6.51782066e-17,
         -4.06966862e-01,   1.97663891e-10,  -3.14479191e-16,
         -6.48622353e-16,   5.84533169e-16,  -1.18199906e-16,
         -6.53437169e-01,   7.22785920e-08,   8.54493630e-01,
          4.05723452e-16,  -1.19131333e-16,  -1.51033226e-18,
         -8.51339807e-18,   5.33848447e-16],
       [ -2.59067370e-04,   1.74048276e-01,  -3.03222880e-01,
         -1.75065807e-01,   8.86900886e-16,  -6.59594577e-02,
          1.96725425e-02,  -3.40739558e-02,  -6.95281371e-01,
          4.01420434e-01,   6.74400518e-01,   1.32361021e-13,
          1.92628957e-01,  -3.33643065e-01,  -6.50269424e-02,
         -9.14059364e-17,  -3.20747565e-16,  -6.17097869e-07,
         -3.58794565e-01,  -6.21451874e-01,  -4.96522928e-01,
          1.42567520e-16,  -2.87629150e-17,   4.87688307e-16,
         -3.18468447e-02,   1.83869054e-02,  -7.44080455e-01,
         -6.20173753e-01,  -1.07417165e+00],
       [  1.18454720e-03,   1.88783745e-02,  -1.12793339e-01,
         -6.51212574e-02,   9.82821341e-16,  -9.60810355e-01,
          9.90220699e-01,  -1.71511400e+00,   4.65536623e-04,
         -2.68324188e-04,  -3.94937758e-01,  -7.63982576e-14,
         -8.10712205e-01,   1.40419542e+00,  -8.85018690e-01,
          8.14151276e-16,   6.14911797e-16,  -2.98703497e-07,
         -1.35119574e-01,  -2.34034102e-01,  -9.22140891e-02,
         -5.26133892e-17,  -4.51392791e-16,   5.97964128e-16,
         -5.52180417e-01,   3.18801460e-01,  -4.08890991e-01,
         -2.37481761e-01,  -4.11330103e-01],
       [ -2.83253888e-04,   1.31463738e-02,  -1.43649885e-02,
          1.44025798e-03,   3.38622207e-16,  -6.66255536e-03,
          1.01753725e-02,  -8.47847703e-03,   3.18050028e-02,
          5.96397650e-02,  -4.84488551e-02,  -9.11498250e-15,
         -2.86792644e-02,   1.36230325e-01,  -8.06369054e-02,
         -4.13645556e-16,   1.84323720e-17,   5.09161147e-01,
          4.71667554e-01,  -1.29736658e-01,   6.77632087e-02,
         -1.13982118e-16,  -1.64533061e-16,   5.84172400e-16,
         -5.91375779e-01,  -4.47272632e-01,  -4.63723552e-01,
         -6.06789774e-01,  -3.30571951e-01],
       [  4.90610080e-04,  -2.27701866e-02,   1.51469936e-02,
          1.43649866e-02,  -3.50188718e-16,   1.15398944e-02,
         -8.47846571e-03,   1.99654683e-02,   2.29144388e-02,
          3.18049742e-02,   8.39159876e-02,   1.66506650e-14,
          1.36230254e-01,  -1.85984458e-01,   1.39667213e-01,
         -3.50008481e-16,  -2.48501901e-16,   2.93964225e-01,
          1.29736397e-01,  -3.21861653e-01,  -1.17367612e-01,
         -2.52731740e-17,  -3.75527095e-17,  -4.16900341e-16,
          2.35589253e-01,  -5.91375631e-01,   8.03193880e-01,
          3.30572116e-01,   9.88500466e-01],
       [  7.70532692e-19,   7.20735524e-18,  -1.06740181e-16,
          1.54489208e-18,   1.75544215e-02,  -7.46676293e-18,
          1.33100829e-16,   5.00288354e-17,  -1.95926371e-17,
          9.40430186e-19,  -7.32766167e-15,   3.75088248e-02,
          1.28325571e-16,   6.99175997e-17,   4.38826862e-17,
          2.03483420e-01,  -3.52443616e-01,   4.37802181e-16,
          6.01933094e-17,   3.58943080e-16,  -1.54768656e-16,
         -6.53436741e-01,  -7.40013530e-01,  -4.27247194e-01,
          2.72282334e-16,   4.07158057e-17,  -1.19606676e-17,
         -1.50100556e-18,  -2.79324682e-16],
       [ -2.59067370e-04,   1.74048276e-01,   3.03222884e-01,
         -1.75065800e-01,   4.11213811e-16,  -6.59594577e-02,
          1.96725741e-02,   3.40739376e-02,   6.95281375e-01,
          4.01420426e-01,   6.74400518e-01,   1.33286480e-13,
          1.92629087e-01,   3.33642990e-01,  -6.50269424e-02,
          3.13173963e-17,   4.07621630e-16,   6.17097870e-07,
         -3.58794577e-01,   6.21451868e-01,  -4.96522928e-01,
          3.07580303e-16,   1.36737544e-16,  -7.77295393e-16,
          3.18468450e-02,   1.83869048e-02,  -7.44080455e-01,
         -6.20173763e-01,   1.07417165e+00],
       [  1.18454720e-03,   1.88783745e-02,   1.12793341e-01,
         -6.51212547e-02,   7.52497202e-16,  -9.60810355e-01,
          9.90222290e-01,   1.71511308e+00,  -4.65536626e-04,
         -2.68324183e-04,  -3.94937758e-01,  -7.66306808e-14,
         -8.10712754e-01,  -1.40419511e+00,  -8.85018690e-01,
         -1.48075538e-16,   4.48866119e-16,   2.98703496e-07,
         -1.35119578e-01,   2.34034100e-01,  -9.22140891e-02,
          9.86868076e-17,   2.86677064e-16,  -4.19675615e-16,
          5.52180423e-01,   3.18801449e-01,  -4.08890991e-01,
         -2.37481765e-01,   4.11330101e-01],
       [ -2.83253888e-04,   1.31463738e-02,   1.43649884e-02,
          1.44025832e-03,   4.01718721e-16,  -6.66255536e-03,
          1.01753804e-02,   8.47846759e-03,  -3.18050021e-02,
          5.96397653e-02,  -4.84488551e-02,  -9.73451707e-15,
         -2.86793177e-02,  -1.36230314e-01,  -8.06369054e-02,
         -1.72361940e-16,  -1.53425939e-16,  -5.09161147e-01,
          4.71667552e-01,   1.29736666e-01,   6.77632087e-02,
         -9.31422457e-17,   1.77530024e-16,  -4.51883850e-16,
          5.91375771e-01,  -4.47272643e-01,  -4.63723552e-01,
         -6.06789776e-01,   3.30571946e-01],
       [ -4.90610080e-04,   2.27701866e-02,   1.51469940e-02,
         -1.43649863e-02,   6.76285698e-16,  -1.15398944e-02,
          8.47848423e-03,   1.99654604e-02,   2.29144384e-02,
         -3.18049745e-02,  -8.39159876e-02,  -1.63179390e-14,
         -1.36230326e-01,  -1.85984404e-01,  -1.39667213e-01,
         -1.04904664e-16,  -1.66481409e-16,   2.93964225e-01,
         -1.29736391e-01,  -3.21861655e-01,   1.17367612e-01,
         -3.63708662e-18,  -9.52911651e-17,  -3.25495768e-16,
          2.35589264e-01,   5.91375627e-01,  -8.03193880e-01,
         -3.30572125e-01,   9.88500463e-01],
       [  3.39194599e-19,  -2.71537050e-17,  -9.33588191e-17,
          2.63175966e-17,   1.75544215e-02,   1.62400697e-17,
         -3.88111569e-17,   3.82271799e-17,  -5.26755393e-17,
          2.15843897e-17,  -7.41153624e-15,   3.75088248e-02,
          1.09994316e-16,  -1.91783747e-17,   8.53506100e-17,
          2.03483420e-01,   3.52443616e-01,   3.02909100e-16,
          1.97579717e-16,  -3.87012172e-16,  -1.44322698e-16,
         -6.53436741e-01,   7.40013458e-01,  -4.27247319e-01,
         -3.25099784e-16,   9.80797297e-17,  -1.64601770e-17,
          3.04406287e-18,  -2.64842658e-16]])
    ref_result_exp_beta = array([[  1.00123452e+00,  -2.18447338e-02,   1.46924877e-15,
         -8.75332877e-10,   1.30334598e-15,  -8.75430646e-02,
          2.11817799e-08,  -1.17996986e-14,  -1.37466878e-14,
          1.26820208e-08,  -5.36454009e-02,  -1.68162944e-15,
          1.15008947e-07,  -5.23514656e-14,   8.26365809e-01,
          6.67870172e-16,   5.13213650e-17,   3.61694433e-15,
         -1.72115068e-07,   1.78610965e-15,   3.23305661e-01,
         -2.24308468e-15,   1.01607714e-16,   2.40101458e-16,
         -2.12191919e-15,   5.91110391e-08,  -2.90612262e-01,
          5.09944008e-07,   1.27593115e-14],
       [  1.54229387e-03,   3.63495432e-01,   1.29446840e-15,
          4.12978997e-08,  -6.55271387e-15,   1.14359386e-01,
          9.82858688e-09,   3.27225379e-14,  -3.01255864e-14,
         -4.53058716e-08,   7.45306048e-02,  -3.00189850e-15,
          2.00165089e-07,  -1.05979538e-13,   1.85570380e+00,
          1.53800729e-15,   1.20545858e-16,   8.38116507e-15,
         -4.02230197e-07,   5.55613805e-15,   6.64585383e-01,
         -3.96465682e-15,   2.98341379e-16,   7.29540069e-16,
         -3.07035442e-15,   2.70788814e-07,  -8.95211111e-01,
          1.24837451e-06,   4.66718543e-14],
       [ -5.41057993e-03,   2.83972776e-01,  -1.27420119e-14,
          8.22489743e-08,  -5.60263659e-14,   2.05501096e+00,
         -7.44927244e-07,   5.81953512e-13,   5.33216600e-14,
          3.05575622e-07,   2.03920747e-01,   8.78976346e-15,
         -1.39108537e-07,   1.53685384e-13,  -3.77298807e+00,
         -2.82477510e-15,  -1.73111256e-16,  -1.29975274e-14,
          3.98181571e-07,  -6.66808727e-15,  -1.22218948e+00,
          8.69821058e-15,  -3.08636376e-16,  -7.49963536e-16,
          1.99826115e-14,   6.00160899e-07,  -1.82715249e+00,
          1.38437640e-06,   1.61541633e-13],
       [ -1.38816521e-10,  -6.67469277e-08,  -1.06511944e-08,
          3.95093003e-01,   5.45717120e-16,   7.72357810e-08,
          3.06247160e-01,  -1.50600155e-07,   1.93175033e-09,
          2.58695062e-01,   3.77552164e-07,  -1.79951300e-15,
          8.97544771e-01,  -1.69090619e-07,  -3.38958117e-08,
          1.43158578e-15,  -1.57957845e-16,  -5.77522353e-16,
         -9.95192495e-02,  -8.79512398e-10,   6.85773721e-09,
          2.65253805e-17,  -1.00765830e-16,   8.26337501e-17,
          5.60476746e-09,   5.32847928e-01,  -3.01238309e-07,
         -1.12224866e+00,  -3.33710869e-10],
       [  7.58514790e-17,  -9.85055119e-17,  -3.95093034e-01,
         -1.06511956e-08,  -9.96979872e-17,  -2.94895218e-14,
          1.50600122e-07,   3.06247149e-01,   2.58695130e-01,
         -1.93175272e-09,  -2.34248754e-14,  -6.18973891e-16,
          1.69090614e-07,   8.97544677e-01,   4.18014429e-14,
         -1.76680289e-15,  -1.17583967e-15,   1.24540049e-07,
         -8.79509067e-10,   9.95191489e-02,   1.17309978e-14,
         -7.07658284e-17,  -9.11374129e-16,   3.15713564e-16,
          5.32847499e-01,  -5.60477231e-09,   7.99950525e-14,
         -3.33713256e-10,   1.12224931e+00],
       [ -2.31665076e-17,  -3.07641010e-16,  -2.87890061e-17,
         -1.19025657e-16,   3.67120201e-01,   1.04489646e-14,
         -2.13446632e-16,   1.92052366e-16,   8.55258777e-16,
          3.27799179e-16,  -2.77957189e-15,   1.10549039e+00,
          2.42204943e-15,   1.85706019e-16,   2.19367599e-15,
          8.75390209e-08,  -1.04685886e-15,  -4.06120656e-16,
         -8.70204087e-18,  -2.95997851e-16,   3.08823575e-15,
          2.22096790e-01,  -2.45808783e-14,  -1.84601339e-07,
         -1.85057456e-16,   4.13727368e-16,  -1.03150830e-16,
          3.07478646e-16,   2.37334418e-17],
       [  3.20684432e-10,   8.71545869e-10,  -4.68198213e-09,
          1.73672282e-01,   1.73079611e-15,   1.57019033e-07,
          1.40891433e+00,  -6.92847862e-07,  -9.11322079e-09,
         -1.22041869e+00,  -1.41962672e-06,   3.41332285e-15,
         -1.71193974e+00,   3.22516472e-07,   4.38671273e-07,
         -1.72340695e-15,   4.42112861e-16,  -5.70177035e-16,
          1.13461169e+00,   1.00272200e-08,   1.02105188e-06,
         -4.31278282e-16,   5.66125819e-16,  -9.20409881e-16,
          6.72296423e-09,   6.39155177e-01,  -2.46207322e-07,
         -7.36963308e-01,  -2.19130743e-10],
       [ -6.25814307e-16,  -2.40296319e-15,  -1.73672280e-01,
         -4.68198180e-09,   4.84413037e-16,  -2.23741663e-13,
          6.92847910e-07,   1.40891432e+00,  -1.22041873e+00,
          9.11322472e-09,   4.51282219e-14,   1.25174923e-15,
         -3.22516407e-07,  -1.71193958e+00,  -8.01697294e-14,
          3.94836675e-15,   2.28169215e-15,  -1.05503144e-06,
          1.00272066e-08,  -1.13461158e+00,  -3.51888784e-14,
         -3.39454720e-16,   1.19568210e-16,   1.43359404e-16,
          6.39154547e-01,  -6.72297096e-09,   3.27818215e-14,
         -2.19147541e-10,   7.36963635e-01],
       [  8.40465756e-18,   1.83843843e-17,  -2.88799136e-17,
         -2.12948556e-16,   7.37552339e-01,   2.26999059e-14,
         -7.76059766e-16,  -3.54437978e-16,  -3.53741428e-16,
          1.91355462e-16,   2.67823045e-15,  -9.47109865e-01,
         -1.96456357e-15,  -2.90142031e-16,  -1.18304398e-15,
         -4.51899829e-08,   2.98314343e-16,   3.80586273e-17,
          1.35627458e-16,  -5.17747048e-17,   4.71380834e-15,
          4.22199620e-01,  -2.01128314e-14,  -1.67891685e-07,
          9.13838698e-17,   8.03713984e-18,   3.53246679e-17,
         -2.89031946e-16,  -4.79433037e-17],
       [ -1.18138305e-03,  -2.67925676e-02,   1.21590424e-15,
         -4.81027857e-09,   1.39939819e-15,  -3.71572598e-02,
          2.19330420e-08,  -1.06376208e-14,  -8.33440872e-16,
         -1.00254247e-07,   2.11116098e-01,   2.96297562e-16,
         -1.21958794e-07,   2.28996461e-14,  -5.74082921e-03,
          7.39731497e-17,  -1.61533440e-17,   1.05852969e-15,
         -6.11559060e-07,  -3.89662194e-14,   1.01114801e+00,
         -1.24637689e-14,  -4.12389525e-16,  -1.12529111e-15,
         -5.09408412e-15,  -3.48446292e-07,   9.05753236e-01,
         -7.07872962e-07,  -6.78778067e-14],
       [ -4.13076209e-19,  -1.20873030e-17,  -2.21233890e-16,
         -9.24977229e-17,  -4.42037515e-09,  -4.71996967e-16,
         -1.21473685e-16,  -1.06385916e-16,   1.10431664e-16,
          4.86693331e-17,   3.42715835e-18,  -1.03915071e-11,
         -1.00182606e-15,   7.49048823e-16,  -1.23709344e-15,
          6.07388304e-01,  -1.35673133e-09,  -1.87116548e-16,
         -1.85886780e-16,  -2.59041505e-16,   1.03735055e-15,
          2.50151993e-07,   1.34309807e-07,   9.83341687e-01,
         -5.17813625e-16,   1.78303711e-16,  -1.43358299e-17,
         -1.96639284e-16,   9.55542115e-17],
       [  3.54262419e-20,  -4.93626128e-18,   1.18165279e-16,
          2.01344959e-18,   9.10729825e-17,   1.42443341e-16,
          4.58256999e-17,  -1.42040842e-16,  -3.44797249e-16,
         -2.04726266e-16,   5.51486493e-18,  -6.59194921e-17,
          9.70144430e-17,   3.75623510e-16,   2.53881073e-16,
          1.35673223e-09,   6.07388311e-01,   4.56980003e-17,
         -1.56707679e-16,   2.31075993e-16,  -3.91591060e-16,
          6.35602682e-15,  -9.83341732e-01,   1.34309812e-07,
         -7.84446818e-16,  -2.42162275e-17,   6.29530047e-18,
          6.56683095e-18,  -8.01902557e-17],
       [  9.02701227e-11,  -2.28779274e-09,  -5.90583625e-10,
          2.19069713e-02,  -4.94462148e-17,   6.37856987e-10,
          2.41954159e-02,  -1.18983380e-08,   1.06901432e-09,
          1.43159767e-01,   7.63515614e-09,   6.59389496e-16,
         -2.86917194e-01,   5.40530243e-08,   4.60308252e-08,
         -3.61176278e-16,   3.91466480e-16,  -1.87065520e-15,
          5.22086089e-01,   4.61397286e-09,   4.54439666e-07,
         -5.61092194e-17,   1.76710297e-16,  -3.51509864e-16,
         -5.90169909e-09,  -5.61075294e-01,  -1.64625970e-06,
         -1.52099851e+00,  -4.52279679e-10],
       [  4.63496429e-18,   1.19262239e-16,   2.19069822e-02,
          5.90584143e-10,   2.01745863e-17,   8.84708973e-15,
         -1.18983520e-08,  -2.41954353e-02,  -1.43159711e-01,
          1.06901491e-09,   1.61676228e-15,   3.75614220e-16,
          5.40530480e-08,   2.86917355e-01,  -6.09234885e-15,
         -1.10326748e-16,  -4.06054696e-16,   5.13217443e-07,
         -4.61397080e-09,   5.22086066e-01,   7.17741838e-15,
         -3.31473767e-16,  -7.62438532e-16,   3.42534892e-16,
          5.61075734e-01,  -5.90168802e-09,  -1.01200298e-13,
          4.52275474e-10,  -1.52099852e+00],
       [ -2.89553187e-04,   2.10738600e-01,  -1.04090429e-08,
          3.86110733e-01,   1.27887783e-15,  -3.52842859e-02,
         -1.42380376e-02,   7.00170180e-09,   6.09002615e-09,
          8.15562445e-01,  -6.92556694e-01,  -1.23710487e-15,
         -3.48468993e-01,   6.56488966e-08,   9.59279462e-02,
         -8.78199832e-16,  -1.93847209e-16,   1.22527821e-16,
         -7.01141501e-01,  -6.19640135e-09,   4.50776948e-01,
         -5.17006639e-15,  -4.12466412e-16,  -1.94270593e-16,
         -4.19456965e-10,  -3.98787397e-02,   7.45778682e-01,
          1.24210232e+00,   3.69292475e-10],
       [  9.81926225e-04,   4.69272949e-02,  -4.63825268e-09,
          1.72050515e-01,   2.64656529e-14,  -9.88081457e-01,
         -2.00079707e+00,   9.83912080e-07,  -3.96159289e-10,
         -5.30525398e-02,   3.78286947e-01,  -4.58246977e-15,
          1.59170747e+00,  -2.99865651e-07,   8.62945088e-01,
          2.63118102e-15,  -7.12762978e-17,   5.16175533e-15,
         -2.81453810e-01,  -2.48736699e-09,   8.89735297e-02,
          1.02117547e-17,  -1.46683797e-16,   8.17919135e-16,
         -6.67667635e-09,  -6.34754168e-01,   4.05270475e-01,
          4.71192467e-01,   1.40068045e-10],
       [  4.21032873e-04,  -2.44346122e-02,   6.10823248e-10,
         -2.26577769e-02,   1.88749232e-17,   1.40264537e-02,
          2.40258901e-02,  -1.18149741e-08,   1.41172962e-11,
          1.89030523e-03,  -1.07334453e-01,   5.24695077e-16,
         -2.74619676e-01,   5.17362695e-08,  -1.65918176e-01,
         -7.51015409e-16,  -1.23992473e-16,  -2.91348118e-15,
         -2.49011546e-01,  -2.20065787e-09,   1.40799082e-01,
         -2.05264829e-15,  -1.83083574e-16,  -6.00416725e-16,
          6.14503225e-09,   5.84211199e-01,  -9.24731537e-01,
         -1.17312459e+00,  -3.48772151e-10],
       [  6.45970013e-17,   1.20258799e-16,  -1.11283993e-02,
         -3.00007149e-10,  -7.66872668e-17,   5.74847039e-16,
          3.49714621e-09,   7.11149344e-03,  -8.30914537e-02,
          6.20468301e-10,   5.18959132e-16,  -2.58586222e-16,
          9.02109424e-09,   4.78845785e-02,  -8.10374645e-15,
         -3.80736200e-16,  -3.39684536e-17,   5.87929309e-01,
         -4.93834786e-09,   5.58789914e-01,   1.55273570e-14,
          5.42750498e-16,   9.08680375e-16,   7.26589693e-18,
         -7.79939134e-01,   8.20381134e-09,   3.22832500e-14,
         -1.23523545e-10,   4.15420987e-01],
       [  1.08773107e-18,  -3.31200132e-18,  -9.70594000e-17,
          6.60763608e-18,   1.99802434e-02,   1.51255050e-15,
         -6.80751785e-17,  -8.46735112e-17,   7.96780963e-17,
          9.63654772e-18,  -1.09936073e-16,   5.42478978e-02,
         -3.74079263e-16,   5.88288204e-16,   1.86923304e-15,
          4.47289154e-01,  -9.99115380e-10,   5.41916045e-16,
         -7.15401621e-16,   2.37285163e-16,  -8.98294678e-15,
         -6.52191009e-01,  -1.13924887e-07,  -8.34094626e-01,
         -4.32053031e-17,  -2.51960968e-16,   3.34512676e-17,
          6.31217600e-17,   2.12329346e-16],
       [ -2.89553193e-04,   2.10738702e-01,  -3.34381686e-01,
         -1.93055343e-01,   1.34572501e-15,  -3.52842455e-02,
          7.11895780e-03,  -1.23304904e-02,   7.06297397e-01,
         -4.07780692e-01,  -6.92557153e-01,  -2.58802981e-15,
          1.74234691e-01,  -3.01783180e-01,   9.59279687e-02,
          1.09025492e-15,   2.96973665e-16,   5.50045375e-07,
          3.50570424e-01,   6.07206156e-01,   4.50777884e-01,
         -5.53228296e-15,   2.70564908e-17,  -3.38841139e-16,
         -3.45353270e-02,   1.99390953e-02,   7.45777546e-01,
         -6.21052263e-01,  -1.07569334e+00],
       [  9.81926772e-04,   4.69273144e-02,  -1.49000086e-01,
         -8.60252266e-02,   2.89790174e-14,  -9.88081192e-01,
          1.00039818e+00,  -1.73274208e+00,  -4.59444864e-02,
          2.65257236e-02,   3.78285791e-01,   2.18827651e-16,
         -7.95853609e-01,   1.37845944e+00,   8.62945707e-01,
         -3.46602728e-15,  -1.46507575e-15,   2.90431220e-07,
          1.40726948e-01,   2.43746168e-01,   8.89740554e-02,
          9.72249683e-17,   1.82740104e-16,  -3.35489427e-16,
         -5.49712908e-01,   3.17376843e-01,   4.05270372e-01,
         -2.35596715e-01,  -4.08065144e-01],
       [ -2.10516301e-04,   1.22173091e-02,  -1.46298448e-02,
          2.68185501e-03,   7.07649721e-17,  -7.01322335e-03,
          1.13400957e-02,  -7.32416830e-03,  -3.67981508e-02,
         -6.18460506e-02,   5.36671580e-02,  -3.66564252e-17,
         -3.27415019e-02,   1.39648527e-01,   8.29591254e-02,
         -3.22962645e-16,  -2.78899728e-16,  -5.09161154e-01,
         -4.81345511e-01,   1.34138645e-01,  -7.03999140e-02,
          1.50356107e-15,   5.27369749e-16,   6.52306312e-17,
         -5.90694176e-01,  -4.38901844e-01,   4.62364817e-01,
         -6.04847844e-01,  -3.28095932e-01],
       [  3.64624937e-04,  -2.11610011e-02,   1.42112256e-02,
          1.46298425e-02,   1.09062016e-17,   1.21472706e-02,
         -7.32415506e-03,   1.97973091e-02,  -1.93551460e-02,
         -3.67981411e-02,  -9.29543309e-02,  -4.43639369e-16,
          1.39648465e-01,  -1.93993678e-01,  -1.43689406e-01,
          1.90094435e-16,  -9.28283931e-18,  -2.93964250e-01,
         -1.34138289e-01,   3.26456479e-01,   1.21935622e-01,
         -1.71639638e-15,  -2.48990068e-16,   1.58828420e-16,
          2.43172998e-01,  -5.90694024e-01,  -8.00840443e-01,
          3.28096065e-01,   9.83699504e-01],
       [  1.10582523e-18,  -4.08256150e-18,  -4.10691728e-17,
         -6.07397513e-18,   1.99802418e-02,   9.67046829e-16,
          2.32780740e-17,  -2.94092982e-17,  -4.33390921e-17,
         -3.34424013e-17,  -7.41906794e-17,   5.42479525e-02,
          3.90212714e-16,   1.54414097e-16,   1.19949186e-15,
         -2.23644552e-01,   3.87363739e-01,  -9.82620108e-17,
         -4.45840483e-16,   2.76342362e-18,  -7.25836210e-15,
         -6.52190628e-01,   7.22347486e-01,   4.17047636e-01,
          4.92547855e-16,   5.92759532e-17,   1.82036581e-17,
         -6.87135361e-17,   1.89150789e-16],
       [ -2.89553193e-04,   2.10738702e-01,   3.34381697e-01,
         -1.93055325e-01,   1.41703173e-15,  -3.52842455e-02,
          7.11896993e-03,   1.23304834e-02,  -7.06297403e-01,
         -4.07780682e-01,  -6.92557153e-01,  -2.08084932e-15,
          1.74234805e-01,   3.01783114e-01,   9.59279687e-02,
          1.27036766e-16,  -2.48892024e-18,  -5.50045374e-07,
          3.50570434e-01,  -6.07206150e-01,   4.50777884e-01,
         -5.38773966e-15,  -3.24967332e-17,  -7.44074295e-16,
          3.45353275e-02,   1.99390946e-02,   7.45777546e-01,
         -6.21052264e-01,   1.07569334e+00],
       [  9.81926772e-04,   4.69273144e-02,   1.49000091e-01,
         -8.60252186e-02,   2.96391404e-14,  -9.88081192e-01,
          1.00039988e+00,   1.73274110e+00,   4.59444868e-02,
          2.65257230e-02,   3.78285791e-01,   5.36880718e-16,
         -7.95854129e-01,  -1.37845914e+00,   8.62945707e-01,
          2.54885829e-15,   1.58653385e-15,  -2.90431218e-07,
          1.40726952e-01,  -2.43746166e-01,   8.89740554e-02,
         -5.54406053e-16,   1.41088179e-16,   2.68542713e-17,
          5.49712914e-01,   3.17376832e-01,   4.05270372e-01,
         -2.35596716e-01,   4.08065143e-01],
       [ -2.10516301e-04,   1.22173091e-02,   1.46298447e-02,
          2.68185580e-03,   2.29657424e-17,  -7.01322335e-03,
          1.13401029e-02,   7.32415715e-03,   3.67981499e-02,
         -6.18460511e-02,   5.36671580e-02,   3.85044091e-16,
         -3.27415546e-02,  -1.39648515e-01,   8.29591254e-02,
         -1.59040900e-16,  -4.09809646e-16,   5.09161154e-01,
         -4.81345508e-01,  -1.34138653e-01,  -7.03999140e-02,
          1.00472675e-15,  -7.38422497e-16,   5.76593607e-16,
          5.90694167e-01,  -4.38901857e-01,   4.62364817e-01,
         -6.04847844e-01,   3.28095932e-01],
       [ -3.64624937e-04,   2.11610011e-02,   1.42112264e-02,
         -1.46298418e-02,   4.04876105e-17,  -1.21472706e-02,
          7.32417453e-03,   1.97973019e-02,  -1.93551454e-02,
          3.67981414e-02,   9.29543309e-02,   1.22856491e-16,
         -1.39648538e-01,  -1.93993625e-01,   1.43689406e-01,
          3.11216278e-18,   2.20834025e-16,  -2.93964250e-01,
          1.34138283e-01,   3.26456481e-01,  -1.21935622e-01,
          1.81760470e-15,   4.17620492e-18,   1.07431409e-16,
          2.43173011e-01,   5.90694019e-01,   8.00840443e-01,
         -3.28096065e-01,   9.83699504e-01],
       [  1.19609624e-18,   2.22423191e-17,  -9.80032647e-18,
         -3.62710766e-17,   1.99802418e-02,   1.19344459e-15,
         -6.40246979e-17,  -3.56298025e-18,  -1.58900436e-16,
          9.16012598e-17,  -1.40497988e-16,   5.42479525e-02,
          2.99216244e-16,  -6.27591632e-16,   1.66356411e-15,
         -2.23644554e-01,  -3.87363738e-01,  -1.43514039e-16,
          5.79732881e-16,   1.55722073e-17,  -7.82509658e-15,
         -6.52190628e-01,  -7.22347372e-01,   4.17047833e-01,
         -1.27134194e-15,   5.79350596e-17,   7.76181564e-18,
         -5.61846366e-17,   1.06231832e-16]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uhf_methyl_cholesky.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
