# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_rks_water_numgga():
    ref_result_dm_alpha = array([[  9.81743581e-02,   4.71809612e-02,  -1.83785386e-02,
          4.01831405e-02,   1.25576024e-01,  -9.51721302e-02,
         -7.80874353e-07,   1.79824593e-02,   6.28942513e-02,
         -6.28160789e-02,  -6.26439447e-06,  -4.91542165e-03,
          3.39282024e-06,  -1.57498305e-06,  -3.75385619e-03,
         -9.08971910e-03,  -2.01415902e-02,  -1.91610879e-02],
       [  4.71809612e-02,   2.87500624e-02,   1.13838600e-02,
         -1.79782500e-02,   7.03939607e-02,  -5.62204804e-02,
          3.21143461e-05,  -3.46027317e-02,   3.52577232e-02,
         -3.93128139e-02,   2.25928267e-05,  -1.56784896e-03,
          1.93966275e-06,  -2.49560725e-06,  -3.21665204e-03,
         -5.09573172e-03,  -1.91437195e-02,  -8.44184753e-03],
       [ -1.83785386e-02,   1.13838600e-02,   1.04146857e+00,
         -8.42528163e-02,  -4.32663273e-06,  -2.01301282e-02,
          2.65508419e-06,  -1.41402875e-01,   2.61071665e-07,
         -1.60667106e-02,   2.14252040e-06,   3.10140823e-03,
          2.73713155e-07,   2.36972763e-07,  -3.73432658e-03,
         -6.18179702e-07,  -1.83753708e-02,   1.13745220e-02],
       [  4.01831405e-02,  -1.79782500e-02,  -8.42528163e-02,
          2.48921502e-01,   3.60299383e-05,   4.20107117e-02,
          4.10474166e-06,   2.78915232e-01,   1.28632502e-05,
          4.19349984e-02,   2.90635522e-06,  -6.30944747e-03,
         -4.31866461e-07,  -1.30350026e-06,   8.00721800e-03,
         -8.22923050e-07,   4.01516535e-02,  -1.79708456e-02],
       [  1.25576024e-01,   7.03939607e-02,  -4.32663273e-06,
          3.60299383e-05,   2.66563667e-01,   1.52465819e-05,
          1.23926265e-05,  -4.27531345e-05,   1.33527474e-01,
          1.34699747e-05,   4.61420717e-06,   9.31179400e-06,
          5.55964637e-06,  -3.48650609e-06,  -5.19539030e-06,
         -1.92971452e-02,  -1.25582111e-01,  -7.03511258e-02],
       [ -9.51721302e-02,  -5.62204804e-02,  -2.01301282e-02,
          4.20107117e-02,   1.52465819e-05,   3.27035677e-01,
         -8.76724476e-06,   1.32747377e-01,   3.38617895e-05,
          2.25403816e-01,   2.70920791e-06,   1.11541385e-02,
         -2.72087129e-06,   6.87344768e-07,   1.71928995e-02,
         -3.06805015e-06,  -9.51931520e-02,  -5.60909469e-02],
       [ -7.80874353e-07,   3.21143461e-05,   2.65508419e-06,
          4.10474166e-06,   1.23926265e-05,  -8.76724476e-06,
          4.10497170e-01,  -5.88093126e-05,   8.41174000e-07,
          2.43980240e-05,   3.26913864e-01,  -7.01361692e-06,
         -5.39505851e-06,  -2.26101583e-02,   3.00350606e-06,
         -3.27733809e-06,  -1.22943813e-05,   6.76580828e-05],
       [  1.79824593e-02,  -3.46027317e-02,  -1.41402875e-01,
          2.78915232e-01,  -4.27531345e-05,   1.32747377e-01,
         -5.88093126e-05,   3.37501315e-01,  -2.00208192e-05,
          1.05354233e-01,  -4.46317959e-05,  -3.85114889e-03,
         -1.19748298e-06,   2.13516232e-06,   1.32468657e-02,
          4.50569576e-06,   1.80236144e-02,  -3.45148944e-02],
       [  6.28942513e-02,   3.52577232e-02,   2.61071665e-07,
          1.28632502e-05,   1.33527474e-01,   3.38617895e-05,
          8.41174000e-07,  -2.00208192e-05,   6.68867865e-02,
          2.43683586e-05,  -1.96165892e-06,   5.83232109e-06,
          2.78480177e-06,  -1.45082096e-06,  -1.42837837e-06,
         -9.66635531e-03,  -6.29162614e-02,  -3.52445077e-02],
       [ -6.28160789e-02,  -3.93128139e-02,  -1.60667106e-02,
          4.19349984e-02,   1.34699747e-05,   2.25403816e-01,
          2.43980240e-05,   1.05354233e-01,   2.43683586e-05,
          1.56052205e-01,   2.60242765e-05,   7.27767987e-03,
         -1.87990867e-06,  -1.26171373e-06,   1.21574215e-02,
         -2.22134613e-06,  -6.28331819e-02,  -3.92246295e-02],
       [ -6.26439447e-06,   2.25928267e-05,   2.14252040e-06,
          2.90635522e-06,   4.61420717e-06,   2.70920791e-06,
          3.26913864e-01,  -4.46317959e-05,  -1.96165892e-06,
          2.60242765e-05,   2.60349358e-01,  -5.20398710e-06,
         -4.29673436e-06,  -1.80063950e-02,   2.86323366e-06,
         -2.22966686e-06,  -1.04824112e-05,   5.36780322e-05],
       [ -4.91542165e-03,  -1.56784896e-03,   3.10140823e-03,
         -6.30944747e-03,   9.31179400e-06,   1.11541385e-02,
         -7.01361692e-06,  -3.85114889e-03,   5.83232109e-06,
          7.27767987e-03,  -5.20398710e-06,   6.27982336e-04,
         -8.97978124e-08,   4.28297717e-07,   4.01179969e-04,
         -8.06278213e-07,  -4.92452797e-03,  -1.56835228e-03],
       [  3.39282024e-06,   1.93966275e-06,   2.73713155e-07,
         -4.31866461e-07,   5.55964637e-06,  -2.72087129e-06,
         -5.39505851e-06,  -1.19748298e-06,   2.78480177e-06,
         -1.87990867e-06,  -4.29673436e-06,  -8.97978124e-08,
          2.09547378e-10,   2.97099676e-07,  -1.45244830e-07,
         -4.02428437e-07,  -1.84546501e-06,  -9.97520503e-07],
       [ -1.57498305e-06,  -2.49560725e-06,   2.36972763e-07,
         -1.30350026e-06,  -3.48650609e-06,   6.87344768e-07,
         -2.26101583e-02,   2.13516232e-06,  -1.45082096e-06,
         -1.26171373e-06,  -1.80063950e-02,   4.28297717e-07,
          2.97099676e-07,   1.24536613e-03,  -1.80911698e-07,
          3.83487271e-07,   1.70103481e-06,  -2.97284289e-06],
       [ -3.75385619e-03,  -3.21665204e-03,  -3.73432658e-03,
          8.00721800e-03,  -5.19539030e-06,   1.71928995e-02,
          3.00350606e-06,   1.32468657e-02,  -1.42837837e-06,
          1.21574215e-02,   2.86323366e-06,   4.01179969e-04,
         -1.45244830e-07,  -1.80911698e-07,   1.04246527e-03,
          3.21605411e-07,  -3.74923189e-03,  -3.20646690e-03],
       [ -9.08971910e-03,  -5.09573172e-03,  -6.18179702e-07,
         -8.22923050e-07,  -1.92971452e-02,  -3.06805015e-06,
         -3.27733809e-06,   4.50569576e-06,  -9.66635531e-03,
         -2.22134613e-06,  -2.22966686e-06,  -8.06278213e-07,
         -4.02428437e-07,   3.83487271e-07,   3.21605411e-07,
          1.39696392e-03,   9.09218497e-03,   5.09312161e-03],
       [ -2.01415902e-02,  -1.91437195e-02,  -1.83753708e-02,
          4.01516535e-02,  -1.25582111e-01,  -9.51931520e-02,
         -1.22943813e-05,   1.80236144e-02,  -6.29162614e-02,
         -6.28331819e-02,  -1.04824112e-05,  -4.92452797e-03,
         -1.84546501e-06,   1.70103481e-06,  -3.74923189e-03,
          9.09218497e-03,   9.81853975e-02,   4.71252247e-02],
       [ -1.91610879e-02,  -8.44184753e-03,   1.13745220e-02,
         -1.79708456e-02,  -7.03511258e-02,  -5.60909469e-02,
          6.76580828e-05,  -3.45148944e-02,  -3.52445077e-02,
         -3.92246295e-02,   5.36780322e-05,  -1.56835228e-03,
         -9.97520503e-07,  -2.97284289e-06,  -3.20646690e-03,
          5.09312161e-03,   4.71252247e-02,   2.86794308e-02]])
    ref_result_energy = -76.31847745020643
    ref_result_exp_alpha = array([[  1.67120500e-04,   1.41666405e-01,   2.43231324e-01,
         -1.37635381e-01,   2.64174014e-05,   1.16799367e-01,
         -1.14219534e-01,  -8.44041368e-01,  -7.93013304e-01,
         -4.72287370e-05,   3.88160661e-01,   2.33322272e-02,
          1.71795403e-01,  -1.03929097e-03,  -9.53977754e-02,
          7.34184878e-05,   8.30183709e-01,  -9.57997722e-01],
       [  3.26879928e-03,   1.06830593e-03,   1.36353834e-01,
         -1.00726796e-01,  -3.43504062e-05,   9.34986328e-01,
         -1.25829005e+00,   6.58395010e-01,   5.81670688e-01,
          4.55689229e-04,  -5.97723169e-03,   9.40339432e-01,
          6.73314118e-01,  -5.05719374e-04,  -5.01659563e-02,
          2.80749574e-04,   1.12476345e-01,   1.27338319e-02],
       [  9.94909450e-01,  -2.11521290e-01,   9.47148315e-06,
         -8.29608566e-02,   2.91570973e-06,   9.33025970e-02,
          1.54041840e-04,  -1.21222203e-04,  -4.34519358e-02,
          3.59338827e-05,   5.95021885e-02,  -1.14751289e-06,
         -6.81001332e-02,  -4.40373960e-06,   7.13008563e-04,
         -2.08249369e-05,   1.74747516e-02,  -1.43541608e-06],
       [  2.90599995e-02,   4.62690464e-01,   2.98352437e-05,
          1.84376063e-01,  -2.16786609e-05,  -1.72406196e-01,
         -2.52868843e-04,   6.33364171e-04,   1.93729169e-01,
         -3.37060511e-04,  -3.53540792e-01,   4.88172140e-04,
          1.61554879e+00,  -1.20607643e-03,  -1.35778925e-01,
          5.32388030e-04,   5.61341081e-01,  -4.80447030e-05],
       [  1.41738147e-07,   2.37587865e-05,   5.16297997e-01,
          5.22133937e-05,  -6.48889258e-06,  -6.32094894e-04,
          4.30536816e-01,   2.22204072e-01,  -5.41250694e-05,
          1.27137280e-04,  -1.56136636e-04,   9.76419814e-01,
         -4.50971892e-04,  -6.71791900e-05,   6.50576789e-05,
          3.20731635e-05,   6.63387629e-05,  -3.86888769e-02],
       [ -1.65024006e-03,  -1.30928701e-01,  -2.07372381e-05,
          5.56678163e-01,  -5.67212002e-05,   2.81473096e-01,
          3.49102034e-04,  -8.11134468e-04,  -5.53379715e-01,
         -1.13867417e-03,  -7.88372157e-01,  -4.01386858e-05,
         -1.87690781e-01,   4.69612281e-05,   8.26975838e-03,
         -1.78871778e-04,  -4.18258381e-02,   9.04990491e-05],
       [  1.52567960e-07,   1.01738765e-05,   1.59579454e-05,
         -7.86364626e-05,  -6.40700497e-01,  -9.97404519e-05,
         -1.56025390e-05,   2.42479364e-04,  -7.45510870e-04,
          9.62029339e-01,  -9.32142907e-04,  -1.87502004e-04,
          7.43511100e-05,  -3.46202244e-05,   1.16917109e-04,
          6.86894305e-03,   1.75137119e-05,  -1.98766811e-05],
       [ -1.42404277e-02,   4.65107301e-01,  -1.39384828e-04,
          3.47812803e-01,   5.64840720e-05,  -1.09846256e+00,
         -1.80706615e-03,  -4.46703444e-04,  -1.80303216e-01,
          6.26137210e-06,   5.03159882e-03,  -8.72022396e-04,
         -2.53756048e+00,   2.51176039e-03,   2.70026821e-01,
         -8.73146985e-04,  -1.33590348e+00,   1.27688539e-04],
       [  7.51935404e-08,  -1.55075030e-05,   2.58624770e-01,
          6.68206603e-05,   5.12022357e-06,  -1.17797569e-03,
          7.58732647e-01,   3.97737852e-01,  -1.39142550e-03,
         -4.00623023e-04,   5.57561289e-04,  -1.69842684e+00,
          7.37292553e-04,   1.60579082e-04,   1.81711383e-04,
         -5.33545004e-05,  -1.80033828e-04,   9.47317549e-01],
       [  2.56573203e-03,  -6.48080126e-02,  -1.03335210e-05,
          3.89673634e-01,  -8.69378535e-05,   4.31403204e-01,
          7.64279752e-04,  -6.63762420e-05,   1.84090835e-01,
          1.24302772e-03,   1.16280807e+00,   3.91173842e-04,
          6.33491888e-01,  -1.50224053e-03,  -1.50477526e-01,
          3.78174654e-04,   6.78705551e-01,  -1.20609641e-04],
       [ -3.54402989e-08,   1.05454995e-06,   2.52898687e-06,
         -4.68733546e-05,  -5.10244438e-01,   3.65541643e-05,
         -1.03906086e-05,  -2.46271894e-04,   7.73484571e-04,
         -1.03656658e+00,   9.88080282e-04,   1.90697026e-04,
         -1.08302803e-04,   6.77567017e-05,  -9.58577430e-05,
          3.49993009e-02,  -5.42748367e-06,   1.99834645e-05],
       [  1.94988660e-04,  -1.97795784e-02,   1.73901094e-05,
          1.53854566e-02,   8.74720038e-06,   1.28572388e-02,
          3.11888448e-05,   2.34704782e-04,   1.41515502e-01,
         -8.52874516e-06,  -6.86709600e-02,  -2.47934412e-04,
         -1.62485923e-01,   4.74777806e-03,   4.74441240e-01,
         -3.63669246e-04,   9.79862410e-01,  -8.90855287e-05],
       [  8.16234451e-08,   9.21876763e-07,   1.07671620e-05,
         -4.66936817e-06,   8.42094900e-06,  -2.10111395e-06,
          1.66559441e-05,   1.30678493e-05,   3.57097795e-05,
         -3.84023168e-05,  -8.53998892e-06,  -8.57689638e-05,
          1.24948703e-04,  -9.99947779e-01,   1.01738803e-02,
          9.49513913e-04,  -6.56006067e-05,  -8.00826120e-06],
       [ -1.16510208e-07,  -2.81614160e-06,  -6.30966118e-06,
          4.16555846e-06,   3.52897528e-02,   2.35549691e-05,
          2.90036904e-06,   4.86425665e-06,  -9.26414540e-05,
          1.63677252e-02,  -1.02546505e-04,  -3.39051565e-05,
         -2.82230359e-04,   9.55085692e-04,   6.49523946e-04,
          9.99242361e-01,   1.05185404e-05,  -5.31964154e-07],
       [ -1.15272801e-04,   4.57699534e-03,  -1.35051956e-05,
          3.19609660e-02,  -8.53835340e-06,   1.03389896e-02,
         -1.62236580e-05,  -3.78851421e-04,  -1.20432061e-01,
         -1.14828597e-04,   9.03694635e-02,   1.69869398e-04,
          1.85302014e-01,   8.93319649e-03,   8.73015810e-01,
         -5.18387305e-04,  -5.08594526e-01,  -1.49030153e-04],
       [ -1.21357488e-07,   3.09989345e-06,  -3.73759827e-02,
         -6.17458119e-06,   4.18512456e-06,   2.63243433e-05,
         -1.73581729e-02,   2.09809267e-01,  -4.88142407e-04,
         -8.30112238e-05,  -6.23830193e-06,  -3.38493408e-02,
         -6.01112021e-05,   1.32195887e-05,  -1.88005142e-04,
         -1.77529976e-06,  -2.25308828e-05,  -1.27369829e+00],
       [  1.67214154e-04,   1.41653221e-01,  -2.43228301e-01,
         -1.37694363e-01,   3.22783510e-05,   1.16554007e-01,
          1.14848480e-01,   8.40505711e-01,  -7.96350280e-01,
         -4.27337381e-04,   3.88971948e-01,  -2.25536611e-02,
          1.71841544e-01,  -1.02470238e-03,  -9.48552425e-02,
          6.63896983e-05,   8.30231697e-01,   9.57980626e-01],
       [  3.26886582e-03,   1.01792848e-03,  -1.36250611e-01,
         -1.00516111e-01,  -9.66432142e-05,   9.31037955e-01,
          1.26111983e+00,  -6.56047764e-01,   5.83760444e-01,
          4.25149460e-04,  -6.30944028e-03,  -9.40285611e-01,
          6.74134799e-01,  -3.23813014e-04,  -5.03238189e-02,
          2.17404917e-04,   1.12171668e-01,  -1.28500497e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_numgga.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]