# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_uks_methyl_gga():
    ref_result_dm_alpha = array([[  1.03151801e+00,  -4.58386200e-02,   2.35196079e-06,
         -1.49172001e-06,  -2.25476545e-06,  -1.09616652e-01,
          1.34616201e-06,  -7.11539856e-07,  -1.72387936e-06,
          1.56368782e-03,  -9.64975789e-08,  -4.85196489e-07,
         -4.13543984e-08,   4.80357965e-07,  -2.91114699e-02,
         -3.85064571e-03,  -2.91081793e-02,  -3.85517895e-03,
         -2.91106515e-02,  -3.85156131e-03],
       [ -4.58386200e-02,   1.61074637e-01,  -4.14968719e-06,
          2.54236168e-06,   1.03672158e-06,   1.69062037e-01,
         -2.43995314e-06,   1.02984097e-06,   3.50823196e-07,
         -2.57910011e-03,   3.65673765e-07,   9.03824901e-07,
          1.05354888e-08,  -9.74264261e-07,   5.46849642e-02,
          1.72497902e-02,   5.46776297e-02,   1.72581067e-02,
          5.46832793e-02,   1.72513931e-02],
       [  2.35196079e-06,  -4.14968719e-06,   2.00077281e-01,
         -1.39868338e-06,   8.45649601e-06,  -1.12888973e-05,
          9.38824794e-02,  -2.82294849e-06,   6.21716841e-06,
         -1.79133359e-06,  -2.78869126e-06,  -1.29415730e-06,
          8.94266821e-03,  -3.68673917e-07,   1.22922333e-01,
          1.01236380e-01,  -6.14500888e-02,  -5.06170940e-02,
         -6.14566836e-02,  -5.06144810e-02],
       [ -1.49172001e-06,   2.54236168e-06,  -1.39868338e-06,
          2.00086223e-01,  -4.92425014e-06,   5.27302773e-06,
         -2.65852114e-06,   9.38900660e-02,  -5.55232002e-06,
          1.68593005e-06,  -1.08486425e-06,   1.35021261e-06,
          1.76024287e-06,  -8.94061190e-03,  -4.05645273e-06,
          1.04386088e-06,   1.06438743e-01,   8.76753410e-02,
         -1.06450820e-01,  -8.76722821e-02],
       [ -2.25476545e-06,   1.03672158e-06,   8.45649601e-06,
         -4.92425014e-06,   3.60892986e-01,   2.00469498e-05,
          1.39439437e-05,  -1.22757896e-05,   3.16805754e-01,
          4.00063967e-07,  -2.20342291e-06,   2.55567274e-06,
         -5.84401012e-07,   1.93392545e-06,  -2.25036918e-05,
         -8.71246660e-06,   1.12315934e-05,  -2.87981312e-07,
         -1.40857084e-05,  -4.34838470e-06],
       [ -1.09616652e-01,   1.69062037e-01,  -1.12888973e-05,
          5.27302773e-06,   2.00469498e-05,   1.81159768e-01,
         -5.82001230e-06,   2.30616569e-06,   1.70052118e-05,
         -2.75709966e-03,   3.83316724e-07,   9.62606960e-07,
         -2.93389140e-07,  -1.14904741e-06,   5.82107043e-02,
          1.80377929e-02,   5.82106207e-02,   1.80529832e-02,
          5.82138794e-02,   1.80435912e-02],
       [  1.34616201e-06,  -2.43995314e-06,   9.38824794e-02,
         -2.65852114e-06,   1.39439437e-05,  -5.82001230e-06,
          4.40525778e-02,  -2.26442578e-06,   1.16745255e-05,
         -8.32581284e-07,  -1.30859179e-06,  -6.07204482e-07,
          4.19617784e-03,  -8.34766503e-08,   5.76788099e-02,
          4.75032032e-02,  -2.88355250e-02,  -2.37520438e-02,
         -2.88364900e-02,  -2.37490632e-02],
       [ -7.11539856e-07,   1.02984097e-06,  -2.82294849e-06,
          9.38900660e-02,  -1.22757896e-05,   2.30616569e-06,
         -2.26442578e-06,   4.40577289e-02,  -1.13531455e-05,
          7.93693139e-07,  -5.08979747e-07,   6.33527151e-07,
          7.29177520e-07,  -4.19536457e-03,  -3.28846076e-06,
         -6.23628320e-07,   4.99467809e-02,   4.11420116e-02,
         -4.99512263e-02,  -4.11395151e-02],
       [ -1.72387936e-06,   3.50823196e-07,   6.21716841e-06,
         -5.55232002e-06,   3.16805754e-01,   1.70052118e-05,
          1.16745255e-05,  -1.13531455e-05,   2.78104284e-01,
          3.60225217e-07,  -1.93422723e-06,   2.24346424e-06,
         -5.66937088e-07,   1.75262405e-06,  -2.06868472e-05,
         -8.31830465e-06,   9.38477523e-06,  -5.46251102e-07,
         -1.15314010e-05,  -3.03302876e-06],
       [  1.56368782e-03,  -2.57910011e-03,  -1.79133359e-06,
          1.68593005e-06,   4.00063967e-07,  -2.75709966e-03,
         -8.32581284e-07,   7.93693139e-07,   3.60225217e-07,
          4.19721123e-05,  -5.83495596e-09,  -1.46309871e-08,
         -8.32633240e-08,  -6.14094896e-08,  -8.87786778e-04,
         -2.76279078e-04,  -8.85036616e-04,  -2.74246416e-04,
         -8.86965531e-04,  -2.75651255e-04],
       [ -9.64975789e-08,   3.65673765e-07,  -2.78869126e-06,
         -1.08486425e-06,  -2.20342291e-06,   3.83316724e-07,
         -1.30859179e-06,  -5.08979747e-07,  -1.93422723e-06,
         -5.83495596e-09,   5.90331746e-11,  -2.83649003e-12,
         -1.24647104e-07,   4.84694460e-08,  -1.58907485e-06,
         -1.37180070e-06,   4.03288542e-07,   2.69277729e-07,
          1.55789046e-06,   1.22003132e-06],
       [ -4.85196489e-07,   9.03824901e-07,  -1.29415730e-06,
          1.35021261e-06,   2.55567274e-06,   9.62606960e-07,
         -6.07204482e-07,   6.33527151e-07,   2.24346424e-06,
         -1.46309871e-08,  -2.83649003e-12,   4.07036126e-11,
         -5.78371401e-08,  -6.03225650e-08,  -4.85435731e-07,
         -5.58344275e-07,   1.42565874e-06,   1.01565945e-06,
         -1.10696357e-08,  -1.67706973e-07],
       [ -4.13543984e-08,   1.05354888e-08,   8.94266821e-03,
          1.76024287e-06,  -5.84401012e-07,  -2.93389140e-07,
          4.19617784e-03,   7.29177520e-07,  -5.66937088e-07,
         -8.32633240e-08,  -1.24647104e-07,  -5.78371401e-08,
          3.99702145e-04,  -9.79316769e-08,   5.49421300e-03,
          4.52488929e-03,  -2.74554015e-03,  -2.26156559e-03,
         -2.74777422e-03,  -2.26304617e-03],
       [  4.80357965e-07,  -9.74264261e-07,  -3.68673917e-07,
         -8.94061190e-03,   1.93392545e-06,  -1.14904741e-06,
         -8.34766503e-08,  -4.19536457e-03,   1.75262405e-06,
         -6.14094896e-08,   4.84694460e-08,  -6.03225650e-08,
         -9.79316769e-08,   3.99500489e-04,  -3.78234349e-07,
         -3.56880066e-07,  -4.75624893e-03,  -3.91764996e-03,
          4.75646462e-03,   3.91754739e-03],
       [ -2.91114699e-02,   5.46849642e-02,   1.22922333e-01,
         -4.05645273e-06,  -2.25036918e-05,   5.82107043e-02,
          5.76788099e-02,  -3.28846076e-06,  -2.06868472e-05,
         -8.87786778e-04,  -1.58907485e-06,  -4.85435731e-07,
          5.49421300e-03,  -3.78234349e-07,   9.42679098e-02,
          6.80402587e-02,  -1.90117490e-02,  -2.52546215e-02,
         -1.90095377e-02,  -2.52517503e-02],
       [ -3.85064571e-03,   1.72497902e-02,   1.01236380e-01,
          1.04386088e-06,  -8.71246660e-06,   1.80377929e-02,
          4.75032032e-02,  -6.23628320e-07,  -8.31830465e-06,
         -2.76279078e-04,  -1.37180070e-06,  -5.58344275e-07,
          4.52488929e-03,  -3.56880066e-07,   6.80402587e-02,
          5.30730913e-02,  -2.52500830e-02,  -2.37614987e-02,
         -2.52543894e-02,  -2.37621906e-02],
       [ -2.91081793e-02,   5.46776297e-02,  -6.14500888e-02,
          1.06438743e-01,   1.12315934e-05,   5.82106207e-02,
         -2.88355250e-02,   4.99467809e-02,   9.38477523e-06,
         -8.85036616e-04,   4.03288542e-07,   1.42565874e-06,
         -2.74554015e-03,  -4.75624893e-03,  -1.90117490e-02,
         -2.52500830e-02,   9.42334613e-02,   6.80291816e-02,
         -1.90108629e-02,  -2.52514703e-02],
       [ -3.85517895e-03,   1.72581067e-02,  -5.06170940e-02,
          8.76753410e-02,  -2.87981312e-07,   1.80529832e-02,
         -2.37520438e-02,   4.11420116e-02,  -5.46251102e-07,
         -2.74246416e-04,   2.69277729e-07,   1.01565945e-06,
         -2.26156559e-03,  -3.91764996e-03,  -2.52546215e-02,
         -2.37614987e-02,   6.80291816e-02,   5.30731848e-02,
         -2.52534889e-02,  -2.37628343e-02],
       [ -2.91106515e-02,   5.46832793e-02,  -6.14566836e-02,
         -1.06450820e-01,  -1.40857084e-05,   5.82138794e-02,
         -2.88364900e-02,  -4.99512263e-02,  -1.15314010e-05,
         -8.86965531e-04,   1.55789046e-06,  -1.10696357e-08,
         -2.74777422e-03,   4.75646462e-03,  -1.90095377e-02,
         -2.52543894e-02,  -1.90108629e-02,  -2.52534889e-02,
          9.42569930e-02,   6.80338216e-02],
       [ -3.85156131e-03,   1.72513931e-02,  -5.06144810e-02,
         -8.76722821e-02,  -4.34838470e-06,   1.80435912e-02,
         -2.37490632e-02,  -4.11395151e-02,  -3.03302876e-06,
         -2.75651255e-04,   1.22003132e-06,  -1.67706973e-07,
         -2.26304617e-03,   3.91754739e-03,  -2.52517503e-02,
         -2.37621906e-02,  -2.52514703e-02,  -2.37628343e-02,
          6.80338216e-02,   5.30688434e-02]])
    ref_result_energy = -39.760972800928023
    ref_result_exp_alpha = array([[  9.94857527e-01,   2.04393032e-01,   9.62139012e-06,
         -7.03436916e-06,  -3.67118024e-06,   1.54002539e-01,
         -4.37142732e-06,   8.00625816e-06,   2.00736924e-07,
         -1.33676589e-08,  -9.97142564e-06,   4.68963038e-02,
         -7.96024636e-07,   5.60086920e-06,   3.48062926e-02,
         -1.68757698e-06,   9.39761033e-07,   4.11141660e-02,
          1.14914339e-05,  -2.71484680e-06],
       [  3.60465335e-02,  -3.99719048e-01,  -1.80093678e-05,
          1.22819801e-05,   1.45734151e-06,  -2.57927956e-01,
          1.52173807e-05,  -1.55553786e-05,   6.65947932e-06,
          1.34111997e-06,  -1.21514212e-04,   6.60719549e-01,
         -2.41076193e-04,   1.40768117e-04,  -1.94835850e+00,
          4.23067104e-05,  -2.47431476e-06,   2.73729806e-01,
          4.62227634e-05,  -2.11992558e-05],
       [ -1.71996833e-08,  -1.16076744e-05,   4.41403125e-01,
         -7.23918057e-02,   1.11901768e-05,  -1.38342090e-06,
          4.32770068e-01,   1.00734202e-01,   5.93138498e-05,
         -3.00822513e-01,   7.71243530e-01,   2.62689057e-04,
          9.73785218e-02,  -7.51988883e-01,  -2.62205937e-05,
         -2.35373588e-06,  -2.34719178e-05,   3.01163540e-07,
         -3.26234124e-02,   4.96432002e-02],
       [  1.13016226e-07,   3.91243315e-06,   7.23903338e-02,
          4.41413515e-01,  -1.57186634e-05,  -2.99458159e-05,
         -1.00734298e-01,   4.32770911e-01,  -2.07738029e-05,
         -7.71182810e-01,  -3.00812492e-01,  -9.06334599e-05,
         -7.52046899e-01,  -9.73998631e-02,   7.62398751e-05,
          6.54580275e-06,  -1.49240743e-05,   6.20539316e-06,
          4.96195252e-02,   3.26385628e-02],
       [  3.20951350e-08,  -4.11475474e-07,   5.46464132e-06,
          9.34534442e-06,   6.00743732e-01,   1.13165608e-05,
         -3.01385147e-06,   5.47729299e-06,   1.05818439e+00,
          2.81301648e-05,  -6.45768185e-05,   1.82142262e-06,
         -3.59485527e-05,   1.14004373e-05,   3.59146717e-06,
         -4.38725659e-06,  -1.36520030e-06,   2.21598599e-06,
          9.28863141e-06,   3.47321626e-06],
       [ -2.28643153e-02,  -4.25014064e-01,  -3.34292689e-05,
          2.12555259e-05,   3.31320725e-05,  -1.84861274e+00,
          3.87016449e-05,  -1.13397576e-04,  -8.05357894e-06,
          2.23633418e-06,   1.82748319e-04,  -9.88475062e-01,
          4.34078162e-04,  -2.23845616e-04,   3.60638487e+00,
         -9.13099429e-05,  -3.86218630e-06,  -7.92536106e-01,
         -1.52698134e-04,   4.95456120e-05],
       [ -1.07322715e-08,  -4.19761063e-06,   2.07119310e-01,
         -3.39728918e-02,   2.18575282e-05,   1.29938452e-05,
          1.24710115e+00,   2.90300791e-01,  -1.39880991e-04,
          6.15438969e-01,  -1.57780476e+00,  -4.87967990e-04,
         -1.46930196e-01,   1.13466169e+00,   3.85765485e-05,
          1.55327963e-06,   9.45773834e-05,   9.14245144e-05,
         -2.93453008e-01,   4.46275606e-01],
       [ -4.27285101e-08,   2.23073224e-06,   3.39642342e-02,
          2.07133127e-01,  -2.39626388e-05,  -7.39702070e-05,
         -2.90292417e-01,   1.24709078e+00,   3.20211158e-05,
          1.57773110e+00,   6.15453317e-01,   2.10894972e-04,
          1.13476080e+00,   1.47008089e-01,  -1.02267958e-04,
         -8.42474204e-06,   2.15735530e-05,  -8.68232611e-05,
          4.46280461e-01,   2.93431789e-01],
       [ -2.84073636e-09,   1.04160699e-06,   1.68932640e-06,
          5.92581082e-06,   5.27355898e-01,   7.17323410e-06,
         -2.08394033e-05,   4.52476647e-06,  -1.09660521e+00,
         -2.26240076e-05,   8.18090742e-05,   1.65304169e-05,
          1.79140270e-05,   5.51595933e-06,   1.17071118e-06,
         -1.93894491e-06,   1.69967924e-06,   6.35015662e-07,
         -5.60301276e-07,  -2.63311200e-06],
       [  2.41674390e-04,   6.47407861e-03,  -3.17191096e-06,
          4.27814577e-06,   6.77577241e-07,  -1.69886200e-02,
          2.13587807e-06,  -4.10518926e-06,  -1.98859189e-06,
         -6.83476379e-06,   2.01211111e-05,  -1.85158281e-01,
          4.62281788e-05,  -4.86414606e-05,  -2.71332940e-02,
          8.41676351e-05,   1.26184722e-05,   1.05103028e+00,
          2.22099080e-04,  -5.04626608e-05],
       [  8.93165463e-08,  -9.07341030e-07,  -6.53984785e-06,
         -1.38537663e-06,  -3.69963103e-06,  -6.27240866e-06,
          2.05321646e-06,   5.74781023e-06,   5.31904223e-07,
          1.47804732e-05,  -1.17983260e-05,  -3.11980674e-05,
         -2.43228399e-05,  -5.24943082e-05,  -1.92379698e-05,
         -6.21713845e-01,   7.83244458e-01,   3.42829612e-05,
          3.51668673e-05,  -8.39238966e-05],
       [ -2.26790137e-08,  -2.26415521e-06,  -2.36599318e-06,
          3.45206980e-06,   4.26321090e-06,   6.45037534e-06,
          2.77447782e-06,   2.95227885e-06,   1.62882904e-06,
          4.19306389e-06,  -8.19099358e-06,   4.30577056e-05,
          3.63997522e-07,  -3.70857512e-05,   2.17276264e-05,
          7.83244461e-01,   6.21713842e-01,  -6.19331735e-05,
          2.73812693e-05,  -6.50641833e-05],
       [ -4.61073022e-08,  -1.02326413e-06,   1.97296269e-02,
         -3.23161218e-03,  -1.10204848e-06,   1.73290869e-06,
         -2.15520592e-02,  -5.01946312e-03,   7.56882862e-06,
         -4.24652954e-02,   1.08841295e-01,   1.94764240e-05,
         -2.53757966e-02,   1.96118030e-01,   1.82313199e-05,
         -2.02211813e-06,   1.37290357e-04,   1.81339745e-04,
         -5.95878088e-01,   9.06200251e-01],
       [ -3.09862085e-08,   1.97276939e-06,  -3.23562446e-03,
         -1.97239086e-02,   3.55552556e-06,   3.68498136e-07,
         -5.00668973e-03,   2.15447411e-02,   1.26674263e-06,
          1.08837756e-01,   4.24460456e-02,   6.87118292e-06,
         -1.96063847e-01,  -2.54141703e-02,   3.06257056e-05,
          4.18145104e-06,  -2.92599785e-05,   1.72390174e-04,
         -9.06214593e-01,  -5.95875210e-01],
       [ -1.13384285e-03,  -1.36924354e-01,   2.71182280e-01,
         -4.44809645e-02,  -3.93352247e-05,   1.13377748e-01,
         -1.24170383e-01,  -2.89238725e-02,   3.07943774e-05,
         -1.55110205e-01,   3.97439988e-01,   6.37041449e-01,
         -1.12343644e-01,   8.67522849e-01,   2.85808966e-01,
         -1.92052232e-05,  -1.01791210e-05,   3.76372909e-01,
          3.74801716e-01,  -5.69930600e-01],
       [  4.90458887e-03,  -4.27237137e-02,   2.23343603e-01,
         -3.66248798e-02,  -1.60181749e-05,   9.53067882e-01,
         -1.58526141e+00,  -3.68920469e-01,   5.40744621e-05,
         -1.69651460e-01,   4.35074323e-01,  -2.30360010e-01,
          2.01429418e-01,  -1.55630682e+00,  -1.09482558e+00,
          4.15685071e-05,  -7.91827736e-05,   6.44707112e-02,
          5.98548789e-03,  -9.05827201e-03],
       [ -1.13391807e-03,  -1.36880171e-01,  -9.70616656e-02,
          2.57050622e-01,   1.54797496e-05,   1.13394691e-01,
          8.71281996e-02,  -9.30892435e-02,   9.96519891e-06,
         -2.66831811e-01,  -3.33283713e-01,   6.37169913e-01,
          8.07398975e-01,  -3.36408360e-01,   2.85688258e-01,
         -3.06490125e-05,   2.12990781e-05,   3.76555183e-01,
         -6.80749912e-01,  -3.95929301e-02],
       [  4.90462883e-03,  -4.27231580e-02,  -7.99487589e-02,
          2.11735762e-01,  -3.09879195e-06,   9.53195096e-01,
          1.11215402e+00,  -1.18829327e+00,  -6.67112517e-05,
         -2.91819578e-01,  -3.64384948e-01,  -2.30977413e-01,
         -1.44867494e+00,   6.03596925e-01,  -1.09459978e+00,
          5.56003044e-05,   1.42238862e-05,   6.45503646e-02,
         -1.08921674e-02,  -6.33604318e-04],
       [ -1.13382634e-03,  -1.36905252e-01,  -1.74102032e-01,
         -2.12605627e-01,  -1.86555382e-05,   1.13371420e-01,
          3.70531907e-02,   1.21990843e-01,  -2.90183467e-05,
          4.21940083e-01,  -6.45779239e-02,   6.37114361e-01,
         -6.95079398e-01,  -5.30906513e-01,   2.85827684e-01,
         -1.20741811e-06,  -1.66152230e-06,   3.76430406e-01,
          3.06242611e-01,   6.09436316e-01],
       [  4.90454647e-03,  -4.27154144e-02,  -1.43385712e-01,
         -1.75102007e-01,  -3.25656167e-06,   9.53020324e-01,
          4.73028578e-01,   1.55741661e+00,   6.64253048e-06,
          4.61463747e-01,  -7.05277374e-02,  -2.30711176e-01,
          1.24696038e+00,   9.52698893e-01,  -1.09485031e+00,
          2.25337690e-05,   6.60112553e-05,   6.44953600e-02,
          4.89848764e-03,   9.69701311e-03]])
    ref_result_exp_beta = array([[  9.95042530e-01,  -1.96044514e-01,  -1.04234625e-05,
         -7.26627697e-06,   2.15925950e-06,   1.61459058e-01,
          9.44879302e-06,   9.64023005e-06,  -7.01405423e-06,
         -9.48069724e-06,   3.35192683e-07,   5.84967603e-02,
         -7.70026947e-06,   8.58590865e-06,   3.62061509e-02,
          2.02041910e-05,  -1.04947209e-06,   3.14806540e-02,
         -5.37220517e-05,   3.14193269e-05],
       [  3.45140354e-02,   3.80009762e-01,   1.60821385e-05,
          9.94180613e-06,   9.92260270e-06,  -2.56247277e-01,
         -2.22445030e-05,  -2.04107253e-05,  -5.30826264e-05,
         -6.99578737e-05,  -1.69578390e-05,   5.41973289e-01,
         -2.69042175e-04,   1.36392908e-04,  -1.98023466e+00,
          5.66769673e-05,   2.02613436e-05,   3.29931055e-01,
         -5.85232883e-04,   3.86337479e-04],
       [  1.67612714e-07,   1.88797371e-05,  -4.27286306e-01,
         -4.30772897e-02,   4.50876180e-05,   1.83679035e-05,
         -4.46499534e-01,   6.51576072e-03,   6.94220372e-01,
          4.20257533e-01,   6.12478183e-04,   3.29694285e-04,
          3.45849106e-01,  -7.04202321e-01,  -3.95684173e-05,
          1.60825270e-05,  -1.35101644e-05,   1.01114526e-04,
          4.10885190e-02,  -4.16042090e-02],
       [  8.86339417e-08,  -1.07007756e-05,  -4.30767219e-02,
          4.27245818e-01,   3.69356521e-06,  -3.45566656e-05,
          6.51258896e-03,   4.46462210e-01,   4.20200475e-01,
         -6.94139415e-01,  -2.81465573e-04,  -1.21973161e-04,
         -7.04332839e-01,  -3.45915471e-01,   5.45670517e-05,
          4.89006807e-06,   9.14697205e-06,  -5.93299834e-06,
         -4.15799229e-02,  -4.11014118e-02],
       [ -2.14353462e-07,  -1.10273799e-05,   8.17889801e-05,
          3.44970049e-05,  -5.34319317e-01,   7.34242612e-06,
          1.63788403e-05,   9.46122978e-06,  -5.81229806e-04,
         -7.68291738e-04,   1.09322877e+00,  -3.72525729e-05,
          6.46479893e-05,  -1.45292356e-04,  -2.19994072e-05,
          1.33868004e-05,   9.39658836e-06,   1.96849000e-05,
         -5.11869196e-06,  -3.01132901e-06],
       [ -2.15165799e-02,   3.65930543e-01,   2.92727276e-05,
          1.66898697e-05,  -1.38359153e-05,  -1.91186055e+00,
         -9.86919418e-05,  -1.30639710e-04,   5.87109585e-05,
          8.83366433e-05,   6.76747356e-05,  -8.64674053e-01,
          4.83078322e-04,  -2.38141402e-04,   3.60535784e+00,
         -2.60546457e-04,  -5.09987621e-05,  -8.20907361e-01,
          1.42458965e-03,  -9.16063566e-04],
       [  9.88437782e-08,   6.04077460e-06,  -1.84020936e-01,
         -1.85561991e-02,   7.29761537e-06,   7.72950961e-05,
         -1.29955611e+00,   1.89574098e-02,  -1.42733206e+00,
         -8.64049193e-01,  -1.15918846e-03,  -6.03628231e-04,
         -5.12521121e-01,   1.04357038e+00,   4.10679814e-05,
         -1.22614040e-04,   2.73182781e-05,   1.06878690e-03,
          3.76751304e-01,  -3.81065751e-01],
       [ -6.03231733e-08,  -4.65905018e-06,  -1.85478120e-02,
          1.84030370e-01,   2.40714350e-05,  -8.95872814e-05,
          1.89636526e-02,   1.29965476e+00,  -8.63922354e-01,
          1.42717047e+00,   5.43077980e-04,   2.59359479e-04,
          1.04371560e+00,   5.12650563e-01,  -6.89585237e-05,
         -3.98634182e-05,   2.52002732e-05,  -2.59090134e-04,
         -3.81070069e-01,  -3.76728781e-01],
       [  8.36487625e-08,  -3.37224530e-06,   2.60155934e-05,
          1.26488373e-05,  -5.94001833e-01,  -1.55803549e-05,
         -1.16480066e-04,  -1.25256233e-05,   5.94645135e-04,
          7.89657689e-04,  -1.06198308e+00,   5.08568521e-05,
         -6.46227956e-05,   1.21063219e-04,   1.99280354e-05,
         -1.09346828e-05,  -7.72506997e-06,  -8.73135416e-06,
         -1.27930615e-06,   1.82284339e-06],
       [ -6.17408538e-04,  -3.18237300e-02,  -2.50071988e-06,
          5.15385359e-07,   8.09241660e-06,   1.40437210e-02,
          3.82438196e-07,  -5.23577520e-06,   2.68761749e-05,
          2.09274088e-05,  -2.04763141e-05,  -1.55686563e-01,
          6.35133942e-05,  -2.32799782e-05,   1.42242474e-02,
          4.67722708e-04,   6.23868980e-05,   1.05563221e+00,
         -1.80359439e-03,   1.12983592e-03],
       [ -1.10585223e-06,  -1.76978148e-05,   4.77677642e-06,
         -3.06447997e-06,  -1.83874788e-06,   1.72356211e-05,
         -4.41758477e-06,   2.45865515e-06,  -1.34854942e-05,
          2.02122437e-06,   1.12251449e-05,  -3.32473521e-06,
          1.36842492e-06,  -4.88848991e-05,   3.83509628e-05,
         -9.99931516e-01,   1.16931501e-02,   4.40265077e-04,
         -7.91778203e-05,   1.68758467e-04],
       [  3.77697331e-07,   5.23527871e-06,   4.75828147e-06,
          1.13861571e-06,   1.28243641e-06,   3.10067626e-06,
         -2.74438223e-06,  -2.31395839e-06,  -1.21415688e-05,
         -6.77811229e-06,  -8.12457424e-06,   4.01977111e-05,
          2.05249355e-05,  -2.79392630e-05,   1.24440811e-05,
          1.16931349e-02,   9.99931628e-01,  -5.84180634e-05,
          2.37846949e-05,   5.48555573e-05],
       [  5.66133539e-07,   1.13356031e-05,  -1.97826494e-02,
         -1.98577574e-03,  -4.95702598e-06,  -1.14775271e-05,
          1.90030745e-02,  -2.74670319e-04,   1.02637760e-01,
          6.21119743e-02,   1.26364774e-04,   3.71887194e-06,
         -8.45859385e-02,   1.72270169e-01,   2.49844471e-06,
         -1.99297611e-04,   3.50122351e-05,   2.13589456e-03,
          7.63042619e-01,  -7.71813207e-01],
       [  2.85594969e-08,  -2.92942082e-08,   1.99128565e-03,
         -1.97766535e-02,  -1.67160422e-06,  -8.79805731e-07,
          2.63222841e-04,   1.89905844e-02,  -6.21254006e-02,
          1.02625857e-01,   4.32281678e-05,   5.53739134e-06,
         -1.72193813e-01,  -8.46030759e-02,   2.27974682e-05,
          7.22506593e-05,  -5.98647100e-05,   5.10666373e-04,
          7.71829829e-01,   7.63045081e-01],
       [ -1.19977022e-03,   1.51428558e-01,  -2.87217747e-01,
         -2.89615832e-02,  -2.15210819e-05,   9.50341473e-02,
          1.12451831e-01,  -1.66204225e-03,   3.80675109e-01,
          2.30338564e-01,   5.21881619e-04,   6.62058182e-01,
         -3.81856386e-01,   7.77509844e-01,   2.60152543e-01,
          2.34869745e-04,   9.04399803e-06,   3.49181549e-01,
         -4.77392625e-01,   4.82692917e-01],
       [  4.62521258e-03,   6.94801077e-02,  -2.51583048e-01,
         -2.53587490e-02,  -1.39543709e-04,   9.73834158e-01,
          1.63806440e+00,  -2.38047702e-02,   3.69331398e-01,
          2.23663856e-01,   1.54243290e-05,  -2.65626975e-01,
          6.89497511e-01,  -1.40412962e+00,  -1.06561220e+00,
          7.02686520e-05,  -1.75306330e-05,   8.14364198e-02,
         -9.71523025e-03,   9.73543232e-03],
       [ -1.19947737e-03,   1.51381491e-01,   1.18522129e-01,
          2.63204605e-01,   1.53757045e-05,   9.50561789e-02,
         -5.76498417e-02,  -9.65481498e-02,   9.17419911e-03,
         -4.45245189e-01,  -3.48896655e-04,   6.62236379e-01,
          8.64073286e-01,  -5.80352498e-02,   2.59979458e-01,
          1.40662985e-04,  -6.06047643e-05,   3.51406381e-01,
          6.55420114e-01,   1.72120584e-01],
       [  4.62527133e-03,   6.94756038e-02,   1.03831731e-01,
          2.30598305e-01,   7.38791706e-05,   9.74070683e-01,
         -8.39646016e-01,  -1.40658997e+00,   8.91274568e-03,
         -4.31329390e-01,  -1.84090483e-04,  -2.66425312e-01,
         -1.56084438e+00,   1.04858318e-01,  -1.06536410e+00,
          3.42613686e-06,   5.06356549e-05,   8.15433133e-02,
          1.30594410e-02,   3.56106994e-03],
       [ -1.19942410e-03,   1.51408983e-01,   1.68688989e-01,
         -2.34264735e-01,   3.31998499e-05,   9.50339844e-02,
         -5.48009733e-02,   9.81838155e-02,  -3.90142233e-01,
          2.14514129e-01,  -9.30333171e-05,   6.62154580e-01,
         -4.82432090e-01,  -7.19215668e-01,   2.60089851e-01,
          1.07530376e-04,   1.45040470e-05,   3.50915561e-01,
         -1.79860942e-01,  -6.53690892e-01],
       [  4.62517945e-03,   6.94688697e-02,   1.47762369e-01,
         -2.05216149e-01,   3.67584305e-05,   9.73876038e-01,
         -7.98251401e-01,   1.43063054e+00,  -3.78067734e-01,
          2.07880185e-01,   4.13411346e-05,  -2.66085563e-01,
          8.71162706e-01,   1.29925415e+00,  -1.06554813e+00,
         -3.83865096e-05,   4.24740827e-05,   8.14789039e-02,
         -3.74653070e-03,  -1.30117884e-02]])
    ref_result_dm_beta = array([[  1.02854309e+00,  -4.01559154e-02,   1.21817900e-06,
         -4.64789023e-07,   1.94976971e-06,  -9.31485726e-02,
          9.49651759e-07,  -2.85147720e-07,   7.46220613e-07,
          5.62451954e-03,   2.36900482e-06,  -6.50787429e-07,
         -1.43713142e-06,   1.57466115e-07,  -3.08773590e-02,
         -9.01609092e-03,  -3.08741926e-02,  -9.02073522e-03,
         -3.08764373e-02,  -9.01679170e-03],
       [ -4.01559154e-02,   1.45598697e-01,  -7.27316226e-08,
         -5.23453348e-07,  -4.20199461e-06,   1.38314557e-01,
         -8.15403646e-07,  -2.50452892e-07,  -1.28185358e-06,
         -1.21146385e-02,  -6.76310147e-06,   2.00306276e-06,
          3.98714694e-06,  -1.75382771e-07,   5.74980355e-02,
          2.65584441e-02,   5.74895823e-02,   2.65650194e-02,
          5.74958944e-02,   2.65588245e-02],
       [  1.21817900e-06,  -7.27316226e-08,   1.84429293e-01,
          1.50410355e-06,  -3.64321649e-05,  -6.25284748e-06,
          7.94289487e-02,  -2.30424264e-06,  -1.16603885e-05,
          4.37042735e-07,  -1.91112893e-06,  -2.08208824e-06,
          8.53841338e-03,   1.07246641e-06,   1.23974681e-01,
          1.08591685e-01,  -6.19781824e-02,  -5.42981422e-02,
         -6.19841631e-02,  -5.42953995e-02],
       [ -4.64789023e-07,  -5.23453348e-07,   1.50410355e-06,
          1.84394634e-01,   1.12175082e-05,   1.92899813e-06,
         -1.04065447e-06,   7.94251714e-02,   4.28439333e-06,
          6.70916358e-07,  -1.51485348e-06,   2.79709099e-07,
          3.76032914e-06,  -8.53526519e-03,  -2.93555943e-06,
          2.21904123e-06,   1.07345926e-01,   9.40486958e-02,
         -1.07356839e-01,  -9.40435985e-02],
       [  1.94976971e-06,  -4.20199461e-06,  -3.64321649e-05,
          1.12175082e-05,   8.00113927e-09,  -4.03317124e-06,
         -1.56904754e-05,   4.83235406e-06,   2.60134328e-09,
          3.51358254e-07,   4.80942870e-10,   3.70428281e-10,
         -1.68656923e-06,  -5.19456189e-07,  -2.61612736e-05,
         -2.22189151e-05,   1.71028487e-05,   1.56796254e-05,
          4.04223826e-06,   4.23652345e-06],
       [ -9.31485726e-02,   1.38314557e-01,  -6.25284748e-06,
          1.92899813e-06,  -4.03317124e-06,   1.34368074e-01,
         -3.44910101e-06,   8.12215426e-07,  -1.23850902e-06,
         -1.16319868e-02,  -6.45193873e-06,   1.90824078e-06,
          3.52267858e-06,  -2.83326628e-07,   5.54292727e-02,
          2.53175796e-02,   5.54287602e-02,   2.53306041e-02,
          5.54319972e-02,   2.53221568e-02],
       [  9.49651759e-07,  -8.15403646e-07,   7.94289487e-02,
         -1.04065447e-06,  -1.56904754e-05,  -3.44910101e-06,
          3.42080034e-02,  -1.71964465e-06,  -5.02186140e-06,
          2.53925701e-07,  -8.23023635e-07,  -8.96715173e-07,
          3.67727478e-03,   5.40039019e-07,   5.33923910e-02,
          4.67674998e-02,  -2.66937032e-02,  -2.33858166e-02,
         -2.66943130e-02,  -2.33829130e-02],
       [ -2.85147720e-07,  -2.50452892e-07,  -2.30424264e-06,
          7.94251714e-02,   4.83235406e-06,   8.12215426e-07,
         -1.71964465e-06,   3.42111791e-02,   1.84562379e-06,
          2.90852778e-07,  -6.52468283e-07,   1.20513413e-07,
          1.48303149e-06,  -3.67643509e-03,  -3.25738934e-06,
         -7.86785776e-07,   4.62386011e-02,   4.05109035e-02,
         -4.62413344e-02,  -4.05069785e-02],
       [  7.46220613e-07,  -1.28185358e-06,  -1.16603885e-05,
          4.28439333e-06,   2.60134328e-09,  -1.23850902e-06,
         -5.02186140e-06,   1.84562379e-06,   8.48207237e-10,
          1.07526264e-07,   1.45368257e-10,   1.20464995e-10,
         -5.39783606e-07,  -1.98386565e-07,  -8.35029726e-06,
         -7.10006110e-06,   5.90082314e-06,   5.38369347e-06,
          9.12439746e-07,   1.01317479e-06],
       [  5.62451954e-03,  -1.21146385e-02,   4.37042735e-07,
          6.70916358e-07,   3.51358254e-07,  -1.16319868e-02,
          2.53925701e-07,   2.90852778e-07,   1.07526264e-07,
          1.01313076e-03,   5.63849325e-07,  -1.66890778e-07,
         -3.12669176e-07,  -1.42623148e-08,  -4.81758070e-03,
         -2.21335669e-03,  -4.81694128e-03,  -2.21396776e-03,
         -4.81819970e-03,  -2.21408861e-03],
       [  2.36900482e-06,  -6.76310147e-06,  -1.91112893e-06,
         -1.51485348e-06,   4.80942870e-10,  -6.45193873e-06,
         -8.23023635e-07,  -6.52468283e-07,   1.45368257e-10,
          5.63849325e-07,   3.46646458e-10,  -7.38141826e-11,
         -8.86942756e-08,   7.01170673e-08,  -3.96288331e-06,
         -2.35976877e-06,  -2.91748775e-06,  -1.44477690e-06,
         -1.15386617e-06,   1.00722927e-07],
       [ -6.50787429e-07,   2.00306276e-06,  -2.08208824e-06,
          2.79709099e-07,   3.70428281e-10,   1.90824078e-06,
         -8.96715173e-07,   1.20513413e-07,   1.20464995e-10,
         -1.66890778e-07,  -7.38141826e-11,   5.14962649e-11,
         -9.63326657e-08,  -1.29628318e-08,  -6.07123473e-07,
         -8.60388504e-07,   1.65490174e-06,   1.12129662e-06,
          1.32934441e-06,   8.35837508e-07],
       [ -1.43713142e-06,   3.98714694e-06,   8.53841338e-03,
          3.76032914e-06,  -1.68656923e-06,   3.52267858e-06,
          3.67727478e-03,   1.48303149e-06,  -5.39783606e-07,
         -3.12669176e-07,  -8.86942756e-08,  -9.63326657e-08,
          3.95298033e-04,  -1.21189159e-07,   5.74116375e-03,
          5.02813329e-03,  -2.86563705e-03,  -2.51119766e-03,
         -2.87021109e-03,  -2.51483557e-03],
       [  1.57466115e-07,  -1.75382771e-07,   1.07246641e-06,
         -8.53526519e-03,  -5.19456189e-07,  -2.83326628e-07,
          5.40039019e-07,  -3.67643509e-03,  -1.98386565e-07,
         -1.42623148e-08,   7.01170673e-08,  -1.29628318e-08,
         -1.21189159e-07,   3.95080656e-04,   8.23578717e-07,
          5.33199348e-07,  -4.96929575e-03,  -4.35370208e-03,
          4.96887321e-03,   4.35272056e-03],
       [ -3.08773590e-02,   5.74980355e-02,   1.23974681e-01,
         -2.93555943e-06,  -2.61612736e-05,   5.54292727e-02,
          5.33923910e-02,  -3.25738934e-06,  -8.35029726e-06,
         -4.81758070e-03,  -3.96288331e-06,  -6.07123473e-07,
          5.74116375e-03,   8.23578717e-07,   1.06264849e-01,
          8.35092385e-02,  -1.87395675e-02,  -2.59857755e-02,
         -1.87367225e-02,  -2.59825872e-02],
       [ -9.01609092e-03,   2.65584441e-02,   1.08591685e-01,
          2.21904123e-06,  -2.22189151e-05,   2.53175796e-02,
          4.67674998e-02,  -7.86785776e-07,  -7.10006110e-06,
         -2.21335669e-03,  -2.35976877e-06,  -8.60388504e-07,
          5.02813329e-03,   5.33199348e-07,   8.35092385e-02,
          6.87859339e-02,  -2.59802501e-02,  -2.71214278e-02,
         -2.59842819e-02,  -2.71224032e-02],
       [ -3.08741926e-02,   5.74895823e-02,  -6.19781824e-02,
          1.07345926e-01,   1.71028487e-05,   5.54287602e-02,
         -2.66937032e-02,   4.62386011e-02,   5.90082314e-06,
         -4.81694128e-03,  -2.91748775e-06,   1.65490174e-06,
         -2.86563705e-03,  -4.96929575e-03,  -1.87395675e-02,
         -2.59802501e-02,   1.06241995e-01,   8.35126972e-02,
         -1.87442153e-02,  -2.59899516e-02],
       [ -9.02073522e-03,   2.65650194e-02,  -5.42981422e-02,
          9.40486958e-02,   1.56796254e-05,   2.53306041e-02,
         -2.33858166e-02,   4.05109035e-02,   5.38369347e-06,
         -2.21396776e-03,  -1.44477690e-06,   1.12129662e-06,
         -2.51119766e-03,  -4.35370208e-03,  -2.59857755e-02,
         -2.71214278e-02,   8.35126972e-02,   6.88048799e-02,
         -2.59920793e-02,  -2.71322612e-02],
       [ -3.08764373e-02,   5.74958944e-02,  -6.19841631e-02,
         -1.07356839e-01,   4.04223826e-06,   5.54319972e-02,
         -2.66943130e-02,  -4.62413344e-02,   9.12439746e-07,
         -4.81819970e-03,  -1.15386617e-06,   1.32934441e-06,
         -2.87021109e-03,   4.96887321e-03,  -1.87367225e-02,
         -2.59842819e-02,  -1.87442153e-02,  -2.59920793e-02,
          1.06262084e-01,   8.35134647e-02],
       [ -9.01679170e-03,   2.65588245e-02,  -5.42953995e-02,
         -9.40435985e-02,   4.23652345e-06,   2.53221568e-02,
         -2.33829130e-02,  -4.05069785e-02,   1.01317479e-06,
         -2.21408861e-03,   1.00722927e-07,   8.35837508e-07,
         -2.51483557e-03,   4.35272056e-03,  -2.59825872e-02,
         -2.71224032e-02,  -2.59899516e-02,  -2.71322612e-02,
          8.35134647e-02,   6.87947015e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha', 'ref_result_exp_beta', 'ref_result_dm_beta']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_gga.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]