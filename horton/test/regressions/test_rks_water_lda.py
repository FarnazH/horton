# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_rks_water_lda():
    ref_result_dm_alpha = array([[  9.14224696e-02,   4.60615279e-02,  -1.85307320e-02,
          3.96710454e-02,   1.22225169e-01,  -9.13361582e-02,
          4.86321943e-07,   1.98749632e-02,   6.18970333e-02,
         -6.06919966e-02,  -6.94290231e-07,  -4.86578596e-03,
          7.65031137e-07,  -6.43805500e-07,  -3.65348775e-03,
         -8.89768595e-03,  -1.89752174e-02,  -1.91617701e-02],
       [  4.60615279e-02,   2.89590903e-02,   1.09455414e-02,
         -1.54322761e-02,   7.22138671e-02,  -5.54588767e-02,
         -6.35205932e-06,  -3.19898082e-02,   3.65705798e-02,
         -3.91549530e-02,  -5.78213548e-06,  -1.60664588e-03,
          3.68353042e-07,   7.20156417e-08,  -3.23606215e-03,
         -5.25694597e-03,  -1.91645367e-02,  -9.57642588e-03],
       [ -1.85307320e-02,   1.09455414e-02,   1.04053775e+00,
         -7.86077293e-02,  -6.87529417e-07,  -1.96963622e-02,
         -1.35593339e-09,  -1.45164867e-01,   2.80465415e-07,
         -1.61150802e-02,  -1.87182352e-07,   3.29388408e-03,
         -2.17578217e-07,   1.82051701e-07,  -3.90021689e-03,
          7.87569134e-08,  -1.85305749e-02,   1.09470423e-02],
       [  3.96710454e-02,  -1.54322761e-02,  -7.86077293e-02,
          2.40369583e-01,   5.93716867e-06,   3.92325789e-02,
         -3.60965768e-06,   2.75378929e-01,   1.72908149e-06,
          4.11905486e-02,  -2.38611739e-06,  -6.60891413e-03,
          4.83388652e-07,  -1.94208031e-07,   8.14702745e-03,
         -5.96933942e-07,   3.96667667e-02,  -1.54378202e-02],
       [  1.22225169e-01,   7.22138671e-02,  -6.87529417e-07,
          5.93716867e-06,   2.70634446e-01,  -4.74347825e-06,
          1.94205922e-06,  -4.70207674e-06,   1.37053082e-01,
          1.19571708e-06,   4.90699049e-07,   3.18310901e-07,
          1.29786351e-06,  -7.27553140e-07,  -1.72150302e-06,
         -1.97007380e-02,  -1.22221405e-01,  -7.22156407e-02],
       [ -9.13361582e-02,  -5.54588767e-02,  -1.96963622e-02,
          3.92325789e-02,  -4.74347825e-06,   3.29393779e-01,
         -2.81128176e-06,   1.30706465e-01,  -4.93558509e-06,
          2.29541985e-01,   9.48758711e-08,   1.13535015e-02,
         -2.46779216e-07,   9.88728719e-07,   1.78538928e-02,
          1.37905339e-06,  -9.13324087e-02,  -5.54732787e-02],
       [  4.86321943e-07,  -6.35205932e-06,  -1.35593339e-09,
         -3.60965768e-06,   1.94205922e-06,  -2.81128176e-06,
          4.08079300e-01,   8.99537825e-06,   1.56387804e-07,
         -2.20281781e-06,   3.27230699e-01,  -4.49215744e-07,
         -8.72047806e-07,  -2.29882342e-02,   2.29175435e-07,
         -8.42809108e-07,   2.93019033e-07,  -3.76195675e-06],
       [  1.98749632e-02,  -3.19898082e-02,  -1.45164867e-01,
          2.75378929e-01,  -4.70207674e-06,   1.30706465e-01,
          8.99537825e-06,   3.41056269e-01,  -4.47066511e-06,
          1.06242443e-01,   8.39592757e-06,  -4.34387309e-03,
          4.70731342e-07,  -7.28187886e-07,   1.37675410e-02,
          4.35285692e-07,   1.98802696e-02,  -3.19944138e-02],
       [  6.18970333e-02,   3.65705798e-02,   2.80465415e-07,
          1.72908149e-06,   1.37053082e-01,  -4.93558509e-06,
          1.56387804e-07,  -4.47066511e-06,   6.94056047e-02,
         -1.21692972e-06,  -4.14755806e-07,   1.07059765e-07,
          6.57257832e-07,  -3.21854714e-07,  -1.03417857e-06,
         -9.97673027e-03,  -6.18941432e-02,  -3.65705501e-02],
       [ -6.06919966e-02,  -3.91549530e-02,  -1.61150802e-02,
          4.11905486e-02,   1.19571708e-06,   2.29541985e-01,
         -2.20281781e-06,   1.06242443e-01,  -1.21692972e-06,
          1.60777339e-01,  -1.15861248e-07,   7.44685990e-03,
         -1.41954245e-07,   6.73700873e-07,   1.27936743e-02,
          6.16419820e-07,  -6.06933822e-02,  -3.91674125e-02],
       [ -6.94290231e-07,  -5.78213548e-06,  -1.87182352e-07,
         -2.38611739e-06,   4.90699049e-07,   9.48758711e-08,
          3.27230699e-01,   8.39592757e-06,  -4.14755806e-07,
         -1.15861248e-07,   2.62399809e-01,  -2.86930762e-07,
         -6.99284223e-07,  -1.84338092e-02,   3.16923353e-07,
         -5.98182072e-07,   1.14091777e-07,  -3.13609233e-06],
       [ -4.86578596e-03,  -1.60664588e-03,   3.29388408e-03,
         -6.60891413e-03,   3.18310901e-07,   1.13535015e-02,
         -4.49215744e-07,  -4.34387309e-03,   1.07059765e-07,
          7.44685990e-03,  -2.86930762e-07,   6.62160299e-04,
         -2.59133690e-08,   7.07912027e-08,   4.10811056e-04,
          2.21804330e-08,  -4.86613085e-03,  -1.60738729e-03],
       [  7.65031137e-07,   3.68353042e-07,  -2.17578217e-07,
          4.83388652e-07,   1.29786351e-06,  -2.46779216e-07,
         -8.72047806e-07,   4.70731342e-07,   6.57257832e-07,
         -1.41954245e-07,  -6.99284223e-07,  -2.59133690e-08,
          9.39229417e-12,   4.91201906e-08,  -2.28637656e-10,
         -9.44774131e-08,  -4.07245379e-07,  -3.24273733e-07],
       [ -6.43805500e-07,   7.20156417e-08,   1.82051701e-07,
         -1.94208031e-07,  -7.27553140e-07,   9.88728719e-07,
         -2.29882342e-02,  -7.28187886e-07,  -3.21854714e-07,
          6.73700873e-07,  -1.84338092e-02,   7.07912027e-08,
          4.91201906e-08,   1.29499073e-03,   1.93581110e-08,
          9.24791010e-08,  -7.45836845e-08,   2.55955085e-07],
       [ -3.65348775e-03,  -3.23606215e-03,  -3.90021689e-03,
          8.14702745e-03,  -1.72150302e-06,   1.78538928e-02,
          2.29175435e-07,   1.37675410e-02,  -1.03417857e-06,
          1.27936743e-02,   3.16923353e-07,   4.10811056e-04,
         -2.28637656e-10,   1.93581110e-08,   1.12227867e-03,
          1.73996374e-07,  -3.65193240e-03,  -3.23607043e-03],
       [ -8.89768595e-03,  -5.25694597e-03,   7.87569134e-08,
         -5.96933942e-07,  -1.97007380e-02,   1.37905339e-06,
         -8.42809108e-07,   4.35285692e-07,  -9.97673027e-03,
          6.16419820e-07,  -5.98182072e-07,   2.21804330e-08,
         -9.44774131e-08,   9.24791010e-08,   1.73996374e-07,
          1.43410820e-03,   8.89671525e-03,   5.25674849e-03],
       [ -1.89752174e-02,  -1.91645367e-02,  -1.85305749e-02,
          3.96667667e-02,  -1.22221405e-01,  -9.13324087e-02,
          2.93019033e-07,   1.98802696e-02,  -6.18941432e-02,
         -6.06933822e-02,   1.14091777e-07,  -4.86613085e-03,
         -4.07245379e-07,  -7.45836845e-08,  -3.65193240e-03,
          8.89671525e-03,   9.14198607e-02,   4.60659893e-02],
       [ -1.91617701e-02,  -9.57642588e-03,   1.09470423e-02,
         -1.54378202e-02,  -7.22156407e-02,  -5.54732787e-02,
         -3.76195675e-06,  -3.19944138e-02,  -3.65705501e-02,
         -3.91674125e-02,  -3.13609233e-06,  -1.60738729e-03,
         -3.24273733e-07,   2.55955085e-07,  -3.23607043e-03,
          5.25674849e-03,   4.60659893e-02,   2.89657664e-02]])
    ref_result_energy = -75.840493462941922
    ref_result_exp_alpha = array([[  1.10104686e-04,   1.39081331e-01,   2.34944736e-01,
         -1.29922124e-01,   4.84369020e-06,   1.11736091e-01,
         -1.14301455e-01,   8.41898176e-01,   7.33279348e-01,
          1.65419512e-04,   4.95914747e-01,   3.96426752e-03,
          1.68777349e-01,   6.67302896e-05,  -9.74653261e-02,
         -6.77081891e-06,   8.32360301e-01,  -9.60579112e-01],
       [  3.76288935e-03,   4.91649629e-03,   1.38812106e-01,
         -9.82439880e-02,   1.37535458e-05,   9.32827724e-01,
         -1.25456053e+00,  -6.31322136e-01,  -5.73657090e-01,
         -6.25783829e-05,  -7.35607188e-02,   9.64234488e-01,
          6.78620001e-01,   1.85781405e-05,  -4.93580379e-02,
          1.01335574e-05,   1.09382899e-01,   1.54976094e-02],
       [  9.94156911e-01,  -2.12460653e-01,   4.09704648e-07,
         -8.39658410e-02,   1.92532335e-06,   9.53761847e-02,
         -9.45703118e-06,  -1.15955768e-05,   3.48939045e-02,
          8.25711795e-06,   6.60158806e-02,   1.58092113e-07,
         -7.09381038e-02,  -5.16850154e-07,   6.85177666e-04,
         -2.77336724e-07,   1.74165630e-02,   5.96822325e-07],
       [  3.33311518e-02,   4.54377473e-01,   7.67390432e-06,
          1.81107291e-01,   1.37321515e-06,  -1.78562146e-01,
          3.04181509e-05,   7.05456700e-05,  -1.41362968e-01,
         -2.05256840e-06,  -3.63079234e-01,   1.09192743e-05,
          1.62305373e+00,   6.28330670e-05,  -1.34707414e-01,
          2.16859304e-05,   5.55152212e-01,  -4.25960296e-05],
       [  9.94363895e-09,   4.97686541e-06,   5.20225582e-01,
         -1.74868394e-06,   2.20358963e-06,   2.20946866e-05,
          4.35094836e-01,  -1.94023614e-01,  -3.39923756e-05,
          2.15158311e-05,   1.88810714e-05,   9.78383697e-01,
         -4.94233258e-06,   7.99576186e-06,   3.74923908e-06,
         -2.53051620e-06,  -5.80638824e-06,  -3.70320325e-02],
       [ -1.73490325e-03,  -1.35791348e-01,  -5.94454859e-06,
          5.57630451e-01,  -9.32351931e-06,   2.81467955e-01,
         -2.00436411e-05,  -9.84941396e-05,   6.52883023e-01,
          6.41722947e-05,  -7.08383508e-01,   2.36564827e-05,
         -1.81050960e-01,  -4.75508338e-06,   6.48808154e-03,
          8.18669320e-06,  -3.95855079e-02,   1.59892497e-05],
       [ -3.75079559e-08,   2.33112982e-07,   6.43895168e-06,
         -1.56656049e-05,  -6.38811020e-01,   8.39807587e-06,
          1.15520656e-07,   7.82323826e-06,   1.57470925e-04,
         -9.63280020e-01,   5.04023460e-05,   2.06221799e-05,
          2.51330452e-05,   1.90806721e-05,   3.44327539e-06,
         -7.63998052e-03,   6.35470107e-06,  -1.61524240e-06],
       [ -1.64907444e-02,   4.68398211e-01,  -1.23480427e-05,
          3.48406715e-01,  -2.24536677e-05,  -1.09441130e+00,
          6.73544419e-05,  -6.11085330e-05,   1.74777455e-01,
         -4.56368538e-05,  -3.01269622e-03,  -2.51090015e-05,
         -2.54395197e+00,  -1.23857213e-04,   2.69437774e-01,
         -4.01769773e-05,  -1.32657312e+00,   8.09856668e-05],
       [  3.93759320e-08,   1.60567516e-06,   2.63449472e-01,
         -5.65135161e-06,   2.41079167e-06,   6.81717274e-05,
          7.46726735e-01,  -4.36423003e-01,  -5.70368580e-05,
         -4.13002251e-05,  -3.56407613e-05,  -1.69471888e+00,
          2.01276864e-05,  -2.04073509e-05,  -9.53377646e-06,
          1.65971460e-05,   4.02170709e-05,   9.45136247e-01],
       [  2.83384728e-03,  -6.71164897e-02,   4.26929252e-06,
          3.95303213e-01,  -6.27035666e-06,   4.20589858e-01,
         -3.42523640e-05,   2.65207587e-05,  -3.43477992e-01,
          2.47734299e-05,   1.13308997e+00,  -1.79181598e-05,
          6.27292752e-01,   7.13299612e-05,  -1.50872602e-01,
          4.12089844e-06,   6.75997405e-01,  -4.35127838e-05],
       [  1.81524905e-08,  -3.27011250e-07,   3.11301939e-06,
         -8.47415357e-06,  -5.12249568e-01,  -1.78648148e-06,
         -3.03501951e-06,  -9.68697292e-06,  -1.70047769e-04,
          1.03557903e+00,  -5.77165386e-05,  -2.38893120e-05,
         -2.30900659e-05,  -2.42092337e-05,  -3.43326317e-06,
         -3.49674752e-02,  -5.45177937e-06,   1.38216161e-06],
       [  1.90790802e-04,  -2.06683944e-02,   8.61118297e-07,
          1.53277999e-02,   3.19776557e-07,   1.28650233e-02,
         -3.15667249e-07,   2.59051405e-05,  -1.33487522e-01,
         -2.29346251e-05,  -8.93793017e-02,   3.94539743e-06,
         -1.58244599e-01,  -2.02870687e-04,   4.73059154e-01,
          1.38768059e-05,   9.80674936e-01,  -2.67747039e-05],
       [  8.47174877e-09,   1.12987666e-06,   2.49479373e-06,
         -1.67332827e-07,   1.36513922e-06,  -2.41255877e-06,
          4.38275290e-06,   9.29351195e-07,  -1.67010954e-06,
         -2.10933643e-05,  -1.64481692e-07,   4.42516015e-06,
         -2.19359543e-06,  -9.99999898e-01,  -4.48008524e-04,
          4.76954469e-05,   8.70257973e-06,  -1.73927405e-05],
       [ -2.58470476e-09,  -1.35132967e-06,  -1.55094524e-06,
          2.04567902e-06,   3.59859721e-02,   3.74050714e-06,
         -6.74327460e-07,  -3.96633198e-06,   8.76210171e-06,
         -1.59394713e-02,  -5.34267920e-06,  -1.47480542e-06,
          1.14157472e-05,  -4.72797261e-05,   1.41903047e-05,
         -9.99225170e-01,   9.33864949e-06,   1.32463608e-05],
       [ -1.13467179e-04,   4.71891282e-03,  -3.24280128e-06,
          3.31662068e-02,  -1.17039444e-06,   1.02953822e-02,
         -6.22815362e-06,  -1.91512589e-05,   1.10297077e-01,
          2.84273494e-05,   1.07972450e-01,  -2.05921348e-06,
          1.81289410e-01,  -3.96506849e-04,   8.73787188e-01,
          9.74982899e-06,  -5.07582668e-01,   3.00087935e-05],
       [ -4.97259997e-08,  -1.36298533e-06,  -3.78696264e-02,
          1.73731135e-06,   9.37587267e-07,   2.36388210e-06,
         -1.71018846e-02,  -2.14105805e-01,  -2.99565215e-05,
         -9.18387199e-07,  -1.82038226e-05,  -2.60333925e-02,
         -1.20949473e-05,   2.16499536e-05,   2.01747990e-05,
         -1.58721877e-05,  -4.64744402e-05,  -1.27315591e+00],
       [  1.10138493e-04,   1.39079356e-01,  -2.34941035e-01,
         -1.29920890e-01,   4.10001650e-07,   1.11719410e-01,
          1.14235631e-01,  -8.42208002e-01,   7.32955834e-01,
          1.47862816e-04,   4.95867759e-01,  -3.96359215e-03,
          1.68832394e-01,   3.15611874e-05,  -9.74917784e-02,
          2.60884661e-05,   8.32431229e-01,   9.60515992e-01],
       [  3.76292753e-03,   4.92010455e-03,  -1.38816270e-01,
         -9.82718961e-02,   6.90128679e-06,   9.33052181e-01,
          1.25445365e+00,   6.31540284e-01,  -5.73351785e-01,
         -9.04826088e-05,  -7.35155547e-02,  -9.64213467e-01,
          6.78592199e-01,   2.20577986e-05,  -4.93511173e-02,
          6.49478131e-06,   1.09392920e-01,  -1.55233317e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_lda.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]