# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_rks_water_hybgga():
    ref_result_dm_alpha = array([[  9.65389324e-02,   4.58311099e-02,  -1.85097065e-02,
          4.05441623e-02,   1.24295931e-01,  -9.41093390e-02,
         -1.82215776e-06,   1.91029345e-02,   6.34677247e-02,
         -6.24646805e-02,  -2.05429278e-06,  -4.94387287e-03,
          6.57255707e-07,  -2.06148527e-07,  -3.49563941e-03,
         -9.52658654e-03,  -1.97152101e-02,  -1.88702933e-02],
       [  4.58311099e-02,   2.74110719e-02,   1.05223261e-02,
         -1.67239038e-02,   6.91776366e-02,  -5.44119094e-02,
          8.84626959e-07,  -3.20469359e-02,   3.53233562e-02,
         -3.81293555e-02,   3.65683232e-07,  -1.65006393e-03,
          3.11154092e-07,  -1.50302109e-07,  -2.92364371e-03,
         -5.30210044e-03,  -1.88708191e-02,  -8.59886948e-03],
       [ -1.85097065e-02,   1.05223261e-02,   1.04154604e+00,
         -8.54282792e-02,  -7.29876029e-08,  -2.02292802e-02,
          8.42610763e-08,  -1.39029835e-01,   4.35721516e-08,
         -1.60238448e-02,   7.72167516e-08,   2.87499582e-03,
         -1.29059355e-07,   1.58787413e-07,  -3.53278065e-03,
         -7.05018252e-08,  -1.85096401e-02,   1.05224933e-02],
       [  4.05441623e-02,  -1.67239038e-02,  -8.54282792e-02,
          2.49967338e-01,   4.40244258e-07,   4.28394405e-02,
         -5.47572145e-07,   2.77252633e-01,   2.36072050e-08,
          4.19940322e-02,  -3.77932651e-07,  -5.77167904e-03,
          2.87056330e-07,  -3.63173033e-07,   7.59072332e-03,
          1.41621766e-07,   4.05437698e-02,  -1.67244301e-02],
       [  1.24295931e-01,   6.91776366e-02,  -7.29876029e-08,
          4.40244258e-07,   2.65788179e-01,   1.89848833e-08,
          7.46415218e-07,   6.62901557e-08,   1.35715645e-01,
         -4.51482874e-08,   1.48532839e-07,   1.12764479e-08,
          8.81487302e-07,  -3.70587846e-07,  -3.45871878e-07,
         -2.03709888e-02,  -1.24295847e-01,  -6.91782783e-02],
       [ -9.41093390e-02,  -5.44119094e-02,  -2.02292802e-02,
          4.28394405e-02,   1.89848833e-08,   3.28543831e-01,
         -1.90483407e-06,   1.30592433e-01,  -9.48100476e-07,
          2.27340198e-01,  -1.59205280e-07,   1.17263900e-02,
         -5.80761214e-07,   3.04641669e-07,   1.63377755e-02,
          3.95081254e-07,  -9.41089820e-02,  -5.44146240e-02],
       [ -1.82215776e-06,   8.84626959e-07,   8.42610763e-08,
         -5.47572145e-07,   7.46415218e-07,  -1.90483407e-06,
          4.13897782e-01,  -1.02236087e-06,   1.57314353e-06,
          9.71371176e-07,   3.26449895e-01,  -3.12443452e-07,
         -5.55535969e-07,  -2.21146619e-02,   4.66169950e-07,
         -1.30684785e-06,   1.16216895e-07,   2.92867512e-06],
       [  1.91029345e-02,  -3.20469359e-02,  -1.39029835e-01,
          2.77252633e-01,   6.62901557e-08,   1.30592433e-01,
         -1.02236087e-06,   3.30815857e-01,  -4.27941305e-07,
          1.03425229e-01,  -4.03723545e-07,  -3.16044360e-03,
          1.57227948e-07,  -3.12208624e-07,   1.23371278e-02,
          2.84627225e-07,   1.91029894e-02,  -3.20479856e-02],
       [  6.34677247e-02,   3.53233562e-02,   4.35721516e-08,
          2.36072050e-08,   1.35715645e-01,  -9.48100476e-07,
          1.57314353e-06,  -4.27941305e-07,   6.92985532e-02,
         -6.89669771e-07,   1.01600439e-06,  -2.61534278e-08,
          4.50101328e-07,  -2.52917977e-07,  -2.25937230e-07,
         -1.04017488e-02,  -6.34671662e-02,  -3.53233606e-02],
       [ -6.24646805e-02,  -3.81293555e-02,  -1.60238448e-02,
          4.19940322e-02,  -4.51482874e-08,   2.27340198e-01,
          9.71371176e-07,   1.03425229e-01,  -6.89669771e-07,
          1.57939812e-01,   1.68955716e-06,   7.74765649e-03,
         -3.83623465e-07,   6.73776777e-08,   1.15796560e-02,
          2.84070545e-07,  -6.24643804e-02,  -3.81312008e-02],
       [ -2.05429278e-06,   3.65683232e-07,   7.72167516e-08,
         -3.77932651e-07,   1.48532839e-07,  -1.59205280e-07,
          3.26449895e-01,  -4.03723545e-07,   1.01600439e-06,
          1.68955716e-06,   2.57477905e-01,  -1.94811420e-07,
         -4.38166932e-07,  -1.74422994e-02,   4.31729060e-07,
         -9.96999786e-07,  -1.13753295e-07,   2.20699176e-06],
       [ -4.94387287e-03,  -1.65006393e-03,   2.87499582e-03,
         -5.77167904e-03,   1.12764479e-08,   1.17263900e-02,
         -3.12443452e-07,  -3.16044360e-03,  -2.61534278e-08,
          7.74765649e-03,  -1.94811420e-07,   6.37888768e-04,
         -3.16125049e-08,   3.64859719e-08,   4.19251040e-04,
          9.58460493e-09,  -4.94386915e-03,  -1.65016802e-03],
       [  6.57255707e-07,   3.11154092e-07,  -1.29059355e-07,
          2.87056330e-07,   8.81487302e-07,  -5.80761214e-07,
         -5.55535969e-07,   1.57227948e-07,   4.50101328e-07,
         -3.83623465e-07,  -4.38166932e-07,  -3.16125049e-08,
          5.23599565e-12,   2.96803470e-08,  -2.07479644e-08,
         -6.75592858e-08,  -1.67203926e-07,  -1.47702120e-07],
       [ -2.06148527e-07,  -1.50302109e-07,   1.58787413e-07,
         -3.63173033e-07,  -3.70587846e-07,   3.04641669e-07,
         -2.21146619e-02,  -3.12208624e-07,  -2.52917977e-07,
          6.73776777e-08,  -1.74422994e-02,   3.64859719e-08,
          2.96803470e-08,   1.18159191e-03,  -2.42011202e-08,
          9.51718233e-08,  -4.05997776e-10,  -8.73686607e-08],
       [ -3.49563941e-03,  -2.92364371e-03,  -3.53278065e-03,
          7.59072332e-03,  -3.45871878e-07,   1.63377755e-02,
          4.66169950e-07,   1.23371278e-02,  -2.25937230e-07,
          1.15796560e-02,   4.31729060e-07,   4.19251040e-04,
         -2.07479644e-08,  -2.42011202e-08,   9.34901380e-04,
          4.89956309e-08,  -3.49529795e-03,  -2.92359691e-03],
       [ -9.52658654e-03,  -5.30210044e-03,  -7.05018252e-08,
          1.41621766e-07,  -2.03709888e-02,   3.95081254e-07,
         -1.30684785e-06,   2.84627225e-07,  -1.04017488e-02,
          2.84070545e-07,  -9.96999786e-07,   9.58460493e-09,
         -6.75592858e-08,   9.51718233e-08,   4.89956309e-08,
          1.56130791e-03,   9.52640653e-03,   5.30200844e-03],
       [ -1.97152101e-02,  -1.88708191e-02,  -1.85096401e-02,
          4.05437698e-02,  -1.24295847e-01,  -9.41089820e-02,
          1.16216895e-07,   1.91029894e-02,  -6.34671662e-02,
         -6.24643804e-02,  -1.13753295e-07,  -4.94386915e-03,
         -1.67203926e-07,  -4.05997776e-10,  -3.49529795e-03,
          9.52640653e-03,   9.65386263e-02,   4.58321142e-02],
       [ -1.88702933e-02,  -8.59886948e-03,   1.05224933e-02,
         -1.67244301e-02,  -6.91782783e-02,  -5.44146240e-02,
          2.92867512e-06,  -3.20479856e-02,  -3.53233606e-02,
         -3.81312008e-02,   2.20699176e-06,  -1.65016802e-03,
         -1.47702120e-07,  -8.73686607e-08,  -2.92359691e-03,
          5.30200844e-03,   4.58321142e-02,   2.74122973e-02]])
    ref_result_energy = -76.406160976247307
    ref_result_exp_alpha = array([[ -1.90421602e-04,  -1.39559085e-01,   2.41095391e-01,
         -1.37605126e-01,  -8.51629072e-06,  -1.01233351e-01,
         -9.56954275e-02,  -8.47809793e-01,  -8.13618685e-01,
          5.62574239e-05,   3.56372527e-01,   1.22492455e-03,
         -1.74410627e-01,   2.04742405e-04,   9.07738372e-02,
         -5.47949982e-06,   8.28665446e-01,  -9.55971678e-01],
       [ -3.04377878e-03,  -1.01291078e-03,   1.34183074e-01,
         -9.69313376e-02,  -2.16000335e-06,  -9.50512960e-01,
         -1.28957856e+00,   6.04547614e-01,   5.61048454e-01,
         -3.93704381e-05,   1.50017852e-02,   9.35476441e-01,
         -6.68562903e-01,   8.49324177e-05,   4.64249944e-02,
          2.44643692e-05,   1.10741011e-01,   1.16531687e-02],
       [ -9.95040948e-01,   2.12402371e-01,  -1.51438654e-07,
         -7.95285287e-02,  -1.45319847e-06,  -9.21841101e-02,
         -7.93896414e-07,   1.71600334e-06,  -4.74982604e-02,
         -3.89083182e-06,   5.72836814e-02,  -7.71784296e-07,
          6.81091439e-02,   1.62574542e-07,  -5.71305783e-04,
         -2.21748902e-06,   1.80398162e-02,  -5.83785417e-07],
       [ -2.79245020e-02,  -4.66264314e-01,   8.42402014e-07,
          1.78283904e-01,   2.79563931e-06,   1.57363602e-01,
          1.99290636e-06,  -3.07248237e-06,   2.07030340e-01,
          4.67926962e-05,  -3.48596478e-01,   2.28418823e-05,
         -1.61931386e+00,   2.44371203e-04,   1.27038203e-01,
          3.39325132e-05,   5.54328220e-01,   3.25252279e-07],
       [ -8.18300211e-09,  -1.08531197e-07,   5.15546486e-01,
         -2.51115050e-07,  -2.93989873e-06,  -2.67142055e-06,
          4.08545105e-01,   2.04426654e-01,   5.82666251e-06,
          1.19011367e-05,  -3.62248567e-06,   9.90115024e-01,
          1.51058455e-05,   2.99058300e-06,  -5.29916524e-06,
          9.23862595e-06,  -2.64212927e-07,  -3.71223305e-02],
       [  1.64616881e-03,   1.22155254e-01,   3.35972067e-07,
          5.60017155e-01,   1.15173001e-05,  -2.66168137e-01,
          7.89396186e-07,   5.38362160e-06,  -5.25111305e-01,
          1.11087925e-04,  -8.10302134e-01,  -4.97050580e-06,
          1.94089081e-01,  -1.86647187e-05,  -6.31243490e-03,
         -1.71179075e-05,  -4.04853993e-02,   2.28451318e-06],
       [  2.18191221e-08,  -1.22702063e-06,   5.11657377e-06,
         -1.63650869e-05,   6.43348880e-01,   6.09121057e-06,
         -1.22737554e-07,  -3.26369148e-05,  -6.89508860e-05,
         -9.60255870e-01,  -9.52546650e-05,   1.73594908e-05,
         -1.57998809e-05,  -4.11959034e-06,  -5.02392471e-06,
          7.56187805e-03,   7.01105070e-07,  -3.93896961e-06],
       [  1.31928791e-02,  -4.67290691e-01,   1.93665275e-07,
          3.35083893e-01,   6.04318949e-06,   1.12257894e+00,
          7.02201396e-06,  -7.30701031e-06,  -1.49791012e-01,
         -2.54729526e-05,   5.40539006e-03,  -3.77213203e-05,
          2.53678727e+00,  -5.02001091e-04,  -2.53249468e-01,
         -4.65957607e-05,  -1.32685415e+00,   5.71962560e-06],
       [  3.78415667e-09,  -2.61268486e-07,   2.63246184e-01,
         -1.79327814e-06,   3.51639035e-07,  -3.85742345e-06,
          7.77188946e-01,   4.62410287e-01,   7.78920606e-06,
         -4.84545629e-05,   6.31885872e-06,  -1.67581765e+00,
         -2.12222557e-05,  -4.82424590e-06,   3.68631486e-06,
         -1.48568298e-05,   7.55486230e-06,   9.41974953e-01],
       [ -2.42463672e-03,   6.02781542e-02,   1.17007281e-07,
          3.92810994e-01,   1.16168628e-05,  -4.38279538e-01,
         -5.61633376e-06,   1.05265690e-05,   1.24522912e-01,
         -1.16234176e-04,   1.16845997e+00,   1.29375795e-05,
         -6.38482318e-01,   2.99086051e-04,   1.41926458e-01,
          1.65257531e-05,   6.73897662e-01,  -7.79692898e-06],
       [ -1.41087034e-08,  -2.26328580e-07,   3.18172431e-06,
         -1.06706230e-05,   5.07422807e-01,  -4.56969224e-06,
         -1.75839286e-06,   3.50609032e-05,   7.17670178e-05,
          1.03801059e+00,   1.00700587e-04,  -1.93509637e-05,
          1.83290464e-05,   6.45503020e-06,   7.93631788e-06,
          3.32026751e-02,   5.70421749e-07,   2.65206451e-06],
       [ -2.15688824e-04,   1.88278859e-02,   3.38827351e-08,
          1.68330912e-02,  -2.15292743e-08,  -1.32420523e-02,
         -1.57022401e-07,  -4.68942653e-06,   1.44445239e-01,
         -3.99137122e-06,  -6.18495918e-02,  -5.19401018e-06,
          1.60755899e-01,  -9.41848551e-04,  -4.74659434e-01,
          1.22557672e-05,   9.80069881e-01,  -1.00007204e-05],
       [ -3.08780032e-09,  -9.34075736e-07,   1.70981767e-06,
         -8.33268909e-07,  -8.63113248e-07,   1.50598333e-06,
          2.71276100e-06,   2.60454690e-06,   5.51101321e-07,
          4.27781997e-06,   7.82571975e-06,   1.51018494e-07,
          1.24933757e-05,  -9.99997950e-01,   2.02342435e-03,
          7.33484587e-05,   1.73839278e-05,  -8.85377491e-06],
       [  1.44696325e-08,   9.69371062e-07,  -9.14846029e-07,
          1.03946775e-06,  -3.43742914e-02,  -2.55754421e-06,
         -1.63670625e-06,  -4.31808801e-06,  -9.09629733e-06,
         -1.51606693e-02,  -1.03105224e-05,  -6.96385102e-06,
          2.69216431e-05,   7.33563617e-05,   4.66732542e-05,
          9.99294028e-01,   6.31936624e-06,   6.33148709e-06],
       [  1.24887946e-04,  -4.73732559e-03,  -6.56791959e-07,
          3.02066802e-02,   1.48393521e-06,  -8.95960229e-03,
         -1.27734048e-06,   1.25425716e-06,  -1.23133579e-01,
          8.72972407e-06,   8.12412176e-02,  -3.27008347e-07,
         -1.77952347e-01,  -1.77860876e-03,  -8.73784111e-01,
          4.88184083e-05,  -5.10995037e-01,   4.03337004e-06],
       [ -1.91329386e-09,  -8.87426904e-08,  -3.95133889e-02,
          7.48914939e-07,  -1.71704955e-06,   2.98620609e-07,
         -1.97817769e-02,   2.06386897e-01,   5.84940699e-06,
         -3.53358643e-06,  -5.62207718e-06,  -2.52178530e-02,
         -3.10703939e-06,   1.16977616e-05,   1.00153966e-06,
          8.60837258e-06,  -1.23698002e-05,  -1.27435767e+00],
       [ -1.90419770e-04,  -1.39558785e-01,  -2.41095421e-01,
         -1.37604264e-01,  -1.66841746e-06,  -1.01231868e-01,
          9.56887153e-02,   8.47861944e-01,  -8.13576518e-01,
         -7.31402988e-06,   3.56363545e-01,  -1.21529353e-03,
         -1.74401073e-01,   1.91911484e-04,   9.07671150e-02,
         -1.11388581e-05,   8.28681486e-01,   9.55954145e-01],
       [ -3.04377607e-03,  -1.01397126e-03,  -1.34184413e-01,
         -9.69357919e-02,   3.15160517e-06,  -9.50528791e-01,
          1.28956893e+00,  -6.04569270e-01,   5.61010679e-01,
         -3.03114689e-05,   1.50262579e-02,  -9.35457941e-01,
         -6.68594766e-01,   8.82613815e-05,   4.64338062e-02,
          1.06479699e-05,   1.10741987e-01,  -1.16512072e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_hybgga.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]