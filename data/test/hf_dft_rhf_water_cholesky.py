# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_energy = -76.025896285286294
    ref_result_exp_alpha = array([[  2.39212011e-04,  -1.89883827e-01,  -3.30390705e-01,
          1.97955811e-01,   7.58166249e-16,   6.55324066e-02,
          2.29432589e-02,   9.41572574e-01,  -8.20802446e-01,
         -4.87897161e-01,  -1.13040253e-15,  -4.01586063e-01,
          1.20655222e-16,   2.50922291e-01,   4.06137087e-16,
          7.99595707e-01,   4.40867756e-01,   3.20420250e-01,
          4.90419665e-01,  -5.40745390e-16,   6.63773776e-19,
         -3.94726243e-01,   1.18718552e+00,  -1.08035914e+00],
       [ -4.32572773e-04,  -1.04963020e-02,  -8.66641918e-02,
          4.08656036e-02,   5.38795273e-16,   8.31794088e-01,
          1.41669907e+00,  -6.72215237e-01,   5.43060132e-01,
         -1.38015229e-01,   2.30663105e-15,  -8.04098744e-01,
         -2.09985579e-15,  -2.44988441e-01,   2.40398493e-16,
          3.80322743e-01,   1.08239360e-01,   3.28714732e-01,
          1.61718077e-01,  -1.50705470e-16,  -2.20687055e-16,
         -6.18489485e-02,   1.87142471e-01,  -2.85716169e-01],
       [ -5.77608140e-04,   3.81191121e-02,   2.54719522e-02,
         -3.04392676e-02,   2.24810784e-16,  -1.79716016e-02,
         -2.14968901e-02,   7.49821881e-02,  -2.81137898e-01,
          1.15797612e-01,  -7.69998443e-16,   3.29072939e-01,
         -7.06031951e-16,  -2.62206258e-01,  -1.45015729e-15,
         -3.99080940e-01,   4.55175728e-01,  -7.06755898e-01,
         -7.87257818e-01,  -1.34166189e-16,   1.98596515e-16,
          4.07141697e-01,  -6.18547970e-01,   6.19074047e-01],
       [  4.52857394e-04,  -1.84182538e-02,  -3.15693511e-02,
         -9.26040670e-03,   8.88340682e-17,   1.58153274e-02,
          1.69754644e-02,  -1.65267471e-01,   3.29737110e-02,
         -2.40145039e-01,  -5.52692544e-16,  -1.51908055e-01,
         -3.06246146e-15,  -5.75974841e-01,  -1.14501988e-15,
         -1.05830944e-01,   6.78858725e-01,   5.75488442e-01,
          4.83278551e-01,  -3.73713798e-16,   8.84650681e-17,
          2.82220232e-01,   5.04839745e-01,  -4.43462305e-01],
       [ -4.80747862e-17,  -7.15960507e-17,  -9.56142148e-17,
         -1.07990383e-16,   3.06581514e-02,  -8.00287593e-17,
         -8.38125644e-17,   4.22117189e-17,  -2.52015745e-16,
         -4.13882989e-16,   9.35814587e-03,  -9.75279547e-16,
          6.81789337e-01,  -3.78856613e-15,  -7.73413856e-01,
          1.00509999e-15,  -1.72683348e-15,   3.21165453e-16,
         -6.19069772e-17,  -3.83881853e-01,  -3.75620839e-01,
          1.29007647e-16,  -4.75163043e-17,  -1.26302085e-16],
       [ -1.00089928e+00,   8.60224724e-03,  -1.52989772e-15,
          1.82119440e-03,   6.48018576e-17,   5.24208008e-02,
          2.81232617e-15,   8.16907903e-15,   5.60218193e-02,
         -9.20793268e-03,  -1.61684831e-16,  -1.68304511e-14,
         -1.76466573e-15,  -2.54309323e-01,   6.71311030e-16,
          7.09136318e-01,  -8.99595937e-14,  -1.45972192e-13,
         -2.70588795e-01,  -1.79353903e-16,   3.93119529e-17,
         -8.89618355e-02,   1.27463899e-01,   1.48894060e-14],
       [ -1.18024915e-03,  -4.43375104e-01,  -1.72267665e-15,
         -1.43979779e-01,  -1.59618562e-16,  -7.52403997e-02,
          1.33409426e-14,   3.53448277e-14,   2.39577419e-01,
          7.68597206e-02,  -3.94743649e-17,  -3.97108217e-14,
         -4.23613336e-15,  -6.40338270e-01,   1.41255584e-15,
          1.55970667e+00,  -1.96293828e-13,  -3.77442231e-13,
         -7.16134723e-01,  -4.37022735e-16,  -2.02757621e-16,
         -1.52655149e-01,   1.45669671e-01,   2.32725912e-14],
       [  2.69108321e-03,  -3.81695970e-01,   1.29187129e-14,
         -3.34223198e-01,  -1.66457866e-15,  -1.01110117e+00,
          1.30107703e-14,  -3.79889943e-14,  -2.44019994e-01,
          7.66390617e-01,   4.26753885e-15,   6.08805854e-14,
          5.52832949e-15,   7.75668346e-01,  -2.64738612e-15,
         -2.94651504e+00,   3.91059567e-13,  -3.03789212e-13,
         -8.20324022e-01,   1.17437444e-15,  -1.47043874e-16,
          7.42995700e-01,  -2.18275064e+00,  -1.85587591e-13],
       [ -5.33623970e-16,   1.42323857e-15,  -4.86982077e-01,
         -5.72273075e-15,   1.61837170e-16,  -1.41758941e-14,
         -2.81441727e-01,  -2.85091585e-01,   3.95573565e-14,
         -1.31764706e-14,   2.64762078e-15,  -7.16966622e-01,
         -7.10002293e-16,   7.43391366e-15,  -3.31000290e-16,
         -3.43991676e-14,   8.34989717e-02,  -8.55558952e-01,
          3.91710651e-13,  -1.47243670e-17,   1.94150434e-16,
          4.25703824e-16,  -2.55868610e-14,   4.65780754e-01],
       [  1.70185486e-03,   7.41752374e-02,   6.57724666e-15,
         -5.51448344e-01,  -1.76323842e-15,   1.85785970e-01,
         -8.07381970e-15,  -4.59486298e-14,  -2.87661523e-01,
          7.82903526e-01,   3.71070311e-15,  -1.63625319e-14,
         -8.59753355e-16,  -1.55521294e-01,  -3.52750523e-16,
          8.92761892e-02,  -1.05297344e-14,   2.92338276e-13,
          6.34232206e-01,   2.64145898e-16,   7.38171324e-17,
         -5.98982263e-02,   3.84858369e-01,   2.83044174e-14],
       [  6.79023545e-17,  -5.70296753e-17,  -8.11420556e-17,
         -1.96119382e-15,   6.30569887e-01,   1.13405369e-16,
         -6.62481053e-17,  -1.94973950e-16,   1.28371566e-16,
          4.50427026e-15,  -9.68286245e-01,  -3.60682672e-15,
         -3.75882329e-15,   1.76413693e-16,   1.61180508e-02,
         -2.52408364e-16,  -8.62225617e-17,   5.41020839e-17,
         -3.92469238e-17,  -1.23591816e-02,  -1.83917959e-16,
          1.84621081e-16,  -3.00738817e-16,   1.58335355e-16],
       [ -4.99220930e-16,  -1.20796347e-15,  -2.14151329e-01,
         -3.11179162e-15,  -7.48095076e-16,  -4.03561313e-14,
         -6.76908819e-01,  -4.49435434e-01,   6.87113608e-14,
          3.24841830e-14,  -6.44511380e-15,   1.78060305e+00,
          1.88768486e-15,  -7.96039715e-15,   1.34068558e-15,
         -1.06149350e-13,  -1.00292348e+00,  -2.22943620e-01,
          9.62430778e-14,   2.40055096e-16,   2.02246268e-17,
          8.29811097e-15,  -7.21742675e-14,   1.17564056e+00],
       [ -4.84472294e-04,  -1.09493182e-02,   8.34215369e-16,
         -3.79162629e-01,  -9.74337469e-16,   3.26081793e-01,
         -2.24938784e-15,  -2.03589915e-15,  -4.78632441e-02,
         -1.25153187e+00,  -6.05241025e-15,   1.97145829e-15,
          2.72508312e-15,   6.61451466e-01,   1.42527061e-15,
          9.57206234e-01,  -1.31289344e-13,   7.29963833e-14,
          2.00361826e-01,  -7.05765959e-16,  -9.72034050e-17,
         -5.95172492e-01,   8.02033145e-01,   7.02060284e-14],
       [  2.36527464e-17,  -5.99492139e-17,   1.26979121e-17,
         -1.56441777e-15,   4.96823587e-01,  -5.59093209e-17,
         -1.18452004e-16,   7.19438639e-17,  -1.39872818e-16,
         -4.33590920e-15,   1.02382314e+00,   3.96944202e-15,
          2.83010735e-15,  -2.29993100e-16,   6.38237891e-01,
         -3.44652729e-16,   1.00634723e-15,  -2.67377945e-16,
          2.52358203e-16,   3.00004627e-01,   6.83497624e-16,
         -1.64019830e-16,   1.01820913e-16,  -2.11178516e-16],
       [  1.24287190e-04,   3.25736642e-03,  -5.40181799e-16,
         -1.27674769e-02,  -1.76514806e-16,   1.18447829e-02,
          1.44078895e-15,   1.26431740e-14,   8.86425288e-02,
         -7.58234274e-03,   8.97690018e-17,  -8.02972945e-16,
         -2.12000698e-16,  -5.62152072e-02,  -2.70745397e-17,
         -1.51968802e-01,   2.03225153e-14,  -8.32463951e-14,
         -2.17424431e-01,   9.40210248e-17,  -9.16885114e-17,
         -5.36948806e-01,   1.00258669e+00,   7.06324201e-14],
       [ -1.29996088e-16,  -3.68600340e-18,  -1.21911145e-17,
         -8.51477309e-18,  -2.36547232e-16,  -1.36828315e-17,
          1.74750126e-17,  -1.38799733e-16,  -1.20698105e-16,
          3.61111701e-17,  -5.51858817e-16,  -2.29443245e-16,
          1.30048809e-01,  -5.43155940e-16,   7.46468054e-16,
          1.39337764e-16,  -2.08372108e-16,   4.40865097e-16,
         -2.71522314e-16,  -1.98817157e-15,   1.07007327e+00,
         -1.57553657e-16,  -1.43906795e-17,   1.72963521e-17],
       [ -2.56299504e-18,   3.68602367e-18,   3.94050339e-18,
          3.70624965e-17,  -1.76424605e-02,   1.22692368e-17,
          5.15340412e-18,  -7.25230735e-18,   2.74740894e-17,
          3.01651801e-16,   3.44948939e-03,   1.54151470e-17,
         -5.67383374e-16,   1.05147819e-17,   1.60741448e-01,
         -3.57847654e-16,   1.50931817e-16,  -3.57261629e-17,
          2.01119974e-17,  -1.03615633e+00,  -2.32627184e-15,
         -5.33867198e-17,   6.32588569e-17,  -1.53501727e-17],
       [ -9.24107693e-05,  -1.14206720e-03,   5.53917762e-16,
         -1.25450842e-02,   2.30120250e-16,   1.44837623e-04,
         -7.07952748e-16,  -9.27437983e-15,  -6.23611587e-02,
         -7.18581345e-03,  -3.66760902e-16,   1.43344934e-15,
         -5.92300290e-16,  -1.03057022e-01,  -9.45562751e-17,
         -5.61950947e-02,   7.39555067e-15,   2.55401001e-14,
          5.00233496e-02,   2.99519997e-17,  -1.10404098e-16,
         -9.34448243e-01,  -6.49643037e-01,  -3.31602120e-14],
       [  6.67549434e-16,   4.56929456e-16,   2.58319906e-02,
          3.40620140e-16,  -1.37034853e-16,   2.80700073e-15,
          2.13253061e-02,  -1.11798416e-01,   1.65657697e-14,
         -2.76650016e-15,   1.11474511e-16,  -3.99324047e-02,
          1.10207395e-17,  -1.87341077e-15,  -7.32741372e-17,
          3.55574195e-15,  -2.57347148e-02,  -1.43240599e-01,
          7.00929785e-14,  -6.28223322e-18,   4.02952132e-17,
         -1.56685264e-14,   8.88603175e-14,  -1.31091341e+00],
       [  2.39212011e-04,  -1.89883827e-01,   3.30390705e-01,
          1.97955811e-01,   3.62719959e-16,   6.55324066e-02,
         -2.29432589e-02,  -9.41572574e-01,  -8.20802446e-01,
         -4.87897161e-01,  -3.87406243e-15,   4.01586063e-01,
          8.34791021e-16,   2.50922291e-01,   1.43207570e-15,
          7.99595707e-01,  -4.40867756e-01,  -3.20420250e-01,
          4.90419665e-01,  -3.79051954e-16,  -2.62754344e-16,
         -3.94726243e-01,   1.18718552e+00,   1.08035914e+00],
       [ -4.32572773e-04,  -1.04963020e-02,   8.66641918e-02,
          4.08656036e-02,   1.70898032e-16,   8.31794088e-01,
         -1.41669907e+00,   6.72215237e-01,   5.43060132e-01,
         -1.38015229e-01,  -3.71308649e-15,   8.04098744e-01,
         -2.43595345e-16,  -2.44988441e-01,   2.90858458e-16,
          3.80322743e-01,  -1.08239360e-01,  -3.28714732e-01,
          1.61718077e-01,  -1.11029476e-16,   5.52974742e-16,
         -6.18489485e-02,   1.87142471e-01,   2.85716169e-01],
       [  5.77608140e-04,  -3.81191121e-02,   2.54719522e-02,
          3.04392676e-02,   8.87327814e-16,   1.79716016e-02,
         -2.14968901e-02,   7.49821881e-02,   2.81137898e-01,
         -1.15797612e-01,  -1.75142728e-15,   3.29072939e-01,
          1.99819971e-15,   2.62206258e-01,  -9.20922347e-16,
          3.99080940e-01,   4.55175728e-01,  -7.06755898e-01,
          7.87257818e-01,  -3.86027468e-16,   5.37288042e-16,
         -4.07141697e-01,   6.18547970e-01,   6.19074047e-01],
       [  4.52857394e-04,  -1.84182538e-02,   3.15693511e-02,
         -9.26040670e-03,  -3.57870989e-16,   1.58153274e-02,
         -1.69754644e-02,   1.65267471e-01,   3.29737110e-02,
         -2.40145039e-01,  -1.84839971e-15,   1.51908055e-01,
         -3.02211616e-15,  -5.75974841e-01,   1.03756920e-15,
         -1.05830944e-01,  -6.78858725e-01,  -5.75488442e-01,
          4.83278551e-01,   2.16678314e-16,   4.89432581e-16,
          2.82220232e-01,   5.04839745e-01,   4.43462305e-01],
       [  7.98265386e-17,   4.79789293e-19,  -4.47737995e-18,
         -8.47889127e-17,   3.06581514e-02,   1.13484782e-17,
         -1.02856405e-17,   1.10886810e-16,   1.73436274e-16,
         -2.15236538e-16,   9.35814587e-03,   6.23631947e-16,
         -6.81789337e-01,   3.74668146e-15,  -7.73413856e-01,
          1.42132075e-16,  -1.35692552e-15,   3.42851400e-16,
         -2.26557779e-16,  -3.83881853e-01,   3.75620839e-01,
         -5.90360326e-17,   3.74387059e-17,   1.47679472e-18]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rhf_water_cholesky.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
