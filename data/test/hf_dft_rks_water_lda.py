# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_dm_alpha = array([[  9.14202319e-02,   4.60679814e-02,  -1.85307725e-02,
          3.96696155e-02,   1.22221686e-01,  -9.13353431e-02,
         -1.59459391e-07,   1.98772489e-02,   6.18922328e-02,
         -6.06919651e-02,   8.43352532e-07,  -4.86580670e-03,
         -2.64265264e-07,   6.59314519e-07,  -3.65276338e-03,
         -8.89707876e-03,  -1.89746204e-02,  -1.91673663e-02],
       [  4.60679814e-02,   2.89674028e-02,   1.09458332e-02,
         -1.54340513e-02,   7.22224370e-02,  -5.54689246e-02,
          4.94969298e-06,  -3.19915597e-02,   3.65730162e-02,
         -3.91624272e-02,   4.53525519e-06,  -1.60699048e-03,
         -5.40167958e-08,   1.38468443e-07,  -3.23600234e-03,
         -5.25744757e-03,  -1.91658391e-02,  -9.58108454e-03],
       [ -1.85307725e-02,   1.09458332e-02,   1.04053776e+00,
         -7.86083203e-02,  -1.47620435e-07,  -1.96960762e-02,
          8.10240100e-08,  -1.45163488e-01,   8.38707519e-08,
         -1.61151715e-02,   8.08540349e-08,   3.29401780e-03,
          2.35355430e-07,   1.00830639e-07,  -3.89966257e-03,
         -9.35235243e-08,  -1.85307141e-02,   1.09453672e-02],
       [  3.96696155e-02,  -1.54340513e-02,  -7.86083203e-02,
          2.40372128e-01,  -2.34781715e-07,   3.92305073e-02,
         -7.29909247e-07,   2.75376974e-01,  -4.60141285e-07,
          4.11896095e-02,  -6.01501534e-07,  -6.60942401e-03,
         -5.27036267e-07,  -1.87481136e-07,   8.14579353e-03,
          2.84321204e-07,   3.96699256e-02,  -1.54327313e-02],
       [  1.22221686e-01,   7.22224370e-02,  -1.47620435e-07,
         -2.34781715e-07,   2.70633883e-01,   2.76830353e-06,
         -2.37012594e-06,   1.15079312e-06,   1.37047661e-01,
         -2.90418959e-07,  -2.06228078e-07,   1.08853818e-07,
          3.29005706e-07,   1.47094244e-06,   5.22140620e-07,
         -1.97008188e-02,  -1.22224334e-01,  -7.22211150e-02],
       [ -9.13353431e-02,  -5.54689246e-02,  -1.96960762e-02,
          3.92305073e-02,   2.76830353e-06,   3.29404287e-01,
          1.04016319e-06,   1.30707834e-01,   1.90168619e-06,
          2.29541433e-01,   1.42368905e-07,   1.13530101e-02,
          9.87974363e-07,  -3.74107532e-07,   1.78541616e-02,
         -2.10942140e-07,  -9.13379829e-02,  -5.54602725e-02],
       [ -1.59459391e-07,   4.94969298e-06,   8.10240100e-08,
         -7.29909247e-07,  -2.37012594e-06,   1.04016319e-06,
          4.08075218e-01,   2.80074346e-07,  -2.91136598e-06,
         -2.28192934e-07,   3.27231214e-01,   9.93662648e-07,
          1.19005240e-07,  -2.29891460e-02,   3.98337621e-07,
          2.22538112e-06,  -2.70691301e-07,  -4.04125529e-06],
       [  1.98772489e-02,  -3.19915597e-02,  -1.45163488e-01,
          2.75376974e-01,   1.15079312e-06,   1.30707834e-01,
          2.80074346e-07,   3.41050000e-01,   3.36223202e-07,
          1.06241626e-01,   2.32853187e-08,  -4.34438775e-03,
         -3.23124654e-07,  -3.52833151e-07,   1.37661796e-02,
          2.09241262e-07,   1.98762829e-02,  -3.19881704e-02],
       [  6.18922328e-02,   3.65730162e-02,   8.38707519e-08,
         -4.60141285e-07,   1.37047661e-01,   1.90168619e-06,
         -2.91136598e-06,   3.36223202e-07,   6.94002580e-02,
          1.77805583e-07,  -1.47658391e-06,   8.59644473e-08,
          1.66608965e-07,   8.41276194e-07,   2.81212868e-07,
         -9.97639727e-03,  -6.18940234e-02,  -3.65724845e-02],
       [ -6.06919651e-02,  -3.91624272e-02,  -1.61151715e-02,
          4.11896095e-02,  -2.90418959e-07,   2.29541433e-01,
         -2.28192934e-07,   1.06241626e-01,   1.77805583e-07,
          1.60771623e-01,  -6.61139400e-07,   7.44618336e-03,
          6.50742562e-07,  -2.18190107e-07,   1.27934036e-02,
          3.03042737e-08,  -6.06917932e-02,  -3.91552140e-02],
       [  8.43352532e-07,   4.53525519e-06,   8.08540349e-08,
         -6.01501534e-07,  -2.06228078e-07,   1.42368905e-07,
          3.27231214e-01,   2.32853187e-08,  -1.47658391e-06,
         -6.61139400e-07,   2.62403260e-01,   7.70725752e-07,
          9.54288505e-08,  -1.84347537e-02,   2.83626462e-07,
          1.66116932e-06,  -7.76240047e-07,  -3.57882690e-06],
       [ -4.86580670e-03,  -1.60699048e-03,   3.29401780e-03,
         -6.60942401e-03,   1.08853818e-07,   1.13530101e-02,
          9.93662648e-07,  -4.34438775e-03,   8.59644473e-08,
          7.44618336e-03,   7.70725752e-07,   6.62132978e-04,
          5.59460008e-08,  -6.03661672e-08,   4.10805136e-04,
         -1.73333682e-08,  -4.86591377e-03,  -1.60669900e-03],
       [ -2.64265264e-07,  -5.40167958e-08,   2.35355430e-07,
         -5.27036267e-07,   3.29005706e-07,   9.87974363e-07,
          1.19005240e-07,  -3.23124654e-07,   1.66608965e-07,
          6.50742562e-07,   9.54288505e-08,   5.59460008e-08,
          5.16853224e-12,  -6.70302272e-09,   3.70105981e-08,
         -2.39501663e-08,  -5.61436155e-07,  -2.29587310e-07],
       [  6.59314519e-07,   1.38468443e-07,   1.00830639e-07,
         -1.87481136e-07,   1.47094244e-06,  -3.74107532e-07,
         -2.29891460e-02,  -3.52833151e-07,   8.41276194e-07,
         -2.18190107e-07,  -1.84347537e-02,  -6.03661672e-08,
         -6.70302272e-09,   1.29510643e-03,  -4.44397689e-08,
         -2.22725920e-07,  -5.42423869e-07,  -6.88431125e-08],
       [ -3.65276338e-03,  -3.23600234e-03,  -3.89966257e-03,
          8.14579353e-03,   5.22140620e-07,   1.78541616e-02,
          3.98337621e-07,   1.37661796e-02,   2.81212868e-07,
          1.27934036e-02,   2.83626462e-07,   4.10805136e-04,
          3.70105981e-08,  -4.44397689e-08,   1.12221909e-03,
         -3.16491559e-08,  -3.65323959e-03,  -3.23573233e-03],
       [ -8.89707876e-03,  -5.25744757e-03,  -9.35235243e-08,
          2.84321204e-07,  -1.97008188e-02,  -2.10942140e-07,
          2.22538112e-06,   2.09241262e-07,  -9.97639727e-03,
          3.03042737e-08,   1.66116932e-06,  -1.73333682e-08,
         -2.39501663e-08,  -2.22725920e-07,  -3.16491559e-08,
          1.43412295e-03,   8.89739208e-03,   5.25733424e-03],
       [ -1.89746204e-02,  -1.91658391e-02,  -1.85307141e-02,
          3.96699256e-02,  -1.22224334e-01,  -9.13379829e-02,
         -2.70691301e-07,   1.98762829e-02,  -6.18940234e-02,
         -6.06917932e-02,  -7.76240047e-07,  -4.86591377e-03,
         -5.61436155e-07,  -5.42423869e-07,  -3.65323959e-03,
          8.89739208e-03,   9.14227502e-02,   4.60652981e-02],
       [ -1.91673663e-02,  -9.58108454e-03,   1.09453672e-02,
         -1.54327313e-02,  -7.22211150e-02,  -5.54602725e-02,
         -4.04125529e-06,  -3.19881704e-02,  -3.65724845e-02,
         -3.91552140e-02,  -3.57882690e-06,  -1.60669900e-03,
         -2.29587310e-07,  -6.88431125e-08,  -3.23573233e-03,
          5.25733424e-03,   4.60652981e-02,   2.89632874e-02]])
    ref_result_energy = -75.840493741128014
    ref_result_exp_alpha = array([[ -1.10109854e-04,   1.39080722e-01,   2.34940977e-01,
         -1.29920965e-01,  -6.92250384e-07,   1.11738448e-01,
          1.14245500e-01,  -8.42072651e-01,   7.33084049e-01,
         -1.21273191e-05,   4.95934579e-01,  -3.99147507e-03,
         -1.68775951e-01,  -2.81935320e-05,   9.74408150e-02,
          5.64771140e-05,  -8.32396080e-01,   9.60544181e-01],
       [ -3.76288801e-03,   4.92169934e-03,   1.38829759e-01,
         -9.82610956e-02,  -8.07307954e-06,   9.32990339e-01,
          1.25447419e+00,   6.31458567e-01,  -5.73468303e-01,
          4.53695871e-05,  -7.35792856e-02,  -9.64203156e-01,
         -6.78619763e-01,  -4.71741272e-06,   4.93160362e-02,
          1.80016140e-05,  -1.09431020e-01,  -1.55244996e-02],
       [ -9.94156894e-01,  -2.12460779e-01,   1.93629900e-07,
         -8.39657693e-02,   7.78577569e-07,   9.53770399e-02,
         -4.95951368e-06,  -2.62757803e-06,   3.48845911e-02,
          1.75623925e-06,   6.60208604e-02,   5.31535262e-07,
          7.09377841e-02,  -4.67740852e-07,  -6.82691596e-04,
         -8.62352124e-07,  -1.74128393e-02,   7.82056740e-07],
       [ -3.33312020e-02,   4.54381112e-01,  -1.45423020e-06,
          1.81105174e-01,  -8.27767854e-07,  -1.78567511e-01,
          8.60819454e-06,   1.69115576e-05,  -1.41267383e-01,
         -2.03385657e-05,  -3.63124843e-01,  -2.18929856e-06,
         -1.62303470e+00,  -7.92272070e-06,   1.34608933e-01,
          6.47892464e-05,  -5.55222200e-01,  -1.56472931e-05],
       [  6.79643347e-09,  -2.27154120e-07,   5.20225037e-01,
          3.45206772e-06,  -1.58996170e-06,  -1.70014857e-05,
         -4.35096656e-01,   1.94061098e-01,   3.81693534e-06,
          1.24370454e-05,  -3.08125050e-07,  -9.78375999e-01,
          5.09160280e-06,  -5.66177687e-06,   2.44282124e-06,
         -5.49560587e-08,  -8.03701813e-06,   3.70252970e-02],
       [  1.73486665e-03,  -1.35795570e-01,   1.56170245e-06,
          5.57638841e-01,  -7.82132482e-06,   2.81470325e-01,
         -6.61380061e-06,   2.26953291e-05,   6.52936594e-01,
         -9.03373592e-05,  -7.08316035e-01,   8.83006734e-06,
          1.81088669e-01,   1.13233637e-06,  -6.43643536e-03,
         -6.69977759e-06,   3.95957966e-02,   2.07665273e-06],
       [  5.04267884e-09,   5.27830423e-08,  -6.50829892e-06,
         -7.08162810e-06,  -6.38807822e-01,  -1.59009367e-06,
         -6.53807594e-06,   1.56843970e-05,   7.37088874e-05,
          9.63282195e-01,  -5.56648607e-05,   1.58439822e-05,
         -6.73378659e-06,   6.53122832e-06,   8.17387206e-06,
         -7.63444390e-03,   2.33747941e-06,   5.43088202e-08],
       [  1.64906976e-02,   4.68392069e-01,   1.04473892e-07,
          3.48405983e-01,  -4.26192442e-06,  -1.09440682e+00,
          5.29256552e-05,  -4.54242639e-06,   1.74688437e-01,
          2.33700027e-07,  -2.94916843e-03,  -9.91892610e-07,
          2.54392599e+00,   1.99860333e-05,  -2.69259878e-01,
         -1.23743519e-04,   1.32667700e+00,   2.38092847e-05],
       [  4.83245345e-09,  -1.12516614e-06,   2.63439323e-01,
          2.39849992e-06,   1.87349748e-06,  -3.48767740e-05,
         -7.46727772e-01,   4.36369285e-01,  -1.15017116e-05,
         -3.70624950e-05,   1.87792829e-05,   1.69474162e+00,
          2.24204134e-07,   2.68013675e-05,  -1.09096208e-05,
         -1.15573096e-05,   1.93988990e-05,  -9.45122288e-01],
       [ -2.83379059e-03,  -6.71134952e-02,  -3.21059877e-06,
          3.95296494e-01,  -4.03045365e-06,   4.20582284e-01,
         -2.44236208e-05,  -3.53458784e-05,  -3.43558871e-01,
          8.91670515e-05,   1.13305566e+00,  -3.04652995e-06,
         -6.27318934e-01,  -2.75744564e-06,   1.50767452e-01,
          6.25171921e-05,  -6.76021919e-01,  -6.89227048e-06],
       [ -4.99431981e-09,   4.59909536e-07,  -1.96196834e-06,
         -6.81742808e-06,  -5.12252939e-01,   8.92961637e-08,
          6.86783210e-07,  -1.99146427e-05,  -7.91626191e-05,
         -1.03557711e+00,   6.09647733e-05,  -1.77046762e-05,
          5.76690117e-06,  -1.05590291e-05,   8.22303699e-06,
         -3.49752898e-02,  -1.85368590e-06,  -2.00764967e-06],
       [ -1.90734276e-04,  -2.06687365e-02,   9.85103443e-08,
          1.53264479e-02,  -1.72711028e-06,   1.28700860e-02,
         -9.67466044e-08,   5.90874726e-07,  -1.33464540e-01,
          1.02122931e-05,  -8.93989474e-02,   7.18091952e-06,
          1.58304870e-01,  -9.67998482e-05,  -4.73082624e-01,
         -1.67176886e-04,  -9.80655174e-01,  -1.94135891e-06],
       [  1.19329857e-08,  -1.70014899e-06,   6.32419411e-07,
          1.35765143e-06,  -1.86324342e-07,   3.32122857e-06,
         -5.93368647e-07,  -4.80493517e-06,   5.43247039e-06,
         -7.51103849e-06,   5.90683688e-06,  -5.49980676e-06,
         -1.55397312e-05,   9.99999981e-01,  -1.74195362e-04,
         -7.68180745e-05,  -1.83477222e-05,   1.69250300e-05],
       [  7.50174304e-10,  -2.55925473e-07,   2.93750284e-06,
         -2.28457280e-07,   3.59875797e-02,  -4.59449212e-07,
         -1.73455652e-06,  -4.88402387e-06,  -1.38089974e-06,
          1.59461250e-02,  -3.82793494e-07,   2.15090003e-06,
         -9.52620986e-06,  -7.65705050e-05,   3.56013293e-04,
         -9.99224941e-01,  -2.61248783e-06,   1.54497298e-05],
       [  1.13466454e-04,   4.71653694e-03,   7.85668576e-07,
          3.31656470e-02,  -9.90845899e-07,   1.03016970e-02,
         -1.11540652e-06,  -6.08892964e-06,   1.10299383e-01,
         -1.48247016e-07,   1.07939153e-01,  -7.00120022e-06,
         -1.81259560e-01,  -1.47044174e-04,  -8.73782257e-01,
         -3.11152453e-04,   5.07608368e-01,   6.69719637e-06],
       [ -2.08977934e-08,   5.57384952e-07,  -3.78698211e-02,
         -1.36457318e-07,  -3.09782101e-06,  -4.06303069e-07,
          1.71051488e-02,   2.14104196e-01,  -3.10697515e-06,
         -6.03414216e-06,   4.99917927e-06,   2.60311593e-02,
         -7.89490577e-06,  -2.03400109e-05,   6.09396341e-06,
          1.83496462e-05,  -6.47382982e-06,   1.27315618e+00],
       [ -1.10087322e-04,   1.39081217e-01,  -2.34944220e-01,
         -1.29924262e-01,   4.26919372e-06,   1.11735024e-01,
         -1.14276214e-01,   8.42036484e-01,   7.33090695e-01,
         -4.13151875e-05,   4.95991334e-01,   4.00896259e-03,
         -1.68758528e-01,   1.26125582e-05,   9.74238538e-02,
          1.72781537e-05,  -8.32386416e-01,  -9.60550028e-01],
       [ -3.76289321e-03,   4.91761734e-03,  -1.38825909e-01,
         -9.82457961e-02,   8.83012693e-06,   9.32876712e-01,
         -1.25454944e+00,  -6.31451676e-01,  -5.73497274e-01,
          2.66318139e-05,  -7.36328782e-02,   9.64197031e-01,
         -6.78628316e-01,  -2.01639622e-06,   4.93150607e-02,
          3.26538946e-05,  -1.09410753e-01,   1.55129387e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08}

    test_path = context.get_fn("examples/hf_dft/rks_water_lda.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
