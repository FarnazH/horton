# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_uks_methyl_numlda():
    ref_result_dm_alpha = array([[  1.03042767e+00,  -3.95322410e-02,  -2.00923105e-05,
          1.99822341e-05,  -1.38609505e-05,  -1.12416441e-01,
         -2.04552065e-05,   2.64165747e-05,  -1.16015014e-05,
          2.13655457e-03,   5.70140459e-06,  -3.12044529e-06,
         -1.51765626e-06,  -1.43873728e-06,  -2.92302552e-02,
         -4.75375833e-03,  -2.93214551e-02,  -4.67939145e-03,
         -2.92714054e-02,  -4.71691436e-03],
       [ -3.95322410e-02,   1.56858631e-01,   1.46319537e-05,
          9.60394884e-06,   2.33528985e-05,   1.64016695e-01,
          2.70960103e-05,  -2.82787426e-05,   1.84790844e-05,
         -4.05978455e-03,  -1.08913681e-05,   5.76283200e-06,
          2.84003478e-06,   6.16515684e-07,   5.27965861e-02,
          1.98193885e-02,   5.30194021e-02,   1.97155464e-02,
          5.28744513e-02,   1.97463626e-02],
       [ -2.00923105e-05,   1.46319537e-05,   2.06266540e-01,
          2.20002531e-05,   3.48941497e-05,   1.90868435e-05,
          9.63204875e-02,   1.32520498e-04,   2.99302015e-05,
         -6.50910956e-06,  -3.26065573e-05,  -6.09337238e-06,
          9.01492201e-03,  -1.66547873e-06,   1.20144278e-01,
          1.04254014e-01,  -6.02985320e-02,  -5.20288596e-02,
         -6.01576744e-02,  -5.19881778e-02],
       [  1.99822341e-05,   9.60394884e-06,   2.20002531e-05,
          2.06190271e-01,  -7.20316189e-06,  -1.26986071e-04,
         -6.68301496e-05,   9.63141064e-02,  -1.11507967e-05,
         -8.07491519e-06,  -5.80717424e-06,   6.35256685e-06,
          2.37204884e-06,  -8.99439042e-03,   2.28452785e-05,
          1.25223399e-04,   1.04436624e-01,   8.99012273e-02,
         -1.04203930e-01,  -9.00712335e-02],
       [ -1.38609505e-05,   2.33528985e-05,   3.48941497e-05,
         -7.20316189e-06,   3.54876733e-01,   7.93655255e-05,
          7.61446481e-05,  -3.16633920e-05,   3.17250518e-01,
          3.76970498e-06,  -2.99370574e-06,  -2.80678286e-05,
         -6.40952532e-06,   8.97189636e-07,  -1.58706134e-04,
         -3.24937396e-06,   2.48190781e-05,  -1.30340605e-05,
         -4.79133196e-05,  -8.43942041e-06],
       [ -1.12416441e-01,   1.64016695e-01,   1.90868435e-05,
         -1.26986071e-04,   7.93655255e-05,   1.76452578e-01,
          3.05763853e-05,  -9.41943429e-05,   6.84336439e-05,
         -4.32259522e-03,  -1.15913813e-05,   6.13344772e-06,
          3.13892875e-06,   6.64347255e-06,   5.63166017e-02,
          2.07082806e-02,   5.64811336e-02,   2.05353477e-02,
          5.64656941e-02,   2.06878860e-02],
       [ -2.04552065e-05,   2.70960103e-05,   9.63204875e-02,
         -6.68301496e-05,   7.61446481e-05,   3.05763853e-05,
          4.49789137e-02,   2.58580814e-05,   6.74824042e-05,
         -3.56685060e-06,  -1.52260734e-05,  -2.85178258e-06,
          4.20970535e-03,   2.58590259e-06,   5.61107689e-02,
          4.86861104e-02,  -2.81897715e-02,  -2.43270425e-02,
         -2.80460063e-02,  -2.42407408e-02],
       [  2.64165747e-05,  -2.82787426e-05,   1.32520498e-04,
          9.63141064e-02,  -3.16633920e-05,  -9.41943429e-05,
          2.58580814e-05,   4.49896296e-02,  -3.05072265e-05,
         -2.91822526e-06,  -2.72939014e-06,   2.96477425e-06,
          6.45088182e-06,  -4.20139521e-03,   7.07226159e-05,
          1.16144207e-04,   4.87367185e-02,   4.19590533e-02,
         -4.87218146e-02,  -4.21083521e-02],
       [ -1.16015014e-05,   1.84790844e-05,   2.99302015e-05,
         -1.11507967e-05,   3.17250518e-01,   6.84336439e-05,
          6.74824042e-05,  -3.05072265e-05,   2.83613667e-01,
          3.43249620e-06,  -2.67579522e-06,  -2.50921010e-05,
         -5.78526846e-06,   1.00757044e-06,  -1.43425488e-04,
         -3.84922822e-06,   1.93575097e-05,  -1.36887664e-05,
         -4.08949313e-05,  -5.46995344e-06],
       [  2.13655457e-03,  -4.05978455e-03,  -6.50910956e-06,
         -8.07491519e-06,   3.76970498e-06,  -4.32259522e-03,
         -3.56685060e-06,  -2.91822526e-06,   3.43249620e-06,
          1.06289862e-04,   2.86264277e-07,  -1.51380443e-07,
         -3.41680357e-07,   3.25136948e-07,  -1.38740804e-03,
         -5.15792379e-04,  -1.39183922e-03,  -5.11839251e-04,
         -1.38013462e-03,  -5.05818556e-04],
       [  5.70140459e-06,  -1.08913681e-05,  -3.26065573e-05,
         -5.80717424e-06,  -2.99370574e-06,  -1.15913813e-05,
         -1.52260734e-05,  -2.72939014e-06,  -2.67579522e-06,
          2.86264277e-07,   6.10736122e-09,   6.15751131e-10,
         -1.42520228e-06,   2.53353277e-07,  -2.27015926e-05,
         -1.78580394e-05,   2.86522429e-06,   4.32633155e-06,
          8.72579001e-06,   9.38290104e-06],
       [ -3.12044529e-06,   5.76283200e-06,  -6.09337238e-06,
          6.35256685e-06,  -2.80678286e-05,   6.13344772e-06,
         -2.85178258e-06,   2.96477425e-06,  -2.50921010e-05,
         -1.51380443e-07,   6.15751131e-10,   2.81009889e-09,
         -2.65560087e-07,  -2.77097097e-07,  -1.56865243e-06,
         -2.34691180e-06,   6.97104837e-06,   5.03143745e-06,
          5.39472283e-07,  -5.13555866e-07],
       [ -1.51765626e-06,   2.84003478e-06,   9.01492201e-03,
          2.37204884e-06,  -6.40952532e-06,   3.13892875e-06,
          4.20970535e-03,   6.45088182e-06,  -5.78526846e-06,
         -3.41680357e-07,  -1.42520228e-06,  -2.65560087e-07,
          3.93999259e-04,  -1.34318135e-07,   5.25167676e-03,
          4.55672259e-03,  -2.63390098e-03,  -2.27304045e-03,
         -2.62917216e-03,  -2.27249302e-03],
       [ -1.43873728e-06,   6.16515684e-07,  -1.66547873e-06,
         -8.99439042e-03,   8.97189636e-07,   6.64347255e-06,
          2.58590259e-06,  -4.20139521e-03,   1.00757044e-06,
          3.25136948e-07,   2.53353277e-07,  -2.77097097e-07,
         -1.34318135e-07,   3.92351495e-04,  -1.05470345e-06,
         -5.68852330e-06,  -4.55515212e-03,  -3.92134508e-03,
          4.54612245e-03,   3.92937736e-03],
       [ -2.92302552e-02,   5.27965861e-02,   1.20144278e-01,
          2.28452785e-05,  -1.58706134e-04,   5.63166017e-02,
          5.61107689e-02,   7.07226159e-05,  -1.43425488e-04,
         -1.38740804e-03,  -2.27015926e-05,  -1.56865243e-06,
          5.25167676e-03,  -1.05470345e-06,   8.79937651e-02,
          6.73884495e-02,  -1.70253702e-02,  -2.36704630e-02,
         -1.69995112e-02,  -2.36421721e-02],
       [ -4.75375833e-03,   1.98193885e-02,   1.04254014e-01,
          1.25223399e-04,  -3.24937396e-06,   2.07082806e-02,
          4.86861104e-02,   1.16144207e-04,  -3.84922822e-06,
         -5.15792379e-04,  -1.78580394e-05,  -2.34691180e-06,
          4.55672259e-03,  -5.68852330e-06,   6.73884495e-02,
          5.51959424e-02,  -2.37264792e-02,  -2.37572020e-02,
         -2.37878125e-02,  -2.38312869e-02],
       [ -2.93214551e-02,   5.30194021e-02,  -6.02985320e-02,
          1.04436624e-01,   2.48190781e-05,   5.64811336e-02,
         -2.81897715e-02,   4.87367185e-02,   1.93575097e-05,
         -1.39183922e-03,   2.86522429e-06,   6.97104837e-06,
         -2.63390098e-03,  -4.55515212e-03,  -1.70253702e-02,
         -2.37264792e-02,   8.87022150e-02,   6.74103383e-02,
         -1.70694724e-02,  -2.37509074e-02],
       [ -4.67939145e-03,   1.97155464e-02,  -5.20288596e-02,
          8.99012273e-02,  -1.30340605e-05,   2.05353477e-02,
         -2.43270425e-02,   4.19590533e-02,  -1.36887664e-05,
         -5.11839251e-04,   4.32633155e-06,   5.03143745e-06,
         -2.27304045e-03,  -3.92134508e-03,  -2.36704630e-02,
         -2.37572020e-02,   6.74103383e-02,   5.48045660e-02,
         -2.36173801e-02,  -2.36755922e-02],
       [ -2.92714054e-02,   5.28744513e-02,  -6.01576744e-02,
         -1.04203930e-01,  -4.79133196e-05,   5.64656941e-02,
         -2.80460063e-02,  -4.87218146e-02,  -4.08949313e-05,
         -1.38013462e-03,   8.72579001e-06,   5.39472283e-07,
         -2.62917216e-03,   4.54612245e-03,  -1.69995112e-02,
         -2.37878125e-02,  -1.70694724e-02,  -2.36173801e-02,
          8.82790600e-02,   6.73325696e-02],
       [ -4.71691436e-03,   1.97463626e-02,  -5.19881778e-02,
         -9.00712335e-02,  -8.43942041e-06,   2.06878860e-02,
         -2.42407408e-02,  -4.21083521e-02,  -5.46995344e-06,
         -5.05818556e-04,   9.38290104e-06,  -5.13555866e-07,
         -2.27249302e-03,   3.92937736e-03,  -2.36421721e-02,
         -2.38312869e-02,  -2.37509074e-02,  -2.36755922e-02,
          6.73325696e-02,   5.49326133e-02]])
    ref_result_energy = -39.414654740242668
    ref_result_exp_alpha = array([[  9.93910290e-01,   2.06324983e-01,  -7.00165660e-05,
          2.28683107e-05,  -2.96039354e-05,   1.56679722e-01,
          1.85393732e-04,  -1.41340769e-04,  -4.34901400e-06,
         -9.12943633e-05,  -4.88347074e-05,  -4.67951631e-02,
          8.97546878e-06,   2.30476670e-05,   3.94352501e-02,
         -3.50766090e-07,   5.38323472e-06,   4.01831885e-02,
          1.31821620e-04,  -6.60093117e-05],
       [  4.19788904e-02,  -3.93822794e-01,   1.56016882e-05,
         -2.97692089e-05,   5.00034391e-05,  -2.62930771e-01,
         -3.01470390e-04,   3.55295698e-04,  -8.98915407e-05,
         -4.36581576e-04,  -6.23413227e-04,  -7.33489309e-01,
          5.83588948e-03,   2.11661411e-03,  -1.92228780e+00,
          7.38536616e-05,  -1.30844092e-04,   2.75595403e-01,
          5.82797480e-04,  -2.79890578e-04],
       [  7.59172168e-07,   1.36482905e-06,   1.63443708e-01,
         -4.23736541e-01,   1.56535412e-04,  -6.45938793e-04,
          4.08544166e-01,  -1.86473135e-01,  -2.82357891e-04,
          2.37779521e-01,   8.13323594e-01,  -2.71693649e-03,
         -2.86010552e-01,  -6.70587930e-01,  -8.79734591e-04,
         -1.36038997e-04,  -1.47088525e-04,  -7.17408827e-05,
          5.78877271e-02,  -2.21963930e-02],
       [  5.08736052e-09,  -2.87191794e-05,  -4.23640709e-01,
         -1.63458844e-01,  -5.64713653e-05,   4.98648429e-05,
          1.86084501e-01,   4.08415462e-01,  -3.35003791e-04,
         -8.12818578e-01,   2.38467136e-01,   2.27476583e-03,
          6.71393792e-01,  -2.85518532e-01,   1.00932716e-03,
         -3.53025980e-05,  -9.20805658e-06,   2.34559341e-05,
          2.22722357e-02,   5.80494626e-02],
       [  3.92717506e-07,   1.64218627e-05,  -1.00576255e-04,
          9.89241501e-05,   5.95715285e-01,   3.35173160e-05,
          1.08637525e-05,   1.20047026e-05,   1.06102320e+00,
         -2.52348547e-04,   4.00387372e-04,  -2.27456563e-04,
          6.99529711e-05,  -2.69462293e-05,   4.73311902e-05,
          4.58810865e-05,  -7.13899249e-06,   1.74402875e-05,
         -2.10445420e-05,   2.43040245e-05],
       [ -2.60729306e-02,  -4.19252497e-01,   3.01545411e-04,
          6.98187402e-05,   1.44604215e-04,  -1.85129637e+00,
         -2.01466510e-03,   1.22088044e-03,   8.54965071e-05,
          4.10769738e-04,   5.95965874e-04,   1.15237279e+00,
         -1.04607529e-02,  -3.87329292e-03,   3.55787561e+00,
         -1.31355121e-04,   3.25839169e-04,  -7.87025758e-01,
         -1.90986448e-03,   9.20757734e-04],
       [ -8.96723164e-08,  -5.08576426e-05,   7.64816873e-02,
         -1.97811571e-01,   1.73583160e-04,  -1.53143846e-03,
          1.15040292e+00,  -5.23367848e-01,   4.48838849e-04,
         -4.88301309e-01,  -1.66983134e+00,   4.95018284e-03,
          4.29382891e-01,   1.00612843e+00,   1.05706116e-03,
          2.78527193e-04,   4.45531013e-04,  -1.68385001e-03,
          4.94444528e-01,  -1.89416463e-01],
       [ -7.48782745e-08,   6.97554156e-05,  -1.97791024e-01,
         -7.66050214e-02,  -7.38263788e-05,   3.19437965e-04,
          5.24034419e-01,   1.15065423e+00,   6.61768936e-04,
          1.66871791e+00,  -4.88811327e-01,  -3.73089493e-03,
         -1.00765482e+00,   4.28092908e-01,  -1.32059960e-03,
          2.00155491e-04,   6.57067074e-05,   4.60641426e-05,
          1.89262264e-01,   4.94481442e-01],
       [ -1.03675912e-07,   2.06908359e-05,  -8.12345850e-05,
          9.47665336e-05,   5.32553906e-01,   7.24822858e-05,
         -8.47236133e-05,   5.59654245e-05,  -1.09409017e+00,
          3.25705916e-04,  -3.34944469e-04,   1.05807718e-04,
          3.00698192e-05,   1.34329267e-04,   1.08985411e-05,
          1.97840948e-06,  -1.53836260e-05,   7.94144445e-07,
          3.16239441e-06,  -2.22399075e-07],
       [  9.47084171e-06,   1.03096671e-02,   1.08312048e-05,
          1.95858556e-05,   6.01060357e-06,  -1.22549642e-02,
         -6.48381583e-05,   4.08570329e-05,   2.04970726e-05,
          3.22825623e-04,   2.04700293e-04,   1.83315906e-01,
         -2.94553252e-04,  -7.69093593e-05,  -3.41397407e-02,
          1.99926345e-05,  -3.28343562e-04,   1.05117928e+00,
          2.88874161e-03,  -1.34489360e-03],
       [ -5.91998804e-09,   2.76482186e-05,  -1.39207203e-05,
          7.16024382e-05,  -5.01829851e-06,  -2.71525467e-05,
          3.83860584e-05,  -1.10738265e-05,  -1.35766113e-05,
         -1.51784914e-05,  -1.26844514e-04,   2.27735882e-04,
         -1.11730637e-04,  -4.71878723e-04,  -9.74768115e-05,
          5.14224084e-01,   8.57655492e-01,   2.16036607e-04,
         -5.28342511e-04,  -2.11352875e-05],
       [ -1.00994465e-07,  -1.46510630e-05,  -1.78495007e-05,
          7.47774255e-06,  -4.70664067e-05,   1.93774604e-05,
          1.48227926e-05,   2.32824154e-06,  -1.41351898e-05,
          1.30589928e-05,  -3.61964457e-05,  -1.20478629e-04,
          2.65258474e-05,  -1.08415948e-04,   9.23643601e-05,
          8.57655715e-01,  -5.14224231e-01,  -1.52717893e-04,
         -4.23965166e-05,  -2.22294559e-04],
       [  5.38082741e-07,  -5.46892109e-06,   7.14049399e-03,
         -1.85206194e-02,  -6.47816199e-06,  -4.58105829e-05,
         -1.93714784e-02,   8.83509718e-03,   1.92127165e-06,
          3.13229304e-02,   1.06596912e-01,   3.41441303e-04,
          8.07633221e-02,   1.89941979e-01,   1.81178347e-04,
          3.11872537e-04,   5.61575048e-04,  -3.32563605e-03,
          1.01189417e+00,  -3.87532620e-01],
       [ -2.44347854e-08,  -1.37716860e-06,   1.84794126e-02,
          7.13177416e-03,   3.44173959e-06,  -3.09192412e-06,
          8.82673548e-03,   1.95043416e-02,   3.69418988e-05,
          1.06758375e-01,  -3.11311448e-02,   2.17829617e-04,
          1.89965072e-01,  -8.09334692e-02,   3.89441549e-04,
         -3.47345124e-04,  -7.82926065e-05,  -2.34990597e-04,
         -3.87521691e-01,  -1.01187331e+00],
       [ -1.53782168e-03,  -1.34203319e-01,   9.51888090e-02,
         -2.46819608e-01,  -2.05626328e-04,   1.03232778e-01,
         -1.12266349e-01,   5.10910781e-02,  -1.46554940e-04,
          1.12076797e-01,   3.84308888e-01,  -6.26878438e-01,
          3.48054077e-01,   8.16410731e-01,   3.12199321e-01,
          1.98575629e-04,   1.88106033e-04,   3.78220974e-01,
         -6.40096594e-01,   2.45085913e-01],
       [  5.54810547e-03,  -4.97147712e-02,   8.23785633e-02,
         -2.14260031e-01,   4.54990529e-05,   9.61955098e-01,
         -1.47884494e+00,   6.72964583e-01,  -8.87578158e-05,
          1.49133639e-01,   5.10512751e-01,   1.70650365e-01,
         -6.05594968e-01,  -1.42533786e+00,  -1.10114003e+00,
         -3.61742982e-04,  -6.31074956e-04,   6.33833448e-02,
         -4.49769641e-03,   1.72387718e-03],
       [ -1.53651769e-03,  -1.34804847e-01,  -2.62370789e-01,
          4.10998759e-02,  -5.71374810e-06,   1.03340697e-01,
          1.21270851e-02,  -1.23358461e-01,  -1.64136441e-04,
         -3.91441281e-01,  -9.58788853e-02,  -6.29032389e-01,
         -8.78891941e-01,  -1.06491958e-01,   3.08512849e-01,
         -1.78765150e-04,   6.88188963e-05,   3.75093166e-01,
          1.09020437e-01,  -6.78731059e-01],
       [  5.54719279e-03,  -4.94822561e-02,  -2.25955537e-01,
          3.56302739e-02,  -6.44859910e-05,   9.58004011e-01,
          1.57139164e-01,  -1.61891388e+00,  -8.66144902e-05,
         -5.13734199e-01,  -1.25264973e-01,   1.79615444e-01,
          1.54155870e+00,   1.87982145e-01,  -1.09613482e+00,
          1.16104437e-04,   1.66308596e-05,   6.31469147e-02,
          9.12350830e-04,  -4.73305844e-03],
       [ -1.53707970e-03,  -1.34432351e-01,   1.66433750e-01,
          2.06165859e-01,  -8.28310895e-05,   1.03271478e-01,
          1.00801728e-01,   7.18107439e-02,   8.45412443e-06,
          2.76370670e-01,  -2.90649135e-01,  -6.27339847e-01,
          5.33326963e-01,  -7.08330602e-01,   3.11358180e-01,
          2.40010211e-06,   7.70962584e-05,   3.75312723e-01,
          5.34530775e-01,   4.32092012e-01],
       [  5.54764081e-03,  -4.95567537e-02,   1.43865414e-01,
          1.78181402e-01,  -1.80050279e-05,   9.58938352e-01,
          1.32461784e+00,   9.44059680e-01,   3.63474548e-04,
          3.66750700e-01,  -3.83698942e-01,   1.73945909e-01,
         -9.29675511e-01,   1.23938704e+00,  -1.10025394e+00,
          3.31704154e-04,   9.91771106e-05,   6.31460202e-02,
          3.67960831e-03,   2.95251723e-03]])
    ref_result_exp_beta = array([[  9.94136458e-01,  -1.99386223e-01,   7.90881755e-05,
         -2.54198038e-05,  -3.14728605e-05,  -1.62570791e-01,
         -2.15978106e-04,  -1.78082849e-04,   1.09705698e-04,
          5.71817877e-05,  -1.34727171e-05,  -5.46829193e-02,
         -6.33949831e-05,  -4.42574526e-05,   4.10275365e-02,
         -1.38293287e-06,   3.70600362e-06,  -3.42178109e-02,
         -1.70389163e-04,   8.46185193e-05],
       [  4.02081153e-02,   3.74367994e-01,  -3.37764093e-05,
          3.53438683e-05,   5.18580542e-05,   2.54205894e-01,
          3.29056388e-04,   4.04864390e-04,   3.71133864e-04,
          5.29482425e-04,  -1.74443042e-04,  -6.33168581e-01,
         -4.03822239e-03,  -1.34596665e-03,  -1.95771727e+00,
          7.48922906e-05,  -1.12518765e-04,  -3.08564742e-01,
         -1.14478082e-03,   5.44136508e-04],
       [  8.09115215e-07,  -1.25570509e-05,  -1.54085838e-01,
          4.03514285e-01,   1.35473981e-04,   7.52918720e-04,
         -3.98883585e-01,  -1.94829904e-01,  -2.49557517e-01,
         -7.96766669e-01,   1.09265737e-03,  -2.84729706e-03,
          2.99330141e-01,   6.98026350e-01,  -4.30000887e-04,
         -1.21024117e-04,  -1.26979021e-04,   1.78224736e-04,
         -5.69405770e-02,   2.19828304e-02],
       [  5.00397489e-08,   4.56044945e-05,   4.03429621e-01,
          1.54104043e-01,  -4.60548455e-05,  -9.21899254e-05,
         -1.94442883e-01,   3.98751679e-01,   7.96198695e-01,
         -2.50268523e-01,   2.99034186e-04,   2.42644058e-03,
         -6.98847970e-01,   2.98831755e-01,   5.78495350e-04,
         -2.07392610e-05,  -1.43354576e-05,  -2.90476618e-05,
         -2.20599809e-02,  -5.71054780e-02],
       [  7.23715571e-09,  -3.53669530e-05,   9.52705895e-05,
         -9.59755986e-05,   5.45852120e-01,  -2.68000094e-05,
         -1.14385330e-05,   1.17283650e-05,  -1.13045799e-05,
          1.54134602e-03,   1.08751560e+00,  -3.38791959e-04,
         -6.96183314e-05,   5.13489015e-05,   2.15819206e-05,
          4.40355048e-05,  -8.78590553e-06,  -2.66056940e-05,
          2.12932992e-05,  -2.48912688e-05],
       [ -2.46020292e-02,   3.77528182e-01,  -2.87822316e-04,
         -8.26855359e-05,   1.18192415e-04,   1.91247382e+00,
          2.38601578e-03,   1.66377585e-03,  -4.14862174e-04,
         -5.06558246e-04,   2.68630275e-04,   1.02303562e+00,
          7.12417374e-03,   2.44867787e-03,   3.56633168e+00,
         -1.25827592e-04,   2.95498451e-04,   8.02275823e-01,
          3.19662773e-03,  -1.52839164e-03],
       [ -1.21153511e-07,   4.98402003e-05,  -6.91058939e-02,
          1.80451016e-01,   1.54539935e-04,   1.88811603e-03,
         -1.16829939e+00,  -5.68920949e-01,   5.08852004e-01,
          1.62414337e+00,  -2.32241791e-03,   5.05317146e-03,
         -4.39543742e-01,  -1.02437607e+00,   3.91484720e-04,
          2.53165221e-04,   4.35239629e-04,   2.58819332e-03,
         -4.94450178e-01,   1.90713111e-01],
       [ -1.03029096e-07,  -6.67680609e-05,   1.80454173e-01,
          6.92202203e-02,  -7.02704733e-05,  -4.53341057e-04,
         -5.69579546e-01,   1.16852299e+00,  -1.62298298e+00,
          5.09373674e-01,  -6.54276594e-04,  -3.89177748e-03,
          1.02590241e+00,  -4.38247694e-01,  -6.61582273e-04,
          2.18778649e-04,   5.73029659e-05,  -1.14307906e-04,
         -1.90561375e-01,  -4.94488581e-01],
       [  3.47547680e-08,  -3.01891770e-05,   8.13522529e-05,
         -9.59947124e-05,   5.82736342e-01,  -4.95945335e-05,
          6.22891157e-05,   3.82442865e-05,  -6.40530579e-05,
         -1.59923940e-03,  -1.06820548e+00,   2.05696194e-04,
         -3.12756826e-05,  -1.55696821e-04,   3.11729609e-05,
          2.42436072e-06,  -1.53918297e-05,   2.87602751e-06,
         -4.27801104e-06,   1.43871532e-06],
       [ -5.54289657e-04,  -2.53835560e-02,  -3.66617106e-06,
         -1.91224863e-05,  -4.84335892e-06,  -7.01916717e-03,
          3.51857768e-05,   1.84595448e-05,  -2.98000533e-04,
         -1.82681231e-04,   2.73878024e-05,   1.64502758e-01,
          3.35509229e-04,   8.33127641e-05,  -5.14633026e-03,
          1.36460918e-05,  -3.24849049e-04,  -1.05461276e+00,
         -4.54139202e-03,   2.12711437e-03],
       [ -2.60217081e-07,  -3.69847435e-05,   1.49135687e-05,
         -7.58383866e-05,  -2.24508603e-06,   1.58964636e-05,
         -2.99063842e-05,  -8.59155771e-06,   1.80932763e-05,
          1.33199166e-04,  -1.26944699e-05,   2.15577431e-04,
          1.01571647e-04,   4.32402683e-04,  -6.98864967e-05,
          5.09139293e-01,   8.60683769e-01,  -2.26052426e-04,
          5.50127772e-04,   2.57533607e-05],
       [ -6.08448255e-09,   1.86161600e-05,   1.41850831e-05,
         -9.29442846e-06,  -4.60694733e-05,  -1.41908027e-05,
         -1.16067167e-05,  -2.71083856e-06,  -1.09028618e-05,
          3.70124253e-05,  -1.59294134e-05,  -1.16617050e-04,
         -1.53342088e-05,   9.73077069e-05,   7.80940641e-05,
          8.60683976e-01,  -5.09139431e-01,   1.49395634e-04,
          4.46791036e-05,   2.72090453e-04],
       [  5.26350020e-07,   1.90262443e-06,  -6.91076240e-03,
          1.81050384e-02,  -8.40780666e-06,   4.28683933e-05,
          1.62912280e-02,   7.95374723e-03,  -3.40734083e-02,
         -1.08264031e-01,   1.92208490e-04,   3.55439953e-04,
         -7.81493239e-02,  -1.82804723e-01,   2.92463792e-05,
          2.96627332e-04,   5.81968137e-04,   5.18994806e-03,
         -1.01215390e+00,   3.90282875e-01],
       [ -3.05561569e-08,  -5.50684732e-07,  -1.80672971e-02,
         -6.90152871e-03,   2.71427645e-06,  -1.02058228e-07,
         -7.94960209e-03,   1.64224357e-02,  -1.08432052e-01,
          3.38879493e-02,  -4.95951269e-05,   2.21742234e-04,
         -1.82830746e-01,   7.83217112e-02,   2.37507973e-04,
         -3.94845368e-04,  -6.72534552e-05,   3.67291134e-04,
          3.90276238e-01,   1.01213882e+00],
       [ -1.54397709e-03,   1.45181149e-01,  -9.87381697e-02,
          2.58576838e-01,  -2.00106706e-04,  -9.03928487e-02,
          9.85168019e-02,   4.79791365e-02,  -1.26099238e-01,
         -4.03500198e-01,   4.87066760e-04,  -6.47900157e-01,
         -3.46932167e-01,  -8.08529334e-01,   2.87077135e-01,
          1.76552118e-04,   1.36911001e-04,  -3.61942547e-01,
          6.33689129e-01,  -2.44248318e-01],
       [  5.23627773e-03,   7.06865513e-02,  -9.11325816e-02,
          2.39348683e-01,   1.08763864e-04,  -9.79592813e-01,
          1.47629462e+00,   7.18957236e-01,  -1.43524334e-01,
         -4.58635050e-01,   6.65679040e-04,   2.10275521e-01,
          6.07174695e-01,   1.41913469e+00,  -1.07582811e+00,
         -3.26470259e-04,  -5.79562936e-04,  -7.40300065e-02,
          7.77496330e-03,  -2.98724991e-03],
       [ -1.54266904e-03,   1.45840724e-01,   2.74321554e-01,
         -4.39178406e-02,   3.80360300e-07,  -9.04392477e-02,
         -7.92433919e-03,  -1.09858493e-01,   4.15175843e-01,
          9.32809095e-02,  -3.00916105e-04,  -6.50087302e-01,
          8.70676818e-01,   1.03643047e-01,   2.84854433e-01,
         -2.13193828e-04,   8.65578377e-05,  -3.57029053e-01,
         -1.07102640e-01,   6.73589012e-01],
       [  5.23535228e-03,   7.04498836e-02,   2.51970714e-01,
         -4.05805575e-02,  -7.10565838e-05,  -9.74962658e-01,
         -1.16125053e-01,  -1.64021693e+00,   4.65916873e-01,
          1.04187277e-01,  -1.39601002e-04,   2.19371288e-01,
         -1.53481369e+00,  -1.83775286e-01,  -1.07322766e+00,
          1.11340343e-04,   1.36719951e-05,  -7.37542383e-02,
         -1.61000600e-03,   8.41953037e-03],
       [ -1.54321781e-03,   1.45428248e-01,  -1.74858973e-01,
         -2.15108587e-01,  -7.71344585e-05,  -9.04110823e-02,
         -9.12181618e-02,   6.14448080e-02,  -2.85917552e-01,
          3.12440290e-01,  -6.92598171e-04,  -6.48340828e-01,
         -5.27551359e-01,   7.02809950e-01,   2.86636690e-01,
          4.38920155e-05,   7.46516984e-05,  -3.57380050e-01,
         -5.31591629e-01,  -4.27045886e-01],
       [  5.23576785e-03,   7.05180382e-02,  -1.61200440e-01,
         -1.98277957e-01,  -5.06930000e-06,  -9.76115866e-01,
         -1.36362522e+00,   9.18685158e-01,  -3.24614133e-01,
          3.52862170e-01,  -3.46710436e-04,   2.13535714e-01,
          9.24770073e-01,  -1.23598243e+00,  -1.07558487e+00,
          3.03094616e-04,   9.71312181e-05,  -7.37654528e-02,
         -6.68149498e-03,  -5.18052794e-03]])
    ref_result_dm_beta = array([[  1.02806217e+00,  -3.46714902e-02,  -1.91255250e-05,
          1.89249344e-05,   7.05654433e-06,  -9.97317052e-02,
         -2.00989375e-05,   2.57235303e-05,   6.05186770e-06,
          4.51009210e-03,   7.11866238e-06,  -3.71649669e-06,
         -8.63571991e-07,  -1.17356409e-06,  -3.04964297e-02,
         -8.90164658e-03,  -3.05894452e-02,  -8.82113521e-03,
         -3.05389223e-02,  -8.86293797e-03],
       [ -3.46714902e-02,   1.41768147e-01,   1.47651242e-05,
          8.92898484e-06,  -1.32181056e-05,   1.40345288e-01,
          2.73458323e-05,  -2.86470724e-05,  -1.12884655e-05,
         -9.52507984e-03,  -1.38595485e-05,   6.96824595e-06,
          1.60783950e-06,   1.58239015e-07,   5.43015812e-02,
          2.66848676e-02,   5.45252711e-02,   2.65747707e-02,
          5.43799516e-02,   2.66086095e-02],
       [ -1.91255250e-05,   1.47651242e-05,   1.86566276e-01,
          2.03263275e-05,  -5.34069137e-05,   6.17834572e-06,
          8.34628025e-02,   1.25804627e-04,  -5.12700786e-05,
         -6.82772055e-06,  -3.28911811e-05,  -5.93638444e-06,
          8.37048856e-03,  -9.66285875e-07,   1.19551805e-01,
          1.10621974e-01,  -5.99923677e-02,  -5.52007654e-02,
         -5.98579568e-02,  -5.51701949e-02],
       [  1.89249344e-05,   8.92898484e-06,   2.03263275e-05,
          1.86503578e-01,   2.36431512e-05,  -1.11514924e-04,
         -7.12425438e-05,   8.34676607e-02,   1.80253669e-05,
         -5.57614185e-06,  -5.67211160e-06,   4.29941786e-06,
          2.06891152e-06,  -8.35244768e-03,   2.04400065e-05,
          1.22254950e-04,   1.03908151e-01,   9.54019648e-02,
         -1.03685836e-01,  -9.55853228e-02],
       [  7.05654433e-06,  -1.32181056e-05,  -5.34069137e-05,
          2.36431512e-05,   1.95332556e-08,  -1.33431391e-05,
         -2.39044085e-05,   1.05509046e-05,   1.80273126e-08,
          8.97296966e-07,   1.00023410e-08,   1.58750842e-09,
         -2.39609689e-06,  -1.05888065e-06,  -3.93475351e-05,
         -3.41484291e-05,   2.52028774e-05,   2.54138827e-05,
         -1.14610618e-06,   1.18356808e-06],
       [ -9.97317052e-02,   1.40345288e-01,   6.17834572e-06,
         -1.11514924e-04,  -1.33431391e-05,   1.43132847e-01,
          2.37626199e-05,  -8.28234348e-05,  -1.13952121e-05,
         -9.56936690e-03,  -1.39543967e-05,   7.02495930e-06,
          1.19787772e-06,   5.55880495e-06,   5.48549852e-02,
          2.65637723e-02,   5.50216682e-02,   2.63989227e-02,
          5.50092950e-02,   2.65564312e-02],
       [ -2.00989375e-05,   2.73458323e-05,   8.34628025e-02,
         -7.12425438e-05,  -2.39044085e-05,   2.37626199e-05,
          3.73381867e-02,   2.03220601e-05,  -2.29457624e-05,
         -4.45964842e-06,  -1.47138988e-05,  -2.65653709e-06,
          3.74464444e-03,   3.16559116e-06,   5.34910749e-02,
          4.94920217e-02,  -2.68750238e-02,  -2.47319596e-02,
         -2.67254930e-02,  -2.46360100e-02],
       [  2.57235303e-05,  -2.86470724e-05,   1.25804627e-04,
          8.34676607e-02,   1.05509046e-05,  -8.28234348e-05,
          2.03220601e-05,   3.73551301e-02,   8.03761374e-06,
         -2.86126022e-07,  -2.55584174e-06,   1.91882083e-06,
          6.16191909e-06,  -3.73804786e-03,   7.12728439e-05,
          1.17748557e-04,   4.64527187e-02,   4.26554386e-02,
         -4.64535966e-02,  -4.28188358e-02],
       [  6.05186770e-06,  -1.12884655e-05,  -5.12700786e-05,
          1.80253669e-05,   1.80273126e-08,  -1.13952121e-05,
         -2.29457624e-05,   8.03761374e-06,   1.67416195e-08,
          7.66594214e-07,   9.60581356e-09,   1.48589128e-09,
         -2.30024768e-06,  -8.07284592e-07,  -3.72304748e-05,
         -3.25203928e-05,   2.21367526e-05,   2.22706331e-05,
          2.04076606e-06,   3.79433914e-06],
       [  4.51009210e-03,  -9.52507984e-03,  -6.82772055e-06,
         -5.57614185e-06,   8.97296966e-07,  -9.56936690e-03,
         -4.45964842e-06,  -2.86126022e-07,   7.66594214e-07,
          6.44632457e-04,   9.40342568e-07,  -4.72415463e-07,
         -3.69399519e-07,   2.11821787e-07,  -3.68893854e-03,
         -1.80141944e-03,  -3.70126280e-03,  -1.79131578e-03,
         -3.68588274e-03,  -1.78852055e-03],
       [  7.11866238e-06,  -1.38595485e-05,  -3.28911811e-05,
         -5.67211160e-06,   1.00023410e-08,  -1.39543967e-05,
         -1.47138988e-05,  -2.55584174e-06,   9.60581356e-09,
          9.40342568e-07,   7.33892283e-09,   2.27401247e-10,
         -1.47582353e-06,   2.53976644e-07,  -2.64464240e-05,
         -2.21217554e-05,   2.02565000e-06,   4.22597185e-06,
          8.32487152e-06,   1.00211427e-05],
       [ -3.71649669e-06,   6.96824595e-06,  -5.93638444e-06,
          4.29941786e-06,   1.58750842e-09,   7.02495930e-06,
         -2.65653709e-06,   1.91882083e-06,   1.48589128e-09,
         -4.72415463e-07,   2.27401247e-10,   6.34541524e-10,
         -2.66269320e-07,  -1.92517187e-07,  -1.10120314e-06,
         -2.20144163e-06,   7.01902880e-06,   5.26705753e-06,
          2.22169099e-06,   8.64778802e-07],
       [ -8.63571991e-07,   1.60783950e-06,   8.37048856e-03,
          2.06891152e-06,  -2.39609689e-06,   1.19787772e-06,
          3.74464444e-03,   6.16191909e-06,  -2.30024768e-06,
         -3.69399519e-07,  -1.47582353e-06,  -2.66269320e-07,
          3.75550624e-04,  -9.51630187e-08,   5.36417344e-03,
          4.96334711e-03,  -2.69061513e-03,  -2.47587079e-03,
         -2.68587332e-03,  -2.47568369e-03],
       [ -1.17356409e-06,   1.58239015e-07,  -9.66285875e-07,
         -8.35244768e-03,  -1.05888065e-06,   5.55880495e-06,
          3.16559116e-06,  -3.73804786e-03,  -8.07284592e-07,
          2.11821787e-07,   2.53976644e-07,  -1.92517187e-07,
         -9.51630187e-08,   3.74059219e-04,  -7.34328153e-07,
         -5.40284719e-06,  -4.65322656e-03,  -4.27239652e-03,
          4.64374147e-03,   4.28085149e-03],
       [ -3.04964297e-02,   5.43015812e-02,   1.19551805e-01,
          2.04400065e-05,  -3.93475351e-05,   5.48549852e-02,
          5.34910749e-02,   7.12728439e-05,  -3.72304748e-05,
         -3.68893854e-03,  -2.64464240e-05,  -1.10120314e-06,
          5.36417344e-03,  -7.34328153e-07,   9.76911889e-02,
          8.11425721e-02,  -1.72664180e-02,  -2.51523454e-02,
         -1.72410412e-02,  -2.51236888e-02],
       [ -8.90164658e-03,   2.66848676e-02,   1.10621974e-01,
          1.22254950e-04,  -3.41484291e-05,   2.65637723e-02,
          4.94920217e-02,   1.17748557e-04,  -3.25203928e-05,
         -1.80141944e-03,  -2.21217554e-05,  -2.20144163e-06,
          4.96334711e-03,  -5.40284719e-06,   8.11425721e-02,
          7.06169417e-02,  -2.52103631e-02,  -2.76682931e-02,
         -2.52788966e-02,  -2.77549041e-02],
       [ -3.05894452e-02,   5.45252711e-02,  -5.99923677e-02,
          1.03908151e-01,   2.52028774e-05,   5.50216682e-02,
         -2.68750238e-02,   4.64527187e-02,   2.21367526e-05,
         -3.70126280e-03,   2.02565000e-06,   7.01902880e-06,
         -2.69061513e-03,  -4.65322656e-03,  -1.72664180e-02,
         -2.52103631e-02,   9.84528916e-02,   8.11694699e-02,
         -1.73087496e-02,  -2.52365193e-02],
       [ -8.82113521e-03,   2.65747707e-02,  -5.52007654e-02,
          9.54019648e-02,   2.54138827e-05,   2.63989227e-02,
         -2.47319596e-02,   4.26554386e-02,   2.22706331e-05,
         -1.79131578e-03,   4.22597185e-06,   5.26705753e-06,
         -2.47587079e-03,  -4.27239652e-03,  -2.51523454e-02,
         -2.76682931e-02,   8.11694699e-02,   7.01264646e-02,
         -2.50927877e-02,  -2.75761702e-02],
       [ -3.05389223e-02,   5.43799516e-02,  -5.98579568e-02,
         -1.03685836e-01,  -1.14610618e-06,   5.50092950e-02,
         -2.67254930e-02,  -4.64535966e-02,   2.04076606e-06,
         -3.68588274e-03,   8.32487152e-06,   2.22169099e-06,
         -2.68587332e-03,   4.64374147e-03,  -1.72410412e-02,
         -2.52788966e-02,  -1.73087496e-02,  -2.50927877e-02,
          9.79992365e-02,   8.10859529e-02],
       [ -8.86293797e-03,   2.66086095e-02,  -5.51701949e-02,
         -9.55853228e-02,   1.18356808e-06,   2.65564312e-02,
         -2.46360100e-02,  -4.28188358e-02,   3.79433914e-06,
         -1.78852055e-03,   1.00211427e-05,   8.64778802e-07,
         -2.47568369e-03,   4.28085149e-03,  -2.51236888e-02,
         -2.77549041e-02,  -2.52365193e-02,  -2.75761702e-02,
          8.10859529e-02,   7.03000120e-02]])

    results = ['ref_result_dm_alpha', 'ref_result_energy', 'ref_result_exp_alpha', 'ref_result_exp_beta', 'ref_result_dm_beta']
    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_numlda.py")
    with open(test_path) as fh:
        exec fh

    l = locals()
    for r in results:
        var_name = r.split("ref_")[-1]
        assert allclose(l[var_name], l[r], thresholds[r]), l[r] - l[var_name]