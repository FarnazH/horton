# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_dm_alpha = array([[  1.03151730e+00,  -4.58379896e-02,  -3.99279509e-06,
          2.40219212e-06,  -3.60824368e-08,  -1.09613625e-01,
         -4.85656018e-06,   1.97526830e-06,   6.04921138e-08,
          1.56401726e-03,   7.28138098e-08,  -1.21506699e-08,
          1.47918067e-06,  -2.13948317e-07,  -2.91069562e-02,
         -3.85494514e-03,  -2.91176230e-02,  -3.84704878e-03,
         -2.91119019e-02,  -3.85386916e-03],
       [ -4.58379896e-02,   1.61074729e-01,   6.96694458e-06,
         -3.03609100e-06,   1.09246105e-06,   1.69057743e-01,
          8.96142617e-06,  -2.77532458e-06,   5.21312372e-07,
         -2.57973069e-03,  -2.26925760e-07,   2.09068772e-07,
         -2.73494430e-06,   4.26269247e-07,   5.46754731e-02,
          1.72576204e-02,   5.46990184e-02,   1.72435199e-02,
          5.46852507e-02,   1.72554523e-02],
       [ -3.99279509e-06,   6.96694458e-06,   2.00082724e-01,
          2.18570158e-06,  -3.38496011e-07,   1.22474622e-05,
          9.38800242e-02,   5.07714494e-06,  -1.66356876e-06,
          3.72817025e-06,   1.19910380e-06,   5.41763650e-07,
          8.94485411e-03,   3.69526567e-06,   1.22898448e-01,
          1.01252035e-01,  -6.14713642e-02,  -5.06174159e-02,
         -6.14589061e-02,  -5.06249143e-02],
       [  2.40219212e-06,  -3.03609100e-06,   2.18570158e-06,
          2.00072214e-01,   5.60128517e-06,  -7.29157838e-06,
         -2.81711230e-06,   9.38818551e-02,   4.00250506e-06,
         -1.54128599e-06,   3.89465829e-07,  -3.80041401e-07,
         -2.78026145e-06,  -8.94273515e-03,   7.12560283e-06,
          4.97362855e-06,   1.06477001e-01,   8.76439037e-02,
         -1.06450375e-01,  -8.76632695e-02],
       [ -3.60824368e-08,   1.09246105e-06,  -3.38496011e-07,
          5.60128517e-06,   3.60895370e-01,  -1.58644143e-06,
         -2.73288543e-06,   9.98475365e-06,   3.16805565e-01,
         -8.46552214e-08,   2.88060921e-06,  -3.59481748e-06,
          7.74038033e-07,  -1.52689584e-06,   4.43362780e-06,
          3.30780238e-07,  -1.02330594e-05,  -2.57512689e-06,
          6.04566073e-06,   3.84180865e-06],
       [ -1.09613625e-01,   1.69057743e-01,   1.22474622e-05,
         -7.29157838e-06,  -1.58644143e-06,   1.81150518e-01,
          1.18036183e-05,  -4.86706898e-06,  -1.85006515e-06,
         -2.75769997e-03,  -2.38670424e-07,   2.16619027e-07,
         -2.69755756e-06,   6.32423121e-07,   5.82063161e-02,
          1.80515806e-02,   5.82246970e-02,   1.80311353e-02,
          5.82144082e-02,   1.80473812e-02],
       [ -4.85656018e-06,   8.96142617e-06,   9.38800242e-02,
         -2.81711230e-06,  -2.73288543e-06,   1.18036183e-05,
          4.40490754e-02,   5.78998641e-07,  -3.04014798e-06,
          1.65703082e-06,   5.62590696e-07,   2.54239044e-07,
          4.19697959e-03,   1.90561769e-06,   5.76666453e-02,
          4.75086754e-02,  -2.88428294e-02,  -2.37510729e-02,
         -2.88328953e-02,  -2.37512239e-02],
       [  1.97526830e-06,  -2.77532458e-06,   5.07714494e-06,
          9.38818551e-02,   9.98475365e-06,  -4.86706898e-06,
          5.78998641e-07,   4.40531076e-02,   8.33580195e-06,
         -7.01146580e-07,   1.82837792e-07,  -1.78394606e-07,
         -1.12344080e-06,  -4.19628762e-03,   5.36765268e-06,
          4.23989553e-06,   4.99615415e-02,   4.11248427e-02,
         -4.99524667e-02,  -4.11362684e-02],
       [  6.04921138e-08,   5.21312372e-07,  -1.66356876e-06,
          4.00250506e-06,   3.16805565e-01,  -1.85006515e-06,
         -3.04014798e-06,   8.33580195e-06,   2.78102116e-01,
         -6.73485786e-08,   2.52868208e-06,  -3.15564895e-06,
          6.18409749e-07,  -1.29950983e-06,   2.90452900e-06,
         -4.48043453e-07,  -9.19797879e-06,  -2.36233710e-06,
          6.06519173e-06,   4.07195637e-06],
       [  1.56401726e-03,  -2.57973069e-03,   3.72817025e-06,
         -1.54128599e-06,  -8.46552214e-08,  -2.75769997e-03,
          1.65703082e-06,  -7.01146580e-07,  -6.73485786e-08,
          4.19926002e-05,   3.66048173e-09,  -3.29571773e-09,
          2.16128288e-07,   6.42916928e-08,  -8.84347733e-04,
         -2.73589045e-04,  -8.89114562e-04,  -2.76972811e-04,
         -8.87198911e-04,  -2.75772608e-04],
       [  7.28138098e-08,  -2.26925760e-07,   1.19910380e-06,
          3.89465829e-07,   2.88060921e-06,  -2.38670424e-07,
          5.62590696e-07,   1.82837792e-07,   2.52868208e-06,
          3.66048173e-09,   3.12566822e-11,  -2.64802484e-11,
          5.36118664e-08,  -1.73960304e-08,   6.59436845e-07,
          5.82514863e-07,  -2.38432738e-07,  -1.57081388e-07,
         -6.52632663e-07,  -4.98295087e-07],
       [ -1.21506699e-08,   2.09068772e-07,   5.41763650e-07,
         -3.80041401e-07,  -3.59481748e-06,   2.16619027e-07,
          2.54239044e-07,  -1.78394606e-07,  -3.15564895e-06,
         -3.29571773e-09,  -2.64802484e-11,   3.82695172e-11,
          2.42136543e-08,   1.70102758e-08,   4.03041258e-07,
          2.96590446e-07,  -2.98205752e-07,  -2.81057639e-07,
          1.06050901e-07,   5.18260583e-08],
       [  1.47918067e-06,  -2.73494430e-06,   8.94485411e-03,
         -2.78026145e-06,   7.74038033e-07,  -2.69755756e-06,
          4.19697959e-03,  -1.12344080e-06,   6.18409749e-07,
          2.16128288e-07,   5.36118664e-08,   2.42136543e-08,
          3.99886775e-04,   2.93829820e-07,   5.49322630e-03,
          4.52622556e-03,  -2.75070205e-03,  -2.26447714e-03,
         -2.74708184e-03,  -2.26229078e-03],
       [ -2.13948317e-07,   4.26269247e-07,   3.69526567e-06,
         -8.94273515e-03,  -1.52689584e-06,   6.32423121e-07,
          1.90561769e-06,  -4.19628762e-03,  -1.29950983e-06,
          6.42916928e-08,  -1.73960304e-08,   1.70102758e-08,
          2.93829820e-07,   3.99718310e-04,   2.11016356e-06,
          1.72820678e-06,  -4.76032599e-03,  -3.91839509e-03,
          4.75700339e-03,   3.91740360e-03],
       [ -2.91069562e-02,   5.46754731e-02,   1.22898448e-01,
          7.12560283e-06,   4.43362780e-06,   5.82063161e-02,
          5.76666453e-02,   5.36765268e-06,   2.90452900e-06,
         -8.84347733e-04,   6.59436845e-07,   4.03041258e-07,
          5.49322630e-03,   2.11016356e-06,   9.42253242e-02,
          6.80351047e-02,  -1.90077691e-02,  -2.52489392e-02,
         -1.90120869e-02,  -2.52554372e-02],
       [ -3.85494514e-03,   1.72576204e-02,   1.01252035e-01,
          4.97362855e-06,   3.30780238e-07,   1.80515806e-02,
          4.75086754e-02,   4.23989553e-06,  -4.48043453e-07,
         -2.73589045e-04,   5.82514863e-07,   2.96590446e-07,
          4.52622556e-03,   1.72820678e-06,   6.80351047e-02,
          5.30880108e-02,  -2.52599635e-02,  -2.37647611e-02,
         -2.52595925e-02,  -2.37709534e-02],
       [ -2.91176230e-02,   5.46990184e-02,  -6.14713642e-02,
          1.06477001e-01,  -1.02330594e-05,   5.82246970e-02,
         -2.88428294e-02,   4.99615415e-02,  -9.19797879e-06,
         -8.89114562e-04,  -2.38432738e-07,  -2.98205752e-07,
         -2.75070205e-03,  -4.76032599e-03,  -1.90077691e-02,
         -2.52599635e-02,   9.43108703e-02,   6.80382743e-02,
         -1.90179174e-02,  -2.52540573e-02],
       [ -3.84704878e-03,   1.72435199e-02,  -5.06174159e-02,
          8.76439037e-02,  -2.57512689e-06,   1.80311353e-02,
         -2.37510729e-02,   4.11248427e-02,  -2.36233710e-06,
         -2.76972811e-04,  -1.57081388e-07,  -2.81057639e-07,
         -2.26447714e-03,  -3.91839509e-03,  -2.52489392e-02,
         -2.37647611e-02,   6.80382743e-02,   5.30469408e-02,
         -2.52425359e-02,  -2.37459529e-02],
       [ -2.91119019e-02,   5.46852507e-02,  -6.14589061e-02,
         -1.06450375e-01,   6.04566073e-06,   5.82144082e-02,
         -2.88328953e-02,  -4.99524667e-02,   6.06519173e-06,
         -8.87198911e-04,  -6.52632663e-07,   1.06050901e-07,
         -2.74708184e-03,   4.75700339e-03,  -1.90120869e-02,
         -2.52595925e-02,  -1.90179174e-02,  -2.52425359e-02,
          9.42618140e-02,   6.80362481e-02],
       [ -3.85386916e-03,   1.72554523e-02,  -5.06249143e-02,
         -8.76632695e-02,   3.84180865e-06,   1.80473812e-02,
         -2.37512239e-02,  -4.11362684e-02,   4.07195637e-06,
         -2.75772608e-04,  -4.98295087e-07,   5.18260583e-08,
         -2.26229078e-03,   3.91740360e-03,  -2.52554372e-02,
         -2.37709534e-02,  -2.52540573e-02,  -2.37459529e-02,
          6.80362481e-02,   5.30687163e-02]])
    ref_result_energy = -39.761050200484853
    ref_result_exp_alpha = array([[  9.94857539e-01,  -2.04391230e-01,  -1.35033536e-05,
          1.43243517e-05,  -9.45888504e-07,   1.54003315e-01,
          1.25289402e-05,  -2.71491425e-05,   9.44884303e-07,
         -2.01352069e-06,   8.15978234e-06,   4.68987369e-02,
         -6.23136315e-07,   1.42046851e-06,   3.48063807e-02,
         -1.16870246e-06,  -2.85109970e-06,  -4.11170402e-02,
          1.62327623e-05,   3.02903245e-05],
       [  3.60464696e-02,   3.99719163e-01,   2.15377525e-05,
         -2.63803390e-05,   4.42520670e-07,  -2.57940541e-01,
         -2.46011291e-05,   5.52129169e-05,   1.13964263e-05,
          5.60401213e-05,   8.86725537e-05,   6.60712951e-01,
         -3.24788526e-05,   7.16236116e-04,  -1.94836014e+00,
          3.17012945e-05,   2.08827787e-05,  -2.73721207e-01,
          6.13891968e-05,   1.25460564e-04],
       [  1.32292125e-07,  -1.59120680e-05,   7.95191912e-02,
         -4.40181145e-01,  -1.62334921e-06,  -3.00418842e-05,
          4.43523170e-01,  -2.71194148e-02,  -2.86665580e-05,
          7.78307837e-01,  -2.81866795e-01,   2.63188491e-05,
         -7.50188553e-01,   1.10771792e-01,   7.63147243e-05,
         -2.86784984e-08,  -9.20619602e-06,   9.96970499e-07,
          5.17517596e-02,   2.91468971e-02],
       [ -1.84617901e-07,   1.07246721e-05,  -4.40168674e-01,
         -7.95220189e-02,  -5.95696785e-06,   8.93114636e-05,
          2.71430361e-02,   4.43509821e-01,   1.31110904e-04,
         -2.81900954e-01,  -7.78342056e-01,   2.57445915e-04,
         -1.10776136e-01,  -7.50150063e-01,  -2.35412246e-04,
          7.34876554e-06,   3.19992262e-06,   1.18071616e-05,
          2.91150961e-02,  -5.18201272e-02],
       [  9.31991178e-08,   3.30944702e-06,  -4.97334922e-06,
          2.08691748e-06,  -6.00745710e-01,  -3.89622779e-06,
         -6.52890690e-06,  -3.24226308e-06,   1.05818326e+00,
          8.79864936e-05,   1.33795156e-04,  -1.02235793e-05,
         -8.97456346e-07,   1.82132612e-05,   3.68128961e-06,
         -3.52057065e-06,  -2.53870671e-06,   8.30755723e-07,
         -1.46701066e-06,   3.36298406e-06],
       [ -2.28642786e-02,   4.25003173e-01,   3.39851495e-05,
         -3.70931856e-05,   5.35137380e-06,  -1.84859563e+00,
         -1.02025180e-04,   3.34897258e-04,  -2.77636057e-05,
         -1.17299872e-04,  -1.35049025e-04,  -9.88483560e-01,
          5.77947701e-05,  -1.29829355e-03,   3.60639369e+00,
         -5.55604203e-05,  -2.67380193e-05,   7.92530029e-01,
         -2.07482009e-04,  -4.10088953e-04],
       [ -8.25674050e-09,   6.77482181e-06,   3.73192293e-02,
         -2.06534118e-01,   3.52331000e-06,  -8.14250517e-05,
          1.27804170e+00,  -7.81727129e-02,   7.33585591e-05,
         -1.59228702e+00,   5.76691950e-01,  -1.10242661e-04,
          1.13200459e+00,  -1.67157990e-01,  -1.52339247e-04,
         -2.53311376e-06,   1.51490465e-05,   3.07815536e-04,
          4.65516757e-01,   2.61838703e-01],
       [  7.20072353e-08,   1.64538704e-06,  -2.06542961e-01,
         -3.73239018e-02,  -1.50408633e-05,   2.08611618e-04,
          7.81292569e-02,   1.27803554e+00,  -2.71834183e-04,
          5.76685675e-01,   1.59241841e+00,  -5.14881027e-04,
          1.67088624e-01,   1.13184584e+00,   3.40889505e-04,
         -2.49845434e-05,  -1.90157513e-05,  -2.04224527e-04,
          2.61867317e-01,  -4.65488407e-01],
       [ -4.17631206e-08,   1.86820087e-06,  -2.89641067e-06,
          5.20126326e-06,  -5.27353849e-01,   3.57575039e-06,
          9.35310608e-06,  -1.06583248e-05,  -1.09660619e+00,
         -9.77101866e-05,  -1.43248516e-04,   1.01457170e-05,
         -2.94028472e-06,  -6.65726335e-06,  -3.05646594e-06,
         -9.68416497e-07,  -4.86032666e-06,  -9.98065647e-07,
         -1.05503569e-06,   1.65984972e-06],
       [  2.41693215e-04,  -6.47565660e-03,   4.68739636e-06,
         -7.39429733e-06,   1.57255967e-07,  -1.69943828e-02,
         -1.25328158e-05,   9.15079656e-06,  -8.21317605e-07,
          2.54761316e-05,  -2.59277560e-05,  -1.85186243e-01,
          5.36060753e-05,  -8.92827759e-05,  -2.71469816e-02,
          5.38723027e-06,  -6.23514295e-09,  -1.05102472e+00,
          3.04686317e-04,   5.76387309e-04],
       [ -4.26640749e-08,  -5.64271461e-07,  -3.86572293e-07,
         -2.75709588e-06,  -4.78410915e-06,   2.94582864e-06,
          5.69453391e-07,  -2.49095348e-06,   8.80838374e-07,
          1.14793016e-06,  -6.22244774e-06,   9.00492744e-06,
          6.53333279e-06,   1.71617731e-05,   1.96023075e-05,
          9.92439692e-01,   1.22733270e-01,   2.93638845e-06,
          1.73834525e-05,  -3.06395874e-05],
       [  9.35277892e-08,   5.14757115e-07,   1.08690260e-06,
         -1.03438029e-06,   5.97247572e-06,  -6.18091532e-06,
         -3.51736629e-06,   3.13467619e-07,   1.41765362e-06,
          6.75740350e-06,  -2.49161039e-06,  -2.09751970e-05,
          1.89489733e-05,  -7.75109074e-06,  -1.55093831e-05,
          1.22733271e-01,  -9.92439692e-01,   4.84519006e-06,
          5.53210165e-06,   2.47465795e-05],
       [  1.04581558e-07,  -8.34155621e-06,   3.56130841e-03,
         -1.96774957e-02,  -1.38628894e-06,  -1.55927187e-05,
         -2.20815475e-02,   1.36360951e-03,  -4.68641250e-06,
          1.09863063e-01,  -3.97680431e-02,  -6.68321840e-05,
          1.95601359e-01,  -2.89460923e-02,  -5.38769077e-05,
         -4.17821264e-06,   2.29277339e-05,   5.95555915e-04,
          9.45283700e-01,   5.31709355e-01],
       [  4.94041032e-08,   2.31489849e-07,   1.96759822e-02,
          3.54608763e-03,   2.39118142e-06,  -2.07729669e-06,
          1.33572545e-03,   2.20922246e-02,  -1.60782926e-05,
          3.98091544e-02,   1.09853226e-01,  -1.88436638e-05,
         -2.88290876e-02,  -1.95695103e-01,  -8.03383953e-05,
          3.95101522e-05,   2.64890924e-05,   3.83314164e-04,
         -5.31727828e-01,   9.45256985e-01],
       [ -1.13394091e-03,   1.36866530e-01,   4.88351278e-02,
         -2.70382555e-01,  -8.01706501e-06,   1.13389582e-01,
         -1.27253057e-01,   7.79563319e-03,  -1.09373131e-05,
          4.01337350e-01,  -1.45250557e-01,   6.37208079e-01,
          8.65326456e-01,  -1.27724293e-01,   2.85750054e-01,
         -1.44423985e-05,  -1.24334411e-05,  -3.76776556e-01,
         -5.94260846e-01,  -3.34172476e-01],
       [  4.90462407e-03,   4.27152189e-02,   4.02335300e-02,
         -2.22756854e-01,  -1.57673896e-06,   9.53213308e-01,
         -1.62451651e+00,   9.91497800e-02,  -2.66332353e-05,
          4.38942403e-01,  -1.59036549e-01,  -2.30664420e-01,
         -1.55253062e+00,   2.29545464e-01,  -1.09462310e+00,
          2.68107975e-05,  -3.09952200e-06,  -6.45670557e-02,
         -9.51336373e-03,  -5.27550172e-03],
       [ -1.13364321e-03,   1.36965945e-01,  -2.58683305e-01,
          9.29138490e-02,   2.02057521e-05,   1.13340636e-01,
          5.69098000e-02,  -1.14068750e-01,   6.09686166e-05,
         -3.26473961e-01,  -2.74712975e-01,   6.36913272e-01,
         -3.21916177e-01,   8.13238424e-01,   2.85999775e-01,
         -8.55473947e-07,  -1.80985139e-05,  -3.76161166e-01,
          7.79235615e-03,   6.82360428e-01],
       [  4.90443025e-03,   4.27132890e-02,  -2.12938405e-01,
          7.65232295e-02,   6.39773532e-06,   9.52787764e-01,
          7.26294491e-01,  -1.45680981e+00,   1.00797684e-04,
         -3.57115831e-01,  -3.00794292e-01,  -2.30309430e-01,
          5.77720253e-01,  -1.45877500e+00,  -1.09523504e+00,
          3.28100251e-05,   3.74843692e-05,  -6.44039975e-02,
          1.06818242e-04,   1.07544371e-02],
       [ -1.13385920e-03,   1.36911881e-01,   2.09773344e-01,
          1.77512674e-01,  -1.04765418e-05,   1.13396870e-01,
          7.03883014e-02,   1.06280044e-01,  -3.27676406e-05,
         -7.48417972e-02,   4.20290314e-01,   6.37166548e-01,
         -5.43316663e-01,  -6.85452510e-01,   2.85566117e-01,
         -8.46429344e-06,  -3.35961152e-05,  -3.76483775e-01,
          5.86918940e-01,  -3.47387060e-01],
       [  4.90461712e-03,   4.27270133e-02,   1.72743857e-01,
          1.46214034e-01,  -7.23592246e-06,   9.53274846e-01,
          8.98354456e-01,   1.35709176e+00,  -6.05272669e-05,
         -8.17066086e-02,   4.59701130e-01,  -2.31054470e-01,
          9.74749731e-01,   1.23010878e+00,  -1.09443076e+00,
         -3.04001634e-06,   1.98712713e-05,  -6.45042595e-02,
          9.37681993e-03,  -5.50132337e-03]])
    ref_result_exp_beta = array([[  9.95042649e-01,   1.96041867e-01,  -1.35817300e-05,
         -1.76111847e-05,   7.09039642e-06,  -1.61459431e-01,
          5.82484377e-06,  -4.39804268e-05,   2.11957041e-06,
         -9.81548623e-06,  -2.52228586e-06,   5.85002322e-02,
          8.56125938e-07,   1.28953597e-05,   3.62094603e-02,
         -4.78980748e-06,  -2.33254956e-05,  -3.14811826e-02,
         -4.60243741e-05,   3.75916224e-05],
       [  3.45127157e-02,  -3.80002348e-01,   3.04460723e-05,
          2.29485336e-05,  -3.63112987e-05,   2.56249475e-01,
         -2.79039543e-05,   6.52423795e-05,  -5.53532242e-05,
         -9.30784114e-05,   3.85229666e-05,   5.42011936e-01,
         -2.79838331e-05,   6.31382057e-04,  -1.98021986e+00,
         -4.91277672e-05,  -6.08595130e-05,  -3.29963226e-01,
         -4.23132007e-04,   2.74294414e-04],
       [ -1.53723417e-07,   3.80662047e-05,   6.04181394e-02,
          4.25164236e-01,   3.53131552e-05,   2.41903543e-05,
          4.40620883e-01,  -7.24900921e-02,  -7.70041558e-01,
          2.55857441e-01,   4.03067472e-04,  -3.88865998e-05,
          7.72587012e-01,   1.37008981e-01,   3.23450603e-05,
          1.09673892e-05,   2.77995548e-05,   4.15562109e-05,
         -5.49424783e-02,   1.99862554e-02],
       [ -7.35518596e-07,   4.78329856e-06,  -4.25165875e-01,
          6.04350240e-02,  -4.64475404e-05,  -1.41289486e-04,
          7.25204243e-02,   4.40610262e-01,   2.55889162e-01,
          7.70101990e-01,  -5.55964515e-04,   2.79660054e-04,
          1.36985748e-01,  -7.72518064e-01,  -2.24626980e-04,
         -2.06017387e-05,   5.33030999e-06,  -3.20996256e-05,
         -1.99441873e-02,  -5.50018287e-02],
       [ -7.76266077e-07,   1.85827666e-05,   8.30664429e-05,
          4.76701977e-05,   5.34260595e-01,   3.68676319e-06,
         -1.75012156e-06,  -1.97391720e-05,  -7.96086403e-04,
         -5.86543882e-04,  -1.09325743e+00,  -1.37269307e-04,
         -5.74698946e-05,  -1.57551723e-04,  -6.37137157e-05,
         -7.15591134e-05,   2.23747649e-05,  -4.81780997e-05,
          1.88545929e-05,  -4.18034279e-06],
       [ -2.15150637e-02,  -3.65928515e-01,   2.69609658e-05,
          3.53171073e-05,  -4.53419323e-05,   1.91186664e+00,
          1.88743646e-06,   5.56697920e-04,   8.52017186e-05,
          2.07644837e-04,  -1.59619956e-04,  -8.64788130e-01,
          6.80575836e-05,  -1.16973226e-03,   3.60531658e+00,
          1.19546403e-04,   2.84664450e-04,   8.20954975e-01,
          1.06584672e-03,  -7.32917693e-04],
       [  5.82143589e-08,  -4.57589662e-06,   2.60292023e-02,
          1.83100131e-01,   1.85829391e-05,   1.01974315e-04,
          1.28248069e+00,  -2.11043201e-01,   1.58322046e+00,
         -5.26090987e-01,  -7.69781372e-04,  -2.27523184e-06,
         -1.14495207e+00,  -2.03044537e-01,  -8.96367005e-05,
         -5.42341392e-05,  -8.16340947e-05,   8.70569550e-04,
         -5.03665530e-01,   1.82929891e-01],
       [  3.12580107e-07,  -2.48919759e-06,  -1.83118080e-01,
          2.60394271e-02,  -4.31035795e-06,  -3.01129528e-04,
          2.10971224e-01,   1.28245378e+00,  -5.26067562e-01,
         -1.58342106e+00,   1.03874431e-03,  -5.44629984e-04,
         -2.02943697e-01,   1.14474781e+00,   3.11476675e-04,
         -2.80980693e-05,   8.70829925e-05,  -2.15573911e-04,
         -1.82957391e-01,  -5.03644828e-01],
       [  2.73505752e-07,  -3.15212310e-06,   2.33882914e-05,
          1.37262377e-05,   5.94058870e-01,   5.74629443e-05,
         -5.75548034e-05,   1.22738893e-04,   8.15453162e-04,
          5.99984161e-04,   1.06195114e+00,   1.23906924e-04,
          4.43673519e-05,   1.28760122e-04,   4.71788441e-05,
          3.76268960e-05,  -5.72979246e-06,   2.72689237e-05,
         -7.22594424e-06,   4.96689648e-06],
       [ -6.18566432e-04,   3.18314380e-02,   1.18331351e-05,
         -3.01388509e-06,  -1.92953950e-05,  -1.40474271e-02,
         -1.88512574e-05,  -8.27317329e-06,  -1.58320487e-05,
         -4.61304403e-06,   5.63045725e-05,  -1.55704998e-01,
         -6.53224538e-05,  -8.23878476e-05,   1.42308261e-02,
         -1.01782427e-04,  -5.05028435e-04,  -1.05562988e+00,
         -1.38352139e-03,   9.76557706e-04],
       [  5.64082463e-07,  -1.38311402e-05,   1.89084762e-06,
          1.17892693e-05,  -1.20137570e-05,   1.63892314e-05,
          8.75151070e-06,  -6.06778788e-06,  -1.76590131e-05,
          9.46152789e-06,   2.97681008e-05,  -1.69590727e-05,
          6.84422168e-06,   2.10669368e-05,  -2.58770742e-05,
         -7.51031594e-01,  -6.60266137e-01,   3.89604568e-04,
          9.71588728e-05,  -8.57094089e-05],
       [ -1.07096838e-06,   1.48855597e-05,   2.09576780e-06,
         -2.19838468e-07,  -2.97176725e-05,  -1.25482515e-05,
         -5.95641893e-06,  -4.04970553e-06,  -3.06371446e-06,
          5.96098203e-06,   4.40762826e-05,  -2.26252728e-06,
         -2.32838434e-05,   7.78339226e-06,   3.72023302e-05,
         -6.60266249e-01,   7.51031533e-01,  -2.94076502e-04,
          2.57670570e-05,   1.55535185e-04],
       [ -7.96265532e-08,   1.29005821e-05,   2.80547265e-03,
          1.96891402e-02,   7.88802670e-06,   1.22474876e-05,
         -1.87435069e-02,   3.09760947e-03,  -1.13868219e-01,
          3.78100363e-02,   6.32295838e-05,  -7.30570605e-05,
         -1.88929970e-01,  -3.35673276e-02,  -4.18910124e-05,
         -7.39270204e-05,  -1.12465815e-04,   1.70634178e-03,
         -1.02012760e+00,   3.70510999e-01],
       [  2.18874994e-07,  -2.87442195e-06,   1.96878297e-02,
         -2.78695350e-03,  -7.03520092e-06,   3.49198006e-06,
          3.07219596e-03,   1.87552865e-02,  -3.78595492e-02,
         -1.13848836e-01,   1.14191368e-04,  -9.15715280e-06,
          3.34528830e-02,  -1.89026521e-01,  -7.15328697e-05,
          6.74092575e-05,  -1.60712833e-04,   4.72171111e-04,
          3.70535526e-01,   1.02010623e+00],
       [ -1.19968045e-03,  -1.51362923e-01,   4.06037316e-02,
          2.85779859e-01,  -2.27317297e-05,  -9.50410072e-02,
         -1.10954612e-01,   1.82663678e-02,  -4.22514436e-01,
          1.40305453e-01,   2.29429959e-04,   6.62250148e-01,
         -8.52790244e-01,  -1.51080645e-01,   2.60086944e-01,
          2.12184606e-05,  -1.30963722e-04,  -3.51504173e-01,
          6.36906311e-01,  -2.31214291e-01],
       [  4.62489026e-03,  -6.94618516e-02,   3.55803712e-02,
          2.50412454e-01,  -5.75149353e-05,  -9.74051503e-01,
         -1.61645851e+00,   2.65668147e-01,  -4.09472648e-01,
          1.36099511e-01,   1.82957224e-04,  -2.66056430e-01,
          1.54029578e+00,   2.73348103e-01,  -1.06542371e+00,
         -1.87875867e-05,   1.98674635e-05,  -8.15865131e-02,
          1.27279921e-02,  -4.54590482e-03],
       [ -1.19941155e-03,  -1.51473790e-01,  -2.67887882e-01,
         -1.07731679e-01,   5.37208284e-05,  -9.49841264e-02,
          3.96877546e-02,  -1.05194970e-01,   3.32722923e-01,
          2.95521323e-01,  -6.21020746e-04,   6.61884780e-01,
          2.95354987e-01,   8.14212181e-01,   2.60264060e-01,
         -1.65225520e-05,  -2.95068032e-04,  -3.49792097e-01,
         -1.18738207e-01,   6.68281315e-01],
       [  4.62464048e-03,  -6.94676810e-02,  -2.34542893e-01,
         -9.43656142e-02,   1.79445277e-04,  -9.73515465e-01,
          5.77904662e-01,  -1.53320137e+00,   3.22587323e-01,
          2.86764303e-01,   3.81810276e-05,  -2.65523604e-01,
         -5.33654704e-01,  -1.47024135e+00,  -1.06588304e+00,
         -2.92809941e-05,  -2.85025746e-05,  -8.14166866e-02,
         -2.42105144e-03,   1.33277894e-02],
       [ -1.19991156e-03,  -1.51416939e-01,   2.27205957e-01,
         -1.78062282e-01,  -5.34831285e-07,  -9.50690754e-02,
          7.13105432e-02,   8.69323689e-02,   8.97036020e-02,
         -4.36064147e-01,   1.49354429e-04,   6.62270379e-01,
          5.57377145e-01,  -6.62816123e-01,   2.59933785e-01,
         -1.33464290e-04,  -1.27521123e-04,  -3.50237017e-01,
         -5.19694469e-01,  -4.35921822e-01],
       [  4.62512764e-03,  -6.94831432e-02,   1.98993622e-01,
         -1.55985986e-01,  -1.20947352e-05,  -9.74234254e-01,
          1.03854649e+00,   1.26665029e+00,   8.68504317e-02,
         -4.22884525e-01,   1.16363836e-04,  -2.66441276e-01,
         -1.00670496e+00,   1.19751516e+00,  -1.06522765e+00,
          7.33996637e-06,  -1.16714253e-05,  -8.14705572e-02,
         -1.05345305e-02,  -8.67844840e-03]])
    ref_result_dm_beta = array([[  1.02854229e+00,  -4.01547711e-02,  -9.96869347e-07,
          4.88984709e-06,   2.85287940e-06,  -9.31457012e-02,
         -4.41897000e-06,   1.83755180e-06,  -3.62069785e-07,
          5.62479394e-03,  -2.15037870e-06,   1.85246082e-06,
          2.06507802e-06,  -5.64783876e-07,  -3.08727901e-02,
         -9.02035443e-03,  -3.08831373e-02,  -9.01201788e-03,
         -3.08779749e-02,  -9.01935610e-03],
       [ -4.01547711e-02,   1.45592986e-01,  -2.87466079e-06,
         -1.33384725e-05,  -7.04532217e-06,   1.38311162e-01,
          6.73770625e-06,  -3.99502264e-06,   1.23494192e-06,
         -1.21173705e-02,   5.27554417e-06,  -5.69333757e-06,
         -4.36786776e-06,   1.63683936e-06,   5.74846756e-02,
          2.65621070e-02,   5.75083948e-02,   2.65482055e-02,
          5.75002264e-02,   2.65658507e-02],
       [ -9.96869347e-07,  -2.87466079e-06,   1.84415035e-01,
          7.02895575e-06,   2.52866440e-05,   2.70556660e-06,
          7.94202282e-02,   7.30981375e-06,   7.24864916e-06,
          6.43718420e-07,   5.13823918e-06,   3.36676009e-08,
          8.54062989e-03,   4.58707378e-06,   1.23950857e-01,
          1.08613496e-01,  -6.19947096e-02,  -5.42941517e-02,
         -6.19841411e-02,  -5.42995151e-02],
       [  4.88984709e-06,  -1.33384725e-05,   7.02895575e-06,
          1.84418487e-01,  -3.24355257e-05,  -1.09179060e-05,
         -1.13725736e-06,   7.94292518e-02,  -9.11417011e-06,
         -5.06352161e-06,  -9.15586470e-08,  -8.92074689e-07,
         -2.87567045e-06,  -8.53902579e-03,   7.05398222e-06,
          5.77202662e-06,   1.07385284e-01,   9.40162482e-02,
         -1.07362203e-01,  -9.40327115e-02],
       [  2.85287940e-06,  -7.04532217e-06,   2.52866440e-05,
         -3.24355257e-05,   9.51428704e-09,  -6.74171615e-06,
          1.08902977e-05,  -1.39695151e-05,   2.53724906e-09,
          5.89549553e-07,   4.64701273e-10,   4.37354986e-10,
          1.17184404e-06,   1.50246820e-06,   1.41994868e-05,
          1.36052844e-05,  -3.01859024e-05,  -2.52679853e-05,
          7.58761076e-06,   7.80611847e-06],
       [ -9.31457012e-02,   1.38311162e-01,   2.70556660e-06,
         -1.09179060e-05,  -6.74171615e-06,   1.34366527e-01,
          8.83869847e-06,  -3.05145123e-06,   1.17445699e-06,
         -1.16347182e-02,   5.04942461e-06,  -5.42384942e-06,
         -3.94865779e-06,   1.47702195e-06,   5.54249943e-02,
          2.53283453e-02,   5.54434079e-02,   2.53111059e-02,
          5.54333733e-02,   2.53261476e-02],
       [ -4.41897000e-06,   6.73770625e-06,   7.94202282e-02,
         -1.13725736e-06,   1.08902977e-05,   8.83869847e-06,
          3.42031372e-02,   1.35455184e-06,   3.12197865e-06,
         -3.90452488e-07,   2.21312774e-06,   1.42070678e-08,
          3.67810979e-03,   2.16834589e-06,   5.33838846e-02,
          4.67769753e-02,  -2.66979060e-02,  -2.33829993e-02,
         -2.66885067e-02,  -2.33810626e-02],
       [  1.83755180e-06,  -3.99502264e-06,   7.30981375e-06,
          7.94292518e-02,  -1.39695151e-05,  -3.05145123e-06,
          1.35455184e-06,   3.42102691e-02,  -3.92530025e-06,
         -2.32601254e-06,  -3.92518311e-08,  -3.84285171e-07,
         -1.04027710e-06,  -3.67776798e-03,   6.60430385e-06,
          5.32713509e-06,   4.62502121e-02,   4.04919628e-02,
         -4.62417740e-02,  -4.05009377e-02],
       [ -3.62069785e-07,   1.23494192e-06,   7.24864916e-06,
         -9.11417011e-06,   2.53724906e-09,   1.17445699e-06,
          3.12197865e-06,  -3.92530025e-06,   7.45842702e-10,
         -1.02508252e-07,   2.51242649e-10,  -2.86477656e-12,
          3.35821757e-07,   4.22210053e-07,   5.35962811e-06,
          4.49435420e-06,  -7.25620254e-06,  -6.55555541e-06,
          3.35739714e-06,   2.73814199e-06],
       [  5.62479394e-03,  -1.21173705e-02,   6.43718420e-07,
         -5.06352161e-06,   5.89549553e-07,  -1.16347182e-02,
         -3.90452488e-07,  -2.32601254e-06,  -1.02508252e-07,
          1.01362291e-03,  -4.40617166e-07,   4.74506620e-07,
          3.84482921e-07,   1.49507166e-07,  -4.81773905e-03,
         -2.21426461e-03,  -4.82373001e-03,  -2.21660708e-03,
         -4.81585149e-03,  -2.21178324e-03],
       [ -2.15037870e-06,   5.27554417e-06,   5.13823918e-06,
         -9.15586470e-08,   4.64701273e-10,   5.04942461e-06,
          2.21312774e-06,  -3.92518311e-08,   2.51242649e-10,
         -4.40617166e-07,   3.34848356e-10,  -2.05113568e-10,
          2.37809647e-07,   4.41323780e-09,   5.54687485e-06,
          3.98993491e-06,   3.13603766e-07,  -5.96185007e-07,
          4.19880694e-07,  -5.02626280e-07],
       [  1.85246082e-06,  -5.69333757e-06,   3.36676009e-08,
         -8.92074689e-07,   4.37354986e-10,  -5.42384942e-06,
          1.42070678e-08,  -3.84285171e-07,  -2.86477656e-12,
          4.74506620e-07,  -2.05113568e-10,   2.27039614e-10,
          1.74056876e-09,   4.12662559e-08,  -2.22955692e-06,
         -1.01942389e-06,  -2.78407187e-06,  -1.50356837e-06,
         -1.74435740e-06,  -5.94090411e-07],
       [  2.06507802e-06,  -4.36786776e-06,   8.54062989e-03,
         -2.87567045e-06,   1.17184404e-06,  -3.94865779e-06,
          3.67810979e-03,  -1.04027710e-06,   3.35821757e-07,
          3.84482921e-07,   2.37809647e-07,   1.74056876e-09,
          3.95533868e-04,   3.60630041e-07,   5.73872651e-03,
          5.02933442e-03,  -2.87465024e-03,  -2.51687695e-03,
         -2.87043244e-03,  -2.51386125e-03],
       [ -5.64783876e-07,   1.63683936e-06,   4.58707378e-06,
         -8.53902579e-03,   1.50246820e-06,   1.47702195e-06,
          2.16834589e-06,  -3.67776798e-03,   4.22210053e-07,
          1.49507166e-07,   4.41323780e-09,   4.12662559e-08,
          3.60630041e-07,   3.95377861e-04,   3.37855713e-06,
          2.81210804e-06,  -4.97344862e-03,  -4.35444203e-03,
          4.96988416e-03,   4.35268358e-03],
       [ -3.08727901e-02,   5.74846756e-02,   1.23950857e-01,
          7.05398222e-06,   1.41994868e-05,   5.54249943e-02,
          5.33838846e-02,   6.60430385e-06,   5.35962811e-06,
         -4.81773905e-03,   5.54687485e-06,  -2.22955692e-06,
          5.73872651e-03,   3.37855713e-06,   1.06231000e-01,
          8.35159450e-02,  -1.87358362e-02,  -2.59818074e-02,
         -1.87408672e-02,  -2.59861727e-02],
       [ -9.02035443e-03,   2.65621070e-02,   1.08613496e-01,
          5.77202662e-06,   1.36052844e-05,   2.53283453e-02,
          4.67769753e-02,   5.32713509e-06,   4.49435420e-06,
         -2.21426461e-03,   3.98993491e-06,  -1.01942389e-06,
          5.02933442e-03,   2.81210804e-06,   8.35159450e-02,
          6.88186999e-02,  -2.59927997e-02,  -2.71286876e-02,
         -2.59928073e-02,  -2.71327709e-02],
       [ -3.08831373e-02,   5.75083948e-02,  -6.19947096e-02,
          1.07385284e-01,  -3.01859024e-05,   5.54434079e-02,
         -2.66979060e-02,   4.62502121e-02,  -7.25620254e-06,
         -4.82373001e-03,   3.13603766e-07,  -2.78407187e-06,
         -2.87465024e-03,  -4.97344862e-03,  -1.87358362e-02,
         -2.59927997e-02,   1.06315692e-01,   8.35142440e-02,
         -1.87456361e-02,  -2.59840231e-02],
       [ -9.01201788e-03,   2.65482055e-02,  -5.42941517e-02,
          9.40162482e-02,  -2.52679853e-05,   2.53111059e-02,
         -2.33829993e-02,   4.04919628e-02,  -6.55555541e-06,
         -2.21660708e-03,  -5.96185007e-07,  -1.50356837e-06,
         -2.51687695e-03,  -4.35444203e-03,  -2.59818074e-02,
         -2.71286876e-02,   8.35142440e-02,   6.87622614e-02,
         -2.59735307e-02,  -2.71045875e-02],
       [ -3.08779749e-02,   5.75002264e-02,  -6.19841411e-02,
         -1.07362203e-01,   7.58761076e-06,   5.54333733e-02,
         -2.66885067e-02,  -4.62417740e-02,   3.35739714e-06,
         -4.81585149e-03,   4.19880694e-07,  -1.74435740e-06,
         -2.87043244e-03,   4.96988416e-03,  -1.87408672e-02,
         -2.59928073e-02,  -1.87456361e-02,  -2.59735307e-02,
          1.06257358e-01,   8.35032192e-02],
       [ -9.01935610e-03,   2.65658507e-02,  -5.42995151e-02,
         -9.40327115e-02,   7.80611847e-06,   2.53261476e-02,
         -2.33810626e-02,  -4.05009377e-02,   2.73814199e-06,
         -2.21178324e-03,  -5.02626280e-07,  -5.94090411e-07,
         -2.51386125e-03,   4.35268358e-03,  -2.59861727e-02,
         -2.71327709e-02,  -2.59840231e-02,  -2.71045875e-02,
          8.35032192e-02,   6.87794660e-02]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_dm_beta': 1e-08, 'ref_result_dm_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uks_methyl_gga.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
